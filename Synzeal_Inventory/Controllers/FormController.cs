using iTextSharp.text;
using iTextSharp.text.html.simpleparser;
using iTextSharp.text.pdf;
using iTextSharp.tool.xml;
using Newtonsoft.Json;
using OfficeOpenXml;
using Synzeal_Inventory.Entity;
using Synzeal_Inventory.Models;
using System;
using System.Collections.Generic;
using System.Data;
using System.IO;
using System.Linq;
using System.Linq.Dynamic;
using System.Net.Http;
using System.Threading.Tasks;
using System.Web;
using System.Web.Hosting;
using System.Web.Mvc;
using System.Web.UI;
using System.Net;
using System.Net.NetworkInformation;
using System.Configuration;
using System.Data.SqlClient;
using HtmlAgilityPack;
using System.Runtime.InteropServices;
using OfficeOpenXml.Style;
using System.Drawing;
using System.Data.Entity.Validation;
using System.EnterpriseServices.Internal;
using System.Net.Mail;
using WebGrease.Css.Extensions;
using Org.BouncyCastle.Ocsp;
using Ionic.Zip;
using System.Text.RegularExpressions;
using System.Transactions;
using System.Data.Entity;
using Synzeal_Inventory.Repository;
using System.Net.Http.Headers;
using Newtonsoft.Json.Linq;
using DocumentFormat.OpenXml.Office2010.Excel;
using Color = System.Drawing.Color;
using DocumentFormat.OpenXml.Packaging;
using static Synzeal_Inventory.Models.ProductDetailsModel;
using Microsoft.AspNet.SignalR.Hosting;
using System.Text;
using MailChimp.Net.Interfaces;
using Amazon.S3;
using Amazon.S3.Model;
using System.Runtime.InteropServices.ComTypes;
using System.Web.UI.WebControls;
using System.Data.Entity.Infrastructure;
using DocumentFormat.OpenXml.Bibliography;
using MailChimp.Net.Core;
using static Synzeal_Inventory.Models.ConversationMessageModel;
using System.Collections;
using System.Web.Routing;
using DocumentFormat.OpenXml.Office2016.Presentation.Command;
using Microsoft.Ajax.Utilities;
using OfficeOpenXml.FormulaParsing.Excel.Functions.Text;

namespace Synzeal_Inventory.Controllers
{
    public class FormController : Controller
    {
        //    var sectionList = [];
        //    sectionList.push('Quote');
        //sectionList.push('Quotedetail');
        //sectionList.push('Project');
        //sectionList.push('Dispatch');
        //sectionList.push('QC');
        //sectionList.push('Invoice');
        //sectionList.push('COA');
        //sectionList.push('Query');

        //var fieldList = [];
        //    fieldList.push('Tracebility');
        //fieldList.push('ColdShipment');

        //TODO: Make all call into repository pattern.
        public string Domain = "https://synzeal.com/";
        //public string Domain = "http://synzeal.in/";
        public static string bucketname = "synzeal-quotation";
        public static string missiveBaseAddress = "https://public.missiveapp.com/";
        public static string missiveAuthorization = "Bearer d59e2507-e903-440d-81b9-bfbd9a115133";
        public static string missiveHost = "public.missiveapp.com";
        public static string missiveContractBook = "d7572911-569d-4e88-8b3b-a5a8e9aff9c6";
        SynzealLiveEntities db = new SynzealLiveEntities();
        public int tabindex = 1;
        private IOperationRepository _operationRepository;
        public FormController()
        {
            this._operationRepository = new OperationRepository(db);
        }
        public ActionResult ReturnData()
        {
            return View("_PartialFedEx");
        }

        public async Task<ActionResult> Cricket()
        {
            //var test = await Aws.CreateBucket("quotation");
            //Uplaod in S3 Start
            Aws.CreateBucket("synzeal-v2-test");
            //Aws.UploadFile(@"F:\test-file.pdf", "test01.pdf");
            Aws.S3Download("synzeal-quotation", "test01.pdf", @"F:\test\");

            //Uplaod in S3 end
            return View();
        }

        public ActionResult RuleManagement()
        {
            var model = db.SZ_Rule.OrderByDescending(x => x.UpdatedDate).ToList();
            return View(model);
        }

        public ActionResult AddNewRule(int id = 0)
        {
            var outputModel = new RuleModel();
            var model = db.SZ_Rule.Where(x => x.Id == id).FirstOrDefault();
            if (model != null)
            {
                outputModel.id = model.Id;
                outputModel.ruleName = model.Name;
                outputModel.ruletag = model.SZ_RuleDetail.Select(x => x.Tag).FirstOrDefault();
                outputModel.condition = model.SZ_RuleDetail.Select(x => x.Condition).FirstOrDefault();
                outputModel.rules = (from i in model.SZ_RuleDetail
                                     select new RulesData()
                                     {
                                         ruledetailid = i.Id,
                                         typedata = i.Type,
                                         query = i.Query,
                                         value = i.Value
                                     }).ToList();
            }
            return View(outputModel);
        }
        public ActionResult SOP()
        {
            var model = db.SZ_SOP.OrderByDescending(x => x.CreatedDate).ToList();
            return View(model);
        }
        public ActionResult AddSOP()
        {
            var model = db.SZ_SOP.OrderByDescending(x => x.CreatedDate).ToList();
            return View(model);
        }
        public ActionResult AddNewSOP()
        {
            return View();
        }
        public static readonly string email = "parthsuthar2010@gmail.com";
        public static readonly string apiKey = "52d8550c2698974e9c6839604b2645bc-us21"; // your API key here (no, this is not a real one!)
        public static readonly string listId = "df53fccb20"; // your list ID here
        public static readonly IMailChimpManager mailChimpManager = new MailChimp.Net.MailChimpManager(apiKey);
        public async Task<ActionResult> GetMailchimp()
        {
            //IMailChimpManager mailChimpManager = new MailChimp.Net.MailChimpManager(apiKey); //if you have it in code
            ServicePointManager.SecurityProtocol = ServicePointManager.SecurityProtocol | SecurityProtocolType.Tls12;
            // Use the Status property if updating an existing member
            var member = new MailChimp.Net.Models.Member
            {
                EmailAddress = $"parthsuthar2010@gmail.com",
                StatusIfNew = MailChimp.Net.Models.Status.Pending,
                ListId = listId
            };
            member.MergeFields.Add("FNAME", "HOLY");
            member.MergeFields.Add("LNAME", "COW");
            var t = await mailChimpManager.Members.AddOrUpdateAsync(listId, member);

            //var subscribeRequest = new
            //{
            //    apikey = apiKey,
            //    id = listId,
            //    email = new
            //    {
            //        email = email
            //    },
            //    double_optin = true,
            //};
            //var requestJson = JsonConvert.SerializeObject(subscribeRequest);
            //var responseString = CallMailChimpApi("lists/subscribe.json", requestJson);
            //dynamic responseObject = JsonConvert.DeserializeObject(responseString);
            //if ((responseObject.email != null) && (responseObject.euid != null))
            //{
            //    // successful!

            //    var addsubscribe = new
            //    {
            //        name = "Parth Suthar",
            //        contact = new
            //        {
            //            company = "SynZeal Research PVT LTD",
            //            address1 = "New Ranip",
            //            address2 = "",
            //            city = "Ahmedabad",
            //            state = "",
            //            zip = "",
            //            country = "IN",
            //            phone = ""
            //        },
            //        permission_reminder = "You'\''re receiving this email because you signed up into SPMS module.",
            //        use_archive_bar = false,
            //        campaign_defaults = new 
            //        { 
            //            from_name = "Parth Suthar",
            //            from_email = email,
            //            subject = "SPMS", 
            //            language = "en"
            //        },
            //        email_type_option = true
            //    };
            //    var requestJsonss = JsonConvert.SerializeObject(addsubscribe);
            //    //    var responseStringss = CreateList("us21", apiKey, requestJsonss);
            //    var test = AddOrUpdateListMember("us21", apiKey, listId, email);

            //}
            //else
            //{
            //    string name = responseObject.name;
            //    if (name == "List_AlreadySubscribed")
            //    {

            //    }
            //    else
            //    {

            //    }
            //}

            return Content("ok");
        }
        public ActionResult UploadAttachmentFileToAWS()
        {

            var szform = db.SZ_QuoteDetailForm.ToList();
            if (szform != null && szform.Count > 0)
            {
                foreach (var item in szform)
                {
                    try
                    {
                        if (!string.IsNullOrEmpty(item.SpectralDataAttachment) && item.SpectralDataAttachment.Contains(".."))
                        {
                            item.SpectralDataAttachment = Server.MapPath("~/" + item.SpectralDataAttachment.Replace("../", ""));
                        }
                        if (!string.IsNullOrEmpty(item.SpectralDataAttachment) && System.IO.File.Exists(item.SpectralDataAttachment) && !item.SpectralDataAttachment.Contains("s3"))
                        {
                            var filename = Path.GetFileNameWithoutExtension(item.SpectralDataAttachment);
                            var fileextension = Path.GetExtension(item.SpectralDataAttachment);
                            var isUploadDone = Aws.UploadFile(item.SpectralDataAttachment, filename + "" + fileextension);
                            if (isUploadDone)
                            {
                                var localpath = item.SpectralDataAttachment;
                                item.SpectralDataAttachment = "https://synzeal-quotation.s3.amazonaws.com/" + filename + "" + fileextension;
                                System.IO.File.Delete(localpath);
                            }
                        }
                        if (!string.IsNullOrEmpty(item.IRAttachment) && item.IRAttachment.Contains(".."))
                        {
                            item.IRAttachment = Server.MapPath("~/" + item.IRAttachment.Replace("../", ""));
                        }
                        if (!string.IsNullOrEmpty(item.IRAttachment) && System.IO.File.Exists(item.IRAttachment) && !item.IRAttachment.Contains("s3"))
                        {
                            var filename = Path.GetFileNameWithoutExtension(item.IRAttachment);
                            var fileextension = Path.GetExtension(item.IRAttachment);
                            var isUploadDone = Aws.UploadFile(item.IRAttachment, filename + "" + fileextension);
                            if (isUploadDone)
                            {
                                var localpath = item.IRAttachment;
                                item.IRAttachment = "https://synzeal-quotation.s3.amazonaws.com/" + filename + "" + fileextension;
                                System.IO.File.Delete(localpath);
                            }
                        }
                        if (!string.IsNullOrEmpty(item.MassAttachment) && item.MassAttachment.Contains(".."))
                        {
                            item.MassAttachment = Server.MapPath("~/" + item.MassAttachment.Replace("../", ""));
                        }
                        if (!string.IsNullOrEmpty(item.MassAttachment) && System.IO.File.Exists(item.MassAttachment) && !item.MassAttachment.Contains("s3"))
                        {
                            var filename = Path.GetFileNameWithoutExtension(item.MassAttachment);
                            var fileextension = Path.GetExtension(item.MassAttachment);
                            var isUploadDone = Aws.UploadFile(item.MassAttachment, filename + "" + fileextension);
                            if (isUploadDone)
                            {
                                var localpath = item.MassAttachment;
                                item.MassAttachment = "https://synzeal-quotation.s3.amazonaws.com/" + filename + "" + fileextension;
                                System.IO.File.Delete(localpath);
                            }
                        }

                        if (!string.IsNullOrEmpty(item.PLCAttachment) && item.PLCAttachment.Contains(".."))
                        {
                            item.PLCAttachment = Server.MapPath("~/" + item.PLCAttachment.Replace("../", ""));
                        }
                        if (!string.IsNullOrEmpty(item.PLCAttachment) && System.IO.File.Exists(item.PLCAttachment) && !item.PLCAttachment.Contains("s3"))
                        {
                            var filename = Path.GetFileNameWithoutExtension(item.PLCAttachment);
                            var fileextension = Path.GetExtension(item.PLCAttachment);
                            var isUploadDone = Aws.UploadFile(item.PLCAttachment, filename + "" + fileextension);
                            if (isUploadDone)
                            {
                                var localpath = item.PLCAttachment;
                                item.PLCAttachment = "https://synzeal-quotation.s3.amazonaws.com/" + filename + "" + fileextension;
                                System.IO.File.Delete(localpath);
                            }
                        }

                        if (!string.IsNullOrEmpty(item.NMRAttchment) && item.NMRAttchment.Contains(".."))
                        {
                            item.NMRAttchment = Server.MapPath("~/" + item.NMRAttchment.Replace("../", ""));
                        }
                        if (!string.IsNullOrEmpty(item.NMRAttchment) && System.IO.File.Exists(item.NMRAttchment) && !item.NMRAttchment.Contains("s3"))
                        {
                            var filename = Path.GetFileNameWithoutExtension(item.NMRAttchment);
                            var fileextension = Path.GetExtension(item.NMRAttchment);
                            var isUploadDone = Aws.UploadFile(item.NMRAttchment, filename + "" + fileextension);
                            if (isUploadDone)
                            {
                                var localpath = item.NMRAttchment;
                                item.NMRAttchment = "https://synzeal-quotation.s3.amazonaws.com/" + filename + "" + fileextension;
                                System.IO.File.Delete(localpath);
                            }
                        }
                        if (!string.IsNullOrEmpty(item.QNMRAttchment) && item.QNMRAttchment.Contains(".."))
                        {
                            item.QNMRAttchment = Server.MapPath("~/" + item.QNMRAttchment.Replace("../", ""));
                        }
                        if (!string.IsNullOrEmpty(item.QNMRAttchment) && System.IO.File.Exists(item.QNMRAttchment) && !item.QNMRAttchment.Contains("s3"))
                        {
                            var filename = Path.GetFileNameWithoutExtension(item.QNMRAttchment);
                            var fileextension = Path.GetExtension(item.QNMRAttchment);
                            var isUploadDone = Aws.UploadFile(item.QNMRAttchment, filename + "" + fileextension);
                            if (isUploadDone)
                            {
                                var localpath = item.QNMRAttchment;
                                item.QNMRAttchment = "https://synzeal-quotation.s3.amazonaws.com/" + filename + "" + fileextension;
                                System.IO.File.Delete(localpath);
                            }
                        }
                        if (!string.IsNullOrEmpty(item.TGAAttachment) && item.TGAAttachment.Contains(".."))
                        {
                            item.TGAAttachment = Server.MapPath("~/" + item.TGAAttachment.Replace("../", ""));
                        }
                        if (!string.IsNullOrEmpty(item.TGAAttachment) && System.IO.File.Exists(item.TGAAttachment) && !item.TGAAttachment.Contains("s3"))
                        {
                            var filename = Path.GetFileNameWithoutExtension(item.TGAAttachment);
                            var fileextension = Path.GetExtension(item.TGAAttachment);
                            var isUploadDone = Aws.UploadFile(item.TGAAttachment, filename + "" + fileextension);
                            if (isUploadDone)
                            {
                                var localpath = item.TGAAttachment;
                                item.TGAAttachment = "https://synzeal-quotation.s3.amazonaws.com/" + filename + "" + fileextension;
                                System.IO.File.Delete(localpath);
                            }
                        }

                        if (!string.IsNullOrEmpty(item.CMRAttchment) && item.CMRAttchment.Contains(".."))
                        {
                            item.CMRAttchment = Server.MapPath("~/" + item.CMRAttchment.Replace("../", ""));
                        }
                        if (!string.IsNullOrEmpty(item.CMRAttchment) && System.IO.File.Exists(item.CMRAttchment) && !item.CMRAttchment.Contains("s3"))
                        {
                            var filename = Path.GetFileNameWithoutExtension(item.CMRAttchment);
                            var fileextension = Path.GetExtension(item.CMRAttchment);
                            var isUploadDone = Aws.UploadFile(item.CMRAttchment, filename + "" + fileextension);
                            if (isUploadDone)
                            {
                                var localpath = item.CMRAttchment;
                                item.CMRAttchment = "https://synzeal-quotation.s3.amazonaws.com/" + filename + "" + fileextension;
                                System.IO.File.Delete(localpath);
                            }
                        }

                        if (!string.IsNullOrEmpty(item.DEPTAttachment) && item.DEPTAttachment.Contains(".."))
                        {
                            item.DEPTAttachment = Server.MapPath("~/" + item.DEPTAttachment.Replace("../", ""));
                        }
                        if (!string.IsNullOrEmpty(item.DEPTAttachment) && System.IO.File.Exists(item.DEPTAttachment) && !item.DEPTAttachment.Contains("s3"))
                        {
                            var filename = Path.GetFileNameWithoutExtension(item.DEPTAttachment);
                            var fileextension = Path.GetExtension(item.DEPTAttachment);
                            var isUploadDone = Aws.UploadFile(item.DEPTAttachment, filename + "" + fileextension);
                            if (isUploadDone)
                            {
                                var localpath = item.DEPTAttachment;
                                item.DEPTAttachment = "https://synzeal-quotation.s3.amazonaws.com/" + filename + "" + fileextension;

                                System.IO.File.Delete(localpath);
                            }
                        }

                        if (!string.IsNullOrEmpty(item.HRMSAttachment) && item.HRMSAttachment.Contains(".."))
                        {
                            item.HRMSAttachment = Server.MapPath("~/" + item.HRMSAttachment.Replace("../", ""));
                        }
                        if (!string.IsNullOrEmpty(item.HRMSAttachment) && System.IO.File.Exists(item.HRMSAttachment) && !item.HRMSAttachment.Contains("s3"))
                        {
                            var filename = Path.GetFileNameWithoutExtension(item.HRMSAttachment);
                            var fileextension = Path.GetExtension(item.HRMSAttachment);
                            var isUploadDone = Aws.UploadFile(item.HRMSAttachment, filename + "" + fileextension);
                            if (isUploadDone)
                            {
                                var localpath = item.HRMSAttachment;
                                item.HRMSAttachment = "https://synzeal-quotation.s3.amazonaws.com/" + filename + "" + fileextension;

                                System.IO.File.Delete(localpath);
                            }
                        }

                        if (!string.IsNullOrEmpty(item.ROIAttachment) && item.ROIAttachment.Contains(".."))
                        {
                            item.ROIAttachment = Server.MapPath("~/" + item.ROIAttachment.Replace("../", ""));
                        }
                        if (!string.IsNullOrEmpty(item.ROIAttachment) && System.IO.File.Exists(item.ROIAttachment) && !item.ROIAttachment.Contains("s3"))
                        {
                            var filename = Path.GetFileNameWithoutExtension(item.ROIAttachment);
                            var fileextension = Path.GetExtension(item.ROIAttachment);
                            var isUploadDone = Aws.UploadFile(item.ROIAttachment, filename + "" + fileextension);
                            if (isUploadDone)
                            {
                                var localpath = item.ROIAttachment;
                                item.ROIAttachment = "https://synzeal-quotation.s3.amazonaws.com/" + filename + "" + fileextension;

                                System.IO.File.Delete(localpath);
                            }
                        }

                        if (!string.IsNullOrEmpty(item.ElementralAttachment) && item.ElementralAttachment.Contains(".."))
                        {
                            item.ElementralAttachment = Server.MapPath("~/" + item.ElementralAttachment.Replace("../", ""));
                        }
                        if (!string.IsNullOrEmpty(item.ElementralAttachment) && System.IO.File.Exists(item.ElementralAttachment) && !item.ElementralAttachment.Contains("s3"))
                        {
                            var filename = Path.GetFileNameWithoutExtension(item.ElementralAttachment);
                            var fileextension = Path.GetExtension(item.ElementralAttachment);
                            var isUploadDone = Aws.UploadFile(item.ElementralAttachment, filename + "" + fileextension);
                            if (isUploadDone)
                            {
                                var localpath = item.ElementralAttachment;
                                item.ElementralAttachment = "https://synzeal-quotation.s3.amazonaws.com/" + filename + "" + fileextension;

                                System.IO.File.Delete(localpath);
                            }
                        }

                        if (!string.IsNullOrEmpty(item.SERAttachment) && item.SERAttachment.Contains(".."))
                        {
                            item.SERAttachment = Server.MapPath("~/" + item.SERAttachment.Replace("../", ""));
                        }
                        if (!string.IsNullOrEmpty(item.SERAttachment) && System.IO.File.Exists(item.SERAttachment) && !item.SERAttachment.Contains("s3"))
                        {
                            var filename = Path.GetFileNameWithoutExtension(item.SERAttachment);
                            var fileextension = Path.GetExtension(item.SERAttachment);
                            var isUploadDone = Aws.UploadFile(item.SERAttachment, filename + "" + fileextension);
                            if (isUploadDone)
                            {
                                var localpath = item.SERAttachment;
                                item.SERAttachment = "https://synzeal-quotation.s3.amazonaws.com/" + filename + "" + fileextension;
                                System.IO.File.Delete(localpath);
                            }
                        }

                        if (!string.IsNullOrEmpty(item.GCAttachment) && item.GCAttachment.Contains(".."))
                        {
                            item.GCAttachment = Server.MapPath("~/" + item.GCAttachment.Replace("../", ""));
                        }
                        if (!string.IsNullOrEmpty(item.GCAttachment) && System.IO.File.Exists(item.GCAttachment) && !item.GCAttachment.Contains("s3"))
                        {
                            var filename = Path.GetFileNameWithoutExtension(item.GCAttachment);
                            var fileextension = Path.GetExtension(item.GCAttachment);
                            var isUploadDone = Aws.UploadFile(item.GCAttachment, filename + "" + fileextension);
                            if (isUploadDone)
                            {
                                var localpath = item.GCAttachment;
                                item.GCAttachment = "https://synzeal-quotation.s3.amazonaws.com/" + filename + "" + fileextension;
                                System.IO.File.Delete(localpath);
                            }
                        }

                        if (!string.IsNullOrEmpty(item.ELSDAttachment) && item.ELSDAttachment.Contains(".."))
                        {
                            item.ELSDAttachment = Server.MapPath("~/" + item.ELSDAttachment.Replace("../", ""));
                        }
                        if (!string.IsNullOrEmpty(item.ELSDAttachment) && System.IO.File.Exists(item.ELSDAttachment) && !item.ELSDAttachment.Contains("s3"))
                        {
                            var filename = Path.GetFileNameWithoutExtension(item.ELSDAttachment);
                            var fileextension = Path.GetExtension(item.ELSDAttachment);
                            var isUploadDone = Aws.UploadFile(item.ELSDAttachment, filename + "" + fileextension);
                            if (isUploadDone)
                            {
                                var localpath = item.ELSDAttachment;
                                item.ELSDAttachment = "https://synzeal-quotation.s3.amazonaws.com/" + filename + "" + fileextension;
                                System.IO.File.Delete(localpath);
                            }
                        }

                        if (!string.IsNullOrEmpty(item.ChiralAttachmenrt) && item.ChiralAttachmenrt.Contains(".."))
                        {
                            item.ChiralAttachmenrt = Server.MapPath("~/" + item.ChiralAttachmenrt.Replace("../", ""));
                        }
                        if (!string.IsNullOrEmpty(item.ChiralAttachmenrt) && System.IO.File.Exists(item.ChiralAttachmenrt) && !item.ChiralAttachmenrt.Contains("s3"))
                        {
                            var filename = Path.GetFileNameWithoutExtension(item.ChiralAttachmenrt);
                            var fileextension = Path.GetExtension(item.ChiralAttachmenrt);
                            var isUploadDone = Aws.UploadFile(item.ChiralAttachmenrt, filename + "" + fileextension);
                            if (isUploadDone)
                            {
                                var localpath = item.ChiralAttachmenrt;
                                item.ChiralAttachmenrt = "https://synzeal-quotation.s3.amazonaws.com/" + filename + "" + fileextension;
                                System.IO.File.Delete(localpath);
                            }
                        }

                        if (!string.IsNullOrEmpty(item.APCIMassAttachment) && item.APCIMassAttachment.Contains(".."))
                        {
                            item.APCIMassAttachment = Server.MapPath("~/" + item.APCIMassAttachment.Replace("../", ""));
                        }
                        if (!string.IsNullOrEmpty(item.APCIMassAttachment) && System.IO.File.Exists(item.APCIMassAttachment) && !item.APCIMassAttachment.Contains("s3"))
                        {
                            var filename = Path.GetFileNameWithoutExtension(item.APCIMassAttachment);
                            var fileextension = Path.GetExtension(item.APCIMassAttachment);
                            var isUploadDone = Aws.UploadFile(item.APCIMassAttachment, filename + "" + fileextension);
                            if (isUploadDone)
                            {
                                var localpath = item.APCIMassAttachment;
                                item.APCIMassAttachment = "https://synzeal-quotation.s3.amazonaws.com/" + filename + "" + fileextension;
                                System.IO.File.Delete(localpath);
                            }
                        }

                        if (!string.IsNullOrEmpty(item.ChemdrawFileAttachment) && item.ChemdrawFileAttachment.Contains(".."))
                        {
                            item.ChemdrawFileAttachment = Server.MapPath("~/" + item.ChemdrawFileAttachment.Replace("../", ""));
                        }
                        if (!string.IsNullOrEmpty(item.ChemdrawFileAttachment) && System.IO.File.Exists(item.ChemdrawFileAttachment) && !item.ChemdrawFileAttachment.Contains("s3"))
                        {
                            var filename = Path.GetFileNameWithoutExtension(item.ChemdrawFileAttachment);
                            var fileextension = Path.GetExtension(item.ChemdrawFileAttachment);
                            var isUploadDone = Aws.UploadFile(item.ChemdrawFileAttachment, filename + "" + fileextension);
                            if (isUploadDone)
                            {
                                var localpath = item.ChemdrawFileAttachment;
                                item.ChemdrawFileAttachment = "https://synzeal-quotation.s3.amazonaws.com/" + filename + "" + fileextension;
                                System.IO.File.Delete(localpath);
                            }
                        }

                        if (!string.IsNullOrEmpty(item.WeightingSlipAttachment) && item.WeightingSlipAttachment.Contains(".."))
                        {
                            item.WeightingSlipAttachment = Server.MapPath("~/" + item.WeightingSlipAttachment.Replace("../", ""));
                        }
                        if (!string.IsNullOrEmpty(item.WeightingSlipAttachment) && System.IO.File.Exists(item.WeightingSlipAttachment) && !item.WeightingSlipAttachment.Contains("s3"))
                        {
                            var filename = Path.GetFileNameWithoutExtension(item.WeightingSlipAttachment);
                            var fileextension = Path.GetExtension(item.WeightingSlipAttachment);
                            var isUploadDone = Aws.UploadFile(item.WeightingSlipAttachment, filename + "" + fileextension);
                            if (isUploadDone)
                            {
                                var localpath = item.WeightingSlipAttachment;
                                item.WeightingSlipAttachment = "https://synzeal-quotation.s3.amazonaws.com/" + filename + "" + fileextension;
                                System.IO.File.Delete(localpath);
                            }
                        }

                        if (!string.IsNullOrEmpty(item.NMRInterpretaionAttachment) && item.NMRInterpretaionAttachment.Contains(".."))
                        {
                            item.NMRInterpretaionAttachment = Server.MapPath("~/" + item.NMRInterpretaionAttachment.Replace("../", ""));
                        }
                        if (!string.IsNullOrEmpty(item.NMRInterpretaionAttachment) && System.IO.File.Exists(item.NMRInterpretaionAttachment) && !item.NMRInterpretaionAttachment.Contains("s3"))
                        {
                            var filename = Path.GetFileNameWithoutExtension(item.NMRInterpretaionAttachment);
                            var fileextension = Path.GetExtension(item.NMRInterpretaionAttachment);
                            var isUploadDone = Aws.UploadFile(item.NMRInterpretaionAttachment, filename + "" + fileextension);
                            if (isUploadDone)
                            {
                                var localpath = item.NMRInterpretaionAttachment;
                                item.NMRInterpretaionAttachment = "https://synzeal-quotation.s3.amazonaws.com/" + filename + "" + fileextension;
                                System.IO.File.Delete(localpath);
                            }
                        }


                        if (!string.IsNullOrEmpty(item.UVSpectra) && item.UVSpectra.Contains(".."))
                        {
                            item.UVSpectra = Server.MapPath("~/" + item.UVSpectra.Replace("../", ""));
                        }
                        if (!string.IsNullOrEmpty(item.UVSpectra) && System.IO.File.Exists(item.UVSpectra) && !item.UVSpectra.Contains("s3"))
                        {
                            var filename = Path.GetFileNameWithoutExtension(item.UVSpectra);
                            var fileextension = Path.GetExtension(item.UVSpectra);
                            var isUploadDone = Aws.UploadFile(item.UVSpectra, filename + "" + fileextension);
                            if (isUploadDone)
                            {
                                var localpath = item.UVSpectra;
                                item.UVSpectra = "https://synzeal-quotation.s3.amazonaws.com/" + filename + "" + fileextension;
                                System.IO.File.Delete(localpath);
                            }
                        }

                        if (!string.IsNullOrEmpty(item.OtherAnalysisAttachment) && item.OtherAnalysisAttachment.Contains(".."))
                        {
                            item.OtherAnalysisAttachment = Server.MapPath("~/" + item.OtherAnalysisAttachment.Replace("../", ""));
                        }
                        if (!string.IsNullOrEmpty(item.OtherAnalysisAttachment) && System.IO.File.Exists(item.OtherAnalysisAttachment) && !item.OtherAnalysisAttachment.Contains("s3"))
                        {
                            var filename = Path.GetFileNameWithoutExtension(item.OtherAnalysisAttachment);
                            var fileextension = Path.GetExtension(item.OtherAnalysisAttachment);
                            var isUploadDone = Aws.UploadFile(item.OtherAnalysisAttachment, filename + "" + fileextension);
                            if (isUploadDone)
                            {
                                var localpath = item.OtherAnalysisAttachment;
                                item.OtherAnalysisAttachment = "https://synzeal-quotation.s3.amazonaws.com/" + filename + "" + fileextension;
                                System.IO.File.Delete(localpath);
                            }
                        }

                        if (!string.IsNullOrEmpty(item.N1NmrAttachment) && item.N1NmrAttachment.Contains(".."))
                        {
                            item.N1NmrAttachment = Server.MapPath("~/" + item.N1NmrAttachment.Replace("../", ""));
                        }
                        if (!string.IsNullOrEmpty(item.N1NmrAttachment) && System.IO.File.Exists(item.N1NmrAttachment) && !item.N1NmrAttachment.Contains("s3"))
                        {
                            var filename = Path.GetFileNameWithoutExtension(item.N1NmrAttachment);
                            var fileextension = Path.GetExtension(item.N1NmrAttachment);
                            var isUploadDone = Aws.UploadFile(item.N1NmrAttachment, filename + "" + fileextension);
                            if (isUploadDone)
                            {
                                var localpath = item.N1NmrAttachment;
                                item.N1NmrAttachment = "https://synzeal-quotation.s3.amazonaws.com/" + filename + "" + fileextension;
                                System.IO.File.Delete(localpath);
                            }
                        }

                        if (!string.IsNullOrEmpty(item.ChiralHPLCAttachment) && item.ChiralHPLCAttachment.Contains(".."))
                        {
                            item.ChiralHPLCAttachment = Server.MapPath("~/" + item.ChiralHPLCAttachment.Replace("../", ""));
                        }
                        if (!string.IsNullOrEmpty(item.ChiralHPLCAttachment) && System.IO.File.Exists(item.ChiralHPLCAttachment) && !item.ChiralHPLCAttachment.Contains("s3"))
                        {
                            var filename = Path.GetFileNameWithoutExtension(item.ChiralHPLCAttachment);
                            var fileextension = Path.GetExtension(item.ChiralHPLCAttachment);
                            var isUploadDone = Aws.UploadFile(item.ChiralHPLCAttachment, filename + "" + fileextension);
                            if (isUploadDone)
                            {
                                var localpath = item.ChiralHPLCAttachment;
                                item.ChiralHPLCAttachment = "https://synzeal-quotation.s3.amazonaws.com/" + filename + "" + fileextension;
                                System.IO.File.Delete(localpath);
                            }
                        }

                        if (!string.IsNullOrEmpty(item.IsotropicpurityAttachment) && item.IsotropicpurityAttachment.Contains(".."))
                        {
                            item.IsotropicpurityAttachment = Server.MapPath("~/" + item.IsotropicpurityAttachment.Replace("../", ""));
                        }
                        if (!string.IsNullOrEmpty(item.IsotropicpurityAttachment) && System.IO.File.Exists(item.IsotropicpurityAttachment) && !item.IsotropicpurityAttachment.Contains("s3"))
                        {
                            var filename = Path.GetFileNameWithoutExtension(item.IsotropicpurityAttachment);
                            var fileextension = Path.GetExtension(item.IsotropicpurityAttachment);
                            var isUploadDone = Aws.UploadFile(item.IsotropicpurityAttachment, filename + "" + fileextension);
                            if (isUploadDone)
                            {
                                var localpath = item.IsotropicpurityAttachment;
                                item.IsotropicpurityAttachment = "https://synzeal-quotation.s3.amazonaws.com/" + filename + "" + fileextension;
                                System.IO.File.Delete(localpath);
                            }
                        }

                        if (!string.IsNullOrEmpty(item.TwoDNMRAttachment) && item.TwoDNMRAttachment.Contains(".."))
                        {
                            item.TwoDNMRAttachment = Server.MapPath("~/" + item.TwoDNMRAttachment.Replace("../", ""));
                        }
                        if (!string.IsNullOrEmpty(item.TwoDNMRAttachment) && System.IO.File.Exists(item.TwoDNMRAttachment) && !item.TwoDNMRAttachment.Contains("s3"))
                        {
                            var filename = Path.GetFileNameWithoutExtension(item.TwoDNMRAttachment);
                            var fileextension = Path.GetExtension(item.TwoDNMRAttachment);
                            var isUploadDone = Aws.UploadFile(item.TwoDNMRAttachment, filename + "" + fileextension);
                            if (isUploadDone)
                            {
                                var localpath = item.TwoDNMRAttachment;
                                item.TwoDNMRAttachment = "https://synzeal-quotation.s3.amazonaws.com/" + filename + "" + fileextension;
                                System.IO.File.Delete(localpath);
                            }
                        }

                        if (!string.IsNullOrEmpty(item.COSYAttachment) && item.COSYAttachment.Contains(".."))
                        {
                            item.COSYAttachment = Server.MapPath("~/" + item.COSYAttachment.Replace("../", ""));
                        }
                        if (!string.IsNullOrEmpty(item.COSYAttachment) && System.IO.File.Exists(item.COSYAttachment) && !item.COSYAttachment.Contains("s3"))
                        {
                            var filename = Path.GetFileNameWithoutExtension(item.COSYAttachment);
                            var fileextension = Path.GetExtension(item.COSYAttachment);
                            var isUploadDone = Aws.UploadFile(item.COSYAttachment, filename + "" + fileextension);
                            if (isUploadDone)
                            {
                                var localpath = item.COSYAttachment;
                                item.COSYAttachment = "https://synzeal-quotation.s3.amazonaws.com/" + filename + "" + fileextension;
                                System.IO.File.Delete(localpath);
                            }
                        }

                        if (!string.IsNullOrEmpty(item.CHNSAttachment) && item.CHNSAttachment.Contains(".."))
                        {
                            item.CHNSAttachment = Server.MapPath("~/" + item.CHNSAttachment.Replace("../", ""));
                        }
                        if (!string.IsNullOrEmpty(item.CHNSAttachment) && System.IO.File.Exists(item.CHNSAttachment) && !item.CHNSAttachment.Contains("s3"))
                        {
                            var filename = Path.GetFileNameWithoutExtension(item.CHNSAttachment);
                            var fileextension = Path.GetExtension(item.CHNSAttachment);
                            var isUploadDone = Aws.UploadFile(item.CHNSAttachment, filename + "" + fileextension);
                            if (isUploadDone)
                            {
                                var localpath = item.CHNSAttachment;
                                item.CHNSAttachment = "https://synzeal-quotation.s3.amazonaws.com/" + filename + "" + fileextension;
                                System.IO.File.Delete(localpath);
                            }
                        }

                        if (!string.IsNullOrEmpty(item.StabilitydataAttachment) && item.StabilitydataAttachment.Contains(".."))
                        {
                            item.StabilitydataAttachment = Server.MapPath("~/" + item.StabilitydataAttachment.Replace("../", ""));
                        }
                        if (!string.IsNullOrEmpty(item.StabilitydataAttachment) && System.IO.File.Exists(item.StabilitydataAttachment) && !item.StabilitydataAttachment.Contains("s3"))
                        {
                            var filename = Path.GetFileNameWithoutExtension(item.StabilitydataAttachment);
                            var fileextension = Path.GetExtension(item.StabilitydataAttachment);
                            var isUploadDone = Aws.UploadFile(item.StabilitydataAttachment, filename + "" + fileextension);
                            if (isUploadDone)
                            {
                                var localpath = item.StabilitydataAttachment;
                                item.StabilitydataAttachment = "https://synzeal-quotation.s3.amazonaws.com/" + filename + "" + fileextension;
                                System.IO.File.Delete(localpath);
                            }
                        }

                        if (!string.IsNullOrEmpty(item.LCMSAttachment) && item.LCMSAttachment.Contains(".."))
                        {
                            item.LCMSAttachment = Server.MapPath("~/" + item.LCMSAttachment.Replace("../", ""));
                        }
                        if (!string.IsNullOrEmpty(item.LCMSAttachment) && System.IO.File.Exists(item.LCMSAttachment) && !item.LCMSAttachment.Contains("s3"))
                        {
                            var filename = Path.GetFileNameWithoutExtension(item.LCMSAttachment);
                            var fileextension = Path.GetExtension(item.LCMSAttachment);
                            var isUploadDone = Aws.UploadFile(item.LCMSAttachment, filename + "" + fileextension);
                            if (isUploadDone)
                            {
                                var localpath = item.LCMSAttachment;
                                item.LCMSAttachment = "https://synzeal-quotation.s3.amazonaws.com/" + filename + "" + fileextension;
                                System.IO.File.Delete(localpath);
                            }
                        }
                        db.Entry(item).State = EntityState.Modified;
                    }
                    catch (Exception)
                    {
                        continue;
                    }
                }

                db.SaveChanges();
            }

            var szquotepdf = db.SZ_QuotationPDF.Where(x => x.QuotePDF != null && x.QuotePDF != "" && !x.QuotePDF.Contains("s3")).ToList();
            if (szquotepdf != null && szquotepdf.Count > 0)
            {
                foreach (var item in szquotepdf)
                {
                    if (System.IO.File.Exists(item.QuotePDF) && !item.QuotePDF.Contains("s3"))
                    {
                        if (item.QuotePDF.Contains("quote.synzeal"))
                        {
                            item.QuotePDF = item.QuotePDF.Replace("quote.synzeal", "spms.synzeal");
                        }

                        var filename = Path.GetFileNameWithoutExtension(item.QuotePDF);
                        var fileextension = Path.GetExtension(item.QuotePDF);
                        ////Uplaod in S3 Start
                        var isUploadDone = Aws.UploadFile(item.QuotePDF, filename + "" + fileextension);
                        ////Uplaod in S3 end
                        if (isUploadDone)
                        {
                            var localpath = item.QuotePDF;
                            item.QuotePDF = "https://synzeal-quotation.s3.amazonaws.com/" + filename + "" + fileextension;
                            db.Entry(item).State = EntityState.Modified;
                            System.IO.File.Delete(localpath);
                        }
                    }
                }
                db.SaveChanges();
            }

            var szquotedetail = db.SZ_QuotationDetail.Where(x => !string.IsNullOrEmpty(x.COAPath) || !string.IsNullOrEmpty(x.AnalyticalData)).ToList();
            if (szquotedetail != null && szquotedetail.Count > 0)
            {
                foreach (var item in szquotedetail)
                {
                    if (!string.IsNullOrEmpty(item.COAPath))
                    {
                        if (item.COAPath.Contains(".."))
                        {
                            item.COAPath = Server.MapPath("~/" + item.COAPath.Replace("../", ""));
                        }
                        if (System.IO.File.Exists(item.COAPath) && !item.COAPath.Contains("s3"))
                        {

                            var filename = Path.GetFileNameWithoutExtension(item.COAPath);
                            var fileextension = Path.GetExtension(item.COAPath);
                            ////Uplaod in S3 Start
                            var isUploadDone = Aws.UploadFile(item.COAPath, filename + "" + fileextension);
                            ////Uplaod in S3 end
                            if (isUploadDone)
                            {
                                var localpath = item.COAPath;
                                item.COAPath = "https://synzeal-quotation.s3.amazonaws.com/" + filename + "" + fileextension;
                                db.Entry(item).State = EntityState.Modified;
                                System.IO.File.Delete(localpath);
                            }
                        }
                    }

                    if (!string.IsNullOrEmpty(item.AnalyticalData))
                    {
                        if (item.AnalyticalData.Contains(".."))
                        {
                            item.AnalyticalData = Server.MapPath("~/" + item.AnalyticalData.Replace("../", ""));
                        }
                        if (System.IO.File.Exists(item.AnalyticalData) && !item.AnalyticalData.Contains("s3"))
                        {
                            var filename = Path.GetFileNameWithoutExtension(item.AnalyticalData);
                            var fileextension = Path.GetExtension(item.AnalyticalData);
                            ////Uplaod in S3 Start
                            var isUploadDone = Aws.UploadFile(item.AnalyticalData, filename + "" + fileextension);
                            ////Uplaod in S3 end
                            if (isUploadDone)
                            {
                                var localpath = item.AnalyticalData;
                                item.AnalyticalData = "https://synzeal-quotation.s3.amazonaws.com/" + filename + "" + fileextension;
                                db.Entry(item).State = EntityState.Modified;
                                System.IO.File.Delete(localpath);
                            }
                        }
                    }
                }
                db.SaveChanges();
            }

            return Content("success");
        }
        public async Task AddSubscriberToCampaignList(string listName = "SynZeal Research Pvt Ltd", string fname = "Parth", string lname = "Suthar")
        {
            try
            {
                ServicePointManager.SecurityProtocol = ServicePointManager.SecurityProtocol | SecurityProtocolType.Tls12;

                string emailAddress = email;
                var listsAwaitable = mailChimpManager.Lists.GetAllAsync().ConfigureAwait(false);
                var list = listsAwaitable.GetAwaiter().GetResult().FirstOrDefault(l =>
                                l.Name.Equals(listName, StringComparison.CurrentCultureIgnoreCase));

                if (list != null)
                {
                    //the subscriber
                    var member = new MailChimp.Net.Models.Member
                    {
                        EmailAddress = emailAddress,
                        StatusIfNew = MailChimp.Net.Models.Status.Pending,
                        EmailType = "html",
                        TimestampSignup = DateTime.UtcNow.ToString("s"),
                    };

                    if (fname != null && lname != null)
                    {
                        var subscriberName = new Dictionary<string, object>
                        {
                            {"FNAME", fname},
                            {"LNAME", lname}
                        };
                        member.MergeFields = subscriberName;
                    }

                    string campaignListKey = list.Id;
                    await mailChimpManager.Members.AddOrUpdateAsync(campaignListKey, member);
                }
            }
            catch (MailChimp.Net.Core.MailChimpException e)
            {
                throw;
            }
        }

        private static string AddOrUpdateListMember(string dataCenter, string apiKey, string listId, string subscriberEmail)
        {
            var sampleListMember = JsonConvert.SerializeObject(
                new
                {
                    email_address = subscriberEmail,
                    merge_fields =
                    new
                    {
                        FNAME = "Foo",
                        LNAME = "Bar"
                    },
                    status_if_new = "subscribed"
                });

            var hashedEmailAddress = string.IsNullOrEmpty(subscriberEmail) ? "" : CalculateMD5Hash(subscriberEmail.ToLower());
            var uri = string.Format("https://{0}.api.mailchimp.com/3.0/lists/{1}/members/{2}", dataCenter, listId, hashedEmailAddress);
            try
            {
                using (var webClient = new WebClient())
                {
                    ServicePointManager.Expect100Continue = true;
                    ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12;
                    webClient.Headers.Add("Accept", "application/json");
                    webClient.Headers.Add("Authorization", "apikey " + apiKey);

                    return webClient.UploadString(uri, "POST", sampleListMember);
                }
            }
            catch (WebException we)
            {
                using (var sr = new StreamReader(we.Response.GetResponseStream()))
                {
                    return sr.ReadToEnd();
                }
            }
        }

        private static string CalculateMD5Hash(string input)
        {
            // Step 1, calculate MD5 hash from input.
            var md5 = System.Security.Cryptography.MD5.Create();
            byte[] inputBytes = System.Text.Encoding.ASCII.GetBytes(input);
            byte[] hash = md5.ComputeHash(inputBytes);

            // Step 2, convert byte array to hex string.
            var sb = new StringBuilder();
            foreach (var @byte in hash)
            {
                sb.Append(@byte.ToString("X2"));
            }
            return sb.ToString();
        }

        private static string CreateList(string dataCenter, string apiKey, string samlelistjson)
        {
            samlelistjson = JsonConvert.SerializeObject(
                new
                {
                    name = "Sample List",
                    contact = new
                    {
                        company = "MailChimp",
                        address1 = "675 Ponce De Leon Ave NE",
                        address2 = "Suite 5000",
                        city = "zip",
                        state = "GA",
                        zip = "30308",
                        country = "US",
                        phone = ""
                    },
                    permission_reminder = "You'\''re receiving this email because you signed up for updates about Freddie'\''s newest hats.",
                    campaign_defaults = new
                    {
                        from_name = "Freddie",
                        from_email = "parthsuthar@freddiehats.com",
                        subject = "MailChimp Demo",
                        language = "en",
                    },
                    email_type_option = true
                });
            var uri = string.Format("https://{0}.api.mailchimp.com/2.0/lists", dataCenter);

            try
            {
                using (var webClient = new WebClient())
                {
                    ServicePointManager.Expect100Continue = true;
                    ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12;
                    webClient.Headers.Add("Accept", "application/json");
                    webClient.Headers.Add("Authorization", "apikey " + apiKey);

                    return webClient.UploadString(uri, "POST", samlelistjson);
                }
            }
            catch (WebException we)
            {
                using (var sr = new StreamReader(we.Response.GetResponseStream()))
                {
                    return sr.ReadToEnd();
                }
            }
        }
        private string GetLists(string dataCenter, string apiKey, string listId = "")
        {
            var uri = string.Format("https://{0}.api.mailchimp.com/3.0/lists/{1}", dataCenter, listId);
            try
            {
                ServicePointManager.Expect100Continue = true;
                ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12;
                using (var webClient = new WebClient())
                {
                    webClient.Headers.Add("Accept", "application/json");
                    webClient.Headers.Add("Authorization", "apikey " + apiKey);

                    return webClient.DownloadString(uri);
                }
            }
            catch (WebException we)
            {
                using (var sr = new StreamReader(we.Response.GetResponseStream()))
                {
                    return sr.ReadToEnd();
                }
            }
        }
        public void SetBasicAuthHeader(WebRequest request, string username, string password)
        {
            string auth = username + ":" + password;
            auth = Convert.ToBase64String(Encoding.Default.GetBytes(auth));
            request.Headers["Authorization"] = "Basic " + auth;
        }
        public string CallMailChimpApi(string method, string requestJson)
        {
            var endpoint = String.Format("https://{0}.api.mailchimp.com/2.0/{1}", "us21", method);
            var wc = new WebClient();
            try
            {
                ServicePointManager.Expect100Continue = true;
                ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12;

                return wc.UploadString(endpoint, requestJson);
            }
            catch (WebException we)
            {
                using (var sr = new StreamReader(we.Response.GetResponseStream()))
                {
                    return sr.ReadToEnd();
                }
            }
        }
        public string CallMailChimpApi(string method, string requestJson, string key)
        {
            var endpoint = String.Format("https://{0}.api.mailchimp.com/2.0/lists", "us21", method);
            byte[] dataStream = Encoding.UTF8.GetBytes(requestJson);
            var responsetext = string.Empty;
            WebRequest request = HttpWebRequest.Create(endpoint);
            WebResponse response = null;
            try
            {
                ServicePointManager.Expect100Continue = true;
                ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12;

                request.ContentType = "application/json";
                SetBasicAuthHeader(request, "anystring", key);  // BASIC AUTH
                request.Method = "POST";
                request.ContentLength = dataStream.Length;
                Stream newstream = request.GetRequestStream();

                newstream.Write(dataStream, 0, dataStream.Length);
                newstream.Close();

                response = request.GetResponse();

                // get the result
                using (StreamReader reader = new StreamReader(response.GetResponseStream()))
                {
                    JsonSerializer json = new JsonSerializer();
                    JObject content = JObject.Parse(reader.ReadToEnd());

                    responsetext = reader.ReadToEnd();
                }

                response.Close();
            }

            catch (WebException ex)
            {
                using (var sr = new StreamReader(response.GetResponseStream()))
                {
                    responsetext = sr.ReadToEnd();
                }
            }
            return responsetext;
        }
        public async Task<ActionResult> CallStructureSearch()
        {
            //https://apidocs.chemaxon.com/dotNET/6.3/examples.html
            string URI = "https://api.chemicalize.com/v1/search/hitdisplay";
            string myParameters = "query=C1=CC=CC=C1&searchType=SUBSTRUCTURE&target=aspirin";
            string apikey = "sk_5d0ac7d1f3b847cbabab47f5949455e1";

            HttpClient client = new HttpClient();
            client.DefaultRequestHeaders.Accept.Clear();
            client.DefaultRequestHeaders.Add("x-api-key", apikey);
            //client.DefaultRequestHeaders.Add("x-api-key", "sk_4cabaabe9afb479889e760162bb9e52f");
            client.DefaultRequestHeaders
                  .Accept
                  .Add(new MediaTypeWithQualityHeaderValue("application/json"));//ACCEPT header
            var department = new StructureSearchPostModel() { query = "C1=CC=CC=C1", searchType = "SUBSTRUCTURE", target = "aspirin" };
            HttpResponseMessage response = await client.PostAsJsonAsync(URI, department);

            if (response.IsSuccessStatusCode)
            {
                // Get the URI of the created resource.
                //string UrireturnUrl = response.Headers.Location;
                //Console.WriteLine(returnUrl);

                return Content(response.Headers.Location.ToString());
            }
            return Content(response.IsSuccessStatusCode.ToString());

            //client.BaseAddress = new Uri(URI);
            //client.DefaultRequestHeaders.Accept.Clear();

            //client.DefaultRequestHeaders.Add("x-api-key", "sk_4cabaabe9afb479889e760162bb9e52f");
            //client.DefaultRequestHeaders
            //      .Accept
            //      .Add(new MediaTypeWithQualityHeaderValue("application/json"));//ACCEPT header

            //HttpRequestMessage request = new HttpRequestMessage(HttpMethod.Post, "relativeAddress");
            //request.Content = new StringContent("{\"query\":\"C1=CC=CC=C1\",\"searchType\":\"SUBSTRUCTURE\",\"target\":\"aspirin\"}",
            //                                    System.Text.Encoding.UTF8,
            //                                    "application/json");//CONTENT-TYPE header

            //client.SendAsync(request)
            //      .ContinueWith(responseTask =>
            //      {
            //          Console.WriteLine("Response: {0}", responseTask.Result);
            //      });

            //      DataTable responseObj = new DataTable();
            //      var _httpClient = new HttpClient();
            //      string Url = "https://api.chemicalize.com/v1/search/structure";
            //      var data = new Dictionary<string, string>
            //                 {
            //                    {"query", "C1=CC=CC=C1"},
            //                    {"searchType", "SUBSTRUCTURE"},
            //                    {"target", "aspirin"}
            //                 };

            //      using (var httpClient = new HttpClient())
            //      {
            //          httpClient.BaseAddress = new Uri(Url);
            //          var content = new FormUrlEncodedContent(new[]
            //          {
            //              new KeyValuePair<string, string>("query", "C1=CC=CC=C1"),
            //              new KeyValuePair<string, string>("searchType", "SUBSTRUCTURE"),
            //              new KeyValuePair<string, string>("target", "aspirin"),
            //          });

            //          var jsoncontent = "query:C1=CC=CC=C1&searchType:SUBSTRUCTURE&target:aspirin";
            //          httpClient.DefaultRequestHeaders
            //.Accept
            //.Add(new MediaTypeWithQualityHeaderValue("application/json"));
            //          content.Headers.Add("x-api-key", "sk_4cabaabe9afb479889e760162bb9e52f");
            //          HttpResponseMessage response = new HttpResponseMessage();
            //          response = await httpClient.PostAsJsonAsync(Url, jsoncontent);
            //          if (response.IsSuccessStatusCode)
            //          {
            //              string result = response.Content.ReadAsStringAsync().Result;
            //              responseObj = JsonConvert.DeserializeObject<DataTable>(result);
            //          }
            //      }

            //restTemplate restTemplate = new RestTemplate();
            //URI serviceUri = new URI("https://api.chemicalize.com/v1/search/structure");
            //HttpHeaders headers = new HttpHeaders();
            //headers.set("x-api-key", "sk_4cabaabe9afb479889e760162bb9e52f");
            //Map<String, String> requestBody = Map.of("query", "C1=CC=CC=C1", "searchType", "SUBSTRUCTURE", "target", "aspirin");
            //ResponseEntity<HashMap<Object, Object>> response = restTemplate.exchange(
            //        RequestEntity.post(serviceUri).accept(MediaType.APPLICATION_JSON).headers(headers).body(requestBody),
            //        new ParameterizedTypeReference<HashMap<Object, Object>>() { });
            //System.out.println("Response body: " + response.getBody());
            // return View();
        }

        public void TakeScreenshot()
        {
            HttpWebRequest request = HttpWebRequest.Create("http://spms.synzeal.com/Form/TodayDashboard") as HttpWebRequest;
            Bitmap bitmap;
            using (Stream stream = request.GetResponse().GetResponseStream())
            {
                bitmap = new Bitmap(stream);
            }
        }

        public ActionResult Uploadquotation()
        {
            string path = Server.MapPath("~/img/");
            string[] filePaths = System.IO.Directory.GetFiles(path, "*.xlsx",
                                         SearchOption.AllDirectories);

            foreach (var item in filePaths)
            {
                var file = new FileInfo(item);

                using (var package = new ExcelPackage(file))
                {
                    var currentSheet = package.Workbook.Worksheets;
                    var workSheet = currentSheet.First();
                    var noOfCol = workSheet.Dimension.End.Column;
                    var noOfRow = workSheet.Dimension.End.Row;
                    for (int rowIterator = 2; rowIterator <= noOfRow; rowIterator++)
                    {
                        string quoteno = workSheet.Cells[rowIterator, 1].Value.ToString();
                        string companyname = workSheet.Cells[rowIterator, 2].Value != null ? workSheet.Cells[rowIterator, 2].Value.ToString() : string.Empty;
                        string email = workSheet.Cells[rowIterator, 3].Value != null ? workSheet.Cells[rowIterator, 3].Value.ToString() : string.Empty;
                        string isImageattach = workSheet.Cells[rowIterator, 4].Value != null ? workSheet.Cells[rowIterator, 4].Value.ToString() : "";

                        string countrytype = workSheet.Cells[rowIterator, 5].Value != null ? workSheet.Cells[rowIterator, 5].Value.ToString() : "";
                        string IsQuoteApproved = workSheet.Cells[rowIterator, 6].Value != null ? workSheet.Cells[rowIterator, 6].Value.ToString() : "";
                        string userdistType = workSheet.Cells[rowIterator, 7].Value != null ? workSheet.Cells[rowIterator, 7].Value.ToString() : "";
                        string ProductName = workSheet.Cells[rowIterator, 8].Value != null ? workSheet.Cells[rowIterator, 8].Value.ToString() : "";
                        string CATNo = workSheet.Cells[rowIterator, 9].Value != null ? workSheet.Cells[rowIterator, 9].Value.ToString() : "";
                        string CASNo = workSheet.Cells[rowIterator, 10].Value != null ? workSheet.Cells[rowIterator, 10].Value.ToString() : "";
                        string Price = workSheet.Cells[rowIterator, 11].Value != null ? workSheet.Cells[rowIterator, 11].Value.ToString() : "";
                        string LeadTime = workSheet.Cells[rowIterator, 12].Value != null ? workSheet.Cells[rowIterator, 12].Value.ToString() : "";
                        string DisplayOrder = workSheet.Cells[rowIterator, 13].Value != null ? workSheet.Cells[rowIterator, 13].Value.ToString() : "";
                        var companyData = db.SZ_CompanyList.Where(x => x.Name.Trim().ToLower().Contains(companyname.ToLower().Trim())).FirstOrDefault();
                        if (!string.IsNullOrEmpty(CATNo))
                        {
                            CATNo = CATNo.Trim();
                        }

                        if (companyData == null)
                        {
                            SZ_CompanyList comp = new SZ_CompanyList();
                            comp.Name = companyname;
                            comp.UserDistType = userdistType;
                            comp.CountryType = countrytype;
                            comp.CreatedBy = "System Generated";
                            comp.UpdatedBy = "System Generated";
                            comp.CreatedDate = DateTime.Now;
                            comp.UpdatedDate = DateTime.Now;
                            comp.IsPaymentPending = false;
                            db.SZ_CompanyList.Add(comp);
                            db.SaveChanges();

                            companyData = comp;
                        }

                        var productData = db.Products.AsNoTracking().Where(x => x.Deleted == false && x.Published == true && x.Sku.ToLower().Contains(CATNo.ToLower())).FirstOrDefault();

                        var objquote = db.SZ_Quotation.AsNoTracking().Where(x => x.Ref == quoteno.Trim()).FirstOrDefault();
                        if (objquote != null)
                        {
                            SZ_QuotationDetail objdetails = new SZ_QuotationDetail();
                            objdetails.IsUploadServer = true;
                            objdetails.CASNo = !string.IsNullOrEmpty(CASNo) ? CASNo : string.Empty;
                            objdetails.CATNo = CATNo;
                            objdetails.CreatedDate = DateTime.Now;
                            objdetails.LeadTime = LeadTime;
                            objdetails.Price = Price;
                            objdetails.ProductId = productData != null ? productData.Id : 0;
                            objdetails.IsUploadServer = productData != null ? true : false;
                            objdetails.CreatedDate = DateTime.Now;
                            objdetails.ProductName = ProductName;
                            objdetails.QuoteId = objquote.Id;
                            objdetails.DisplayOrder = !string.IsNullOrEmpty(DisplayOrder) ? Convert.ToInt32(DisplayOrder) : 0;
                            db.Entry(objdetails).State = EntityState.Added;

                        }
                        else
                        {
                            objquote = new SZ_Quotation();
                            objquote.Ref = quoteno;

                            if (companyData != null)
                            {
                                objquote.CompanyId = companyData.Id;
                                objquote.CompanyName = companyData.Name;
                            }
                            objquote.EmailAddress = email;
                            objquote.IsImageAttach = isImageattach == "1" ? true : false;
                            objquote.PONo = string.Empty;
                            objquote.IsImportedQuote = true;
                            objquote.UserDistType = userdistType;
                            objquote.CountryType = countrytype;
                            objquote.LayoutType = "Standard";
                            objquote.CreatedDate = DateTime.Now;
                            objquote.CreatedBy = SessionCookieManagement.UserName;
                            if (objquote.CountryType == "Export")
                            {
                                objquote.IsAnalyticalData = true;
                            }
                            db.SZ_Quotation.Add(objquote);

                            SZ_QuotationDetail objdetails = new SZ_QuotationDetail();
                            objdetails.IsUploadServer = true;
                            objdetails.CASNo = !string.IsNullOrEmpty(CASNo) ? CASNo : string.Empty;
                            objdetails.CATNo = CATNo;
                            objdetails.CreatedDate = DateTime.Now;
                            objdetails.LeadTime = LeadTime;
                            objdetails.Price = Price;
                            objdetails.ProductId = productData != null ? productData.Id : 0;
                            objdetails.ProductName = ProductName;
                            objdetails.QuoteId = objquote.Id;
                            objdetails.IsUploadServer = productData != null ? true : false;
                            objdetails.CreatedDate = DateTime.Now;
                            objdetails.DisplayOrder = !string.IsNullOrEmpty(DisplayOrder) ? Convert.ToInt32(DisplayOrder) : 0;
                            db.SZ_QuotationDetail.Add(objdetails);
                        }
                        db.SaveChanges();
                    }
                }
            }
            return Content("asd");
        }

        public ActionResult EmailTest()
        {
            try
            {
                var htmlstring = "<h1>Email works fine</h1>";
                htmlstring = "<html><head></head><body style='font-family:Tahoma, Verdana, Segoe, sans-serif;font-size:11px;'>" + htmlstring + "</body></html>";

                MailMessage mail = new MailMessage();
                SmtpClient SmtpServer = new SmtpClient(ConfigurationManager.AppSettings["Email.Host"]);
                mail.From = new MailAddress(ConfigurationManager.AppSettings["Email.Username"], "SynZeal Standards");

                mail.To.Add(ConfigurationManager.AppSettings["DevEmailAddress"].ToString());

                mail.Subject = "SynZeal Research Quotation Module :: Email works fine";

                mail.Body = htmlstring;
                mail.IsBodyHtml = true;
                SmtpServer.Port = Convert.ToInt32(ConfigurationManager.AppSettings["Port"]);
                SmtpServer.Credentials = new System.Net.NetworkCredential(ConfigurationManager.AppSettings["Email.Username"], ConfigurationManager.AppSettings["Email.Password"]);
                SmtpServer.EnableSsl = true;
                SmtpServer.Send(mail);
            }
            catch (Exception ex)
            {
                return Content(ex.Message);
            }
            return Content("Success");
        }

        public ActionResult deploy()
        {
            var settingdeploydata = db.Settings.Where(x => x.Name == "isDeploy").FirstOrDefault();
            var settingdeploydatedata = db.Settings.Where(x => x.Name == "DeployDate").FirstOrDefault();
            if (settingdeploydata != null)
            {
                var value = Convert.ToBoolean(settingdeploydata.Value);
                if (value)
                {
                    settingdeploydata.Value = "false";
                }
                else
                {
                    settingdeploydata.Value = "true";
                    settingdeploydatedata.Value = DateTime.Now.AddMinutes(5).ToString();
                }
                db.Entry(settingdeploydata).State = EntityState.Modified;
                db.Entry(settingdeploydatedata).State = EntityState.Modified;
                db.SaveChanges();
            }

            return Content("success");
        }

        public ActionResult MarkasPaid(string invoiceno, bool paid)
        {
            if (!string.IsNullOrEmpty(invoiceno))
            {
                invoiceno = invoiceno.Trim().ToLower();
            }
            var data = db.SZ_QuotationDetail.AsNoTracking().Where(x => x.InvoiceNo.Trim().ToLower() == invoiceno).ToList();
            if (data != null && data.Count > 0)
            {
                foreach (var item in data)
                {
                    item.PaymentStatus = "Paid";
                    db.Entry(item).State = EntityState.Modified;
                }
                db.SaveChanges();
            }

            return RedirectToAction("PaymentUpdate");
        }

        public ActionResult Index()
        {
            return View();
        }
        public ActionResult PaymentUpdate()
        {
            return View();
        }
        public ActionResult Dashboard()
        {
            if (!SessionCookieManagement.IsAdmin && !SessionCookieManagement.IsQuote && SessionCookieManagement.UserEmail != "jinish@synzeal.com")
            {
                return RedirectToAction("Index", "Home");
            }
            //var model = db.Dashboard().ToArray();
            return View(new Dashboard_Result());
        }
        public ActionResult SciDashboard()
        {
            if (!SessionCookieManagement.IsLogin && (!SessionCookieManagement.IsScientist || !SessionCookieManagement.IsSubScientist))
            {
                return RedirectToAction("Index", "Home");
            }

            string subscientistname = Convert.ToString(SessionCookieManagement.UserId);
            var model = new List<SZ_QuotationDetail>();
            using (var txn = new TransactionScope(TransactionScopeOption.Required))
            {
                // Your LINQ to SQL query goes here
                model = (from i in db.SZ_Quotation.AsNoTracking()
                         join t2 in db.SZ_QuotationDetail.AsNoTracking() on i.Id equals t2.QuoteId
                         where t2.ScientistCustomerId == SessionCookieManagement.UserId
                         || t2.SubScientistName == subscientistname
                         //&& (t2.IsOnHold == false || t2.IsOnHold == null)
                         orderby t2.MoveToScientistDate descending
                         select t2).ToList();
            }

            //var model = (from i in db.SZ_Quotation
            //             join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
            //             where t2.ScientistCustomerId == SessionCookieManagement.UserId
            //             || t2.SubScientistName == subscientistname
            //             //&& (t2.IsOnHold == false || t2.IsOnHold == null)
            //             orderby t2.MoveToScientistDate descending
            //             select t2).ToList();

            var quotedetailIds = model.Select(x => x.Id).ToList();
            var formidlist = db.SZ_QuoteDetails_Form.Where(x => quotedetailIds.Contains(x.QuoteDetailsId)).Select(x => x.FormId).ToArray();

            var quotedetailsformList = db.SZ_QuoteDetailForm.Where(x => formidlist.Contains(x.Id)).ToList();
            var scientistStatusList = db.SZ_ScientistStatus.ToList();
            var ReadyToDeliverScientistStatusId = scientistStatusList.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
            var proIds = model.Select(x => x.ProductId).ToList();
            var szInventory = db.SZ_Inventory.Where(x => proIds.Contains(x.ProductId)).ToList();
            var listItems = new List<SelectListItem>();
            MemoryCacheManager objCache = new MemoryCacheManager();

            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });
            var scienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("scientist")).ToList();
            foreach (var term in scienList)
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                listItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.Id.ToString()
                });
            }
            var subscienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();
            foreach (var term in subscienList)
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                listItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.Id.ToString()
                });
            }
            ViewBag.scientistItems = listItems;
            var list = new List<SZ_QuotationModel>();
            foreach (var k in model)
            {
                if (k.SZ_Quotation == null)
                {
                    continue;
                }
                SZ_QuotationModel subList = new SZ_QuotationModel();
                subList.QuoteId = k.QuoteId;
                subList.IsImageAttach = k.SZ_Quotation.IsImageAttach;
                subList.CompanyName = k.SZ_Quotation.CompanyName;
                subList.Email = k.SZ_Quotation.EmailAddress;
                subList.PONumber = k.SZ_Quotation.PONo;
                subList.Ref = k.SZ_Quotation.Ref;
                subList.Remark = k.SZ_Quotation.Remark;
                subList.MoveToScientistDate = k.MoveToScientistDate;
                subList.SZ_QuotationProductModel = new List<SZ_QuotationProductModel>();

                SZ_QuotationProductModel objlist = new SZ_QuotationProductModel();
                objlist.ReadyToDeliverScientistStatusId = ReadyToDeliverScientistStatusId;
                objlist.ScientistFormCount = quotedetailsformList.Where(x => x.QuotationDetailsId == k.Id).Count();
                objlist.QuoteDetailsId = k.Id;
                objlist.IsHoldManually = k.IsHoldManually;
                objlist.CASNo = k.CASNo;
                objlist.CATNo = k.CATNo;
                objlist.CATText = "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>";
                objlist.MoveToScientistDate = k.MoveToScientistDate;
                objlist.CreatedDate = k.CreatedDate;
                objlist.ImagePath = k.ImagePath;
                objlist.IsUploadServer = k.IsUploadServer;
                objlist.LeadTime = k.LeadTime;
                objlist.Price = k.Price;
                objlist.ProductId = k.ProductId;
                objlist.ProductName = k.ProductName;
                objlist.QuoteId = k.QuoteId;
                objlist.ProjectType = k.ProjectType;
                objlist.ScientistCustomerId = k.ScientistCustomerId;
                objlist.RequiredQty = k.RequiredQty;
                objlist.ProjectStatus = k.ProjectStatus;
                objlist.ScientistStatus = k.ScientistStatus;
                objlist.BatchCode1 = k.BatchCode1;
                objlist.BatchCode2 = k.BatchCode2;
                objlist.Qty1 = k.Qty1;
                objlist.Qty2 = k.Qty2;
                objlist.BatchNo = k.BatchNo;
                objlist.AdditionalBatchNo = k.AdditionalBatchNo;
                objlist.MoveToDispatch = k.MoveToDispatch;
                objlist.MoveToProject = k.MoveToProject;
                objlist.Remark = k.Remark;
                objlist.IsSynthesisLog = k.IsSynthesisLog;
                objlist.EstimateCompleteDate = k.EstimateCompleteDate;
                if (k.ProjectStatus != null)
                {
                    objlist.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
                }
                objlist.ScientistStatustext = scientistStatusList.Where(x => x.Id == k.ScientistStatus).Select(x => x.Name).FirstOrDefault();
                objlist.SubScientistName = k.SubScientistName;
                if (!string.IsNullOrEmpty(k.SubScientistName))
                {
                    var subsci = System.Text.RegularExpressions.Regex.IsMatch(k.SubScientistName, @"\d+");
                    if (subsci)
                    {
                        if (System.Text.RegularExpressions.Regex.Match(k.SubScientistName, @"\d+").Value == k.SubScientistName)
                        {
                            var subsciids = Convert.ToInt32(k.SubScientistName);
                            foreach (var r in listItems)
                            {
                                string selected = string.Empty;
                                if (r.Value == Convert.ToString(subsciids))
                                {
                                    objlist.SubScientistName = r.Text;
                                }
                            }
                        }
                    }
                }
                if (k.ProductId.HasValue)
                {
                    string selected = string.Empty;
                    objlist.AdditionalBatchNoText = "<select id='additionalBatch_" + k.ProductId + "' class='addbatch'><option value=''>--Select--</option>";
                    var proBatchData = szInventory.Where(x => x.ProductId == k.ProductId).OrderBy(x => x.Id).ToList();
                    if (proBatchData.Count > 0)
                    {
                        int probatchcount = 1;
                        foreach (var r in proBatchData)
                        {
                            string qty = CommonOperation.SettleQtyForSPMS(r);
                            string text = r.BatchNo + " (" + qty + ")";
                            if (r.IsApproved == false)
                            {
                                text = "*" + text;
                            }

                            if (k.AdditionalBatchNo.HasValue && k.AdditionalBatchNo.Value == r.Id)
                            {
                                selected = " selected ";
                            }
                            objlist.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' data-value='" + r.BatchNo + "' " + selected + ">" + text + "</option>";
                            probatchcount += 1;
                        }
                    }
                    objlist.AdditionalBatchNoText += "</select>";
                }
                objlist.Reason = k.Reason;
                objlist.IsOnHold = k.IsOnHold;
                objlist.TrackingNo = k.TrackingNo;
                objlist.QueryText = k.QueryText;
                objlist.QueryDate = k.QueryDate;
                objlist.IsAssignProjectQuery = k.IsAssignProjectQuery;
                objlist.IsAssignScientistQuery = k.IsAssignScientistQuery;
                objlist.IsQueryResolved = k.IsQueryResolved;
                objlist.IsPriority = k.IsPriority;
                objlist.Chemist = k.Chemist;
                if (!string.IsNullOrEmpty(k.DifficultyLevel))
                {
                    EnumList.DifficultyLevel oldfoo = (EnumList.DifficultyLevel)Enum.ToObject(typeof(EnumList.DifficultyLevel), Convert.ToInt32(k.DifficultyLevel));
                    objlist.DifficultyLevel = Common.GetDescription<EnumList.DifficultyLevel>(oldfoo);
                }
                subList.SZ_QuotationProductModel.Add(objlist);
                list.Add(subList);
            }

            var RePurificationstatus = Convert.ToString((int)EnumList.ProjectType.RePurification);
            var ReSynthesisstatus = Convert.ToString((int)EnumList.ProjectType.ReSynthesis);
            var Dryingstatus = Convert.ToString((int)EnumList.ProjectType.Drying);
            string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
            ViewBag.NoActionCount = list.
                Select(z => z.SZ_QuotationProductModel.Where(x => string.IsNullOrEmpty(x.SubScientistName)
                && x.ReadyToDeliverScientistStatusId != x.ScientistStatus
                && x.ProjectType != inhouseProjectType && (x.IsOnHold == false || x.IsOnHold == null)
                && string.IsNullOrEmpty(x.TrackingNo)).Count()).Sum(x => x);

            ViewBag.All = list.
                Select(z => z.SZ_QuotationProductModel.Where(x => !string.IsNullOrEmpty(x.SubScientistName) && x.ReadyToDeliverScientistStatusId != x.ScientistStatus && x.ProjectType != inhouseProjectType && x.ProjectType != RePurificationstatus && x.ProjectType != Dryingstatus && x.ProjectType != ReSynthesisstatus && (x.IsOnHold == false || x.IsOnHold == null) && (x.IsHoldManually == false || x.IsHoldManually == null) && string.IsNullOrEmpty(x.TrackingNo)).Count()).Sum(x => x);

            ViewBag.Reprocess = list.
                Select(z => z.SZ_QuotationProductModel.Where(x => x.ReadyToDeliverScientistStatusId != x.ScientistStatus && x.ProjectType != inhouseProjectType && (x.ProjectType == RePurificationstatus || x.ProjectType == Dryingstatus || x.ProjectType == ReSynthesisstatus) && (x.IsOnHold == false || x.IsOnHold == null) && (x.IsHoldManually == false || x.IsHoldManually == null) && string.IsNullOrEmpty(x.TrackingNo)).Count()).Sum(x => x);


            ViewBag.Completed = list.
                Select(z => z.SZ_QuotationProductModel.Where(x => x.ScientistStatus == x.ReadyToDeliverScientistStatusId && (x.IsOnHold == false || x.IsOnHold == null)).Count()).Sum(x => x);

            ViewBag.Scaleup = list.
                Select(z => z.SZ_QuotationProductModel.Where(x => x.ReadyToDeliverScientistStatusId != x.ScientistStatus && x.ProjectType == inhouseProjectType && (x.IsOnHold == false || x.IsOnHold == null)).Count()).Sum(x => x);

            ViewBag.Hold = list.
                Select(z => z.SZ_QuotationProductModel.Where(x => x.IsHoldManually == true).Count()).Sum(x => x);

            ViewBag.Cancelled = list.
                Select(z => z.SZ_QuotationProductModel.Where(x => x.IsOnHold == true).Count()).Sum(x => x);

            ViewBag.Query = list.
                Select(z => z.SZ_QuotationProductModel.Where(x => !string.IsNullOrEmpty(x.QueryText)).Count()).Sum(x => x);

            ViewBag.SynthesisLog = list.
                Select(z => z.SZ_QuotationProductModel.Where(x => x.IsSynthesisLog == true && string.IsNullOrEmpty(z.PONumber)).Count()).Sum(x => x);

            var labelData = new List<string>();

            foreach (var i in list)
            {
                foreach (var k in i.SZ_QuotationProductModel.Where(x => (x.EstimateCompleteDate == null || x.EstimateCompleteDate.Value.Date < DateTime.Now.Date) && x.ReadyToDeliverScientistStatusId != x.ScientistStatus && x.ProjectType != inhouseProjectType && (x.IsOnHold == false || x.IsOnHold == null) && string.IsNullOrEmpty(x.TrackingNo)).OrderByDescending(x => x.EstimateCompleteDate))
                {
                    try
                    {
                        var month = k.EstimateCompleteDate.Value.Month.ToString();
                        var year = k.EstimateCompleteDate.Value.Year.ToString();
                        var strName = month + "-" + year;
                        if (!labelData.Contains(strName))
                        {
                            labelData.Add(strName);
                        }
                    }
                    catch
                    {

                    }
                }
            }
            System.Globalization.DateTimeFormatInfo mfi = new System.Globalization.DateTimeFormatInfo();

            var chartModel = new List<ChartModel>();
            foreach (var item in labelData)
            {
                ChartModel subModel = new ChartModel();
                var month = Convert.ToInt32(item.Split('-')[0]);
                var year = Convert.ToInt32(item.Split('-')[1]);
                subModel.Month = month;
                subModel.Year = year;
                subModel.LabelName = mfi.GetMonthName(month).ToString() + "-" + year.ToString();
                subModel.Count = list.Select(z => z.SZ_QuotationProductModel.Where(x => x.EstimateCompleteDate != null && x.EstimateCompleteDate.Value.Month == month && x.EstimateCompleteDate.Value.Year == year && x.ReadyToDeliverScientistStatusId != x.ScientistStatus && x.ProjectType != inhouseProjectType && (x.IsOnHold == false || x.IsOnHold == null) && string.IsNullOrEmpty(x.TrackingNo)).Count()).Sum();
                chartModel.Add(subModel);
            }
            ViewBag.chartModel = chartModel.OrderBy(x => x.Year).ThenBy(x => x.Month).ToList();
            List<OverviewSciDashboard> overscimodel = new List<OverviewSciDashboard>();

            foreach (EnumList.DifficultyLevel r in Enum.GetValues(typeof(EnumList.DifficultyLevel)))
            {
                var item = Enum.GetName(typeof(EnumList.DifficultyLevel), r);
                var test = r.ToString();
                string text = SZ_Helper.GetEnumDescription((EnumList.DifficultyLevel)(int)r);
                int val = (int)r;

                OverviewSciDashboard suboverscimodelontrack = new OverviewSciDashboard();
                suboverscimodelontrack.ProductCount = list.Select(z => z.SZ_QuotationProductModel.Where(x => (x.EstimateCompleteDate == null || x.EstimateCompleteDate.Value.AddDays(7).Date < DateTime.Now.Date) && x.ReadyToDeliverScientistStatusId != x.ScientistStatus && x.ProjectType != inhouseProjectType && (x.IsOnHold == false || x.IsOnHold == null) && string.IsNullOrEmpty(x.TrackingNo) && x.DifficultyLevel == test).Count()).Sum();
                suboverscimodelontrack.CoumnName = text;
                suboverscimodelontrack.RowName = "On Track";
                overscimodel.Add(suboverscimodelontrack);

                OverviewSciDashboard suboverscimodeldelay = new OverviewSciDashboard();
                suboverscimodeldelay.ProductCount = list.Select(z => z.SZ_QuotationProductModel.Where(x => (x.EstimateCompleteDate == null || x.EstimateCompleteDate.Value.AddDays(14).Date < DateTime.Now.Date) && x.ReadyToDeliverScientistStatusId != x.ScientistStatus && x.ProjectType != inhouseProjectType && (x.IsOnHold == false || x.IsOnHold == null) && string.IsNullOrEmpty(x.TrackingNo) && x.DifficultyLevel == test).Count()).Sum();
                suboverscimodeldelay.CoumnName = text;
                suboverscimodeldelay.RowName = "Delayed";
                overscimodel.Add(suboverscimodeldelay);

                OverviewSciDashboard suboverscimodelSignificantDelayed = new OverviewSciDashboard();
                suboverscimodelSignificantDelayed.ProductCount = list.Select(z => z.SZ_QuotationProductModel.Where(x => (x.EstimateCompleteDate != null && x.MoveToScientistDate != null && x.EstimateCompleteDate.Value.AddDays(((x.EstimateCompleteDate.Value - x.MoveToScientistDate.Value).TotalDays) * 2).Date < DateTime.Now.Date) && x.ReadyToDeliverScientistStatusId != x.ScientistStatus && x.ProjectType != inhouseProjectType && (x.IsOnHold == false || x.IsOnHold == null) && string.IsNullOrEmpty(x.TrackingNo) && x.DifficultyLevel == test).Count()).Sum();
                suboverscimodelSignificantDelayed.CoumnName = text;
                suboverscimodelSignificantDelayed.RowName = "Significant Delayed";
                overscimodel.Add(suboverscimodelSignificantDelayed);

                OverviewSciDashboard suboverscimodelAttention = new OverviewSciDashboard();
                suboverscimodelAttention.ProductCount = list.Select(z => z.SZ_QuotationProductModel.Where(x => (x.EstimateCompleteDate != null && x.MoveToScientistDate != null && x.EstimateCompleteDate.Value.AddDays(((x.EstimateCompleteDate.Value - x.MoveToScientistDate.Value).TotalDays) * 3).Date < DateTime.Now.Date) && x.ReadyToDeliverScientistStatusId != x.ScientistStatus && x.ProjectType != inhouseProjectType && (x.IsOnHold == false || x.IsOnHold == null) && string.IsNullOrEmpty(x.TrackingNo) && x.DifficultyLevel == test).Count()).Sum();
                suboverscimodelAttention.CoumnName = text;
                suboverscimodelAttention.RowName = "Attention";
                overscimodel.Add(suboverscimodelAttention);

                OverviewSciDashboard suboverscimodelTempHold = new OverviewSciDashboard();
                suboverscimodelTempHold.ProductCount = list.Select(z => z.SZ_QuotationProductModel.Where(x => x.IsHoldManually == true && x.DifficultyLevel == test).Count()).Sum();
                suboverscimodelTempHold.CoumnName = text;
                suboverscimodelTempHold.RowName = "Temp Hold";
                overscimodel.Add(suboverscimodelTempHold);

                OverviewSciDashboard suboverscimodelCancelled = new OverviewSciDashboard();
                suboverscimodelCancelled.ProductCount = list.Select(z => z.SZ_QuotationProductModel.Where(x => x.IsOnHold == true && x.DifficultyLevel == test).Count()).Sum();
                suboverscimodelCancelled.CoumnName = text;
                suboverscimodelCancelled.RowName = "Cancelled";
                overscimodel.Add(suboverscimodelCancelled);
            }

            OverviewSciDashboard suboverscimodeldlabelontrack = new OverviewSciDashboard();
            suboverscimodeldlabelontrack.ProductCount = list.Select(z => z.SZ_QuotationProductModel.Where(x => (x.EstimateCompleteDate == null || x.EstimateCompleteDate.Value.AddDays(7).Date < DateTime.Now.Date) && x.ReadyToDeliverScientistStatusId != x.ScientistStatus && x.ProjectType != inhouseProjectType && (x.IsOnHold == false || x.IsOnHold == null) && string.IsNullOrEmpty(x.TrackingNo) && string.IsNullOrEmpty(x.DifficultyLevel)).Count()).Sum();
            suboverscimodeldlabelontrack.CoumnName = "Not assigned D";
            suboverscimodeldlabelontrack.RowName = "On Track";
            overscimodel.Add(suboverscimodeldlabelontrack);

            OverviewSciDashboard suboverscimodeldlabeldelay = new OverviewSciDashboard();
            suboverscimodeldlabeldelay.ProductCount = list.Select(z => z.SZ_QuotationProductModel.Where(x => (x.EstimateCompleteDate == null || x.EstimateCompleteDate.Value.AddDays(14).Date < DateTime.Now.Date) && x.ReadyToDeliverScientistStatusId != x.ScientistStatus && x.ProjectType != inhouseProjectType && (x.IsOnHold == false || x.IsOnHold == null) && string.IsNullOrEmpty(x.TrackingNo) && string.IsNullOrEmpty(x.DifficultyLevel)).Count()).Sum();
            suboverscimodeldlabeldelay.CoumnName = "Not assigned D";
            suboverscimodeldlabeldelay.RowName = "Delayed";
            overscimodel.Add(suboverscimodeldlabeldelay);

            OverviewSciDashboard suboverscimodelSignificantdlabelDelayed = new OverviewSciDashboard();
            suboverscimodelSignificantdlabelDelayed.ProductCount = list.Select(z => z.SZ_QuotationProductModel.Where(x => (x.EstimateCompleteDate != null && x.MoveToScientistDate != null && x.EstimateCompleteDate.Value.AddDays(((x.EstimateCompleteDate.Value - x.MoveToScientistDate.Value).TotalDays) * 2).Date < DateTime.Now.Date) && x.ReadyToDeliverScientistStatusId != x.ScientistStatus && x.ProjectType != inhouseProjectType && (x.IsOnHold == false || x.IsOnHold == null) && string.IsNullOrEmpty(x.TrackingNo) && string.IsNullOrEmpty(x.DifficultyLevel)).Count()).Sum();
            suboverscimodelSignificantdlabelDelayed.CoumnName = "Not assigned D";
            suboverscimodelSignificantdlabelDelayed.RowName = "Significant Delayed";
            overscimodel.Add(suboverscimodelSignificantdlabelDelayed);

            OverviewSciDashboard suboverscimodeldlabelAttention = new OverviewSciDashboard();
            suboverscimodeldlabelAttention.ProductCount = list.Select(z => z.SZ_QuotationProductModel.Where(x => (x.EstimateCompleteDate != null && x.MoveToScientistDate != null && x.EstimateCompleteDate.Value.AddDays(((x.EstimateCompleteDate.Value - x.MoveToScientistDate.Value).TotalDays) * 3).Date < DateTime.Now.Date) && x.ReadyToDeliverScientistStatusId != x.ScientistStatus && x.ProjectType != inhouseProjectType && (x.IsOnHold == false || x.IsOnHold == null) && string.IsNullOrEmpty(x.TrackingNo) && string.IsNullOrEmpty(x.DifficultyLevel)).Count()).Sum();
            suboverscimodeldlabelAttention.CoumnName = "Not assigned D";
            suboverscimodeldlabelAttention.RowName = "Attention";
            overscimodel.Add(suboverscimodeldlabelAttention);

            OverviewSciDashboard suboverscimodeldlabelTempHold = new OverviewSciDashboard();
            suboverscimodeldlabelTempHold.ProductCount = list.Select(z => z.SZ_QuotationProductModel.Where(x => x.IsHoldManually == true && string.IsNullOrEmpty(x.DifficultyLevel)).Count()).Sum();
            suboverscimodeldlabelTempHold.CoumnName = "Not assigned D";
            suboverscimodeldlabelTempHold.RowName = "Temp Hold";
            overscimodel.Add(suboverscimodeldlabelTempHold);

            OverviewSciDashboard suboverscimodeldlabelCancelled = new OverviewSciDashboard();
            suboverscimodeldlabelCancelled.ProductCount = list.Select(z => z.SZ_QuotationProductModel.Where(x => x.IsOnHold == true && string.IsNullOrEmpty(x.DifficultyLevel)).Count()).Sum();
            suboverscimodeldlabelCancelled.CoumnName = "Not assigned D";
            suboverscimodeldlabelCancelled.RowName = "Cancelled";
            overscimodel.Add(suboverscimodeldlabelCancelled);

            ViewBag.OverSciModel = overscimodel;
            return View(list.OrderByDescending(x => x.MoveToScientistDate).ToList());
        }
        public ActionResult CompanyDashboard()
        {
            if (!SessionCookieManagement.IsAdmin && !SessionCookieManagement.IsQuote && SessionCookieManagement.UserEmail != "jinish@synzeal.com")
            {
                return RedirectToAction("Index", "Home");
            }
            var model = db.Dashboard().ToArray();
            return View(model);
        }

        public ActionResult Search()
        {
            return View();
        }

        public ActionResult TempPDF()
        {
            string htmlstring = "<html><body><h1 style='font-family:andalus; font-size:30px;text-align:center;font-weight:bold'>CERTIFICATE OF ANALYSIS</h1><p>My first paragraph.</p></body></html>";
            string path = ConvertHTMLToPDF(htmlstring, filenameDateWise("testcoa"));
            return File(path, "application/pdf", Server.UrlEncode("testPDF.pdf"));
        }

        public string GetQuotePlace(SZ_Quotation q, SZ_QuotationDetail qd)
        {
            if (qd == null)
            {
                return "All";
            }
            var str = "";
            if ((q.IsToBe == null || q.IsToBe == false) && (q.IsQuoteApproved == false || q.IsQuoteApproved == null) &&
                (q.IsPark == false || q.IsPark == null) && !q.CompanyName.Contains("synzeal"))
            {
                str = "All";
            }
            if (q.IsToBe == true && (qd.IsSynthesisLog == null || qd.IsSynthesisLog == false) && (q.IsQuoteApproved == false || q.IsQuoteApproved == null) &&
                (q.IsPark == false || q.IsPark == null) && q.UserDistType == "User")
            {
                str = "Pending User";
            }
            if (q.IsToBe == true && (qd.IsSynthesisLog == null || qd.IsSynthesisLog == false) && (q.IsQuoteApproved == false || q.IsQuoteApproved == null) &&
                (q.IsPark == false || q.IsPark == null) && q.UserDistType == "Distributor")
            {
                str = "Pending Distributor";
            }
            if (q.IsQuoteApproved == true && (qd.IsSynthesisLog == null || qd.IsSynthesisLog == false)
                && (q.IsPark == false || q.IsPark == null))
            {
                str = "Approved";
            }
            return str;
        }

        [HttpPost]
        public JsonResult LoadQuicksearchQuotationData()
        {
            try
            {
                var searchby = string.Empty;
                var searchbyvalue = string.Empty;
                if (Request.Form.GetValues("radiobuton") != null)
                {
                    searchby = Request.Form.GetValues("radiobuton")[0].ToString();
                }
                if (Request.Form.GetValues("searchbox") != null)
                {
                    searchbyvalue = Request.Form.GetValues("searchbox")[0].ToString().Trim();
                }

                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                int numberOfObjectsPerPage = Convert.ToInt32(Request.Form["length"]);
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int pageNo = 1;
                if (skip > 0)
                {
                    pageNo = (skip / numberOfObjectsPerPage) + 1;
                }

                if (string.IsNullOrEmpty(searchbyvalue))
                {
                    return Json(new { draw = draw, recordsFiltered = 0, recordsTotal = 0, data = new List<QuotationListModel>() });
                }
                else
                {
                    DateTime prevdate = DateTime.Now.AddDays(-7);
                    var query = (from q in db.SZ_Quotation.AsNoTracking()
                                 join qd in db.SZ_QuotationDetail.AsNoTracking() on q.Id equals qd.QuoteId
                                 where qd.CreatedDate <= DateTime.Now && qd.CreatedDate >= prevdate
                                 select new QuotationListModel
                                 {
                                     QuoteId = q.Id,
                                     Ref = q.Ref,
                                     PONumber = q.PONo,
                                     CompanyName = q.CompanyName,
                                     ProductName = qd.ProductName,
                                     CASNo = qd.CASNo,
                                     CATNo = qd.CATNo,
                                     LeadTime = qd.LeadTime,
                                     Price = qd.Price,
                                     SZ_QuotationData = q,
                                     SZ_QuotationDetailData = qd
                                     //ActionRow = GetQuotePlace(q, qd)
                                 }).AsQueryable();

                    searchbyvalue = searchbyvalue.ToLower();
                    if (searchby == "quoteid")
                    {
                        query = query.Where(x => x.Ref.ToLower().Contains(searchbyvalue)).AsQueryable();
                    }
                    if (searchby == "ponumber")
                    {
                        query = query.Where(x => x.PONumber.ToLower().Contains(searchbyvalue)).AsQueryable();
                    }
                    if (searchby == "company")
                    {
                        query = query.Where(x => x.CompanyName.ToLower().Contains(searchbyvalue)).AsQueryable();
                    }
                    if (searchby == "productname")
                    {
                        searchbyvalue = searchbyvalue.ToLower().Trim();
                        query = query.Where(x => x.ProductName.ToLower().Trim().Contains(searchbyvalue)).AsQueryable();
                    }
                    if (searchby == "cas")
                    {
                        query = query.Where(x => x.CASNo.ToLower().Contains(searchbyvalue)).AsQueryable();
                    }
                    if (searchby == "cat")
                    {
                        query = query.Where(x => x.CATNo.ToLower().Contains(searchbyvalue)).AsQueryable();
                    }

                    var model = query.ToList();
                    foreach (var item in model)
                    {
                        item.Location = GetQuotePlace(item.SZ_QuotationData, item.SZ_QuotationDetailData);
                        item.SZ_QuotationData = null;
                        item.SZ_QuotationDetailData = null;
                        item.ActionRow = "<a href='javascript:void(0)' onclick='OpenQuoteDetailPage(\"" + item.QuoteId + "\")' > Select</a>";
                    }
                    int? recordsTotal = model.Count();
                    var jsonResult = Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = model }, JsonRequestBehavior.AllowGet);
                    jsonResult.MaxJsonLength = int.MaxValue;
                    return jsonResult;
                }


            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        [HttpPost]
        public JsonResult LoadBugData(string status)
        {
            try
            {
                var companysearch = string.Empty;
                var penuserdate = string.Empty;
                var countrytypesearch = string.Empty;
                var tablename = string.Empty;
                var searchbyvalue = string.Empty;
                if (Request.Form.GetValues("searchbox") != null)
                {
                    searchbyvalue = Request.Form.GetValues("searchbox")[0].Trim().ToString();
                }
                var length = Request.Form.GetValues("length").FirstOrDefault();
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                int numberOfObjectsPerPage = Convert.ToInt32(Request.Form["length"]);
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int pageNo = 1;
                if (skip > 0)
                {
                    pageNo = (skip / numberOfObjectsPerPage) + 1;
                }

                var model = new List<SZ_Bug>();
                if (SessionCookieManagement.IsAdmin)
                {
                    if (status == "closed")
                    {
                        model = db.SZ_Bug.Where(x => x.Status == "CLOSED").OrderByDescending(x => x.CreatedDate).ToList();
                    }
                    else
                    {
                        model = db.SZ_Bug.Where(x => x.Status != "CLOSED").OrderByDescending(x => x.CreatedDate).ToList();
                    }
                }
                else
                {
                    if (status == "closed")
                    {
                        model = db.SZ_Bug.Where(x => x.Status == "CLOSED" && x.CreatedUserId == SessionCookieManagement.UserId).OrderByDescending(x => x.CreatedDate).ToList();
                    }
                    else
                    {
                        model = db.SZ_Bug.Where(x => x.Status != "CLOSED" && x.CreatedUserId == SessionCookieManagement.UserId).OrderByDescending(x => x.CreatedDate).ToList();
                    }
                }

                var recordsTotal = model.Count();

                var data = model.Skip(skip).Take(pageSize).ToList();
                if (data != null && data.Count > 0)
                {
                    data.ForEach(item =>
                    {
                        item.URL = item.CreatedDate.Value.ToShortDateString();
                        item.Description = "<a href='/Form/Bug/" + item.Id + "'>Edit</a>";
                    });
                }
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }
        }

        [HttpPost]
        public JsonResult LoadgeneratedInvoiceData()
        {
            try
            {
                var companysearch = string.Empty;
                var penuserdate = string.Empty;
                var countrytypesearch = string.Empty;
                var tablename = string.Empty;

                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                int numberOfObjectsPerPage = Convert.ToInt32(Request.Form["length"]);
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int pageNo = 1;
                if (skip > 0)
                {
                    pageNo = (skip / numberOfObjectsPerPage) + 1;
                }

                var model = db.SZ_InvoiceData.OrderByDescending(x => x.InvoiceDate).ToList();
                if (!string.IsNullOrEmpty(searchValue))
                {
                    model = model.Where(x => (x.InvoiceNo != null && x.InvoiceNo.Contains(searchValue)) ||
                    x.ShipCountry.Contains(searchValue) ||
                    x.CompanyName.Contains(searchValue)).ToList();
                }

                string internationcompanylist = "";
                if (SessionCookieManagement.IsInternational)
                {
                    internationcompanylist = db.SZ_UserManagement.Where(x => x.UserId == SessionCookieManagement.UserId).Select(x => x.CompanyIds).FirstOrDefault();
                    if (!string.IsNullOrEmpty(internationcompanylist))
                    {
                        List<int?> cidList = new List<int?>();
                        foreach (var item in internationcompanylist.Split(','))
                        {
                            if (!string.IsNullOrEmpty(item))
                            {
                                cidList.Add(Convert.ToInt32(item));
                            }
                        }
                        model = model.Where(x => cidList.Contains(x.CompanyId) && x.CreatedDate >= new DateTime(2022, 05, 01)).ToList();
                    }
                }

                int? recordsTotal = model.Count;

                model = model.Skip((pageNo - 1) * numberOfObjectsPerPage).Take(numberOfObjectsPerPage).ToList();
                var compdata = db.SZ_CompanyList.ToList();
                var outputModel = new List<SZ_InvoiceData>();
                if (model != null && model.Count > 0)
                {
                    model.ForEach(item =>
                    {
                        item.Courier = item.InvoiceDate.ToShortDateString();
                        item.TrackingNo = "<a href='/Form/DownloadInvoice/" + item.Id + "' target='_blank'>Download</a>";
                        outputModel.Add(new SZ_InvoiceData()
                        {
                            Courier = item.Courier,
                            TrackingNo = item.TrackingNo,
                            InvoiceNo = item.InvoiceNo,
                            ShipCountry = item.ShipCountry,
                            CompanyName = compdata.Where(x => x.Id == item.CompanyId).Select(x => x.Name).FirstOrDefault()
                        });
                    });
                }
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = outputModel });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }
        }


        [HttpPost]
        public JsonResult LoadPoformaInvoiceData()
        {
            try
            {
                var companysearch = string.Empty;
                var penuserdate = string.Empty;
                var countrytypesearch = string.Empty;
                var tablename = string.Empty;
                var searchbyvalue = string.Empty;
                if (Request.Form.GetValues("searchbox") != null)
                {
                    searchbyvalue = Request.Form.GetValues("searchbox")[0].Trim().ToString();
                }

                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                int numberOfObjectsPerPage = Convert.ToInt32(Request.Form["length"]);
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int pageNo = 1;
                if (skip > 0)
                {
                    pageNo = (skip / numberOfObjectsPerPage) + 1;
                }

                var model = db.SZ_PerformaInvoice.OrderByDescending(x => x.PerformaInvoiceDate).ToList();
                if (!string.IsNullOrEmpty(searchValue))
                {
                    model = model.Where(x => (x.PerformaInvoiceNo != null && x.PerformaInvoiceNo.Contains(searchValue)) ||
                    (x.ShipCountry != null && x.ShipCountry.Contains(searchValue)) ||
                    (x.BillCompanyName != null && x.BillCompanyName.Contains(searchValue)) ||
                    (x.CustomerPoNo != null && x.CustomerPoNo.Contains(searchValue)) ||
                    (x.ShipCompanyName != null && x.ShipCompanyName.Contains(searchValue))).ToList();
                }
                string internationcompanylist = "";
                if (SessionCookieManagement.IsInternational)
                {
                    List<int> intcompids = new List<int>();
                    internationcompanylist = db.SZ_UserManagement.Where(x => x.UserId == SessionCookieManagement.UserId).Select(x => x.CompanyIds).FirstOrDefault();
                    foreach (var items in internationcompanylist.Split(','))
                    {
                        if (!string.IsNullOrEmpty(items))
                        {
                            intcompids.Add(Convert.ToInt32(items));
                        }
                    }
                    model = model.Where(x => intcompids.Contains(x.CompanyId) && x.CreatedDate >= new DateTime(2022, 05, 01)).ToList();
                }

                int? recordsTotal = model.Count;

                model = model.Skip((pageNo - 1) * numberOfObjectsPerPage).Take(numberOfObjectsPerPage).ToList();
                if (model != null && model.Count > 0)
                {
                    model.ForEach(item =>
                    {
                        item.Courier = item.PerformaInvoiceDate.ToShortDateString();
                        item.TrackingNo = "<a href='/Form/PI/" + item.Id + "' target='_blank'>Edit</a> | <a href='/Form/DownloadPI/" + item.Id + "' target='_blank'>Download</a>";
                    });
                }
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = model });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }
        }

        [HttpPost]
        public JsonResult LoadNotificationList()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                int numberOfObjectsPerPage = Convert.ToInt32(Request.Form["length"]);
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int pageNo = 1;
                if (skip > 0)
                {
                    pageNo = (skip / numberOfObjectsPerPage) + 1;
                }
                var length = Request.Form.GetValues("length").FirstOrDefault();
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                var model = db.SZ_SystemNotification.AsQueryable();

                if (SessionCookieManagement.IsProjectLogin)
                {
                    model = model.Where(x => x.ReceivedUserId == SessionCookieManagement.UserId).AsQueryable();
                }

                model = model.OrderByDescending(x => x.CreatedDate).AsQueryable();
                int? recordsTotal = model.Count();
                var result = model.Skip(skip).Take(pageSize).ToList();
                var data = PrepareSystemNotification(result);
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }
        }

        public List<SystemNotificationModel> PrepareSystemNotification(List<SZ_SystemNotification> model)
        {
            List<SystemNotificationModel> mainModel = new List<SystemNotificationModel>();
            model.ForEach(item =>
            {
                var objModel = new SystemNotificationModel()
                {
                    Id = item.Id,
                    SentUserId = item.SentUserId,
                    SentUsername = item.SentUsername,
                    ReceivedUserId = item.ReceivedUserId,
                    ReceivedUserName = item.ReceivedUserName,
                    CreatedDate = item.CreatedDate,
                    IsView = item.IsView,
                    ViewedUserId = item.ViewedUserId,
                    Message = item.Message,
                    URL = !string.IsNullOrEmpty(item.URL) ? "<a href='" + item.URL + "' target='_blank'>Visit</a>" : "",
                    CreatedDateText = item.CreatedDate.ToShortDateString(),
                    ActionRow = item.IsView == false ? "<a href='javascript:void(0)' id='edit_" + item.Id + "' onclick='MarkasRead(" + item.Id + ")'>View</a>" : ""
                };

                mainModel.Add(objModel);
            });

            return mainModel;
        }

        [HttpGet]
        public JsonResult MarkasRead(int notificationId)
        {
            try
            {
                var notificationdata = db.SZ_SystemNotification.Where(x => x.Id == notificationId).FirstOrDefault();
                if (notificationdata != null)
                {
                    notificationdata.IsView = true;
                    db.Entry(notificationdata).State = EntityState.Modified;
                    db.SaveChanges();
                }
                return Json(new { success = true }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new { success = true, message = ex.Message }, JsonRequestBehavior.AllowGet);
            }
        }

        public ActionResult ExportQuoteFollowupData(string radio,
                                                    string searchbox,
                                                    string startdate_search,
                                                    string enddate_search,
                                                    string ddlexportdist,
                                                    string ddlcompanyid,
                                                    string ddlemailaddress,
                                                    string startNumber,
                                                    string endNumber,
                                                    string GeographicalId,
                                                    string ddlsymbol)
        {
            IQueryable<QuotationAndDetailsView> followupdata = null;
            string searchvaluetextbox = string.Empty;
            followupdata = (from q in db.QuotationAndDetailsViews.AsNoTracking()
                            where !q.CompanyName.Contains("synzeal")
                            select q).AsQueryable();

            if (!string.IsNullOrEmpty(searchbox))
            {
                followupdata = followupdata.Where(x => x.Ref == searchvaluetextbox || x.PONo == searchvaluetextbox).AsQueryable();
            }
            else
            {
                followupdata = (from q in db.QuotationAndDetailsViews.AsNoTracking()
                                where (q.IsToBe == false)
                                 && (q.IsRFQManually == null || q.IsRFQManually == false)
                                 && (q.IsPark == false || q.IsPark == null)
                                 && string.IsNullOrEmpty(q.PONo)
                                 && !q.CompanyName.Contains("synzeal")
                                 //&& (q.IsRemoveFollowup == null || q.IsRemoveFollowup == false)
                                 && (q.MoveToProject == null || q.MoveToProject == false)
                                select q).AsQueryable();
                if (!string.IsNullOrEmpty(startNumber))
                {
                    int sn = Convert.ToInt32(startNumber);
                    followupdata = followupdata.Where(x => x.QuoteValue >= sn).AsQueryable();
                }
                if (!string.IsNullOrEmpty(endNumber))
                {
                    int en = Convert.ToInt32(endNumber);
                    followupdata = followupdata.Where(x => x.QuoteValue <= en).AsQueryable();
                }
                if (!string.IsNullOrEmpty(startdate_search))
                {
                    var d = Convert.ToDateTime(startdate_search);
                    followupdata = followupdata.Where(x => x.CreatedDate >= d).AsQueryable();
                }
                if (!string.IsNullOrEmpty(enddate_search))
                {
                    var d = Convert.ToDateTime(enddate_search);
                    followupdata = followupdata.Where(x => x.CreatedDate <= d).AsQueryable();
                }
                if (!string.IsNullOrEmpty(ddlcompanyid))
                {
                    if (!string.IsNullOrEmpty(ddlcompanyid))
                    {
                        int cid = Convert.ToInt32(ddlcompanyid);
                        followupdata = followupdata.Where(x => x.CompanyId == cid).AsQueryable();
                    }
                }
                if (!string.IsNullOrEmpty(ddlexportdist))
                {
                    followupdata = followupdata.Where(x => x.CountryType == ddlexportdist).AsQueryable();
                }
                if (!string.IsNullOrEmpty(ddlemailaddress))
                {
                    followupdata = followupdata.Where(x => x.EmailAddress.Contains(ddlemailaddress)).AsQueryable();
                }

                if (!string.IsNullOrEmpty(GeographicalId))
                {
                    var gid = Convert.ToInt32(GeographicalId);
                    var cIds = db.SZ_CompanyList.Where(x => x.GeographicalLocation == gid).Select(x => x.Id).ToList();
                    followupdata = followupdata.Where(x => x.CompanyId.HasValue && cIds.Contains(x.CompanyId.Value)).AsQueryable();
                }

                if (!string.IsNullOrEmpty(ddlsymbol))
                {
                    if (ddlsymbol == "Interested")
                    {
                        followupdata = followupdata.Where(x => x.IsFollowupInterested == true).AsQueryable();
                    }
                    if (ddlsymbol == "Mail")
                    {
                        followupdata = followupdata.Where(x => x.IsFollowupMail == true).AsQueryable();
                    }
                    if (ddlsymbol == "Call")
                    {
                        followupdata = followupdata.Where(x => x.IsFollowupCall == true).AsQueryable();
                    }
                    if (ddlsymbol == "Won")
                    {
                        followupdata = followupdata.Where(x => x.IsFollowupWon == true).AsQueryable();
                    }
                    if (ddlsymbol == "Freeze")
                    {
                        followupdata = followupdata.Where(x => x.FreezeQuote == true).AsQueryable();
                    }
                    if (ddlsymbol == "Lost")
                    {
                        followupdata = followupdata.Where(x => x.IsFollowupLost == true).AsQueryable();
                    }

                    if (ddlsymbol == "Meeting")
                    {
                        followupdata = followupdata.Where(x => x.IsFollowupMeeting == true).AsQueryable();
                    }

                    if (ddlsymbol == "Less Value")
                    {
                        followupdata = followupdata.Where(x => x.IsFollowupLessValue == true).AsQueryable();
                    }

                    if (ddlsymbol == "Negotiation")
                    {
                        followupdata = followupdata.Where(x => x.IsFollowupNegotiation == true).AsQueryable();
                    }

                    if (ddlsymbol == "Important")
                    {
                        followupdata = followupdata.Where(x => x.IsFollowupImportant == true).AsQueryable();
                    }

                    //followupdata = followupdata.Where(x => x.CompanyId == cid).AsQueryable();
                }

            }

            followupdata = followupdata.OrderBy(x => x.FreezeQuote).ThenByDescending(x => x.CreatedDate).AsQueryable();
            var products = followupdata.ToList();
            ExcelPackage ExcelPkg = new ExcelPackage();
            ExcelWorksheet wsSheet1 = ExcelPkg.Workbook.Worksheets.Add("Sheet1");
            wsSheet1.DefaultColWidth = 16;
            wsSheet1.Protection.IsProtected = false;
            wsSheet1.Protection.AllowSelectLockedCells = false;
            wsSheet1.Cells.AutoFitColumns(14, 40);
            wsSheet1.Column(3).Width = 40;
            wsSheet1.Column(3).Style.WrapText = true;

            int loopCount = 2;
            wsSheet1.Cells[loopCount, 1].Value = "Sr No";
            wsSheet1.Cells[loopCount, 2].Value = "Product Name";
            wsSheet1.Cells[loopCount, 3].Value = "CAT No";
            wsSheet1.Cells[loopCount, 4].Value = "CAS No";
            wsSheet1.Cells[loopCount, 5].Value = "Price/Qty";
            wsSheet1.Cells[loopCount, 6].Value = "Lead Time";
            wsSheet1.Cells[loopCount, 7].Value = "Batch Code";
            wsSheet1.Cells[loopCount, 8].Value = "Product Remark";
            wsSheet1.Cells[loopCount, 9].Value = "Followup Remark";
            wsSheet1.Cells[loopCount, 10].Value = "Contact Details";
            wsSheet1.Cells[loopCount, 11].Value = "Admin Followup";
            wsSheet1.Cells[loopCount, 12].Value = "Followup Admin Remark";
            wsSheet1.Cells[loopCount, 13].Value = "Status";
            wsSheet1.Cells[loopCount, 14].Value = "Interested";
            wsSheet1.Cells[loopCount, 15].Value = "Removed";
            wsSheet1.Cells[loopCount, 16].Value = "Mail";
            wsSheet1.Cells[loopCount, 17].Value = "Call";
            wsSheet1.Cells[loopCount, 18].Value = "Won";
            wsSheet1.Cells[loopCount, 19].Value = "Freeze";
            wsSheet1.Cells[loopCount, 20].Value = "Lost";
            wsSheet1.Cells[loopCount, 21].Value = "Meeting";
            wsSheet1.Cells[loopCount, 22].Value = "Less Value";
            wsSheet1.Cells[loopCount, 24].Value = "Negotiation";
            wsSheet1.Cells[loopCount, 25].Value = "Important";
            using (ExcelRange Rng = wsSheet1.Cells[loopCount, 1, loopCount, 25])
            {
                Rng.Style.Font.Bold = true;
                Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#7b7b7b");
                Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                Rng.Style.Font.Color.SetColor(Color.White);
                Rng.Style.WrapText = true;
            }

            loopCount = loopCount + 1;
            int srno = 1;
            foreach (var quote in products)
            {
                wsSheet1.Cells[loopCount, 1].Value = srno;
                wsSheet1.Cells[loopCount, 2].Value = quote.ProductName;
                wsSheet1.Cells[loopCount, 3].Value = quote.CATNo;
                wsSheet1.Cells[loopCount, 4].Value = quote.CASNo;
                wsSheet1.Cells[loopCount, 5].Value = quote.Price;
                wsSheet1.Cells[loopCount, 6].Value = quote.LeadTime;
                wsSheet1.Cells[loopCount, 7].Value = quote.AdditionalBatchNo;
                wsSheet1.Cells[loopCount, 8].Value = quote.ProductRemark;
                wsSheet1.Cells[loopCount, 9].Value = quote.FollowupDescription;
                wsSheet1.Cells[loopCount, 10].Value = quote.ContactDetail;
                wsSheet1.Cells[loopCount, 11].Value = quote.FollowUpRemark;
                wsSheet1.Cells[loopCount, 12].Value = quote.FollowupAdminRemark;
                wsSheet1.Cells[loopCount, 13].Value = quote.FollowupReason;
                wsSheet1.Cells[loopCount, 14].Value = quote.IsFollowupInterested == true ? "Yes" : "No";
                wsSheet1.Cells[loopCount, 15].Value = quote.IsRemoveFollowup == true ? "Yes" : "No";
                wsSheet1.Cells[loopCount, 16].Value = quote.IsFollowupMail == true ? "Yes" : "No";
                wsSheet1.Cells[loopCount, 17].Value = quote.IsFollowupCall == true ? "Yes" : "No";
                wsSheet1.Cells[loopCount, 18].Value = quote.IsFollowupWon == true ? "Yes" : "No";
                wsSheet1.Cells[loopCount, 19].Value = quote.FreezeQuote == true ? "Yes" : "No";
                wsSheet1.Cells[loopCount, 20].Value = quote.IsFollowupLost == true ? "Yes" : "No";
                wsSheet1.Cells[loopCount, 21].Value = quote.IsFollowupMeeting == true ? "Yes" : "No";
                wsSheet1.Cells[loopCount, 22].Value = quote.IsFollowupLessValue == true ? "Yes" : "No";
                wsSheet1.Cells[loopCount, 24].Value = quote.IsFollowupNegotiation == true ? "Yes" : "No";
                wsSheet1.Cells[loopCount, 25].Value = quote.IsFollowupImportant == true ? "Yes" : "No";
                srno += 1;
                loopCount += 1;
            }
            string filePath = HostingEnvironment.MapPath("~/Content/Quotation/") + "AllFollowupProductReport-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xlsx";
            ExcelPkg.SaveAs(new FileInfo(filePath));
            return File(filePath, "application/excel", Server.UrlEncode("AllFollowupProductReport-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xls"));
        }

        [HttpPost]
        public JsonResult LoadQuotationData(string tabname, bool isDispatch = false)
        {
            try
            {
                MemoryCacheManager objCache = new MemoryCacheManager();

                var companyList = objCache.Get("cache.customerdata", () =>
                {
                    return db.SZ_CompanyList.ToList();
                });
                var companysearch = string.Empty;
                var penuserdate = string.Empty;
                var countrytypesearch = string.Empty;
                var tablename = string.Empty;
                var ddlexportdist = string.Empty;
                var startdate = string.Empty;
                var enddate = string.Empty;

                var ddluserdist = string.Empty;
                string ddlGeographicalId = string.Empty;
                var ddlcontrolled = string.Empty;
                var ddlpoReceived = string.Empty;
                var ddlcsinstock = string.Empty;
                int ddlGid = 0;
                var ddlcompanyid = string.Empty;
                var ddlemailaddress = string.Empty;

                var ddlimportant = string.Empty;
                var flthomestartdate = string.Empty;
                var flthomeenddate = string.Empty;

                decimal startNumber = 0;
                decimal endNumber = 0;

                if (Request.Form.GetValues("startNumber") != null)
                {
                    var startNumberstr = Request.Form.GetValues("startNumber")[0].ToString();
                    if (!string.IsNullOrEmpty(startNumberstr))
                    {
                        startNumber = Convert.ToDecimal(startNumberstr);
                    }
                }
                if (Request.Form.GetValues("endNumber") != null)
                {
                    var endNumberstr = Request.Form.GetValues("endNumber")[0].ToString();
                    if (!string.IsNullOrEmpty(endNumberstr))
                    {
                        endNumber = Convert.ToDecimal(endNumberstr);
                    }
                }
                if (Request.Form.GetValues("company_search") != null)
                {
                    companysearch = Request.Form.GetValues("company_search")[0].ToString();
                }
                if (Request.Form.GetValues("date_search") != null)
                {
                    penuserdate = Request.Form.GetValues("date_search")[0].ToString();
                }

                if (Request.Form.GetValues("countrytype_search") != null)
                {
                    countrytypesearch = Request.Form.GetValues("countrytype_search")[0].ToString();
                }
                if (Request.Form.GetValues("startdate_search") != null)
                {
                    startdate = Request.Form.GetValues("startdate_search")[0].ToString();
                }
                if (Request.Form.GetValues("enddate_search") != null)
                {
                    enddate = Request.Form.GetValues("enddate_search")[0].ToString();
                }

                if (Request.Form.GetValues("GeographicalId") != null)
                {
                    ddlGeographicalId = Request.Form.GetValues("GeographicalId")[0].ToString();
                    
                }
                if (Request.Form.GetValues("ddlcontrolled") != null)
                {
                    ddlcontrolled = Request.Form.GetValues("ddlcontrolled")[0].ToString();
                }
                if (Request.Form.GetValues("ddluserdist") != null)
                {
                    ddluserdist = Request.Form.GetValues("ddluserdist")[0].ToString();
                }
                
                if (Request.Form.GetValues("ddlpoReceived") != null)
                {
                    ddlpoReceived = Request.Form.GetValues("ddlpoReceived")[0].ToString();
                }
                if (Request.Form.GetValues("ddlcsinstock") != null)
                {
                    ddlcsinstock = Request.Form.GetValues("ddlcsinstock")[0].ToString();
                }
                if (Request.Form.GetValues("ddlimportant") != null)
                {
                    ddlimportant = Request.Form.GetValues("ddlimportant")[0].ToString();
                }
                if (Request.Form.GetValues("flthomestartdate") != null)
                {
                    flthomestartdate = Request.Form.GetValues("flthomestartdate")[0].ToString();
                }
                if (Request.Form.GetValues("flthomeenddate") != null)
                {
                    flthomeenddate = Request.Form.GetValues("flthomeenddate")[0].ToString();
                }
                var searchby = string.Empty;
                var searchbyvalue = string.Empty;
                if (Request.Form.GetValues("radiobuton") != null)
                {
                    searchby = Request.Form.GetValues("radiobuton")[0].ToString();
                }
                if (Request.Form.GetValues("searchbox") != null)
                {
                    searchbyvalue = Request.Form.GetValues("searchbox")[0].Trim().ToString();
                }
                if (Request.Form.GetValues("tablename") != null)
                {
                    tablename = Request.Form.GetValues("tablename")[0].ToString();
                }
                if (Request.Form.GetValues("ddlexportdist") != null)
                {
                    ddlexportdist = Request.Form.GetValues("ddlexportdist")[0].Trim().ToString();
                    countrytypesearch = ddlexportdist;
                }

                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                int numberOfObjectsPerPage = Convert.ToInt32(Request.Form["length"]);
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int pageNo = 1;
                if (skip > 0)
                {
                    pageNo = (skip / numberOfObjectsPerPage) + 1;
                }
                TempData["tabname"] = tabname;

                string internationcompanylist = "";
                if (SessionCookieManagement.IsInternational)
                {
                    internationcompanylist = db.SZ_UserManagement.Where(x => x.UserId == SessionCookieManagement.UserId).Select(x => x.CompanyIds).FirstOrDefault();
                }

                var model = new List<QuotationList_Result>();

                if (tablename == "followup")
                {
                    IQueryable<QuotationAndDetailsView> followupdata = null;
                    string searchvaluetextbox = string.Empty;
                    followupdata = (from q in db.QuotationAndDetailsViews.AsNoTracking()
                                    where !q.CompanyName.Contains("synzeal")
                                    select q).AsQueryable();
                    if (Request.Form.GetValues("search[value]") != null && !string.IsNullOrEmpty(Request.Form.GetValues("search[value]")[0].ToString()))
                    {
                        searchvaluetextbox = Request.Form.GetValues("search[value]")[0].ToString();
                        if (!string.IsNullOrEmpty(searchvaluetextbox))
                        {
                            followupdata = followupdata.Where(x => x.Ref == searchvaluetextbox || x.PONo == searchvaluetextbox).AsQueryable();
                        }
                        if (!string.IsNullOrEmpty(searchby) && !string.IsNullOrEmpty(searchbyvalue))
                        {
                            if (searchby == "quoteid")
                            {
                                followupdata = followupdata.Where(x => x.Ref == searchbyvalue).AsQueryable();
                            }
                            if (searchby == "ponumber")
                            {
                                followupdata = followupdata.Where(x => x.PONo == searchbyvalue).AsQueryable();
                            }

                        }
                    }
                    else if (!string.IsNullOrEmpty(searchby) && !string.IsNullOrEmpty(searchbyvalue))
                    {

                        if (searchby == "quoteid")
                        {
                            followupdata = followupdata.Where(x => x.Ref == searchbyvalue).AsQueryable();
                        }
                        if (searchby == "ponumber")
                        {
                            followupdata = followupdata.Where(x => x.PONo == searchbyvalue).AsQueryable();
                        }
                    }
                    else
                    {
                        followupdata = (from q in db.QuotationAndDetailsViews.AsNoTracking()
                                        where (q.IsToBe == false)
                                         && (q.IsRFQManually == null || q.IsRFQManually == false)
                                         && (q.IsPark == false || q.IsPark == null)
                                         && string.IsNullOrEmpty(q.PONo)
                                         && !q.CompanyName.Contains("synzeal")
                                         && (q.IsRemoveFollowup == null || q.IsRemoveFollowup == false)
                                         && (q.MoveToProject == null || q.MoveToProject == false)
                                        select q).AsQueryable();
                        if (startNumber > 0)
                        {
                            followupdata = followupdata.Where(x => x.QuoteValue >= startNumber).AsQueryable();
                        }
                        if (endNumber > 0)
                        {
                            followupdata = followupdata.Where(x => x.QuoteValue <= endNumber).AsQueryable();
                        }
                        if (!string.IsNullOrEmpty(startdate))
                        {
                            var d = Convert.ToDateTime(startdate);
                            followupdata = followupdata.Where(x => x.CreatedDate >= d).AsQueryable();
                        }
                        if (!string.IsNullOrEmpty(enddate))
                        {
                            var d = Convert.ToDateTime(enddate);
                            followupdata = followupdata.Where(x => x.CreatedDate <= d).AsQueryable();
                        }
                        //if (Request.Form.GetValues("ddlcompanyid") != null)
                        //{
                        //    ddlcompanyid = Request.Form.GetValues("ddlcompanyid")[0].ToString();
                        //    if (!string.IsNullOrEmpty(ddlcompanyid))
                        //    {
                        //        int cid = Convert.ToInt32(ddlcompanyid);
                        //        followupdata = followupdata.Where(x => x.CompanyId == cid).AsQueryable();
                        //    }
                        //}
                        if (!string.IsNullOrEmpty(countrytypesearch))
                        {
                            followupdata = followupdata.Where(x => x.CountryType == countrytypesearch).AsQueryable();
                        }
                        if (Request.Form.GetValues("ddlemailaddress") != null)
                        {
                            ddlemailaddress = Request.Form.GetValues("ddlemailaddress")[0].ToString();
                            if (!string.IsNullOrEmpty(ddlemailaddress))
                            {
                                followupdata = followupdata.Where(x => x.EmailAddress.Contains(ddlemailaddress)).AsQueryable();
                            }
                        }
                        string GeographicalId = string.Empty;
                        if (Request.Form.GetValues("GeographicalId") != null)
                        {
                            GeographicalId = Request.Form.GetValues("GeographicalId")[0].ToString();
                            if (!string.IsNullOrEmpty(GeographicalId))
                            {
                                var gid = Convert.ToInt32(GeographicalId);
                                var cIds = db.SZ_CompanyList.Where(x => x.GeographicalLocation == gid).Select(x => x.Id).ToList();
                                followupdata = followupdata.Where(x => x.CompanyId.HasValue && cIds.Contains(x.CompanyId.Value)).AsQueryable();
                            }
                        }
                        if (Request.Form.GetValues("ddlsymbol") != null)
                        {
                            var ddlsymbol = Request.Form.GetValues("ddlsymbol")[0].ToString();
                            if (!string.IsNullOrEmpty(ddlsymbol))
                            {
                                if (ddlsymbol == "No Action")
                                {
                                    followupdata = followupdata.Where(x =>
                                                (x.IsFollowupInterested == null || x.IsFollowupInterested == false)
                                                && (x.IsFollowupMail == null || x.IsFollowupMail == false)
                                                && (x.IsFollowupCall == null || x.IsFollowupCall == false)
                                                && (x.IsFollowupWon == null || x.IsFollowupWon == false)
                                                && (x.IsFollowupLost == null || x.IsFollowupLost == false)
                                                && (x.IsFollowupMeeting == null || x.IsFollowupMeeting == false)
                                                && (x.IsFollowupLessValue == null || x.IsFollowupLessValue == false)
                                                && (x.IsFollowupNegotiation == null || x.IsFollowupNegotiation == false)
                                                && (x.IsFollowupImportant == null || x.IsFollowupImportant == false)).AsQueryable();
                                }
                                if (ddlsymbol == "Interested")
                                {
                                    followupdata = followupdata.Where(x => x.IsFollowupInterested == true).AsQueryable();
                                }
                                if (ddlsymbol == "Mail")
                                {
                                    followupdata = followupdata.Where(x => x.IsFollowupMail == true).AsQueryable();
                                }
                                if (ddlsymbol == "Call")
                                {
                                    followupdata = followupdata.Where(x => x.IsFollowupCall == true).AsQueryable();
                                }
                                if (ddlsymbol == "Won")
                                {
                                    followupdata = followupdata.Where(x => x.IsFollowupWon == true).AsQueryable();
                                }
                                if (ddlsymbol == "Freeze")
                                {
                                    followupdata = followupdata.Where(x => x.FreezeQuote == true).AsQueryable();
                                }
                                if (ddlsymbol == "Lost")
                                {
                                    followupdata = followupdata.Where(x => x.IsFollowupLost == true).AsQueryable();
                                }

                                if (ddlsymbol == "Meeting")
                                {
                                    followupdata = followupdata.Where(x => x.IsFollowupMeeting == true).AsQueryable();
                                }

                                if (ddlsymbol == "Less Value")
                                {
                                    followupdata = followupdata.Where(x => x.IsFollowupLessValue == true).AsQueryable();
                                }

                                if (ddlsymbol == "Negotiation")
                                {
                                    followupdata = followupdata.Where(x => x.IsFollowupNegotiation == true).AsQueryable();
                                }

                                if (ddlsymbol == "Important")
                                {
                                    followupdata = followupdata.Where(x => x.IsFollowupImportant == true).AsQueryable();
                                }

                                //followupdata = followupdata.Where(x => x.CompanyId == cid).AsQueryable();
                            }
                        }
                    }
                    followupdata = followupdata.OrderBy(x => x.FreezeQuote).ThenByDescending(x => x.CreatedDate).AsQueryable();

                    var results = from p in followupdata
                                  group p by p.CompanyName into g
                                  select new
                                  {
                                      CompanyName = g.Key,
                                      Product = g.Count()
                                  };
                    if (Request.Form.GetValues("ddlcompanyid") != null)
                    {
                        ddlcompanyid = Request.Form.GetValues("ddlcompanyid")[0].ToString();
                        if (!string.IsNullOrEmpty(ddlcompanyid))
                        {
                            int cid = Convert.ToInt32(ddlcompanyid);
                            followupdata = followupdata.Where(x => x.CompanyId == cid).AsQueryable();
                        }
                    }
                    followupdata = followupdata.OrderBy(x => x.FreezeQuote).ThenByDescending(x => x.CreatedDate).AsQueryable();
                    int? recordsTotalss = followupdata.Count();
                    var outmodel = followupdata.Skip(skip).Take(numberOfObjectsPerPage).ToList();
                    //var sfollowupdata = followupdata.ToList();
                    // sfollowupdata = sfollowupdata.OrderBy(x => x.FreezeQuote).ThenByDescending(x => x.CreatedDate).ToList();

                    //int? recordsTotalss = sfollowupdata.Count;
                    //var outmodel = sfollowupdata.Skip(skip).Take(numberOfObjectsPerPage).ToList();

                    var models = (from i in outmodel
                                  select new QuotationList_Result()
                                  {
                                      Ref = i.Ref,
                                      CompanyName = i.CompanyName,
                                      PONo = i.PONo,
                                      PODate = i.PODate,
                                      IsImportedQuote = i.IsImportedQuote,
                                      CreatedDate = i.CreatedDate,
                                      MoveToProject = i.MoveToProject,
                                      ProductName = i.ProductName,
                                      Price = i.Price,
                                      CASNo = i.CASNo,
                                      CATNo = i.CATNo,
                                      EmailAddress = i.EmailAddress,
                                      LeadTime = i.LeadTime,
                                      QuoteDetailsId = i.QuoteDetailsId,
                                      ProductRemark = i.ProductRemark,
                                      Id = i.Id,
                                      CountryType = i.CountryType,
                                      ProductId = i.ProductId,
                                      FollowUpRemark = i.FollowUpRemark,
                                      FollowUpRemarkSecond = i.FollowUpRemarkSecond,
                                      FollowupDescription = i.FollowupDescription,
                                      IsFollowUpAdminChange = i.IsFollowUpAdminChange,
                                      IsFollowupChange = i.IsFollowupChange,
                                      ContactDetail = i.ContactDetail,
                                      FinalPrice = i.FinalPrice,
                                      ItemDiscount = i.ItemDiscount,
                                      IsToBe = i.IsToBe,
                                      IsQuoteApproved = i.IsQuoteApproved,
                                      IsPark = i.IsPark,
                                      IsSynthesisLog = i.IsSynthesisLog,
                                      UserDistType = i.UserDistType,
                                      AdditionalBatchNo = i.AdditionalBatchNo,
                                      COAId = i.COAId,
                                      QuoteBatchNo = i.QuoteBatchNo,
                                      DisplayOrder = i.DisplayOrder,
                                      Auction = i.Auction,
                                      IsRemoveFollowup = i.IsRemoveFollowup,
                                      IsFollowupRequired = i.IsFollowupRequired,
                                      TrackingNo = i.TrackingNo,
                                      IsOnHold = i.IsOnHold,
                                      BatchNo = i.BatchNo,
                                      ActivityStatus = i.ActivityStatus,
                                      COARefNumber = i.COARefNumber,
                                      IsRFQManually = i.IsRFQManually,
                                      ClientRef = i.ClientRef,
                                      AddTestCostRemark = i.AddTestCostRemark,
                                      IsConversionReport = i.IsConversionReport,
                                      Expr1 = i.Expr1,
                                      CompanyId = i.CompanyId,
                                      FollowupStatus = i.FollowupStatus,
                                      FollowupReason = i.FollowupReason,
                                      TotalRecord = recordsTotalss,
                                      QuoteValue = i.QuoteValue,
                                      FreezeQuote = i.FreezeQuote,
                                      IsFollowupInterested = i.IsFollowupInterested,
                                      IsFollowupMail = i.IsFollowupMail,
                                      IsFollowupCall = i.IsFollowupCall,
                                      IsFollowupWon = i.IsFollowupWon,
                                      IsFollowupLost = i.IsFollowupLost,
                                      IsFollowupMeeting = i.IsFollowupMeeting,
                                      IsFollowupLessValue = i.IsFollowupLessValue,
                                      IsFollowupNegotiation = i.IsFollowupNegotiation,
                                      FollowupAdminRemark = i.FollowupAdminRemark,
                                      Expr2 = i.Expr2,
                                      IsFollowupImportant = i.IsFollowupImportant
                                  }).ToList();

                    var datass = PrepareQuotationListModel(models, isDispatch, tablename);

                    //var results = from p in datass
                    //              group p by p.CompanyName into g
                    //              select new
                    //              {
                    //                  CompanyName = g.Key,
                    //                  Product = g.Count()
                    //              };
                    return Json(new
                    {
                        draw = draw,
                        recordsFiltered = recordsTotalss,
                        recordsTotal = recordsTotalss,
                        data = datass,
                        followupdata = results.OrderByDescending(x => x.Product).ToList()
                    });

                    //model = db.QuotationList(searchValue, companysearch, penuserdate, countrytypesearch, tabname, searchby, searchbyvalue, internationcompanylist, startdate, enddate, ddlemailaddress, startNumber, endNumber, pageNo, numberOfObjectsPerPage).ToList();
                }
                else
                {
                    if (tabname == "all")
                    {
                        if(!string.IsNullOrEmpty(flthomestartdate))
                        {
                            startdate = flthomestartdate;
                        }
                        if (!string.IsNullOrEmpty(flthomeenddate))
                        {
                            enddate = flthomeenddate;
                        }
                    }
                    model = db.QuotationList(searchValue, companysearch, penuserdate, countrytypesearch, tabname, searchby, searchbyvalue, internationcompanylist, startdate, enddate, ddlemailaddress, startNumber, endNumber, ddlGeographicalId, ddlcontrolled, ddlpoReceived, ddlcsinstock, ddluserdist, ddlimportant, pageNo, numberOfObjectsPerPage).ToList();
                }
                if (SessionCookieManagement.IsInternational)
                {
                    model = model.Where(x => x.CreatedDate >= new DateTime(2022, 05, 01)).ToList();
                }

                if (tabname == "all")
                {
                    var outputallOverviewModel = new List<OverviewQuotationCountModel>();

                    var dbb = new SynzealLiveEntities();
                    using (var connection = dbb.Database.Connection)
                    {

                        connection.Open();
                        var command = connection.CreateCommand();
                        command.CommandText = "EXEC [dbo].[QuotationListOverviewCount] @searchString,@company,@date,@countrytype,@searchby,@searchbyvalue,@startdate,@enddate,@GeographicalId,@controlled,@poReceived,@csinstock,@userDist,@important";
                        //SqlParameter allcompparam = new SqlParameter("@searchString", "'" + searchValue + "'");
                        //command.Parameters.Add(allcompparam);

                        //SqlParameter compparam = new SqlParameter("@company", "'" + companysearch + "'");
                        //command.Parameters.Add(compparam);

                        //SqlParameter dateparam = new SqlParameter("@date", "'" + penuserdate + "'");
                        //command.Parameters.Add(dateparam);

                        //SqlParameter countrytypeparam = new SqlParameter("@countrytype", "'" + countrytypesearch + "'");
                        //command.Parameters.Add(countrytypeparam);

                        //SqlParameter searchbyparam = new SqlParameter("@searchby", "'" + searchby + "'");
                        //command.Parameters.Add(searchbyparam);

                        //SqlParameter searchbyvalueparam = new SqlParameter("@searchbyvalue", "'" + searchbyvalue + "'");
                        //command.Parameters.Add(searchbyvalueparam);

                        //SqlParameter startdateparam = new SqlParameter("@startdate", "'" + startdate + "'");
                        //command.Parameters.Add(startdateparam);

                        //SqlParameter enddatevalueparam = new SqlParameter("@enddate", "'" + enddate + "'");
                        //command.Parameters.Add(enddatevalueparam);

                        //SqlParameter GeographicalIdparam = new SqlParameter("@GeographicalId", "'" + ddlGeographicalId + "'");
                        //command.Parameters.Add(GeographicalIdparam);

                        //SqlParameter controlledparam = new SqlParameter("@controlled", "'" + ddlcontrolled + "'");
                        //command.Parameters.Add(controlledparam);

                        //SqlParameter poReceivedparam = new SqlParameter("@poReceived", "'" + ddlpoReceived + "'");
                        //command.Parameters.Add(poReceivedparam);

                        //SqlParameter csinstockparam = new SqlParameter("@csinstock", "'" + ddlcsinstock + "'");
                        //command.Parameters.Add(csinstockparam);

                        //SqlParameter userDistparam = new SqlParameter("@userDist", "'" + ddluserdist + "'");
                        //command.Parameters.Add(userDistparam);

                        //SqlParameter importantparam = new SqlParameter("@important", "'" + ddlimportant + "'");
                        //command.Parameters.Add(importantparam);

                        SqlParameter allcompparam = new SqlParameter("@searchString", searchValue );
                        command.Parameters.Add(allcompparam);

                        SqlParameter compparam = new SqlParameter("@company",  companysearch);
                        command.Parameters.Add(compparam);

                        SqlParameter dateparam = new SqlParameter("@date", penuserdate );
                        command.Parameters.Add(dateparam);

                        SqlParameter countrytypeparam = new SqlParameter("@countrytype", countrytypesearch );
                        command.Parameters.Add(countrytypeparam);

                        SqlParameter searchbyparam = new SqlParameter("@searchby", searchby );
                        command.Parameters.Add(searchbyparam);

                        SqlParameter searchbyvalueparam = new SqlParameter("@searchbyvalue", searchbyvalue );
                        command.Parameters.Add(searchbyvalueparam);

                        SqlParameter startdateparam = new SqlParameter("@startdate",  startdate );
                        command.Parameters.Add(startdateparam);

                        SqlParameter enddatevalueparam = new SqlParameter("@enddate",  enddate );
                        command.Parameters.Add(enddatevalueparam);

                        SqlParameter GeographicalIdparam = new SqlParameter("@GeographicalId",  ddlGeographicalId );
                        command.Parameters.Add(GeographicalIdparam);

                        SqlParameter controlledparam = new SqlParameter("@controlled",  ddlcontrolled );
                        command.Parameters.Add(controlledparam);

                        SqlParameter poReceivedparam = new SqlParameter("@poReceived",  ddlpoReceived );
                        command.Parameters.Add(poReceivedparam);

                        SqlParameter csinstockparam = new SqlParameter("@csinstock",  ddlcsinstock );
                        command.Parameters.Add(csinstockparam);

                        SqlParameter userDistparam = new SqlParameter("@userDist", ddluserdist );
                        command.Parameters.Add(userDistparam);

                        SqlParameter importantparam = new SqlParameter("@important",  ddlimportant );
                        command.Parameters.Add(importantparam);

                        using (var reader = command.ExecuteReader())
                        {
                            outputallOverviewModel = ((System.Data.Entity.Infrastructure.IObjectContextAdapter)dbb)
                                    .ObjectContext
                                    .Translate<OverviewQuotationCountModel>(reader)
                                    .ToList();
                        }
                    }
                    
                    int? recordsTotal = model.Select(x => x.TotalRecord).FirstOrDefault();
                    var data = PrepareQuotationListModel(model, isDispatch, tablename);
                    return Json(new
                    {
                        draw = draw,
                        recordsFiltered = recordsTotal,
                        recordsTotal = recordsTotal,
                        data = data,
                        overviewdata = outputallOverviewModel
                    });
                }
                else
                {
                    int? recordsTotal = model.Select(x => x.TotalRecord).FirstOrDefault();
                    var data = PrepareQuotationListModel(model, isDispatch, tablename);
                    return Json(new
                    {
                        draw = draw,
                        recordsFiltered = recordsTotal,
                        recordsTotal = recordsTotal,
                        data = data
                    });
                }
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);
                throw ex;
            }
        }

        [HttpPost]
        public JsonResult LoadQuotationSAPData()
        {
            try
            {
                var companysearch = string.Empty;
                var penuserdate = string.Empty;
                var countrytypesearch = string.Empty;
                var tablename = string.Empty;
                if (Request.Form.GetValues("company_search") != null)
                {
                    companysearch = Request.Form.GetValues("company_search")[0].ToString(); ;
                }
                if (Request.Form.GetValues("date_search") != null)
                {
                    penuserdate = Request.Form.GetValues("date_search")[0].ToString(); ;
                }
                if (Request.Form.GetValues("countrytype_search") != null)
                {
                    countrytypesearch = Request.Form.GetValues("countrytype_search")[0].ToString(); ;
                }
                var searchby = string.Empty;
                var searchbyvalue = string.Empty;
                var ddlexportdist = string.Empty;
                if (Request.Form.GetValues("radiobuton") != null)
                {
                    searchby = Request.Form.GetValues("radiobuton")[0].ToString();
                }
                if (Request.Form.GetValues("searchbox") != null)
                {
                    searchbyvalue = Request.Form.GetValues("searchbox")[0].Trim().ToString();
                }
                if (Request.Form.GetValues("tablename") != null)
                {
                    tablename = Request.Form.GetValues("tablename")[0].ToString();
                }
                if (Request.Form.GetValues("ddlexportdist") != null)
                {
                    ddlexportdist = Request.Form.GetValues("ddlexportdist")[0].Trim().ToString();
                    countrytypesearch = ddlexportdist;
                }
                var length = Request.Form.GetValues("length").FirstOrDefault();

                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                int numberOfObjectsPerPage = Convert.ToInt32(Request.Form["length"]);
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int pageNo = 1;
                if (skip > 0)
                {
                    pageNo = (skip / numberOfObjectsPerPage) + 1;
                }

                var model = (from i in db.SZ_Quotation.AsNoTracking()
                             join ql in db.SZ_QuotationDetail.AsNoTracking() on i.Id equals ql.QuoteId
                             where ql.MoveToProject == true && ql.SZ_Quotation.CompanyId != 208
                             select ql).OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).AsQueryable();

                //OrderByDescending(x => x.SZ_Quotation.PONo).ThenByDescending(x=>x.MoveToProject).AsQueryable();

                if (searchby == "quoteid")
                {
                    model = model.Where(x => x.SZ_Quotation.Ref.Contains(searchbyvalue)).AsQueryable();
                }
                if (searchby == "ponumber")
                {
                    model = model.Where(x => x.SZ_Quotation.PONo.Contains(searchbyvalue)).AsQueryable();
                }
                if (searchby == "company")
                {
                    model = model.Where(x => x.SZ_Quotation.CompanyName.Contains(searchbyvalue)).AsQueryable();
                }
                if (searchby == "email")
                {
                    model = model.Where(x => x.SZ_Quotation.EmailAddress.Contains(searchbyvalue)).AsQueryable();
                }
                if (searchby == "productname")
                {
                    model = model.Where(x => x.ProductName.Contains(searchbyvalue)).AsQueryable();
                }
                if (searchby == "cas")
                {
                    model = model.Where(x => x.CASNo.Contains(searchbyvalue)).AsQueryable();
                }
                int? recordsTotal = model.Count();
                var outmodel = model.Skip(skip).Take(pageSize).ToList();

                var data = PrepareQuotationListModel(outmodel);
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);
                throw ex;
            }
        }


        public ActionResult GetAllQuoteDataReport()
        {
            var list = (from i in db.SZ_Quotation.AsNoTracking()
                        join ql in db.SZ_QuotationDetail.AsNoTracking() on i.Id equals ql.QuoteId
                        select new
                        {
                            Quote = i,
                            QuoteDetail = ql
                        }).ToList();

            var LogData = db.SZ_QuotationDetailLog.AsNoTracking().ToList();

            ExcelPackage ExcelPkg = new ExcelPackage();
            ExcelWorksheet wsSheet1 = ExcelPkg.Workbook.Worksheets.Add("All Company Data");
            wsSheet1.DefaultColWidth = 11;
            wsSheet1.Protection.IsProtected = false;
            wsSheet1.Protection.AllowSelectLockedCells = false;
            wsSheet1.Cells.AutoFitColumns(14, 40);
            wsSheet1.Column(3).Width = 40;
            wsSheet1.Column(3).Style.WrapText = true;

            int loopCount = 2;
            wsSheet1.Cells[loopCount, 1].Value = "#";
            wsSheet1.Cells[loopCount, 2].Value = "Diff";
            wsSheet1.Cells[loopCount, 3].Value = "Assign. First Project Type";
            wsSheet1.Cells[loopCount, 4].Value = "Last Assign Scientist";
            wsSheet1.Cells[loopCount, 5].Value = "Last Assign Sub scientist";
            wsSheet1.Cells[loopCount, 6].Value = "Lead Time";
            wsSheet1.Cells[loopCount, 7].Value = "First Assign Scientist";
            wsSheet1.Cells[loopCount, 8].Value = "Product Name";
            wsSheet1.Cells[loopCount, 9].Value = "CATLOG NO.";
            wsSheet1.Cells[loopCount, 10].Value = "CAS No.";
            wsSheet1.Cells[loopCount, 11].Value = "Quantity(mg)";
            wsSheet1.Cells[loopCount, 12].Value = "Batch Code";
            wsSheet1.Cells[loopCount, 13].Value = "Data Remark";
            wsSheet1.Cells[loopCount, 14].Value = "Reason";
            wsSheet1.Cells[loopCount, 15].Value = "Technical Contact";
            wsSheet1.Cells[loopCount, 16].Value = "Pack Size";
            wsSheet1.Cells[loopCount, 17].Value = "Invoice Date";
            wsSheet1.Cells[loopCount, 18].Value = "Courier";
            wsSheet1.Cells[loopCount, 19].Value = "Tracking No";
            wsSheet1.Cells[loopCount, 20].Value = "Location";
            wsSheet1.Cells[loopCount, 21].Value = "Reference Name";
            wsSheet1.Cells[loopCount, 22].Value = "Purpose of dispatch";
            wsSheet1.Cells[loopCount, 23].Value = "Delivery Date";
            wsSheet1.Cells[loopCount, 24].Value = "Pack Size";
            wsSheet1.Cells[loopCount, 25].Value = "Invoice Remark";
            wsSheet1.Cells[loopCount, 26].Value = "Invoice No";
            wsSheet1.Cells[loopCount, 27].Value = "Payment Status";
            using (ExcelRange Rng = wsSheet1.Cells[loopCount, 1, loopCount, 27])
            {
                Rng.Style.Font.Bold = true;
                Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#7b7b7b");
                Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                Rng.Style.Font.Color.SetColor(Color.White);
                Rng.Style.WrapText = true;
            }

            loopCount = loopCount + 1;
            int srno = 1;
            foreach (var item in list)
            {
                var assignfirstprojecttype = LogData.Where(x => x.PropertyName == "ProjectType").OrderBy(x => x.Datetime).Select(x => x.After).FirstOrDefault();
                var lastAssignScientist = LogData.Where(x => x.PropertyName == "ScientistCustomerId").OrderByDescending(x => x.Datetime).Select(x => x.Before).FirstOrDefault();
                var lastAssignSubscientist = LogData.Where(x => x.PropertyName == "SubScientistName").OrderByDescending(x => x.Datetime).Select(x => x.Before).FirstOrDefault();
                var firstAssignSubscientist = LogData.Where(x => x.PropertyName == "ScientistCustomerId").OrderBy(x => x.Datetime).Select(x => x.After).FirstOrDefault();

                wsSheet1.Cells[loopCount, 1].Value = srno;
                wsSheet1.Cells[loopCount, 2].Value = item.QuoteDetail.DifficultyLevel;
                wsSheet1.Cells[loopCount, 3].Value = assignfirstprojecttype;
                wsSheet1.Cells[loopCount, 4].Value = lastAssignScientist;
                wsSheet1.Cells[loopCount, 5].Value = lastAssignSubscientist;
                wsSheet1.Cells[loopCount, 6].Value = item.QuoteDetail.LeadTime;
                wsSheet1.Cells[loopCount, 7].Value = firstAssignSubscientist;
                wsSheet1.Cells[loopCount, 8].Value = item.QuoteDetail.ProductName;
                wsSheet1.Cells[loopCount, 9].Value = item.QuoteDetail.CATNo;
                wsSheet1.Cells[loopCount, 10].Value = item.QuoteDetail.CASNo;
                wsSheet1.Cells[loopCount, 11].Value = item.QuoteDetail.RequiredQty;
                wsSheet1.Cells[loopCount, 12].Value = item.QuoteDetail.AdditionalBatchNo;
                wsSheet1.Cells[loopCount, 13].Value = item.QuoteDetail.Remark;
                wsSheet1.Cells[loopCount, 14].Value = item.QuoteDetail.Reason;
                wsSheet1.Cells[loopCount, 15].Value = item.QuoteDetail.TechnicalEmail;
                wsSheet1.Cells[loopCount, 16].Value = item.QuoteDetail.OrderRemark;
                wsSheet1.Cells[loopCount, 17].Value = item.QuoteDetail.InvoicedDate;
                wsSheet1.Cells[loopCount, 18].Value = item.QuoteDetail.Courier;
                wsSheet1.Cells[loopCount, 19].Value = item.QuoteDetail.TrackingNo;
                wsSheet1.Cells[loopCount, 20].Value = item.QuoteDetail.Location;
                wsSheet1.Cells[loopCount, 21].Value = "";
                wsSheet1.Cells[loopCount, 22].Value = "";
                wsSheet1.Cells[loopCount, 23].Value = item.QuoteDetail.DeliveryDate;
                wsSheet1.Cells[loopCount, 24].Value = "";
                wsSheet1.Cells[loopCount, 25].Value = item.QuoteDetail.InvoiceRemark;
                wsSheet1.Cells[loopCount, 26].Value = item.QuoteDetail.InvoiceNo;
                wsSheet1.Cells[loopCount, 27].Value = item.QuoteDetail.PaymentStatus;
                srno += 1;
                loopCount += 1;
            }

            string filePath = HostingEnvironment.MapPath("~/Content/Quotation/") + "AllData-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xlsx";
            ExcelPkg.SaveAs(new FileInfo(filePath));
            return File(filePath, "application/excel", Server.UrlEncode("AllData-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xls"));
        }


        [HttpPost]
        public JsonResult LoadBrazilData()
        {
            try
            {
                var leftcompanyId = 0;
                var startdate = string.Empty;
                var enddate = string.Empty;
                var tablename = string.Empty;
                var searchValuetext = string.Empty;
                if (Request.Form.GetValues("CompanyId") != null)
                {
                    leftcompanyId = Convert.ToInt32(Request.Form.GetValues("CompanyId")[0].ToString());
                }
                if (Request.Form.GetValues("StartDate") != null)
                {
                    startdate = Request.Form.GetValues("StartDate")[0].ToString();
                }
                if (Request.Form.GetValues("EndDate") != null)
                {
                    enddate = Request.Form.GetValues("EndDate")[0].ToString();
                }
                if (Request.Form.GetValues("SearchValue") != null)
                {
                    searchValuetext = Request.Form.GetValues("SearchValue")[0].ToString();
                }

                var searchby = string.Empty;
                var searchbyvalue = string.Empty;
                var ddlexportdist = string.Empty;
                if (Request.Form.GetValues("radiobuton") != null)
                {
                    searchby = Request.Form.GetValues("radiobuton")[0].ToString();
                }
                if (Request.Form.GetValues("searchbox") != null)
                {
                    searchbyvalue = Request.Form.GetValues("searchbox")[0].Trim().ToString();
                }
                if (Request.Form.GetValues("tablename") != null)
                {
                    tablename = Request.Form.GetValues("tablename")[0].ToString();
                }

                var length = Request.Form.GetValues("length").FirstOrDefault();
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                int numberOfObjectsPerPage = Convert.ToInt32(Request.Form["length"]);
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int pageNo = 1;
                if (skip > 0)
                {
                    pageNo = (skip / numberOfObjectsPerPage) + 1;
                }

                List<int?> cidList = new List<int?>();
                if (leftcompanyId == 0)
                {
                    string internationcompanylist = "";
                    internationcompanylist = db.SZ_UserManagement.Where(x => x.UserId == SessionCookieManagement.UserId).Select(x => x.CompanyIds).FirstOrDefault();
                    if (!string.IsNullOrEmpty(internationcompanylist))
                    {
                        foreach (var item in internationcompanylist.Split(','))
                        {
                            if (!string.IsNullOrEmpty(item))
                            {
                                cidList.Add(Convert.ToInt32(item));
                            }
                        }
                    }
                }
                else
                {
                    cidList.Add(leftcompanyId);
                }
                var model = db.SZ_Quotation.Where(x => cidList.Contains(x.CompanyId) && x.CreatedDate >= new DateTime(2022, 05, 01)).AsQueryable();

                if (!string.IsNullOrEmpty(startdate))
                {
                    DateTime sd = Convert.ToDateTime(startdate);
                    model = model.Where(x => x.CreatedDate >= sd).AsQueryable();
                }
                if (!string.IsNullOrEmpty(enddate))
                {
                    DateTime ed = Convert.ToDateTime(enddate);
                    model = model.Where(x => x.CreatedDate <= ed).AsQueryable();
                }

                var outputModel = model.ToList();
                if (!string.IsNullOrEmpty(searchValuetext))
                {
                    searchValuetext = searchValuetext.ToLower().Trim();
                    outputModel = outputModel.Where(x => (x.Ref != null && x.Ref.ToLower().Contains(searchValuetext))
                                        || (x.CompanyName != null && x.CompanyName.ToLower().Contains(searchValuetext))
                                        || (x.PONo != null && x.PONo.ToLower().Contains(searchValuetext))
                                        || (x.SZ_QuotationDetail != null && x.SZ_QuotationDetail.Where(z => z.CATNo != null && z.CATNo.ToLower().Contains(searchValuetext)).Any())
                                        || (x.SZ_QuotationDetail != null && x.SZ_QuotationDetail.Where(z => z.CASNo != null && z.CASNo.ToLower().Contains(searchValuetext)).Any())
                                        || (x.SZ_QuotationDetail != null && x.SZ_QuotationDetail.Where(z => z.ProductName != null && z.ProductName.ToLower().Contains(searchValuetext)).Any())).ToList();
                }

                outputModel = outputModel.OrderByDescending(x => x.CreatedDate).ToList();
                //model = model.OrderByDescending(x => x.CreatedDate).AsQueryable();
                int? recordsTotal = outputModel.Count;
                var result = outputModel.Skip(skip).Take(pageSize).ToList();
                var data = PrepareQuotationListModelInternational(result);
                var jsonResult = Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
                jsonResult.MaxJsonLength = int.MaxValue;
                return jsonResult;

                //return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);
                throw ex;
            }
        }

        public ActionResult GetFormDatafromBatchId(int batchId)
        {
            SZ_QuoteDetailForm objData = new SZ_QuoteDetailForm();
            var batchCode = db.SZ_Inventory.Where(x => x.Id == batchId).Select(x => x.BatchNo).FirstOrDefault();
            var formdata = db.SZ_QuoteDetailForm.Where(x => x.BatchCode == batchCode).FirstOrDefault();
            if (formdata != null)
            {
                objData.IRAttachment = formdata.IRAttachment;
                objData.MassAttachment = formdata.MassAttachment;
                objData.TempSensitive = formdata.TempSensitive;
                objData.Lacrymatory = formdata.Lacrymatory;
                objData.PLCAttachment = formdata.PLCAttachment;
                objData.NMRAttchment = formdata.NMRAttchment;
                objData.QNMRAttchment = formdata.QNMRAttchment;
                objData.TGAAttachment = formdata.TGAAttachment;
                objData.CMRAttchment = formdata.CMRAttchment;
                objData.DEPTAttachment = formdata.DEPTAttachment;
                objData.HRMSAttachment = formdata.HRMSAttachment;
                objData.ROIAttachment = formdata.ROIAttachment;
                objData.ElementralAttachment = formdata.ElementralAttachment;
                objData.SERAttachment = formdata.SERAttachment;
                objData.GCAttachment = formdata.GCAttachment;
                objData.ELSDAttachment = formdata.ELSDAttachment;
                objData.ChiralAttachmenrt = formdata.ChiralAttachmenrt;
                objData.APCIMassAttachment = formdata.APCIMassAttachment;
                objData.NMRInterpretaionAttachment = formdata.NMRInterpretaionAttachment;
                objData.LightSensitivity = formdata.LightSensitivity;
                objData.Photostability = formdata.Photostability;
                objData.ChkHygroscopic = formdata.ChkHygroscopic;
                objData.TempSensitive = formdata.TempSensitive;
                objData.Lacrymatory = formdata.Lacrymatory;
                objData.State = formdata.State;
                objData.Apearance = formdata.Apearance;
            }
            else
            {
                objData = null;
            }

            return Json(objData, JsonRequestBehavior.AllowGet);
        }

        public JsonResult GetAllQuoteDetailsIdOfPoNumberByQuoteId(int id)
        {
            var quote = _operationRepository.GetQuoteByID(id);
            if (quote == null)
            {
                return Json(new { success = false, message = "Quote not found" }, JsonRequestBehavior.AllowGet);
            }
            var multiplepoquote = db.SZ_Quotation.AsNoTracking().Where(x => x.PONo == quote.PONo).ToList();
            var quoteids = multiplepoquote.Select(x => x.Id).ToList();
            List<int> ids = new List<int>();
            ids = db.SZ_QuotationDetail.AsNoTracking().Where(x => quoteids.Contains(x.QuoteId)).Select(x => x.Id).ToList();
            return Json(new { success = true, ids = ids }, JsonRequestBehavior.AllowGet);
        }

        public JsonResult RemoveShowOnDashboard(int id)
        {
            var quote = _operationRepository.GetQuoteByID(id);
            if (quote != null)
            {
                quote.IsShowDashboard = false;
                db.Entry(quote).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json(new { success = true }, JsonRequestBehavior.AllowGet);
        }

        public JsonResult LoadCompanyNamefromQuotationtab(string tabName)
        {
            MemoryCacheManager objCache = new MemoryCacheManager();
            var compList = objCache.Get("cache.CompanyNamefromQuotationtab", () =>
            {
                return db.SZ_Quotation.AsNoTracking().Select(x => x.CompanyName).Distinct().OrderBy(x => x).ToList();
            });
            return Json(compList, JsonRequestBehavior.AllowGet);
        }

        [HttpGet]
        public ActionResult quotecompleted(int id)
        {
            var model = _operationRepository.GetQuoteByID(id);
            if (model != null)
            {
                model.QuoteCompDate = DateTime.Now;
                model.IsCompleted = true;
                db.Entry(model).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json(true, JsonRequestBehavior.AllowGet);
        }

        [HttpGet]
        public ActionResult ApprovedSampleRequest(int id)
        {
            var model = db.SZ_SampleRequestDetail.Where(x => x.Id == id).FirstOrDefault();
            if (model != null)
            {
                var inv = db.SZ_Inventory.Where(x => x.Id == model.BatchId).FirstOrDefault();
                if (inv != null)
                {
                    // Deduct Inventory
                    SZ_InventoryLog objlog = new SZ_InventoryLog();
                    objlog.CreatedDate = DateTime.Now;
                    objlog.InventoryId = inv.Id;
                    objlog.CurrentQty = Convert.ToString(inv.Qty - Convert.ToDecimal(model.Qty));
                    objlog.PreviousQty = Convert.ToString(inv.Qty);
                    objlog.PoNumber = model.SZ_SampleRequest.RequestNo;
                    objlog.Reason = "Sample Dispatched";
                    objlog.UserId = SessionCookieManagement.UserId;
                    objlog.UserName = SessionCookieManagement.UserName;
                    db.Entry(objlog).State = EntityState.Added;

                    inv.Qty = inv.Qty - Convert.ToDecimal(model.Qty);
                    db.Entry(inv).State = EntityState.Modified;
                }

                model.ResponseDate = DateTime.Now;
                model.IsApproved = true;
                db.Entry(model).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json(true, JsonRequestBehavior.AllowGet);
        }

        [HttpGet]
        public ActionResult RejectedSampleRequest(int id, string reason)
        {
            var model = db.SZ_SampleRequestDetail.Where(x => x.Id == id).FirstOrDefault();
            if (model != null)
            {
                model.ResponseDate = DateTime.Now;
                model.IsApproved = false;
                model.RejectReason = reason;
                db.Entry(model).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json(true, JsonRequestBehavior.AllowGet);
        }

        public ActionResult SampleRequestList()
        {
            var model = db.SZ_SampleRequestDetail.Where(x => x.SZ_SampleRequest.IsConfirm == true).OrderByDescending(x => x.CreatedDate).ToList();
            return View(model);
        }

        public ActionResult NewSampleRequestList()
        {
            if (!SessionCookieManagement.IsLogin)
            {
                return RedirectToAction("Index", "Home");
            }

            var model = new List<SZ_SampleRequestDetail>();
            if (SessionCookieManagement.IsAdmin)
            {
                model = (from i in db.SZ_SampleRequest
                         join pc in db.SZ_SampleRequestDetail on i.Id equals pc.SampleRequestId
                         select pc).OrderByDescending(x => x.SZ_SampleRequest.RequestDate).ToList();
            }
            else
            {
                model = (from i in db.SZ_SampleRequest
                         join pc in db.SZ_SampleRequestDetail on i.Id equals pc.SampleRequestId
                         where i.CreateduserId == SessionCookieManagement.UserId
                         select pc).OrderByDescending(x => x.SZ_SampleRequest.RequestDate).ToList();
            }

            return View(model);
        }

        public ActionResult Bug(int id = 0)
        {
            if (!SessionCookieManagement.IsLogin)
            {
                return RedirectToAction("Index", "Home");
            }
            var model = db.SZ_Bug.Where(x => x.Id == id).FirstOrDefault();
            if (model == null)
            {
                model = new SZ_Bug();
                int refNo = 1;
                string value = string.Empty;
                string matchingstring = "SZ-BUG-";
                var SZ_Quotationdata = (from i in db.SZ_Bug
                                        where i.BugNo.StartsWith(matchingstring)
                                        select i).ToList();
                if (SZ_Quotationdata.Count > 0)
                {
                    refNo = SZ_Quotationdata.Select(x => ExtractQuoreRefNumber(x.BugNo)).Max(w => w);
                    int newbrokerrewf = Convert.ToInt32(refNo) + 1;

                    value = "SZ-BUG-" + newbrokerrewf.ToString().PadLeft(2, '0');
                }
                else
                {
                    value = "SZ-BUG-" + "-01";
                }

                model.BugNo = value;
            }

            return View(model);
        }

        public ActionResult NewSampleRequest(int id = 0)
        {
            if (!SessionCookieManagement.IsLogin)
            {
                return RedirectToAction("Index", "Home");
            }
            var model = db.SZ_SampleRequest.Where(x => x.Id == id).FirstOrDefault();
            if (model == null)
            {
                model = new SZ_SampleRequest();
                int refNo = 1;
                string value = string.Empty;
                string matchingstring = "SZ-SMP-";
                var SZ_Quotationdata = (from i in db.SZ_SampleRequest.AsNoTracking()
                                        where i.RequestNo.StartsWith(matchingstring)
                                        select i).ToList();
                if (SZ_Quotationdata.Count > 0)
                {
                    refNo = SZ_Quotationdata.Select(x => ExtractSampleRequestNumber(x.RequestNo)).Max(w => w);
                    int newbrokerrewf = Convert.ToInt32(refNo) + 1;

                    value = "SZ-SMP-" + newbrokerrewf.ToString().PadLeft(2, '0');
                }
                else
                {
                    value = "SZ-SMP-" + "01";
                }
                model.RequestNo = value;
            }

            var listItems = new List<SelectListItem>();
            listItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var samplereasonlist = db.SZ_SampleReason.ToList();
            if (samplereasonlist != null && samplereasonlist.Count > 0)
            {
                foreach (var item in samplereasonlist)
                {
                    listItems.Add(new SelectListItem
                    {
                        Text = item.Name,
                        Value = item.Name
                    });
                }
            }

            ViewBag.SampleReasonListItem = listItems;

            return View(model);
        }


        [HttpPost]
        public ActionResult SaveBrazildata(List<BrazilModel> model)
        {
            foreach (var item in model)
            {
                var quotedetails = _operationRepository.GetQuoteDetailByID(item.Id);
                if (quotedetails != null)
                {
                    quotedetails.InternationFeedback = item.Feedback;
                    if (!string.IsNullOrEmpty(item.InternationalStatus))
                    {
                        quotedetails.InternationStatus = Convert.ToInt32(item.InternationalStatus);
                    }
                    else
                    {
                        quotedetails.InternationStatus = null;
                    }
                    db.Entry(quotedetails).State = EntityState.Modified;

                }
            }
            db.SaveChanges();
            return Json(new { success = true });

        }

        public ActionResult SyncSAPData(string poNumber)
        {
            //string url = "http://103.54.21.42:334/api/SAPSaleOrder/GetSampleObject";
            //string url = "http://103.54.21.42:334/api/SAPSaleOrder/Post";
            string url = "http://103.54.21.42:333/api/SAPSaleOrder/Post";
            var isDevelopment = ConfigurationManager.AppSettings["IsDevelopment"];
            if (isDevelopment.ToLower().Contains("true"))
            {
                url = "http://103.54.21.42:334/api/SAPSaleOrder/Post";
            }

            HttpMessageHandler handler = new HttpClientHandler();
            var httpClient = new HttpClient(handler)
            {
                BaseAddress = new Uri(url),
                Timeout = new TimeSpan(0, 2, 0)
            };
            httpClient.DefaultRequestHeaders.Add("ContentType", "application/json");
            var plainTextBytes = System.Text.Encoding.UTF8.GetBytes("Spms:Sz@123");
            string val = System.Convert.ToBase64String(plainTextBytes);
            httpClient.DefaultRequestHeaders.Add("Authorization", "Basic " + val);

            string inhouseProjectType = Convert.ToString("5");
            DateTime checkedData = new DateTime(2022, 05, 01);

            var listdata = (from i in db.SZ_Quotation.AsNoTracking()
                            join t2 in db.SZ_QuotationDetail.AsNoTracking() on i.Id equals t2.QuoteId
                            where t2.MoveToProject == true
                            && (t2.MoveToInvoice == false || t2.MoveToInvoice == null)
                            && (t2.ProjectType != inhouseProjectType || t2.ProjectType == null)
                            && i.CreatedDate >= checkedData
                            && (t2.IsSuccessSAP == null || t2.IsSuccessSAP == false)
                            //&& i.PONo == "3100012740"
                            && i.PONo == poNumber
                            select i.PONo).Distinct().FirstOrDefault();

            var list = (from i in db.SZ_Quotation.AsNoTracking()
                        join t2 in db.SZ_QuotationDetail.AsNoTracking() on i.Id equals t2.QuoteId
                        where t2.MoveToProject == true && (t2.MoveToInvoice == false || t2.MoveToInvoice == null)
                            && (t2.ProjectType != inhouseProjectType || t2.ProjectType == null)
                            && listdata.Contains(i.PONo)
                            && i.CreatedDate >= checkedData
                        orderby t2.Id descending
                        select new
                        {
                            Quote = i,
                            QuoteDetail = t2
                        }).ToList();

            var customerData = db.Customers.Where(x => x.Deleted == false).ToList();
            var pIds = list.Where(x => x.QuoteDetail.ProductId.HasValue).Select(x => x.QuoteDetail.ProductId).ToList();
            //var pIds = list.Any(x => x.QuoteDetail.ProductId.ToLower() == needle.ToLower());
            var inventoryData = db.SZ_Inventory.Where(x => pIds.Contains(x.ProductId)).ToList();
            var outputModel = new List<MovetoProjectSAPModel>();
            list.ForEach(item =>
            {
                var model = new MovetoProjectSAPModel();
                model.SAPSOLId = item.QuoteDetail.SAPSOLId.HasValue ? item.QuoteDetail.SAPSOLId.Value : 0;
                model.SAPSODocEntry = !string.IsNullOrEmpty(item.QuoteDetail.SAPSODocEntry) ? Convert.ToInt32(item.QuoteDetail.SAPSODocEntry) : 0;
                model.SAPSONo = !string.IsNullOrEmpty(item.QuoteDetail.SAPSONo) ? Convert.ToInt32(item.QuoteDetail.SAPSONo) : 0;
                model.Reason = item.QuoteDetail.Reason;
                model.OrderRemark = !string.IsNullOrEmpty(item.QuoteDetail.OrderRemark) ? item.QuoteDetail.OrderRemark.Trim() : "";
                model.ActivityStatus = !string.IsNullOrEmpty(item.QuoteDetail.ActivityStatus) ? item.QuoteDetail.ActivityStatus.Trim() : "";
                if (!string.IsNullOrEmpty(item.QuoteDetail.ProStatus))
                {
                    model.Projectstatus = SZ_Helper.GetEnumDescription((EnumList.ProStatusDDL)Convert.ToInt32(item.QuoteDetail.ProStatus));
                }
                else
                {
                    model.Projectstatus = "";
                }
                model.LineRemark = !string.IsNullOrEmpty(item.QuoteDetail.Remark) ? item.QuoteDetail.Remark : "";
                model.DocType = "";
                model.QuoteId = item.Quote.Id;
                model.QuoteDetailId = item.QuoteDetail.Id;
                model.PONo = item.Quote.PONo;
                model.sapCusName = item.Quote.CompanyName;
                model.SAPCusCode = db.SZ_CompanyList.Where(x => x.Id == item.Quote.CompanyId).Select(x => x.SAPCode).FirstOrDefault();
                model.DocDate = item.Quote.PODate.HasValue ? item.Quote.PODate.Value.ToString() : "";
                model.DocCurrency = SZ_Helper.GetCurrancy(item.Quote);
                model.DocRemark = !string.IsNullOrEmpty(item.Quote.Remark) ? item.Quote.Remark.Trim() : "";
                model.ItemCode = !string.IsNullOrEmpty(item.QuoteDetail.CATNo) ? item.QuoteDetail.CATNo.Trim() : "";
                model.CASNo = !string.IsNullOrEmpty(item.QuoteDetail.CASNo) ? item.QuoteDetail.CASNo : "";
                model.ItemName = item.QuoteDetail.ProductName;
                model.QuantityPO = SZ_Helper.CalculateQty(item.QuoteDetail.RequiredQty);
                model.LineType = SZ_Helper.GetProjectType(item.QuoteDetail.ProjectType);
                model.PriceBfrDiscount = SZ_Helper.CalculateBeforePriceData(item.QuoteDetail);
                model.NoofPack = SZ_Helper.CalculateNoofPackFromOrderConfirmation(item.QuoteDetail.OrderRemark);
                model.PackSize = SZ_Helper.CalculatePackSizeFromOrderConfirmation(item.QuoteDetail.OrderRemark);
                //model.PackSize = CalculatePackSize(item.QuoteDetail);
                model.Discount = item.QuoteDetail.ItemDiscount.HasValue ? item.QuoteDetail.ItemDiscount.Value : 0;
                model.COARefNumber = !string.IsNullOrEmpty(item.QuoteDetail.COARefNumber) ? item.QuoteDetail.COARefNumber : "";
                model.BatchNo = SZ_Helper.CheckBatch(inventoryData, item.QuoteDetail);
                model.IsInvoice = item.QuoteDetail.MoveToInvoice.HasValue ? item.QuoteDetail.MoveToInvoice.Value : false;
                model.PriceAfrDiscount = SZ_Helper.CalculateAftPriceData(item.QuoteDetail, model);
                model.UnitPerRate = SZ_Helper.GetUnitPerRate(model);
                outputModel.Add(model);
            });

            var quoteIds = outputModel.Select(x => x.QuoteId).Distinct().ToList();

            if (quoteIds != null && quoteIds.Count > 0)
            {
                foreach (var item in quoteIds)
                {
                    var itemData = outputModel.Where(x => x.QuoteId == item).ToList();

                    var data = new SAPPostModel();
                    data.DocEntry = itemData[0].SAPSODocEntry;
                    data.DocNum = 0;
                    data.CustomerRefNo = itemData[0].PONo;
                    data.DocCurrency = itemData[0].DocCurrency;
                    data.BPCode = itemData[0].SAPCusCode;
                    data.BPName = itemData[0].sapCusName;
                    data.DocDate = Convert.ToDateTime(itemData[0].DocDate);
                    data.DocDueDate = Convert.ToDateTime(itemData[0].DocDate).AddDays(30);
                    data.DocRemark = itemData[0].DocRemark;
                    data.DocRemark_Opening = "";
                    data.DocRemark_Closing = "";
                    data.ExternalPK = Convert.ToString(itemData[0].QuoteId);
                    data.EmpCode = Convert.ToString(itemData[0].QuoteDetailId);
                    data.ApplicationType = "SPMS";
                    data.TransactionType = "";
                    data.Doc_Lines = new List<DocLine>();
                    int quoteId = itemData[0].QuoteId;
                    foreach (var i in itemData.OrderBy(x => x.QuoteDetailId))
                    {
                        var subm = new DocLine();
                        if (i.SAPSOLId != null)
                        {
                            subm.LineNum = i.SAPSOLId;
                        }
                        else
                        {
                            var dataSO = db.SZ_QuotationDetail.Where(x => x.QuoteId == quoteId && x.SAPSOLId != null).Count();
                            if (dataSO == 0)
                            {
                                subm.LineNum = 0;
                            }
                            else
                            {
                                int soLId = db.SZ_QuotationDetail.Where(x => x.QuoteId == quoteId && x.SAPSOLId.HasValue).Max(x => x.SAPSOLId.Value) + 1;
                                subm.LineNum = soLId;
                            }
                        }
                        subm.ItemCode = i.ItemCode;
                        subm.CASNo = i.CASNo;
                        subm.Quantity = i.QuantityPO;
                        subm.UOMCode = "MG";
                        subm.UnitPrice = i.UnitPerRate;
                        subm.DiscountPercent = i.Discount;
                        subm.WarehouseCode = "Dispatch";
                        subm.ProjectCode = "";
                        subm.PackSize = i.PackSize;
                        subm.NoPack = i.NoofPack;
                        subm.ActivityStatus = i.ActivityStatus;
                        subm.ProjectStatus = i.Projectstatus;
                        subm.ProjectType = i.LineType;
                        subm.LineRemark = i.LineRemark;
                        subm.BatchNo = i.BatchNo;
                        subm.COARefNumber = i.COARefNumber;
                        subm.Reason = i.Reason;
                        subm.DataRemark = i.OrderRemark;
                        subm.QuoteId = Convert.ToString(i.QuoteId);
                        subm.QuoteLId = Convert.ToString(i.QuoteDetailId);
                        subm.ExtPK_LId = Convert.ToString(i.QuoteDetailId);
                        subm.ExtPK_LType = "QUOTATION";
                        subm.ExtPK = Convert.ToString(i.QuoteId);
                        data.Doc_Lines.Add(subm);
                    }

                    var myContent = JsonConvert.SerializeObject(data);
                    System.IO.File.WriteAllText(Server.MapPath("~/img/SyncSAPPost.txt"), myContent);

                    var buffer = System.Text.Encoding.UTF8.GetBytes(myContent);
                    var byteContent = new ByteArrayContent(buffer);
                    byteContent.Headers.ContentType = new MediaTypeHeaderValue("application/json");
                    HttpResponseMessage response = httpClient.PostAsync(url, byteContent).Result;
                    string content = string.Empty;

                    using (StreamReader stream = new StreamReader(response.Content.ReadAsStreamAsync().Result, System.Text.Encoding.GetEncoding(0)))
                    {
                        content = stream.ReadToEnd();
                    }

                    var results = JsonConvert.DeserializeObject<ResponseSAPModel>(content);
                    if (results != null)
                    {
                        foreach (var qitem in results.MEXT_Response_Details[0].MEXT_Response_Details_Id)
                        {
                            if (!string.IsNullOrEmpty(qitem.ExtPK_LId))
                            {
                                var qid = Convert.ToInt32(qitem.ExtPK_LId);
                                var qdata = db.SZ_QuotationDetail.Where(x => x.Id == qid).FirstOrDefault();
                                if (qdata != null)
                                {
                                    qdata.IsSuccessSAP = true;
                                    qdata.SAPSODocEntry = results.MEXT_Response_Details[0].DocEntry;
                                    qdata.SAPSOLId = Convert.ToInt32(qitem.LineNum);
                                    qdata.SAPSONo = results.MEXT_Response_Details[0].DocNum;
                                    db.Entry(qdata).State = EntityState.Modified;
                                }
                            }
                        }
                        db.SaveChanges();
                    }
                }
            }

            return Content("success");
        }

        [HttpPost]
        public ActionResult UpdateFeedbackdata(BrazilModel model)
        {
            var quotedetails = _operationRepository.GetQuoteDetailByID(model.Id);
            if (quotedetails != null)
            {
                quotedetails.InternationFeedback = model.Feedback;
                db.Entry(quotedetails).State = EntityState.Modified;

            }
            db.SaveChanges();
            return Json(new { success = true });

        }


        [HttpPost]
        public ActionResult NewSampleRequestData(ProductSampleRequestModel model)
        {
            bool isNew = false;
            if (model.Id == 0)
            {
                int refNo = 1;
                string value = string.Empty;
                string matchingstring = "SZ-SMP-";
                var SZ_Quotationdata = (from i in db.SZ_SampleRequest.AsNoTracking()
                                        where i.RequestNo.StartsWith(matchingstring)
                                        select i).ToList();
                if (SZ_Quotationdata.Count > 0)
                {
                    refNo = SZ_Quotationdata.Select(x => ExtractSampleRequestNumber(x.RequestNo)).Max(w => w);
                    int newbrokerrewf = Convert.ToInt32(refNo) + 1;

                    value = "SZ-SMP-" + newbrokerrewf.ToString().PadLeft(2, '0');
                }
                else
                {
                    value = "SZ-SMP-" + "-01";
                }

                isNew = true;
                SZ_SampleRequest objSampleRequest = new SZ_SampleRequest();
                objSampleRequest.Name = model.Name;
                objSampleRequest.RequestNo = value;
                objSampleRequest.RequestDate = model.RequestDate;
                objSampleRequest.Department = model.Department;
                objSampleRequest.CreateduserId = SessionCookieManagement.UserId;
                objSampleRequest.CreatedBy = SessionCookieManagement.UserName;
                objSampleRequest.CreatedDate = DateTime.Now;
                db.SZ_SampleRequest.Add(objSampleRequest);
                db.SaveChanges();


                foreach (var item in model.BatchIds)
                {
                    var inventoryData = db.SZ_Inventory.Where(x => x.Id == item).FirstOrDefault();
                    SZ_SampleRequestDetail objdetails = new SZ_SampleRequestDetail();
                    objdetails.SampleRequestId = objSampleRequest.Id;
                    objdetails.ProductId = model.ProductId;
                    objdetails.CASNo = model.CASNo;
                    objdetails.CATNo = model.CatelogueNo;
                    objdetails.ProductName = model.ProductName;
                    objdetails.BatchCode = inventoryData.BatchNo;
                    objdetails.BatchId = item;
                    objdetails.Qty = 0;
                    objdetails.Reason = "";
                    objdetails.Handoverby = "";
                    objdetails.CreatedDate = DateTime.Now;
                    objdetails.CreatedBy = SessionCookieManagement.UserName;
                    objdetails.IsApproved = null;
                    db.SZ_SampleRequestDetail.Add(objdetails);
                }
                db.SaveChanges();

                model.Id = objSampleRequest.Id;
            }
            else
            {
                var data = db.SZ_SampleRequest.Where(x => x.Id == model.Id).FirstOrDefault();
                if (data != null)
                {
                    data.Name = model.Name;
                    data.RequestDate = model.RequestDate;
                    data.Department = model.Department;
                    db.Entry(data).State = EntityState.Modified;
                    db.SaveChanges();

                    model.Id = data.Id;
                    foreach (var item in model.BatchIds)
                    {
                        var inventoryData = db.SZ_Inventory.Where(x => x.Id == item).FirstOrDefault();
                        SZ_SampleRequestDetail objdetails = new SZ_SampleRequestDetail();
                        objdetails.SampleRequestId = data.Id;
                        objdetails.ProductId = model.ProductId;
                        objdetails.CASNo = model.CASNo;
                        objdetails.CATNo = model.CatelogueNo;
                        objdetails.ProductName = model.ProductName;
                        objdetails.BatchCode = inventoryData.BatchNo;
                        objdetails.BatchId = item;
                        objdetails.Qty = 0;
                        objdetails.Reason = "";
                        objdetails.Handoverby = "";
                        objdetails.CreatedDate = DateTime.Now;
                        objdetails.CreatedBy = SessionCookieManagement.UserName;
                        objdetails.IsApproved = null;
                        db.SZ_SampleRequestDetail.Add(objdetails);
                    }
                    db.SaveChanges();
                }
            }

            return Json(new { success = true, isNew = isNew, data = model.Id });
        }

        [HttpPost]
        public ActionResult NewProductSampleRequestData(List<ProductSampleRequestProductModel> model, bool isSubmit = false)
        {
            var sampleRequestId = 0;
            foreach (var item in model)
            {
                var data = db.SZ_SampleRequestDetail.Where(x => x.Id == item.Id).FirstOrDefault();
                if (data != null)
                {
                    sampleRequestId = data.SampleRequestId;
                    data.Qty = item.Qty;
                    data.Reason = item.Reason;
                    data.Handoverby = item.Handoverby;
                    db.Entry(data).State = EntityState.Modified;
                }
            }

            if (isSubmit)
            {
                var data = db.SZ_SampleRequest.Where(x => x.Id == sampleRequestId).FirstOrDefault();
                if (data != null)
                {
                    data.IsConfirm = isSubmit;
                    db.Entry(data).State = EntityState.Modified;
                }
            }

            db.SaveChanges();
            return Json(new { data = sampleRequestId, success = true });
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult DeleteRFQ(List<int> id)
        {
            foreach (var rfqid in id)
            {
                var querydata = db.SZ_Query.Where(x => x.Id == rfqid).FirstOrDefault();
                if (querydata != null)
                {
                    db.Entry(querydata).State = EntityState.Deleted;
                }
            }
            db.SaveChanges();

            return Json(new { success = true });
        }

        public JsonResult LoadRFQQuotationData()
        {
            try
            {
                bool isMiniAdmin = SessionCookieManagement.IsMiniAdmin;
                var length = Request.Form.GetValues("length").FirstOrDefault();
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                int numberOfObjectsPerPage = Convert.ToInt32(Request.Form["length"]);
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int pageNo = 1;
                if (skip > 0)
                {
                    pageNo = (skip / numberOfObjectsPerPage) + 1;
                }
                var data = db.SZ_Query.ToList();
                //var allproduct = db.Products.ToList();
                //var allcustomer = db.Customers.ToList();
                var model = new List<RFQQuoteModel>();
                foreach (var item in data)
                {
                    try
                    {
                        var objmodel = new RFQQuoteModel();
                        objmodel.Id = item.Id;
                        objmodel.FullName = item.FullName;
                        objmodel.CompanyName = item.CompanyName;
                        objmodel.CASNo = item.CASNo;
                        objmodel.CATNo = item.CATNo;
                        objmodel.ProductId = item.ProductId;
                        objmodel.ProductName = item.ProductName;
                        objmodel.RequiredQty = item.Package != null ? item.Package.Replace("KG", "").Replace("MG", "").Replace("G", "").Trim() : "";
                        objmodel.RFQDate = item.CreatedDate;
                        objmodel.RFQDateText = item.CreatedDate.HasValue ? item.CreatedDate.Value.ToShortDateString() : null;
                        objmodel.Email = item.Email;
                        objmodel.ChkFirstRow = "<input type='checkbox' value='" + item.Id + "' data-companyName='" + objmodel.CompanyName + "' data-productid='" + item.ProductId + "' class='clsRFQQuote' />";
                        if (!isMiniAdmin)
                        {
                            objmodel.Action = "<a href='javascript:void(0)' onclick='DeleteRFQQuote(\"" + item.Id + "\")'>Delete</a>";
                        }
                        model.Add(objmodel);
                    }
                    catch (Exception)
                    {
                        continue;
                    }
                }
                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.FullName != null && m.FullName.ToLower().Contains(searchValue))
                                        || (m.CompanyName != null && m.CompanyName.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.Email != null && m.Email.ToLower().Contains(searchValue))
                                        || (m.RFQDateText != null && m.RFQDateText.ToLower().Contains(searchValue))
                                        || (m.RequiredQty != null && m.RequiredQty.ToLower().Contains(searchValue))).ToList();
                }
                int? recordsTotal = model.Count;
                model = model.OrderByDescending(x => x.RFQDate).ThenBy(x => x.Email).ToList();
                var result = model.Skip(skip).Take(pageSize).ToList();
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = model });
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        [HttpPost]
        public ActionResult DeleteRFQQuoteData(int id)
        {
            try
            {
                var inv = db.SZ_Query.Where(x => x.Id == id).FirstOrDefault();
                if (inv != null)
                {
                    db.Entry(inv).State = EntityState.Deleted;
                    db.SaveChanges();
                }

                return Json(new { success = true }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new { success = false, message = ex.Message }, JsonRequestBehavior.AllowGet);
            }
        }

        public ActionResult DeleteSampleRequestDetail(int id)
        {
            try
            {
                int sampleId = 0;
                var inv = db.SZ_SampleRequestDetail.Where(x => x.Id == id).FirstOrDefault();
                if (inv != null)
                {
                    sampleId = inv.SampleRequestId;
                    db.Entry(inv).State = EntityState.Deleted;
                    db.SaveChanges();
                }

                return RedirectToAction("NewSampleRequest", new { id = sampleId });
            }
            catch (Exception ex)
            {
                return Json(new { success = false, message = ex.Message }, JsonRequestBehavior.AllowGet);

            }
        }

        public JsonResult LoadSynthesisLogData(bool issynthesispage = false)
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                int numberOfObjectsPerPage = Convert.ToInt32(Request.Form["length"]);
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int pageNo = 1;
                if (skip > 0)
                {
                    pageNo = (skip / numberOfObjectsPerPage) + 1;
                }
                var model = db.SynthesisLog(searchValue, pageNo, numberOfObjectsPerPage).ToList();
                int? recordsTotal = 0;
                if (model != null)
                {
                    recordsTotal = model.Select(x => x.TotalRecord).FirstOrDefault();
                }


                var data = PrepareSynthesisLogModel(model, true);
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        public string GetApiNameOfProduct(int productId, List<Product> productData)
        {
            return productData.Where(x => x.Id == productId).Select(x => x.MainCatName).FirstOrDefault();
        }

        public string GetApiNameOfProduct(int productId, List<Category> categoryData, List<Product_Category_Mapping> productCategoryData)
        {
            var data = (from i in categoryData
                        join pc in productCategoryData on i.Id equals pc.CategoryId
                        where i.Deleted == false && i.Published == true && pc.ProductId == productId
                        select i).FirstOrDefault();
            if (data == null)
                return "";

            if (data.ParentCategoryId == 0)
            {
                return data.Name;
            }
            return getSubCategoryName(data.ParentCategoryId, categoryData);
        }
        public List<string> GetApiAllProduct(int productId, List<Category> categoryData, List<Product_Category_Mapping> productCategoryData)
        {
            var data = (from i in categoryData
                        join pc in productCategoryData on i.Id equals pc.CategoryId
                        where i.Deleted == false && i.Published == true && pc.ProductId == productId
                        select i).FirstOrDefault();
            if (data == null)
                return null;

            var maincategoryId = 0;
            if (data.ParentCategoryId == 0)
            {
                maincategoryId = data.Id;
            }
            maincategoryId = getSubCategoryApiCategoryId(data.ParentCategoryId, categoryData);

            return GetProductsByMainCategoryId(maincategoryId);
        }
        public List<string> GetProductsByMainCategoryId(int mainCategoryId)
        {
            List<string> catNos = new List<string>();
            var data = (from i in db.Categories
                        where i.Deleted == false && i.Published == true && i.ParentCategoryId == mainCategoryId
                        select i).ToList();
            if (data.Count == 0)
                return null;

            foreach (var item in data)
            {
                var subcategorydata = GetProductsByMainCategoryId(item.Id);
                if (subcategorydata == null || subcategorydata.Count == 0)
                {
                    var products = GetProductsByCategoryId(item.Id);
                    if (products.Count > 0)
                    {
                        catNos.AddRange(products.Select(x => x.Sku).ToList());
                    }
                }
            }
            return catNos;
        }
        public List<Product> GetProductsByCategoryId(int categoryId)
        {
            return (from i in db.Product_Category_Mapping
                    join p in db.Products on i.ProductId equals p.Id
                    where i.CategoryId == categoryId && p.Published == true
                    && p.Deleted == false
                    select p).ToList();
        }
        public int getSubCategoryApiCategoryId(int parentCategoryId, List<Category> categoryData)
        {
            var data = (from i in categoryData
                        where i.Deleted == false && i.Published == true && i.Id == parentCategoryId
                        select i).FirstOrDefault();
            if (data == null)
                return 0;

            if (data.ParentCategoryId == 0)
            {
                return data.Id;
            }
            return getSubCategoryApiCategoryId(data.ParentCategoryId, categoryData);
        }

        public string getSubCategoryName(int parentCategoryId, List<Category> categoryData)
        {
            var data = (from i in categoryData
                        where i.Deleted == false && i.Published == true && i.Id == parentCategoryId
                        select i).FirstOrDefault();
            if (data == null)
                return "";

            if (data.ParentCategoryId == 0)
            {
                return data.Name;
            }
            return getSubCategoryName(data.ParentCategoryId, categoryData);
        }

        public ActionResult GetCOADataFromBatchId(int id)
        {
            var data = db.SZ_MasterCOA.Where(x => x.BatchId == id).FirstOrDefault();
            if (data != null)
            {
                var model = new SZ_MasterCOA();
                model.QuantityAvailable = data.QuantityAvailable;
                model.PhysicalState = data.PhysicalState;
                model.AppearanceProduct = data.AppearanceProduct;
                model.Attachment = data.Attachment;
                return Json(new { success = true, data = model }, JsonRequestBehavior.AllowGet);
            }
            return Json(new { success = false }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public ActionResult LoadQuoteNotification()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;

                string approvedstatus = Convert.ToString((int)EnumList.ApprovedStatus.QCApproved);

                var model = (from i in db.SZ_Quotation.AsNoTracking()
                             join ql in db.SZ_QuotationDetailLog.AsNoTracking() on i.Id equals ql.QuoteId
                             where i.CreatedBy == SessionCookieManagement.UserName
                             orderby i.CreatedDate descending
                             select new QuoteNotificationModel()
                             {
                                 Username = ql.Username,
                                 After = ql.After,
                                 Before = ql.Before,
                                 DDateTime = ql.Datetime,
                                 FieldName = ql.FieldName,
                                 QuoteId = i.Id,
                                 Ref = ql.QuoteRef
                             }).ToList();

                foreach (var item in model)
                {
                    item.DateTime = item.DDateTime.ToShortDateString();
                    item.QuoteLink = "<a href='/Form/Quote/" + item.QuoteId + "'>Action</a>";
                }

                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.Username != null && m.Username.ToLower().Contains(searchValue))
                                        || (m.After != null && m.After.ToLower().Contains(searchValue))
                                        || (m.Before != null && m.Before.ToLower().Contains(searchValue))
                                        || (m.DateTime != null && m.DateTime.ToLower().Contains(searchValue))
                                        || (m.FieldName != null && m.FieldName.ToLower().Contains(searchValue))
                                        ).ToList();
                }
                recordsTotal = model.Count();
                var data = model.Skip(skip).Take(pageSize).ToList();
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);
                throw ex;
            }
        }

        [HttpPost]
        public ActionResult LoadQCNewSubmissionData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                var fltapprovalstatus = Request.Form.GetValues("fltapprovalstatus").FirstOrDefault();
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;
                string approvedstatus = Convert.ToString((int)EnumList.ApprovedStatus.QCApproved);
                var queryData = db.SZ_QueryModule.AsQueryable();
                var model = (from i in db.SZ_QuoteDetailForm.AsNoTracking()
                             join t3 in db.SZ_QuoteDetails_Form.AsNoTracking() on i.Id equals t3.FormId
                             join q in db.SZ_QuotationDetail.AsNoTracking() on t3.QuoteDetailsId equals q.Id
                             where i.IsDraftEntry == true
                             && (i.ApprovalStatus == null || i.ApprovalStatus != approvedstatus)
                             && (i.IsDispatchedEntry == null || i.IsDispatchedEntry == false)
                             orderby i.CreatedDate descending
                             select new QCModel()
                             {
                                 IsConversionReport = q.SZ_Quotation.SZ_CompanyList.IsConversionReport,
                                 FormId = i.Id,
                                 QuoteDetailsId = i.QuotationDetailsId,
                                 ScientistName = i.TLName,
                                 Chemist = i.ScientistName,
                                 Diff = q.DifficultyLevel,
                                 ProductName = i.ProductName,
                                 CASNo = i.CASNo,
                                 CATNo = i.CATNo,
                                 Qty = i.Qty,
                                 SubmittedQty = q.RequiredQty,
                                 SubmissionDate = i.SubmissionDate,
                                 ReviewStatus = q.ReviewSciStatus,
                                 AssignDate = q.QCApprovedDate,
                                 BatchNo = i.BatchCode,
                                 DataRemark = q.Remark,
                                 AvailableData = i.RbAdditionalAnalysis,
                                 PhysicalState = i.State,
                                 Appearance = i.Apearance,
                                 Hygroscopic = i.ChkHygroscopic,
                                 TempSensitive = i.TempSensitive,
                                 Lacrymatory = i.Lacrymatory,
                                 LightSensitivity = i.LightSensitivity,
                                 Photostability = i.Photostability,
                                 StabilityRelatedComment = i.StabilityRelatedComment,
                                 Stability = i.Stability,
                                 SaltFreeBase = i.RbSaltMentionName,
                                 COA = "",
                                 HPLC = i.HPLCPurity,
                                 RbAdditionalAnalysis = i.RbAdditionalAnalysis,
                                 IRAttachment = i.IRAttachment,
                                 MassAttachment = i.MassAttachment,
                                 HPLCGCELSDAttachment = i.PLCAttachment,
                                 NMRAttachment = i.NMRAttchment,
                                 qNMRAttachment = i.QNMRAttchment,
                                 TGAAttachment = i.TGAAttachment,
                                 CMRAttachment = i.CMRAttchment,
                                 DEPTAttachment = i.DEPTAttachment,
                                 HRMSAttachment = i.HRMSAttachment,
                                 ROIAttachment = i.ROIAttachment,
                                 ElementalAttachment = i.ElementralAttachment,
                                 SERAttachment = i.SERAttachment,
                                 GCAttachment = i.GCAttachment,
                                 ELSDAttachment = i.ELSDAttachment,
                                 ChairalAttachment = i.ChiralAttachmenrt,
                                 APCIMassAttachment = i.APCIMassAttachment,
                                 NMRInterpretaionAttachment = i.NMRInterpretaionAttachment,
                                 ApprovedStatus = i.ApprovalStatus,
                                 ApprovedAs = q.ApprovedAs,
                                 ApprovalComments = q.ApprovalComment,
                                 RecommondationRetest = q.RecommendedPeriod,
                                 ProductId = q.ProductId,
                                 StabilityRT = i.SolidForm,
                                 StabilitySolution = i.SolutionForm,
                                 chkNMRDone = i.chkNMRDone,
                                 chkCrystallizationDone = i.chkCrystallizationDone,
                                 N1NMRAttachment = i.N1NmrAttachment,
                                 ChiralHPLCAttachment = i.ChiralHPLCAttachment,
                                 IsotropicpurityAttachment = i.IsotropicpurityAttachment,
                                 TwoDNMRAttachment = i.TwoDNMRAttachment,
                                 QCApprovedDate = i.QCApprovedDate,
                                 COSYAttachment = i.COSYAttachment,
                                 CHNSAttachment = i.CHNSAttachment,
                                 StabilitydataAttachment = i.StabilitydataAttachment,
                                 QuoteDetails = q
                             }).ToList();

                if (!string.IsNullOrEmpty(fltapprovalstatus))
                {
                    model = model.Where(x => x.ApprovedStatus == fltapprovalstatus).ToList();
                }

                model.ForEach(x =>
                {
                    x.ApprovedAsText = GetApproveStatusList(x.QuoteDetailsId, x.ApprovedStatus, true);
                });
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                         || (m.ApprovedAsText != null && m.ApprovedAsText.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        ).ToList();
                }

                recordsTotal = model.Count();
                //Paging
                MemoryCacheManager objCache = new MemoryCacheManager();

                var data = model.Skip(skip).Take(pageSize).ToList();
                //var categoryData = db.Categories.ToList();
                //var productCategoryData = db.Product_Category_Mapping.ToList();
                var productsData = objCache.Get("cache.productsdata", () =>
                {
                    return db.Products.Where(x => x.Published == true && x.Deleted == false).ToList();
                });
                foreach (var itemObj in data)
                {
                    if (!string.IsNullOrEmpty(itemObj.AvailableData))
                    {
                        itemObj.AvailableData = itemObj.AvailableData.Replace("APCI Mass", "Mass Interpretaion");
                    }
                    itemObj.N1NMRAttachment = (itemObj.N1NMRAttachment != null ? "<a href='" + itemObj.N1NMRAttachment.Replace("..", "") + "' download='N1NMRAttachment'><i class='fa fa-download'></i></a>" : "");
                    itemObj.GetAllBatch = "<i class='fa fa-clone' title='View Batch No' onclick='GetAllBatchNo(" + itemObj.ProductId + ", " + itemObj.QuoteDetailsId + ", true)'></i>";
                    if (!string.IsNullOrEmpty(itemObj.Diff))
                    {
                        foreach (EnumList.DifficultyLevel r in Enum.GetValues(typeof(EnumList.DifficultyLevel)))
                        {
                            var item = Enum.GetName(typeof(EnumList.DifficultyLevel), r);
                            var test = r.ToString();
                            string text = SZ_Helper.GetEnumDescription((EnumList.DifficultyLevel)(int)r);
                            int val = (int)r;
                            if (Convert.ToString(val) == itemObj.Diff)
                            {
                                itemObj.Diff = text;
                            }
                        }
                    }
                    if (itemObj.QCApprovedDate.HasValue)
                    {
                        itemObj.QCApprovedDateStr = itemObj.QCApprovedDate.Value.ToShortDateString();
                    }
                    if (itemObj.AssignDate.HasValue)
                    {
                        itemObj.AssignDatestr = itemObj.AssignDate.Value.ToShortDateString();
                    }
                    if (itemObj.SubmissionDate != null && itemObj.SubmissionDate.HasValue)
                    {
                        itemObj.SubmissionDatestr = itemObj.SubmissionDate.Value.ToShortDateString();
                    }
                    itemObj.APIName = GetApiNameOfProduct(itemObj.ProductId.Value, productsData);
                    itemObj.ApprovedStatusText = GetApproveStatusList(itemObj.QuoteDetailsId, itemObj.ApprovedStatus);
                    itemObj.ApprovedAsText = GetApprovedAsList(itemObj.QuoteDetailsId, itemObj.ApprovedAs);
                    itemObj.ApprovalCommentsText = "<i class='fa fa-pencil' onclick='approCommentGenerate(\"" + itemObj.QuoteDetailsId + "\")' ></i>";
                    if (string.IsNullOrEmpty(itemObj.RecommondationRetest))
                    {
                        itemObj.RecommondationRetest = "24";
                    }
                    itemObj.RecommondationRetestText = "<input type='number' id='recommondationretest_" + itemObj.QuoteDetailsId + "' name='recommondationretest_" + itemObj.QuoteDetailsId + "' value='" + itemObj.RecommondationRetest + "' />";
                    itemObj.IsLatinAmerica = itemObj.QuoteDetails.SZ_Quotation.SZ_CompanyList.GeographicalLocation == 1 ? true : false;

                    itemObj.ChkSaveRow = "";
                    if (itemObj.IsLatinAmerica)
                    {
                        itemObj.ChkSaveRow = "<img src='../images/Brazilian_flag_icon_round.png' height='16px' width='16px' />";
                    }
                    itemObj.ChkSaveRow += "<input type='checkbox' data-formid='" + itemObj.FormId + "' value='" + itemObj.QuoteDetailsId + "' class='clsSaverow' />";
                    if (itemObj.Hygroscopic.HasValue && itemObj.Hygroscopic.Value)
                    {
                        itemObj.TextHygroscopic = "<i class='fa fa-check'></i>";
                    }
                    else
                    {
                        itemObj.TextHygroscopic = "<i class='fa fa-close'></i>";
                    }

                    if (itemObj.TempSensitive.HasValue && itemObj.TempSensitive.Value)
                    {
                        itemObj.TextTempSensitive = "<i class='fa fa-check'></i>";
                    }
                    else
                    {
                        itemObj.TextTempSensitive = "<i class='fa fa-close'></i>";
                    }

                    if (itemObj.Lacrymatory.HasValue && itemObj.Lacrymatory.Value)
                    {
                        itemObj.TextLacrymatory = "<i class='fa fa-check'></i>";
                    }
                    else
                    {
                        itemObj.TextLacrymatory = "<i class='fa fa-close'></i>";
                    }

                    if (itemObj.Photostability.HasValue && itemObj.Photostability.Value)
                    {
                        itemObj.TextPhotostability = "<i class='fa fa-check'></i>";
                    }
                    else
                    {
                        itemObj.TextPhotostability = "<i class='fa fa-close'></i>";
                    }

                    if (itemObj.LightSensitivity.HasValue && itemObj.LightSensitivity.Value)
                    {
                        itemObj.TextLightSensitivity = "<i class='fa fa-check'></i>";
                    }
                    else
                    {
                        itemObj.TextLightSensitivity = "<i class='fa fa-close'></i>";
                    }
                    if (itemObj.SubmissionDate.HasValue)
                    {
                        itemObj.DraftSubmissionForm = itemObj.SubmissionDate.Value.ToShortDateString();
                    }

                    if (itemObj.chkNMRDone.HasValue && itemObj.chkNMRDone.Value)
                    {
                        itemObj.chkNMRDoneText = "<i class='fa fa-check'></i>";
                    }
                    else
                    {
                        itemObj.chkNMRDoneText = "<i class='fa fa-close'></i>";
                    }
                    if (itemObj.chkCrystallizationDone.HasValue && itemObj.chkCrystallizationDone.Value)
                    {
                        itemObj.chkCrystallizationDoneText = "<i class='fa fa-check'></i>";
                    }
                    else
                    {
                        itemObj.chkCrystallizationDoneText = "<i class='fa fa-close'></i>";
                    }

                    if (!string.IsNullOrEmpty(itemObj.RbAdditionalAnalysis))
                    {
                        itemObj.IR = itemObj.RbAdditionalAnalysis.Contains("IR") ? (itemObj.IRAttachment != null ? "<a href='" + itemObj.IRAttachment.ReplaceForFilepath() + "' download='IRAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.Mass = itemObj.RbAdditionalAnalysis.Contains("Mass") ? (itemObj.MassAttachment != null ? "<a href='" + itemObj.MassAttachment.Replace("..", "") + "' download='MassAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.HPLCGCELSD = itemObj.RbAdditionalAnalysis.Contains("HPLC/GC/ELSD") ? (itemObj.HPLCGCELSDAttachment != null ? "<a href='" + itemObj.HPLCGCELSDAttachment.Replace("..", "") + "' download='HPLCGCELSDAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.NMR = itemObj.RbAdditionalAnalysis.Contains("NMR") ? (itemObj.NMRAttachment != null ? "<a href='" + itemObj.NMRAttachment.Replace("..", "") + "' download='NMRAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.qNMR = itemObj.RbAdditionalAnalysis.Contains("qNMR") ? (itemObj.qNMRAttachment != null ? "<a href='" + itemObj.qNMRAttachment.Replace("..", "") + "' download='qNMRAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.TGA = itemObj.RbAdditionalAnalysis.Contains("TGA") ? (itemObj.TGAAttachment != null ? "<a href='" + itemObj.TGAAttachment.Replace("..", "") + "' download='TGAAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.CMR = itemObj.RbAdditionalAnalysis.Contains("CMR") ? (itemObj.CMRAttachment != null ? "<a href='" + itemObj.CMRAttachment.Replace("..", "") + "' download='CMRAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.DEPT = itemObj.RbAdditionalAnalysis.Contains("DEPT") ? (itemObj.DEPTAttachment != null ? "<a href='" + itemObj.DEPTAttachment.Replace("..", "") + "' download='DEPTAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.HRMS = itemObj.RbAdditionalAnalysis.Contains("HRMS") ? (itemObj.HRMSAttachment != null ? "<a href='" + itemObj.HRMSAttachment.Replace("..", "") + "' download='HRMSAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.ROI = itemObj.RbAdditionalAnalysis.Contains("ROI") ? (itemObj.ROIAttachment != null ? "<a href='" + itemObj.ROIAttachment.Replace("..", "") + "' download='ROIAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.Elemental = itemObj.RbAdditionalAnalysis.Contains("Elemental") ? (itemObj.ElementalAttachment != null ? "<a href='" + itemObj.ElementalAttachment.Replace("..", "") + "' download='ElementalAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.SER = itemObj.RbAdditionalAnalysis.Contains("CMR Interpretaion") ? (itemObj.SERAttachment != null ? "<a href='" + itemObj.SERAttachment.Replace("..", "") + "' download='SERAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.APCIMass = itemObj.RbAdditionalAnalysis.Contains("APCI Mass") ? (itemObj.APCIMassAttachment != null ? "<a href='" + itemObj.APCIMassAttachment.Replace("..", "") + "' download='APCIMassAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.NMRInterpretaion = itemObj.RbAdditionalAnalysis.Contains("NMR Interpretaion") ? (itemObj.NMRInterpretaionAttachment != null ? "<a href='" + itemObj.NMRInterpretaionAttachment.Replace("..", "") + "' download='NMRInterpretaionAttachment'><i class='fa fa-download'></i></a>" : "") : "";

                        itemObj.TwoDNmr = itemObj.RbAdditionalAnalysis.Contains("2D NMR") ? (itemObj.TwoDNMRAttachment != null ? "<a href='" + itemObj.TwoDNMRAttachment.Replace("..", "") + "' download='TwoDNMRAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.COSY = itemObj.RbAdditionalAnalysis.Contains("COSY") ? (itemObj.COSYAttachment != null ? "<a href='" + itemObj.COSYAttachment.Replace("..", "") + "' download='COSYAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.CHNS = itemObj.RbAdditionalAnalysis.Contains("CHNS") ? (itemObj.CHNSAttachment != null ? "<a href='" + itemObj.CHNSAttachment.Replace("..", "") + "' download='CHNSAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.Stabilitydata = itemObj.RbAdditionalAnalysis.Contains("Stability Data") ? (itemObj.StabilitydataAttachment != null ? "<a href='" + itemObj.StabilitydataAttachment.Replace("..", "") + "' download='StabilitydataAttachment'><i class='fa fa-download'></i></a>" : "") : "";

                        itemObj.ChemDrawFile = !string.IsNullOrEmpty(itemObj.ChemdrawFileAttachment) ? "<a href='javascript:void(0)' onclick='DownloadChemDraw(" + itemObj.FormId + ")'><i class='fa fa-download'></i></a>" : "";
                    }
                    var pName = "";
                    var query = queryData.Where(x => x.CATNo.Trim().ToLower() == itemObj.CATNo.Trim().ToLower()).OrderByDescending(x => x.Id).ToList();
                    if (query != null && query.Count() > 0)
                    {
                        var qlist = query.Select(x => x.QueryNo).ToArray();
                        if (query.Select(x => x.Status.ToLower()).FirstOrDefault() == "solved" ||
                             query.Select(x => x.Status.ToLower()).FirstOrDefault() == "close" ||
                             query.Select(x => x.Status.ToLower()).FirstOrDefault() == "completed")
                        {
                            pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + itemObj.CATNo + "\")' title='" + string.Join(", ", qlist) + "' style ='float:right; color: green' ></i>";
                        }
                        else
                        {
                            pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + itemObj.CATNo + "\")' title='" + string.Join(", ", qlist) + "' style ='float:right' ></i>";
                        }
                    }

                    var impstr = "";
                    if (itemObj.IsConversionReport.HasValue && itemObj.IsConversionReport.Value)
                    {
                        impstr += "<img src='/img/important.jpg' width='15px' height='15px' />";
                    }

                    itemObj.CATNo = pName + "" + "<a href='https://www.synzeal.com/search?q=" + itemObj.CATNo + "' target='_blank'>" + itemObj.CATNo + "</a>" + "" + impstr + " " + CommonOperation.GetMatchingTagHTML(itemObj.QuoteDetails, "QC");
                    itemObj.QuoteDetails = null;
                }
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);
                throw ex;
            }
        }
        public string GetApproveStatusList(int QuoteDetailsId, string approvedstatus, bool isTextReturned = false)
        {
            var stringtext = "";
            var str = "<select id='approvestatus_" + QuoteDetailsId + "' class='clsappropro'><option value=''>--Select--</option>";
            foreach (EnumList.ApprovedStatus r in Enum.GetValues(typeof(EnumList.ApprovedStatus)))
            {
                var item = Enum.GetName(typeof(EnumList.ApprovedStatus), r);
                var test = r.ToString();
                string text = SZ_Helper.GetEnumDescription((EnumList.ApprovedStatus)(int)r);
                int val = (int)r;
                string selected = "";
                if (Convert.ToString(val) == approvedstatus)
                {
                    stringtext = text;
                    selected = "selected ";
                }
                str += "<option value='" + val + "' " + selected + ">" + text + "</option>";

            }
            str += "</select>";
            if (isTextReturned)
            {
                return stringtext;
            }
            return str;
        }
        public string GetApprovedAsList(int QuoteDetailsId, string approvedas)
        {
            var str = "<select id='approveas_" + QuoteDetailsId + "' class='clsapproas'><option value=''>--Select--</option>";
            foreach (EnumList.ApprovedAs r in Enum.GetValues(typeof(EnumList.ApprovedAs)))
            {
                var item = Enum.GetName(typeof(EnumList.ApprovedAs), r);
                var test = r.ToString();
                string text = SZ_Helper.GetEnumDescription((EnumList.ApprovedAs)(int)r);
                int val = (int)r;
                string selected = "";
                if (Convert.ToString(val) == approvedas)
                {
                    selected = "selected ";
                }
                str += "<option value='" + val + "' " + selected + ">" + text + "</option>";

            }
            str += "</select>";

            return str;
        }

        [HttpPost]
        public ActionResult LoadQCDispatchedInstockData()
        {
            try
            {
                string approvedstatus = Convert.ToString((int)EnumList.ApprovedStatus.QCApproved);
                string approvalstatus = Convert.ToString((int)EnumList.ApprovedStatus.QCApproval);
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;
                string instockProjectType = Convert.ToString((int)EnumList.ProjectType.InStock);
                string qcapprovalProStatus = Convert.ToString((int)EnumList.ProStatusDDL.QCApproval);

                var model = (from quo in db.SZ_Quotation.AsNoTracking()
                             join q in db.SZ_QuotationDetail.AsNoTracking() on quo.Id equals q.QuoteId
                             join i in db.SZ_MasterCOA on q.AdditionalBatchNo equals i.BatchId
                             join l in db.SZ_QuotationDetailLog.AsNoTracking() on q.Id equals l.QuoteDetailsId
                             where q.MoveToProject == true
                             && ((string.IsNullOrEmpty(l.Before) && l.After == "In-Stock") || (l.Before == "No Action" && l.After == "In-Stock"))
                             && l.FieldName == "Project Type"
                             && (q.ScientistCustomerId == null)
                             && q.ProjectType == instockProjectType
                             && q.IsDispatchApprove == true
                             && q.ProStatus == qcapprovalProStatus
                             && (q.IsOnHold == false || q.IsOnHold == null)
                             && quo.CountryTypeId == 1
                             && (q.MoveToDispatch == null || q.MoveToDispatch == false)
                             && (q.MoveToInvoice == null || q.MoveToInvoice == false)
                             //where (q.MoveToProject == true) && string.IsNullOrEmpty(q.TrackingNo)
                             //&& (q.IsOnHold == false || q.IsOnHold == null)
                             //&& (q.ProjectType == instockProjectType)
                             //&& quo.CountryType == "Domestic"
                             //&& (q.ApprovalStatus != approvedstatus || q.ApprovalStatus == null || q.ApprovalStatus == approvalstatus)
                             //&& q.MoveToProject == true
                             //&& (q.MoveToDispatch == null || q.MoveToDispatch == false)
                             //&& (q.MoveToInvoice == null || q.MoveToInvoice == false)
                             //&& ((string.IsNullOrEmpty(l.Before) && l.After == "In-Stock") || (l.Before == "No Action" && l.After == "In-Stock"))
                             //&& l.FieldName == "Project Type"
                             orderby q.CreatedDate descending
                             select new QCModel()
                             {
                                 QuoteDetails = q,
                                 FormId = i.Id,
                                 QuoteDetailsId = q.Id,
                                 ScientistName = i.CreatedBy,
                                 Chemist = "",
                                 Diff = q.DifficultyLevel,
                                 ProductName = i.ProductName,
                                 CASNo = i.CASNo,
                                 CATNo = i.CATNo,
                                 Qty = i.QuantityAvailable,
                                 SubmittedQty = q.RequiredQty,
                                 SubmissionDate = i.CreatedDate.Value,
                                 ReviewStatus = q.ReviewSciStatus,
                                 AssignDate = q.MoveToScientistDate,
                                 AdditionalBatchNo = q.AdditionalBatchNo,
                                 ProductId = q.ProductId,
                                 DataRemark = q.Remark,
                                 DraftSubmissionForm = "",
                                 RbAdditionalAnalysis = i.Attachment,
                                 AvailableData = i.Attachment,
                                 PhysicalState = i.PhysicalState,
                                 Appearance = i.AppearanceProduct,
                                 COA = "",
                                 ApprovedStatus = q.ApprovalStatus,
                                 ApprovedAs = q.ApprovedAs,
                                 ApprovalComments = q.ApprovalComment,
                                 RecommondationRetest = q.RecommendedPeriod,
                                 QCApprovedDate = q.QCApprovedDate
                             }).ToList();
                model.ForEach(x =>
                {
                    x.ApprovedAsText = GetApproveStatusList(x.QuoteDetailsId, x.ApprovedStatus, true);
                });
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.ApprovedAsText != null && m.ApprovedAsText.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        ).ToList();
                }

                //total number of rows count   
                recordsTotal = model.Count();
                //Paging   
                var data = model.Skip(skip).Take(pageSize).ToList();
                //var categoryData = db.Categories.ToList();
                //var productCategoryData = db.Product_Category_Mapping.ToList();
                var proIds = data.Select(x => x.ProductId).Distinct().ToList();
                MemoryCacheManager objCache = new MemoryCacheManager();

                var queryData = objCache.Get("cache.queryData", () =>
                {
                    return db.SZ_QueryModule.AsNoTracking().ToList();
                });

                var inventoryData = db.SZ_Inventory.Where(x => proIds.Contains(x.ProductId)).ToList();
                var productsData = db.Products.Where(x => proIds.Contains(x.Id) && x.Published == true && x.Deleted == false).ToList();
                foreach (var itemObj in data)
                {
                    itemObj.GetAllBatch = "<i class='fa fa-clone' title='View Batch No' onclick='GetAllBatchNo(" + itemObj.ProductId + ", " + itemObj.QuoteDetailsId + ")'></i>";
                    if (itemObj.QCApprovedDate.HasValue)
                    {
                        itemObj.QCApprovedDateStr = itemObj.QCApprovedDate.Value.ToShortDateString();
                    }
                    if (!string.IsNullOrEmpty(itemObj.Diff))
                    {
                        foreach (EnumList.DifficultyLevel r in Enum.GetValues(typeof(EnumList.DifficultyLevel)))
                        {
                            var item = Enum.GetName(typeof(EnumList.DifficultyLevel), r);
                            var test = r.ToString();
                            string text = SZ_Helper.GetEnumDescription((EnumList.DifficultyLevel)(int)r);
                            int val = (int)r;
                            if (Convert.ToString(val) == itemObj.Diff)
                            {
                                itemObj.Diff = text;
                            }
                        }
                    }
                    itemObj.AdditionalBatchNoText = "<select id='additionalBatch_" + itemObj.QuoteDetailsId + "' data-quotationdetailsid='" + itemObj.QuoteDetailsId + "' class='dddladditionalbatch'><option value=''>--Select--</option>";
                    if (itemObj.ProductId.HasValue)
                    {
                        var proData = productsData.Where(x => x.Id == itemObj.ProductId).Count();
                        var proBatchData = inventoryData.Where(x => x.ProductId == itemObj.ProductId).ToList();
                        if (proBatchData.Count > 0 && proData > 0)
                        {
                            proBatchData.ForEach(r =>
                            {
                                //var qty = System.Text.RegularExpressions.Regex.Match(Convert.ToString(r.Qty), @"\d+").Value;
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }
                                string selected = string.Empty;
                                if (r.Id == itemObj.AdditionalBatchNo)
                                {
                                    selected = "selected ";
                                    itemObj.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
                                }

                                itemObj.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' " + selected + ">" + text + "</option>";
                            });
                        }
                    }
                    itemObj.AdditionalBatchNoText += "</select>";
                    if (itemObj.AssignDate.HasValue)
                    {
                        itemObj.AssignDatestr = itemObj.AssignDate.Value.ToShortDateString();
                    }
                    if (itemObj.SubmissionDate != null && itemObj.SubmissionDate.HasValue)
                    {
                        itemObj.SubmissionDatestr = itemObj.SubmissionDate.Value.ToShortDateString();
                    }
                    itemObj.APIName = GetApiNameOfProduct(itemObj.ProductId.Value, productsData);
                    itemObj.ApprovedStatusText = GetApproveStatusList(itemObj.QuoteDetailsId, itemObj.ApprovedStatus);
                    itemObj.ApprovedAsText = GetApprovedAsList(itemObj.QuoteDetailsId, itemObj.ApprovedAs);
                    itemObj.ApprovalCommentsText = "<i class='fa fa-pencil' onclick='approCommentGenerate(\"" + itemObj.QuoteDetailsId + "\")' ></i>";
                    itemObj.RecommondationRetestText = "<input type='number' id='recommondationretest_" + itemObj.QuoteDetailsId + "' name='recommondationretest_" + itemObj.QuoteDetailsId + "' value='" + itemObj.RecommondationRetest + "' />";
                    itemObj.IsLatinAmerica = itemObj.QuoteDetails.SZ_Quotation.SZ_CompanyList.GeographicalLocation == 1 ? true : false;
                    itemObj.ChkSaveRow = "";
                    if (itemObj.IsLatinAmerica)
                    {
                        itemObj.ChkSaveRow = "<img src='../images/Brazilian_flag_icon_round.png' height='16px' width='16px' />";
                    }
                    itemObj.ChkSaveRow += "<input type='checkbox' value='" + itemObj.QuoteDetailsId + "' class='clsSaverow' />";
                    if (!string.IsNullOrEmpty(itemObj.RbAdditionalAnalysis))
                    {
                        itemObj.IR = itemObj.RbAdditionalAnalysis.Contains("IR") ? "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                        itemObj.Mass = itemObj.RbAdditionalAnalysis.Contains("Mass") ? "<i id='mass_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                        itemObj.HPLCGCELSD = itemObj.RbAdditionalAnalysis.Contains("HPLC/GC/ELSD") ? "<i id='hplc_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                        itemObj.NMR = itemObj.RbAdditionalAnalysis.Contains("NMR") ? "<i id='nmr_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                        itemObj.qNMR = itemObj.RbAdditionalAnalysis.Contains("qNMR") ? "<i id='qnmr_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                        itemObj.TGA = itemObj.RbAdditionalAnalysis.Contains("TGA") ? "<i id='tga_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                        itemObj.CMR = itemObj.RbAdditionalAnalysis.Contains("CMR") ? "<i id='cmr_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                        itemObj.DEPT = itemObj.RbAdditionalAnalysis.Contains("DEPT") ? "<i id='dept_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                        itemObj.HRMS = itemObj.RbAdditionalAnalysis.Contains("HRMS") ? "<i id='hrms_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                        itemObj.ROI = itemObj.RbAdditionalAnalysis.Contains("ROI") ? "<i id='roi_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                        itemObj.Elemental = itemObj.RbAdditionalAnalysis.Contains("Elemental") ? "<i id='elementral_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                        itemObj.SER = itemObj.RbAdditionalAnalysis.Contains("CMR Interpretaion") ? "<i id='ser_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                        itemObj.APCIMass = itemObj.RbAdditionalAnalysis.Contains("APCI Mass") ? "<i id='apcimass_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='apcimass_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                        itemObj.NMRInterpretaion = itemObj.RbAdditionalAnalysis.Contains("NMR Interpretaion") ? "<i id='nmrinterpretaion_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='nmrinterpretaion_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                    }

                    if (itemObj.Hygroscopic.HasValue && itemObj.Hygroscopic.Value)
                    {
                        itemObj.TextHygroscopic = "<i class='fa fa-check'></i>";
                    }
                    else
                    {
                        itemObj.TextHygroscopic = "<i class='fa fa-close'></i>";
                    }
                    if (itemObj.TempSensitive.HasValue && itemObj.TempSensitive.Value)
                    {
                        itemObj.TextTempSensitive = "<i class='fa fa-check'></i>";
                    }
                    else
                    {
                        itemObj.TextTempSensitive = "<i class='fa fa-close'></i>";
                    }

                    if (itemObj.Lacrymatory.HasValue && itemObj.Lacrymatory.Value)
                    {
                        itemObj.TextLacrymatory = "<i class='fa fa-check'></i>";
                    }
                    else
                    {
                        itemObj.TextLacrymatory = "<i class='fa fa-close'></i>";
                    }
                    if (itemObj.SubmissionDate.HasValue)
                    {
                        itemObj.DraftSubmissionForm = itemObj.SubmissionDate.Value.ToShortDateString();
                    }
                    itemObj.Qty = "<span id='availableqty_" + itemObj.QuoteDetailsId + "'>" + itemObj.Qty + "</span>";
                    itemObj.AvailableData = "<span id='availabledata_" + itemObj.QuoteDetailsId + "'>" + itemObj.AvailableData + "</span>";
                    itemObj.PhysicalState = "<span id='physicalstate_" + itemObj.QuoteDetailsId + "'>" + itemObj.PhysicalState + "</span>";
                    itemObj.Appearance = "<span id='appearance_" + itemObj.QuoteDetailsId + "'>" + itemObj.Appearance + "</span>";
                    var pName = "";
                    var query = queryData.Where(x => x.CATNo.Trim().ToLower() == itemObj.CATNo.Trim().ToLower()).OrderByDescending(x => x.Id);
                    if (query != null && query.Count() > 0)
                    {
                        var qlist = query.Select(x => x.QueryNo).ToArray();
                        if (query.Select(x => x.Status.ToLower()).FirstOrDefault() == "solved" ||
                     query.Select(x => x.Status.ToLower()).FirstOrDefault() == "close" ||
                                     query.Select(x => x.Status.ToLower()).FirstOrDefault() == "completed")
                        {
                            pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + itemObj.CATNo + "\")' title='" + string.Join(", ", qlist) + "' style ='float:right; color: green' ></i>";
                        }
                        else
                        {
                            pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + itemObj.CATNo + "\")' title='" + string.Join(", ", qlist) + "' style ='float:right' ></i>";
                        }
                    }
                    itemObj.IsConversionReport = itemObj.QuoteDetails.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    var impstr = "";
                    if (itemObj.IsConversionReport.HasValue && itemObj.IsConversionReport.Value)
                    {
                        impstr += "<img src='/img/important.jpg' width='15px' height='15px' />";
                    }

                    itemObj.CATNo = pName + "" + "<a href='https://www.synzeal.com/search?q=" + itemObj.CATNo + "' target='_blank'>" + itemObj.CATNo + "</a>" + "" + impstr + "" + CommonOperation.GetMatchingTagHTML(itemObj.QuoteDetails, "QC");
                }

                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);
                throw ex;
            }
        }

        [HttpPost]
        public ActionResult LoadQCWorkingStandardData()
        {
            try
            {
                string approvedstatus = Convert.ToString((int)EnumList.ApprovedStatus.QCApproved);

                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();

                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;
                var model = (from q in db.SZ_QuotationDetail.AsNoTracking()
                             join id in db.SZ_Inventory.AsNoTracking() on q.AdditionalBatchNo equals id.Id into pss
                             from id in pss.DefaultIfEmpty()
                             join i in db.SZ_MasterCOA.AsNoTracking() on id.Id equals i.BatchId into ps
                             from i in ps.DefaultIfEmpty()
                             where q.IsQC == true && (q.ApprovalStatus != approvedstatus || q.ApprovalStatus == null)
                             orderby q.CreatedDate descending
                             select new QCModel()
                             {
                                 FormId = i != null ? i.Id : 0,
                                 QuoteDetailsId = q.Id,
                                 QuoteRefNo = q.SZ_Quotation.Ref,
                                 ScientistName = "",
                                 Chemist = "",
                                 Diff = q.DifficultyLevel,
                                 ProductName = q.ProductName,
                                 CASNo = q.CASNo,
                                 CATNo = q.CATNo,
                                 Qty = "",
                                 SubmittedQty = q.RequiredQty,
                                 SubmissionDate = i != null ? i.CreatedDate : (DateTime?)null,
                                 ReviewStatus = q.ReviewSciStatus,
                                 AssignDate = q.MoveToScientistDate,
                                 DataRemark = q.Remark,
                                 DraftSubmissionForm = "",
                                 AvailableData = i != null ? i.Attachment : "",
                                 PhysicalState = i != null ? i.PhysicalState : "",
                                 Appearance = i != null ? i.AppearanceProduct : "",
                                 Hygroscopic = false,
                                 TempSensitive = false,
                                 Lacrymatory = false,
                                 COA = "",
                                 HPLC = "",
                                 RbAdditionalAnalysis = i != null ? i.Attachment : "",
                                 ApprovedStatus = q.ApprovalStatus,
                                 ApprovedAs = q.ApprovedAs,
                                 ApprovalComments = q.ApprovalComment,
                                 PrimaryStdOrdered = q.PrimaryStdOrdered,
                                 ColumnOrder = q.ColumnOrder,
                                 SystemSuitability = q.SystemSuitability,
                                 RecommondationRetest = q.RecommendedPeriod,
                                 ProductId = q.ProductId,
                                 QCApprovedDate = q.QCApprovedDate
                             }).ToList();
                model.ForEach(x =>
                {
                    x.ApprovedAsText = GetApproveStatusList(x.QuoteDetailsId, x.ApprovedStatus, true);
                });
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                         || (m.ApprovedAsText != null && m.ApprovedAsText.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        ).ToList();
                }

                //total number of rows count   
                recordsTotal = model.Count();
                //Paging   
                MemoryCacheManager objCache = new MemoryCacheManager();

                var queryData = objCache.Get("cache.queryData", () =>
                {
                    return db.SZ_QueryModule.AsNoTracking().ToList();
                });

                var data = model.Skip(skip).Take(pageSize).ToList();
                //var categoryData = db.Categories.ToList();
                //var productCategoryData = db.Product_Category_Mapping.ToList();
                var proIds = data.Select(x => x.ProductId).Distinct().ToList();
                var inventoryData = db.SZ_Inventory.Where(x => proIds.Contains(x.ProductId)).ToList();
                var productsData = db.Products.Where(x => proIds.Contains(x.Id) && x.Published == true && x.Deleted == false).ToList();
                foreach (var itemObj in data)
                {
                    itemObj.GetAllBatch = "<i class='fa fa-clone' title='View Batch No' onclick='GetAllBatchNo(" + itemObj.ProductId + ", " + itemObj.QuoteDetailsId + ")'></i>";
                    if (!string.IsNullOrEmpty(itemObj.Diff))
                    {
                        foreach (EnumList.DifficultyLevel r in Enum.GetValues(typeof(EnumList.DifficultyLevel)))
                        {
                            var item = Enum.GetName(typeof(EnumList.DifficultyLevel), r);
                            var test = r.ToString();
                            string text = SZ_Helper.GetEnumDescription((EnumList.DifficultyLevel)(int)r);
                            int val = (int)r;
                            if (Convert.ToString(val) == itemObj.Diff)
                            {
                                itemObj.Diff = text;
                            }
                        }
                    }
                    itemObj.AdditionalBatchNoText = "<select id='additionalBatch_" + itemObj.QuoteDetailsId + "' data-quotationdetailsid='" + itemObj.QuoteDetailsId + "' class='dddladditionalbatch'><option value=''>--Select--</option>";
                    if (itemObj.ProductId.HasValue)
                    {
                        var proData = productsData.Where(x => x.Id == itemObj.ProductId).Count();
                        var proBatchData = inventoryData.Where(x => x.ProductId == itemObj.ProductId).ToList();
                        if (proBatchData.Count > 0 && proData > 0)
                        {
                            proBatchData.ForEach(r =>
                            {
                                //var qty = System.Text.RegularExpressions.Regex.Match(Convert.ToString(r.Qty), @"\d+").Value;
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }
                                string selected = string.Empty;
                                if (r.Id == itemObj.AdditionalBatchNo)
                                {
                                    selected = "selected ";
                                    itemObj.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
                                }

                                itemObj.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' " + selected + ">" + text + "</option>";
                            });
                        }
                    }
                    if (itemObj.QCApprovedDate.HasValue)
                    {
                        itemObj.QCApprovedDateStr = itemObj.QCApprovedDate.Value.ToShortDateString();
                    }
                    if (itemObj.AssignDate.HasValue)
                    {
                        itemObj.AssignDatestr = itemObj.AssignDate.Value.ToShortDateString();
                    }
                    if (itemObj.SubmissionDate != null && itemObj.SubmissionDate.HasValue)
                    {
                        itemObj.SubmissionDatestr = itemObj.SubmissionDate.Value.ToShortDateString();
                    }
                    itemObj.APIName = GetApiNameOfProduct(itemObj.ProductId.Value, productsData);
                    itemObj.ApprovedStatusText = GetApproveStatusList(itemObj.QuoteDetailsId, itemObj.ApprovedStatus);
                    itemObj.ApprovedAsText = GetApprovedAsList(itemObj.QuoteDetailsId, itemObj.ApprovedAs);
                    itemObj.ApprovalCommentsText = "<i class='fa fa-pencil' onclick='approCommentGenerate(\"" + itemObj.QuoteDetailsId + "\")' ></i>";
                    itemObj.RecommondationRetestText = "<input type='number' id='recommondationretest_" + itemObj.QuoteDetailsId + "' name='recommondationretest_" + itemObj.QuoteDetailsId + "' value='" + itemObj.RecommondationRetest + "' />";
                    itemObj.ChkSaveRow = "<input type='checkbox' value='" + itemObj.QuoteDetailsId + "' class='clsSaverow' />";
                    itemObj.IR = itemObj.RbAdditionalAnalysis.Contains("IR") ? "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                    itemObj.Mass = itemObj.RbAdditionalAnalysis.Contains("Mass") ? "<i id='mass_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                    itemObj.HPLCGCELSD = itemObj.RbAdditionalAnalysis.Contains("HPLC/GC/ELSD") ? "<i id='hplc_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                    itemObj.NMR = itemObj.RbAdditionalAnalysis.Contains("NMR") ? "<i id='nmr_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                    itemObj.qNMR = itemObj.RbAdditionalAnalysis.Contains("qNMR") ? "<i id='qnmr_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                    itemObj.TGA = itemObj.RbAdditionalAnalysis.Contains("TGA") ? "<i id='tga_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                    itemObj.CMR = itemObj.RbAdditionalAnalysis.Contains("CMR") ? "<i id='cmr_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                    itemObj.DEPT = itemObj.RbAdditionalAnalysis.Contains("DEPT") ? "<i id='dept_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                    itemObj.HRMS = itemObj.RbAdditionalAnalysis.Contains("HRMS") ? "<i id='hrms_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                    itemObj.ROI = itemObj.RbAdditionalAnalysis.Contains("ROI") ? "<i id='roi_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                    itemObj.Elemental = itemObj.RbAdditionalAnalysis.Contains("Elemental") ? "<i id='elementral_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                    itemObj.SER = itemObj.RbAdditionalAnalysis.Contains("CMR Interpretaion") ? "<i id='ser_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                    itemObj.APCIMass = itemObj.RbAdditionalAnalysis.Contains("APCI Mass") ? "<i id='apcimass_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='apcimass_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                    itemObj.NMRInterpretaion = itemObj.RbAdditionalAnalysis.Contains("NMR Interpretaion") ? "<i id='nmrinterpretaion_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='nmrinterpretaion_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                    if (itemObj.Hygroscopic.HasValue && itemObj.Hygroscopic.Value)
                    {
                        itemObj.TextHygroscopic = "<i class='fa fa-check'></i>";
                    }
                    else
                    {
                        itemObj.TextHygroscopic = "<i class='fa fa-close'></i>";
                    }
                    if (itemObj.TempSensitive.HasValue && itemObj.TempSensitive.Value)
                    {
                        itemObj.TextTempSensitive = "<i class='fa fa-check'></i>";
                    }
                    else
                    {
                        itemObj.TextTempSensitive = "<i class='fa fa-close'></i>";
                    }

                    if (itemObj.Lacrymatory.HasValue && itemObj.Lacrymatory.Value)
                    {
                        itemObj.TextLacrymatory = "<i class='fa fa-check'></i>";
                    }
                    else
                    {
                        itemObj.TextLacrymatory = "<i class='fa fa-close'></i>";
                    }
                    itemObj.PrimaryStdOrderedText = "<input type='text' id='PrimaryStdOrdered_" + itemObj.QuoteDetailsId + "' name='PrimaryStdOrdered_" + itemObj.QuoteDetailsId + "' value='" + itemObj.PrimaryStdOrdered + "' />";
                    itemObj.ColumnOrderText = "<input type='text' id='ColumnOrder_" + itemObj.QuoteDetailsId + "' name='ColumnOrder_" + itemObj.QuoteDetailsId + "' value='" + itemObj.ColumnOrder + "' />";
                    itemObj.SystemSuitabilityText = "<input type='text' id='SystemSuitability_" + itemObj.QuoteDetailsId + "' name='SystemSuitability_" + itemObj.QuoteDetailsId + "' value='" + itemObj.SystemSuitability + "' />";
                    if (itemObj.SubmissionDate.HasValue)
                    {
                        itemObj.DraftSubmissionForm = itemObj.SubmissionDate.Value.ToShortDateString();
                    }
                    itemObj.Qty = "<span id='availableqty_" + itemObj.QuoteDetailsId + "'>" + itemObj.Qty + "</span>";

                    itemObj.AvailableData = "<span id='availabledata_" + itemObj.QuoteDetailsId + "'>" + itemObj.AvailableData + "</span>";
                    itemObj.PhysicalState = "<span id='physicalstate_" + itemObj.QuoteDetailsId + "'>" + itemObj.PhysicalState + "</span>";
                    itemObj.Appearance = "<span id='appearance_" + itemObj.QuoteDetailsId + "'>" + itemObj.Appearance + "</span>";
                    var pName = "";
                    var query = queryData.Where(x => x.CATNo.Trim().ToLower() == itemObj.CATNo.Trim().ToLower()).OrderByDescending(x => x.Id);
                    if (query != null && query.Count() > 0)
                    {
                        var qlist = query.Select(x => x.QueryNo).ToArray();
                        if (query.Select(x => x.Status.ToLower()).FirstOrDefault() == "solved" ||
                     query.Select(x => x.Status.ToLower()).FirstOrDefault() == "close" ||
                                     query.Select(x => x.Status.ToLower()).FirstOrDefault() == "completed")
                        {
                            pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + itemObj.CATNo + "\")' title='" + string.Join(", ", qlist) + "' style ='float:right; color: green' ></i>";
                        }
                        else
                        {
                            pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + itemObj.CATNo + "\")' title='" + string.Join(", ", qlist) + "' style ='float:right' ></i>";
                        }
                    }
                    itemObj.CATNo = pName + "" + "<a href='https://www.synzeal.com/search?q=" + itemObj.CATNo + "' target='_blank'>" + itemObj.CATNo + "</a>";
                }

                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }
        }

        [HttpPost]
        public ActionResult LoadQCInventoryData()
        {
            try
            {
                string approvedstatus = Convert.ToString((int)EnumList.ApprovedStatus.QCApproved);
                MemoryCacheManager objCache = new MemoryCacheManager();

                string ProjectType = Convert.ToString((int)EnumList.ProjectType.Purchase);
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                var fltapprovalstatus = Request.Form.GetValues("fltapprovalstatus").FirstOrDefault();
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;
                var queryData = objCache.Get("cache.queryData", () =>
                {
                    return db.SZ_QueryModule.AsNoTracking().ToList();
                });

                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.Purchase);
                string pursynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
                // Getting all Customer data  
                var model = (from q in db.SZ_QuotationDetail.AsNoTracking()
                             join t3 in db.SZ_QuoteDetails_Form.AsNoTracking() on q.Id equals t3.QuoteDetailsId
                             join i in db.SZ_QuoteDetailForm.AsNoTracking() on t3.FormId equals i.Id
                             where (i.ApprovalStatus != approvedstatus || i.ApprovalStatus == null)
                             && i.IsDispatchedEntry == true
                             orderby i.CreatedDate descending
                             select new QCModel()
                             {
                                 QuoteDetails = q,
                                 FormId = i != null ? i.Id : 0,
                                 QuoteDetailsId = q.Id,
                                 ScientistName = i != null ? i.TLName : "",
                                 Chemist = i != null ? i.ScientistName : "",
                                 Diff = q.DifficultyLevel,
                                 ProductName = q.ProductName,
                                 CASNo = q.CASNo,
                                 CATNo = q.CATNo,
                                 Qty = i != null ? i.Qty : "",
                                 SubmittedQty = q.RequiredQty,
                                 SubmissionDate = i != null ? i.SubmissionDate : (DateTime?)null,
                                 ReviewStatus = q.ReviewSciStatus,
                                 AssignDate = q.MoveToScientistDate,
                                 BatchNo = i != null ? i.BatchCode : "",
                                 DataRemark = i != null ? i.RbAdditionalAnalysis : "",
                                 DraftSubmissionForm = "",
                                 AvailableData = "",
                                 PhysicalState = i != null ? i.State : "",
                                 Appearance = i != null ? i.Apearance : "",
                                 Hygroscopic = i != null ? i.ChkHygroscopic : false,
                                 TempSensitive = i != null ? i.TempSensitive : false,
                                 Lacrymatory = i != null ? i.Lacrymatory : false,
                                 Photostability = i != null ? i.Photostability : false,
                                 StabilityRelatedComment = i != null ? i.StabilityRelatedComment : "",
                                 Stability = i != null ? i.Stability : "",
                                 SaltFreeBase = i != null ? i.RbSaltMentionName : "",
                                 COA = "",
                                 HPLC = i != null ? i.HPLCPurity : "",
                                 RbAdditionalAnalysis = i != null ? i.RbAdditionalAnalysis : "",
                                 IRAttachment = i != null ? i.IRAttachment : "",
                                 MassAttachment = i != null ? i.MassAttachment : "",
                                 HPLCGCELSDAttachment = i != null ? i.PLCAttachment : "",
                                 NMRAttachment = i != null ? i.NMRAttchment : "",
                                 qNMRAttachment = i != null ? i.QNMRAttchment : "",
                                 TGAAttachment = i != null ? i.TGAAttachment : "",
                                 CMRAttachment = i != null ? i.CMRAttchment : "",
                                 DEPTAttachment = i != null ? i.DEPTAttachment : "",
                                 HRMSAttachment = i != null ? i.HRMSAttachment : "",
                                 ROIAttachment = i != null ? i.ROIAttachment : "",
                                 ElementalAttachment = i != null ? i.ElementralAttachment : "",
                                 SERAttachment = i != null ? i.SERAttachment : "",
                                 GCAttachment = i != null ? i.GCAttachment : "",
                                 ELSDAttachment = i != null ? i.ELSDAttachment : "",
                                 ChairalAttachment = i != null ? i.ChiralAttachmenrt : "",
                                 N1NMRAttachment = i != null ? i.N1NmrAttachment : "",
                                 ApprovedStatus = i.ApprovalStatus,
                                 ApprovedAs = i.ApprovedAs,
                                 ApprovalComments = i.ApprovalComment,
                                 RecommondationRetest = q.RecommendedPeriod,
                                 ProductId = q.ProductId,
                                 StabilityRT = i.SolidForm,
                                 StabilitySolution = i.SolutionForm,
                                 chkNMRDone = i.chkNMRDone,
                                 chkCrystallizationDone = i.chkCrystallizationDone,
                                 ChemdrawFileAttachment = i.ChemdrawFileAttachment,
                                 QCApprovedDate = i != null ? i.QCApprovedDate : null
                             }).ToList();
                if (!string.IsNullOrEmpty(fltapprovalstatus))
                {
                    model = model.Where(x => x.ApprovedStatus == fltapprovalstatus).ToList();
                }
                model.ForEach(x =>
                {
                    x.ApprovedAsText = GetApproveStatusList(x.QuoteDetailsId, x.ApprovedStatus, true);
                });
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.ApprovedAsText != null && m.ApprovedAsText.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        ).ToList();
                }

                recordsTotal = model.Count();
                var data = model.Skip(skip).Take(pageSize).ToList();
                //var categoryData = db.Categories.ToList();
                //var productCategoryData = db.Product_Category_Mapping.ToList();
                var proIds = data.Select(x => x.ProductId).Distinct().ToList();
                var productsData = db.Products.Where(x => proIds.Contains(x.Id) && x.Published == true && x.Deleted == false).ToList();
                foreach (var itemObj in data)
                {

                    if (!string.IsNullOrEmpty(itemObj.AvailableData))
                    {
                        itemObj.AvailableData = itemObj.AvailableData.Replace("APCI Mass", "Mass Interpretaion");
                    }
                    if (!string.IsNullOrEmpty(itemObj.N1NMRAttachment))
                    {
                        itemObj.N1NMRAttachment = (itemObj.N1NMRAttachment != null ? "<a href='" + itemObj.N1NMRAttachment.Replace("..", "") + "' download='N1NMRAttachment'><i class='fa fa-download'></i></a>" : "");
                    }
                    itemObj.GetAllBatch = "<i class='fa fa-clone' title='View Batch No' onclick='GetAllBatchNo(" + itemObj.ProductId + ", " + itemObj.QuoteDetailsId + ")'></i>";
                    if (!string.IsNullOrEmpty(itemObj.Diff))
                    {
                        foreach (EnumList.DifficultyLevel r in Enum.GetValues(typeof(EnumList.DifficultyLevel)))
                        {
                            var item = Enum.GetName(typeof(EnumList.DifficultyLevel), r);
                            var test = r.ToString();
                            string text = SZ_Helper.GetEnumDescription((EnumList.DifficultyLevel)(int)r);
                            int val = (int)r;
                            if (Convert.ToString(val) == itemObj.Diff)
                            {
                                itemObj.Diff = text;
                            }
                        }
                    }
                    if (itemObj.QCApprovedDate.HasValue)
                    {
                        itemObj.QCApprovedDateStr = itemObj.QCApprovedDate.Value.ToShortDateString();
                    }
                    if (itemObj.AssignDate.HasValue)
                    {
                        itemObj.AssignDatestr = itemObj.AssignDate.Value.ToShortDateString();
                    }
                    if (itemObj.SubmissionDate != null && itemObj.SubmissionDate.HasValue)
                    {
                        itemObj.SubmissionDatestr = itemObj.SubmissionDate.Value.ToShortDateString();
                    }
                    itemObj.APIName = GetApiNameOfProduct(itemObj.ProductId.Value, productsData);
                    itemObj.ApprovedStatusText = GetApproveStatusList(itemObj.QuoteDetailsId, itemObj.ApprovedStatus);
                    itemObj.ApprovedAsText = GetApprovedAsList(itemObj.QuoteDetailsId, itemObj.ApprovedAs);
                    itemObj.ApprovalCommentsText = "<i class='fa fa-pencil' onclick='approCommentGenerate(\"" + itemObj.QuoteDetailsId + "\")' ></i>";
                    itemObj.RecommondationRetestText = "<input type='number' id='recommondationretest_" + itemObj.QuoteDetailsId + "' name='recommondationretest_" + itemObj.QuoteDetailsId + "' value='" + itemObj.RecommondationRetest + "' />";

                    itemObj.IsLatinAmerica = itemObj.QuoteDetails.SZ_Quotation.SZ_CompanyList.GeographicalLocation == 1 ? true : false;
                    itemObj.ChkSaveRow = "";
                    if (itemObj.IsLatinAmerica)
                    {
                        itemObj.ChkSaveRow = "<img src='../images/Brazilian_flag_icon_round.png' height='16px' width='16px' />";
                    }
                    itemObj.ChkSaveRow += "<input type='checkbox' data-formid='" + itemObj.FormId + "' value='" + itemObj.QuoteDetailsId + "' class='clsSaverow' />";
                    if (!string.IsNullOrEmpty(itemObj.RbAdditionalAnalysis))
                    {
                        itemObj.IR = itemObj.RbAdditionalAnalysis.Contains("IR") ? (itemObj.IRAttachment != null ? "<a href='" + itemObj.IRAttachment.Replace("..", "") + "' download='IRAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.Mass = itemObj.RbAdditionalAnalysis.Contains("Mass") ? (itemObj.MassAttachment != null ? "<a href='" + itemObj.MassAttachment.Replace("..", "") + "' download='MassAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.HPLCGCELSD = itemObj.RbAdditionalAnalysis.Contains("HPLC/GC/ELSD") ? (itemObj.HPLCGCELSDAttachment != null ? "<a href='" + itemObj.HPLCGCELSDAttachment.Replace("..", "") + "' download='HPLCGCELSDAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.NMR = itemObj.RbAdditionalAnalysis.Contains("NMR") ? (itemObj.NMRAttachment != null ? "<a href='" + itemObj.NMRAttachment.Replace("..", "") + "' download='NMRAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.qNMR = itemObj.RbAdditionalAnalysis.Contains("qNMR") ? (itemObj.qNMRAttachment != null ? "<a href='" + itemObj.qNMRAttachment.Replace("..", "") + "' download='qNMRAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.TGA = itemObj.RbAdditionalAnalysis.Contains("TGA") ? (itemObj.TGAAttachment != null ? "<a href='" + itemObj.TGAAttachment.Replace("..", "") + "' download='TGAAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.CMR = itemObj.RbAdditionalAnalysis.Contains("CMR") ? (itemObj.CMRAttachment != null ? "<a href='" + itemObj.CMRAttachment.Replace("..", "") + "' download='CMRAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.DEPT = itemObj.RbAdditionalAnalysis.Contains("DEPT") ? (itemObj.DEPTAttachment != null ? "<a href='" + itemObj.DEPTAttachment.Replace("..", "") + "' download='DEPTAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.HRMS = itemObj.RbAdditionalAnalysis.Contains("HRMS") ? (itemObj.HRMSAttachment != null ? "<a href='" + itemObj.HRMSAttachment.Replace("..", "") + "' download='HRMSAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.ROI = itemObj.RbAdditionalAnalysis.Contains("ROI") ? (itemObj.ROIAttachment != null ? "<a href='" + itemObj.ROIAttachment.Replace("..", "") + "' download='ROIAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.Elemental = itemObj.RbAdditionalAnalysis.Contains("Elemental") ? (itemObj.ElementalAttachment != null ? "<a href='" + itemObj.ElementalAttachment.Replace("..", "") + "' download='ElementalAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.SER = itemObj.RbAdditionalAnalysis.Contains("CMR Interpretaion") ? (itemObj.SERAttachment != null ? "<a href='" + itemObj.SERAttachment.Replace("..", "") + "' download='SERAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.APCIMass = itemObj.RbAdditionalAnalysis.Contains("APCI Mass") ? (itemObj.APCIMassAttachment != null ? "<a href='" + itemObj.APCIMassAttachment.Replace("..", "") + "' download='APCIMassAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.NMRInterpretaion = itemObj.RbAdditionalAnalysis.Contains("NMR Interpretaion") ? (itemObj.NMRInterpretaionAttachment != null ? "<a href='" + itemObj.NMRInterpretaionAttachment.Replace("..", "") + "' download='NMRInterpretaionAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.ChemDrawFile = !string.IsNullOrEmpty(itemObj.ChemdrawFileAttachment) ? "<a href='javascript:void(0)' onclick='DownloadChemDraw(" + itemObj.FormId + ")'><i class='fa fa-download'></i></a>" : "";
                    }
                    if (itemObj.Hygroscopic.HasValue && itemObj.Hygroscopic.Value)
                    {
                        itemObj.TextHygroscopic = "<i class='fa fa-check'></i>";
                    }
                    else
                    {
                        itemObj.TextHygroscopic = "<i class='fa fa-close'></i>";
                    }
                    if (itemObj.TempSensitive.HasValue && itemObj.TempSensitive.Value)
                    {
                        itemObj.TextTempSensitive = "<i class='fa fa-check'></i>";
                    }
                    else
                    {
                        itemObj.TextTempSensitive = "<i class='fa fa-close'></i>";
                    }

                    if (itemObj.Lacrymatory.HasValue && itemObj.Lacrymatory.Value)
                    {
                        itemObj.TextLacrymatory = "<i class='fa fa-check'></i>";
                    }
                    else
                    {
                        itemObj.TextLacrymatory = "<i class='fa fa-close'></i>";
                    }
                    if (itemObj.chkNMRDone.HasValue && itemObj.chkNMRDone.Value)
                    {
                        itemObj.chkNMRDoneText = "<i class='fa fa-check'></i>";
                    }
                    else
                    {
                        itemObj.chkNMRDoneText = "<i class='fa fa-close'></i>";
                    }
                    if (itemObj.chkCrystallizationDone.HasValue && itemObj.chkCrystallizationDone.Value)
                    {
                        itemObj.chkCrystallizationDoneText = "<i class='fa fa-check'></i>";
                    }
                    else
                    {
                        itemObj.chkCrystallizationDoneText = "<i class='fa fa-close'></i>";
                    }

                    if (itemObj.SubmissionDate.HasValue)
                    {
                        itemObj.DraftSubmissionForm = itemObj.SubmissionDate.Value.ToShortDateString();
                    }
                    if (itemObj.Photostability.HasValue && itemObj.Photostability.Value)
                    {
                        itemObj.TextPhotostability = "<i class='fa fa-check'></i>";
                    }
                    else
                    {
                        itemObj.TextPhotostability = "<i class='fa fa-close'></i>";
                    }
                    var pName = "";
                    var query = queryData.Where(x => x.CATNo.Trim().ToLower() == itemObj.CATNo.Trim().ToLower()).OrderByDescending(x => x.Id);
                    if (query != null && query.Count() > 0)
                    {
                        var qlist = query.Select(x => x.QueryNo).ToArray();
                        if (query.Select(x => x.Status.ToLower()).FirstOrDefault() == "solved" ||
                                     query.Select(x => x.Status.ToLower()).FirstOrDefault() == "close" ||
                                     query.Select(x => x.Status.ToLower()).FirstOrDefault() == "completed")
                        {
                            pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + itemObj.CATNo + "\")' title='" + string.Join(", ", qlist) + "' style ='float:right; color: green' ></i>";
                        }
                        else
                        {
                            pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + itemObj.CATNo + "\")' title='" + string.Join(", ", qlist) + "' style ='float:right' ></i>";
                        }
                    }
                    itemObj.IsConversionReport = itemObj.QuoteDetails.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    var impstr = "";
                    if (itemObj.IsConversionReport.HasValue && itemObj.IsConversionReport.Value)
                    {
                        impstr += "<img src='/img/important.jpg' width='15px' height='15px' />";
                    }

                    itemObj.CATNo = pName + "" + "<a href='https://www.synzeal.com/search?q=" + itemObj.CATNo + "' target='_blank'>" + itemObj.CATNo + "</a>" + "" + impstr + " " + CommonOperation.GetMatchingTagHTML(itemObj.QuoteDetails, "QC");
                    itemObj.QuoteDetails = null;
                }

                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }
        }


        public ActionResult DownloadChemDraw(int id)
        {
            var formdata = db.SZ_QuoteDetailForm.Where(x => x.Id == id).FirstOrDefault();
            if (formdata == null)
                return null;

            string startPath = Server.MapPath(formdata.ChemdrawFileAttachment.Replace("..", "~"));
            string zipPath = Server.MapPath("~/Content/NewProducts/" + Guid.NewGuid().ToString() + ".zip");
            string[] Filenames = new string[] { startPath };
            using (ZipFile zip = new ZipFile())
            {
                zip.AddFiles(Filenames, "Chemdraw File");//Zip file inside filename  
                zip.Save(zipPath);//location and name for creating zip file  
            }
            return File(zipPath, "application/zip", Server.UrlEncode("ChemDraw-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".zip"));

        }

        [HttpPost]
        public ActionResult LoadQCApprovedData()
        {
            try
            {
                string approvedstatus = Convert.ToString((int)EnumList.ApprovedStatus.QCApproved);

                string ProjectType = Convert.ToString((int)EnumList.ProjectType.Purchase);
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;
                var model = (from q in db.SZ_QuotationDetail.AsNoTracking()
                             where q.ApprovalStatus == approvedstatus
                             orderby q.QCApprovedDate descending
                             select new QCModel()
                             {
                                 QuoteDetails = q,
                                 QuoteDetailsId = q.Id,
                                 ScientistName = q.SubScientistName,
                                 Chemist = q.Chemist,
                                 Diff = q.DifficultyLevel,
                                 ProductName = q.ProductName,
                                 AdditionalBatchNo = q.AdditionalBatchNo,
                                 CASNo = q.CASNo,
                                 CATNo = q.CATNo,
                                 Qty = q.RequiredQty,
                                 SubmittedQty = q.RequiredQty,
                                 ReviewStatus = q.ReviewSciStatus,
                                 AssignDate = q.MoveToScientistDate,
                                 DataRemark = q.Remark,
                                 DraftSubmissionForm = "",
                                 COA = "",
                                 ApprovedStatus = q.ApprovalStatus,
                                 ApprovedAs = q.ApprovedAs,
                                 ApprovalComments = q.ApprovalComment,
                                 RecommondationRetest = q.RecommendedPeriod,
                                 ProductId = q.ProductId,
                                 QCApprovedDate = q.QCApprovedDate
                             }).ToList();

                var proIds = model.Select(x => x.ProductId).Distinct().ToList();
                var quotedetailsIds = model.Select(x => x.QuoteDetailsId).Distinct().ToList();
                var inventoryData = db.SZ_Inventory.Where(x => proIds.Contains(x.ProductId)).ToList();
                var productsData = db.Products.Where(x => proIds.Contains(x.Id) && x.Published == true && x.Deleted == false).ToList();

                model.ForEach(x =>
                {
                    var i = (from xy in db.SZ_QuoteDetailForm
                             join t3 in db.SZ_QuoteDetails_Form on xy.Id equals t3.FormId
                             where t3.QuoteDetailsId == x.QuoteDetailsId
                             select xy).FirstOrDefault();
                    if (i != null)
                    {
                        x.FormId = i.Id;
                        x.QuoteDetailsId = i.QuotationDetailsId;
                        x.ScientistName = i.TLName;
                        x.Chemist = i.ScientistName;
                        x.ProductName = i.ProductName;
                        x.CASNo = i.CASNo;
                        x.CATNo = i.CATNo;
                        x.Qty = i.Qty;
                        x.SubmissionDate = i.SubmissionDate;
                        x.BatchNo = i.BatchCode;
                        x.DraftSubmissionForm = "";
                        x.AvailableData = i.RbAdditionalAnalysis;
                        x.PhysicalState = i.State;
                        x.Appearance = i.Apearance;
                        x.Hygroscopic = i.ChkHygroscopic;
                        x.TempSensitive = i.TempSensitive;
                        x.Lacrymatory = i.Lacrymatory;
                        x.StabilityRelatedComment = i.StabilityRelatedComment;
                        x.Stability = i.Stability;
                        x.SaltFreeBase = i.RbSaltMentionName;
                        x.COA = "";
                        x.HPLC = i.HPLCPurity;
                        x.RbAdditionalAnalysis = i.RbAdditionalAnalysis;
                        x.IRAttachment = i.IRAttachment;
                        x.MassAttachment = i.MassAttachment;
                        x.HPLCGCELSDAttachment = i.PLCAttachment;
                        x.NMRAttachment = i.NMRAttchment;
                        x.qNMRAttachment = i.QNMRAttchment;
                        x.TGAAttachment = i.TGAAttachment;
                        x.CMRAttachment = i.CMRAttchment;
                        x.DEPTAttachment = i.DEPTAttachment;
                        x.HRMSAttachment = i.HRMSAttachment;
                        x.ROIAttachment = i.ROIAttachment;
                        x.ElementalAttachment = i.ElementralAttachment;
                        x.SERAttachment = i.SERAttachment;
                        x.APCIMassAttachment = i.APCIMassAttachment;
                        x.NMRInterpretaionAttachment = i.NMRInterpretaionAttachment;
                        x.GCAttachment = i.GCAttachment;
                        x.ELSDAttachment = i.ELSDAttachment;
                        x.ChairalAttachment = i.ChiralAttachmenrt;
                        x.N1NMRAttachment = i.N1NmrAttachment;
                        x.ApprovedStatus = i.ApprovalStatus;
                        x.ApprovedAs = i.ApprovedAs;
                        x.ApprovalComments = i.ApprovalComment;
                        x.RecommondationRetest = i.RecommendedPeriod;
                    }

                    x.AdditionalBatchNoText = "<select id='additionalBatch_" + x.QuoteDetailsId + "' data-quotationdetailsid='" + x.QuoteDetailsId + "' class='dddladditionalbatch'><option value=''>--Select--</option>";
                    if (x.ProductId.HasValue)
                    {
                        var proData = productsData.Where(xy => xy.Id == x.ProductId).Count();
                        var proBatchData = inventoryData.Where(xy => xy.ProductId == x.ProductId).ToList();
                        if (proBatchData.Count > 0 && proData > 0)
                        {
                            proBatchData.ForEach(r =>
                            {
                                //var qty = System.Text.RegularExpressions.Regex.Match(Convert.ToString(r.Qty), @"\d+").Value;
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }
                                string selected = string.Empty;
                                if (r.Id == x.AdditionalBatchNo)
                                {
                                    selected = "selected ";
                                    x.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
                                }

                                x.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' " + selected + ">" + text + "</option>";
                            });
                        }
                    }
                    x.AdditionalBatchNoText += "</select>";
                    x.ApprovedAsText = GetApproveStatusList(x.QuoteDetailsId, x.ApprovedStatus, true);
                });
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.ApprovedAsText != null && m.ApprovedAsText.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        ).ToList();
                }
                MemoryCacheManager objCache = new MemoryCacheManager();

                //total number of rows count   
                recordsTotal = model.Count();
                //Paging   
                var data = model.Skip(skip).Take(pageSize).ToList();
                //var categoryData = db.Categories.ToList();
                //var productCategoryData = db.Product_Category_Mapping.ToList();
                var queryData = objCache.Get("cache.queryData", () =>
                {
                    return db.SZ_QueryModule.AsNoTracking().ToList();
                });


                foreach (var itemObj in data)
                {
                    itemObj.GetAllBatch = "<i class='fa fa-clone' title='View Batch No' onclick='GetAllBatchNo(" + itemObj.ProductId + ", " + itemObj.QuoteDetailsId + ")'></i>";
                    if (!string.IsNullOrEmpty(itemObj.Diff))
                    {
                        foreach (EnumList.DifficultyLevel r in Enum.GetValues(typeof(EnumList.DifficultyLevel)))
                        {
                            var item = Enum.GetName(typeof(EnumList.DifficultyLevel), r);
                            var test = r.ToString();
                            string text = SZ_Helper.GetEnumDescription((EnumList.DifficultyLevel)(int)r);
                            int val = (int)r;
                            if (Convert.ToString(val) == itemObj.Diff)
                            {
                                itemObj.Diff = text;
                            }
                        }
                    }
                    if (itemObj.QCApprovedDate.HasValue)
                    {
                        itemObj.QCApprovedDateStr = itemObj.QCApprovedDate.Value.ToShortDateString();
                    }
                    if (itemObj.AssignDate.HasValue)
                    {
                        itemObj.AssignDatestr = itemObj.AssignDate.Value.ToShortDateString();
                    }
                    if (itemObj.SubmissionDate != null && itemObj.SubmissionDate.HasValue)
                    {
                        itemObj.SubmissionDatestr = itemObj.SubmissionDate.Value.ToShortDateString();
                    }
                    itemObj.APIName = GetApiNameOfProduct(itemObj.ProductId.Value, productsData);
                    //itemObj.CATNo = "<a href='https://www.synzeal.com/search?q=" + itemObj.CATNo + "' target='_blank'>" + itemObj.CATNo + "</a>";
                    itemObj.ApprovedStatusText = GetApproveStatusList(itemObj.QuoteDetailsId, itemObj.ApprovedStatus);
                    itemObj.ApprovedAsText = GetApprovedAsList(itemObj.QuoteDetailsId, itemObj.ApprovedAs);
                    //itemObj.ApprovalCommentsText = "<input type='text' id='approvalcomment_" + itemObj.FormId + "' name='approvalcomment_" + itemObj.FormId + "' value='" + itemObj.ApprovalComments + "' />";
                    itemObj.ApprovalCommentsText = "<i class='fa fa-pencil' onclick='approCommentGenerate(\"" + itemObj.QuoteDetailsId + "\")' ></i>";
                    itemObj.RecommondationRetestText = "<input type='number' id='recommondationretest_" + itemObj.QuoteDetailsId + "' name='recommondationretest_" + itemObj.QuoteDetailsId + "' value='" + itemObj.RecommondationRetest + "' />";
                    itemObj.ChkSaveRow = "<input type='checkbox' value='" + itemObj.QuoteDetailsId + "' class='clsSaverow' />";

                    if (!string.IsNullOrEmpty(itemObj.RbAdditionalAnalysis))
                    {
                        itemObj.IR = itemObj.RbAdditionalAnalysis.Contains("IR") ? (itemObj.IRAttachment != null ? "<a href='" + itemObj.IRAttachment.ReplaceForFilepath() + "' download='IRAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.Mass = itemObj.RbAdditionalAnalysis.Contains("Mass") ? (itemObj.MassAttachment != null ? "<a href='" + itemObj.MassAttachment.Replace("..", "") + "' download='MassAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.HPLCGCELSD = itemObj.RbAdditionalAnalysis.Contains("HPLC/GC/ELSD") ? (itemObj.HPLCGCELSDAttachment != null ? "<a href='" + itemObj.HPLCGCELSDAttachment.Replace("..", "") + "' download='HPLCGCELSDAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.NMR = itemObj.RbAdditionalAnalysis.Contains("NMR") ? (itemObj.NMRAttachment != null ? "<a href='" + itemObj.NMRAttachment.Replace("..", "") + "' download='NMRAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.qNMR = itemObj.RbAdditionalAnalysis.Contains("qNMR") ? (itemObj.qNMRAttachment != null ? "<a href='" + itemObj.qNMRAttachment.Replace("..", "") + "' download='qNMRAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.TGA = itemObj.RbAdditionalAnalysis.Contains("TGA") ? (itemObj.TGAAttachment != null ? "<a href='" + itemObj.TGAAttachment.Replace("..", "") + "' download='TGAAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.CMR = itemObj.RbAdditionalAnalysis.Contains("CMR") ? (itemObj.CMRAttachment != null ? "<a href='" + itemObj.CMRAttachment.Replace("..", "") + "' download='CMRAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.DEPT = itemObj.RbAdditionalAnalysis.Contains("DEPT") ? (itemObj.DEPTAttachment != null ? "<a href='" + itemObj.DEPTAttachment.Replace("..", "") + "' download='DEPTAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.HRMS = itemObj.RbAdditionalAnalysis.Contains("HRMS") ? (itemObj.HRMSAttachment != null ? "<a href='" + itemObj.HRMSAttachment.Replace("..", "") + "' download='HRMSAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.ROI = itemObj.RbAdditionalAnalysis.Contains("ROI") ? (itemObj.ROIAttachment != null ? "<a href='" + itemObj.ROIAttachment.Replace("..", "") + "' download='ROIAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.Elemental = itemObj.RbAdditionalAnalysis.Contains("Elemental") ? (itemObj.ElementalAttachment != null ? "<a href='" + itemObj.ElementalAttachment.Replace("..", "") + "' download='ElementalAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.SER = itemObj.RbAdditionalAnalysis.Contains("SER") ? (itemObj.SERAttachment != null ? "<a href='" + itemObj.SERAttachment.Replace("..", "") + "' download='SERAttachment'><i class='fa fa-download'></i></a>" : "") : "";

                        itemObj.APCIMass = itemObj.RbAdditionalAnalysis.Contains("APCI Mass") ? (itemObj.APCIMassAttachment != null ? "<a href='" + itemObj.APCIMassAttachment.Replace("..", "") + "' download='APCIMassAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                        itemObj.NMRInterpretaion = itemObj.RbAdditionalAnalysis.Contains("NMR Interpretaion") ? (itemObj.NMRInterpretaionAttachment != null ? "<a href='" + itemObj.NMRInterpretaionAttachment.Replace("..", "") + "' download='NMRInterpretaionAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                    }
                    if (itemObj.Hygroscopic.HasValue && itemObj.Hygroscopic.Value)
                    {
                        itemObj.TextHygroscopic = "<i class='fa fa-check'></i>";
                    }
                    else
                    {
                        itemObj.TextHygroscopic = "<i class='fa fa-close'></i>";
                    }
                    if (itemObj.TempSensitive.HasValue && itemObj.TempSensitive.Value)
                    {
                        itemObj.TextTempSensitive = "<i class='fa fa-check'></i>";
                    }
                    else
                    {
                        itemObj.TextTempSensitive = "<i class='fa fa-close'></i>";
                    }

                    if (itemObj.Lacrymatory.HasValue && itemObj.Lacrymatory.Value)
                    {
                        itemObj.TextLacrymatory = "<i class='fa fa-check'></i>";
                    }
                    else
                    {
                        itemObj.TextLacrymatory = "<i class='fa fa-close'></i>";
                    }
                    var pName = "";
                    var query = queryData.Where(x => x.CATNo.Trim().ToLower() == itemObj.CATNo.Trim().ToLower()).OrderByDescending(x => x.Id);
                    if (query != null && query.Count() > 0)
                    {
                        var qlist = query.Select(x => x.QueryNo).ToArray();
                        if (query.Select(x => x.Status.ToLower()).FirstOrDefault() == "solved" ||
                     query.Select(x => x.Status.ToLower()).FirstOrDefault() == "close" ||
                                     query.Select(x => x.Status.ToLower()).FirstOrDefault() == "completed")
                        {
                            pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + itemObj.CATNo + "\")' title='" + string.Join(", ", qlist) + "' style ='float:right; color: green' ></i>";
                        }
                        else
                        {
                            pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + itemObj.CATNo + "\")' title='" + string.Join(", ", qlist) + "' style ='float:right' ></i>";
                        }
                    }


                    itemObj.IsConversionReport = itemObj.QuoteDetails.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    var impstr = "";
                    if (itemObj.IsConversionReport.HasValue && itemObj.IsConversionReport.Value)
                    {
                        impstr += "<img src='/img/important.jpg' width='15px' height='15px' />";
                    }
                    itemObj.CATNo = pName + "" + "<a href='https://www.synzeal.com/search?q=" + itemObj.CATNo + "' target='_blank'>" + itemObj.CATNo + "</a>" + "" + impstr + "" + CommonOperation.GetMatchingTagHTML(itemObj.QuoteDetails, "QC");
                    itemObj.QuoteDetails = null;
                }

                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);
                throw ex;
            }
        }

        [HttpPost]
        public ActionResult LoadQCFormApprovedData()
        {
            try
            {
                string approvedstatus = Convert.ToString((int)EnumList.ApprovedStatus.QCApproved);

                string ProjectType = Convert.ToString((int)EnumList.ProjectType.Purchase);
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;
                var model = (from i in db.SZ_QuoteDetailForm.AsNoTracking()
                             join t3 in db.SZ_QuoteDetails_Form.AsNoTracking() on i.Id equals t3.FormId
                             join q in db.SZ_QuotationDetail.AsNoTracking() on t3.QuoteDetailsId equals q.Id
                             where i.ApprovalStatus == approvedstatus
                             orderby i.QCApprovedDate descending
                             select new QCModel()
                             {
                                 QuoteDetails = q,
                                 FormId = i.Id,
                                 QuoteDetailsId = i.QuotationDetailsId,
                                 ScientistName = i.TLName,
                                 Chemist = i.ScientistName,
                                 Diff = q.DifficultyLevel,
                                 ProductName = i.ProductName,
                                 CASNo = i.CASNo,
                                 CATNo = i.CATNo,
                                 Qty = i.Qty,
                                 SubmittedQty = q.RequiredQty,
                                 SubmissionDate = i.SubmissionDate,
                                 ReviewStatus = q.ReviewSciStatus,
                                 AssignDate = q.MoveToScientistDate,
                                 BatchNo = i.BatchCode,
                                 DataRemark = q.Remark,
                                 DraftSubmissionForm = "",
                                 AvailableData = i.RbAdditionalAnalysis,
                                 PhysicalState = i.State,
                                 Appearance = i.Apearance,
                                 Hygroscopic = i.ChkHygroscopic,
                                 TempSensitive = i.TempSensitive,
                                 Lacrymatory = i.Lacrymatory,
                                 StabilityRelatedComment = i.StabilityRelatedComment,
                                 Stability = i.Stability,
                                 SaltFreeBase = i.RbSaltMentionName,
                                 COA = "",
                                 HPLC = i.HPLCPurity,
                                 RbAdditionalAnalysis = i.RbAdditionalAnalysis,
                                 IRAttachment = i.IRAttachment,
                                 MassAttachment = i.MassAttachment,
                                 HPLCGCELSDAttachment = i.PLCAttachment,
                                 NMRAttachment = i.NMRAttchment,
                                 qNMRAttachment = i.QNMRAttchment,
                                 TGAAttachment = i.TGAAttachment,
                                 CMRAttachment = i.CMRAttchment,
                                 DEPTAttachment = i.DEPTAttachment,
                                 HRMSAttachment = i.HRMSAttachment,
                                 ROIAttachment = i.ROIAttachment,
                                 ElementalAttachment = i.ElementralAttachment,
                                 SERAttachment = i.SERAttachment,
                                 APCIMassAttachment = i.APCIMassAttachment,
                                 NMRInterpretaionAttachment = i.NMRInterpretaionAttachment,
                                 GCAttachment = i.GCAttachment,
                                 ELSDAttachment = i.ELSDAttachment,
                                 ChairalAttachment = i.ChiralAttachmenrt,
                                 N1NMRAttachment = i.N1NmrAttachment,
                                 ApprovedStatus = i.ApprovalStatus,
                                 ApprovedAs = i.ApprovedAs,
                                 ApprovalComments = i.ApprovalComment,
                                 RecommondationRetest = i.RecommendedPeriod,
                                 ProductId = q.ProductId,
                                 QCApprovedDate = q.QCApprovedDate
                             }).ToList();

                model.ForEach(x =>
                {
                    x.ApprovedAsText = GetApproveStatusList(x.QuoteDetailsId, x.ApprovedStatus, true);
                });

                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.ApprovedAsText != null && m.ApprovedAsText.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        ).ToList();
                }

                //total number of rows count   
                recordsTotal = model.Count();
                //Paging   
                var data = model.Skip(skip).Take(pageSize).ToList();
                //var categoryData = db.Categories.ToList();
                //var productCategoryData = db.Product_Category_Mapping.ToList();

                MemoryCacheManager objCache = new MemoryCacheManager();
                var queryData = objCache.Get("cache.queryData", () =>
                {
                    return db.SZ_QueryModule.AsNoTracking().ToList();
                });
                var productsData = objCache.Get("cache.productsdata", () =>
                {
                    return db.Products.Where(x => x.Published == true && x.Deleted == false).ToList();
                });
                foreach (var itemObj in data)
                {
                    if (!string.IsNullOrEmpty(itemObj.AvailableData))
                    {
                        itemObj.AvailableData = itemObj.AvailableData.Replace("APCI Mass", "Mass Interpretaion");
                    }
                    if (!string.IsNullOrEmpty(itemObj.N1NMRAttachment))
                    {
                        itemObj.N1NMRAttachment = (itemObj.N1NMRAttachment != null ? "<a href='" + itemObj.N1NMRAttachment.Replace("..", "") + "' download='N1NMRAttachment'><i class='fa fa-download'></i></a>" : "");
                    }
                    itemObj.GetAllBatch = "<i class='fa fa-clone' title='View Batch No' onclick='GetAllBatchNo(" + itemObj.ProductId + ", " + itemObj.QuoteDetailsId + ")'></i>";
                    if (!string.IsNullOrEmpty(itemObj.Diff))
                    {
                        foreach (EnumList.DifficultyLevel r in Enum.GetValues(typeof(EnumList.DifficultyLevel)))
                        {
                            var item = Enum.GetName(typeof(EnumList.DifficultyLevel), r);
                            var test = r.ToString();
                            string text = SZ_Helper.GetEnumDescription((EnumList.DifficultyLevel)(int)r);
                            int val = (int)r;
                            if (Convert.ToString(val) == itemObj.Diff)
                            {
                                itemObj.Diff = text;
                            }
                        }
                    }
                    if (itemObj.QCApprovedDate.HasValue)
                    {
                        itemObj.QCApprovedDateStr = itemObj.QCApprovedDate.Value.ToShortDateString();
                    }
                    if (itemObj.AssignDate.HasValue)
                    {
                        itemObj.AssignDatestr = itemObj.AssignDate.Value.ToShortDateString();
                    }
                    if (itemObj.SubmissionDate != null && itemObj.SubmissionDate.HasValue)
                    {
                        itemObj.SubmissionDatestr = itemObj.SubmissionDate.Value.ToShortDateString();
                    }
                    itemObj.APIName = GetApiNameOfProduct(itemObj.ProductId.Value, productsData);
                    //itemObj.CATNo = "<a href='https://www.synzeal.com/search?q=" + itemObj.CATNo + "' target='_blank'>" + itemObj.CATNo + "</a>";
                    itemObj.ApprovedStatusText = GetApproveStatusList(itemObj.QuoteDetailsId, itemObj.ApprovedStatus);
                    itemObj.ApprovedAsText = GetApprovedAsList(itemObj.QuoteDetailsId, itemObj.ApprovedAs);
                    //itemObj.ApprovalCommentsText = "<input type='text' id='approvalcomment_" + itemObj.FormId + "' name='approvalcomment_" + itemObj.FormId + "' value='" + itemObj.ApprovalComments + "' />";
                    itemObj.ApprovalCommentsText = "<i class='fa fa-pencil' onclick='approCommentGenerate(\"" + itemObj.QuoteDetailsId + "\")' ></i>";
                    itemObj.RecommondationRetestText = "<input type='number' id='recommondationretest_" + itemObj.QuoteDetailsId + "' name='recommondationretest_" + itemObj.QuoteDetailsId + "' value='" + itemObj.RecommondationRetest + "' />";
                    itemObj.ChkSaveRow = "";
                    itemObj.IsLatinAmerica = itemObj.QuoteDetails.SZ_Quotation.SZ_CompanyList.GeographicalLocation == 1 ? true : false;

                    if (itemObj.IsLatinAmerica)
                    {
                        itemObj.ChkSaveRow = "<img src='../images/Brazilian_flag_icon_round.png' height='16px' width='16px' />";
                    }
                    itemObj.ChkSaveRow += "<input type='checkbox' value='" + itemObj.QuoteDetailsId + "' class='clsSaverow' />";
                    itemObj.IR = itemObj.RbAdditionalAnalysis.Contains("IR") ? (itemObj.IRAttachment != null ? "<a href='" + itemObj.IRAttachment.ReplaceForFilepath() + "' download='IRAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                    itemObj.Mass = itemObj.RbAdditionalAnalysis.Contains("Mass") ? (itemObj.MassAttachment != null ? "<a href='" + itemObj.MassAttachment.Replace("..", "") + "' download='MassAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                    itemObj.HPLCGCELSD = itemObj.RbAdditionalAnalysis.Contains("HPLC/GC/ELSD") ? (itemObj.HPLCGCELSDAttachment != null ? "<a href='" + itemObj.HPLCGCELSDAttachment.Replace("..", "") + "' download='HPLCGCELSDAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                    itemObj.NMR = itemObj.RbAdditionalAnalysis.Contains("NMR") ? (itemObj.NMRAttachment != null ? "<a href='" + itemObj.NMRAttachment.Replace("..", "") + "' download='NMRAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                    itemObj.qNMR = itemObj.RbAdditionalAnalysis.Contains("qNMR") ? (itemObj.qNMRAttachment != null ? "<a href='" + itemObj.qNMRAttachment.Replace("..", "") + "' download='qNMRAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                    itemObj.TGA = itemObj.RbAdditionalAnalysis.Contains("TGA") ? (itemObj.TGAAttachment != null ? "<a href='" + itemObj.TGAAttachment.Replace("..", "") + "' download='TGAAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                    itemObj.CMR = itemObj.RbAdditionalAnalysis.Contains("CMR") ? (itemObj.CMRAttachment != null ? "<a href='" + itemObj.CMRAttachment.Replace("..", "") + "' download='CMRAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                    itemObj.DEPT = itemObj.RbAdditionalAnalysis.Contains("DEPT") ? (itemObj.DEPTAttachment != null ? "<a href='" + itemObj.DEPTAttachment.Replace("..", "") + "' download='DEPTAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                    itemObj.HRMS = itemObj.RbAdditionalAnalysis.Contains("HRMS") ? (itemObj.HRMSAttachment != null ? "<a href='" + itemObj.HRMSAttachment.Replace("..", "") + "' download='HRMSAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                    itemObj.ROI = itemObj.RbAdditionalAnalysis.Contains("ROI") ? (itemObj.ROIAttachment != null ? "<a href='" + itemObj.ROIAttachment.Replace("..", "") + "' download='ROIAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                    itemObj.Elemental = itemObj.RbAdditionalAnalysis.Contains("Elemental") ? (itemObj.ElementalAttachment != null ? "<a href='" + itemObj.ElementalAttachment.Replace("..", "") + "' download='ElementalAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                    itemObj.SER = itemObj.RbAdditionalAnalysis.Contains("CMR Interpretaion") ? (!string.IsNullOrEmpty(itemObj.SERAttachment) ? "<a href='" + itemObj.SERAttachment.Replace("..", "") + "' download='SERAttachment'><i class='fa fa-download'></i></a>" : "") : "";

                    itemObj.APCIMass = itemObj.RbAdditionalAnalysis.Contains("APCI Mass") ? (!string.IsNullOrEmpty(itemObj.APCIMassAttachment) ? "<a href='" + itemObj.APCIMassAttachment.Replace("..", "") + "' download='APCIMassAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                    itemObj.NMRInterpretaion = itemObj.RbAdditionalAnalysis.Contains("NMR Interpretaion") ? (!string.IsNullOrEmpty(itemObj.NMRInterpretaionAttachment) ? "<a href='" + itemObj.NMRInterpretaionAttachment.Replace("..", "") + "' download='NMRInterpretaionAttachment'><i class='fa fa-download'></i></a>" : "") : "";
                    if (itemObj.Hygroscopic.HasValue && itemObj.Hygroscopic.Value)
                    {
                        itemObj.TextHygroscopic = "<i class='fa fa-check'></i>";
                    }
                    else
                    {
                        itemObj.TextHygroscopic = "<i class='fa fa-close'></i>";
                    }
                    if (itemObj.TempSensitive.HasValue && itemObj.TempSensitive.Value)
                    {
                        itemObj.TextTempSensitive = "<i class='fa fa-check'></i>";
                    }
                    else
                    {
                        itemObj.TextTempSensitive = "<i class='fa fa-close'></i>";
                    }

                    if (itemObj.Lacrymatory.HasValue && itemObj.Lacrymatory.Value)
                    {
                        itemObj.TextLacrymatory = "<i class='fa fa-check'></i>";
                    }
                    else
                    {
                        itemObj.TextLacrymatory = "<i class='fa fa-close'></i>";
                    }
                    var pName = "";
                    var query = queryData.Where(x => x.CATNo.Trim().ToLower() == itemObj.CATNo.Trim().ToLower()).OrderByDescending(x => x.Id);
                    if (query != null && query.Count() > 0)
                    {
                        var qlist = query.Select(x => x.QueryNo).ToArray();
                        if (query.Select(x => x.Status.ToLower()).FirstOrDefault() == "solved" ||
                     query.Select(x => x.Status.ToLower()).FirstOrDefault() == "close" ||
                                     query.Select(x => x.Status.ToLower()).FirstOrDefault() == "completed")
                        {
                            pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + itemObj.CATNo + "\")' title='" + string.Join(", ", qlist) + "' style ='float:right; color: green' ></i>";
                        }
                        else
                        {
                            pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + itemObj.CATNo + "\")' title='" + string.Join(", ", qlist) + "' style ='float:right' ></i>";
                        }
                    }

                    itemObj.IsConversionReport = itemObj.QuoteDetails.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    var impstr = "";
                    if (itemObj.IsConversionReport.HasValue && itemObj.IsConversionReport.Value)
                    {
                        impstr += "<img src='/img/important.jpg' width='15px' height='15px' />";
                    }

                    itemObj.CATNo = pName + "" + "<a href='https://www.synzeal.com/search?q=" + itemObj.CATNo + "' target='_blank'>" + itemObj.CATNo + "</a>" + "" + impstr + " " + CommonOperation.GetMatchingTagHTML(itemObj.QuoteDetails, "QC");
                    itemObj.QuoteDetails = null;
                }

                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);
                throw ex;
            }
        }

        [HttpPost]
        public ActionResult LoadProductDataQCAllInstock()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                var fltapprovestatus = "";
                if (Request.Form.GetValues("fltapprovestatus") != null)
                {
                    fltapprovestatus = Request.Form.GetValues("fltapprovestatus")[0].ToString();
                }
                var scinameFilter = "";
                if (Request.Form.GetValues("sciname") != null)
                {
                    scinameFilter = Request.Form.GetValues("sciname")[0].ToString();
                }
                var subscinameFilter = "";
                if (Request.Form.GetValues("subsciname") != null)
                {
                    subscinameFilter = Request.Form.GetValues("subsciname")[0].ToString();
                }
                var fltprostatusItem = "";
                if (Request.Form.GetValues("fltprostatusItem") != null)
                {
                    fltprostatusItem = Request.Form.GetValues("fltprostatusItem")[0].ToString();
                }
                var fltactivity = "";
                if (Request.Form.GetValues("fltactivity") != null)
                {
                    fltactivity = Request.Form.GetValues("fltactivity")[0].ToString();
                }
                var searchby = string.Empty;
                var searchbyvalue = string.Empty;
                if (Request.Form.GetValues("radiobuton") != null)
                {
                    searchby = Request.Form.GetValues("radiobuton")[0].ToString();
                }
                if (Request.Form.GetValues("searchbox") != null)
                {
                    searchbyvalue = Request.Form.GetValues("searchbox")[0].ToString().Trim();
                }
                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;
                MemoryCacheManager objCache = new MemoryCacheManager();

                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
                string pursynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
                string instocktype = Convert.ToString((int)EnumList.ProjectType.InStock);
                var queryData = objCache.Get("cache.queryData", () =>
                {
                    return db.SZ_QueryModule.AsNoTracking().ToList();
                });
                var quotationDetailsdata = db.SZ_QuotationDetail.AsQueryable();

                string correctionstatus = Convert.ToString((int)EnumList.ProStatusDDL.QCCorrection);
                string approvalstatus = Convert.ToString((int)EnumList.ProStatusDDL.QCApproval);

                var model = (from quo in db.SZ_Quotation
                             join q in db.SZ_QuotationDetail on quo.Id equals q.QuoteId
                             join i in db.SZ_MasterCOA on q.AdditionalBatchNo equals i.BatchId into gj
                             from ii in gj.DefaultIfEmpty()
                             join l in db.SZ_QuotationDetailLog on q.Id equals l.QuoteDetailsId into gjl
                             from ll in gjl.DefaultIfEmpty()
                             where (q.MoveToProject == true) && string.IsNullOrEmpty(q.TrackingNo)
                             && (q.IsOnHold == false || q.IsOnHold == null)
                             && (q.ProjectType == instocktype)
                             && (q.ProStatus == approvalstatus || q.ProStatus == correctionstatus)
                             orderby q.MoveToProject descending
                             select new QCModel()
                             {
                                 QuoteDetails = q,
                                 QcApprovalDate = q.QcApprovalDate,
                                 CompanyName = quo.CompanyName,
                                 FormId = ii != null ? ii.Id : 0,
                                 QuoteDetailsId = q.Id,
                                 //ScientistName = i.CreatedBy,
                                 ScientistCustomerId = q.ScientistCustomerId,
                                 Chemist = "",
                                 Diff = q.DifficultyLevel,
                                 ProductName = q.ProductName,
                                 CASNo = q.CASNo,
                                 CATNo = q.CATNo,
                                 Qty = ii != null ? ii.QuantityAvailable : "",
                                 SubmittedQty = q.RequiredQty,
                                 SubmissionDate = ii != null ? ii.CreatedDate : (DateTime?)null,
                                 ReviewStatus = q.ReviewSciStatus,
                                 AssignDate = q.MoveToScientistDate,
                                 AdditionalBatchNo = q.AdditionalBatchNo,
                                 ProductId = q.ProductId,
                                 DataRemark = q.Remark,
                                 DraftSubmissionForm = "",
                                 RbAdditionalAnalysis = ii != null ? ii.Attachment : "",
                                 AvailableData = ii != null ? ii.Attachment : "",
                                 PhysicalState = ii != null ? ii.PhysicalState : "",
                                 Appearance = ii != null ? ii.AppearanceProduct : "",
                                 BatchNo = ii != null ? ii.BatchNo : "",
                                 COA = "",
                                 ProStatus = q.ProStatus,
                                 ApprovedStatus = q.ApprovalStatus,
                                 ApprovedAs = q.ApprovedAs,
                                 ApprovalComments = q.ApprovalComment,
                                 RecommondationRetest = q.RecommendedPeriod,
                                 QCApprovedDate = q.QCApprovedDate
                             }).Distinct().OrderByDescending(x => x.QcApprovalDate).ToList();

                model.ForEach(x =>
                {
                    x.ApprovedAsText = GetApproveStatusList(x.QuoteDetailsId, x.ProStatus, true);
                });
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.ApprovedAsText != null && m.ApprovedAsText.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        ).ToList();
                }
                if (!string.IsNullOrEmpty(fltapprovestatus))
                {
                    model = model.Where(x => x.ApprovedStatus == fltapprovestatus).ToList();
                }
                if (!string.IsNullOrEmpty(searchby) && !string.IsNullOrEmpty(searchbyvalue))
                {
                    searchbyvalue = searchbyvalue.ToLower();

                    if (searchby == "company")
                    {
                        model = model.Where(x => x.CompanyName.ToLower().Contains(searchbyvalue)).ToList();
                    }
                    if (searchby == "productname")
                    {
                        model = model.Where(x => x.ProductName.ToLower().Contains(searchbyvalue)).ToList();
                    }
                    if (searchby == "cas")
                    {
                        model = model.Where(x => x.CASNo != null ? x.CASNo.ToLower().Contains(searchbyvalue) : false).ToList();
                    }
                    if (searchby == "cat")
                    {
                        model = model.Where(x => x.CATNo != null ? x.CATNo.ToLower().Contains(searchbyvalue) : false).ToList();
                    }
                    if (searchby == "batchno")
                    {
                        model = model.Where(x => x.BatchNo != null ? x.BatchNo.ToLower().Contains(searchbyvalue) : false).ToList();
                    }

                }
                //total number of rows count   
                recordsTotal = model.Count();
                //Paging   
                var data = model.Skip(skip).Take(pageSize).ToList();
                //var categoryData = db.Categories.ToList();
                //var productCategoryData = db.Product_Category_Mapping.ToList();
                var proIds = data.Select(x => x.ProductId).Distinct().ToList();
                var inventoryData = db.SZ_Inventory.Where(x => proIds.Contains(x.ProductId)).ToList();
                var productsData = db.Products.Where(x => proIds.Contains(x.Id) && x.Published == true && x.Deleted == false).ToList();
                foreach (var itemObj in data)
                {
                    itemObj.GetAllBatch = "<i class='fa fa-clone' title='View Batch No' onclick='GetAllBatchNo(" + itemObj.ProductId + ", " + itemObj.QuoteDetailsId + ")'></i>";
                    if (itemObj.QcApprovalDate.HasValue)
                    {
                        itemObj.QcApprovalStr = itemObj.QcApprovalDate.Value.ToShortDateString();
                    }
                    var invdataforbatch = inventoryData.Where(x => x.Id == itemObj.AdditionalBatchNo).FirstOrDefault();
                    if (invdataforbatch != null)
                    {
                        if (invdataforbatch.ApprovalDate.HasValue)
                        {
                            itemObj.QcLastApprovalStr = invdataforbatch.ApprovalDate.Value.ToShortDateString();
                        }
                    }
                    if (itemObj.QCApprovedDate.HasValue)
                    {
                        itemObj.QCApprovedDateStr = itemObj.QCApprovedDate.Value.ToShortDateString();
                    }
                    if (!string.IsNullOrEmpty(itemObj.Diff))
                    {
                        foreach (EnumList.DifficultyLevel r in Enum.GetValues(typeof(EnumList.DifficultyLevel)))
                        {
                            var item = Enum.GetName(typeof(EnumList.DifficultyLevel), r);
                            var test = r.ToString();
                            string text = SZ_Helper.GetEnumDescription((EnumList.DifficultyLevel)(int)r);
                            int val = (int)r;
                            if (Convert.ToString(val) == itemObj.Diff)
                            {
                                itemObj.Diff = text;
                            }
                        }
                    }
                    itemObj.AdditionalBatchNoText = "<select id='additionalBatch_" + itemObj.QuoteDetailsId + "' data-quotationdetailsid='" + itemObj.QuoteDetailsId + "' class='dddladditionalbatch'><option value=''>--Select--</option>";
                    if (itemObj.ProductId.HasValue)
                    {
                        var proData = productsData.Where(x => x.Id == itemObj.ProductId).Count();
                        var proBatchData = inventoryData.Where(x => x.ProductId == itemObj.ProductId).ToList();
                        if (proBatchData.Count > 0 && proData > 0)
                        {
                            proBatchData.ForEach(r =>
                            {
                                //var qty = System.Text.RegularExpressions.Regex.Match(Convert.ToString(r.Qty), @"\d+").Value;
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }
                                string selected = string.Empty;
                                if (r.Id == itemObj.AdditionalBatchNo)
                                {
                                    selected = "selected ";
                                    itemObj.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
                                }

                                itemObj.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' " + selected + ">" + text + "</option>";
                            });
                        }
                    }
                    itemObj.AdditionalBatchNoText += "</select>";
                    if (itemObj.AssignDate.HasValue)
                    {
                        itemObj.AssignDatestr = itemObj.AssignDate.Value.ToShortDateString();
                    }
                    if (itemObj.SubmissionDate != null && itemObj.SubmissionDate.HasValue)
                    {
                        itemObj.SubmissionDatestr = itemObj.SubmissionDate.Value.ToShortDateString();
                    }
                    itemObj.APIName = GetApiNameOfProduct(itemObj.ProductId.Value, productsData);
                    //itemObj.CATNo = "<a href='https://www.synzeal.com/search?q=" + itemObj.CATNo + "' target='_blank'>" + itemObj.CATNo + "</a>";
                    itemObj.ApprovedStatusText = GetApproveStatusList(itemObj.QuoteDetailsId, itemObj.ApprovedStatus);
                    itemObj.ApprovedAsText = GetApprovedAsList(itemObj.QuoteDetailsId, itemObj.ApprovedAs);
                    //itemObj.ApprovalCommentsText = "<input type='text' id='approvalcomment_" + itemObj.FormId + "' name='approvalcomment_" + itemObj.FormId + "' value='" + itemObj.ApprovalComments + "' />";
                    itemObj.ApprovalCommentsText = "<i class='fa fa-pencil' onclick='approCommentGenerate(\"" + itemObj.QuoteDetailsId + "\")' ></i>";
                    itemObj.RecommondationRetestText = "<input type='number' id='recommondationretest_" + itemObj.QuoteDetailsId + "' name='recommondationretest_" + itemObj.QuoteDetailsId + "' value='" + itemObj.RecommondationRetest + "' />";
                    itemObj.ChkSaveRow = "<input type='checkbox' value='" + itemObj.QuoteDetailsId + "' class='clsSaverow' />";
                    if (!string.IsNullOrEmpty(itemObj.RbAdditionalAnalysis))
                    {
                        itemObj.IR = itemObj.RbAdditionalAnalysis.Contains("IR") ? "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                        itemObj.Mass = itemObj.RbAdditionalAnalysis.Contains("Mass") ? "<i id='mass_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                        itemObj.HPLCGCELSD = itemObj.RbAdditionalAnalysis.Contains("HPLC/GC/ELSD") ? "<i id='hplc_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                        itemObj.NMR = itemObj.RbAdditionalAnalysis.Contains("NMR") ? "<i id='nmr_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                        itemObj.qNMR = itemObj.RbAdditionalAnalysis.Contains("qNMR") ? "<i id='qnmr_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                        itemObj.TGA = itemObj.RbAdditionalAnalysis.Contains("TGA") ? "<i id='tga_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                        itemObj.CMR = itemObj.RbAdditionalAnalysis.Contains("CMR") ? "<i id='cmr_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                        itemObj.DEPT = itemObj.RbAdditionalAnalysis.Contains("DEPT") ? "<i id='dept_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                        itemObj.HRMS = itemObj.RbAdditionalAnalysis.Contains("HRMS") ? "<i id='hrms_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                        itemObj.ROI = itemObj.RbAdditionalAnalysis.Contains("ROI") ? "<i id='roi_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                        itemObj.Elemental = itemObj.RbAdditionalAnalysis.Contains("Elemental") ? "<i id='elementral_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                        itemObj.SER = itemObj.RbAdditionalAnalysis.Contains("CMR Interpretaion") ? "<i id='ser_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='ir_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                        itemObj.APCIMass = itemObj.RbAdditionalAnalysis.Contains("APCI Mass") ? "<i id='apcimass_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='apcimass_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                        itemObj.NMRInterpretaion = itemObj.RbAdditionalAnalysis.Contains("NMR Interpretaion") ? "<i id='nmrinterpretaion_" + itemObj.QuoteDetailsId + "' class='fa fa-check'></i>" : "<i id='nmrinterpretaion_" + itemObj.QuoteDetailsId + "' class='fa fa-close'></i>";
                    }

                    if (itemObj.Hygroscopic.HasValue && itemObj.Hygroscopic.Value)
                    {
                        itemObj.TextHygroscopic = "<i class='fa fa-check'></i>";
                    }
                    else
                    {
                        itemObj.TextHygroscopic = "<i class='fa fa-close'></i>";
                    }
                    if (itemObj.TempSensitive.HasValue && itemObj.TempSensitive.Value)
                    {
                        itemObj.TextTempSensitive = "<i class='fa fa-check'></i>";
                    }
                    else
                    {
                        itemObj.TextTempSensitive = "<i class='fa fa-close'></i>";
                    }

                    if (itemObj.Lacrymatory.HasValue && itemObj.Lacrymatory.Value)
                    {
                        itemObj.TextLacrymatory = "<i class='fa fa-check'></i>";
                    }
                    else
                    {
                        itemObj.TextLacrymatory = "<i class='fa fa-close'></i>";
                    }
                    if (itemObj.SubmissionDate.HasValue)
                    {
                        itemObj.DraftSubmissionForm = itemObj.SubmissionDate.Value.ToShortDateString();
                    }
                    itemObj.Qty = "<span id='availableqty_" + itemObj.QuoteDetailsId + "'>" + itemObj.Qty + "</span>";
                    itemObj.AvailableData = "<span id='availabledata_" + itemObj.QuoteDetailsId + "'>" + itemObj.AvailableData + "</span>";
                    itemObj.PhysicalState = "<span id='physicalstate_" + itemObj.QuoteDetailsId + "'>" + itemObj.PhysicalState + "</span>";
                    itemObj.Appearance = "<span id='appearance_" + itemObj.QuoteDetailsId + "'>" + itemObj.Appearance + "</span>";
                    var pName = "";
                    var query = queryData.Where(x => x.CATNo.Trim().ToLower() == itemObj.CATNo.Trim().ToLower()).OrderByDescending(x => x.Id);
                    if (query != null && query.Count() > 0)
                    {
                        var qlist = query.Select(x => x.QueryNo).ToArray();
                        if (query.Select(x => x.Status.ToLower()).FirstOrDefault() == "solved" ||
                            query.Select(x => x.Status.ToLower()).FirstOrDefault() == "close" ||
                                     query.Select(x => x.Status.ToLower()).FirstOrDefault() == "completed")
                        {
                            pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + itemObj.CATNo + "\")' title='" + string.Join(", ", qlist) + "' style ='float:right; color: green' ></i>";
                        }
                        else
                        {
                            pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + itemObj.CATNo + "\")' title='" + string.Join(", ", qlist) + "' style ='float:right' ></i>";
                        }
                    }

                    itemObj.IsConversionReport = itemObj.QuoteDetails.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    var impstr = "";
                    if (itemObj.IsConversionReport.HasValue && itemObj.IsConversionReport.Value)
                    {
                        impstr += "<img src='/img/important.jpg' width='15px' height='15px' />";
                    }
                    itemObj.CATNo = pName + "" + "<a href='https://www.synzeal.com/search?q=" + itemObj.CATNo + "' target='_blank'>" + itemObj.CATNo + "</a>" + "" + impstr + "" + CommonOperation.GetMatchingTagHTML(itemObj.QuoteDetails, "QC");
                    itemObj.QuoteDetails = null;
                }

                //total number of rows count   

                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }

        }


        public JsonResult LoadProductCountData()
        {
            string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
            string pursynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
            var quotationDetailsdata = db.SZ_QuotationDetail.AsQueryable();
            var companyList = (from i in db.SZ_Quotation
                               join t2 in quotationDetailsdata on i.Id equals t2.QuoteId
                               where t2.MoveToProject == true
                               && string.IsNullOrEmpty(t2.TrackingNo)
                               && (t2.IsOnHold == false || t2.IsOnHold == null)
                               && (t2.ProjectType != inhouseProjectType || t2.ProjectType == null)
                               select i.CompanyId).Distinct().ToList();

            var datas = (from i in db.SZ_Quotation
                         where companyList.Contains(i.CompanyId)
                         select new
                         {
                             Company = i.CompanyName,
                             Count = i.SZ_QuotationDetail.Where(t2 => t2.MoveToProject == true && string.IsNullOrEmpty(t2.TrackingNo)
                                        && (t2.IsOnHold == false || t2.IsOnHold == null)
                                        && (t2.ProjectType != inhouseProjectType || t2.ProjectType == null)).Count()
                         }).ToList();

            var results = datas.GroupBy(n => new { n.Company })
                .Select(g => new
                {
                    Key = g.Key.Company,
                    Count = g.Sum(x => x.Count)
                }).OrderByDescending(x => x.Count).ToList();

            return Json(results.Where(x => x.Count != 0).ToList(), JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public ActionResult LoadClientApprovedData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                var scinameFilter = Request.Form.GetValues("sciname")[0].ToString();

                var subscinameFilter = Request.Form.GetValues("subsciname")[0].ToString();
                var fltprostatusItem = Request.Form.GetValues("fltprostatusItem")[0].ToString();
                var fltactivity = Request.Form.GetValues("fltactivity")[0].ToString();
                var searchby = string.Empty;
                var searchbyvalue = string.Empty;
                if (Request.Form.GetValues("radiobuton") != null)
                {
                    searchby = Request.Form.GetValues("radiobuton")[0].ToString();
                }
                if (Request.Form.GetValues("searchbox") != null)
                {
                    searchbyvalue = Request.Form.GetValues("searchbox")[0].ToString().Trim();
                }
                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;

                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
                string pursynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
                MemoryCacheManager objCache = new MemoryCacheManager();
                var queryData = objCache.Get("cache.queryData", () =>
                {
                    return db.SZ_QueryModule.AsNoTracking().ToList();
                });
                var quotationDetailsdata = db.SZ_QuotationDetail.AsQueryable();
                // Getting all Customer data  
                //var list = (from i in db.SZ_Quotation
                //            join t2 in quotationDetailsdata on i.Id equals t2.QuoteId
                //            where t2.MoveToProject == true
                //            && (t2.IsOnHold == false || t2.IsOnHold == null)
                //            && (t2.ProjectType != inhouseProjectType || t2.ProjectType == null)
                //            orderby t2.MoveProjectDate descending
                //            select t2).Distinct().AsQueryable();

                var list = (from i in db.SZ_Quotation
                            join t2 in quotationDetailsdata on i.Id equals t2.QuoteId
                            where t2.MoveToProject == true
                            && string.IsNullOrEmpty(t2.TrackingNo)
                            && (t2.IsOnHold == false || t2.IsOnHold == null)
                            && (t2.ProjectType != inhouseProjectType)
                            orderby t2.MoveProjectDate descending
                            select t2).Distinct().AsQueryable();

                list = list.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo);

                var listItems = new List<SelectListItem>();
                var subscilistItems = new List<SelectListItem>();

                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });

                var scienList = objCache.Get("cache.GetScientistId", () =>
                {
                    return db.GetScientistId().ToList();
                });
                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                    subscilistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                });

                ViewBag.ScientistListItem = listItems;
                var subscienList = objCache.Get("cache.subscienList", () =>
                {
                    return db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();
                });

                foreach (var term in subscienList)
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }

                    subscilistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                }
                ViewBag.SubScientistListItem = subscilistItems;
                var proIds = list.Select(x => x.ProductId).Distinct().ToList();
                var masterCOAData = db.SZ_MasterCOA.Where(x => proIds.Contains(x.ProductId)).ToList();
                var masterCoaIds = masterCOAData.Select(x => x.Id).Distinct().ToList();
                var childcoadata = db.SZ_ChildCOA.Where(x => masterCoaIds.Contains(x.MasterCOAID.Value)).ToList();
                var productsData = db.Products.Where(x => proIds.Contains(x.Id) && x.Published == true && x.Deleted == false).ToList();
                var inventoryData = db.SZ_Inventory.Where(x => proIds.Contains(x.ProductId)).ToList();
                var catList = db.Categories.Where(x => x.ParentCategoryId == 0 && x.Deleted == false && x.Published).ToList();
                var ReadyToDeliverScientistStatusId = db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                var model = new List<ProjectListModel>();
                var count = list.Count();
                list.ForEach(k =>
                {
                    ProjectListModel subList = new ProjectListModel();
                    subList.ChkSaveRow = "<input type='checkbox' value='" + k.Id + "' class='clsSaverow' />";
                    subList.ReadyToDeliverScientistStatusId = ReadyToDeliverScientistStatusId;
                    if (k.ApprovedForClient.HasValue && k.ApprovedForClient.Value)
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsClientApproved' checked/>";
                    }
                    else
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsClientApproved' />";
                    }
                    subList.ProjectType = k.ProjectType;
                    subList.ProjectTypeText = "<select id='projecttype_" + k.Id + "' class='clsProjType' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ProjectType), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.ProjectType)
                        {
                            selected = "selected ";
                            subList.SelectedProjectType = text;
                        }

                        //if (text != "In-House")
                        //{
                            subList.ProjectTypeText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                        //}
                    }
                    subList.ProjectTypeText += "</select>";
                    subList.IsPaymentPending = k.SZ_Quotation.SZ_CompanyList.IsPaymentPending;
                    subList.ActivityStatus = k.ActivityStatus;
                    subList.ActivityStatusText = "<select id='activitystatus_" + k.Id + "' class='clsActivityStatus' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";

                    if (k.ActivityStatus == "Approval First")
                    {
                        subList.ActivityStatusText += "<option value='Approval First' selected>Approval First</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Approval First'>Approval First</option>";
                    }
                    if (k.ActivityStatus == "Immediate Dispatch")
                    {
                        subList.ActivityStatusText += "<option value='Immediate Dispatch' selected>Immediate Dispatch</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Immediate Dispatch'>Immediate Dispatch</option>";
                    }

                    if (k.ActivityStatus == "Repeat Order")
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order' selected>Repeat Order</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order'>Repeat Order</option>";
                    }

                    if (k.ActivityStatus == "Repeat Order - Dispatch")
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Dispatch' selected>Repeat Order - Dispatch</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Dispatch'>Repeat Order - Dispatch</option>";
                    }
                    if (k.ActivityStatus == "Repeat Order - Approval First")
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Approval First' selected>Repeat Order - Approval First</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Approval First'>Repeat Order - Approval First</option>";
                    }
                    if (k.ActivityStatus == "Short Qty Dispatch")
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatch' selected>Short Qty Dispatch</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatch'>Short Qty Dispatch</option>";
                    }
                    if (k.ActivityStatus == "Short Qty Dispatched")
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatched' selected>Short Qty Dispatched</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatched'>Short Qty Dispatched</option>";
                    }

                    if (k.ActivityStatus == "Sample Request")
                    {
                        subList.ActivityStatusText += "<option value='Sample Request' selected>Sample Request</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Sample Request'>Sample Request</option>";
                    }
                    if (k.ActivityStatus == "Sample Sent")
                    {
                        subList.ActivityStatusText += "<option value='Sample Sent' selected>Sample Sent</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Sample Sent'>Sample Sent</option>";
                    }
                    if (k.ActivityStatus == "Sample Approved")
                    {
                        subList.ActivityStatusText += "<option value='Sample Approved' selected>Sample Approved</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Sample Approved'>Sample Approved</option>";
                    }
                    //if (k.ActivityStatus == "Insufficient QTY")
                    //{
                    //    subList.ActivityStatusText += "<option value='Insufficient QTY' selected>Insufficient QTY</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Insufficient QTY'>Insufficient QTY</option>";
                    //}
                    if (k.ActivityStatus == "Quote - Data Sent")
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Sent' selected>Quote - Data Sent</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Sent'>Quote - Data Sent</option>";
                    }
                    if (k.ActivityStatus == "Quote - Data Approved")
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Approved' selected>Quote - Data Approved</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Approved'>Quote - Data Approved</option>";
                    }


                    //if (k.ActivityStatus == "Data Approved")
                    //{
                    //    subList.ActivityStatusText += "<option value='Data Approved' selected>Data Approved</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Data Approved'>Data Approved</option>";
                    //}


                    //if (k.ActivityStatus == "Data Sent")
                    //{
                    //    subList.ActivityStatusText += "<option value='Data Sent' selected>Data Sent</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Data Sent'>Data Sent</option>";
                    //}
                    //if (k.ActivityStatus == "Data Correction")
                    //{
                    //    subList.ActivityStatusText += "<option value='Data Correction' selected>Data Correction</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Data Correction'>Data Correction</option>";
                    //}
                    //if (k.ActivityStatus == "Invoice Sent")
                    //{
                    //    subList.ActivityStatusText += "<option value='Invoice Sent' selected>Invoice Sent</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Invoice Sent'>Invoice Sent</option>";
                    //}
                    //if (k.ActivityStatus == "PDC Awaited")
                    //{
                    //    subList.ActivityStatusText += "<option value='PDC Awaited' selected>PDC Awaited</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='PDC Awaited'>PDC Awaited</option>";
                    //}
                    //if (k.ActivityStatus == "Advance Payment")
                    //{
                    //    subList.ActivityStatusText += "<option value='Advance Payment' selected>Advance Payment</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Advance Payment'>Advance Payment</option>";
                    //}
                    //if (k.ActivityStatus == "Payment Due")
                    //{
                    //    subList.ActivityStatusText += "<option value='Payment Due' selected>Payment Due</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Payment Due'>Payment Due</option>";
                    //}


                    subList.ActivityStatusText += "</select>";
                    subList.ScientistName = "<select id='ScientistId_" + k.Id + "' class='scientist' scientistId='" + k.ScientistCustomerId + "' quotedetailsid='" + k.Id + "'><option value=''>--Select--</option>";
                    listItems.ForEach(r =>
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.ScientistCustomerId))
                        {
                            selected = "selected ";
                            subList.SelectedScientistName = r.Text;
                        }
                        subList.ScientistName += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    });

                    subList.ScientistName += "</select>";
                    if (!string.IsNullOrEmpty(k.SubScientistName))
                    {
                        var subsci = System.Text.RegularExpressions.Regex.IsMatch(k.SubScientistName, @"\d+");
                        if (subsci)
                        {
                            if (System.Text.RegularExpressions.Regex.Match(k.SubScientistName, @"\d+").Value == k.SubScientistName)
                            {
                                subList.SubScientistCustomerId = Convert.ToInt32(k.SubScientistName);
                            }
                        }
                    }

                    subList.SubScientistName = "<select id='SubScientistId_" + k.Id + "' class='subscientist' subscientistId='" + k.SubScientistName + "' quotedetailsid='" + k.Id + "'><option value=''>--Select--</option>";
                    subscilistItems.ForEach(r =>
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.SubScientistName))
                        {
                            selected = "selected ";
                            subList.SelectedSubScientistName = r.Text;
                        }
                        subList.SubScientistName += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    });

                    subList.SubScientistName += "</select>";

                    if (!string.IsNullOrEmpty(k.SZ_Quotation.Attachment))
                    {
                        subList.Attachment = "<a href = 'javascript:void(0)' onclick='attachment(" + k.QuoteId + ")'><i class='fa fa-paperclip'></i></a>";
                    }
                    subList.MoveProjectDateText = k.MoveProjectDate.HasValue ? k.MoveProjectDate.Value.ToString("dd/MM/yyyy hh:mm tt") : "";
                    subList.AdditionalBatchNo = k.AdditionalBatchNo;
                    subList.QuoteId = k.QuoteId;
                    subList.ProductId = k.ProductId;
                    subList.ProductName = k.ProductName;
                    subList.ScientistRemark = "<input id='sciremark_" + k.Id + "' type='text' value='" + k.ScientistRemark + "' style='width: 170px' />";
                    subList.RequiredQtyTxt = "<input id='qty_" + k.Id + "' type='text' value='" + k.RequiredQty + "' style='width: 50px; font-weight:bold' />";

                    if (!string.IsNullOrEmpty(k.ExplainationSecond))
                    {
                        subList.ExplainationSecondText = "<input id='explainationsecond_" + k.Id + "' type='text' value='" + k.ExplainationSecond.Replace("'", "&#8242;") + "' title='" + k.ExplainationSecond + "' style='width: 200px; font-weight:bold' />";
                    }
                    else
                    {
                        subList.ExplainationSecondText = "<input id='explainationsecond_" + k.Id + "' type='text' value='" + k.ExplainationSecond + "' title='" + k.ExplainationSecond + "' style='width: 200px; font-weight:bold' />";
                    }

                    subList.ExplainationSecond = k.ExplainationSecond;
                    subList.LastWeekUpdate = k.LastWeekUpdate;
                    subList.PaymentTerms = k.SZ_Quotation.PaymentTerm;
                    subList.AdditionalBatchNoText = "<select id='additionalBatch_" + k.Id + "' data-quotationdetailsid='" + k.Id + "' class='ddladditionalbatch'><option value=''>--Select--</option>";
                    if (subList.ProductId.HasValue)
                    {
                        var proData = productsData.Where(x => x.Id == subList.ProductId).Count();
                        var proBatchData = inventoryData.Where(x => x.ProductId == subList.ProductId).ToList();
                        if (proBatchData.Count > 0 && proData > 0)
                        {
                            proBatchData.ForEach(r =>
                            {
                                //var qty = System.Text.RegularExpressions.Regex.Match(Convert.ToString(r.Qty), @"\d+").Value;
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }
                                string selected = string.Empty;
                                if (r.Id == subList.AdditionalBatchNo)
                                {
                                    selected = "selected ";
                                    subList.BatchNo = r.BatchNo;
                                    subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
                                }
                                subList.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' " + selected + ">" + text + "</option>";
                            });
                        }
                    }
                    subList.AdditionalBatchNoText += "</select>";
                    //subList.BatchNo = k.BatchNo;
                    subList.BatchNoText = "<input id='batchno_" + k.Id + "' type='text' value='" + k.BatchNo + "' style='width:120px' />";
                    subList.IsImageAttach = k.SZ_Quotation.IsImageAttach;
                    subList.CompanyName = k.SZ_Quotation.CompanyName;
                    subList.Email = k.SZ_Quotation.EmailAddress;
                    subList.PONumber = k.SZ_Quotation.PONo;
                    subList.Ref = k.SZ_Quotation.Ref;
                    subList.Remark = k.Remark;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.QuoteDetailsId = k.Id;
                    subList.CASNo = k.CASNo;
                    var pName = "";
                    var query = queryData.Where(x => x.CATNo.Trim().ToLower() == k.CATNo.Trim().ToLower()).OrderByDescending(x => x.Id);
                    if (query != null && query.Count() > 0)
                    {
                        var qlist = query.Select(x => x.QueryNo).ToArray();
                        if (query.Select(x => x.Status.ToLower()).FirstOrDefault() == "solved" ||
                        query.Select(x => x.Status.ToLower()).FirstOrDefault() == "close" ||
                        query.Select(x => x.Status.ToLower()).FirstOrDefault() == "completed")
                        {
                            pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + k.CATNo + "\")' title='" + string.Join(", ", qlist) + "' style ='float:right; color: green' ></i>";
                        }
                        else
                        {
                            pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + k.CATNo + "\")' title='" + string.Join(", ", qlist) + "' style ='float:right' ></i>";
                        }
                    }
                    subList.CATNo = pName + "" + "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>";
                    subList.CreatedDate = k.CreatedDate;
                    subList.ImagePath = k.ImagePath;
                    subList.IsUploadServer = k.IsUploadServer;
                    subList.LeadTime = k.LeadTime;
                    subList.Price = k.Price;
                    subList.QuoteId = k.QuoteId;
                    subList.ProjectType = k.ProjectType;
                    subList.ScientistCustomerId = k.ScientistCustomerId;
                    subList.RequiredQty = k.RequiredQty;
                    subList.ProjectStatus = k.ProjectStatus;
                    subList.IsOnHold = k.IsOnHold;
                    if (k.ProjectStatus != null)
                    {
                        subList.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
                    }
                    subList.ScientistStatus = k.ScientistStatus;
                    subList.BatchCode1 = k.BatchCode1;
                    subList.BatchCode2 = k.BatchCode2;
                    subList.Qty1 = k.Qty1;
                    subList.Qty2 = k.Qty2;
                    subList.EstimateCompleteDate = k.EstimateCompleteDate;
                    subList.EstimateCompleteDateText = "<input id='esticompleteDate_" + k.Id + "' data-value='" + k.EstimateCompleteDate + "' type='text' class='datepicker'  style='width:80px' />";
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToProject = k.MoveToProject;
                    subList.Remark = k.Remark;
                    subList.SrPo = k.SrPo;
                    subList.AdminScientistStatus = k.AdminScientistStatus;
                    subList.InvoiceNo = k.InvoiceNo;
                    subList.InvoiceRemark = k.InvoiceRemark;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.ScientistStatustext = "<input id='scientistStatus_" + k.Id + "' type='text' value='" + k.AdminScientistStatus + "' title='" + k.AdminScientistStatus + "'  style='width:200px' />";
                    subList.RemarkText = "<input id='remark_" + k.Id + "' type='text' value='" + k.Remark + "' title='" + k.Remark + "' style='width: 170px' />";
                    subList.LastRowText = "<a href='javascript: void(0)' id='save_" + k.Id + "' onclick='SaveProjectDetails(\"" + k.Id + "\")'> Save</a> ";
                    subList.LastRowText += "<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";

                    subList.GetAllBatch = "<i class='fa fa-clone' title='View Batch No' onclick='GetAllBatchNo(" + k.ProductId + ", " + k.Id + ")'></i>";
                    subList.DispatchedStatus = k.DispatchedStatus;
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToInvoice = k.MoveToInvoice;
                    subList.IsDispatchApprove = k.IsDispatchApprove;
                    subList.IsPayment = k.IsPayment;
                    if (k.IsPayment.HasValue && k.IsPayment.Value)
                    {
                        subList.IsPaymentText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPayment' checked='checked'/>";
                    }
                    else
                    {
                        subList.IsPaymentText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPayment' />";
                    }

                    subList.OrderRemark = k.OrderRemark;
                    subList.OrderRemarkText = "<input id='orderremark_" + k.Id + "' type='text' value='" + k.OrderRemark + "' title='" + k.OrderRemark + "'  style='width:200px' />";

                    subList.Reason = k.Reason;
                    subList.ReasonText = "<input id='reason_" + k.Id + "' type='text' value='" + k.Reason + "' title='" + k.Reason + "'  style='width:200px' />";

                    if (k.MoveToScientistDate.HasValue)
                    {
                        subList.MoveToScientistDateStr = k.MoveToScientistDate.Value.ToShortDateString();
                    }
                    subList.ClientChat = "<i class='fa fa-pencil' onclick='chatDetails(\"" + k.Id + "\")' ></i>";
                    subList.ExplainationText += "<i class='fa fa-pencil' onclick='explainationGenerate(\"" + k.Id + "\")' ></i>"; //<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";
                    subList.DifficultyLevel = k.DifficultyLevel;
                    subList.DifficultyLevelText = "<select id='difflevel_" + k.Id + "' class='clsDifficultyLevel' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.DifficultyLevel r in Enum.GetValues(typeof(EnumList.DifficultyLevel)))
                    {
                        var item = Enum.GetName(typeof(EnumList.DifficultyLevel), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.DifficultyLevel)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.DifficultyLevel)
                        {
                            selected = "selected ";
                        }
                        subList.DifficultyLevelText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                    }
                    subList.DifficultyLevelText += "</select>";

                    subList.IsPriority = k.IsPriority;
                    if (k.IsPriority.HasValue && k.IsPriority.Value)
                    {
                        subList.IsPriorityText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPriority' checked='checked'/>";
                    }
                    else
                    {
                        subList.IsPriorityText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPriority' />";
                    }
                    subList.ProStatus = k.ProStatus;
                    subList.ProStatusText = "<select id='prostatus_" + k.Id + "' class='clsProjStatus' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.ProStatusDDL r in Enum.GetValues(typeof(EnumList.ProStatusDDL)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ProStatusDDL), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ProStatusDDL)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.ProStatus)
                        {
                            selected = "selected ";
                            subList.SelectedProStatus = text;
                        }
                        subList.ProStatusText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                    }
                    subList.ProStatusText += "</select>";
                    subList.COAId = k.COAId;
                    subList.COARefNumber = k.COARefNumber;
                    string coaText = "";

                    coaText = "<select id='coa_" + k.Id + "' class='addcoa'><option value=''>--Select--</option>";
                    int bId = k.AdditionalBatchNo.HasValue ? k.AdditionalBatchNo.Value : 0;
                    if (bId != 0)
                    {
                        var mastercoa = masterCOAData.Where(x => x.BatchId == bId).FirstOrDefault();
                        if (mastercoa != null)
                        {
                            var listchildcoa = childcoadata.Where(x => x.MasterCOAID == mastercoa.Id).ToList();
                            if (listchildcoa != null && listchildcoa.Count > 0)
                            {
                                foreach (var ccoa in listchildcoa)
                                {
                                    if (k.COAId == ccoa.Id)
                                    {
                                        coaText += "<option value='" + ccoa.Id.ToString() + "' data-value='" + k.AdditionalBatchNo + "' selected>" + ccoa.RefNo + "</option>";
                                    }
                                    else
                                    {
                                        coaText += "<option value='" + ccoa.Id.ToString() + "' data-value='" + k.AdditionalBatchNo + "'>" + ccoa.RefNo + "</option>";
                                    }
                                }
                            }
                        }
                    }
                    subList.COAText = coaText;
                    subList.CompanyId = k.SZ_Quotation.CompanyId;
                    model.Add(subList);
                });

                model = model.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).ThenBy(x => x.SrPo).ToList();
                if (!string.IsNullOrEmpty(scinameFilter))
                {
                    int sciid = Convert.ToInt32(scinameFilter);
                    model = model.Where(x => x.ScientistCustomerId == sciid).ToList();
                }
                if (!string.IsNullOrEmpty(subscinameFilter))
                {
                    int subsciid = Convert.ToInt32(subscinameFilter);
                    model = model.Where(x => x.SubScientistCustomerId == subsciid).ToList();
                }
                if (!string.IsNullOrEmpty(fltprostatusItem))
                {
                    model = model.Where(x => x.ProStatus == fltprostatusItem).ToList();
                }
                if (!string.IsNullOrEmpty(fltactivity))
                {
                    model = model.Where(x => x.ActivityStatus == fltactivity).ToList();
                }

                if (!string.IsNullOrEmpty(searchby) && !string.IsNullOrEmpty(searchbyvalue))
                {
                    searchbyvalue = searchbyvalue.ToLower();
                    if (searchby == "quoteid")
                    {
                        model = model.Where(x => x.Ref.ToLower().Contains(searchbyvalue)).ToList();
                    }
                    if (searchby == "ponumber")
                    {
                        model = model.Where(x => x.PONumber.ToLower().Contains(searchbyvalue)).ToList();
                    }
                    if (searchby == "company")
                    {
                        model = model.Where(x => x.CompanyName.ToLower().Contains(searchbyvalue)).ToList();
                    }
                    if (searchby == "productname")
                    {
                        model = model.Where(x => x.ProductName.ToLower().Contains(searchbyvalue)).ToList();
                    }
                    if (searchby == "cas")
                    {
                        model = model.Where(x => x.CASNo != null ? x.CASNo.ToLower().Contains(searchbyvalue) : false).ToList();
                    }
                    if (searchby == "cat")
                    {
                        model = model.Where(x => x.CATNo != null ? x.CATNo.ToLower().Contains(searchbyvalue) : false).ToList();
                    }
                    if (searchby == "batchno")
                    {
                        model = model.Where(x => x.BatchNo != null ? x.BatchNo.ToLower().Contains(searchbyvalue) : false).ToList();
                    }

                }

                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.SelectedScientistName != null && m.SelectedScientistName.ToLower().Contains(searchValue))
                                        || (m.SelectedSubScientistName != null && m.SelectedSubScientistName.ToLower().Contains(searchValue))
                                        || (m.CompanyName != null && m.CompanyName.ToLower().Contains(searchValue))
                                        || (m.PONumber != null && m.PONumber.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.Price != null && m.Price.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.SelectedProjectType != null && m.SelectedProjectType.ToLower().Contains(searchValue))
                                        || (m.RequiredQty != null && m.RequiredQty.ToLower().Contains(searchValue))
                                        || (m.SelectedAdditionalBatchNo != null && m.SelectedAdditionalBatchNo.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        || (m.MoveProjectDateText != null && m.MoveProjectDateText.ToString().ToLower().Contains(searchValue))
                                        || (m.EstimateCompleteDateText != null && m.EstimateCompleteDateText.ToString().ToLower().Contains(searchValue))
                                        || (m.AdminScientistStatus != null && m.AdminScientistStatus.ToLower().Contains(searchValue))
                                        || (m.ProjectStatustext != null && m.ProjectStatustext.ToLower().Contains(searchValue))
                                        || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                                        || (m.ActivityStatus != null && m.ActivityStatus.ToLower().Contains(searchValue))
                                        || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))).ToList();
                }

                //total number of rows count   
                recordsTotal = model.Count();
                //Paging   
                var data = model.Skip(skip).Take(pageSize).ToList();
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }
        }

        public ActionResult UpdateClientApproved(int id, bool status)
        {
            var data = _operationRepository.GetQuoteDetailByID(id);
            if (data != null)
            {
                data.ApprovedForClient = true;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }

            return Json("success", JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public ActionResult LoadCompanyData(string tabname = "")
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;

                var orderbyIndex = Request.Form.GetValues("order[0][column]").FirstOrDefault();
                var orderby = Request.Form.GetValues("columns[" + orderbyIndex + "][name]").FirstOrDefault();
                var asdesc = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                int recordsTotal = 0;
                //var companyList = db.SZ_CompanyList.AsQueryable();
                //if (!string.IsNullOrEmpty(searchValue))
                //{
                //    companyList = companyList.Where(x => x.Name.Contains(searchValue) ||
                //                                       x.SAPCode.Contains(searchValue) ||
                //                                       x.CountryType.Contains(searchValue) ||
                //                                       x.UserDistType.Contains(searchValue)).AsQueryable();
                //}
                //companyList = companyList.OrderBy(x => x.Name).AsQueryable();

                var model = new List<SZ_CompanyList>();
                var query = db.SZ_CompanyList.Where(x => x.IsBlockCompany == false || x.IsBlockCompany == null).AsQueryable();
                if (tabname == "sapcode")
                {
                    query = query.Where(x => !string.IsNullOrEmpty(x.SAPCode)).AsQueryable();
                }
                if (tabname == "withoutsapcode")
                {
                    query = query.Where(x => string.IsNullOrEmpty(x.SAPCode)).AsQueryable();
                }
                if (tabname == "block")
                {
                    query = db.SZ_CompanyList.Where(x => x.IsBlockCompany == true).AsQueryable();
                }

                model = query.ToList();
                var modelAvailable = db.CompanyMasterList().ToList();


                var modelnotinclude = (from i in model
                                       where !modelAvailable.Contains(i.Name)
                                       select i).AsEnumerable();

                var result = new List<SZ_CompanyList>();
                modelnotinclude.ForEach(item =>
                {
                    item.Name = item.Name + "<sup>*</sup>";
                    result.Add(item);
                });
                modelAvailable.ForEach(item =>
                {
                    var comp = model.Where(x => x.Name == item).FirstOrDefault();
                    result.Add(comp);
                });
                var companyList = result;
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.Trim().ToLower();
                    companyList = companyList.Where(x => x != null && ((x.Name != null && x.Name.Trim().ToLower().Contains(searchValue)) ||
                    (x.MasterEmail != null && x.MasterEmail.Trim().ToLower().Contains(searchValue)) ||
                                                       (x.SAPCode != null && x.SAPCode.Trim().ToLower().Contains(searchValue)) ||
                                                       (x.CountryType != null && x.CountryType.Trim().ToLower().Contains(searchValue)) ||
                                                       (x.UserDistType != null && x.UserDistType.Trim().ToLower().Contains(searchValue)))).ToList();
                }
                if (orderby == "Name")
                {
                    if (asdesc == "asc")
                    {
                        companyList = companyList.OrderBy(x => x.Name).ToList();
                    }
                    else
                    {
                        companyList = companyList.OrderByDescending(x => x.Name).ToList();
                    }
                }
                if (orderby == "SAPCode")
                {
                    if (asdesc == "asc")
                    {
                        companyList = companyList.Where(x => x.SAPCode != null).OrderBy(x => x.SAPCode).ToList();
                    }
                    else
                    {
                        companyList = companyList.Where(x => x.SAPCode != null).OrderByDescending(x => x.SAPCode).ToList();
                    }
                }
                if (orderby == "CountryType")
                {
                    if (asdesc == "asc")
                    {
                        companyList = companyList.OrderBy(x => x.CountryType).ToList();
                    }
                    else
                    {
                        companyList = companyList.OrderByDescending(x => x.CountryType).ToList();
                    }
                }
                if (orderby == "UserDist")
                {
                    if (asdesc == "asc")
                    {
                        companyList = companyList.OrderBy(x => x.UserDistType).ToList();
                    }
                    else
                    {
                        companyList = companyList.OrderByDescending(x => x.UserDistType).ToList();
                    }
                }

                recordsTotal = companyList.Count();
                var outputdata = companyList.Skip(skip).Take(pageSize).ToList();
                var data = new List<CompanyListModel>();
                if (outputdata != null && outputdata.Count > 0)
                {
                    outputdata.ForEach(item =>
                    {
                        if (item != null)
                        {
                            var objModel = new CompanyListModel();
                            objModel.Id = item.Id;
                            objModel.Name = item.Name;
                            objModel.SAPCode = item.SAPCode;
                            objModel.CountryType = item.CountryType;
                            objModel.UserDist = item.UserDistType;
                            objModel.IsBlockCompany = item.IsBlockCompany.HasValue ? item.IsBlockCompany.Value : false;

                            objModel.Action = "<a data-toggle='modal' data-target='#myModal' href ='/Form/AddCompany/" + item.Id + "'> Edit</a> | <a href='javascript:void(0)' onclick='deleteCompany(" + item.Id + ")'> Delete </a> | <a href='/Form/ClientAdmin/" + item.Id + "'> Select</a> | <a data-toggle='modal' data-target='#myModal' href='/Form/TransferCompany/" + item.Id + "'>Transfer</a>";

                            objModel.Firstrow = "<input type='checkbox' value='" + item.Id + "' class='clsSaverow' />";
                            data.Add(objModel);
                        }
                    });
                }
                var jsonResult = Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
                jsonResult.MaxJsonLength = int.MaxValue;
                return jsonResult;
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }
        }

        public ActionResult GetProjectTeamData()
        {
            return Json(CommonOperation.GetCustomerRoleSelectedList("project"), JsonRequestBehavior.AllowGet);
        }

        public ActionResult ViewProductScheme(int productid)
        {
            var productscheme = db.SZ_ProductScheme.Where(x => x.ProductId == productid).OrderByDescending(x => x.CreatedDate).Select(x => x.Scheme).ToList();
            return Json(productscheme, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public ActionResult LoadProductData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                var scinameFilter = Request.Form.GetValues("sciname")[0].ToString();
                var subscinameFilter = Request.Form.GetValues("subsciname")[0].ToString();
                var fltprostatusItem = Request.Form.GetValues("fltprostatusItem")[0].ToString();
                var fltactivity = Request.Form.GetValues("fltactivity")[0].ToString();
                var fltpriority = Request.Form.GetValues("fltpriority")[0].ToString();
                var fltgeographicallocation = Request.Form.GetValues("fltgeographicallocation")[0].ToString();
                var fltprotypeItem = "";
                if (Request.Form.GetValues("fltprotypeItem") != null)
                {
                    fltprotypeItem = Request.Form.GetValues("fltprotypeItem")[0].ToString();
                }
                var fltglp = "";
                if (Request.Form.GetValues("fltglp") != null)
                {
                    fltglp = Request.Form.GetValues("fltglp")[0].ToString();
                }
                var fltestdate = "";
                if (Request.Form.GetValues("fltprotypeItem") != null)
                {
                    fltestdate = Request.Form.GetValues("fltestdate")[0].ToString();
                }
                var searchby = string.Empty;
                var searchbyvalue = string.Empty;
                if (Request.Form.GetValues("radiobuton") != null)
                {
                    searchby = Request.Form.GetValues("radiobuton")[0].ToString();
                }
                if (Request.Form.GetValues("searchbox") != null)
                {
                    searchbyvalue = Request.Form.GetValues("searchbox")[0].ToString().Trim();
                }
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;
                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
                string pursynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);


                //var quotationDetailsdata = db.SZ_QuotationDetail.AsQueryable();
                // Getting all Customer data  

                var list = _operationRepository.LoadProjectData();
                //var list = (from i in db.SZ_Quotation.AsNoTracking()
                //            join t2 in quotationDetailsdata.AsNoTracking() on i.Id equals t2.QuoteId
                //            where t2.MoveToProject == true
                //            && string.IsNullOrEmpty(t2.TrackingNo)
                //            && (t2.IsOnHold == false || t2.IsOnHold == null)
                //            && (t2.ProjectType != inhouseProjectType || t2.ProjectType == null)
                //            && i.CompanyId != 208
                //            orderby t2.MoveProjectDate descending
                //            select t2).Distinct().OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).AsQueryable();

                var listItems = new List<SelectListItem>();
                var subscilistItems = new List<SelectListItem>();
                MemoryCacheManager objCache = new MemoryCacheManager();

                var queryData = objCache.Get("cache.queryData", () =>
                {
                    return db.SZ_QueryModule.AsNoTracking().ToList();
                });

                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.AsNoTracking().Where(x => x.KeyGroup == "Customer").ToList();
                });

                var scienList = objCache.Get("cache.GetScientistId", () =>
                {
                    return db.GetScientistId().ToList();
                });

                var subscienList = objCache.Get("cache.subscienList", () =>
                {
                    return db.Customers.AsNoTracking().Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();
                });
                var projectList = objCache.Get("cache.projectlist", () =>
                {
                    return db.Customers.AsNoTracking().Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("project")).ToList();
                });
                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                    subscilistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                });

                ViewBag.ScientistListItem = listItems;

                subscienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }

                    subscilistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                });
                //foreach (var term in subscienList)
                //{

                //}
                ViewBag.SubScientistListItem = subscilistItems;

                //var proIds = list.Select(x => x.ProductId).Distinct().ToList();
                //var masterCOAData = _operationRepository.LoadMasterCOAData(proIds);
                //var masterCoaIds = masterCOAData.Select(x => x.Id).Distinct().ToList();
                //var childcoadata = _operationRepository.LoadChildCOAData(masterCoaIds);
                //var productsData = _operationRepository.LoadProductData(proIds);
                //var inventoryData = _operationRepository.LoadInventoryData(proIds);
                //var catList = _operationRepository.LoadCategoryData();
                //var customerList = _operationRepository.LoadCompanyData();

                var masterCOAData = objCache.Get("cache.mastercoadata", () =>
                {
                    return _operationRepository.LoadMasterCOAData();
                });
                var childcoadata = objCache.Get("cache.childcoadata", () =>
                {
                    return _operationRepository.LoadChildCOAData();
                });

                var ReadyToDeliverScientistStatusId = objCache.Get("cache.ReadyToDeliverScientistStatusId", () =>
                {
                    return db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                });
                var productsData = objCache.Get("cache.productsdata", () =>
                {
                    return _operationRepository.LoadProductData();
                });
                var inventoryData = objCache.Get("cache.inventoryData", () =>
                {
                    return _operationRepository.LoadInventoryData();
                });
                var catList = objCache.Get("cache.categorydata", () =>
                {
                    return _operationRepository.LoadCategoryData();
                });
                var customerList = objCache.Get("cache.customerdata", () =>
                {
                    return _operationRepository.LoadCompanyData();
                });
                var resQtyList = objCache.Get("cache.resQtyList", () =>
                {
                    return db.SZ_ReservedQty.ToList();
                });
                var proIds = list.Select(x => x.ProductId).Distinct().ToList();
                masterCOAData = masterCOAData.Where(x => proIds.Contains(x.ProductId)).ToList();
                var masterCoaIds = masterCOAData.Select(x => x.Id).Distinct().ToList();
                childcoadata = childcoadata.Where(x => masterCoaIds.Contains(x.MasterCOAID.Value)).ToList();
                productsData = productsData.Where(x => proIds.Contains(x.Id) && x.Published == true && x.Deleted == false).ToList();
                inventoryData = inventoryData.Where(x => proIds.Contains(x.ProductId)).ToList();

                if (!string.IsNullOrEmpty(scinameFilter))
                {
                    int sciid = Convert.ToInt32(scinameFilter);
                    list = list.Where(x => x.ScientistCustomerId == sciid).AsQueryable();
                }
                if (!string.IsNullOrEmpty(subscinameFilter))
                {
                    string subsciid = Convert.ToString(subscinameFilter);
                    list = list.Where(x => x.SubScientistName == subsciid).AsQueryable();
                }
                if (!string.IsNullOrEmpty(fltprostatusItem))
                {
                    if (fltprostatusItem == "blank")
                    {
                        list = list.Where(x => !string.IsNullOrEmpty(x.ProStatus)).AsQueryable();
                    }
                    else
                    {
                        list = list.Where(x => x.ProStatus == fltprostatusItem).AsQueryable();
                    }
                }
                if (!string.IsNullOrEmpty(fltprotypeItem))
                {
                    list = list.Where(x => x.ProjectType == fltprotypeItem).AsQueryable();
                }
                if (!string.IsNullOrEmpty(fltestdate))
                {
                    DateTime estdat = Convert.ToDateTime(fltestdate);
                    list = list.Where(x => x.EstimateCompleteDate == estdat).AsQueryable();
                }

                if (!string.IsNullOrEmpty(fltactivity))
                {
                    list = list.Where(x => x.ActivityStatus == fltactivity).AsQueryable();
                }
                if (!string.IsNullOrEmpty(fltpriority) && fltpriority == "true")
                {
                    list = list.Where(x => x.IsPriority == true).AsQueryable();
                }
                if (!string.IsNullOrEmpty(fltglp))
                {
                    if (fltglp == "Yes")
                    {
                        list = list.Where(x => x.IsGLP == true).AsQueryable();
                    }
                    if (fltglp == "No")
                    {
                        list = list.Where(x => x.IsGLP == false || x.IsGLP == null).AsQueryable();
                    }
                }

                if (!string.IsNullOrEmpty(fltgeographicallocation) && fltgeographicallocation != "false")
                {
                    int gl = Convert.ToInt32(fltgeographicallocation);
                    list = list.Where(x => x.SZ_Quotation.SZ_CompanyList.GeographicalLocation == gl).AsQueryable();
                }

                if (!string.IsNullOrEmpty(searchby) && !string.IsNullOrEmpty(searchbyvalue))
                {
                    searchbyvalue = searchbyvalue.ToLower();
                    if (searchbyvalue.Contains("+"))
                    {
                        List<string> searchlist = searchbyvalue.Split('+').Select(p => p.Trim()).ToList();

                        List<SZ_QuotationDetail> objmodel = new List<SZ_QuotationDetail>();
                        foreach (var item in searchlist)
                        {
                            var d = list.Where(x => x.SZ_Quotation.CompanyName.Contains(item) ||
                                                x.SZ_Quotation.PONo.ToLower().Contains(item) ||
                                                x.ProductName.ToLower().Contains(item) ||
                                                (x.CASNo != null ? x.CASNo.ToLower().Contains(item) : false) ||
                                                (x.CATNo != null ? x.CATNo.ToLower().Contains(item) : false) ||
                                               (x.BatchNo != null ? x.BatchNo.ToLower().Contains(item) : false)).ToList();
                            if (d != null && d.Count > 0)
                            {
                                objmodel.AddRange(d);
                            }
                        }
                        if (objmodel != null && objmodel.Count > 0)
                        {
                            list = objmodel.AsQueryable();
                        }
                    }
                    else
                    {
                        if (searchby == "quoteid")
                        {
                            list = list.Where(x => x.SZ_Quotation.Ref.ToLower().Contains(searchbyvalue)).AsQueryable();
                        }
                        if (searchby == "ponumber")
                        {
                            list = list.Where(x => x.SZ_Quotation.PONo.ToLower().Contains(searchbyvalue)).AsQueryable();
                        }
                        if (searchby == "company")
                        {
                            list = list.Where(x => x.SZ_Quotation.CompanyName.ToLower().Contains(searchbyvalue)).AsQueryable();
                        }
                        if (searchby == "productname")
                        {
                            list = list.Where(x => x.ProductName.ToLower().Contains(searchbyvalue)).AsQueryable();
                        }
                        if (searchby == "cas")
                        {
                            list = list.Where(x => x.CASNo != null ? x.CASNo.ToLower().Contains(searchbyvalue) : false).AsQueryable();
                        }
                        if (searchby == "cat")
                        {
                            list = list.Where(x => x.CATNo != null ? x.CATNo.ToLower().Contains(searchbyvalue) : false).AsQueryable();
                        }
                        if (searchby == "batchno")
                        {
                            var bid = db.SZ_Inventory.Where(x => x.BatchNo.Trim().ToLower() == searchbyvalue).Select(x => x.Id).FirstOrDefault();
                            list = list.Where(x => x.AdditionalBatchNo == bid).AsQueryable();
                        }
                        if (searchby == "other")
                        {
                            list = list.Where(x => x.Remark.ToLower().Contains(searchbyvalue) || x.Reason.ToLower().Contains(searchbyvalue)).AsQueryable();
                        }
                    }
                }

                string internationcompanylist = "";
                if (SessionCookieManagement.IsInternational)
                {
                    internationcompanylist = db.SZ_UserManagement.AsNoTracking().Where(x => x.UserId == SessionCookieManagement.UserId).Select(x => x.CompanyIds).FirstOrDefault();
                    if (!string.IsNullOrEmpty(internationcompanylist))
                    {
                        List<int?> cidList = new List<int?>();
                        foreach (var item in internationcompanylist.Split(','))
                        {
                            if (!string.IsNullOrEmpty(item))
                            {
                                cidList.Add(Convert.ToInt32(item));
                            }
                        }
                        list = list.Where(x => cidList.Contains(x.SZ_Quotation.CompanyId) && x.SZ_Quotation.CreatedDate >= new DateTime(2022, 05, 01)).AsQueryable();
                    }
                }

                recordsTotal = list.Count();

                var outlist = list.Skip(() => skip).Take(() => pageSize);

                //var outlist = list.Skip(skip).Take(pageSize).ToList();
                var model = new List<ProjectListModel>();
                var proids = outlist.Select(x => x.ProductId).ToList();
                var maincatnamelist = (from i in productsData
                                       where proids.Contains(i.Id)
                                       select new
                                       {
                                           Id = i.Id,
                                           MainCatName = i.MainCatName,
                                           CASNo = i.ManufacturerPartNumber
                                       }).ToList();
                var szSAPrawmaterial = (from i in db.SZ_SAPProjectNameData.ToList()
                                        join t2 in maincatnamelist on i.ProjectName equals t2.MainCatName
                                        select t2.Id).ToList();

                outlist.ForEach(k =>
                {
                    ProjectListModel subList = new ProjectListModel();

                    if (k.SZ_ReactionMatrix != null && k.SZ_ReactionMatrix.Count > 0)
                    {
                        subList.Attachment = "<a href = 'javascript:void(0)' onclick='showreactionmatrix(" + k.Id + ")'><i class='fa fa-paperclip'></i></a>";
                    }

                    if (k.ProductId.HasValue && szSAPrawmaterial.Contains(k.ProductId.Value))
                    {
                        //subList.SAPRawMaterial = "<a href = 'javascript:void(0)' onclick='getrawmaterialdata(" + k.ProductId + ")'><img src='/img/flask-icon.png' style='width:16px; height: 16px;' /></a>";
                        subList.SAPRawMaterial = "<a href = 'javascript:void(0)' onclick='getrawmaterialdatabyproject(" + k.ProductId + ")'><i class='fa fa-flask'></i></a>";
                    }

                    subList.GLP = "<select id='IsGLP_" + k.Id + "' class='clsIsGLP' data-quoteDetailsId='" + k.Id + "'><option value='false'>No</option>";
                    if (k.IsGLP.HasValue && k.IsGLP.Value)
                    {
                        subList.GLP += "<option value='true' selected>Yes</option>";
                    }
                    else
                    {
                        subList.GLP += "<option value='true'>Yes</option>";
                    }
                    subList.GLP += "</select>";
                    subList.GLPRemark = "<i class='fa fa-pencil' onclick='GLPRemarkGenerate(\"" + k.Id + "\")' ></i>"; //<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";
                    subList.GLPStatus = "<select id='GLPStatus_" + k.Id + "' class='clsGLPStatus' data-quoteDetailsId='" + k.Id + "'>";
                    if (k.GLPStatus.HasValue && k.GLPStatus.Value == 1)
                    {
                        subList.GLPStatus += "<option value='1' selected>Pending</option>";
                    }
                    else
                    {
                        subList.GLPStatus += "<option value='1'>Pending</option>";
                    }
                    if (k.GLPStatus.HasValue && k.GLPStatus.Value == 2)
                    {
                        subList.GLPStatus += "<option value='2' selected>Release</option>";
                    }
                    else
                    {
                        subList.GLPStatus += "<option value='2'>Release</option>";
                    }
                    if (k.GLPStatus.HasValue && k.GLPStatus.Value == 3)
                    {
                        subList.GLPStatus += "<option value='3' selected>Reject</option>";
                    }
                    else
                    {
                        subList.GLPStatus += "<option value='3'>Reject</option>";
                    }
                    subList.GLPStatus += "</select>";

                    subList.IsConversionReport = k.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    subList.SAPCode = k.SZ_Quotation.SZ_CompanyList.SAPCode;
                    subList.CountEstDate = k.CountEstDate.HasValue ? k.CountEstDate.Value : 0;
                    subList.ChkSaveRow = "<input type='checkbox' value='" + k.Id + "' class='clsSaverow' />";
                    subList.ReadyToDeliverScientistStatusId = ReadyToDeliverScientistStatusId;
                    if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == subList.ReadyToDeliverScientistStatusId && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                    {
                        subList.ChkFirstRow = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                    }
                    else if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == subList.ReadyToDeliverScientistStatusId)
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' />";
                    }
                    else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && (k.MoveToDispatch == null || k.MoveToDispatch == false))
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' />";
                    }
                    else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                    {
                        subList.ChkFirstRow = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                    }
                    if (k.IsDispatchApprove.HasValue && k.IsDispatchApprove.Value && (k.MoveToDispatch == null || k.MoveToDispatch == false))
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' style='outline: 4px solid #c00'/>";
                    }

                    if (k.IsCancel.HasValue && k.IsCancel.Value)
                    {
                        subList.ChkFirstRow = "";
                        subList.ChkSaveRow = "";
                    }

                    subList.ProjectType = k.ProjectType;
                    subList.ApprovedForClient = k.ApprovedForClient;
                    if (k.ApprovedForClient.HasValue && k.ApprovedForClient.Value)
                    {
                        subList.ApprovedForClientText = "<input type='checkbox' value='" + k.Id + "' class='clsApprovedForClient' checked='checked'/>";
                    }
                    else
                    {
                        subList.ApprovedForClientText = "<input type='checkbox' value='" + k.Id + "' class='clsApprovedForClient' />";
                    }
                    subList.ProjectTypeText = "<select id='projecttype_" + k.Id + "' class='clsProjType' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ProjectType), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.ProjectType)
                        {
                            selected = "selected ";
                            subList.SelectedProjectType = text;
                        }
                        //if (text != "In-House")
                        //{
                            subList.ProjectTypeText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                        //}
                    }
                    subList.ProjectTypeText += "</select>";
                    subList.IsPaymentPending = k.SZ_Quotation.SZ_CompanyList.IsPaymentPending;
                    subList.ActivityStatus = k.ActivityStatus;
                    subList.TechnicalEmail = k.TechnicalEmail;
                    subList.ActivityStatusText = "<select id='activitystatus_" + k.Id + "' class='clsActivityStatus' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    if (k.ActivityStatus == "Approval First")
                    {
                        subList.ActivityStatusText += "<option value='Approval First' selected>Approval First</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Approval First'>Approval First</option>";
                    }
                    if (k.ActivityStatus == "Immediate Dispatch")
                    {
                        subList.ActivityStatusText += "<option value='Immediate Dispatch' selected>Immediate Dispatch</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Immediate Dispatch'>Immediate Dispatch</option>";
                    }

                    if (k.ActivityStatus == "Repeat Order")
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order' selected>Repeat Order</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order'>Repeat Order</option>";
                    }

                    if (k.ActivityStatus == "Repeat Order - Dispatch")
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Dispatch' selected>Repeat Order - Dispatch</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Dispatch'>Repeat Order - Dispatch</option>";
                    }
                    if (k.ActivityStatus == "Repeat Order - Approval First")
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Approval First' selected>Repeat Order - Approval First</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Approval First'>Repeat Order - Approval First</option>";
                    }
                    if (k.ActivityStatus == "Short Qty Dispatch")
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatch' selected>Short Qty Dispatch</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatch'>Short Qty Dispatch</option>";
                    }
                    if (k.ActivityStatus == "Short Qty Dispatched")
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatched' selected>Short Qty Dispatched</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatched'>Short Qty Dispatched</option>";
                    }
                    if (k.ActivityStatus == "Sample Request")
                    {
                        subList.ActivityStatusText += "<option value='Sample Request' selected>Sample Request</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Sample Request'>Sample Request</option>";
                    }
                    if (k.ActivityStatus == "Sample Sent")
                    {
                        subList.ActivityStatusText += "<option value='Sample Sent' selected>Sample Sent</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Sample Sent'>Sample Sent</option>";
                    }
                    if (k.ActivityStatus == "Sample Approved")
                    {
                        subList.ActivityStatusText += "<option value='Sample Approved' selected>Sample Approved</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Sample Approved'>Sample Approved</option>";
                    }
                    //if (k.ActivityStatus == "Insufficient QTY")
                    //{
                    //    subList.ActivityStatusText += "<option value='Insufficient QTY' selected>Insufficient QTY</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Insufficient QTY'>Insufficient QTY</option>";
                    //}
                    if (k.ActivityStatus == "Quote - Data Sent")
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Sent' selected>Quote - Data Sent</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Sent'>Quote - Data Sent</option>";
                    }
                    if (k.ActivityStatus == "Quote - Data Approved")
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Approved' selected>Quote - Data Approved</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Approved'>Quote - Data Approved</option>";
                    }
                    subList.ActivityStatusText += "</select>";
                    //subList.APIName = GetApiNameOfProduct(k.ProductId.Value, proCat, catList);
                    subList.ScientistName = "<select id='ScientistId_" + k.Id + "' class='scientist' scientistId='" + k.ScientistCustomerId + "' quotedetailsid='" + k.Id + "'><option value=''>--Select--</option>";
                    listItems.ForEach(r =>
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.ScientistCustomerId))
                        {
                            selected = "selected ";
                            subList.SelectedScientistName = r.Text;
                        }
                        subList.ScientistName += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    });

                    subList.ScientistName += "</select>";
                    if (!string.IsNullOrEmpty(k.SubScientistName))
                    {
                        var subsci = System.Text.RegularExpressions.Regex.IsMatch(k.SubScientistName, @"\d+");
                        if (subsci)
                        {
                            if (System.Text.RegularExpressions.Regex.Match(k.SubScientistName, @"\d+").Value == k.SubScientistName)
                            {
                                subList.SubScientistCustomerId = Convert.ToInt32(k.SubScientistName);
                            }
                        }
                    }

                    subList.SubScientistName = "<select id='SubScientistId_" + k.Id + "' class='subscientist' subscientistId='" + k.SubScientistName + "' quotedetailsid='" + k.Id + "'><option value=''>--Select--</option>";
                    subscilistItems.ForEach(r =>
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.SubScientistName))
                        {
                            selected = "selected ";
                            subList.SelectedSubScientistName = r.Text;
                        }
                        subList.SubScientistName += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    });

                    subList.SubScientistName += "</select>";

                    if (!string.IsNullOrEmpty(k.SZ_Quotation.Attachment))
                    {
                        subList.Attachment = "<a href = 'javascript:void(0)' onclick='attachment(" + k.QuoteId + ")'><i class='fa fa-paperclip'></i></a>";
                    }
                    subList.MoveProjectDateText = k.MoveProjectDate.HasValue ? k.MoveProjectDate.Value.ToString("dd/MM/yyyy hh:mm tt") : "";
                    subList.AdditionalBatchNo = k.AdditionalBatchNo;
                    subList.QuoteId = k.QuoteId;
                    subList.ProductId = k.ProductId;
                    subList.ProductName = k.ProductName;
                    subList.ScientistRemark = "<input id='sciremark_" + k.Id + "' type='text' value='" + k.ScientistRemark + "' style='width: 170px' />";
                    subList.RequiredQtyTxt = "<input id='qty_" + k.Id + "' type='text' value='" + k.RequiredQty + "' style='width: 50px; font-weight:bold' />";

                    if (!string.IsNullOrEmpty(k.ExplainationSecond))
                    {
                        subList.ExplainationSecondText = "<input id='explainationsecond_" + k.Id + "' type='text' value='" + k.ExplainationSecond.Replace("'", "&#8242;") + "' title='" + k.ExplainationSecond + "' style='width: 200px; font-weight:bold' />";
                    }
                    else
                    {
                        subList.ExplainationSecondText = "<input id='explainationsecond_" + k.Id + "' type='text' value='" + k.ExplainationSecond + "' title='" + k.ExplainationSecond + "' style='width: 200px; font-weight:bold' />";
                    }

                    subList.ExplainationSecond = k.ExplainationSecond;
                    subList.LastWeekUpdate = k.LastWeekUpdate;
                    subList.PaymentTerms = k.SZ_Quotation.PaymentTerm;
                    subList.AdditionalBatchNoText = "<select id='additionalBatch_" + k.Id + "' data-quotationdetailsid='" + k.Id + "' class='ddladditionalbatch'><option value=''>--Select--</option>";
                    if (subList.ProductId.HasValue)
                    {
                        var proData = productsData.Where(x => x.Id == subList.ProductId).FirstOrDefault();
                        if (proData != null)
                        {
                            subList.IsControlledSubstance = proData.IsControlledSubstance;
                            if (!subList.IsControlledSubstance.HasValue
                                || subList.IsControlledSubstance == false)
                            {
                                subList.IsControlledSubstance = proData.IsManuallyControlledSubstance;
                            }
                        }
                        if (proData != null && proData.SZ_ProductScheme != null && proData.SZ_ProductScheme.Count > 0)
                        {
                            subList.ProductScheme = "<i class='fa fa-eye' onclick='ViewProductScheme(" + k.ProductId + ")' ></i>";
                        }
                        var proBatchData = inventoryData.Where(x => x.ProductId == subList.ProductId).ToList();
                        if (proBatchData.Count > 0 && proData != null)
                        {
                            proBatchData.ForEach(r =>
                            {
                                //var qty = System.Text.RegularExpressions.Regex.Match(Convert.ToString(r.Qty), @"\d+").Value;
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty;
                                var resdetail = resQtyList.Where(x => x.BatchId == r.Id).Sum(x => x.Qty);
                                if (resdetail > 0)
                                {
                                    text += " - " + resdetail;
                                }

                                text += ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }

                                string selected = string.Empty;
                                if (r.Id == subList.AdditionalBatchNo)
                                {
                                    selected = "selected ";
                                    subList.BatchNo = r.BatchNo;
                                    subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
                                }
                                subList.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' " + selected + ">" + text + "</option>";
                            });
                        }
                    }
                    subList.AdditionalBatchNoText += "</select>   <i class='fa fa-list-alt' onclick='DispatchedSummaryDetail(\"" + k.Id + "\")' ></i>";
                    //subList.BatchNo = k.BatchNo;
                    subList.BatchNoText = "<input id='batchno_" + k.Id + "' type='text' value='" + k.BatchNo + "' style='width:120px' />";
                    subList.IsImageAttach = k.SZ_Quotation.IsImageAttach;
                    subList.CompanyName = k.SZ_Quotation.CompanyName;
                    if (k.SZ_Quotation.SZ_CompanyList.ProjectTeam.HasValue)
                    {
                        //var projectuser = projectList.Where(x => x.Id == k.SZ_Quotation.SZ_CompanyList.ProjectTeam).FirstOrDefault();
                        //if (projectuser != null)
                        //{
                        string customerName = string.Empty;
                        var genericAttr = genericData.Where(x => x.EntityId == k.SZ_Quotation.SZ_CompanyList.ProjectTeam.Value).ToList();
                        if (genericAttr.Count > 0)
                        {
                            customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                        }
                        subList.ProjectAssignName = customerName;
                        //}
                    }
                    subList.Email = k.SZ_Quotation.EmailAddress;
                    subList.PONumber = k.SZ_Quotation.PONo;
                    subList.Ref = k.SZ_Quotation.Ref;
                    subList.Remark = k.Remark;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.QuoteDetailsId = k.Id;
                    subList.CASNo = k.CASNo;
                    var pName = "";
                    var query = queryData.Where(x => x.CATNo.Trim().ToLower() == k.CATNo.Trim().ToLower()).OrderByDescending(x => x.Id);
                    if (query != null && query.Count() > 0)
                    {
                        var qlist = query.Select(x => x.QueryNo).ToArray();
                        if (query.Select(x => x.Status.ToLower()).FirstOrDefault() == "solved" ||
                        query.Select(x => x.Status.ToLower()).FirstOrDefault() == "close" ||
                        query.Select(x => x.Status.ToLower()).FirstOrDefault() == "completed")
                        {
                            pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + k.CATNo + "\")' title='" + string.Join(", ", qlist) + "' style ='float:right; color: green' ></i>";
                        }
                        else
                        {
                            pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + k.CATNo + "\")' title='" + string.Join(", ", qlist) + "' style ='float:right' ></i>";
                        }
                    }

                    subList.IsConversionReport = k.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    var impstr = "";
                    if (subList.IsConversionReport.HasValue && subList.IsConversionReport.Value)
                    {
                        impstr += "<img src='/img/important.jpg' width='15px' height='15px' />";
                    }
                    subList.CATNo = pName + "" + "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>  <i class='fa fa-search' onclick='SearchDefault(\"cat\", \"" + k.CATNo + "\")' ></i>" + impstr + " " + CommonOperation.GetMatchingTagHTML(k, "Project");
                    subList.CreatedDate = k.CreatedDate;
                    subList.ImagePath = k.ImagePath;
                    subList.IsUploadServer = k.IsUploadServer;
                    subList.LeadTime = k.LeadTime;
                    subList.Price = k.Price;
                    subList.QuoteId = k.QuoteId;
                    subList.ProjectType = k.ProjectType;
                    subList.ScientistCustomerId = k.ScientistCustomerId;
                    subList.RequiredQty = k.RequiredQty;
                    subList.ProjectStatus = k.ProjectStatus;
                    subList.IsOnHold = k.IsOnHold;
                    if (k.ProjectStatus != null)
                    {
                        subList.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
                    }
                    subList.ScientistStatus = k.ScientistStatus;
                    subList.BatchCode1 = k.BatchCode1;
                    subList.BatchCode2 = k.BatchCode2;
                    subList.Qty1 = k.Qty1;
                    subList.Qty2 = k.Qty2;
                    subList.EstimateCompleteDate = k.EstimateCompleteDate;
                    subList.EstimateCompleteDateText = "<input id='esticompleteDate_" + k.Id + "' data-value='" + k.EstimateCompleteDate + "' type='text' class='datepicker'  style='width:80px' />";
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToProject = k.MoveToProject;
                    subList.Remark = k.Remark;
                    subList.SrPo = k.SrPo;
                    subList.AdminScientistStatus = k.AdminScientistStatus;
                    subList.InvoiceNo = k.InvoiceNo;
                    subList.InvoiceRemark = k.InvoiceRemark;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.ScientistStatustext = "<input id='scientistStatus_" + k.Id + "' type='text' value='" + k.AdminScientistStatus + "' title='" + k.AdminScientistStatus + "'  style='width:200px' />";
                    subList.RemarkText = "<input id='remark_" + k.Id + "' type='text' value='" + k.Remark + "' title='" + k.Remark + "' style='width: 170px' />";
                    subList.LastRowText = "<a href='javascript: void(0)' id='save_" + k.Id + "' onclick='SaveProjectDetails(\"" + k.Id + "\")'> Save</a> ";
                    subList.LastRowText += "<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";

                    subList.GetAllBatch = "<i class='fa fa-clone' title='View Batch No' onclick='GetAllBatchNo(" + k.ProductId + ", " + k.Id + ")'></i>";
                    subList.DispatchedStatus = k.DispatchedStatus;
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToInvoice = k.MoveToInvoice;
                    subList.IsDispatchApprove = k.IsDispatchApprove;
                    subList.IsPayment = k.IsPayment;
                    if (k.IsPayment.HasValue && k.IsPayment.Value)
                    {
                        subList.IsPaymentText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPayment' checked='checked'/>";
                    }
                    else
                    {
                        subList.IsPaymentText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPayment' />";
                    }

                    subList.OrderRemark = k.OrderRemark;
                    subList.OrderRemarkText = "<input id='orderremark_" + k.Id + "' type='text' value='" + k.OrderRemark + "' title='" + k.OrderRemark + "'  style='width:200px' />";

                    subList.Reason = k.Reason;
                    subList.ReasonText = "<input id='reason_" + k.Id + "' type='text' value='" + k.Reason + "' title='" + k.Reason + "'  style='width:200px' />";

                    if (k.MoveToScientistDate.HasValue)
                    {
                        subList.MoveToScientistDateStr = k.MoveToScientistDate.Value.ToShortDateString();
                    }

                    subList.InhouseRemarkText = "<i class='fa fa-pencil' onclick='InhouseRemarkGenerate(\"" + k.Id + "\")' ></i>"; //<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";
                    subList.ExplainationText += "<i class='fa fa-pencil' onclick='explainationGenerate(\"" + k.Id + "\")' ></i>"; //<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";
                    subList.DifficultyLevel = k.DifficultyLevel;
                    subList.DifficultyLevelText = "<select id='difflevel_" + k.Id + "' class='clsDifficultyLevel' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.DifficultyLevel r in Enum.GetValues(typeof(EnumList.DifficultyLevel)))
                    {
                        var item = Enum.GetName(typeof(EnumList.DifficultyLevel), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.DifficultyLevel)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.DifficultyLevel)
                        {
                            selected = "selected ";
                        }
                        subList.DifficultyLevelText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                    }
                    subList.DifficultyLevelText += "</select>";

                    subList.IsPriority = k.IsPriority;
                    if (k.IsPriority.HasValue && k.IsPriority.Value)
                    {
                        subList.IsPriorityText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPriority' checked='checked'/>";
                    }
                    else
                    {
                        subList.IsPriorityText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPriority' />";
                    }
                    subList.ProStatus = k.ProStatus;
                    subList.ProStatusText = "<select id='prostatus_" + k.Id + "' class='clsProjStatus' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.ProStatusDDL r in Enum.GetValues(typeof(EnumList.ProStatusDDL)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ProStatusDDL), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ProStatusDDL)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.ProStatus)
                        {
                            selected = "selected ";
                            subList.SelectedProStatus = text;
                        }
                        subList.ProStatusText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                    }
                    subList.ProStatusText += "</select>";
                    subList.COAId = k.COAId;
                    subList.COARefNumber = k.COARefNumber;
                    string coaText = "";

                    coaText = "<select id='coa_" + k.Id + "' class='addcoa'><option value=''>--Select--</option>";
                    int bId = k.AdditionalBatchNo.HasValue ? k.AdditionalBatchNo.Value : 0;
                    if (bId != 0)
                    {
                        var mastercoa = masterCOAData.Where(x => x.BatchId == bId).FirstOrDefault();
                        if (mastercoa != null)
                        {
                            var listchildcoa = childcoadata.Where(x => x.MasterCOAID == mastercoa.Id).ToList();
                            if (listchildcoa != null && listchildcoa.Count > 0)
                            {
                                foreach (var ccoa in listchildcoa)
                                {
                                    if (k.COAId == ccoa.Id)
                                    {
                                        coaText += "<option value='" + ccoa.Id.ToString() + "' data-value='" + k.AdditionalBatchNo + "' selected>" + ccoa.RefNo + "</option>";
                                    }
                                    else
                                    {
                                        coaText += "<option value='" + ccoa.Id.ToString() + "' data-value='" + k.AdditionalBatchNo + "'>" + ccoa.RefNo + "</option>";
                                    }
                                }
                            }
                        }
                    }
                    subList.COAText = coaText;
                    subList.CompanyId = k.SZ_Quotation.CompanyId;

                    if (k.SynStartDate.HasValue)
                    {
                        subList.SynStartDate = k.SynStartDate.Value.ToShortDateString();
                    }

                    model.Add(subList);
                });

                model = model.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).ToList();

                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.SelectedScientistName != null && m.SelectedScientistName.ToLower().Contains(searchValue))
                                        || (m.SelectedSubScientistName != null && m.SelectedSubScientistName.ToLower().Contains(searchValue))
                                        || (m.CompanyName != null && m.CompanyName.ToLower().Contains(searchValue))
                                        || (m.PONumber != null && m.PONumber.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.Price != null && m.Price.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.SelectedProjectType != null && m.SelectedProjectType.ToLower().Contains(searchValue))
                                        || (m.RequiredQty != null && m.RequiredQty.ToLower().Contains(searchValue))
                                        || (m.SelectedAdditionalBatchNo != null && m.SelectedAdditionalBatchNo.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        || (m.MoveProjectDateText != null && m.MoveProjectDateText.ToString().ToLower().Contains(searchValue))
                                        || (m.EstimateCompleteDateText != null && m.EstimateCompleteDateText.ToString().ToLower().Contains(searchValue))
                                        || (m.AdminScientistStatus != null && m.AdminScientistStatus.ToLower().Contains(searchValue))
                                        || (m.ProjectStatustext != null && m.ProjectStatustext.ToLower().Contains(searchValue))
                                        || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                                        || (m.ActivityStatus != null && m.ActivityStatus.ToLower().Contains(searchValue))
                                        || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))).ToList();
                }

                //recordsTotal = model.Count();
                //var data = model.Skip(skip).Take(pageSize).ToList();
                var data = model;

                var jsonResult = Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
                jsonResult.MaxJsonLength = int.MaxValue;
                return jsonResult;
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }
        }
        public ActionResult ExportProjectList(string parameter = "",
            string parameterradio = "",
            string ScientistListItem = "",
            string SubScientistListItem = "",
            string fltactivity = "",
            string fltprostatusItem = "",
            string fltprotypeItem = "",
            string fltgeographicallocation = "",
            string fltestdate = "",
            string fltglp = "",
            bool chkpriority = false,
            string ProjectTeam = "")
        {
            var listItems = new List<SelectListItem>();
            var subscilistItems = new List<SelectListItem>();
            MemoryCacheManager objCache = new MemoryCacheManager();
            string instockType = Convert.ToString((int)EnumList.ProjectType.InStock);
            string searchby = "";
            string searchbyvalue = "";
            var queryData = objCache.Get("cache.queryData", () =>
            {
                return db.SZ_QueryModule.AsNoTracking().ToList();
            });

            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.AsNoTracking().Where(x => x.KeyGroup == "Customer").ToList();
            });

            var scienList = objCache.Get("cache.GetScientistId", () =>
            {
                return db.GetScientistId().ToList();
            });

            var subscienList = objCache.Get("cache.subscienList", () =>
            {
                return db.Customers.AsNoTracking().Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();
            });
            scienList.ForEach(term =>
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                listItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.ToString()
                });
                subscilistItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.ToString()
                });
            });

            ViewBag.ScientistListItem = listItems;

            subscienList.ForEach(term =>
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == term.Id).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }

                subscilistItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.Id.ToString()
                });
            });
            var inventoryData = objCache.Get("cache.inventoryData", () =>
            {
                return _operationRepository.LoadInventoryData();
            });

            var list = _operationRepository.LoadProjectData();

            if (!string.IsNullOrEmpty(ScientistListItem))
            {
                int sciid = Convert.ToInt32(ScientistListItem);
                list = list.Where(x => x.ScientistCustomerId == sciid).AsQueryable();
            }
            if (!string.IsNullOrEmpty(SubScientistListItem))
            {
                string subsciid = Convert.ToString(SubScientistListItem);
                list = list.Where(x => x.SubScientistName == subsciid).AsQueryable();
            }
            if (!string.IsNullOrEmpty(fltprostatusItem))
            {
                if (fltprostatusItem == "blank")
                {
                    list = list.Where(x => !string.IsNullOrEmpty(x.ProStatus)).AsQueryable();
                }
                else
                {
                    list = list.Where(x => x.ProStatus == fltprostatusItem).AsQueryable();
                }
            }
            if (!string.IsNullOrEmpty(fltprotypeItem))
            {
                if (fltprotypeItem == "111")
                {
                    list = list.Where(x => x.ProjectType != instockType).AsQueryable();
                }
                else
                {
                    list = list.Where(x => x.ProjectType == fltprotypeItem).AsQueryable();
                }
            }
            if (!string.IsNullOrEmpty(fltestdate))
            {
                DateTime estdat = Convert.ToDateTime(fltestdate);
                list = list.Where(x => x.EstimateCompleteDate <= estdat).AsQueryable();
            }

            if (!string.IsNullOrEmpty(fltactivity))
            {
                list = list.Where(x => x.ActivityStatus == fltactivity).AsQueryable();
            }

            if (!string.IsNullOrEmpty(fltglp))
            {
                if (fltglp == "Yes")
                {
                    list = list.Where(x => x.IsGLP == true).AsQueryable();
                }
                if (fltglp == "No")
                {
                    list = list.Where(x => x.IsGLP == false || x.IsGLP == null).AsQueryable();
                }
            }

            if (!string.IsNullOrEmpty(fltgeographicallocation) && fltgeographicallocation != "false")
            {
                int gl = Convert.ToInt32(fltgeographicallocation);
                list = list.Where(x => x.SZ_Quotation.SZ_CompanyList.GeographicalLocation == gl).AsQueryable();
            }

            if (!string.IsNullOrEmpty(ProjectTeam) && ProjectTeam != "undefined")
            {
                int sciid = Convert.ToInt32(ProjectTeam);
                list = list.Where(x => x.SZ_Quotation.SZ_CompanyList.ProjectTeam == sciid).AsQueryable();
            }
            if (chkpriority == true)
            {
                list = list.Where(x => x.IsPriority == true).AsQueryable();
            }

            if (!string.IsNullOrEmpty(searchby) && !string.IsNullOrEmpty(searchbyvalue))
            {
                searchbyvalue = searchbyvalue.ToLower();
                if (searchbyvalue.Contains("+"))
                {
                    List<string> searchlist = searchbyvalue.Split('+').Select(p => p.Trim()).ToList();

                    List<SZ_QuotationDetail> objmodel = new List<SZ_QuotationDetail>();
                    foreach (var item in searchlist)
                    {
                        var d = list.Where(x => x.SZ_Quotation.CompanyName.Contains(item) ||
                                            x.SZ_Quotation.PONo.ToLower().Contains(item) ||
                                            x.ProductName.ToLower().Contains(item) ||
                                            (x.CASNo != null ? x.CASNo.ToLower().Contains(item) : false) ||
                                            (x.CATNo != null ? x.CATNo.ToLower().Contains(item) : false) ||
                                           (x.BatchNo != null ? x.BatchNo.ToLower().Contains(item) : false)).ToList();
                        if (d != null && d.Count > 0)
                        {
                            objmodel.AddRange(d);
                        }
                    }
                    if (objmodel != null && objmodel.Count > 0)
                    {
                        list = objmodel.AsQueryable();
                    }
                }
                else
                {
                    if (searchby == "quoteid")
                    {
                        list = list.Where(x => x.SZ_Quotation.Ref.ToLower().Contains(searchbyvalue)).AsQueryable();
                    }
                    if (searchby == "ponumber")
                    {
                        list = list.Where(x => x.SZ_Quotation.PONo.ToLower().Contains(searchbyvalue)).AsQueryable();
                    }
                    if (searchby == "company")
                    {
                        list = list.Where(x => x.SZ_Quotation.CompanyName.ToLower().Contains(searchbyvalue)).AsQueryable();
                    }
                    if (searchby == "productname")
                    {
                        list = list.Where(x => x.ProductName.ToLower().Contains(searchbyvalue)).AsQueryable();
                    }
                    if (searchby == "cas")
                    {
                        list = list.Where(x => x.CASNo != null ? x.CASNo.ToLower().Contains(searchbyvalue) : false).AsQueryable();
                    }
                    if (searchby == "cat")
                    {
                        list = list.Where(x => x.CATNo != null ? x.CATNo.ToLower().Contains(searchbyvalue) : false).AsQueryable();
                    }
                    if (searchby == "batchno")
                    {
                        var bid = db.SZ_Inventory.Where(x => x.BatchNo.Trim().ToLower() == searchbyvalue).Select(x => x.Id).FirstOrDefault();
                        list = list.Where(x => x.AdditionalBatchNo == bid).AsQueryable();
                    }
                    if (searchby == "other")
                    {
                        list = list.Where(x => x.Remark.ToLower().Contains(searchbyvalue) || x.Reason.ToLower().Contains(searchbyvalue)).AsQueryable();
                    }
                }
            }

            ExcelPackage ExcelPkg = new ExcelPackage();
            ExcelWorksheet wsSheet1 = ExcelPkg.Workbook.Worksheets.Add("Sheet1");
            wsSheet1.DefaultColWidth = 16;
            wsSheet1.Protection.IsProtected = false;
            wsSheet1.Protection.AllowSelectLockedCells = false;
            wsSheet1.Cells.AutoFitColumns(14, 40);
            wsSheet1.Column(3).Width = 40;
            wsSheet1.Column(3).Style.WrapText = true;

            int loopCount = 2;
            wsSheet1.Cells[loopCount, 1].Value = "Sr No";
            wsSheet1.Cells[loopCount, 2].Value = "PO No";
            wsSheet1.Cells[loopCount, 3].Value = "PO Date";
            wsSheet1.Cells[loopCount, 4].Value = "Project Type";
            wsSheet1.Cells[loopCount, 5].Value = "Scientist";
            wsSheet1.Cells[loopCount, 6].Value = "Sub-Scientist";
            wsSheet1.Cells[loopCount, 7].Value = "Lead Time";
            wsSheet1.Cells[loopCount, 8].Value = "Sci. Assg.";
            wsSheet1.Cells[loopCount, 9].Value = "Syn. Start Date";
            wsSheet1.Cells[loopCount, 10].Value = "Product Name";
            wsSheet1.Cells[loopCount, 11].Value = "CAS No";
            wsSheet1.Cells[loopCount, 12].Value = "CAT No";
            wsSheet1.Cells[loopCount, 13].Value = "Qty (mg)";
            wsSheet1.Cells[loopCount, 14].Value = "Batch No";
            wsSheet1.Cells[loopCount, 15].Value = "COA";
            wsSheet1.Cells[loopCount, 16].Value = "Activity";
            wsSheet1.Cells[loopCount, 17].Value = "Status";
            wsSheet1.Cells[loopCount, 18].Value = "Est. Date";
            wsSheet1.Cells[loopCount, 19].Value = "Count";
            wsSheet1.Cells[loopCount, 20].Value = "Sec. Exp";
            wsSheet1.Cells[loopCount, 21].Value = "Data Remark";
            wsSheet1.Cells[loopCount, 22].Value = "Reason";
            wsSheet1.Cells[loopCount, 23].Value = "Technical Contact";
            wsSheet1.Cells[loopCount, 24].Value = "Pack Size";
            wsSheet1.Cells[loopCount, 25].Value = "GLP";
            wsSheet1.Cells[loopCount, 26].Value = "GLP Remark";
            wsSheet1.Cells[loopCount, 27].Value = "GLP Status";
            wsSheet1.Cells[loopCount, 28].Value = "Project Assign";
            using (ExcelRange Rng = wsSheet1.Cells[loopCount, 1, loopCount, 28])
            {
                Rng.Style.Font.Bold = true;
                Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#7b7b7b");
                Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                Rng.Style.Font.Color.SetColor(Color.White);
                Rng.Style.WrapText = true;
            }
            loopCount += 1;
            int srno = 1;
            foreach (var quote in list)
            {
                string glpstatus = "";
                if (quote.GLPStatus.HasValue && quote.GLPStatus.Value == 1)
                {
                    glpstatus = "Pending";
                }
                if (quote.GLPStatus.HasValue && quote.GLPStatus.Value == 2)
                {
                    glpstatus = "Release";
                }
                if (quote.GLPStatus.HasValue && quote.GLPStatus.Value == 3)
                {
                    glpstatus = "Reject";
                }
                string projectType = "";
                foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
                {
                    var item = Enum.GetName(typeof(EnumList.ProjectType), r);
                    var test = r.ToString();
                    string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
                    int val = (int)r;
                    string selected = "";
                    if (Convert.ToString(val) == quote.ProjectType)
                    {
                        projectType = text;
                    }
                }
                string SubScientistName = "";
                string ScientistName = "";
                listItems.ForEach(r =>
                {
                    string selected = string.Empty;
                    if (r.Value == Convert.ToString(quote.ScientistCustomerId))
                    {
                        ScientistName = r.Text;
                    }
                });
                //if (!string.IsNullOrEmpty(quote.SubScientistName))
                //{
                //    var subsci = System.Text.RegularExpressions.Regex.IsMatch(quote.SubScientistName, @"\d+");
                //    if (subsci)
                //    {
                //        if (System.Text.RegularExpressions.Regex.Match(quote.SubScientistName, @"\d+").Value == k.SubScientistName)
                //        {
                //            subList.SubScientistCustomerId = Convert.ToInt32(quote.SubScientistName);
                //        }
                //    }
                //}

                subscilistItems.ForEach(r =>
                {
                    string selected = string.Empty;
                    if (r.Value == Convert.ToString(quote.SubScientistName))
                    {
                        selected = "selected ";
                        SubScientistName = r.Text;
                    }
                });
                string batchno = "";
                if (quote.ProductId.HasValue)
                {

                    var proBatchData = inventoryData.Where(x => x.ProductId == quote.ProductId).ToList();
                    if (proBatchData.Count > 0)
                    {
                        proBatchData.ForEach(r =>
                        {
                            string selected = string.Empty;
                            if (r.Id == quote.AdditionalBatchNo)
                            {
                                batchno = r.BatchNo;
                            }
                        });
                    }
                }
                string projectMemberName = "";
                if (quote.SZ_Quotation.SZ_CompanyList.ProjectTeam.HasValue)
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == quote.SZ_Quotation.SZ_CompanyList.ProjectTeam.Value).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    projectMemberName = customerName;
                }
                string proStatus = "";

                foreach (EnumList.ProStatusDDL r in Enum.GetValues(typeof(EnumList.ProStatusDDL)))
                {
                    var item = Enum.GetName(typeof(EnumList.ProStatusDDL), r);
                    var test = r.ToString();
                    string text = SZ_Helper.GetEnumDescription((EnumList.ProStatusDDL)(int)r);
                    int val = (int)r;
                    string selected = "";
                    if (Convert.ToString(val) == quote.ProStatus)
                    {
                        proStatus = text;
                    }
                }
                wsSheet1.Cells[loopCount, 1].Value = srno;
                wsSheet1.Cells[loopCount, 2].Value = quote.SZ_Quotation.PONo;
                wsSheet1.Cells[loopCount, 3].Value = quote.SZ_Quotation.PODate.HasValue ? quote.SZ_Quotation.PODate.Value.ToShortDateString() : "";
                wsSheet1.Cells[loopCount, 4].Value = projectType;
                wsSheet1.Cells[loopCount, 5].Value = ScientistName;
                wsSheet1.Cells[loopCount, 6].Value = SubScientistName;
                wsSheet1.Cells[loopCount, 7].Value = quote.LeadTime;
                wsSheet1.Cells[loopCount, 8].Value = quote.MoveToScientistDate.HasValue ? quote.MoveToScientistDate.Value.ToShortDateString() : "";
                wsSheet1.Cells[loopCount, 9].Value = quote.SynStartDate;
                wsSheet1.Cells[loopCount, 10].Value = quote.ProductName;
                wsSheet1.Cells[loopCount, 11].Value = quote.CASNo;
                wsSheet1.Cells[loopCount, 12].Value = quote.CATNo;
                wsSheet1.Cells[loopCount, 13].Value = quote.RequiredQty;
                wsSheet1.Cells[loopCount, 14].Value = batchno;
                wsSheet1.Cells[loopCount, 15].Value = quote.COARefNumber;
                wsSheet1.Cells[loopCount, 16].Value = quote.ActivityStatus;
                wsSheet1.Cells[loopCount, 17].Value = proStatus;
                wsSheet1.Cells[loopCount, 18].Value = quote.EstimateCompleteDate;
                wsSheet1.Cells[loopCount, 19].Value = quote.CountEstDate;
                wsSheet1.Cells[loopCount, 20].Value = quote.ExplainationSecond;
                wsSheet1.Cells[loopCount, 21].Value = quote.Remark;
                wsSheet1.Cells[loopCount, 22].Value = quote.Reason;
                wsSheet1.Cells[loopCount, 23].Value = quote.ContactDetail;
                wsSheet1.Cells[loopCount, 24].Value = quote.OrderRemark;
                wsSheet1.Cells[loopCount, 25].Value = quote.IsGLP.HasValue && quote.IsGLP.Value ? "Yes" : "No";
                wsSheet1.Cells[loopCount, 26].Value = quote.GLPRemark;
                wsSheet1.Cells[loopCount, 27].Value = glpstatus;
                wsSheet1.Cells[loopCount, 28].Value = projectMemberName;
                srno += 1;
                loopCount += 1;
            }
            string filePath = HostingEnvironment.MapPath("~/Content/Quotation/") + "ExportProjectWatchList-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xlsx";
            ExcelPkg.SaveAs(new FileInfo(filePath));
            return File(filePath, "application/excel", Server.UrlEncode("ExportProjectWatchList-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xls"));
        }
        public ActionResult ExportProjectWatchListTab(string parameter = "",
            string parameterradio = "",
            string ScientistListItem = "",
            string SubScientistListItem = "",
            string fltactivity = "",
            string fltprostatusItem = "",
            string fltprotypeItem = "",
            string fltgeographicallocation = "",
            string fltestdate = "",
            string fltglp = "",
            bool chkpriority = false,
            string ProjectTeam = "")
        {
            var listItems = new List<SelectListItem>();
            var subscilistItems = new List<SelectListItem>();
            MemoryCacheManager objCache = new MemoryCacheManager();
            string instockType = Convert.ToString((int)EnumList.ProjectType.InStock);
            string searchby = "";
            string searchbyvalue = "";
            var queryData = objCache.Get("cache.queryData", () =>
            {
                return db.SZ_QueryModule.AsNoTracking().ToList();
            });

            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.AsNoTracking().Where(x => x.KeyGroup == "Customer").ToList();
            });

            var scienList = objCache.Get("cache.GetScientistId", () =>
            {
                return db.GetScientistId().ToList();
            });

            var subscienList = objCache.Get("cache.subscienList", () =>
            {
                return db.Customers.AsNoTracking().Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();
            });
            scienList.ForEach(term =>
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                listItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.ToString()
                });
                subscilistItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.ToString()
                });
            });

            ViewBag.ScientistListItem = listItems;

            subscienList.ForEach(term =>
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == term.Id).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }

                subscilistItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.Id.ToString()
                });
            });
            var inventoryData = objCache.Get("cache.inventoryData", () =>
            {
                return _operationRepository.LoadInventoryData();
            });

            var list = _operationRepository.LoadProjectWatchListData();

            if (!string.IsNullOrEmpty(ScientistListItem))
            {
                int sciid = Convert.ToInt32(ScientistListItem);
                list = list.Where(x => x.ScientistCustomerId == sciid).AsQueryable();
            }
            if (!string.IsNullOrEmpty(SubScientistListItem))
            {
                string subsciid = Convert.ToString(SubScientistListItem);
                list = list.Where(x => x.SubScientistName == subsciid).AsQueryable();
            }
            if (!string.IsNullOrEmpty(fltprostatusItem))
            {
                if (fltprostatusItem == "blank")
                {
                    list = list.Where(x => !string.IsNullOrEmpty(x.ProStatus)).AsQueryable();
                }
                else
                {
                    list = list.Where(x => x.ProStatus == fltprostatusItem).AsQueryable();
                }
            }
            if (!string.IsNullOrEmpty(fltprotypeItem))
            {
                if (fltprotypeItem == "111")
                {
                    list = list.Where(x => x.ProjectType != instockType).AsQueryable();
                }
                else
                {
                    list = list.Where(x => x.ProjectType == fltprotypeItem).AsQueryable();
                }
            }
            if (!string.IsNullOrEmpty(fltestdate))
            {
                DateTime estdat = Convert.ToDateTime(fltestdate);
                list = list.Where(x => x.EstimateCompleteDate <= estdat).AsQueryable();
            }

            if (!string.IsNullOrEmpty(fltactivity))
            {
                list = list.Where(x => x.ActivityStatus == fltactivity).AsQueryable();
            }

            if (!string.IsNullOrEmpty(fltglp))
            {
                if (fltglp == "Yes")
                {
                    list = list.Where(x => x.IsGLP == true).AsQueryable();
                }
                if (fltglp == "No")
                {
                    list = list.Where(x => x.IsGLP == false || x.IsGLP == null).AsQueryable();
                }
            }
            if (!string.IsNullOrEmpty(ProjectTeam) && ProjectTeam != "undefined")
            {
                int sciid = Convert.ToInt32(ProjectTeam);
                list = list.Where(x => x.SZ_Quotation.SZ_CompanyList.ProjectTeam == sciid).AsQueryable();
            }
            if (chkpriority == true)
            {
                list = list.Where(x => x.IsPriority == true).AsQueryable();
            }
            if (!string.IsNullOrEmpty(fltgeographicallocation) && fltgeographicallocation != "false")
            {
                int gl = Convert.ToInt32(fltgeographicallocation);
                list = list.Where(x => x.SZ_Quotation.SZ_CompanyList.GeographicalLocation == gl).AsQueryable();
            }

            if (!string.IsNullOrEmpty(searchby) && !string.IsNullOrEmpty(searchbyvalue))
            {
                searchbyvalue = searchbyvalue.ToLower();
                if (searchbyvalue.Contains("+"))
                {
                    List<string> searchlist = searchbyvalue.Split('+').Select(p => p.Trim()).ToList();

                    List<SZ_QuotationDetail> objmodel = new List<SZ_QuotationDetail>();
                    foreach (var item in searchlist)
                    {
                        var d = list.Where(x => x.SZ_Quotation.CompanyName.Contains(item) ||
                                            x.SZ_Quotation.PONo.ToLower().Contains(item) ||
                                            x.ProductName.ToLower().Contains(item) ||
                                            (x.CASNo != null ? x.CASNo.ToLower().Contains(item) : false) ||
                                            (x.CATNo != null ? x.CATNo.ToLower().Contains(item) : false) ||
                                           (x.BatchNo != null ? x.BatchNo.ToLower().Contains(item) : false)).ToList();
                        if (d != null && d.Count > 0)
                        {
                            objmodel.AddRange(d);
                        }
                    }
                    if (objmodel != null && objmodel.Count > 0)
                    {
                        list = objmodel.AsQueryable();
                    }
                }
                else
                {
                    if (searchby == "quoteid")
                    {
                        list = list.Where(x => x.SZ_Quotation.Ref.ToLower().Contains(searchbyvalue)).AsQueryable();
                    }
                    if (searchby == "ponumber")
                    {
                        list = list.Where(x => x.SZ_Quotation.PONo.ToLower().Contains(searchbyvalue)).AsQueryable();
                    }
                    if (searchby == "company")
                    {
                        list = list.Where(x => x.SZ_Quotation.CompanyName.ToLower().Contains(searchbyvalue)).AsQueryable();
                    }
                    if (searchby == "productname")
                    {
                        list = list.Where(x => x.ProductName.ToLower().Contains(searchbyvalue)).AsQueryable();
                    }
                    if (searchby == "cas")
                    {
                        list = list.Where(x => x.CASNo != null ? x.CASNo.ToLower().Contains(searchbyvalue) : false).AsQueryable();
                    }
                    if (searchby == "cat")
                    {
                        list = list.Where(x => x.CATNo != null ? x.CATNo.ToLower().Contains(searchbyvalue) : false).AsQueryable();
                    }
                    if (searchby == "batchno")
                    {
                        var bid = db.SZ_Inventory.Where(x => x.BatchNo.Trim().ToLower() == searchbyvalue).Select(x => x.Id).FirstOrDefault();
                        list = list.Where(x => x.AdditionalBatchNo == bid).AsQueryable();
                    }
                    if (searchby == "other")
                    {
                        list = list.Where(x => x.Remark.ToLower().Contains(searchbyvalue) || x.Reason.ToLower().Contains(searchbyvalue)).AsQueryable();
                    }
                }
            }

            ExcelPackage ExcelPkg = new ExcelPackage();
            ExcelWorksheet wsSheet1 = ExcelPkg.Workbook.Worksheets.Add("Sheet1");
            wsSheet1.DefaultColWidth = 16;
            wsSheet1.Protection.IsProtected = false;
            wsSheet1.Protection.AllowSelectLockedCells = false;
            wsSheet1.Cells.AutoFitColumns(14, 40);
            wsSheet1.Column(3).Width = 40;
            wsSheet1.Column(3).Style.WrapText = true;

            int loopCount = 2;
            wsSheet1.Cells[loopCount, 1].Value = "Sr No";
            wsSheet1.Cells[loopCount, 2].Value = "PO No";
            wsSheet1.Cells[loopCount, 3].Value = "PO Date";
            wsSheet1.Cells[loopCount, 4].Value = "Project Type";
            wsSheet1.Cells[loopCount, 5].Value = "Scientist";
            wsSheet1.Cells[loopCount, 6].Value = "Sub-Scientist";
            wsSheet1.Cells[loopCount, 7].Value = "Lead Time";
            wsSheet1.Cells[loopCount, 8].Value = "Sci. Assg.";
            wsSheet1.Cells[loopCount, 9].Value = "Syn. Start Date";
            wsSheet1.Cells[loopCount, 10].Value = "Product Name";
            wsSheet1.Cells[loopCount, 11].Value = "CAS No";
            wsSheet1.Cells[loopCount, 12].Value = "CAT No";
            wsSheet1.Cells[loopCount, 13].Value = "Qty (mg)";
            wsSheet1.Cells[loopCount, 14].Value = "Batch No";
            wsSheet1.Cells[loopCount, 15].Value = "COA";
            wsSheet1.Cells[loopCount, 16].Value = "Activity";
            wsSheet1.Cells[loopCount, 17].Value = "Status";
            wsSheet1.Cells[loopCount, 18].Value = "Est. Date";
            wsSheet1.Cells[loopCount, 19].Value = "Count";
            wsSheet1.Cells[loopCount, 20].Value = "Sec. Exp";
            wsSheet1.Cells[loopCount, 21].Value = "Data Remark";
            wsSheet1.Cells[loopCount, 22].Value = "Reason";
            wsSheet1.Cells[loopCount, 23].Value = "Technical Contact";
            wsSheet1.Cells[loopCount, 24].Value = "Pack Size";
            wsSheet1.Cells[loopCount, 25].Value = "GLP";
            wsSheet1.Cells[loopCount, 26].Value = "GLP Remark";
            wsSheet1.Cells[loopCount, 27].Value = "GLP Status";
            wsSheet1.Cells[loopCount, 28].Value = "Project Assign";
            using (ExcelRange Rng = wsSheet1.Cells[loopCount, 1, loopCount, 28])
            {
                Rng.Style.Font.Bold = true;
                Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#7b7b7b");
                Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                Rng.Style.Font.Color.SetColor(Color.White);
                Rng.Style.WrapText = true;
            }
            loopCount += 1;
            int srno = 1;
            foreach (var quote in list)
            {
                string glpstatus = "";
                if (quote.GLPStatus.HasValue && quote.GLPStatus.Value == 1)
                {
                    glpstatus = "Pending";
                }
                if (quote.GLPStatus.HasValue && quote.GLPStatus.Value == 2)
                {
                    glpstatus = "Release";
                }
                if (quote.GLPStatus.HasValue && quote.GLPStatus.Value == 3)
                {
                    glpstatus = "Reject";
                }
                string projectType = "";
                foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
                {
                    var item = Enum.GetName(typeof(EnumList.ProjectType), r);
                    var test = r.ToString();
                    string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
                    int val = (int)r;
                    string selected = "";
                    if (Convert.ToString(val) == quote.ProjectType)
                    {
                        projectType = text;
                    }
                }
                string SubScientistName = "";
                string ScientistName = "";
                listItems.ForEach(r =>
                {
                    string selected = string.Empty;
                    if (r.Value == Convert.ToString(quote.ScientistCustomerId))
                    {
                        ScientistName = r.Text;
                    }
                });
                //if (!string.IsNullOrEmpty(quote.SubScientistName))
                //{
                //    var subsci = System.Text.RegularExpressions.Regex.IsMatch(quote.SubScientistName, @"\d+");
                //    if (subsci)
                //    {
                //        if (System.Text.RegularExpressions.Regex.Match(quote.SubScientistName, @"\d+").Value == k.SubScientistName)
                //        {
                //            subList.SubScientistCustomerId = Convert.ToInt32(quote.SubScientistName);
                //        }
                //    }
                //}

                subscilistItems.ForEach(r =>
                {
                    string selected = string.Empty;
                    if (r.Value == Convert.ToString(quote.SubScientistName))
                    {
                        selected = "selected ";
                        SubScientistName = r.Text;
                    }
                });
                string batchno = "";
                if (quote.ProductId.HasValue)
                {

                    var proBatchData = inventoryData.Where(x => x.ProductId == quote.ProductId).ToList();
                    if (proBatchData.Count > 0)
                    {
                        proBatchData.ForEach(r =>
                        {
                            string selected = string.Empty;
                            if (r.Id == quote.AdditionalBatchNo)
                            {
                                batchno = r.BatchNo;
                            }
                        });
                    }
                }
                string projectMemberName = "";
                if (quote.SZ_Quotation.SZ_CompanyList.ProjectTeam.HasValue)
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == quote.SZ_Quotation.SZ_CompanyList.ProjectTeam.Value).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    projectMemberName = customerName;
                }
                string proStatus = "";

                foreach (EnumList.ProStatusDDL r in Enum.GetValues(typeof(EnumList.ProStatusDDL)))
                {
                    var item = Enum.GetName(typeof(EnumList.ProStatusDDL), r);
                    var test = r.ToString();
                    string text = SZ_Helper.GetEnumDescription((EnumList.ProStatusDDL)(int)r);
                    int val = (int)r;
                    string selected = "";
                    if (Convert.ToString(val) == quote.ProStatus)
                    {
                        proStatus = text;
                    }
                }
                wsSheet1.Cells[loopCount, 1].Value = srno;
                wsSheet1.Cells[loopCount, 2].Value = quote.SZ_Quotation.PONo;
                wsSheet1.Cells[loopCount, 3].Value = quote.SZ_Quotation.PODate.HasValue ? quote.SZ_Quotation.PODate.Value.ToShortDateString() : "";
                wsSheet1.Cells[loopCount, 4].Value = projectType;
                wsSheet1.Cells[loopCount, 5].Value = ScientistName;
                wsSheet1.Cells[loopCount, 6].Value = SubScientistName;
                wsSheet1.Cells[loopCount, 7].Value = quote.LeadTime;
                wsSheet1.Cells[loopCount, 8].Value = quote.MoveToScientistDate.HasValue ? quote.MoveToScientistDate.Value.ToShortDateString() : "";
                wsSheet1.Cells[loopCount, 9].Value = quote.SynStartDate;
                wsSheet1.Cells[loopCount, 10].Value = quote.ProductName;
                wsSheet1.Cells[loopCount, 11].Value = quote.CASNo;
                wsSheet1.Cells[loopCount, 12].Value = quote.CATNo;
                wsSheet1.Cells[loopCount, 13].Value = quote.RequiredQty;
                wsSheet1.Cells[loopCount, 14].Value = batchno;
                wsSheet1.Cells[loopCount, 15].Value = quote.COARefNumber;
                wsSheet1.Cells[loopCount, 16].Value = quote.ActivityStatus;
                wsSheet1.Cells[loopCount, 17].Value = proStatus;
                wsSheet1.Cells[loopCount, 18].Value = quote.EstimateCompleteDate;
                wsSheet1.Cells[loopCount, 19].Value = quote.CountEstDate;
                wsSheet1.Cells[loopCount, 20].Value = quote.ExplainationSecond;
                wsSheet1.Cells[loopCount, 21].Value = quote.Remark;
                wsSheet1.Cells[loopCount, 22].Value = quote.Reason;
                wsSheet1.Cells[loopCount, 23].Value = quote.ContactDetail;
                wsSheet1.Cells[loopCount, 24].Value = quote.OrderRemark;
                wsSheet1.Cells[loopCount, 25].Value = quote.IsGLP.HasValue && quote.IsGLP.Value ? "Yes" : "No";
                wsSheet1.Cells[loopCount, 26].Value = quote.GLPRemark;
                wsSheet1.Cells[loopCount, 27].Value = glpstatus;
                wsSheet1.Cells[loopCount, 28].Value = projectMemberName;
                srno += 1;
                loopCount += 1;
            }
            string filePath = HostingEnvironment.MapPath("~/Content/Quotation/") + "ExportProjectWatchList-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xlsx";
            ExcelPkg.SaveAs(new FileInfo(filePath));
            return File(filePath, "application/excel", Server.UrlEncode("ExportProjectWatchList-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xls"));
        }
        [HttpPost]
        public ActionResult LoadWatchListProductData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                var scinameFilter = Request.Form.GetValues("sciname")[0].ToString();
                var subscinameFilter = Request.Form.GetValues("subsciname")[0].ToString();
                var fltprostatusItem = Request.Form.GetValues("fltprostatusItem")[0].ToString();
                var fltactivity = Request.Form.GetValues("fltactivity")[0].ToString();
                var fltpriority = Request.Form.GetValues("fltpriority")[0].ToString();
                var fltgeographicallocation = Request.Form.GetValues("fltgeographicallocation")[0].ToString();
                var fltprotypeItem = "";
                if (Request.Form.GetValues("fltprotypeItem") != null)
                {
                    fltprotypeItem = Request.Form.GetValues("fltprotypeItem")[0].ToString();
                }
                var fltglp = "";
                if (Request.Form.GetValues("fltglp") != null)
                {
                    fltglp = Request.Form.GetValues("fltglp")[0].ToString();
                }
                var fltestdate = "";
                if (Request.Form.GetValues("fltprotypeItem") != null)
                {
                    fltestdate = Request.Form.GetValues("fltestdate")[0].ToString();
                }
                var searchby = string.Empty;
                var searchbyvalue = string.Empty;
                if (Request.Form.GetValues("radiobuton") != null)
                {
                    searchby = Request.Form.GetValues("radiobuton")[0].ToString();
                }
                if (Request.Form.GetValues("searchbox") != null)
                {
                    searchbyvalue = Request.Form.GetValues("searchbox")[0].ToString().Trim();
                }
                var projectTeam = "";
                if (Request.Form.GetValues("fltProjectTeam") != null)
                {
                    projectTeam = Request.Form.GetValues("fltProjectTeam")[0].ToString();
                }

                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;
                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
                string pursynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
                string instockType = Convert.ToString((int)EnumList.ProjectType.InStock);


                //var quotationDetailsdata = db.SZ_QuotationDetail.AsQueryable();
                // Getting all Customer data  

                var list = _operationRepository.LoadProjectWatchListData();

                var listItems = new List<SelectListItem>();
                var subscilistItems = new List<SelectListItem>();
                MemoryCacheManager objCache = new MemoryCacheManager();

                var queryData = objCache.Get("cache.queryData", () =>
                {
                    return db.SZ_QueryModule.AsNoTracking().ToList();
                });

                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.AsNoTracking().Where(x => x.KeyGroup == "Customer").ToList();
                });

                var scienList = objCache.Get("cache.GetScientistId", () =>
                {
                    return db.GetScientistId().ToList();
                });

                var subscienList = objCache.Get("cache.subscienList", () =>
                {
                    return db.Customers.AsNoTracking().Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();
                });
                var projectList = objCache.Get("cache.projectlist", () =>
                {
                    return db.Customers.AsNoTracking().Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("project")).ToList();
                });
                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                    subscilistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                });

                ViewBag.ScientistListItem = listItems;

                subscienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }

                    subscilistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                });

                ViewBag.SubScientistListItem = subscilistItems;

                //var proIds = list.Select(x => x.ProductId).Distinct().ToList();
                //var masterCOAData = _operationRepository.LoadMasterCOAData(proIds);
                //var masterCoaIds = masterCOAData.Select(x => x.Id).Distinct().ToList();
                //var childcoadata = _operationRepository.LoadChildCOAData(masterCoaIds);
                //var productsData = _operationRepository.LoadProductData(proIds);
                //var inventoryData = _operationRepository.LoadInventoryData(proIds);
                //var catList = _operationRepository.LoadCategoryData();
                //var customerList = _operationRepository.LoadCompanyData();

                var masterCOAData = objCache.Get("cache.mastercoadata", () =>
                {
                    return _operationRepository.LoadMasterCOAData();
                });
                var childcoadata = objCache.Get("cache.childcoadata", () =>
                {
                    return _operationRepository.LoadChildCOAData();
                });

                var ReadyToDeliverScientistStatusId = objCache.Get("cache.ReadyToDeliverScientistStatusId", () =>
                {
                    return db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                });
                var productsData = objCache.Get("cache.productsdata", () =>
                {
                    return _operationRepository.LoadProductData();
                });
                var inventoryData = objCache.Get("cache.inventoryData", () =>
                {
                    return _operationRepository.LoadInventoryData();
                });
                var catList = objCache.Get("cache.categorydata", () =>
                {
                    return _operationRepository.LoadCategoryData();
                });
                var customerList = objCache.Get("cache.customerdata", () =>
                {
                    return _operationRepository.LoadCompanyData();
                });
                var resQtyList = objCache.Get("cache.resQtyList", () =>
                {
                    return db.SZ_ReservedQty.ToList();
                });
                var proIds = list.Select(x => x.ProductId).Distinct().ToList();
                masterCOAData = masterCOAData.Where(x => proIds.Contains(x.ProductId)).ToList();
                var masterCoaIds = masterCOAData.Select(x => x.Id).Distinct().ToList();
                childcoadata = childcoadata.Where(x => masterCoaIds.Contains(x.MasterCOAID.Value)).ToList();
                productsData = productsData.Where(x => proIds.Contains(x.Id) && x.Published == true && x.Deleted == false).ToList();
                inventoryData = inventoryData.Where(x => proIds.Contains(x.ProductId)).ToList();
                if (!string.IsNullOrEmpty(projectTeam))
                {
                    int sciid = Convert.ToInt32(projectTeam);
                    list = list.Where(x => x.SZ_Quotation.SZ_CompanyList.ProjectTeam == sciid).AsQueryable();
                }
                if (!string.IsNullOrEmpty(scinameFilter))
                {
                    int sciid = Convert.ToInt32(scinameFilter);
                    list = list.Where(x => x.ScientistCustomerId == sciid).AsQueryable();
                }
                if (!string.IsNullOrEmpty(subscinameFilter))
                {
                    string subsciid = Convert.ToString(subscinameFilter);
                    list = list.Where(x => x.SubScientistName == subsciid).AsQueryable();
                }
                if (!string.IsNullOrEmpty(fltprostatusItem))
                {
                    if (fltprostatusItem == "blank")
                    {
                        list = list.Where(x => !string.IsNullOrEmpty(x.ProStatus)).AsQueryable();
                    }
                    else
                    {
                        list = list.Where(x => x.ProStatus == fltprostatusItem).AsQueryable();
                    }
                }
                if (!string.IsNullOrEmpty(fltprotypeItem))
                {
                    if (fltprotypeItem == "111")
                    {
                        list = list.Where(x => x.ProjectType != instockType).AsQueryable();
                    }
                    else
                    {
                        list = list.Where(x => x.ProjectType == fltprotypeItem).AsQueryable();
                    }
                }
                if (!string.IsNullOrEmpty(fltestdate))
                {
                    DateTime estdat = Convert.ToDateTime(fltestdate);
                    list = list.Where(x => x.EstimateCompleteDate <= estdat).AsQueryable();
                }

                if (!string.IsNullOrEmpty(fltactivity))
                {
                    list = list.Where(x => x.ActivityStatus == fltactivity).AsQueryable();
                }
                if (!string.IsNullOrEmpty(fltpriority) && fltpriority == "true")
                {
                    list = list.Where(x => x.IsPriority == true).AsQueryable();
                }
                if (!string.IsNullOrEmpty(fltglp))
                {
                    if (fltglp == "Yes")
                    {
                        list = list.Where(x => x.IsGLP == true).AsQueryable();
                    }
                    if (fltglp == "No")
                    {
                        list = list.Where(x => x.IsGLP == false || x.IsGLP == null).AsQueryable();
                    }
                }

                if (!string.IsNullOrEmpty(fltgeographicallocation) && fltgeographicallocation != "false")
                {
                    int gl = Convert.ToInt32(fltgeographicallocation);
                    list = list.Where(x => x.SZ_Quotation.SZ_CompanyList.GeographicalLocation == gl).AsQueryable();
                }

                if (!string.IsNullOrEmpty(searchby) && !string.IsNullOrEmpty(searchbyvalue))
                {
                    searchbyvalue = searchbyvalue.ToLower();
                    if (searchbyvalue.Contains("+"))
                    {
                        List<string> searchlist = searchbyvalue.Split('+').Select(p => p.Trim()).ToList();

                        List<SZ_QuotationDetail> objmodel = new List<SZ_QuotationDetail>();
                        foreach (var item in searchlist)
                        {
                            var d = list.Where(x => x.SZ_Quotation.CompanyName.Contains(item) ||
                                                x.SZ_Quotation.PONo.ToLower().Contains(item) ||
                                                x.ProductName.ToLower().Contains(item) ||
                                                (x.CASNo != null ? x.CASNo.ToLower().Contains(item) : false) ||
                                                (x.CATNo != null ? x.CATNo.ToLower().Contains(item) : false) ||
                                               (x.BatchNo != null ? x.BatchNo.ToLower().Contains(item) : false)).ToList();
                            if (d != null && d.Count > 0)
                            {
                                objmodel.AddRange(d);
                            }
                        }
                        if (objmodel != null && objmodel.Count > 0)
                        {
                            list = objmodel.AsQueryable();
                        }
                    }
                    else
                    {
                        if (searchby == "quoteid")
                        {
                            list = list.Where(x => x.SZ_Quotation.Ref.ToLower().Contains(searchbyvalue)).AsQueryable();
                        }
                        if (searchby == "ponumber")
                        {
                            list = list.Where(x => x.SZ_Quotation.PONo.ToLower().Contains(searchbyvalue)).AsQueryable();
                        }
                        if (searchby == "company")
                        {
                            list = list.Where(x => x.SZ_Quotation.CompanyName.ToLower().Contains(searchbyvalue)).AsQueryable();
                        }
                        if (searchby == "productname")
                        {
                            list = list.Where(x => x.ProductName.ToLower().Contains(searchbyvalue)).AsQueryable();
                        }
                        if (searchby == "cas")
                        {
                            list = list.Where(x => x.CASNo != null ? x.CASNo.ToLower().Contains(searchbyvalue) : false).AsQueryable();
                        }
                        if (searchby == "cat")
                        {
                            list = list.Where(x => x.CATNo != null ? x.CATNo.ToLower().Contains(searchbyvalue) : false).AsQueryable();
                        }
                        if (searchby == "batchno")
                        {
                            var bid = db.SZ_Inventory.Where(x => x.BatchNo.Trim().ToLower() == searchbyvalue).Select(x => x.Id).FirstOrDefault();
                            list = list.Where(x => x.AdditionalBatchNo == bid).AsQueryable();
                        }
                        if (searchby == "other")
                        {
                            list = list.Where(x => x.Remark.ToLower().Contains(searchbyvalue) || x.Reason.ToLower().Contains(searchbyvalue)).AsQueryable();
                        }
                    }
                }

                string internationcompanylist = "";
                if (SessionCookieManagement.IsInternational)
                {
                    internationcompanylist = db.SZ_UserManagement.AsNoTracking().Where(x => x.UserId == SessionCookieManagement.UserId).Select(x => x.CompanyIds).FirstOrDefault();
                    if (!string.IsNullOrEmpty(internationcompanylist))
                    {
                        List<int?> cidList = new List<int?>();
                        foreach (var item in internationcompanylist.Split(','))
                        {
                            if (!string.IsNullOrEmpty(item))
                            {
                                cidList.Add(Convert.ToInt32(item));
                            }
                        }
                        list = list.Where(x => cidList.Contains(x.SZ_Quotation.CompanyId) && x.SZ_Quotation.CreatedDate >= new DateTime(2022, 05, 01)).AsQueryable();
                    }
                }

                recordsTotal = list.Count();

                var outlist = list.Skip(() => skip).Take(() => pageSize);

                //var outlist = list.Skip(skip).Take(pageSize).ToList();
                var model = new List<ProjectListModel>();
                var proids = outlist.Select(x => x.ProductId).ToList();
                var maincatnamelist = (from i in productsData
                                       where proids.Contains(i.Id)
                                       select new
                                       {
                                           Id = i.Id,
                                           MainCatName = i.MainCatName,
                                           CASNo = i.ManufacturerPartNumber
                                       }).ToList();
                var szSAPrawmaterial = (from i in db.SZ_SAPProjectNameData.ToList()
                                        join t2 in maincatnamelist on i.ProjectName equals t2.MainCatName
                                        select t2.Id).ToList();
                var qdids = outlist.Select(x => x.Id).ToList();
                //var auditlog = db.SZ_QuotationDetailLog.Where(x=>x.FieldName == "EstimateCompleteDate" && qdids.Contains(x.QuoteDetailsId)).AsEnumerable();
                outlist.ForEach(k =>
                {

                    //var oldEstCompDate = auditlog.Where(x=>x.QuoteDetailsId == k.Id).Select(x=>x.Before).FirstOrDefault();
                    ProjectListModel subList = new ProjectListModel();
                    subList.ImportantDays = 0;
                    //if (k.EstimateCompleteDate.HasValue && !string.IsNullOrEmpty(oldEstCompDate))
                    //{
                    //    var odddate = Convert.ToDateTime(oldEstCompDate);
                    //    var initialNumberOfDays = (odddate- k.SZ_Quotation.PODate.Value).TotalDays;
                    //    var CurrantNumberOfDays = (k.EstimateCompleteDate.Value - k.SZ_Quotation.PODate.Value).TotalDays;
                    //    if((initialNumberOfDays*2) <= CurrantNumberOfDays)
                    //    {
                    //        subList.ImportantDays = 1;
                    //    }
                    //}
                    if (k.SZ_ReactionMatrix != null && k.SZ_ReactionMatrix.Count > 0)
                    {
                        subList.Attachment = "<a href = 'javascript:void(0)' onclick='showreactionmatrix(" + k.Id + ")'><i class='fa fa-paperclip'></i></a>";
                    }

                    if (k.ProductId.HasValue && szSAPrawmaterial.Contains(k.ProductId.Value))
                    {
                        //subList.SAPRawMaterial = "<a href = 'javascript:void(0)' onclick='getrawmaterialdata(" + k.ProductId + ")'><img src='/img/flask-icon.png' style='width:16px; height: 16px;' /></a>";
                        subList.SAPRawMaterial = "<a href = 'javascript:void(0)' onclick='getrawmaterialdatabyproject(" + k.ProductId + ")'><i class='fa fa-flask'></i></a>";
                    }

                    subList.GLP = "<select id='IsGLP_" + k.Id + "' class='clsIsGLP' data-quoteDetailsId='" + k.Id + "'><option value='false'>No</option>";
                    if (k.IsGLP.HasValue && k.IsGLP.Value)
                    {
                        subList.GLP += "<option value='true' selected>Yes</option>";
                    }
                    else
                    {
                        subList.GLP += "<option value='true'>Yes</option>";
                    }
                    subList.GLP += "</select>";
                    subList.GLPRemark = "<i class='fa fa-pencil' onclick='GLPRemarkGenerate(\"" + k.Id + "\")' ></i>"; //<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";
                    subList.GLPStatus = "<select id='GLPStatus_" + k.Id + "' class='clsGLPStatus' data-quoteDetailsId='" + k.Id + "'>";
                    if (k.GLPStatus.HasValue && k.GLPStatus.Value == 1)
                    {
                        subList.GLPStatus += "<option value='1' selected>Pending</option>";
                    }
                    else
                    {
                        subList.GLPStatus += "<option value='1'>Pending</option>";
                    }
                    if (k.GLPStatus.HasValue && k.GLPStatus.Value == 2)
                    {
                        subList.GLPStatus += "<option value='2' selected>Release</option>";
                    }
                    else
                    {
                        subList.GLPStatus += "<option value='2'>Release</option>";
                    }
                    if (k.GLPStatus.HasValue && k.GLPStatus.Value == 3)
                    {
                        subList.GLPStatus += "<option value='3' selected>Reject</option>";
                    }
                    else
                    {
                        subList.GLPStatus += "<option value='3'>Reject</option>";
                    }
                    subList.GLPStatus += "</select>";

                    subList.IsConversionReport = k.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    subList.SAPCode = k.SZ_Quotation.SZ_CompanyList.SAPCode;
                    subList.CountEstDate = k.CountEstDate.HasValue ? k.CountEstDate.Value : 0;
                    subList.ChkSaveRow = "<input type='checkbox' value='" + k.Id + "' class='clsSaverow' />";
                    subList.ReadyToDeliverScientistStatusId = ReadyToDeliverScientistStatusId;
                    if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == subList.ReadyToDeliverScientistStatusId && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                    {
                        subList.ChkFirstRow = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                    }
                    else if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == subList.ReadyToDeliverScientistStatusId)
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' />";
                    }
                    else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && (k.MoveToDispatch == null || k.MoveToDispatch == false))
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' />";
                    }
                    else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                    {
                        subList.ChkFirstRow = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                    }
                    if (k.IsDispatchApprove.HasValue && k.IsDispatchApprove.Value && (k.MoveToDispatch == null || k.MoveToDispatch == false))
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' style='outline: 4px solid #c00'/>";
                    }

                    if (k.IsCancel.HasValue && k.IsCancel.Value)
                    {
                        subList.ChkFirstRow = "";
                        subList.ChkSaveRow = "";
                    }

                    subList.ProjectType = k.ProjectType;
                    subList.ApprovedForClient = k.ApprovedForClient;
                    if (k.ApprovedForClient.HasValue && k.ApprovedForClient.Value)
                    {
                        subList.ApprovedForClientText = "<input type='checkbox' value='" + k.Id + "' class='clsApprovedForClient' checked='checked'/>";
                    }
                    else
                    {
                        subList.ApprovedForClientText = "<input type='checkbox' value='" + k.Id + "' class='clsApprovedForClient' />";
                    }
                    subList.ProjectTypeText = "<select id='projecttype_" + k.Id + "' class='clsProjType' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ProjectType), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.ProjectType)
                        {
                            selected = "selected ";
                            subList.SelectedProjectType = text;
                        }
                        //if (text != "In-House")
                        //{
                            subList.ProjectTypeText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                        //}
                    }
                    subList.ProjectTypeText += "</select>";
                    subList.IsPaymentPending = k.SZ_Quotation.SZ_CompanyList.IsPaymentPending;
                    subList.ActivityStatus = k.ActivityStatus;
                    subList.TechnicalEmail = k.TechnicalEmail;
                    subList.ActivityStatusText = "<select id='activitystatus_" + k.Id + "' class='clsActivityStatus' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    if (k.ActivityStatus == "Approval First")
                    {
                        subList.ActivityStatusText += "<option value='Approval First' selected>Approval First</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Approval First'>Approval First</option>";
                    }
                    if (k.ActivityStatus == "Immediate Dispatch")
                    {
                        subList.ActivityStatusText += "<option value='Immediate Dispatch' selected>Immediate Dispatch</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Immediate Dispatch'>Immediate Dispatch</option>";
                    }

                    if (k.ActivityStatus == "Repeat Order")
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order' selected>Repeat Order</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order'>Repeat Order</option>";
                    }

                    if (k.ActivityStatus == "Repeat Order - Dispatch")
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Dispatch' selected>Repeat Order - Dispatch</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Dispatch'>Repeat Order - Dispatch</option>";
                    }
                    if (k.ActivityStatus == "Repeat Order - Approval First")
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Approval First' selected>Repeat Order - Approval First</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Approval First'>Repeat Order - Approval First</option>";
                    }
                    if (k.ActivityStatus == "Short Qty Dispatch")
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatch' selected>Short Qty Dispatch</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatch'>Short Qty Dispatch</option>";
                    }
                    if (k.ActivityStatus == "Short Qty Dispatched")
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatched' selected>Short Qty Dispatched</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatched'>Short Qty Dispatched</option>";
                    }
                    if (k.ActivityStatus == "Sample Request")
                    {
                        subList.ActivityStatusText += "<option value='Sample Request' selected>Sample Request</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Sample Request'>Sample Request</option>";
                    }
                    if (k.ActivityStatus == "Sample Sent")
                    {
                        subList.ActivityStatusText += "<option value='Sample Sent' selected>Sample Sent</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Sample Sent'>Sample Sent</option>";
                    }
                    if (k.ActivityStatus == "Sample Approved")
                    {
                        subList.ActivityStatusText += "<option value='Sample Approved' selected>Sample Approved</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Sample Approved'>Sample Approved</option>";
                    }
                    //if (k.ActivityStatus == "Insufficient QTY")
                    //{
                    //    subList.ActivityStatusText += "<option value='Insufficient QTY' selected>Insufficient QTY</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Insufficient QTY'>Insufficient QTY</option>";
                    //}
                    if (k.ActivityStatus == "Quote - Data Sent")
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Sent' selected>Quote - Data Sent</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Sent'>Quote - Data Sent</option>";
                    }
                    if (k.ActivityStatus == "Quote - Data Approved")
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Approved' selected>Quote - Data Approved</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Approved'>Quote - Data Approved</option>";
                    }
                    subList.ActivityStatusText += "</select>";
                    //subList.APIName = GetApiNameOfProduct(k.ProductId.Value, proCat, catList);
                    subList.ScientistName = "<select id='ScientistId_" + k.Id + "' class='scientist' scientistId='" + k.ScientistCustomerId + "' quotedetailsid='" + k.Id + "'><option value=''>--Select--</option>";
                    listItems.ForEach(r =>
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.ScientistCustomerId))
                        {
                            selected = "selected ";
                            subList.SelectedScientistName = r.Text;
                        }
                        subList.ScientistName += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    });

                    subList.ScientistName += "</select>";
                    if (!string.IsNullOrEmpty(k.SubScientistName))
                    {
                        var subsci = System.Text.RegularExpressions.Regex.IsMatch(k.SubScientistName, @"\d+");
                        if (subsci)
                        {
                            if (System.Text.RegularExpressions.Regex.Match(k.SubScientistName, @"\d+").Value == k.SubScientistName)
                            {
                                subList.SubScientistCustomerId = Convert.ToInt32(k.SubScientistName);
                            }
                        }
                    }

                    subList.SubScientistName = "<select id='SubScientistId_" + k.Id + "' class='subscientist' subscientistId='" + k.SubScientistName + "' quotedetailsid='" + k.Id + "'><option value=''>--Select--</option>";
                    subscilistItems.ForEach(r =>
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.SubScientistName))
                        {
                            selected = "selected ";
                            subList.SelectedSubScientistName = r.Text;
                        }
                        subList.SubScientistName += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    });

                    subList.SubScientistName += "</select>";

                    if (!string.IsNullOrEmpty(k.SZ_Quotation.Attachment))
                    {
                        subList.Attachment = "<a href = 'javascript:void(0)' onclick='attachment(" + k.QuoteId + ")'><i class='fa fa-paperclip'></i></a>";
                    }
                    subList.MoveProjectDateText = k.MoveProjectDate.HasValue ? k.MoveProjectDate.Value.ToString("dd/MM/yyyy hh:mm tt") : "";
                    subList.AdditionalBatchNo = k.AdditionalBatchNo;
                    subList.QuoteId = k.QuoteId;
                    subList.ProductId = k.ProductId;
                    subList.ProductName = k.ProductName;
                    subList.ScientistRemark = "<input id='sciremark_" + k.Id + "' type='text' value='" + k.ScientistRemark + "' style='width: 170px' />";
                    subList.RequiredQtyTxt = "<input id='qty_" + k.Id + "' type='text' value='" + k.RequiredQty + "' style='width: 50px; font-weight:bold' />";

                    if (!string.IsNullOrEmpty(k.ExplainationSecond))
                    {
                        subList.ExplainationSecondText = "<input id='explainationsecond_" + k.Id + "' type='text' value='" + k.ExplainationSecond.Replace("'", "&#8242;") + "' title='" + k.ExplainationSecond + "' style='width: 200px; font-weight:bold' />";
                    }
                    else
                    {
                        subList.ExplainationSecondText = "<input id='explainationsecond_" + k.Id + "' type='text' value='" + k.ExplainationSecond + "' title='" + k.ExplainationSecond + "' style='width: 200px; font-weight:bold' />";
                    }

                    subList.ExplainationSecond = k.ExplainationSecond;
                    subList.LastWeekUpdate = k.LastWeekUpdate;
                    subList.PaymentTerms = k.SZ_Quotation.PaymentTerm;
                    subList.AdditionalBatchNoText = "<select id='additionalBatch_" + k.Id + "' data-quotationdetailsid='" + k.Id + "' class='ddladditionalbatch'><option value=''>--Select--</option>";
                    if (subList.ProductId.HasValue)
                    {
                        var proData = productsData.Where(x => x.Id == subList.ProductId).FirstOrDefault();
                        if (proData != null)
                        {
                            subList.IsControlledSubstance = proData.IsControlledSubstance;
                            if (!subList.IsControlledSubstance.HasValue
                                || subList.IsControlledSubstance == false)
                            {
                                subList.IsControlledSubstance = proData.IsManuallyControlledSubstance;
                            }
                        }
                        if (proData != null && proData.SZ_ProductScheme != null && proData.SZ_ProductScheme.Count > 0)
                        {
                            subList.ProductScheme = "<i class='fa fa-eye' onclick='ViewProductScheme(" + k.ProductId + ")' ></i>";
                        }
                        var proBatchData = inventoryData.Where(x => x.ProductId == subList.ProductId).ToList();
                        if (proBatchData.Count > 0 && proData != null)
                        {
                            proBatchData.ForEach(r =>
                            {
                                //var qty = System.Text.RegularExpressions.Regex.Match(Convert.ToString(r.Qty), @"\d+").Value;
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty;
                                var resdetail = resQtyList.Where(x => x.BatchId == r.Id).Sum(x => x.Qty);
                                if (resdetail > 0)
                                {
                                    text += " - " + resdetail;
                                }

                                text += ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }

                                string selected = string.Empty;
                                if (r.Id == subList.AdditionalBatchNo)
                                {
                                    selected = "selected ";
                                    subList.BatchNo = r.BatchNo;
                                    subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
                                }
                                subList.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' " + selected + ">" + text + "</option>";
                            });
                        }
                    }
                    subList.AdditionalBatchNoText += "</select>   <i class='fa fa-list-alt' onclick='DispatchedSummaryDetail(\"" + k.Id + "\")' ></i>";
                    //subList.BatchNo = k.BatchNo;
                    subList.BatchNoText = "<input id='batchno_" + k.Id + "' type='text' value='" + k.BatchNo + "' style='width:120px' />";
                    subList.IsImageAttach = k.SZ_Quotation.IsImageAttach;
                    subList.CompanyName = k.SZ_Quotation.CompanyName;
                    if (k.SZ_Quotation.SZ_CompanyList.ProjectTeam.HasValue)
                    {
                        //var projectuser = projectList.Where(x => x.Id == k.SZ_Quotation.SZ_CompanyList.ProjectTeam).FirstOrDefault();
                        //if (projectuser != null)
                        //{
                        string customerName = string.Empty;
                        var genericAttr = genericData.Where(x => x.EntityId == k.SZ_Quotation.SZ_CompanyList.ProjectTeam.Value).ToList();
                        if (genericAttr.Count > 0)
                        {
                            customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                        }
                        subList.ProjectAssignName = customerName;
                        //}
                    }
                    subList.Email = k.SZ_Quotation.EmailAddress;
                    subList.PONumber = k.SZ_Quotation.PONo;
                    subList.Ref = k.SZ_Quotation.Ref;
                    subList.Remark = k.Remark;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.QuoteDetailsId = k.Id;
                    subList.CASNo = k.CASNo;
                    var pName = "";
                    var query = queryData.Where(x => x.CATNo.Trim().ToLower() == k.CATNo.Trim().ToLower()).OrderByDescending(x => x.Id);
                    if (query != null && query.Count() > 0)
                    {
                        var qlist = query.Select(x => x.QueryNo).ToArray();
                        if (query.Select(x => x.Status.ToLower()).FirstOrDefault() == "solved" ||
                        query.Select(x => x.Status.ToLower()).FirstOrDefault() == "close" ||
                        query.Select(x => x.Status.ToLower()).FirstOrDefault() == "completed")
                        {
                            pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + k.CATNo + "\")' title='" + string.Join(", ", qlist) + "' style ='float:right; color: green' ></i>";
                        }
                        else
                        {
                            pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + k.CATNo + "\")' title='" + string.Join(", ", qlist) + "' style ='float:right' ></i>";
                        }
                    }

                    subList.IsConversionReport = k.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    var impstr = "";
                    if (subList.IsConversionReport.HasValue && subList.IsConversionReport.Value)
                    {
                        impstr += "<img src='/img/important.jpg' width='15px' height='15px' />";
                    }
                    subList.CATNo = pName + "" + "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>  <i class='fa fa-search' onclick='SearchDefault(\"cat\", \"" + k.CATNo + "\")' ></i>" + impstr + " " + CommonOperation.GetMatchingTagHTML(k, "Project");
                    subList.CreatedDate = k.CreatedDate;
                    subList.ImagePath = k.ImagePath;
                    subList.IsUploadServer = k.IsUploadServer;
                    subList.LeadTime = k.LeadTime;
                    subList.Price = k.Price;
                    subList.QuoteId = k.QuoteId;
                    subList.ProjectType = k.ProjectType;
                    subList.ScientistCustomerId = k.ScientistCustomerId;
                    subList.RequiredQty = k.RequiredQty;
                    subList.ProjectStatus = k.ProjectStatus;
                    subList.IsOnHold = k.IsOnHold;
                    if (k.ProjectStatus != null)
                    {
                        subList.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
                    }
                    subList.ScientistStatus = k.ScientistStatus;
                    subList.BatchCode1 = k.BatchCode1;
                    subList.BatchCode2 = k.BatchCode2;
                    subList.Qty1 = k.Qty1;
                    subList.Qty2 = k.Qty2;
                    subList.EstimateCompleteDate = k.EstimateCompleteDate;
                    subList.EstimateCompleteDateText = "<input id='esticompleteDate_" + k.Id + "' data-value='" + k.EstimateCompleteDate + "' type='text' class='datepicker'  style='width:80px' />";
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToProject = k.MoveToProject;
                    subList.Remark = k.Remark;
                    subList.SrPo = k.SrPo;
                    subList.AdminScientistStatus = k.AdminScientistStatus;
                    subList.InvoiceNo = k.InvoiceNo;
                    subList.InvoiceRemark = k.InvoiceRemark;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.ScientistStatustext = "<input id='scientistStatus_" + k.Id + "' type='text' value='" + k.AdminScientistStatus + "' title='" + k.AdminScientistStatus + "'  style='width:200px' />";
                    subList.RemarkText = "<input id='remark_" + k.Id + "' type='text' value='" + k.Remark + "' title='" + k.Remark + "' style='width: 170px' />";
                    subList.LastRowText = "<a href='javascript: void(0)' id='save_" + k.Id + "' onclick='SaveProjectDetails(\"" + k.Id + "\")'> Save</a> ";
                    subList.LastRowText += "<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";

                    subList.GetAllBatch = "<i class='fa fa-clone' title='View Batch No' onclick='GetAllBatchNo(" + k.ProductId + ", " + k.Id + ")'></i>";
                    subList.DispatchedStatus = k.DispatchedStatus;
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToInvoice = k.MoveToInvoice;
                    subList.IsDispatchApprove = k.IsDispatchApprove;
                    subList.IsPayment = k.IsPayment;
                    if (k.IsPayment.HasValue && k.IsPayment.Value)
                    {
                        subList.IsPaymentText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPayment' checked='checked'/>";
                    }
                    else
                    {
                        subList.IsPaymentText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPayment' />";
                    }

                    subList.OrderRemark = k.OrderRemark;
                    subList.OrderRemarkText = "<input id='orderremark_" + k.Id + "' type='text' value='" + k.OrderRemark + "' title='" + k.OrderRemark + "'  style='width:200px' />";

                    subList.Reason = k.Reason;
                    subList.ReasonText = "<input id='reason_" + k.Id + "' type='text' value='" + k.Reason + "' title='" + k.Reason + "'  style='width:200px' />";

                    if (k.MoveToScientistDate.HasValue)
                    {
                        subList.MoveToScientistDateStr = k.MoveToScientistDate.Value.ToShortDateString();
                    }

                    subList.InhouseRemarkText = "<i class='fa fa-pencil' onclick='InhouseRemarkGenerate(\"" + k.Id + "\")' ></i>"; //<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";
                    subList.ExplainationText += "<i class='fa fa-pencil' onclick='explainationGenerate(\"" + k.Id + "\")' ></i>"; //<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";
                    subList.DifficultyLevel = k.DifficultyLevel;
                    subList.DifficultyLevelText = "<select id='difflevel_" + k.Id + "' class='clsDifficultyLevel' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.DifficultyLevel r in Enum.GetValues(typeof(EnumList.DifficultyLevel)))
                    {
                        var item = Enum.GetName(typeof(EnumList.DifficultyLevel), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.DifficultyLevel)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.DifficultyLevel)
                        {
                            selected = "selected ";
                        }
                        subList.DifficultyLevelText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                    }
                    subList.DifficultyLevelText += "</select>";

                    subList.IsPriority = k.IsPriority;
                    if (k.IsPriority.HasValue && k.IsPriority.Value)
                    {
                        subList.IsPriorityText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPriority' checked='checked'/>";
                    }
                    else
                    {
                        subList.IsPriorityText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPriority' />";
                    }
                    subList.ProStatus = k.ProStatus;
                    subList.ProStatusText = "<select id='prostatus_" + k.Id + "' class='clsProjStatus' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.ProStatusDDL r in Enum.GetValues(typeof(EnumList.ProStatusDDL)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ProStatusDDL), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ProStatusDDL)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.ProStatus)
                        {
                            selected = "selected ";
                            subList.SelectedProStatus = text;
                        }
                        subList.ProStatusText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                    }
                    subList.ProStatusText += "</select>";
                    subList.COAId = k.COAId;
                    subList.COARefNumber = k.COARefNumber;
                    string coaText = "";

                    coaText = "<select id='coa_" + k.Id + "' class='addcoa'><option value=''>--Select--</option>";
                    int bId = k.AdditionalBatchNo.HasValue ? k.AdditionalBatchNo.Value : 0;
                    if (bId != 0)
                    {
                        var mastercoa = masterCOAData.Where(x => x.BatchId == bId).FirstOrDefault();
                        if (mastercoa != null)
                        {
                            var listchildcoa = childcoadata.Where(x => x.MasterCOAID == mastercoa.Id).ToList();
                            if (listchildcoa != null && listchildcoa.Count > 0)
                            {
                                foreach (var ccoa in listchildcoa)
                                {
                                    if (k.COAId == ccoa.Id)
                                    {
                                        coaText += "<option value='" + ccoa.Id.ToString() + "' data-value='" + k.AdditionalBatchNo + "' selected>" + ccoa.RefNo + "</option>";
                                    }
                                    else
                                    {
                                        coaText += "<option value='" + ccoa.Id.ToString() + "' data-value='" + k.AdditionalBatchNo + "'>" + ccoa.RefNo + "</option>";
                                    }
                                }
                            }
                        }
                    }
                    subList.COAText = coaText;
                    subList.CompanyId = k.SZ_Quotation.CompanyId;

                    if (k.SynStartDate.HasValue)
                    {
                        subList.SynStartDate = k.SynStartDate.Value.ToShortDateString();
                    }

                    model.Add(subList);
                });

                model = model.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).ToList();

                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.SelectedScientistName != null && m.SelectedScientistName.ToLower().Contains(searchValue))
                                        || (m.SelectedSubScientistName != null && m.SelectedSubScientistName.ToLower().Contains(searchValue))
                                        || (m.CompanyName != null && m.CompanyName.ToLower().Contains(searchValue))
                                        || (m.PONumber != null && m.PONumber.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.Price != null && m.Price.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.SelectedProjectType != null && m.SelectedProjectType.ToLower().Contains(searchValue))
                                        || (m.RequiredQty != null && m.RequiredQty.ToLower().Contains(searchValue))
                                        || (m.SelectedAdditionalBatchNo != null && m.SelectedAdditionalBatchNo.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        || (m.MoveProjectDateText != null && m.MoveProjectDateText.ToString().ToLower().Contains(searchValue))
                                        || (m.EstimateCompleteDateText != null && m.EstimateCompleteDateText.ToString().ToLower().Contains(searchValue))
                                        || (m.AdminScientistStatus != null && m.AdminScientistStatus.ToLower().Contains(searchValue))
                                        || (m.ProjectStatustext != null && m.ProjectStatustext.ToLower().Contains(searchValue))
                                        || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                                        || (m.ActivityStatus != null && m.ActivityStatus.ToLower().Contains(searchValue))
                                        || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))).ToList();
                }

                //recordsTotal = model.Count();
                //var data = model.Skip(skip).Take(pageSize).ToList();
                var data = model;

                var jsonResult = Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
                jsonResult.MaxJsonLength = int.MaxValue;
                return jsonResult;

            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }
        }


        [HttpPost]
        public ActionResult LoadProductGLPData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                var searchby = string.Empty;
                var searchbyvalue = string.Empty;
                if (Request.Form.GetValues("radiobuton") != null)
                {
                    searchby = Request.Form.GetValues("radiobuton")[0].ToString();
                }
                if (Request.Form.GetValues("searchbox") != null)
                {
                    searchbyvalue = Request.Form.GetValues("searchbox")[0].ToString().Trim();
                }
                var fltglpstatus = string.Empty;
                if (Request.Form.GetValues("fltglpstatus") != null)
                {
                    fltglpstatus = Request.Form.GetValues("fltglpstatus")[0].ToString().Trim();
                    if ("--Select--" == fltglpstatus)
                    {
                        fltglpstatus = "";
                    }
                }

                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;
                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
                string pursynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);


                var quotationDetailsdata = db.SZ_QuotationDetail.AsQueryable();
                // Getting all Customer data  
                var list = (from i in db.SZ_Quotation
                            join t2 in quotationDetailsdata on i.Id equals t2.QuoteId
                            where t2.MoveToProject == true
                            && string.IsNullOrEmpty(t2.TrackingNo)
                            && (t2.IsOnHold == false || t2.IsOnHold == null)
                            && (t2.ProjectType != inhouseProjectType || t2.ProjectType == null)
                            && i.CompanyId != 208
                            && t2.IsGLP == true
                            orderby t2.GLPAssignDate descending
                            select t2).Distinct().OrderByDescending(x => x.GLPAssignDate).ThenBy(x => x.SrPo).AsQueryable();

                var listItems = new List<SelectListItem>();
                var subscilistItems = new List<SelectListItem>();
                MemoryCacheManager objCache = new MemoryCacheManager();
                var queryData = objCache.Get("cache.queryData", () =>
                {
                    return db.SZ_QueryModule.AsNoTracking().ToList();
                });
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });

                var scienList = objCache.Get("cache.GetScientistId", () =>
                {
                    return db.GetScientistId().ToList();
                });

                var subscienList = objCache.Get("cache.subscienList", () =>
                {
                    return db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();
                });
                var projectList = objCache.Get("cache.projectlist", () =>
                {
                    return db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("project")).ToList();
                });
                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                    subscilistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                });

                ViewBag.ScientistListItem = listItems;

                foreach (var term in subscienList)
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }

                    subscilistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                }
                ViewBag.SubScientistListItem = subscilistItems;

                var masterCOAData = objCache.Get("cache.mastercoadata", () =>
                {
                    return db.SZ_MasterCOA.ToList();
                });
                var childcoadata = objCache.Get("cache.childcoadata", () =>
                {
                    return db.SZ_ChildCOA.ToList();
                });
                var productsData = objCache.Get("cache.productsdata", () =>
                {
                    return db.Products.Where(x => x.Published == true && x.Deleted == false).ToList();
                });
                var ReadyToDeliverScientistStatusId = objCache.Get("cache.ReadyToDeliverScientistStatusId", () =>
                {
                    return db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                });
                var inventoryData = objCache.Get("cache.inventoryData", () =>
                {
                    return db.SZ_Inventory.ToList();
                });
                var catList = objCache.Get("cache.categorydata", () =>
                {
                    return db.Categories.Where(x => x.ParentCategoryId == 0 && x.Deleted == false && x.Published).ToList();
                });
                var customerList = objCache.Get("cache.customerdata", () =>
                {
                    return db.SZ_CompanyList.ToList();
                });

                var proIds = list.Select(x => x.ProductId).Distinct().ToList();
                masterCOAData = masterCOAData.Where(x => proIds.Contains(x.ProductId)).ToList();
                var masterCoaIds = masterCOAData.Select(x => x.Id).Distinct().ToList();
                childcoadata = childcoadata.Where(x => masterCoaIds.Contains(x.MasterCOAID.Value)).ToList();
                productsData = productsData.Where(x => proIds.Contains(x.Id) && x.Published == true && x.Deleted == false).ToList();
                inventoryData = inventoryData.Where(x => proIds.Contains(x.ProductId)).ToList();

                if (!string.IsNullOrEmpty(fltglpstatus))
                {
                    int glpst = Convert.ToInt32(fltglpstatus);
                    list = list.Where(x => x.GLPStatus == glpst).AsQueryable();
                }

                //if (!string.IsNullOrEmpty(scinameFilter))
                //{
                //    int sciid = Convert.ToInt32(scinameFilter);
                //    list = list.Where(x => x.ScientistCustomerId == sciid).AsQueryable();
                //}
                //if (!string.IsNullOrEmpty(subscinameFilter))
                //{
                //    string subsciid = Convert.ToString(subscinameFilter);
                //    list = list.Where(x => x.SubScientistName == subsciid).AsQueryable();
                //}
                //if (!string.IsNullOrEmpty(fltprostatusItem))
                //{
                //    if (fltprostatusItem == "blank")
                //    {
                //        list = list.Where(x => !string.IsNullOrEmpty(x.ProStatus)).AsQueryable();
                //    }
                //    else
                //    {
                //        list = list.Where(x => x.ProStatus == fltprostatusItem).AsQueryable();
                //    }
                //}
                //if (!string.IsNullOrEmpty(fltprotypeItem))
                //{
                //    list = list.Where(x => x.ProjectType == fltprotypeItem).AsQueryable();
                //}
                //if (!string.IsNullOrEmpty(fltestdate))
                //{
                //    DateTime estdat = Convert.ToDateTime(fltestdate);
                //    list = list.Where(x => x.EstimateCompleteDate == estdat).AsQueryable();
                //}

                //if (!string.IsNullOrEmpty(fltactivity))
                //{
                //    list = list.Where(x => x.ActivityStatus == fltactivity).AsQueryable();
                //}
                //if (!string.IsNullOrEmpty(fltpriority) && fltpriority == "true")
                //{
                //    list = list.Where(x => x.IsPriority == true).AsQueryable();
                //}
                //if (!string.IsNullOrEmpty(fltgeographicallocation) && fltgeographicallocation != "false")
                //{
                //    int gl = Convert.ToInt32(fltgeographicallocation);
                //    list = list.Where(x => x.SZ_Quotation.SZ_CompanyList.GeographicalLocation == gl).AsQueryable();
                //}

                if (!string.IsNullOrEmpty(searchby) && !string.IsNullOrEmpty(searchbyvalue))
                {
                    searchbyvalue = searchbyvalue.ToLower();
                    if (searchbyvalue.Contains("+"))
                    {
                        List<string> searchlist = searchbyvalue.Split('+').Select(p => p.Trim()).ToList();

                        List<SZ_QuotationDetail> objmodel = new List<SZ_QuotationDetail>();
                        foreach (var item in searchlist)
                        {
                            var d = list.Where(x => x.SZ_Quotation.CompanyName.Contains(item) ||
                                                x.SZ_Quotation.PONo.ToLower().Contains(item) ||
                                                x.ProductName.ToLower().Contains(item) ||
                                                (x.CASNo != null ? x.CASNo.ToLower().Contains(item) : false) ||
                                                (x.CATNo != null ? x.CATNo.ToLower().Contains(item) : false) ||
                                               (x.BatchNo != null ? x.BatchNo.ToLower().Contains(item) : false)).ToList();
                            if (d != null && d.Count > 0)
                            {
                                objmodel.AddRange(d);
                            }
                        }
                        if (objmodel != null && objmodel.Count > 0)
                        {
                            list = objmodel.AsQueryable();
                        }
                    }
                    else
                    {
                        if (searchby == "quoteid")
                        {
                            list = list.Where(x => x.SZ_Quotation.Ref.ToLower().Contains(searchbyvalue)).AsQueryable();
                        }
                        if (searchby == "ponumber")
                        {
                            list = list.Where(x => x.SZ_Quotation.PONo.ToLower().Contains(searchbyvalue)).AsQueryable();
                        }
                        if (searchby == "company")
                        {
                            list = list.Where(x => x.SZ_Quotation.CompanyName.ToLower().Contains(searchbyvalue)).AsQueryable();
                        }
                        if (searchby == "productname")
                        {
                            list = list.Where(x => x.ProductName.ToLower().Contains(searchbyvalue)).AsQueryable();
                        }
                        if (searchby == "cas")
                        {
                            list = list.Where(x => x.CASNo != null ? x.CASNo.ToLower().Contains(searchbyvalue) : false).AsQueryable();
                        }
                        if (searchby == "cat")
                        {
                            list = list.Where(x => x.CATNo != null ? x.CATNo.ToLower().Contains(searchbyvalue) : false).AsQueryable();
                        }
                        if (searchby == "batchno")
                        {
                            var bid = db.SZ_Inventory.Where(x => x.BatchNo.Trim().ToLower() == searchbyvalue).Select(x => x.Id).FirstOrDefault();
                            list = list.Where(x => x.AdditionalBatchNo == bid).AsQueryable();
                        }
                        if (searchby == "other")
                        {
                            list = list.Where(x => x.Remark.ToLower().Contains(searchbyvalue) || x.Reason.ToLower().Contains(searchbyvalue)).AsQueryable();
                        }
                    }
                }

                string internationcompanylist = "";
                if (SessionCookieManagement.IsInternational)
                {
                    internationcompanylist = db.SZ_UserManagement.Where(x => x.UserId == SessionCookieManagement.UserId).Select(x => x.CompanyIds).FirstOrDefault();
                    if (!string.IsNullOrEmpty(internationcompanylist))
                    {
                        List<int?> cidList = new List<int?>();
                        foreach (var item in internationcompanylist.Split(','))
                        {
                            if (!string.IsNullOrEmpty(item))
                            {
                                cidList.Add(Convert.ToInt32(item));
                            }
                        }
                        list = list.Where(x => cidList.Contains(x.SZ_Quotation.CompanyId) && x.SZ_Quotation.CreatedDate >= new DateTime(2022, 05, 01)).AsQueryable();
                    }
                }

                recordsTotal = list.Count();
                var outlist = list.Skip(() => skip).Take(() => pageSize).ToList();
                var model = new List<ProjectListModel>();
                var proids = outlist.Select(x => x.ProductId).ToList();
                var maincatnamelist = (from i in db.Products
                                       where i.Published == true && i.Deleted == false
                                       && proids.Contains(i.Id)
                                       select new
                                       {
                                           Id = i.Id,
                                           MainCatName = i.MainCatName,
                                           CASNo = i.ManufacturerPartNumber
                                       }).ToList();
                var szSAPrawmaterial = (from i in db.SZ_SAPProjectNameData.ToList()
                                        join t2 in maincatnamelist on i.ProjectName equals t2.MainCatName
                                        select t2.Id).ToList();

                outlist.ForEach(k =>
                {
                    ProjectListModel subList = new ProjectListModel();
                    if (k.SZ_ReactionMatrix != null && k.SZ_ReactionMatrix.Count > 0)
                    {
                        subList.Attachment = "<a href = 'javascript:void(0)' onclick='showreactionmatrix(" + k.Id + ")'><i class='fa fa-paperclip'></i></a>";
                    }

                    if (k.ProductId.HasValue && szSAPrawmaterial.Contains(k.ProductId.Value))
                    {
                        //subList.SAPRawMaterial = "<a href = 'javascript:void(0)' onclick='getrawmaterialdata(" + k.ProductId + ")'><img src='/img/flask-icon.png' style='width:16px; height: 16px;' /></a>";
                        subList.SAPRawMaterial = "<a href = 'javascript:void(0)' onclick='getrawmaterialdatabyproject(" + k.ProductId + ")'><i class='fa fa-flask'></i></a>";
                    }

                    subList.GLP = "<select id='IsGLP_" + k.Id + "' class='clsIsGLP' data-quoteDetailsId='" + k.Id + "'><option value='false'>No</option>";
                    if (k.IsGLP.HasValue && k.IsGLP.Value)
                    {
                        subList.GLP += "<option value='true' selected>Yes</option>";
                    }
                    else
                    {
                        subList.GLP += "<option value='true'>Yes</option>";
                    }
                    subList.GLP += "</select>";
                    subList.GLPAssignDate = k.GLPAssignDate;
                    if (k.GLPAssignDate.HasValue)
                    {
                        subList.GLPAssignDateText = k.GLPAssignDate.Value.ToShortDateString();
                    }

                    if (!string.IsNullOrEmpty(k.GLPStabilityPath))
                    {
                        subList.GLPStabilityPath = "<a download href='" + k.GLPStabilityPath + "' target='blank' ><i class='fa fa-download'></i></a>";
                    }
                    if (!string.IsNullOrEmpty(k.GLPAMVPath))
                    {
                        subList.GLPAMVPath = "<a download href='" + k.GLPAMVPath + "' target='blank' ><i class='fa fa-download'></i></a>";
                    }
                    subList.GLPRemark = "<i class='fa fa-pencil' onclick='GLPRemarkGenerate(\"" + k.Id + "\")' ></i>"; //<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";
                    subList.GLPStatus = "<select id='GLPStatus_" + k.Id + "' class='clsGLPStatus' data-quoteDetailsId='" + k.Id + "'>";
                    if (k.GLPStatus.HasValue && k.GLPStatus.Value == 1)
                    {
                        subList.GLPStatus += "<option value='1' selected>Pending</option>";
                    }
                    else
                    {
                        subList.GLPStatus += "<option value='1'>Pending</option>";
                    }
                    if (k.GLPStatus.HasValue && k.GLPStatus.Value == 2)
                    {
                        subList.GLPStatus += "<option value='2' selected>Release</option>";
                    }
                    else
                    {
                        subList.GLPStatus += "<option value='2'>Release</option>";
                    }
                    if (k.GLPStatus.HasValue && k.GLPStatus.Value == 3)
                    {
                        subList.GLPStatus += "<option value='3' selected>Reject</option>";
                    }
                    else
                    {
                        subList.GLPStatus += "<option value='3'>Reject</option>";
                    }
                    subList.GLPStatus += "</select>";
                    subList.IsConversionReport = k.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    subList.SAPCode = k.SZ_Quotation.SZ_CompanyList.SAPCode;
                    subList.CountEstDate = k.CountEstDate.HasValue ? k.CountEstDate.Value : 0;
                    subList.ChkSaveRow = "<input type='checkbox' value='" + k.Id + "' class='clsSaverow' />";
                    subList.ReadyToDeliverScientistStatusId = ReadyToDeliverScientistStatusId;
                    if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == subList.ReadyToDeliverScientistStatusId && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                    {
                        subList.ChkFirstRow = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                    }
                    else if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == subList.ReadyToDeliverScientistStatusId)
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' />";
                    }
                    else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && (k.MoveToDispatch == null || k.MoveToDispatch == false))
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' />";
                    }
                    else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                    {
                        subList.ChkFirstRow = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                    }
                    if (k.IsDispatchApprove.HasValue && k.IsDispatchApprove.Value && (k.MoveToDispatch == null || k.MoveToDispatch == false))
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' style='outline: 4px solid #c00'/>";
                    }
                    if (k.IsCancel.HasValue && k.IsCancel.Value)
                    {
                        subList.ChkFirstRow = "";
                        subList.ChkSaveRow = "";
                    }
                    subList.ProjectType = k.ProjectType;
                    subList.ApprovedForClient = k.ApprovedForClient;
                    if (k.ApprovedForClient.HasValue && k.ApprovedForClient.Value)
                    {
                        subList.ApprovedForClientText = "<input type='checkbox' value='" + k.Id + "' class='clsApprovedForClient' checked='checked'/>";
                    }
                    else
                    {
                        subList.ApprovedForClientText = "<input type='checkbox' value='" + k.Id + "' class='clsApprovedForClient' />";
                    }
                    subList.ProjectTypeText = "<select id='projecttype_" + k.Id + "' class='clsProjType' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ProjectType), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.ProjectType)
                        {
                            selected = "selected ";
                            subList.SelectedProjectType = text;
                        }
                        //if (text != "In-House")
                        //{
                            subList.ProjectTypeText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                        //}
                    }
                    subList.ProjectTypeText += "</select>";
                    subList.IsPaymentPending = k.SZ_Quotation.SZ_CompanyList.IsPaymentPending;
                    subList.ActivityStatus = k.ActivityStatus;
                    subList.TechnicalEmail = k.TechnicalEmail;
                    subList.ActivityStatusText = "<select id='activitystatus_" + k.Id + "' class='clsActivityStatus' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    if (k.ActivityStatus == "Approval First")
                    {
                        subList.ActivityStatusText += "<option value='Approval First' selected>Approval First</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Approval First'>Approval First</option>";
                    }
                    if (k.ActivityStatus == "Immediate Dispatch")
                    {
                        subList.ActivityStatusText += "<option value='Immediate Dispatch' selected>Immediate Dispatch</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Immediate Dispatch'>Immediate Dispatch</option>";
                    }

                    if (k.ActivityStatus == "Repeat Order")
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order' selected>Repeat Order</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order'>Repeat Order</option>";
                    }

                    if (k.ActivityStatus == "Repeat Order - Dispatch")
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Dispatch' selected>Repeat Order - Dispatch</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Dispatch'>Repeat Order - Dispatch</option>";
                    }
                    if (k.ActivityStatus == "Repeat Order - Approval First")
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Approval First' selected>Repeat Order - Approval First</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Approval First'>Repeat Order - Approval First</option>";
                    }
                    if (k.ActivityStatus == "Short Qty Dispatch")
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatch' selected>Short Qty Dispatch</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatch'>Short Qty Dispatch</option>";
                    }
                    if (k.ActivityStatus == "Short Qty Dispatched")
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatched' selected>Short Qty Dispatched</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatched'>Short Qty Dispatched</option>";
                    }
                    if (k.ActivityStatus == "Sample Request")
                    {
                        subList.ActivityStatusText += "<option value='Sample Request' selected>Sample Request</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Sample Request'>Sample Request</option>";
                    }
                    if (k.ActivityStatus == "Sample Sent")
                    {
                        subList.ActivityStatusText += "<option value='Sample Sent' selected>Sample Sent</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Sample Sent'>Sample Sent</option>";
                    }
                    if (k.ActivityStatus == "Sample Approved")
                    {
                        subList.ActivityStatusText += "<option value='Sample Approved' selected>Sample Approved</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Sample Approved'>Sample Approved</option>";
                    }
                    //if (k.ActivityStatus == "Insufficient QTY")
                    //{
                    //    subList.ActivityStatusText += "<option value='Insufficient QTY' selected>Insufficient QTY</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Insufficient QTY'>Insufficient QTY</option>";
                    //}
                    if (k.ActivityStatus == "Quote - Data Sent")
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Sent' selected>Quote - Data Sent</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Sent'>Quote - Data Sent</option>";
                    }
                    if (k.ActivityStatus == "Quote - Data Approved")
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Approved' selected>Quote - Data Approved</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Approved'>Quote - Data Approved</option>";
                    }
                    subList.ActivityStatusText += "</select>";
                    //subList.APIName = GetApiNameOfProduct(k.ProductId.Value, proCat, catList);
                    subList.ScientistName = "<select id='ScientistId_" + k.Id + "' class='scientist' scientistId='" + k.ScientistCustomerId + "' quotedetailsid='" + k.Id + "'><option value=''>--Select--</option>";
                    listItems.ForEach(r =>
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.ScientistCustomerId))
                        {
                            selected = "selected ";
                            subList.SelectedScientistName = r.Text;
                        }
                        subList.ScientistName += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    });

                    subList.ScientistName += "</select>";
                    if (!string.IsNullOrEmpty(k.SubScientistName))
                    {
                        var subsci = System.Text.RegularExpressions.Regex.IsMatch(k.SubScientistName, @"\d+");
                        if (subsci)
                        {
                            if (System.Text.RegularExpressions.Regex.Match(k.SubScientistName, @"\d+").Value == k.SubScientistName)
                            {
                                subList.SubScientistCustomerId = Convert.ToInt32(k.SubScientistName);
                            }
                        }
                    }

                    subList.SubScientistName = "<select id='SubScientistId_" + k.Id + "' class='subscientist' subscientistId='" + k.SubScientistName + "' quotedetailsid='" + k.Id + "'><option value=''>--Select--</option>";
                    subscilistItems.ForEach(r =>
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.SubScientistName))
                        {
                            selected = "selected ";
                            subList.SelectedSubScientistName = r.Text;
                        }
                        subList.SubScientistName += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    });

                    subList.SubScientistName += "</select>";

                    if (!string.IsNullOrEmpty(k.SZ_Quotation.Attachment))
                    {
                        subList.Attachment = "<a href = 'javascript:void(0)' onclick='attachment(" + k.QuoteId + ")'><i class='fa fa-paperclip'></i></a>";
                    }
                    subList.MoveProjectDateText = k.MoveProjectDate.HasValue ? k.MoveProjectDate.Value.ToString("dd/MM/yyyy hh:mm tt") : "";
                    subList.AdditionalBatchNo = k.AdditionalBatchNo;
                    subList.QuoteId = k.QuoteId;
                    subList.ProductId = k.ProductId;
                    subList.ProductName = k.ProductName;
                    subList.ScientistRemark = "<input id='sciremark_" + k.Id + "' type='text' value='" + k.ScientistRemark + "' style='width: 170px' />";
                    subList.RequiredQtyTxt = "<input id='qty_" + k.Id + "' type='text' value='" + k.RequiredQty + "' style='width: 50px; font-weight:bold' />";

                    if (!string.IsNullOrEmpty(k.ExplainationSecond))
                    {
                        subList.ExplainationSecondText = "<input id='explainationsecond_" + k.Id + "' type='text' value='" + k.ExplainationSecond.Replace("'", "&#8242;") + "' title='" + k.ExplainationSecond + "' style='width: 200px; font-weight:bold' />";
                    }
                    else
                    {
                        subList.ExplainationSecondText = "<input id='explainationsecond_" + k.Id + "' type='text' value='" + k.ExplainationSecond + "' title='" + k.ExplainationSecond + "' style='width: 200px; font-weight:bold' />";
                    }

                    subList.ExplainationSecond = k.ExplainationSecond;
                    subList.LastWeekUpdate = k.LastWeekUpdate;
                    subList.PaymentTerms = k.SZ_Quotation.PaymentTerm;
                    subList.AdditionalBatchNoText = "";
                    if (subList.ProductId.HasValue)
                    {
                        var proData = productsData.Where(x => x.Id == subList.ProductId).FirstOrDefault();
                        if (proData != null)
                        {
                            subList.IsControlledSubstance = proData.IsControlledSubstance;
                            if (!subList.IsControlledSubstance.HasValue
                                || subList.IsControlledSubstance == false)
                            {
                                subList.IsControlledSubstance = proData.IsManuallyControlledSubstance;
                            }
                        }
                        if (proData != null && proData.SZ_ProductScheme != null && proData.SZ_ProductScheme.Count > 0)
                        {
                            //if (SessionCookieManagement.IsAdmin)
                            //{
                            subList.ProductScheme = "<i class='fa fa-eye' onclick='ViewProductScheme(" + k.ProductId + ")' ></i>";
                            //}
                        }
                        var proBatchData = inventoryData.Where(x => x.ProductId == subList.ProductId).OrderByDescending(x => x.Id).Take(3).ToList();
                        if (proBatchData.Count > 0 && proData != null)
                        {
                            proBatchData.ForEach(r =>
                            {
                                //var qty = System.Text.RegularExpressions.Regex.Match(Convert.ToString(r.Qty), @"\d+").Value;
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }
                                string selected = string.Empty;
                                if (r.Id == subList.AdditionalBatchNo)
                                {
                                    selected = "selected ";
                                    subList.BatchNo = r.BatchNo;
                                    subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
                                }
                                subList.AdditionalBatchNoText += r.BatchNo + ", ";
                            });
                        }
                    }
                    subList.CompanyName = k.SZ_Quotation.CompanyName;
                    if (k.SZ_Quotation.SZ_CompanyList.ProjectTeam.HasValue)
                    {
                        //var projectuser = projectList.Where(x => x.Id == k.SZ_Quotation.SZ_CompanyList.ProjectTeam).FirstOrDefault();
                        //if (projectuser != null)
                        //{
                        string customerName = string.Empty;
                        var genericAttr = genericData.Where(x => x.EntityId == k.SZ_Quotation.SZ_CompanyList.ProjectTeam.Value).ToList();
                        if (genericAttr.Count > 0)
                        {
                            customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                        }
                        subList.ProjectAssignName = customerName;
                        //}
                    }
                    subList.Email = k.SZ_Quotation.EmailAddress;
                    subList.PONumber = k.SZ_Quotation.PONo;
                    subList.Ref = k.SZ_Quotation.Ref;
                    subList.Remark = k.Remark;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.QuoteDetailsId = k.Id;
                    subList.CASNo = k.CASNo;
                    var pName = "";
                    var query = queryData.Where(x => x.CATNo.Trim().ToLower() == k.CATNo.Trim().ToLower()).OrderByDescending(x => x.Id);
                    if (query != null && query.Count() > 0)
                    {
                        var qlist = query.Select(x => x.QueryNo).ToArray();
                        if (query.Select(x => x.Status.ToLower()).FirstOrDefault() == "solved" ||
                        query.Select(x => x.Status.ToLower()).FirstOrDefault() == "close" ||
                        query.Select(x => x.Status.ToLower()).FirstOrDefault() == "completed")
                        {
                            pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + k.CATNo + "\")' title='" + string.Join(", ", qlist) + "' style ='float:right; color: green' ></i>";
                        }
                        else
                        {
                            pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + k.CATNo + "\")' title='" + string.Join(", ", qlist) + "' style ='float:right' ></i>";
                        }
                    }
                    subList.IsConversionReport = k.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    var impstr = "";
                    if (subList.IsConversionReport.HasValue && subList.IsConversionReport.Value)
                    {
                        impstr += "<img src='/img/important.jpg' width='15px' height='15px' />";
                    }
                    subList.CATNo = pName + "" + "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>  <i class='fa fa-search' onclick='SearchDefault(\"cat\", \"" + k.CATNo + "\")' ></i>" + impstr;
                    subList.CreatedDate = k.CreatedDate;
                    subList.ImagePath = k.ImagePath;
                    subList.IsUploadServer = k.IsUploadServer;
                    subList.LeadTime = k.LeadTime;
                    subList.Price = k.Price;
                    subList.QuoteId = k.QuoteId;
                    subList.ProjectType = k.ProjectType;
                    subList.ScientistCustomerId = k.ScientistCustomerId;
                    subList.RequiredQty = k.RequiredQty;
                    subList.ProjectStatus = k.ProjectStatus;
                    subList.IsOnHold = k.IsOnHold;
                    if (k.ProjectStatus != null)
                    {
                        subList.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
                    }
                    subList.ScientistStatus = k.ScientistStatus;
                    subList.BatchCode1 = k.BatchCode1;
                    subList.BatchCode2 = k.BatchCode2;
                    subList.Qty1 = k.Qty1;
                    subList.Qty2 = k.Qty2;
                    subList.EstimateCompleteDate = k.EstimateCompleteDate;
                    subList.EstimateCompleteDateText = "<input id='esticompleteDate_" + k.Id + "' data-value='" + k.EstimateCompleteDate + "' type='text' class='datepicker'  style='width:80px' />";

                    subList.AnalysisCompletionDate = "<input id='analysisCompletionDate_" + k.Id + "' data-value='" + k.GLPAnalysisCompletionDate + "' type='text' class='datepicker'  style='width:80px' />";

                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToProject = k.MoveToProject;
                    subList.Remark = k.Remark;
                    subList.SrPo = k.SrPo;
                    subList.AdminScientistStatus = k.AdminScientistStatus;
                    subList.InvoiceNo = k.InvoiceNo;
                    subList.InvoiceRemark = k.InvoiceRemark;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.ScientistStatustext = "<input id='scientistStatus_" + k.Id + "' type='text' value='" + k.AdminScientistStatus + "' title='" + k.AdminScientistStatus + "'  style='width:200px' />";
                    subList.RemarkText = "<input id='remark_" + k.Id + "' type='text' value='" + k.Remark + "' title='" + k.Remark + "' style='width: 170px' />";
                    subList.LastRowText = "<a href='javascript: void(0)' id='save_" + k.Id + "' onclick='SaveProjectDetails(\"" + k.Id + "\")'> Save</a> ";
                    subList.LastRowText += "<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";

                    subList.GetAllBatch = "<i class='fa fa-clone' title='View Batch No' onclick='GetAllBatchNo(" + k.ProductId + ", " + k.Id + ")'></i>";
                    subList.DispatchedStatus = k.DispatchedStatus;
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToInvoice = k.MoveToInvoice;
                    subList.IsDispatchApprove = k.IsDispatchApprove;
                    subList.IsPayment = k.IsPayment;
                    if (k.IsPayment.HasValue && k.IsPayment.Value)
                    {
                        subList.IsPaymentText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPayment' checked='checked'/>";
                    }
                    else
                    {
                        subList.IsPaymentText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPayment' />";
                    }

                    subList.OrderRemark = k.OrderRemark;
                    subList.OrderRemarkText = "<input id='orderremark_" + k.Id + "' type='text' value='" + k.OrderRemark + "' title='" + k.OrderRemark + "'  style='width:200px' />";

                    subList.Reason = k.Reason;
                    subList.ReasonText = "<input id='reason_" + k.Id + "' type='text' value='" + k.Reason + "' title='" + k.Reason + "'  style='width:200px' />";

                    if (k.MoveToScientistDate.HasValue)
                    {
                        subList.MoveToScientistDateStr = k.MoveToScientistDate.Value.ToShortDateString();
                    }

                    subList.InhouseRemarkText = "<i class='fa fa-pencil' onclick='InhouseRemarkGenerate(\"" + k.Id + "\")' ></i>"; //<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";
                    subList.ExplainationText += "<i class='fa fa-pencil' onclick='explainationGenerate(\"" + k.Id + "\")' ></i>"; //<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";
                    subList.DifficultyLevel = k.DifficultyLevel;
                    subList.DifficultyLevelText = "<select id='difflevel_" + k.Id + "' class='clsDifficultyLevel' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.DifficultyLevel r in Enum.GetValues(typeof(EnumList.DifficultyLevel)))
                    {
                        var item = Enum.GetName(typeof(EnumList.DifficultyLevel), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.DifficultyLevel)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.DifficultyLevel)
                        {
                            selected = "selected ";
                        }
                        subList.DifficultyLevelText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                    }
                    subList.DifficultyLevelText += "</select>";

                    subList.IsPriority = k.IsPriority;
                    if (k.IsPriority.HasValue && k.IsPriority.Value)
                    {
                        subList.IsPriorityText = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                        //subList.IsPriorityText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPriority' checked='checked'/>";
                    }
                    else
                    {
                        //subList.IsPriorityText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPriority' />";
                    }
                    subList.ProStatus = k.ProStatus;
                    subList.ProStatusText = "<select id='prostatus_" + k.Id + "' class='clsProjStatus' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.ProStatusDDL r in Enum.GetValues(typeof(EnumList.ProStatusDDL)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ProStatusDDL), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ProStatusDDL)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.ProStatus)
                        {
                            selected = "selected ";
                            subList.SelectedProStatus = text;
                        }
                        subList.ProStatusText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                    }
                    subList.ProStatusText += "</select>";
                    subList.COAId = k.COAId;
                    subList.COARefNumber = k.COARefNumber;
                    string coaText = "";

                    coaText = "<select id='coa_" + k.Id + "' class='addcoa'><option value=''>--Select--</option>";
                    int bId = k.AdditionalBatchNo.HasValue ? k.AdditionalBatchNo.Value : 0;
                    if (bId != 0)
                    {
                        var mastercoa = masterCOAData.Where(x => x.BatchId == bId).FirstOrDefault();
                        if (mastercoa != null)
                        {
                            var listchildcoa = childcoadata.Where(x => x.MasterCOAID == mastercoa.Id).ToList();
                            if (listchildcoa != null && listchildcoa.Count > 0)
                            {
                                foreach (var ccoa in listchildcoa)
                                {
                                    if (k.COAId == ccoa.Id)
                                    {
                                        coaText += "<option value='" + ccoa.Id.ToString() + "' data-value='" + k.AdditionalBatchNo + "' selected>" + ccoa.RefNo + "</option>";
                                    }
                                    else
                                    {
                                        coaText += "<option value='" + ccoa.Id.ToString() + "' data-value='" + k.AdditionalBatchNo + "'>" + ccoa.RefNo + "</option>";
                                    }
                                }
                            }
                        }
                    }
                    subList.COAText = coaText;
                    subList.CompanyId = k.SZ_Quotation.CompanyId;
                    subList.ActionRow = "<a href='javascript:void(0)' onclick='uploadglpfiles(" + k.Id + ")'><i class='fa fa-paperclip'></i></a>";

                    model.Add(subList);
                });

                model = model.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).ToList();

                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.SelectedScientistName != null && m.SelectedScientistName.ToLower().Contains(searchValue))
                                        || (m.SelectedSubScientistName != null && m.SelectedSubScientistName.ToLower().Contains(searchValue))
                                        || (m.CompanyName != null && m.CompanyName.ToLower().Contains(searchValue))
                                        || (m.PONumber != null && m.PONumber.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.Price != null && m.Price.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.SelectedProjectType != null && m.SelectedProjectType.ToLower().Contains(searchValue))
                                        || (m.RequiredQty != null && m.RequiredQty.ToLower().Contains(searchValue))
                                        || (m.SelectedAdditionalBatchNo != null && m.SelectedAdditionalBatchNo.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        || (m.MoveProjectDateText != null && m.MoveProjectDateText.ToString().ToLower().Contains(searchValue))
                                        || (m.EstimateCompleteDateText != null && m.EstimateCompleteDateText.ToString().ToLower().Contains(searchValue))
                                        || (m.AdminScientistStatus != null && m.AdminScientistStatus.ToLower().Contains(searchValue))
                                        || (m.ProjectStatustext != null && m.ProjectStatustext.ToLower().Contains(searchValue))
                                        || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                                        || (m.ActivityStatus != null && m.ActivityStatus.ToLower().Contains(searchValue))
                                        || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))).ToList();
                }

                //recordsTotal = model.Count();
                //var data = model.Skip(skip).Take(pageSize).ToList();
                var data = model;

                var jsonResult = Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
                jsonResult.MaxJsonLength = int.MaxValue;
                return jsonResult;

            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }
        }

        public ActionResult ViewQuoteDetailsId(int id)
        {
            var modal = _operationRepository.GetQuoteDetailByID(id);

            var listItems = new List<SelectListItem>();
            var subscilistItems = new List<SelectListItem>();
            MemoryCacheManager objCache = new MemoryCacheManager();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });

            var scienList = objCache.Get("cache.GetScientistId", () =>
            {
                return db.GetScientistId().ToList();
            });

            var subscienList = objCache.Get("cache.subscienList", () =>
            {
                return db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();
            });
            scienList.ForEach(term =>
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                listItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.ToString()
                });
                subscilistItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.ToString()
                });
            });

            ViewBag.ScientistListItem = listItems;
            foreach (var term in subscienList)
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == term.Id).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }

                subscilistItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.Id.ToString()
                });

            }

            if (modal.ScientistCustomerId.HasValue)
            {
                var scid = Convert.ToString(modal.ScientistCustomerId);
                ViewBag.ScientistName = subscilistItems.Where(x => x.Value == scid).Select(x => x.Text).FirstOrDefault();
            }
            if (!string.IsNullOrEmpty(modal.SubScientistName))
            {
                var subsci = System.Text.RegularExpressions.Regex.IsMatch(modal.SubScientistName, @"\d+");
                if (subsci)
                {
                    if (System.Text.RegularExpressions.Regex.Match(modal.SubScientistName, @"\d+").Value == modal.SubScientistName)
                    {
                        ViewBag.SubScientistName = subscilistItems.Where(x => x.Value == modal.SubScientistName).Select(x => x.Text).FirstOrDefault();
                    }
                }
                else
                {
                    ViewBag.SubScientistName = modal.SubScientistName;
                }
            }


            var html = PartialViewdata(this, "_PartialQuoteDetails", modal);
            return Json(html, JsonRequestBehavior.AllowGet);
        }


        [HttpPost]
        public ActionResult LoadProductControlledsubstanceData(bool iscompleted = false)
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                var fltLicesenStatus = "";
                if (Request.Form.GetValues("fltLicesenStatus") != null)
                {
                    fltLicesenStatus = Request.Form.GetValues("fltLicesenStatus")[0].ToString();
                }
                var searchby = string.Empty;
                var searchbyvalue = string.Empty;
                if (Request.Form.GetValues("radiobuton") != null)
                {
                    searchby = Request.Form.GetValues("radiobuton")[0].ToString();
                }
                if (Request.Form.GetValues("searchbox") != null)
                {
                    searchbyvalue = Request.Form.GetValues("searchbox")[0].ToString().Trim();
                }
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;
                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
                string pursynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
                //var quotationDetailsdata = db.SZ_QuotationDetail.AsQueryable();
                var substanceproductIds = db.Products.Where(x => x.IsControlledSubstance == true
                                        || x.IsManuallyControlledSubstance == true).Select(x => x.Id).ToList();

                // Getting all Customer data  
                var list = (from i in db.SZ_Quotation.AsNoTracking()
                            join t2 in db.SZ_QuotationDetail.AsNoTracking() on i.Id equals t2.QuoteId
                            where t2.MoveToProject == true
                            //&& string.IsNullOrEmpty(t2.TrackingNo)
                            && (t2.IsOnHold == false || t2.IsOnHold == null)
                            && (t2.ProjectType != inhouseProjectType || t2.ProjectType == null)
                            && i.CompanyId != 208
                            && t2.ProductId.HasValue
                            && substanceproductIds.Contains(t2.ProductId.Value)
                            orderby t2.MoveProjectDate descending
                            select t2).Distinct().OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).AsQueryable();

                if (iscompleted)
                {
                    list = list.Where(x => x.LicesenStatusId.HasValue && x.LicesenStatusId.Value == 2).AsQueryable();
                }
                else
                {
                    list = list.Where(x => (x.MoveToInvoice == false || x.MoveToInvoice == null)
                                        //&& (x.MoveToDispatch == false || x.MoveToDispatch == null)
                                        && (x.LicesenStatusId == null || (x.LicesenStatusId.HasValue && x.LicesenStatusId.Value != 2))).AsQueryable();
                }
                if (!string.IsNullOrEmpty(fltLicesenStatus))
                {
                    var lcids = fltLicesenStatus.Split(',');
                    List<int> lcid = new List<int>();
                    foreach (var lc in lcids)
                    {
                        lcid.Add(Convert.ToInt32(lc));
                    }
                    //var lcid = Convert.ToInt32(fltLicesenStatus);
                    list = list.Where(x => x.LicesenStatusId.HasValue && lcid.Contains(x.LicesenStatusId.Value)).AsQueryable();
                }

                var listItems = new List<SelectListItem>();
                var subscilistItems = new List<SelectListItem>();
                MemoryCacheManager objCache = new MemoryCacheManager();
                var queryData = objCache.Get("cache.queryData", () =>
                {
                    return db.SZ_QueryModule.AsNoTracking().ToList();
                });
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });

                var scienList = objCache.Get("cache.GetScientistId", () =>
                {
                    return db.GetScientistId().ToList();
                });

                var subscienList = objCache.Get("cache.subscienList", () =>
                {
                    return db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();
                });
                var projectList = objCache.Get("cache.projectlist", () =>
                {
                    return db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("project")).ToList();
                });
                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                    subscilistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                });

                ViewBag.ScientistListItem = listItems;

                foreach (var term in subscienList)
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }

                    subscilistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                }
                ViewBag.SubScientistListItem = subscilistItems;

                var masterCOAData = objCache.Get("cache.mastercoadata", () =>
                {
                    return db.SZ_MasterCOA.ToList();
                });
                var childcoadata = objCache.Get("cache.childcoadata", () =>
                {
                    return db.SZ_ChildCOA.ToList();
                });
                var productsData = objCache.Get("cache.productsdata", () =>
                {
                    return db.Products.Where(x => x.Published == true && x.Deleted == false).ToList();
                });
                var ReadyToDeliverScientistStatusId = objCache.Get("cache.ReadyToDeliverScientistStatusId", () =>
                {
                    return db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                });
                var inventoryData = objCache.Get("cache.inventoryData", () =>
                {
                    return db.SZ_Inventory.ToList();
                });
                var catList = objCache.Get("cache.categorydata", () =>
                {
                    return db.Categories.Where(x => x.ParentCategoryId == 0 && x.Deleted == false && x.Published).ToList();
                });
                var customerList = objCache.Get("cache.customerdata", () =>
                {
                    return db.SZ_CompanyList.ToList();
                });

                var proIds = list.Select(x => x.ProductId).Distinct().ToList();
                masterCOAData = masterCOAData.Where(x => proIds.Contains(x.ProductId)).ToList();
                var masterCoaIds = masterCOAData.Select(x => x.Id).Distinct().ToList();
                childcoadata = childcoadata.Where(x => masterCoaIds.Contains(x.MasterCOAID.Value)).ToList();
                productsData = productsData.Where(x => proIds.Contains(x.Id) && x.Published == true && x.Deleted == false).ToList();
                inventoryData = inventoryData.Where(x => proIds.Contains(x.ProductId)).ToList();

                if (!string.IsNullOrEmpty(searchby) && !string.IsNullOrEmpty(searchbyvalue))
                {
                    searchbyvalue = searchbyvalue.ToLower();
                    if (searchbyvalue.Contains("+"))
                    {
                        List<string> searchlist = searchbyvalue.Split('+').Select(p => p.Trim()).ToList();

                        List<SZ_QuotationDetail> objmodel = new List<SZ_QuotationDetail>();
                        foreach (var item in searchlist)
                        {
                            var d = list.Where(x => x.SZ_Quotation.CompanyName.Contains(item) ||
                                                x.SZ_Quotation.PONo.ToLower().Contains(item) ||
                                                x.ProductName.ToLower().Contains(item) ||
                                                (x.CASNo != null ? x.CASNo.ToLower().Contains(item) : false) ||
                                                (x.CATNo != null ? x.CATNo.ToLower().Contains(item) : false) ||
                                               (x.BatchNo != null ? x.BatchNo.ToLower().Contains(item) : false)).ToList();
                            if (d != null && d.Count > 0)
                            {
                                objmodel.AddRange(d);
                            }
                        }
                        if (objmodel != null && objmodel.Count > 0)
                        {
                            list = objmodel.AsQueryable();
                        }
                    }
                    else
                    {
                        if (searchby == "quoteid")
                        {
                            list = list.Where(x => x.SZ_Quotation.Ref.ToLower().Contains(searchbyvalue)).AsQueryable();
                        }
                        if (searchby == "ponumber")
                        {
                            list = list.Where(x => x.SZ_Quotation.PONo.ToLower().Contains(searchbyvalue)).AsQueryable();
                        }
                        if (searchby == "company")
                        {
                            list = list.Where(x => x.SZ_Quotation.CompanyName.ToLower().Contains(searchbyvalue)).AsQueryable();
                        }
                        if (searchby == "productname")
                        {
                            list = list.Where(x => x.ProductName.ToLower().Contains(searchbyvalue)).AsQueryable();
                        }
                        if (searchby == "cas")
                        {
                            list = list.Where(x => x.CASNo != null ? x.CASNo.ToLower().Contains(searchbyvalue) : false).AsQueryable();
                        }
                        if (searchby == "cat")
                        {
                            list = list.Where(x => x.CATNo != null ? x.CATNo.ToLower().Contains(searchbyvalue) : false).AsQueryable();
                        }
                        if (searchby == "batchno")
                        {
                            var bid = db.SZ_Inventory.Where(x => x.BatchNo.Trim().ToLower() == searchbyvalue).Select(x => x.Id).FirstOrDefault();
                            list = list.Where(x => x.AdditionalBatchNo == bid).AsQueryable();
                        }
                        if (searchby == "other")
                        {
                            list = list.Where(x => x.Remark.ToLower().Contains(searchbyvalue) || x.Reason.ToLower().Contains(searchbyvalue)).AsQueryable();
                        }
                    }
                }

                string internationcompanylist = "";
                if (SessionCookieManagement.IsInternational)
                {
                    internationcompanylist = db.SZ_UserManagement.Where(x => x.UserId == SessionCookieManagement.UserId).Select(x => x.CompanyIds).FirstOrDefault();
                    if (!string.IsNullOrEmpty(internationcompanylist))
                    {
                        List<int?> cidList = new List<int?>();
                        foreach (var item in internationcompanylist.Split(','))
                        {
                            if (!string.IsNullOrEmpty(item))
                            {
                                cidList.Add(Convert.ToInt32(item));
                            }
                        }
                        list = list.Where(x => cidList.Contains(x.SZ_Quotation.CompanyId) && x.SZ_Quotation.CreatedDate >= new DateTime(2022, 05, 01)).AsQueryable();
                    }
                }

                recordsTotal = list.Count();
                var outlist = list.Skip(() => skip).Take(() => pageSize).ToList();
                var model = new List<ProjectListModel>();
                int srNo = skip + 1;
                outlist.ForEach(k =>
                {
                    ProjectListModel subList = new ProjectListModel();
                    subList.srNo = srNo;

                    srNo += 1;

                    subList.IsConversionReport = k.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    subList.SAPCode = k.SZ_Quotation.SZ_CompanyList.SAPCode;
                    subList.CountEstDate = k.CountEstDate.HasValue ? k.CountEstDate.Value : 0;
                    subList.ChkSaveRow = "<input type='checkbox' value='" + k.Id + "' class='clsSaverow' />";
                    subList.ReadyToDeliverScientistStatusId = ReadyToDeliverScientistStatusId;
                    subList.ChkFirstRow = "<a href='javascript:void(0)' onclick='UploadDocumentOfProduct(\"" + k.Id + "\")'> Upload </a>";
                    //if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == subList.ReadyToDeliverScientistStatusId && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                    //{
                    //    subList.ChkFirstRow = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                    //}
                    //else if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == subList.ReadyToDeliverScientistStatusId)
                    //{
                    //    subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' />";
                    //}
                    //else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && (k.MoveToDispatch == null || k.MoveToDispatch == false))
                    //{
                    //    subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' />";
                    //}
                    //else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                    //{
                    //    subList.ChkFirstRow = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                    //}
                    //if (k.IsDispatchApprove.HasValue && k.IsDispatchApprove.Value && (k.MoveToDispatch == null || k.MoveToDispatch == false))
                    //{
                    //    subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' style='outline: 4px solid #c00'/>";
                    //}
                    //if (k.IsCancel.HasValue && k.IsCancel.Value)
                    //{
                    //    subList.ChkFirstRow = "";
                    //    subList.ChkSaveRow = "";
                    //}
                    subList.ProjectType = k.ProjectType;
                    subList.ApprovedForClient = k.ApprovedForClient;
                    if (k.ApprovedForClient.HasValue && k.ApprovedForClient.Value)
                    {
                        subList.ApprovedForClientText = "<input type='checkbox' value='" + k.Id + "' class='clsApprovedForClient' checked='checked'/>";
                    }
                    else
                    {
                        subList.ApprovedForClientText = "<input type='checkbox' value='" + k.Id + "' class='clsApprovedForClient' />";
                    }
                    subList.ProjectTypeText = "<select id='projecttype_" + k.Id + "' class='clsProjType' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ProjectType), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.ProjectType)
                        {
                            selected = "selected ";
                            subList.SelectedProjectType = text;
                        }
                        //if (text != "In-House")
                        //{
                            subList.ProjectTypeText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                        //}
                    }
                    subList.ProjectTypeText += "</select>";
                    subList.IsPaymentPending = k.SZ_Quotation.SZ_CompanyList.IsPaymentPending;
                    subList.ActivityStatus = k.ActivityStatus;
                    subList.TechnicalEmail = k.TechnicalEmail;
                    subList.ActivityStatusText = "<select id='activitystatus_" + k.Id + "' class='clsActivityStatus' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    if (k.ActivityStatus == "Approval First")
                    {
                        subList.ActivityStatusText += "<option value='Approval First' selected>Approval First</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Approval First'>Approval First</option>";
                    }
                    if (k.ActivityStatus == "Immediate Dispatch")
                    {
                        subList.ActivityStatusText += "<option value='Immediate Dispatch' selected>Immediate Dispatch</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Immediate Dispatch'>Immediate Dispatch</option>";
                    }

                    if (k.ActivityStatus == "Repeat Order")
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order' selected>Repeat Order</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order'>Repeat Order</option>";
                    }

                    if (k.ActivityStatus == "Repeat Order - Dispatch")
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Dispatch' selected>Repeat Order - Dispatch</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Dispatch'>Repeat Order - Dispatch</option>";
                    }
                    if (k.ActivityStatus == "Repeat Order - Approval First")
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Approval First' selected>Repeat Order - Approval First</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Approval First'>Repeat Order - Approval First</option>";
                    }
                    if (k.ActivityStatus == "Short Qty Dispatch")
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatch' selected>Short Qty Dispatch</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatch'>Short Qty Dispatch</option>";
                    }
                    if (k.ActivityStatus == "Short Qty Dispatched")
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatched' selected>Short Qty Dispatched</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatched'>Short Qty Dispatched</option>";
                    }
                    if (k.ActivityStatus == "Sample Request")
                    {
                        subList.ActivityStatusText += "<option value='Sample Request' selected>Sample Request</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Sample Request'>Sample Request</option>";
                    }
                    if (k.ActivityStatus == "Sample Sent")
                    {
                        subList.ActivityStatusText += "<option value='Sample Sent' selected>Sample Sent</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Sample Sent'>Sample Sent</option>";
                    }
                    if (k.ActivityStatus == "Sample Approved")
                    {
                        subList.ActivityStatusText += "<option value='Sample Approved' selected>Sample Approved</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Sample Approved'>Sample Approved</option>";
                    }
                    //if (k.ActivityStatus == "Insufficient QTY")
                    //{
                    //    subList.ActivityStatusText += "<option value='Insufficient QTY' selected>Insufficient QTY</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Insufficient QTY'>Insufficient QTY</option>";
                    //}
                    if (k.ActivityStatus == "Quote - Data Sent")
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Sent' selected>Quote - Data Sent</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Sent'>Quote - Data Sent</option>";
                    }
                    if (k.ActivityStatus == "Quote - Data Approved")
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Approved' selected>Quote - Data Approved</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Approved'>Quote - Data Approved</option>";
                    }
                    subList.ActivityStatusText += "</select>";



                    subList.APIName = GetApiNameOfProduct(k.ProductId.Value, productsData);
                    subList.ScientistName = "<select id='ScientistId_" + k.Id + "' class='scientist' scientistId='" + k.ScientistCustomerId + "' quotedetailsid='" + k.Id + "'><option value=''>--Select--</option>";
                    listItems.ForEach(r =>
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.ScientistCustomerId))
                        {
                            selected = "selected ";
                            subList.SelectedScientistName = r.Text;
                        }
                        subList.ScientistName += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    });

                    subList.ScientistName += "</select>";
                    if (!string.IsNullOrEmpty(k.SubScientistName))
                    {
                        var subsci = System.Text.RegularExpressions.Regex.IsMatch(k.SubScientistName, @"\d+");
                        if (subsci)
                        {
                            if (System.Text.RegularExpressions.Regex.Match(k.SubScientistName, @"\d+").Value == k.SubScientistName)
                            {
                                subList.SubScientistCustomerId = Convert.ToInt32(k.SubScientistName);
                            }
                        }
                    }

                    subList.SubScientistName = "<select id='SubScientistId_" + k.Id + "' class='subscientist' subscientistId='" + k.SubScientistName + "' quotedetailsid='" + k.Id + "'><option value=''>--Select--</option>";
                    subscilistItems.ForEach(r =>
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.SubScientistName))
                        {
                            selected = "selected ";
                            subList.SelectedSubScientistName = r.Text;
                        }
                        subList.SubScientistName += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    });

                    subList.SubScientistName += "</select>";

                    if (!string.IsNullOrEmpty(k.SZ_Quotation.Attachment))
                    {
                        subList.Attachment = "<a href = 'javascript:void(0)' onclick='attachment(" + k.QuoteId + ")'><i class='fa fa-paperclip'></i></a>";
                    }
                    subList.MoveProjectDateText = k.MoveProjectDate.HasValue ? k.MoveProjectDate.Value.ToString("dd/MM/yyyy hh:mm tt") : "";
                    subList.AdditionalBatchNo = k.AdditionalBatchNo;
                    subList.QuoteId = k.QuoteId;
                    subList.ProductId = k.ProductId;
                    subList.ProductName = k.ProductName;
                    subList.ScientistRemark = "<input id='sciremark_" + k.Id + "' type='text' value='" + k.ScientistRemark + "' style='width: 170px' />";
                    subList.RequiredQtyTxt = "<input id='qty_" + k.Id + "' type='text' value='" + k.RequiredQty + "' style='width: 50px; font-weight:bold' />";

                    if (!string.IsNullOrEmpty(k.ExplainationSecond))
                    {
                        subList.ExplainationSecondText = "<input id='explainationsecond_" + k.Id + "' type='text' value='" + k.ExplainationSecond.Replace("'", "&#8242;") + "' title='" + k.ExplainationSecond + "' style='width: 200px; font-weight:bold' />";
                    }
                    else
                    {
                        subList.ExplainationSecondText = "<input id='explainationsecond_" + k.Id + "' type='text' value='" + k.ExplainationSecond + "' title='" + k.ExplainationSecond + "' style='width: 200px; font-weight:bold' />";
                    }

                    subList.ExplainationSecond = k.ExplainationSecond;
                    subList.LastWeekUpdate = k.LastWeekUpdate;
                    subList.PaymentTerms = k.SZ_Quotation.PaymentTerm;
                    subList.AdditionalBatchNoText = "<select id='additionalBatch_" + k.Id + "' data-quotationdetailsid='" + k.Id + "' class='ddladditionalbatch'><option value=''>--Select--</option>";
                    if (subList.ProductId.HasValue)
                    {
                        var proData = productsData.Where(x => x.Id == subList.ProductId).FirstOrDefault();
                        if (proData != null)
                        {
                            subList.IsControlledSubstance = proData.IsControlledSubstance;
                            if (!subList.IsControlledSubstance.HasValue
                                || subList.IsControlledSubstance == false)
                            {
                                subList.IsControlledSubstance = proData.IsManuallyControlledSubstance;
                            }
                        }
                        if (proData != null && proData.SZ_ProductScheme != null && proData.SZ_ProductScheme.Count > 0)
                        {
                            //if (SessionCookieManagement.IsAdmin)
                            //{
                            subList.ProductScheme = "<i class='fa fa-eye' onclick='ViewProductScheme(" + k.ProductId + ")' ></i>";
                            //}
                        }
                        var proBatchData = inventoryData.Where(x => x.ProductId == subList.ProductId).ToList();
                        if (proBatchData.Count > 0 && proData != null)
                        {
                            proBatchData.ForEach(r =>
                            {
                                //var qty = System.Text.RegularExpressions.Regex.Match(Convert.ToString(r.Qty), @"\d+").Value;
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }
                                string selected = string.Empty;
                                if (r.Id == subList.AdditionalBatchNo)
                                {
                                    selected = "selected ";
                                    subList.BatchNo = r.BatchNo;
                                    subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
                                }
                                subList.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' " + selected + ">" + text + "</option>";
                            });
                        }
                    }
                    subList.AdditionalBatchNoText += "</select>   <i class='fa fa-list-alt' onclick='DispatchedSummaryDetail(\"" + k.Id + "\")' ></i>";
                    //subList.BatchNo = k.BatchNo;
                    subList.BatchNoText = "<input id='batchno_" + k.Id + "' type='text' value='" + k.BatchNo + "' style='width:120px' />";
                    subList.IsImageAttach = k.SZ_Quotation.IsImageAttach;
                    subList.CompanyName = k.SZ_Quotation.CompanyName;
                    if (k.SZ_Quotation.SZ_CompanyList.ProjectTeam.HasValue)
                    {
                        var projectuser = projectList.Where(x => x.Id == k.SZ_Quotation.SZ_CompanyList.ProjectTeam).FirstOrDefault();
                        if (projectuser != null)
                        {
                            string customerName = string.Empty;
                            var genericAttr = genericData.Where(x => x.EntityId == projectuser.Id).ToList();
                            if (genericAttr.Count > 0)
                            {
                                customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                            }
                            subList.ProjectAssignName = customerName;
                        }
                    }
                    subList.Email = k.SZ_Quotation.EmailAddress;
                    subList.PONumber = k.SZ_Quotation.PONo;
                    subList.Ref = k.SZ_Quotation.Ref;
                    subList.Remark = k.Remark;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.QuoteDetailsId = k.Id;
                    subList.CASNo = k.CASNo;
                    var pName = "";
                    var query = queryData.Where(x => x.CATNo.Trim().ToLower() == k.CATNo.Trim().ToLower()).OrderByDescending(x => x.Id);
                    if (query != null && query.Count() > 0)
                    {
                        var qlist = query.Select(x => x.QueryNo).ToArray();
                        if (query.Select(x => x.Status.ToLower()).FirstOrDefault() == "solved" ||
                        query.Select(x => x.Status.ToLower()).FirstOrDefault() == "close" ||
                        query.Select(x => x.Status.ToLower()).FirstOrDefault() == "completed")
                        {
                            pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + k.CATNo + "\")' title='" + string.Join(", ", qlist) + "' style ='float:right; color: green' ></i>";
                        }
                        else
                        {
                            pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + k.CATNo + "\")' title='" + string.Join(", ", qlist) + "' style ='float:right' ></i>";
                        }
                    }
                    subList.IsConversionReport = k.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    var impstr = "";
                    if (subList.IsConversionReport.HasValue && subList.IsConversionReport.Value)
                    {
                        impstr += "<img src='/img/important.jpg' width='15px' height='15px' />";
                    }
                    subList.CATNo = pName + "" + "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>" + impstr + " " + CommonOperation.GetMatchingTagHTML(k, "Project");
                    subList.CreatedDate = k.CreatedDate;
                    subList.ImagePath = k.ImagePath;
                    subList.IsUploadServer = k.IsUploadServer;
                    subList.LeadTime = k.LeadTime;
                    subList.Price = k.Price;
                    subList.QuoteId = k.QuoteId;
                    subList.ProjectType = k.ProjectType;
                    subList.ScientistCustomerId = k.ScientistCustomerId;
                    subList.RequiredQty = k.RequiredQty;
                    subList.ProjectStatus = k.ProjectStatus;
                    subList.IsOnHold = k.IsOnHold;
                    if (k.ProjectStatus != null)
                    {
                        subList.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
                    }
                    subList.ScientistStatus = k.ScientistStatus;
                    subList.BatchCode1 = k.BatchCode1;
                    subList.BatchCode2 = k.BatchCode2;
                    subList.Qty1 = k.Qty1;
                    subList.Qty2 = k.Qty2;
                    subList.EstimateCompleteDate = k.EstimateCompleteDate;
                    subList.EstimateCompleteDateText = "<input id='esticompleteDate_" + k.Id + "' data-value='" + k.EstimateCompleteDate + "' type='text' class='datepicker'  style='width:80px' />";
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToProject = k.MoveToProject;
                    subList.Remark = k.Remark;
                    subList.SrPo = k.SrPo;
                    subList.AdminScientistStatus = k.AdminScientistStatus;
                    subList.InvoiceNo = k.InvoiceNo;
                    subList.InvoiceRemark = k.InvoiceRemark;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.ScientistStatustext = "<input id='scientistStatus_" + k.Id + "' type='text' value='" + k.AdminScientistStatus + "' title='" + k.AdminScientistStatus + "'  style='width:200px' />";
                    subList.RemarkText = "<input id='remark_" + k.Id + "' type='text' value='" + k.Remark + "' title='" + k.Remark + "' style='width: 170px' />";
                    subList.LastRowText = "<a href='javascript: void(0)' id='save_" + k.Id + "' onclick='SaveProjectDetails(\"" + k.Id + "\")'> Save</a> ";
                    subList.LastRowText += "<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";

                    subList.GetAllBatch = "<i class='fa fa-clone' title='View Batch No' onclick='GetAllBatchNo(" + k.ProductId + ", " + k.Id + ")'></i>";
                    subList.DispatchedStatus = k.DispatchedStatus;
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToInvoice = k.MoveToInvoice;
                    subList.IsDispatchApprove = k.IsDispatchApprove;
                    subList.IsPayment = k.IsPayment;
                    if (k.IsPayment.HasValue && k.IsPayment.Value)
                    {
                        subList.IsPaymentText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPayment' checked='checked'/>";
                    }
                    else
                    {
                        subList.IsPaymentText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPayment' />";
                    }

                    subList.OrderRemark = k.OrderRemark;
                    subList.OrderRemarkText = "<input id='orderremark_" + k.Id + "' type='text' value='" + k.OrderRemark + "' title='" + k.OrderRemark + "'  style='width:200px' />";

                    subList.Reason = k.Reason;
                    subList.ReasonText = "<input id='reason_" + k.Id + "' type='text' value='" + k.Reason + "' title='" + k.Reason + "'  style='width:200px' />";

                    if (k.MoveToScientistDate.HasValue)
                    {
                        subList.MoveToScientistDateStr = k.MoveToScientistDate.Value.ToShortDateString();
                    }

                    subList.InhouseRemarkText = "<i class='fa fa-pencil' onclick='InhouseRemarkGenerate(\"" + k.Id + "\")' ></i>"; //<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";
                    subList.ExplainationText += "<i class='fa fa-pencil' onclick='explainationGenerate(\"" + k.Id + "\")' ></i>"; //<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";
                    subList.DifficultyLevel = k.DifficultyLevel;
                    subList.DifficultyLevelText = "<select id='difflevel_" + k.Id + "' class='clsDifficultyLevel' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.DifficultyLevel r in Enum.GetValues(typeof(EnumList.DifficultyLevel)))
                    {
                        var item = Enum.GetName(typeof(EnumList.DifficultyLevel), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.DifficultyLevel)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.DifficultyLevel)
                        {
                            selected = "selected ";
                        }
                        subList.DifficultyLevelText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                    }
                    subList.DifficultyLevelText += "</select>";

                    subList.IsPriority = k.IsPriority;
                    if (k.IsPriority.HasValue && k.IsPriority.Value)
                    {
                        subList.IsPriorityText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPriority' checked='checked'/>";
                    }
                    else
                    {
                        subList.IsPriorityText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPriority' />";
                    }
                    subList.ProStatus = k.ProStatus;
                    subList.ProStatusText = "<select id='prostatus_" + k.Id + "' class='clsProjStatus' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.ProStatusDDL r in Enum.GetValues(typeof(EnumList.ProStatusDDL)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ProStatusDDL), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ProStatusDDL)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.ProStatus)
                        {
                            selected = "selected ";
                            subList.SelectedProStatus = text;
                        }
                        subList.ProStatusText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                    }
                    subList.ProStatusText += "</select>";
                    subList.COAId = k.COAId;
                    subList.COARefNumber = k.COARefNumber;
                    string coaText = "";

                    coaText = "<select id='coa_" + k.Id + "' class='addcoa'><option value=''>--Select--</option>";
                    int bId = k.AdditionalBatchNo.HasValue ? k.AdditionalBatchNo.Value : 0;
                    if (bId != 0)
                    {
                        var mastercoa = masterCOAData.Where(x => x.BatchId == bId).FirstOrDefault();
                        if (mastercoa != null)
                        {
                            var listchildcoa = childcoadata.Where(x => x.MasterCOAID == mastercoa.Id).ToList();
                            if (listchildcoa != null && listchildcoa.Count > 0)
                            {
                                foreach (var ccoa in listchildcoa)
                                {
                                    if (k.COAId == ccoa.Id)
                                    {
                                        coaText += "<option value='" + ccoa.Id.ToString() + "' data-value='" + k.AdditionalBatchNo + "' selected>" + ccoa.RefNo + "</option>";
                                    }
                                    else
                                    {
                                        coaText += "<option value='" + ccoa.Id.ToString() + "' data-value='" + k.AdditionalBatchNo + "'>" + ccoa.RefNo + "</option>";
                                    }
                                }
                            }
                        }
                    }
                    subList.COAText = coaText;
                    subList.CompanyId = k.SZ_Quotation.CompanyId;
                    subList.LicesenStatusText = "<select id='LicesenStatus_" + k.Id + "' class='clsLicesenStatus' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    subList.LicesenStatusText += "<option value='1' " + (k.LicesenStatusId == 1 ? "selected" : "") + ">In Progress</option>";
                    subList.LicesenStatusText += "<option value='2' " + (k.LicesenStatusId == 2 ? "selected" : "") + ">Completed</option>";
                    subList.LicesenStatusText += "<option value='3' " + (k.LicesenStatusId == 3 ? "selected" : "") + ">On Hold</option>";
                    subList.LicesenStatusText += "<option value='4' " + (k.LicesenStatusId == 4 ? "selected" : "") + ">Query</option>";
                    subList.LicesenStatusText += "<option value='5' " + (k.LicesenStatusId == 5 ? "selected" : "") + ">To Be Initiated</option>";
                    subList.LicesenStatusText += "</select>";

                    subList.PermitRequired = "<select id='PermitRequired_" + k.Id + "' class='clsPermitRequired' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    subList.PermitRequired += "<option value='Y' " + (k.PermitRequired == "Y" ? "selected" : "") + ">Y</option>";
                    subList.PermitRequired += "<option value='N' " + (k.PermitRequired == "N" ? "selected" : "") + ">N</option>";
                    subList.PermitRequired += "</select>";

                    subList.ImportPermit = "<select id='ImportPermit_" + k.Id + "' class='clsImportPermit' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    subList.ImportPermit += "<option value='Y' " + (k.ImportPermit == "Y" ? "selected" : "") + ">Y</option>";
                    subList.ImportPermit += "<option value='N' " + (k.ImportPermit == "N" ? "selected" : "") + ">N</option>";
                    subList.ImportPermit += "</select>";

                    subList.Declaration = "<select id='Declaration_" + k.Id + "' class='clsDeclaration' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    subList.Declaration += "<option value='Y' " + (k.Declaration == "Y" ? "selected" : "") + ">Y</option>";
                    subList.Declaration += "<option value='N' " + (k.Declaration == "N" ? "selected" : "") + ">N</option>";
                    subList.Declaration += "</select>";

                    subList.ApplicationDateText = "<input id='ApplicationDate_" + k.Id + "' type='text' value='" + k.ApplicationDate + "' class='clsApplicationDate'  style='width:100px' />";
                    subList.ExportPermitReceivedDateText = "<input id='ExportPermitReceivedDate_" + k.Id + "' type='text' value='" + k.ExportPermitReceivedDate + "' class='clsExportPermitReceivedDate'  style='width:100px' />";
                    subList.TechnicalWriteup = "<input id='TechnicalWriteup_" + k.Id + "' type='text' value='" + k.TechnicalWriteup + "' class='clsTechnicalWriteup'  style='width:100px' />";

                    subList.QuaterlyDataToSubmit = "<select id='QuaterlyDataToSubmit_" + k.Id + "' class='clsQuaterlyDataToSubmit' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    subList.QuaterlyDataToSubmit += "<option value='Y' " + (k.QuaterlyDataToSubmit == "Y" ? "selected" : "") + ">Y</option>";
                    subList.QuaterlyDataToSubmit += "<option value='N' " + (k.QuaterlyDataToSubmit == "N" ? "selected" : "") + ">N</option>";
                    subList.QuaterlyDataToSubmit += "</select>";

                    subList.QuaterlyDataSubmited = "<select id='QuaterlyDataSubmited_" + k.Id + "' class='clsQuaterlyDataSubmited' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    subList.QuaterlyDataSubmited += "<option value='Y' " + (k.QuaterlyDataSubmited == "Y" ? "selected" : "") + ">Y</option>";
                    subList.QuaterlyDataSubmited += "<option value='N'  " + (k.QuaterlyDataSubmited == "N" ? "selected" : "") + ">N</option>";
                    subList.QuaterlyDataSubmited += "</select>";

                    subList.ImpExpo = "<select id='impexpo_" + k.Id + "' class='clsimpexpo' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    if (k.ImpExpo == "Domestic")
                    {
                        subList.ImpExpo += "<option value='Domestic' selected>Domestic</option>";
                    }
                    else
                    {
                        subList.ImpExpo += "<option value='Domestic'>Domestic</option>";
                    }
                    if (k.ImpExpo == "Export")
                    {
                        subList.ImpExpo += "<option value='Export' selected>International</option>";
                    }
                    else
                    {
                        subList.ImpExpo += "<option value='Export'>International</option>";
                    }
                    subList.ImpExpo += "</select>";

                    var startYear = DateTime.Now.Year;
                    var endYear = DateTime.Now.AddYears(1).Year;
                    subList.NextQuater = "<select id='NextQuater_" + k.Id + "' class='clsNextQuater' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    for (int i = startYear; i <= endYear; i++)
                    {
                        for (int j = 1; j < 5; j++)
                        {
                            if (k.NextQuater == "Q" + j + "-" + i)
                            {
                                subList.NextQuater += "<option value='Q" + j + "-" + i + "' selected>Q" + j + "-" + i + "</option>";
                            }
                            else
                            {
                                subList.NextQuater += "<option value='Q" + j + "-" + i + "'>Q" + j + "-" + i + "</option>";
                            }
                        }

                        //subList.NextQuater += "<option value='Q2-"+ i + "'  "+ (k.NextQuater == "\"Q2-" + i + "\"" +  "selected" ? "" : "") + ">Q2-"+ i + "</option>";
                        //subList.NextQuater += "<option value='Q3-"+ i + "'  "+ (k.NextQuater == "\"Q3-" + i + "\"" + "selected" ? "" : "") + ">Q3-"+ i + "</option>";
                        //subList.NextQuater += "<option value='Q4-"+ i + "'  "+ (k.NextQuater == "\"Q4-" + i + "\"" + "selected" ? "" : "") + ">Q4-"+ i + "</option>";
                    }
                    subList.NextQuater += "</select>";
                    //subList.InhouseRemarkText = "<i class='fa fa-pencil' onclick='InhouseRemarkGenerate(\"" + k.Id + "\")' ></i>";
                    subList.JourneyComment = "<input id='JourneyComment_" + k.Id + "' type='text' value='" + k.JourneyComment + "' class='clsJourneyComment'  style='width:200px' /> <i class='fa fa-pencil' onclick='JourneyCommentGenerate(\"" + k.Id + "\")' ></i>";
                    subList.APIRequired = "<select id='APIRequired_" + k.Id + "' class='clsAPIRequired' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    subList.APIRequired += "<option value='Y' " + (k.APIRequired == "Y" ? "selected" : "") + ">Y</option>";
                    subList.APIRequired += "<option value='N'  " + (k.APIRequired == "N" ? "selected" : "") + " >N</option>";
                    subList.APIRequired += "</select>";

                    subList.APIImpExport = "<input id='APIImpExport_" + k.Id + "' type='text' value='" + k.APIImpExport + "' class='clsAPIImpExport'  style='width:200px' />";
                    subList.Category = "<input id='Category_" + k.Id + "' type='text' value='" + k.Category + "' class='clsCategory'  style='width:200px' />";
                    subList.ActionRow = "<a href='javascript:void(0)' onclick='viewcontrolledsubstancedata(" + k.Id + ")'><i class='fa fa-paperclip'></i></a>";
                    model.Add(subList);
                });

                model = model.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).ToList();

                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.SelectedScientistName != null && m.SelectedScientistName.ToLower().Contains(searchValue))
                                        || (m.SelectedSubScientistName != null && m.SelectedSubScientistName.ToLower().Contains(searchValue))
                                        || (m.CompanyName != null && m.CompanyName.ToLower().Contains(searchValue))
                                        || (m.PONumber != null && m.PONumber.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.Price != null && m.Price.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.SelectedProjectType != null && m.SelectedProjectType.ToLower().Contains(searchValue))
                                        || (m.RequiredQty != null && m.RequiredQty.ToLower().Contains(searchValue))
                                        || (m.SelectedAdditionalBatchNo != null && m.SelectedAdditionalBatchNo.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        || (m.MoveProjectDateText != null && m.MoveProjectDateText.ToString().ToLower().Contains(searchValue))
                                        || (m.EstimateCompleteDateText != null && m.EstimateCompleteDateText.ToString().ToLower().Contains(searchValue))
                                        || (m.AdminScientistStatus != null && m.AdminScientistStatus.ToLower().Contains(searchValue))
                                        || (m.ProjectStatustext != null && m.ProjectStatustext.ToLower().Contains(searchValue))
                                        || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                                        || (m.ActivityStatus != null && m.ActivityStatus.ToLower().Contains(searchValue))
                                        || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))).ToList();
                }

                //recordsTotal = model.Count();
                //var data = model.Skip(skip).Take(pageSize).ToList();
                var data = model;

                var jsonResult = Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
                jsonResult.MaxJsonLength = int.MaxValue;
                return jsonResult;

            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }
        }


        [HttpPost]
        public ActionResult LoadProductAssignedData()
        {
            try
            {
                var companyIds = db.SZ_CompanyList.Where(x => x.ProjectTeam == SessionCookieManagement.UserId).Select(x => x.Id).ToList();
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                var scinameFilter = Request.Form.GetValues("sciname")[0].ToString();
                var subscinameFilter = Request.Form.GetValues("subsciname")[0].ToString();
                var fltprostatusItem = Request.Form.GetValues("fltprostatusItem")[0].ToString();
                var fltactivity = Request.Form.GetValues("fltactivity")[0].ToString();
                var fltprotypeItem = "";
                if (Request.Form.GetValues("fltprotypeItem") != null)
                {
                    fltprotypeItem = Request.Form.GetValues("fltprotypeItem")[0].ToString();
                }
                var fltestdate = "";
                if (Request.Form.GetValues("fltprotypeItem") != null)
                {
                    fltestdate = Request.Form.GetValues("fltestdate")[0].ToString();
                }
                var searchby = string.Empty;
                var searchbyvalue = string.Empty;
                if (Request.Form.GetValues("radiobuton") != null)
                {
                    searchby = Request.Form.GetValues("radiobuton")[0].ToString();
                }
                if (Request.Form.GetValues("searchbox") != null)
                {
                    searchbyvalue = Request.Form.GetValues("searchbox")[0].ToString().Trim();
                }
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;
                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
                string pursynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
                var quotationDetailsdata = db.SZ_QuotationDetail.AsQueryable();
                // Getting all Customer data  
                var list = (from i in db.SZ_Quotation
                            join t2 in quotationDetailsdata on i.Id equals t2.QuoteId
                            where i.CompanyId.HasValue && companyIds.Contains(i.CompanyId.Value)
                            && t2.MoveToProject == true
                            && string.IsNullOrEmpty(t2.TrackingNo)
                            && (t2.IsOnHold == false || t2.IsOnHold == null)
                            && (t2.ProjectType != inhouseProjectType || t2.ProjectType == null)
                            orderby t2.MoveProjectDate descending
                            select t2).Distinct().OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).AsQueryable();

                var listItems = new List<SelectListItem>();
                var subscilistItems = new List<SelectListItem>();
                MemoryCacheManager objCache = new MemoryCacheManager();
                var queryData = objCache.Get("cache.queryData", () =>
                {
                    return db.SZ_QueryModule.AsNoTracking().ToList();
                });
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });

                var scienList = objCache.Get("cache.GetScientistId", () =>
                {
                    return db.GetScientistId().ToList();
                });

                var subscienList = objCache.Get("cache.subscienList", () =>
                {
                    return db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();
                });
                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                    subscilistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                });

                ViewBag.ScientistListItem = listItems;

                foreach (var term in subscienList)
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }

                    subscilistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                }
                ViewBag.SubScientistListItem = subscilistItems;

                var masterCOAData = objCache.Get("cache.mastercoadata", () =>
                {
                    return db.SZ_MasterCOA.ToList();
                });
                var childcoadata = objCache.Get("cache.childcoadata", () =>
                {
                    return db.SZ_ChildCOA.ToList();
                });
                var productsData = objCache.Get("cache.productsdata", () =>
                {
                    return db.Products.Where(x => x.Published == true && x.Deleted == false).ToList();
                });
                var ReadyToDeliverScientistStatusId = objCache.Get("cache.ReadyToDeliverScientistStatusId", () =>
                {
                    return db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                });
                var inventoryData = objCache.Get("cache.inventoryData", () =>
                {
                    return db.SZ_Inventory.ToList();
                });
                var catList = objCache.Get("cache.categorydata", () =>
                {
                    return db.Categories.Where(x => x.ParentCategoryId == 0 && x.Deleted == false && x.Published).ToList();
                });

                var proIds = list.Select(x => x.ProductId).Distinct().ToList();
                masterCOAData = masterCOAData.Where(x => proIds.Contains(x.ProductId)).ToList();
                var masterCoaIds = masterCOAData.Select(x => x.Id).Distinct().ToList();
                childcoadata = childcoadata.Where(x => masterCoaIds.Contains(x.MasterCOAID.Value)).ToList();
                productsData = productsData.Where(x => proIds.Contains(x.Id) && x.Published == true && x.Deleted == false).ToList();
                inventoryData = inventoryData.Where(x => proIds.Contains(x.ProductId)).ToList();

                if (!string.IsNullOrEmpty(scinameFilter))
                {
                    int sciid = Convert.ToInt32(scinameFilter);
                    list = list.Where(x => x.ScientistCustomerId == sciid).AsQueryable();
                }
                if (!string.IsNullOrEmpty(subscinameFilter))
                {
                    string subsciid = Convert.ToString(subscinameFilter);
                    list = list.Where(x => x.SubScientistName == subsciid).AsQueryable();
                }
                if (!string.IsNullOrEmpty(fltprostatusItem))
                {
                    if (fltprostatusItem == "blank")
                    {
                        list = list.Where(x => !string.IsNullOrEmpty(x.ProStatus)).AsQueryable();
                    }
                    else
                    {
                        list = list.Where(x => x.ProStatus == fltprostatusItem).AsQueryable();
                    }
                }
                if (!string.IsNullOrEmpty(fltprotypeItem))
                {
                    list = list.Where(x => x.ProjectType == fltprotypeItem).AsQueryable();
                }
                if (!string.IsNullOrEmpty(fltestdate))
                {
                    DateTime estdat = Convert.ToDateTime(fltestdate);
                    list = list.Where(x => x.EstimateCompleteDate == estdat).AsQueryable();
                }

                if (!string.IsNullOrEmpty(fltactivity))
                {
                    list = list.Where(x => x.ActivityStatus == fltactivity).AsQueryable();
                }

                if (!string.IsNullOrEmpty(searchby) && !string.IsNullOrEmpty(searchbyvalue))
                {
                    searchbyvalue = searchbyvalue.ToLower();
                    if (searchbyvalue.Contains("+"))
                    {
                        List<string> searchlist = searchbyvalue.Split('+').Select(p => p.Trim()).ToList();

                        List<SZ_QuotationDetail> objmodel = new List<SZ_QuotationDetail>();
                        foreach (var item in searchlist)
                        {
                            var d = list.Where(x => x.SZ_Quotation.CompanyName.Contains(item) ||
                                                x.SZ_Quotation.PONo.ToLower().Contains(item) ||
                                                x.ProductName.ToLower().Contains(item) ||
                                                (x.CASNo != null ? x.CASNo.ToLower().Contains(item) : false) ||
                                                (x.CATNo != null ? x.CATNo.ToLower().Contains(item) : false) ||
                                               (x.BatchNo != null ? x.BatchNo.ToLower().Contains(item) : false)).ToList();
                            if (d != null && d.Count > 0)
                            {
                                objmodel.AddRange(d);
                            }
                        }
                        if (objmodel != null && objmodel.Count > 0)
                        {
                            list = objmodel.AsQueryable();
                        }
                    }
                    else
                    {
                        if (searchby == "quoteid")
                        {
                            list = list.Where(x => x.SZ_Quotation.Ref.ToLower().Contains(searchbyvalue)).AsQueryable();
                        }
                        if (searchby == "ponumber")
                        {
                            list = list.Where(x => x.SZ_Quotation.PONo.ToLower().Contains(searchbyvalue)).AsQueryable();
                        }
                        if (searchby == "company")
                        {
                            list = list.Where(x => x.SZ_Quotation.CompanyName.ToLower().Contains(searchbyvalue)).AsQueryable();
                        }
                        if (searchby == "productname")
                        {
                            list = list.Where(x => x.ProductName.ToLower().Contains(searchbyvalue)).AsQueryable();
                        }
                        if (searchby == "cas")
                        {
                            list = list.Where(x => x.CASNo != null ? x.CASNo.ToLower().Contains(searchbyvalue) : false).AsQueryable();
                        }
                        if (searchby == "cat")
                        {
                            list = list.Where(x => x.CATNo != null ? x.CATNo.ToLower().Contains(searchbyvalue) : false).AsQueryable();
                        }
                        if (searchby == "batchno")
                        {
                            var bid = db.SZ_Inventory.Where(x => x.BatchNo.Trim().ToLower() == searchbyvalue).Select(x => x.Id).FirstOrDefault();
                            list = list.Where(x => x.AdditionalBatchNo == bid).AsQueryable();
                        }
                    }
                }

                recordsTotal = list.Count();
                var outlist = list.Skip(() => skip).Take(() => pageSize);
                var model = new List<ProjectListModel>();
                outlist.ForEach(k =>
                {
                    ProjectListModel subList = new ProjectListModel();
                    subList.IsConversionReport = k.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    subList.SAPCode = k.SZ_Quotation.SZ_CompanyList.SAPCode;
                    subList.CountEstDate = k.CountEstDate.HasValue ? k.CountEstDate.Value : 0;
                    subList.ChkSaveRow = "<input type='checkbox' value='" + k.Id + "' class='clsSaverow' />";
                    subList.ReadyToDeliverScientistStatusId = ReadyToDeliverScientistStatusId;
                    if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == subList.ReadyToDeliverScientistStatusId && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                    {
                        subList.ChkFirstRow = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                    }
                    else if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == subList.ReadyToDeliverScientistStatusId)
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' />";
                    }
                    else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && (k.MoveToDispatch == null || k.MoveToDispatch == false))
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' />";
                    }
                    else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                    {
                        subList.ChkFirstRow = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                    }
                    if (k.IsDispatchApprove.HasValue && k.IsDispatchApprove.Value && (k.MoveToDispatch == null || k.MoveToDispatch == false))
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' style='outline: 4px solid #c00'/>";
                    }
                    if (k.IsCancel.HasValue && k.IsCancel.Value)
                    {
                        subList.ChkFirstRow = "";
                        subList.ChkSaveRow = "";
                    }
                    subList.ProjectType = k.ProjectType;
                    subList.ApprovedForClient = k.ApprovedForClient;
                    if (k.ApprovedForClient.HasValue && k.ApprovedForClient.Value)
                    {
                        subList.ApprovedForClientText = "<input type='checkbox' value='" + k.Id + "' class='clsApprovedForClient' checked='checked'/>";
                    }
                    else
                    {
                        subList.ApprovedForClientText = "<input type='checkbox' value='" + k.Id + "' class='clsApprovedForClient' />";
                    }
                    subList.ProjectTypeText = "<select id='projecttype_" + k.Id + "' class='clsProjType' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ProjectType), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.ProjectType)
                        {
                            selected = "selected ";
                            subList.SelectedProjectType = text;
                        }
                        //if (text != "In-House")
                        //{
                            subList.ProjectTypeText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                        //}
                    }
                    subList.ProjectTypeText += "</select>";
                    subList.IsPaymentPending = k.SZ_Quotation.SZ_CompanyList.IsPaymentPending;
                    subList.ActivityStatus = k.ActivityStatus;
                    subList.ActivityStatusText = "<select id='activitystatus_" + k.Id + "' class='clsActivityStatus' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    if (k.ActivityStatus == "Approval First")
                    {
                        subList.ActivityStatusText += "<option value='Approval First' selected>Approval First</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Approval First'>Approval First</option>";
                    }
                    if (k.ActivityStatus == "Immediate Dispatch")
                    {
                        subList.ActivityStatusText += "<option value='Immediate Dispatch' selected>Immediate Dispatch</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Immediate Dispatch'>Immediate Dispatch</option>";
                    }

                    if (k.ActivityStatus == "Repeat Order")
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order' selected>Repeat Order</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order'>Repeat Order</option>";
                    }

                    if (k.ActivityStatus == "Repeat Order - Dispatch")
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Dispatch' selected>Repeat Order - Dispatch</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Dispatch'>Repeat Order - Dispatch</option>";
                    }
                    if (k.ActivityStatus == "Repeat Order - Approval First")
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Approval First' selected>Repeat Order - Approval First</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Approval First'>Repeat Order - Approval First</option>";
                    }
                    if (k.ActivityStatus == "Short Qty Dispatch")
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatch' selected>Short Qty Dispatch</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatch'>Short Qty Dispatch</option>";
                    }
                    if (k.ActivityStatus == "Short Qty Dispatched")
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatched' selected>Short Qty Dispatched</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatched'>Short Qty Dispatched</option>";
                    }
                    if (k.ActivityStatus == "Sample Request")
                    {
                        subList.ActivityStatusText += "<option value='Sample Request' selected>Sample Request</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Sample Request'>Sample Request</option>";
                    }
                    if (k.ActivityStatus == "Sample Sent")
                    {
                        subList.ActivityStatusText += "<option value='Sample Sent' selected>Sample Sent</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Sample Sent'>Sample Sent</option>";
                    }
                    if (k.ActivityStatus == "Sample Approved")
                    {
                        subList.ActivityStatusText += "<option value='Sample Approved' selected>Sample Approved</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Sample Approved'>Sample Approved</option>";
                    }
                    //if (k.ActivityStatus == "Insufficient QTY")
                    //{
                    //    subList.ActivityStatusText += "<option value='Insufficient QTY' selected>Insufficient QTY</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Insufficient QTY'>Insufficient QTY</option>";
                    //}
                    if (k.ActivityStatus == "Quote - Data Sent")
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Sent' selected>Quote - Data Sent</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Sent'>Quote - Data Sent</option>";
                    }
                    if (k.ActivityStatus == "Quote - Data Approved")
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Approved' selected>Quote - Data Approved</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Approved'>Quote - Data Approved</option>";
                    }
                    subList.ActivityStatusText += "</select>";
                    //subList.APIName = GetApiNameOfProduct(k.ProductId.Value, proCat, catList);
                    subList.ScientistName = "<select id='ScientistId_" + k.Id + "' class='scientist' scientistId='" + k.ScientistCustomerId + "' quotedetailsid='" + k.Id + "'><option value=''>--Select--</option>";
                    listItems.ForEach(r =>
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.ScientistCustomerId))
                        {
                            selected = "selected ";
                            subList.SelectedScientistName = r.Text;
                        }
                        subList.ScientistName += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    });

                    subList.ScientistName += "</select>";
                    if (!string.IsNullOrEmpty(k.SubScientistName))
                    {
                        var subsci = System.Text.RegularExpressions.Regex.IsMatch(k.SubScientistName, @"\d+");
                        if (subsci)
                        {
                            if (System.Text.RegularExpressions.Regex.Match(k.SubScientistName, @"\d+").Value == k.SubScientistName)
                            {
                                subList.SubScientistCustomerId = Convert.ToInt32(k.SubScientistName);
                            }
                        }
                    }

                    subList.SubScientistName = "<select id='SubScientistId_" + k.Id + "' class='subscientist' subscientistId='" + k.SubScientistName + "' quotedetailsid='" + k.Id + "'><option value=''>--Select--</option>";
                    subscilistItems.ForEach(r =>
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.SubScientistName))
                        {
                            selected = "selected ";
                            subList.SelectedSubScientistName = r.Text;
                        }
                        subList.SubScientistName += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    });

                    subList.SubScientistName += "</select>";

                    if (!string.IsNullOrEmpty(k.SZ_Quotation.Attachment))
                    {
                        subList.Attachment = "<a href = 'javascript:void(0)' onclick='attachment(" + k.QuoteId + ")'><i class='fa fa-paperclip'></i></a>";
                    }
                    subList.MoveProjectDateText = k.MoveProjectDate.HasValue ? k.MoveProjectDate.Value.ToString("dd/MM/yyyy hh:mm tt") : "";
                    subList.AdditionalBatchNo = k.AdditionalBatchNo;
                    subList.QuoteId = k.QuoteId;
                    subList.ProductId = k.ProductId;
                    subList.ProductName = k.ProductName;
                    subList.ScientistRemark = "<input id='sciremark_" + k.Id + "' type='text' value='" + k.ScientistRemark + "' style='width: 170px' />";
                    subList.RequiredQtyTxt = "<input id='qty_" + k.Id + "' type='text' value='" + k.RequiredQty + "' style='width: 50px; font-weight:bold' />";

                    if (!string.IsNullOrEmpty(k.ExplainationSecond))
                    {
                        subList.ExplainationSecondText = "<input id='explainationsecond_" + k.Id + "' type='text' value='" + k.ExplainationSecond.Replace("'", "&#8242;") + "' title='" + k.ExplainationSecond + "' style='width: 200px; font-weight:bold' />";
                    }
                    else
                    {
                        subList.ExplainationSecondText = "<input id='explainationsecond_" + k.Id + "' type='text' value='" + k.ExplainationSecond + "' title='" + k.ExplainationSecond + "' style='width: 200px; font-weight:bold' />";
                    }

                    subList.ExplainationSecond = k.ExplainationSecond;
                    subList.LastWeekUpdate = k.LastWeekUpdate;
                    subList.PaymentTerms = k.SZ_Quotation.PaymentTerm;
                    subList.AdditionalBatchNoText = "<select id='additionalBatch_" + k.Id + "' data-quotationdetailsid='" + k.Id + "' class='ddladditionalbatch'><option value=''>--Select--</option>";
                    if (subList.ProductId.HasValue)
                    {
                        var proData = productsData.Where(x => x.Id == subList.ProductId).FirstOrDefault();
                        if (proData != null)
                        {
                            subList.IsControlledSubstance = proData.IsControlledSubstance;
                            if (!subList.IsControlledSubstance.HasValue
                                || subList.IsControlledSubstance == false)
                            {
                                subList.IsControlledSubstance = proData.IsManuallyControlledSubstance;
                            }
                        }
                        if (proData != null && proData.SZ_ProductScheme != null && proData.SZ_ProductScheme.Count > 0)
                        {
                            //if (SessionCookieManagement.IsAdmin)
                            //{
                            subList.ProductScheme = "<i class='fa fa-eye' onclick='ViewProductScheme(" + k.ProductId + ")' ></i>";
                            //}
                        }
                        var proBatchData = inventoryData.Where(x => x.ProductId == subList.ProductId).ToList();
                        if (proBatchData.Count > 0 && proData != null)
                        {
                            proBatchData.ForEach(r =>
                            {
                                //var qty = System.Text.RegularExpressions.Regex.Match(Convert.ToString(r.Qty), @"\d+").Value;
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }
                                string selected = string.Empty;
                                if (r.Id == subList.AdditionalBatchNo)
                                {
                                    selected = "selected ";
                                    subList.BatchNo = r.BatchNo;
                                    subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
                                }
                                subList.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' " + selected + ">" + text + "</option>";
                            });
                        }
                    }
                    subList.AdditionalBatchNoText += "</select>   <i class='fa fa-list-alt' onclick='DispatchedSummaryDetail(\"" + k.Id + "\")' ></i>";
                    //subList.BatchNo = k.BatchNo;
                    subList.BatchNoText = "<input id='batchno_" + k.Id + "' type='text' value='" + k.BatchNo + "' style='width:120px' />";
                    subList.IsImageAttach = k.SZ_Quotation.IsImageAttach;
                    subList.CompanyName = k.SZ_Quotation.CompanyName;
                    subList.Email = k.SZ_Quotation.EmailAddress;
                    subList.PONumber = k.SZ_Quotation.PONo;
                    subList.Ref = k.SZ_Quotation.Ref;
                    subList.Remark = k.Remark;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.QuoteDetailsId = k.Id;
                    subList.CASNo = k.CASNo;
                    var pName = "";
                    var query = queryData.Where(x => x.CATNo.Trim().ToLower() == k.CATNo.Trim().ToLower()).OrderByDescending(x => x.Id);
                    if (query != null && query.Count() > 0)
                    {
                        var qlist = query.Select(x => x.QueryNo).ToArray();
                        if (query.Select(x => x.Status.ToLower()).FirstOrDefault() == "solved" ||
                        query.Select(x => x.Status.ToLower()).FirstOrDefault() == "close" ||
                        query.Select(x => x.Status.ToLower()).FirstOrDefault() == "completed")
                        {
                            pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + k.CATNo + "\")' title='" + string.Join(", ", qlist) + "' style ='float:right; color: green' ></i>";
                        }
                        else
                        {
                            pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + k.CATNo + "\")' title='" + string.Join(", ", qlist) + "' style ='float:right' ></i>";
                        }
                    }
                    subList.IsConversionReport = k.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    var impstr = "";
                    if (subList.IsConversionReport.HasValue && subList.IsConversionReport.Value)
                    {
                        impstr += "<img src='/img/important.jpg' width='15px' height='15px' />";
                    }
                    subList.CATNo = pName + "" + "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>  <i class='fa fa-search' onclick='SearchDefault(\"cat\", \"" + k.CATNo + "\")' ></i>" + impstr + " " + CommonOperation.GetMatchingTagHTML(k, "Project");
                    subList.CreatedDate = k.CreatedDate;
                    subList.ImagePath = k.ImagePath;
                    subList.IsUploadServer = k.IsUploadServer;
                    subList.LeadTime = k.LeadTime;
                    subList.Price = k.Price;
                    subList.QuoteId = k.QuoteId;
                    subList.ProjectType = k.ProjectType;
                    subList.ScientistCustomerId = k.ScientistCustomerId;
                    subList.RequiredQty = k.RequiredQty;
                    subList.ProjectStatus = k.ProjectStatus;
                    subList.IsOnHold = k.IsOnHold;
                    if (k.ProjectStatus != null)
                    {
                        subList.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
                    }
                    subList.ScientistStatus = k.ScientistStatus;
                    subList.BatchCode1 = k.BatchCode1;
                    subList.BatchCode2 = k.BatchCode2;
                    subList.Qty1 = k.Qty1;
                    subList.Qty2 = k.Qty2;
                    subList.EstimateCompleteDate = k.EstimateCompleteDate;
                    subList.EstimateCompleteDateText = "<input id='esticompleteDate_" + k.Id + "' data-value='" + k.EstimateCompleteDate + "' type='text' class='datepicker'  style='width:80px' />";
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToProject = k.MoveToProject;
                    subList.Remark = k.Remark;
                    subList.SrPo = k.SrPo;
                    subList.AdminScientistStatus = k.AdminScientistStatus;
                    subList.InvoiceNo = k.InvoiceNo;
                    subList.InvoiceRemark = k.InvoiceRemark;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.ScientistStatustext = "<input id='scientistStatus_" + k.Id + "' type='text' value='" + k.AdminScientistStatus + "' title='" + k.AdminScientistStatus + "'  style='width:200px' />";
                    subList.RemarkText = "<input id='remark_" + k.Id + "' type='text' value='" + k.Remark + "' title='" + k.Remark + "' style='width: 170px' />";
                    subList.LastRowText = "<a href='javascript: void(0)' id='save_" + k.Id + "' onclick='SaveProjectDetails(\"" + k.Id + "\")'> Save</a> ";
                    subList.LastRowText += "<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";

                    subList.GetAllBatch = "<i class='fa fa-clone' title='View Batch No' onclick='GetAllBatchNo(" + k.ProductId + ", " + k.Id + ")'></i>";
                    subList.DispatchedStatus = k.DispatchedStatus;
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToInvoice = k.MoveToInvoice;
                    subList.IsDispatchApprove = k.IsDispatchApprove;
                    subList.IsPayment = k.IsPayment;
                    if (k.IsPayment.HasValue && k.IsPayment.Value)
                    {
                        subList.IsPaymentText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPayment' checked='checked'/>";
                    }
                    else
                    {
                        subList.IsPaymentText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPayment' />";
                    }

                    subList.OrderRemark = k.OrderRemark;
                    subList.OrderRemarkText = "<input id='orderremark_" + k.Id + "' type='text' value='" + k.OrderRemark + "' title='" + k.OrderRemark + "'  style='width:200px' />";

                    subList.Reason = k.Reason;
                    subList.ReasonText = "<input id='reason_" + k.Id + "' type='text' value='" + k.Reason + "' title='" + k.Reason + "'  style='width:200px' />";

                    if (k.MoveToScientistDate.HasValue)
                    {
                        subList.MoveToScientistDateStr = k.MoveToScientistDate.Value.ToShortDateString();
                    }

                    subList.InhouseRemarkText = "<i class='fa fa-pencil' onclick='InhouseRemarkGenerate(\"" + k.Id + "\")' ></i>"; //<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";
                    subList.ExplainationText += "<i class='fa fa-pencil' onclick='explainationGenerate(\"" + k.Id + "\")' ></i>"; //<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";
                    subList.DifficultyLevel = k.DifficultyLevel;
                    subList.DifficultyLevelText = "<select id='difflevel_" + k.Id + "' class='clsDifficultyLevel' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.DifficultyLevel r in Enum.GetValues(typeof(EnumList.DifficultyLevel)))
                    {
                        var item = Enum.GetName(typeof(EnumList.DifficultyLevel), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.DifficultyLevel)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.DifficultyLevel)
                        {
                            selected = "selected ";
                        }
                        subList.DifficultyLevelText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                    }
                    subList.DifficultyLevelText += "</select>";

                    subList.IsPriority = k.IsPriority;
                    if (k.IsPriority.HasValue && k.IsPriority.Value)
                    {
                        subList.IsPriorityText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPriority' checked='checked'/>";
                    }
                    else
                    {
                        subList.IsPriorityText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPriority' />";
                    }
                    subList.ProStatus = k.ProStatus;
                    subList.ProStatusText = "<select id='prostatus_" + k.Id + "' class='clsProjStatus' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.ProStatusDDL r in Enum.GetValues(typeof(EnumList.ProStatusDDL)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ProStatusDDL), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ProStatusDDL)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.ProStatus)
                        {
                            selected = "selected ";
                            subList.SelectedProStatus = text;
                        }
                        subList.ProStatusText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                    }
                    subList.ProStatusText += "</select>";
                    subList.COAId = k.COAId;
                    subList.COARefNumber = k.COARefNumber;
                    string coaText = "";

                    coaText = "<select id='coa_" + k.Id + "' class='addcoa'><option value=''>--Select--</option>";
                    int bId = k.AdditionalBatchNo.HasValue ? k.AdditionalBatchNo.Value : 0;
                    if (bId != 0)
                    {
                        var mastercoa = masterCOAData.Where(x => x.BatchId == bId).FirstOrDefault();
                        if (mastercoa != null)
                        {
                            var listchildcoa = childcoadata.Where(x => x.MasterCOAID == mastercoa.Id).ToList();
                            if (listchildcoa != null && listchildcoa.Count > 0)
                            {
                                foreach (var ccoa in listchildcoa)
                                {
                                    if (k.COAId == ccoa.Id)
                                    {
                                        coaText += "<option value='" + ccoa.Id.ToString() + "' data-value='" + k.AdditionalBatchNo + "' selected>" + ccoa.RefNo + "</option>";
                                    }
                                    else
                                    {
                                        coaText += "<option value='" + ccoa.Id.ToString() + "' data-value='" + k.AdditionalBatchNo + "'>" + ccoa.RefNo + "</option>";
                                    }
                                }
                            }
                        }
                    }
                    subList.COAText = coaText;
                    subList.CompanyId = k.SZ_Quotation.CompanyId;
                    model.Add(subList);
                });

                model = model.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).ToList();
                //.ThenBy(x => x.SrPo).ToList();
                //if (!string.IsNullOrEmpty(scinameFilter))
                //{
                //    int sciid = Convert.ToInt32(scinameFilter);
                //    model = model.Where(x => x.ScientistCustomerId == sciid).ToList();
                //}
                //if (!string.IsNullOrEmpty(subscinameFilter))
                //{
                //    int subsciid = Convert.ToInt32(subscinameFilter);
                //    model = model.Where(x => x.SubScientistCustomerId == subsciid).ToList();
                //}
                //if (!string.IsNullOrEmpty(fltprostatusItem))
                //{
                //    if (fltprostatusItem == "blank")
                //    {
                //        model = model.Where(x => x.ProStatus == null).ToList();
                //    }
                //    else
                //    {
                //        model = model.Where(x => x.ProStatus == fltprostatusItem).ToList();
                //    }
                //}
                //if (!string.IsNullOrEmpty(fltprotypeItem))
                //{
                //    model = model.Where(x => x.ProjectType == fltprotypeItem).ToList();
                //}

                //if (!string.IsNullOrEmpty(fltactivity))
                //{
                //    model = model.Where(x => x.ActivityStatus == fltactivity).ToList();
                //}

                //if (!string.IsNullOrEmpty(searchby) && !string.IsNullOrEmpty(searchbyvalue))
                //{
                //    searchbyvalue = searchbyvalue.ToLower();
                //    if (searchbyvalue.Contains("+"))
                //    {
                //        List<string> searchlist = searchbyvalue.Split('+').Select(p => p.Trim()).ToList();

                //        List<ProjectListModel> objmodel = new List<ProjectListModel>();
                //        foreach (var item in searchlist)
                //        {
                //            var d = model.Where(x => x.CompanyName.Contains(item) ||
                //                                x.PONumber.ToLower().Contains(item) ||
                //                                x.CompanyName.ToLower().Contains(item) ||
                //                                x.ProductName.ToLower().Contains(item) ||
                //                                (x.CASNo != null ? x.CASNo.ToLower().Contains(item) : false) ||
                //                                (x.CATNo != null ? x.CATNo.ToLower().Contains(item) : false) ||
                //                               (x.BatchNo != null ? x.BatchNo.ToLower().Contains(item) : false)).ToList();
                //            if (d != null && d.Count > 0)
                //            {
                //                objmodel.AddRange(d);
                //            }
                //        }
                //        if (objmodel != null && objmodel.Count > 0)
                //        {
                //            model = objmodel;
                //        }
                //    }
                //    else
                //    {
                //        if (searchby == "quoteid")
                //        {
                //            model = model.Where(x => x.Ref.ToLower().Contains(searchbyvalue)).ToList();
                //        }
                //        if (searchby == "ponumber")
                //        {
                //            model = model.Where(x => x.PONumber.ToLower().Contains(searchbyvalue)).ToList();
                //        }
                //        if (searchby == "company")
                //        {
                //            model = model.Where(x => x.CompanyName.ToLower().Contains(searchbyvalue)).ToList();
                //        }
                //        if (searchby == "productname")
                //        {
                //            model = model.Where(x => x.ProductName.ToLower().Contains(searchbyvalue)).ToList();
                //        }
                //        if (searchby == "cas")
                //        {
                //            model = model.Where(x => x.CASNo != null ? x.CASNo.ToLower().Contains(searchbyvalue) : false).ToList();
                //        }
                //        if (searchby == "cat")
                //        {
                //            model = model.Where(x => x.CATNo != null ? x.CATNo.ToLower().Contains(searchbyvalue) : false).ToList();
                //        }
                //        if (searchby == "batchno")
                //        {
                //            model = model.Where(x => x.BatchNo != null ? x.BatchNo.ToLower().Contains(searchbyvalue) : false).ToList();
                //        }
                //    }
                //}

                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.SelectedScientistName != null && m.SelectedScientistName.ToLower().Contains(searchValue))
                                        || (m.SelectedSubScientistName != null && m.SelectedSubScientistName.ToLower().Contains(searchValue))
                                        || (m.CompanyName != null && m.CompanyName.ToLower().Contains(searchValue))
                                        || (m.PONumber != null && m.PONumber.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.Price != null && m.Price.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.SelectedProjectType != null && m.SelectedProjectType.ToLower().Contains(searchValue))
                                        || (m.RequiredQty != null && m.RequiredQty.ToLower().Contains(searchValue))
                                        || (m.SelectedAdditionalBatchNo != null && m.SelectedAdditionalBatchNo.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        || (m.MoveProjectDateText != null && m.MoveProjectDateText.ToString().ToLower().Contains(searchValue))
                                        || (m.EstimateCompleteDateText != null && m.EstimateCompleteDateText.ToString().ToLower().Contains(searchValue))
                                        || (m.AdminScientistStatus != null && m.AdminScientistStatus.ToLower().Contains(searchValue))
                                        || (m.ProjectStatustext != null && m.ProjectStatustext.ToLower().Contains(searchValue))
                                        || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                                        || (m.ActivityStatus != null && m.ActivityStatus.ToLower().Contains(searchValue))
                                        || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))).ToList();
                }

                //recordsTotal = model.Count();
                //var data = model.Skip(skip).Take(pageSize).ToList();
                var data = model;

                var jsonResult = Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
                jsonResult.MaxJsonLength = int.MaxValue;
                return jsonResult;

            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }
        }

        [HttpPost]
        public ActionResult LoadProductCancelledData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                var scinameFilter = Request.Form.GetValues("sciname")[0].ToString();

                var subscinameFilter = Request.Form.GetValues("subsciname")[0].ToString();
                var fltprostatusItem = Request.Form.GetValues("fltprostatusItem")[0].ToString();
                var fltactivity = Request.Form.GetValues("fltactivity")[0].ToString();
                var searchby = string.Empty;
                var searchbyvalue = string.Empty;
                if (Request.Form.GetValues("radiobuton") != null)
                {
                    searchby = Request.Form.GetValues("radiobuton")[0].ToString();
                }
                if (Request.Form.GetValues("searchbox") != null)
                {
                    searchbyvalue = Request.Form.GetValues("searchbox")[0].ToString().Trim();
                }
                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;

                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
                string pursynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
                var quotationDetailsdata = db.SZ_QuotationDetail.AsQueryable();
                // Getting all Customer data  
                var list = (from i in db.SZ_Quotation
                            join t2 in quotationDetailsdata on i.Id equals t2.QuoteId
                            where t2.MoveToProject == true
                            && string.IsNullOrEmpty(t2.TrackingNo)
                            && t2.IsCancel == true
                            orderby t2.MoveProjectDate descending
                            select t2).Distinct().AsQueryable();
                string internationcompanylist = "";
                if (SessionCookieManagement.IsInternational)
                {
                    internationcompanylist = db.SZ_UserManagement.Where(x => x.UserId == SessionCookieManagement.UserId).Select(x => x.CompanyIds).FirstOrDefault();
                    if (!string.IsNullOrEmpty(internationcompanylist))
                    {
                        List<int?> cidList = new List<int?>();
                        foreach (var item in internationcompanylist.Split(','))
                        {
                            if (!string.IsNullOrEmpty(item))
                            {
                                cidList.Add(Convert.ToInt32(item));
                            }
                        }
                        list = list.Where(x => cidList.Contains(x.SZ_Quotation.CompanyId) && x.SZ_Quotation.CreatedDate >= new DateTime(2022, 05, 01)).AsQueryable();
                    }
                }
                list = list.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo);

                var listItems = new List<SelectListItem>();
                var subscilistItems = new List<SelectListItem>();
                MemoryCacheManager objCache = new MemoryCacheManager();
                var queryData = objCache.Get("cache.queryData", () =>
                {
                    return db.SZ_QueryModule.AsNoTracking().ToList();
                });
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });

                var scienList = objCache.Get("cache.GetScientistId", () =>
                {
                    return db.GetScientistId().ToList();
                });

                var subscienList = objCache.Get("cache.subscienList", () =>
                {
                    return db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();
                });
                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                    subscilistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                });

                ViewBag.ScientistListItem = listItems;
                foreach (var term in subscienList)
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }

                    subscilistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                }
                ViewBag.SubScientistListItem = subscilistItems;
                var proIds = list.Select(x => x.ProductId).Distinct().ToList();
                var masterCOAData = objCache.Get("cache.mastercoadata", () =>
                {
                    return db.SZ_MasterCOA.ToList();
                });
                var childcoadata = objCache.Get("cache.childcoadata", () =>
                {
                    return db.SZ_ChildCOA.ToList();
                });
                var productsData = objCache.Get("cache.productsdata", () =>
                {
                    return db.Products.Where(x => x.Published == true && x.Deleted == false).ToList();
                });
                var ReadyToDeliverScientistStatusId = objCache.Get("cache.ReadyToDeliverScientistStatusId", () =>
                {
                    return db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                });
                var inventoryData = objCache.Get("cache.inventoryData", () =>
                {
                    return db.SZ_Inventory.ToList();
                });
                var catList = objCache.Get("cache.categorydata", () =>
                {
                    return db.Categories.Where(x => x.ParentCategoryId == 0 && x.Deleted == false && x.Published).ToList();
                });

                // var masterCOAData = db.SZ_MasterCOA.Where(x => proIds.Contains(x.ProductId)).ToList();
                masterCOAData = masterCOAData.Where(x => proIds.Contains(x.ProductId)).ToList();
                var masterCoaIds = masterCOAData.Select(x => x.Id).Distinct().ToList();
                childcoadata = childcoadata.Where(x => masterCoaIds.Contains(x.MasterCOAID.Value)).ToList();
                productsData = productsData.Where(x => proIds.Contains(x.Id) && x.Published == true && x.Deleted == false).ToList();
                inventoryData = inventoryData.Where(x => proIds.Contains(x.ProductId)).ToList();
                //var childcoadata = db.SZ_ChildCOA.Where(x => masterCoaIds.Contains(x.MasterCOAID.Value)).ToList();
                //var productsData = db.Products.Where(x => proIds.Contains(x.Id) && x.Published == true && x.Deleted == false).ToList();
                //var inventoryData = db.SZ_Inventory.Where(x => proIds.Contains(x.ProductId)).ToList();
                //var catList = db.Categories.Where(x => x.ParentCategoryId == 0 && x.Deleted == false && x.Published).ToList();
                //var ReadyToDeliverScientistStatusId = db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                var model = new List<ProjectListModel>();
                list.ForEach(k =>
                {
                    ProjectListModel subList = new ProjectListModel();
                    subList.IsConversionReport = k.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    subList.ChkSaveRow = "<input type='checkbox' value='" + k.Id + "' class='clsSaverow' />";
                    subList.ReadyToDeliverScientistStatusId = ReadyToDeliverScientistStatusId;
                    if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == subList.ReadyToDeliverScientistStatusId && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                    {
                        subList.ChkFirstRow = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                    }
                    else if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == subList.ReadyToDeliverScientistStatusId)
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' />";
                    }
                    else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && (k.MoveToDispatch == null || k.MoveToDispatch == false))
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' />";
                    }
                    else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                    {
                        subList.ChkFirstRow = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                    }
                    if (k.IsDispatchApprove.HasValue && k.IsDispatchApprove.Value && (k.MoveToDispatch == null || k.MoveToDispatch == false))
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' style='outline: 4px solid #c00'/>";
                    }

                    subList.ProjectType = k.ProjectType;
                    subList.ProjectTypeText = "<select id='projecttype_" + k.Id + "' class='clsProjType' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ProjectType), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.ProjectType)
                        {
                            selected = "selected ";
                            subList.SelectedProjectType = text;
                        }

                        //if (text != "In-House")
                        //{
                            subList.ProjectTypeText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                        //}
                    }
                    subList.ProjectTypeText += "</select>";
                    subList.IsPaymentPending = k.SZ_Quotation.SZ_CompanyList.IsPaymentPending;
                    subList.ActivityStatus = k.ActivityStatus;
                    subList.ActivityStatusText = "<select id='activitystatus_" + k.Id + "' class='clsActivityStatus' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";

                    //if (k.ActivityStatus == "Approval First")
                    //{
                    //    subList.ActivityStatusText += "<option value='Approval First' selected>Approval First</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Approval First'>Approval First</option>";
                    //}
                    //if (k.ActivityStatus == "Immediate Dispatch")
                    //{
                    //    subList.ActivityStatusText += "<option value='Immediate Dispatch' selected>Immediate Dispatch</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Immediate Dispatch'>Immediate Dispatch</option>";
                    //}

                    //if (k.ActivityStatus == "Short Qty Dispatch")
                    //{
                    //    subList.ActivityStatusText += "<option value='Short Qty Dispatch' selected>Short Qty Dispatch</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Short Qty Dispatch'>Short Qty Dispatch</option>";
                    //}
                    //if (k.ActivityStatus == "Repeat Order")
                    //{
                    //    subList.ActivityStatusText += "<option value='Repeat Order' selected>Repeat Order</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Repeat Order'>Repeat Order</option>";
                    //}
                    //if (k.ActivityStatus == "Data Approved")
                    //{
                    //    subList.ActivityStatusText += "<option value='Data Approved' selected>Data Approved</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Data Approved'>Data Approved</option>";
                    //}
                    //if (k.ActivityStatus == "Data Sent")
                    //{
                    //    subList.ActivityStatusText += "<option value='Data Sent' selected>Data Sent</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Data Sent'>Data Sent</option>";
                    //}
                    //if (k.ActivityStatus == "Data Correction")
                    //{
                    //    subList.ActivityStatusText += "<option value='Data Correction' selected>Data Correction</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Data Correction'>Data Correction</option>";
                    //}
                    //if (k.ActivityStatus == "Invoice Sent")
                    //{
                    //    subList.ActivityStatusText += "<option value='Invoice Sent' selected>Invoice Sent</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Invoice Sent'>Invoice Sent</option>";
                    //}

                    //if (k.ActivityStatus == "PDC Awaited")
                    //{
                    //    subList.ActivityStatusText += "<option value='PDC Awaited' selected>PDC Awaited</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='PDC Awaited'>PDC Awaited</option>";
                    //}
                    //if (k.ActivityStatus == "Advance Payment")
                    //{
                    //    subList.ActivityStatusText += "<option value='Advance Payment' selected>Advance Payment</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Advance Payment'>Advance Payment</option>";
                    //}
                    //if (k.ActivityStatus == "Payment Due")
                    //{
                    //    subList.ActivityStatusText += "<option value='Payment Due' selected>Payment Due</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Payment Due'>Payment Due</option>";
                    //}
                    //if (k.ActivityStatus == "Insufficient QTY")
                    //{
                    //    subList.ActivityStatusText += "<option value='Insufficient QTY' selected>Insufficient QTY</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Insufficient QTY'>Insufficient QTY</option>";
                    //}
                    if (k.ActivityStatus == "Approval First")
                    {
                        subList.ActivityStatusText += "<option value='Approval First' selected>Approval First</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Approval First'>Approval First</option>";
                    }
                    if (k.ActivityStatus == "Immediate Dispatch")
                    {
                        subList.ActivityStatusText += "<option value='Immediate Dispatch' selected>Immediate Dispatch</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Immediate Dispatch'>Immediate Dispatch</option>";
                    }

                    if (k.ActivityStatus == "Repeat Order")
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order' selected>Repeat Order</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order'>Repeat Order</option>";
                    }

                    if (k.ActivityStatus == "Repeat Order - Dispatch")
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Dispatch' selected>Repeat Order - Dispatch</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Dispatch'>Repeat Order - Dispatch</option>";
                    }
                    if (k.ActivityStatus == "Repeat Order - Approval First")
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Approval First' selected>Repeat Order - Approval First</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Approval First'>Repeat Order - Approval First</option>";
                    }
                    if (k.ActivityStatus == "Short Qty Dispatch")
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatch' selected>Short Qty Dispatch</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatch'>Short Qty Dispatch</option>";
                    }
                    if (k.ActivityStatus == "Short Qty Dispatched")
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatched' selected>Short Qty Dispatched</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatched'>Short Qty Dispatched</option>";
                    }
                    if (k.ActivityStatus == "Sample Request")
                    {
                        subList.ActivityStatusText += "<option value='Sample Request' selected>Sample Request</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Sample Request'>Sample Request</option>";
                    }
                    if (k.ActivityStatus == "Sample Sent")
                    {
                        subList.ActivityStatusText += "<option value='Sample Sent' selected>Sample Sent</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Sample Sent'>Sample Sent</option>";
                    }
                    if (k.ActivityStatus == "Sample Approved")
                    {
                        subList.ActivityStatusText += "<option value='Sample Approved' selected>Sample Approved</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Sample Approved'>Sample Approved</option>";
                    }
                    //if (k.ActivityStatus == "Insufficient QTY")
                    //{
                    //    subList.ActivityStatusText += "<option value='Insufficient QTY' selected>Insufficient QTY</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Insufficient QTY'>Insufficient QTY</option>";
                    //}
                    if (k.ActivityStatus == "Quote - Data Sent")
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Sent' selected>Quote - Data Sent</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Sent'>Quote - Data Sent</option>";
                    }
                    if (k.ActivityStatus == "Quote - Data Approved")
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Approved' selected>Quote - Data Approved</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Approved'>Quote - Data Approved</option>";
                    }
                    subList.ActivityStatusText += "</select>";
                    //subList.APIName = GetApiNameOfProduct(k.ProductId.Value, proCat, catList);
                    subList.ScientistName = "<select id='ScientistId_" + k.Id + "' class='scientist' scientistId='" + k.ScientistCustomerId + "' quotedetailsid='" + k.Id + "'><option value=''>--Select--</option>";
                    listItems.ForEach(r =>
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.ScientistCustomerId))
                        {
                            selected = "selected ";
                            subList.SelectedScientistName = r.Text;
                        }
                        subList.ScientistName += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    });

                    subList.ScientistName += "</select>";
                    if (!string.IsNullOrEmpty(k.SubScientistName))
                    {
                        var subsci = System.Text.RegularExpressions.Regex.IsMatch(k.SubScientistName, @"\d+");
                        if (subsci)
                        {
                            if (System.Text.RegularExpressions.Regex.Match(k.SubScientistName, @"\d+").Value == k.SubScientistName)
                            {
                                subList.SubScientistCustomerId = Convert.ToInt32(k.SubScientistName);
                            }
                        }
                    }

                    subList.SubScientistName = "<select id='SubScientistId_" + k.Id + "' class='subscientist' subscientistId='" + k.SubScientistName + "' quotedetailsid='" + k.Id + "'><option value=''>--Select--</option>";
                    subscilistItems.ForEach(r =>
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.SubScientistName))
                        {
                            selected = "selected ";
                            subList.SelectedSubScientistName = r.Text;
                        }
                        subList.SubScientistName += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    });

                    subList.SubScientistName += "</select>";

                    if (!string.IsNullOrEmpty(k.SZ_Quotation.Attachment))
                    {
                        subList.Attachment = "<a href = 'javascript:void(0)' onclick='attachment(" + k.QuoteId + ")'><i class='fa fa-paperclip'></i></a>";
                    }
                    subList.MoveProjectDateText = k.MoveProjectDate.HasValue ? k.MoveProjectDate.Value.ToString("dd/MM/yyyy hh:mm tt") : "";
                    subList.AdditionalBatchNo = k.AdditionalBatchNo;
                    subList.QuoteId = k.QuoteId;
                    subList.ProductId = k.ProductId;
                    subList.ProductName = k.ProductName;
                    subList.ScientistRemark = "<input id='sciremark_" + k.Id + "' type='text' value='" + k.ScientistRemark + "' style='width: 170px' />";
                    subList.RequiredQtyTxt = "<input id='qty_" + k.Id + "' type='text' value='" + k.RequiredQty + "' style='width: 50px; font-weight:bold' />";

                    if (!string.IsNullOrEmpty(k.ExplainationSecond))
                    {
                        subList.ExplainationSecondText = "<input id='explainationsecond_" + k.Id + "' type='text' value='" + k.ExplainationSecond.Replace("'", "&#8242;") + "' title='" + k.ExplainationSecond + "' style='width: 200px; font-weight:bold' />";
                    }
                    else
                    {
                        subList.ExplainationSecondText = "<input id='explainationsecond_" + k.Id + "' type='text' value='" + k.ExplainationSecond + "' title='" + k.ExplainationSecond + "' style='width: 200px; font-weight:bold' />";
                    }

                    subList.ExplainationSecond = k.ExplainationSecond;
                    subList.LastWeekUpdate = k.LastWeekUpdate;
                    subList.PaymentTerms = k.SZ_Quotation.PaymentTerm;
                    subList.AdditionalBatchNoText = "<select id='additionalBatch_" + k.Id + "' data-quotationdetailsid='" + k.Id + "' class='ddladditionalbatch'><option value=''>--Select--</option>";
                    if (subList.ProductId.HasValue)
                    {
                        var proData = productsData.Where(x => x.Id == subList.ProductId).Count();
                        var productData = productsData.Where(x => x.Id == subList.ProductId && x.Published == true && x.Deleted == false).FirstOrDefault();
                        if (productData != null)
                        {
                            subList.IsControlledSubstance = productData.IsControlledSubstance;
                            if (!subList.IsControlledSubstance.HasValue
                                || subList.IsControlledSubstance == false)
                            {
                                subList.IsControlledSubstance = productData.IsManuallyControlledSubstance;
                            }
                        }
                        var proBatchData = inventoryData.Where(x => x.ProductId == subList.ProductId).ToList();
                        if (proBatchData.Count > 0 && proData > 0)
                        {
                            proBatchData.ForEach(r =>
                            {
                                //var qty = System.Text.RegularExpressions.Regex.Match(Convert.ToString(r.Qty), @"\d+").Value;
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }
                                string selected = string.Empty;
                                if (r.Id == subList.AdditionalBatchNo)
                                {
                                    selected = "selected ";
                                    subList.BatchNo = r.BatchNo;
                                    subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
                                }
                                subList.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' " + selected + ">" + text + "</option>";
                            });
                        }
                    }
                    subList.AdditionalBatchNoText += "</select>";
                    //subList.BatchNo = k.BatchNo;
                    subList.BatchNoText = "<input id='batchno_" + k.Id + "' type='text' value='" + k.BatchNo + "' style='width:120px' />";
                    subList.IsImageAttach = k.SZ_Quotation.IsImageAttach;
                    subList.CompanyName = k.SZ_Quotation.CompanyName;
                    subList.Email = k.SZ_Quotation.EmailAddress;
                    subList.PONumber = k.SZ_Quotation.PONo;
                    subList.Ref = k.SZ_Quotation.Ref;
                    subList.Remark = k.Remark;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.QuoteDetailsId = k.Id;
                    subList.CASNo = k.CASNo;
                    var pName = "";
                    var query = queryData.Where(x => x.CATNo.Trim().ToLower() == k.CATNo.Trim().ToLower()).OrderByDescending(x => x.Id);
                    if (query != null && query.Count() > 0)
                    {
                        var qlist = query.Select(x => x.QueryNo).ToArray();
                        if (query.Select(x => x.Status.ToLower()).FirstOrDefault() == "solved" ||
                        query.Select(x => x.Status.ToLower()).FirstOrDefault() == "close" ||
                        query.Select(x => x.Status.ToLower()).FirstOrDefault() == "completed")
                        {
                            pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + k.CATNo + "\")' title='" + string.Join(", ", qlist) + "' style ='float:right; color: green' ></i>";
                        }
                        else
                        {
                            pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + k.CATNo + "\")' title='" + string.Join(", ", qlist) + "' style ='float:right' ></i>";
                        }
                    }
                    subList.IsConversionReport = k.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    var impstr = "";
                    if (subList.IsConversionReport.HasValue && subList.IsConversionReport.Value)
                    {
                        impstr += "<img src='/img/important.jpg' width='15px' height='15px' />";
                    }
                    subList.CATNo = pName + "" + "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>" + impstr + " " + CommonOperation.GetMatchingTagHTML(k, "Project");
                    subList.CreatedDate = k.CreatedDate;
                    subList.ImagePath = k.ImagePath;
                    subList.IsUploadServer = k.IsUploadServer;
                    subList.LeadTime = k.LeadTime;
                    subList.Price = k.Price;
                    subList.QuoteId = k.QuoteId;
                    subList.ProjectType = k.ProjectType;
                    subList.ScientistCustomerId = k.ScientistCustomerId;
                    subList.RequiredQty = k.RequiredQty;
                    subList.ProjectStatus = k.ProjectStatus;
                    subList.IsOnHold = k.IsOnHold;
                    if (k.ProjectStatus != null)
                    {
                        subList.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
                    }
                    subList.ScientistStatus = k.ScientistStatus;
                    subList.BatchCode1 = k.BatchCode1;
                    subList.BatchCode2 = k.BatchCode2;
                    subList.Qty1 = k.Qty1;
                    subList.Qty2 = k.Qty2;
                    subList.EstimateCompleteDate = k.EstimateCompleteDate;
                    subList.EstimateCompleteDateText = "<input id='esticompleteDate_" + k.Id + "' data-value='" + k.EstimateCompleteDate + "' type='text' class='datepicker'  style='width:80px' />";
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToProject = k.MoveToProject;
                    subList.Remark = k.Remark;
                    subList.SrPo = k.SrPo;
                    subList.AdminScientistStatus = k.AdminScientistStatus;
                    subList.InvoiceNo = k.InvoiceNo;
                    subList.InvoiceRemark = k.InvoiceRemark;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.ScientistStatustext = "<input id='scientistStatus_" + k.Id + "' type='text' value='" + k.AdminScientistStatus + "' title='" + k.AdminScientistStatus + "'  style='width:200px' />";
                    subList.RemarkText = "<input id='remark_" + k.Id + "' type='text' value='" + k.Remark + "' title='" + k.Remark + "' style='width: 170px' />";
                    subList.LastRowText = "<a href='javascript: void(0)' id='save_" + k.Id + "' onclick='SaveProjectDetails(\"" + k.Id + "\")'> Save</a> ";
                    subList.LastRowText += "<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";

                    subList.GetAllBatch = "<i class='fa fa-clone' title='View Batch No' onclick='GetAllBatchNo(" + k.ProductId + ", " + k.Id + ")'></i>";
                    subList.DispatchedStatus = k.DispatchedStatus;
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToInvoice = k.MoveToInvoice;
                    subList.IsDispatchApprove = k.IsDispatchApprove;
                    subList.IsPayment = k.IsPayment;
                    if (k.IsPayment.HasValue && k.IsPayment.Value)
                    {
                        subList.IsPaymentText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPayment' checked='checked'/>";
                    }
                    else
                    {
                        subList.IsPaymentText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPayment' />";
                    }

                    subList.OrderRemark = k.OrderRemark;
                    subList.OrderRemarkText = "<input id='orderremark_" + k.Id + "' type='text' value='" + k.OrderRemark + "' title='" + k.OrderRemark + "'  style='width:200px' />";

                    subList.Reason = k.Reason;
                    subList.ReasonText = "<input id='reason_" + k.Id + "' type='text' value='" + k.Reason + "' title='" + k.Reason + "'  style='width:200px' />";

                    if (k.MoveToScientistDate.HasValue)
                    {
                        subList.MoveToScientistDateStr = k.MoveToScientistDate.Value.ToShortDateString();
                    }

                    subList.ExplainationText += "<i class='fa fa-pencil' onclick='explainationGenerate(\"" + k.Id + "\")' ></i>"; //<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";
                    subList.DifficultyLevel = k.DifficultyLevel;
                    subList.DifficultyLevelText = "<select id='difflevel_" + k.Id + "' class='clsDifficultyLevel' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.DifficultyLevel r in Enum.GetValues(typeof(EnumList.DifficultyLevel)))
                    {
                        var item = Enum.GetName(typeof(EnumList.DifficultyLevel), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.DifficultyLevel)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.DifficultyLevel)
                        {
                            selected = "selected ";
                        }
                        subList.DifficultyLevelText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                    }
                    subList.DifficultyLevelText += "</select>";

                    subList.IsPriority = k.IsPriority;
                    if (k.IsPriority.HasValue && k.IsPriority.Value)
                    {
                        subList.IsPriorityText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPriority' checked='checked'/>";
                    }
                    else
                    {
                        subList.IsPriorityText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPriority' />";
                    }
                    subList.ProStatus = k.ProStatus;
                    subList.ProStatusText = "<select id='prostatus_" + k.Id + "' class='clsProjStatus' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.ProStatusDDL r in Enum.GetValues(typeof(EnumList.ProStatusDDL)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ProStatusDDL), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ProStatusDDL)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.ProStatus)
                        {
                            selected = "selected ";
                            subList.SelectedProStatus = text;
                        }
                        subList.ProStatusText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                    }
                    subList.ProStatusText += "</select>";
                    subList.COAId = k.COAId;
                    subList.COARefNumber = k.COARefNumber;
                    string coaText = "";

                    coaText = "<select id='coa_" + k.Id + "' class='addcoa'><option value=''>--Select--</option>";
                    int bId = k.AdditionalBatchNo.HasValue ? k.AdditionalBatchNo.Value : 0;
                    if (bId != 0)
                    {
                        var mastercoa = masterCOAData.Where(x => x.BatchId == bId).FirstOrDefault();
                        if (mastercoa != null)
                        {
                            var listchildcoa = childcoadata.Where(x => x.MasterCOAID == mastercoa.Id).ToList();
                            if (listchildcoa != null && listchildcoa.Count > 0)
                            {
                                foreach (var ccoa in listchildcoa)
                                {
                                    if (k.COAId == ccoa.Id)
                                    {
                                        coaText += "<option value='" + ccoa.Id.ToString() + "' data-value='" + k.AdditionalBatchNo + "' selected>" + ccoa.RefNo + "</option>";
                                    }
                                    else
                                    {
                                        coaText += "<option value='" + ccoa.Id.ToString() + "' data-value='" + k.AdditionalBatchNo + "'>" + ccoa.RefNo + "</option>";
                                    }
                                }
                            }
                        }
                    }
                    subList.COAText = coaText;
                    subList.CompanyId = k.SZ_Quotation.CompanyId;
                    model.Add(subList);
                });

                model = model.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).ThenBy(x => x.SrPo).ToList();
                if (!string.IsNullOrEmpty(scinameFilter))
                {
                    int sciid = Convert.ToInt32(scinameFilter);
                    model = model.Where(x => x.ScientistCustomerId == sciid).ToList();
                }
                if (!string.IsNullOrEmpty(subscinameFilter))
                {
                    int subsciid = Convert.ToInt32(subscinameFilter);
                    model = model.Where(x => x.SubScientistCustomerId == subsciid).ToList();
                }
                if (!string.IsNullOrEmpty(fltprostatusItem))
                {
                    model = model.Where(x => x.ProStatus == fltprostatusItem).ToList();
                }
                if (!string.IsNullOrEmpty(fltactivity))
                {
                    model = model.Where(x => x.ActivityStatus == fltactivity).ToList();
                }

                if (!string.IsNullOrEmpty(searchby) && !string.IsNullOrEmpty(searchbyvalue))
                {
                    searchbyvalue = searchbyvalue.ToLower();
                    if (searchby == "quoteid")
                    {
                        model = model.Where(x => x.Ref.ToLower().Contains(searchbyvalue)).ToList();
                    }
                    if (searchby == "ponumber")
                    {
                        model = model.Where(x => x.PONumber.ToLower().Contains(searchbyvalue)).ToList();
                    }
                    if (searchby == "company")
                    {
                        model = model.Where(x => x.CompanyName.ToLower().Contains(searchbyvalue)).ToList();
                    }
                    if (searchby == "productname")
                    {
                        model = model.Where(x => x.ProductName.ToLower().Contains(searchbyvalue)).ToList();
                    }
                    if (searchby == "cas")
                    {
                        model = model.Where(x => x.CASNo != null ? x.CASNo.ToLower().Contains(searchbyvalue) : false).ToList();
                    }
                    if (searchby == "cat")
                    {
                        model = model.Where(x => x.CATNo != null ? x.CATNo.ToLower().Contains(searchbyvalue) : false).ToList();
                    }
                    if (searchby == "batchno")
                    {
                        model = model.Where(x => x.BatchNo != null ? x.BatchNo.ToLower().Contains(searchbyvalue) : false).ToList();
                    }

                }

                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.SelectedScientistName != null && m.SelectedScientistName.ToLower().Contains(searchValue))
                                        || (m.SelectedSubScientistName != null && m.SelectedSubScientistName.ToLower().Contains(searchValue))
                                        || (m.CompanyName != null && m.CompanyName.ToLower().Contains(searchValue))
                                        || (m.PONumber != null && m.PONumber.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.Price != null && m.Price.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.SelectedProjectType != null && m.SelectedProjectType.ToLower().Contains(searchValue))
                                        || (m.RequiredQty != null && m.RequiredQty.ToLower().Contains(searchValue))
                                        || (m.SelectedAdditionalBatchNo != null && m.SelectedAdditionalBatchNo.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        || (m.MoveProjectDateText != null && m.MoveProjectDateText.ToString().ToLower().Contains(searchValue))
                                        || (m.EstimateCompleteDateText != null && m.EstimateCompleteDateText.ToString().ToLower().Contains(searchValue))
                                        || (m.AdminScientistStatus != null && m.AdminScientistStatus.ToLower().Contains(searchValue))
                                        || (m.ProjectStatustext != null && m.ProjectStatustext.ToLower().Contains(searchValue))
                                        || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                                        || (m.ActivityStatus != null && m.ActivityStatus.ToLower().Contains(searchValue))
                                        || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))).ToList();
                }

                //total number of rows count   
                recordsTotal = model.Count();
                //Paging   
                var data = model.Skip(skip).Take(pageSize).ToList();
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }
        }


        [HttpPost]
        public ActionResult LoadPrepHPLCData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();


                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;
                string prostats = Convert.ToString((int)EnumList.ProStatusDDL.PrepHPLC);

                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
                string pursynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
                var quotationDetailsdata = db.SZ_QuotationDetail.AsQueryable();
                // Getting all Customer data  
                var list = (from i in db.SZ_Quotation
                            join t2 in quotationDetailsdata on i.Id equals t2.QuoteId
                            where t2.MoveToProject == true
                            && t2.ProStatus == prostats
                            && string.IsNullOrEmpty(t2.TrackingNo)
                            && (t2.IsOnHold == false || t2.IsOnHold == null)
                            && (t2.ProjectType != inhouseProjectType || t2.ProjectType == null)
                            orderby t2.MoveProjectDate descending
                            select t2).Distinct().AsQueryable();

                list = list.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo);

                var listItems = new List<SelectListItem>();
                var subscilistItems = new List<SelectListItem>();
                MemoryCacheManager objCache = new MemoryCacheManager();
                var queryData = objCache.Get("cache.queryData", () =>
                {
                    return db.SZ_QueryModule.AsNoTracking().ToList();
                });
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });

                var scienList = objCache.Get("cache.GetScientistId", () =>
                {
                    return db.GetScientistId().ToList();
                });

                var subscienList = objCache.Get("cache.subscienList", () =>
                {
                    return db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();
                });
                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                    subscilistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                });

                ViewBag.ScientistListItem = listItems;
                foreach (var term in subscienList)
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }

                    subscilistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });

                }
                ViewBag.SubScientistListItem = subscilistItems;

                var masterCOAData = objCache.Get("cache.mastercoadata", () =>
                {
                    return db.SZ_MasterCOA.ToList();
                });
                var childcoadata = objCache.Get("cache.childcoadata", () =>
                {
                    return db.SZ_ChildCOA.ToList();
                });
                var productsData = objCache.Get("cache.productsdata", () =>
                {
                    return db.Products.Where(x => x.Published == true && x.Deleted == false).ToList();
                });
                var ReadyToDeliverScientistStatusId = objCache.Get("cache.ReadyToDeliverScientistStatusId", () =>
                {
                    return db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                });
                var inventoryData = objCache.Get("cache.inventoryData", () =>
                {
                    return db.SZ_Inventory.ToList();
                });
                var catList = objCache.Get("cache.categorydata", () =>
                {
                    return db.Categories.Where(x => x.ParentCategoryId == 0 && x.Deleted == false && x.Published).ToList();
                });
                var proIds = list.Select(x => x.ProductId).Distinct().ToList();
                masterCOAData = masterCOAData.Where(x => proIds.Contains(x.ProductId)).ToList();
                inventoryData = inventoryData.Where(x => proIds.Contains(x.ProductId)).ToList();
                productsData = productsData.Where(x => proIds.Contains(x.Id) && x.Published == true && x.Deleted == false).ToList();
                catList = catList.Where(x => x.ParentCategoryId == 0 && x.Deleted == false && x.Published).ToList();
                var model = new List<ProjectListModel>();
                var mastercoaids = masterCOAData.Select(x => x.Id).ToList();
                childcoadata = childcoadata.Where(x => mastercoaids.Contains(x.MasterCOAID.Value)).ToList();
                list.ForEach(k =>
                {
                    ProjectListModel subList = new ProjectListModel();
                    subList.ChkSaveRow = "<input type='checkbox' value='" + k.Id + "' class='clsSaverow' />";
                    subList.ReadyToDeliverScientistStatusId = ReadyToDeliverScientistStatusId;
                    if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == subList.ReadyToDeliverScientistStatusId && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                    {
                        subList.ChkFirstRow = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                    }
                    else if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == subList.ReadyToDeliverScientistStatusId)
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' />";
                    }
                    else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && (k.MoveToDispatch == null || k.MoveToDispatch == false))
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' />";
                    }
                    else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                    {
                        subList.ChkFirstRow = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                    }
                    if (k.IsDispatchApprove.HasValue && k.IsDispatchApprove.Value && (k.MoveToDispatch == null || k.MoveToDispatch == false))
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' style='outline: 4px solid #c00'/>";
                    }
                    subList.ProjectType = k.ProjectType;
                    subList.ProjectTypeText = "<select id='projecttype_" + k.Id + "' class='clsProjType' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ProjectType), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.ProjectType)
                        {
                            selected = "selected ";
                            subList.SelectedProjectType = text;
                        }
                        //if (text != "In-House")
                        //{
                            subList.ProjectTypeText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                        //}
                    }
                    subList.ProjectTypeText += "</select>";
                    subList.IsPaymentPending = k.SZ_Quotation.SZ_CompanyList.IsPaymentPending;
                    subList.ActivityStatus = k.ActivityStatus;
                    subList.ActivityStatusText = "<select id='activitystatus_" + k.Id + "' class='clsActivityStatus' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";

                    if (k.ActivityStatus == "Approval First")
                    {
                        subList.ActivityStatusText += "<option value='Approval First' selected>Approval First</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Approval First'>Approval First</option>";
                    }
                    if (k.ActivityStatus == "Immediate Dispatch")
                    {
                        subList.ActivityStatusText += "<option value='Immediate Dispatch' selected>Immediate Dispatch</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Immediate Dispatch'>Immediate Dispatch</option>";
                    }

                    if (k.ActivityStatus == "Repeat Order")
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order' selected>Repeat Order</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order'>Repeat Order</option>";
                    }

                    if (k.ActivityStatus == "Repeat Order - Dispatch")
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Dispatch' selected>Repeat Order - Dispatch</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Dispatch'>Repeat Order - Dispatch</option>";
                    }
                    if (k.ActivityStatus == "Repeat Order - Approval First")
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Approval First' selected>Repeat Order - Approval First</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Approval First'>Repeat Order - Approval First</option>";
                    }
                    if (k.ActivityStatus == "Short Qty Dispatch")
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatch' selected>Short Qty Dispatch</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatch'>Short Qty Dispatch</option>";
                    }
                    if (k.ActivityStatus == "Short Qty Dispatched")
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatched' selected>Short Qty Dispatched</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatched'>Short Qty Dispatched</option>";
                    }
                    if (k.ActivityStatus == "Sample Request")
                    {
                        subList.ActivityStatusText += "<option value='Sample Request' selected>Sample Request</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Sample Request'>Sample Request</option>";
                    }
                    if (k.ActivityStatus == "Sample Sent")
                    {
                        subList.ActivityStatusText += "<option value='Sample Sent' selected>Sample Sent</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Sample Sent'>Sample Sent</option>";
                    }
                    if (k.ActivityStatus == "Sample Approved")
                    {
                        subList.ActivityStatusText += "<option value='Sample Approved' selected>Sample Approved</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Sample Approved'>Sample Approved</option>";
                    }
                    //if (k.ActivityStatus == "Insufficient QTY")
                    //{
                    //    subList.ActivityStatusText += "<option value='Insufficient QTY' selected>Insufficient QTY</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Insufficient QTY'>Insufficient QTY</option>";
                    //}
                    if (k.ActivityStatus == "Quote - Data Sent")
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Sent' selected>Quote - Data Sent</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Sent'>Quote - Data Sent</option>";
                    }
                    if (k.ActivityStatus == "Quote - Data Approved")
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Approved' selected>Quote - Data Approved</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Approved'>Quote - Data Approved</option>";
                    }
                    subList.ActivityStatusText += "</select>";
                    //subList.APIName = GetApiNameOfProduct(k.ProductId.Value, proCat, catList);
                    subList.ScientistName = "<select id='ScientistId_" + k.Id + "' class='scientist' scientistId='" + k.ScientistCustomerId + "' quotedetailsid='" + k.Id + "'><option value=''>--Select--</option>";
                    listItems.ForEach(r =>
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.ScientistCustomerId))
                        {
                            selected = "selected ";
                            subList.SelectedScientistName = r.Text;
                        }
                        subList.ScientistName += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    });

                    subList.ScientistName += "</select>";
                    if (!string.IsNullOrEmpty(k.SubScientistName))
                    {
                        var subsci = System.Text.RegularExpressions.Regex.IsMatch(k.SubScientistName, @"\d+");
                        if (subsci)
                        {
                            if (System.Text.RegularExpressions.Regex.Match(k.SubScientistName, @"\d+").Value == k.SubScientistName)
                            {
                                subList.SubScientistCustomerId = Convert.ToInt32(k.SubScientistName);
                            }
                        }
                    }

                    subList.SubScientistName = "<select id='SubScientistId_" + k.Id + "' class='subscientist' subscientistId='" + k.SubScientistName + "' quotedetailsid='" + k.Id + "'><option value=''>--Select--</option>";
                    subscilistItems.ForEach(r =>
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.SubScientistName))
                        {
                            selected = "selected ";
                            subList.SelectedSubScientistName = r.Text;
                        }
                        subList.SubScientistName += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    });

                    subList.SubScientistName += "</select>";

                    if (!string.IsNullOrEmpty(k.SZ_Quotation.Attachment))
                    {
                        subList.Attachment = "<a href = 'javascript:void(0)' onclick='attachment(" + k.QuoteId + ")'><i class='fa fa-paperclip'></i></a>";
                    }
                    subList.MoveProjectDateText = k.MoveProjectDate.HasValue ? k.MoveProjectDate.Value.ToString("dd/MM/yyyy hh:mm tt") : "";
                    subList.AdditionalBatchNo = k.AdditionalBatchNo;
                    subList.QuoteId = k.SZ_Quotation.Id;
                    subList.ProductId = k.ProductId;
                    subList.ProductName = k.ProductName;
                    subList.ScientistRemark = "<input id='sciremark_" + k.Id + "' type='text' value='" + k.ScientistRemark + "' style='width: 170px' />";
                    subList.RequiredQtyTxt = "<input id='qty_" + k.Id + "' type='text' value='" + k.RequiredQty + "' style='width: 50px; font-weight:bold' />";
                    subList.ExplainationSecondText = k.ExplainationSecond;
                    subList.ExplainationSecond = k.ExplainationSecond;
                    subList.LastWeekUpdate = k.LastWeekUpdate;
                    subList.PaymentTerms = k.SZ_Quotation.PaymentTerm;
                    subList.AdditionalBatchNoText = "<select id='additionalBatch_" + k.Id + "' data-quotationdetailsid='" + k.Id + "' class='ddladditionalbatch'><option value=''>--Select--</option>";
                    if (subList.ProductId.HasValue)
                    {
                        var proData = productsData.Where(x => x.Id == subList.ProductId).Count();
                        var proBatchData = inventoryData.Where(x => x.ProductId == subList.ProductId).ToList();
                        if (proBatchData.Count > 0 && proData > 0)
                        {
                            proBatchData.ForEach(r =>
                            {
                                //var qty = System.Text.RegularExpressions.Regex.Match(Convert.ToString(r.Qty), @"\d+").Value;
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }
                                string selected = string.Empty;
                                if (r.Id == subList.AdditionalBatchNo)
                                {
                                    selected = "selected ";
                                    subList.BatchNo = r.BatchNo;
                                    subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
                                }

                                subList.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' " + selected + ">" + text + "</option>";
                            });
                        }
                    }
                    subList.AdditionalBatchNoText += "</select>";
                    subList.BatchNoText = "<input id='batchno_" + k.Id + "' type='text' value='" + k.BatchNo + "' style='width:120px' />";
                    subList.IsImageAttach = k.SZ_Quotation.IsImageAttach;
                    subList.CompanyName = k.SZ_Quotation.SZ_CompanyList.Name;
                    subList.Email = k.SZ_Quotation.EmailAddress;
                    subList.PONumber = k.SZ_Quotation.PONo;
                    subList.Ref = k.SZ_Quotation.Ref;
                    subList.Remark = k.SZ_Quotation.Remark;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.QuoteDetailsId = k.Id;
                    subList.CASNo = k.CASNo;
                    var pName = "";
                    var query = queryData.Where(x => x.CATNo.Trim().ToLower() == k.CATNo.Trim().ToLower()).OrderByDescending(x => x.Id);
                    if (query != null && query.Count() > 0)
                    {
                        var qlist = query.Select(x => x.QueryNo).ToArray();
                        if (query.Select(x => x.Status.ToLower()).FirstOrDefault() == "solved" ||
                        query.Select(x => x.Status.ToLower()).FirstOrDefault() == "close" ||
                        query.Select(x => x.Status.ToLower()).FirstOrDefault() == "completed")
                        {
                            pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + k.CATNo + "\")' title='" + string.Join(", ", qlist) + "' style ='float:right; color: green' ></i>";
                        }
                        else
                        {
                            pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + k.CATNo + "\")' title='" + string.Join(", ", qlist) + "' style ='float:right' ></i>";
                        }
                    }
                    subList.CATNo = pName + "" + "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>";
                    subList.CreatedDate = k.CreatedDate;
                    subList.ImagePath = k.ImagePath;
                    subList.IsUploadServer = k.IsUploadServer;
                    subList.LeadTime = k.LeadTime;
                    subList.Price = k.Price;
                    subList.QuoteId = k.QuoteId;
                    subList.ProjectType = k.ProjectType;
                    subList.ScientistCustomerId = k.ScientistCustomerId;
                    subList.RequiredQty = k.RequiredQty;
                    subList.ProjectStatus = k.ProjectStatus;
                    subList.IsOnHold = k.IsOnHold;
                    if (k.ProjectStatus != null)
                    {
                        subList.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
                    }
                    subList.ScientistStatus = k.ScientistStatus;
                    subList.BatchCode1 = k.BatchCode1;
                    subList.BatchCode2 = k.BatchCode2;
                    subList.Qty1 = k.Qty1;
                    subList.Qty2 = k.Qty2;
                    subList.EstimateCompleteDate = k.EstimateCompleteDate;
                    subList.EstimateCompleteDateText = "<input id='esticompleteDate_" + k.Id + "' data-value='" + k.EstimateCompleteDate + "' type='text' class='datepicker'  style='width:80px' />";
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToProject = k.MoveToProject;
                    subList.Remark = k.Remark;
                    subList.SrPo = k.SrPo;
                    subList.AdminScientistStatus = k.AdminScientistStatus;
                    subList.InvoiceNo = k.InvoiceNo;
                    subList.InvoiceRemark = k.InvoiceRemark;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.ScientistStatustext = "<input id='scientistStatus_" + k.Id + "' type='text' value='" + k.AdminScientistStatus + "' title='" + k.AdminScientistStatus + "'  style='width:200px' />";
                    //subList.RemarkText = "<input id='remark_" + k.Id + "' type='text' value='" + k.Remark + "' title='" + k.Remark + "' style='width: 170px' />";
                    subList.RemarkText = k.Remark;
                    subList.LastRowText = "<a href='javascript: void(0)' id='save_" + k.Id + "' onclick='SaveProjectDetails(\"" + k.Id + "\")'> Save</a> ";
                    subList.LastRowText += "<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";
                    subList.GetAllBatch = "<i class='fa fa-clone' title='View Batch No' onclick='GetAllBatchNo(" + k.ProductId + ", " + k.Id + ")'></i>";
                    subList.DispatchedStatus = k.DispatchedStatus;
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToInvoice = k.MoveToInvoice;
                    subList.IsDispatchApprove = k.IsDispatchApprove;
                    subList.IsPayment = k.SZ_Quotation.IsPayment;
                    if (k.SZ_Quotation.IsPayment.HasValue && k.SZ_Quotation.IsPayment.Value)
                    {
                        subList.IsPaymentText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPayment' checked='checked'/>";
                    }
                    else
                    {
                        subList.IsPaymentText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPayment' />";
                    }

                    subList.OrderRemark = k.OrderRemark;
                    subList.OrderRemarkText = "<input id='orderremark_" + k.Id + "' type='text' value='" + k.OrderRemark + "' title='" + k.OrderRemark + "'  style='width:200px' />";

                    subList.Reason = k.Reason;
                    subList.ReasonText = "<input id='reason_" + k.Id + "' type='text' value='" + k.Reason + "' title='" + k.Reason + "'  style='width:200px' />";

                    if (k.MoveToScientistDate.HasValue)
                    {
                        subList.MoveToScientistDateStr = k.MoveToScientistDate.Value.ToShortDateString();
                    }

                    subList.ExplainationText += "<i class='fa fa-pencil' onclick='explainationGenerate(\"" + k.Id + "\")' ></i>"; //<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";
                    subList.DifficultyLevel = k.DifficultyLevel;
                    subList.DifficultyLevelText = "<select id='difflevel_" + k.Id + "' class='clsDifficultyLevel' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.DifficultyLevel r in Enum.GetValues(typeof(EnumList.DifficultyLevel)))
                    {
                        var item = Enum.GetName(typeof(EnumList.DifficultyLevel), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.DifficultyLevel)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.DifficultyLevel)
                        {
                            selected = "selected ";
                        }
                        subList.DifficultyLevelText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                    }
                    subList.DifficultyLevelText += "</select>";
                    subList.IsPriority = k.IsPriority;
                    if (k.IsPriority.HasValue && k.IsPriority.Value)
                    {
                        subList.IsPriorityText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPriority' checked='checked'/>";
                    }
                    else
                    {
                        subList.IsPriorityText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPriority' />";
                    }
                    subList.ProStatus = k.ProStatus;
                    subList.ProStatusText = "<select id='prostatus_" + k.Id + "' class='clsProjStatus' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.ProStatusDDL r in Enum.GetValues(typeof(EnumList.ProStatusDDL)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ProStatusDDL), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ProStatusDDL)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.ProStatus)
                        {
                            selected = "selected ";
                            subList.SelectedProStatus = text;
                        }
                        subList.ProStatusText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                    }
                    subList.ProStatusText += "</select>";
                    subList.COAId = k.COAId;
                    subList.COARefNumber = k.COARefNumber;
                    string coaText = "";

                    coaText = "<select id='coa_" + k.Id + "' class='addcoa'><option value=''>--Select--</option>";
                    int bId = k.AdditionalBatchNo.HasValue ? k.AdditionalBatchNo.Value : 0;
                    if (bId != 0)
                    {
                        var mastercoa = masterCOAData.Where(x => x.BatchId == bId).FirstOrDefault();
                        if (mastercoa != null)
                        {
                            var listchildcoa = childcoadata.Where(x => x.MasterCOAID == mastercoa.Id).ToList();
                            if (listchildcoa != null && listchildcoa.Count > 0)
                            {
                                foreach (var ccoa in listchildcoa)
                                {
                                    if (k.COAId == ccoa.Id)
                                    {
                                        coaText += "<option value='" + ccoa.Id.ToString() + "' data-value='" + k.AdditionalBatchNo + "' selected>" + ccoa.RefNo + "</option>";
                                    }
                                    else
                                    {
                                        coaText += "<option value='" + ccoa.Id.ToString() + "' data-value='" + k.AdditionalBatchNo + "'>" + ccoa.RefNo + "</option>";
                                    }
                                }
                            }
                        }
                    }
                    subList.COAText = coaText;
                    model.Add(subList);
                });

                model = model.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).ThenBy(x => x.SrPo).ToList();

                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.SelectedScientistName != null && m.SelectedScientistName.ToLower().Contains(searchValue))
                                        || (m.SelectedSubScientistName != null && m.SelectedSubScientistName.ToLower().Contains(searchValue))
                                        || (m.CompanyName != null && m.CompanyName.ToLower().Contains(searchValue))
                                        || (m.PONumber != null && m.PONumber.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.Price != null && m.Price.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.SelectedProjectType != null && m.SelectedProjectType.ToLower().Contains(searchValue))
                                        || (m.RequiredQty != null && m.RequiredQty.ToLower().Contains(searchValue))
                                        || (m.SelectedAdditionalBatchNo != null && m.SelectedAdditionalBatchNo.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        || (m.MoveProjectDateText != null && m.MoveProjectDateText.ToString().ToLower().Contains(searchValue))
                                        || (m.EstimateCompleteDateText != null && m.EstimateCompleteDateText.ToString().ToLower().Contains(searchValue))
                                        || (m.AdminScientistStatus != null && m.AdminScientistStatus.ToLower().Contains(searchValue))
                                        || (m.ProjectStatustext != null && m.ProjectStatustext.ToLower().Contains(searchValue))
                                        || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                                        || (m.ActivityStatus != null && m.ActivityStatus.ToLower().Contains(searchValue))
                                        || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))).ToList();
                }

                //total number of rows count   
                recordsTotal = model.Count();
                //Paging   
                var data = model.Skip(skip).Take(pageSize).ToList();
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }

        }

        [HttpPost]
        public ActionResult LoadProductSynthesisLogData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();

                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;

                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
                string pursynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);

                var quotationDetailsdata = db.SZ_QuotationDetail.AsEnumerable();
                // Getting all Customer data  
                var list = (from i in db.SZ_Quotation
                            join t2 in quotationDetailsdata on i.Id equals t2.QuoteId
                            where (t2.MoveToProject == false || t2.MoveToProject == null)
                            && t2.ScientistCustomerId != null
                            && t2.IsSynthesisLog == true
                            orderby t2.MoveProjectDate descending
                            select t2).Distinct();

                list = list.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo);

                var listItems = new List<SelectListItem>();
                MemoryCacheManager objCache = new MemoryCacheManager();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });

                var scienList = objCache.Get("cache.GetScientistId", () =>
                {
                    return db.GetScientistId().ToList();
                });

                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                });

                var proIds = list.Select(x => x.ProductId).Distinct().ToList();
                var productsData = db.Products.Where(x => proIds.Contains(x.Id) && x.Published == true && x.Deleted == false).ToList();
                var inventoryData = db.SZ_Inventory.Where(x => proIds.Contains(x.ProductId)).ToList();

                var model = new List<ProjectListModel>();
                foreach (var k in list)
                {
                    ProjectListModel subList = new ProjectListModel();
                    subList.IsConversionReport = k.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    subList.ChkSaveRow = "<input type='checkbox' value='" + k.Id + "' class='clsSaverow' />";
                    subList.ReadyToDeliverScientistStatusId = db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                    if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == subList.ReadyToDeliverScientistStatusId && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                    {
                        subList.ChkFirstRow = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                    }
                    else if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == subList.ReadyToDeliverScientistStatusId)
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' />";
                    }
                    else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && k.MoveToDispatch == null)
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' />";
                    }
                    else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                    {
                        subList.ChkFirstRow = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                    }
                    if (k.IsDispatchApprove.HasValue && k.IsDispatchApprove.Value && k.MoveToDispatch == null)
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' style='outline: 4px solid #c00'/>";
                    }
                    subList.ProjectType = k.ProjectType;
                    subList.ProjectTypeText = "<select id='projecttype_" + k.Id + "' class='clsProjType' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ProjectType), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.ProjectType)
                        {
                            selected = "selected ";
                            subList.SelectedProjectType = text;
                        }

                        //if (text != "In-House")
                        //{
                            subList.ProjectTypeText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                        //}
                    }
                    subList.ProjectTypeText += "</select>";
                    subList.ScientistName = "<select id='ScientistId_" + k.Id + "' class='scientist' scientistId='" + k.ScientistCustomerId + "' quotedetailsid='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (var r in listItems)
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.ScientistCustomerId))
                        {
                            selected = "selected ";
                            subList.SelectedScientistName = r.Text;
                        }
                        subList.ScientistName += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    }
                    subList.ScientistName += "</select>";
                    subList.MoveProjectDateText = k.MoveProjectDate.HasValue ? k.MoveProjectDate.Value.ToString("dd/MM/yyyy hh:mm tt") : "";
                    subList.AdditionalBatchNo = k.AdditionalBatchNo;
                    subList.QuoteId = k.SZ_Quotation.Id;
                    subList.ProductId = k.ProductId;
                    subList.ProductName = k.ProductName;
                    subList.ScientistRemark = "<input id='sciremark_" + k.Id + "' type='text' value='" + k.ScientistRemark + "' style='width: 170px' />";
                    subList.RequiredQtyTxt = "<input id='qty_" + k.Id + "' type='text' value='" + k.RequiredQty + "' style='width: 50px; font-weight:bold' />";
                    subList.AdditionalBatchNoText = "<select id='additionalBatch_" + k.Id + "' data-quotationdetailsid='" + k.Id + "' class='ddladditionalbatch'><option value=''>--Select--</option>";
                    if (subList.ProductId.HasValue)
                    {
                        var proData = productsData.Where(x => x.Id == subList.ProductId).Count();
                        var productData = productsData.Where(x => x.Id == subList.ProductId && x.Published == true && x.Deleted == false).FirstOrDefault();
                        if (productData != null)
                        {
                            subList.IsControlledSubstance = productData.IsControlledSubstance;
                            if (!subList.IsControlledSubstance.HasValue
                                || subList.IsControlledSubstance == false)
                            {
                                subList.IsControlledSubstance = productData.IsManuallyControlledSubstance;
                            }
                        }

                        var proBatchData = inventoryData.Where(x => x.ProductId == subList.ProductId).ToList();
                        if (proBatchData.Count > 0 && proData > 0)
                        {
                            foreach (var r in proBatchData)
                            {
                                //var qty = System.Text.RegularExpressions.Regex.Match(Convert.ToString(r.Qty), @"\d+").Value;
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }
                                string selected = string.Empty;
                                if (r.Id == subList.AdditionalBatchNo)
                                {
                                    selected = "selected ";
                                    subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
                                }

                                subList.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' " + selected + ">" + text + "</option>";
                            }
                        }
                    }
                    subList.AdditionalBatchNoText += "</select>";
                    subList.BatchNoText = "<input id='batchno_" + k.Id + "' type='text' value='" + k.BatchNo + "' style='width:120px' />";
                    subList.IsImageAttach = k.SZ_Quotation.IsImageAttach;
                    subList.CompanyName = k.SZ_Quotation.SZ_CompanyList.Name;
                    subList.Email = k.SZ_Quotation.EmailAddress;
                    subList.PONumber = k.SZ_Quotation.PONo;
                    subList.Ref = k.SZ_Quotation.Ref;
                    subList.Remark = k.SZ_Quotation.Remark;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.QuoteDetailsId = k.Id;
                    subList.CASNo = k.CASNo;
                    subList.CATNo = "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>";
                    subList.CreatedDate = k.CreatedDate;
                    subList.ImagePath = k.ImagePath;
                    subList.IsUploadServer = k.IsUploadServer;
                    subList.LeadTime = k.LeadTime;
                    subList.Price = k.Price;

                    subList.QuoteId = k.QuoteId;
                    subList.ProjectType = k.ProjectType;
                    subList.ScientistCustomerId = k.ScientistCustomerId;

                    subList.RequiredQty = k.RequiredQty;
                    subList.ProjectStatus = k.ProjectStatus;
                    subList.IsOnHold = k.IsOnHold;
                    if (k.ProjectStatus != null)
                    {
                        subList.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
                    }
                    subList.ScientistStatus = k.ScientistStatus;
                    subList.BatchCode1 = k.BatchCode1;
                    subList.BatchCode2 = k.BatchCode2;
                    subList.Qty1 = k.Qty1;
                    subList.Qty2 = k.Qty2;
                    subList.EstimateCompleteDate = k.EstimateCompleteDate;
                    subList.EstimateCompleteDateText = "<input id='esticompleteDate_" + k.Id + "' data-value='" + k.EstimateCompleteDate + "' type='text' class='datepicker'  style='width:80px' />";

                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToProject = k.MoveToProject;
                    subList.Remark = k.Remark;
                    subList.SrPo = k.SrPo;
                    subList.AdminScientistStatus = k.AdminScientistStatus;
                    subList.InvoiceNo = k.InvoiceNo;
                    subList.InvoiceRemark = k.InvoiceRemark;

                    subList.MoveProjectDate = k.MoveProjectDate;

                    subList.ScientistStatustext = "<input id='scientistStatus_" + k.Id + "' type='text' value='" + k.AdminScientistStatus + "' title='" + k.AdminScientistStatus + "'  style='width:200px' />";
                    subList.RemarkText = "<input id='remark_" + k.Id + "' type='text' value='" + k.Remark + "' title='" + k.Remark + "' style='width: 170px' />";
                    subList.LastRowText = "<a href='javascript: void(0)' id='save_" + k.Id + "' onclick='SaveProjectDetails(\"" + k.Id + "\")'> Save</a> ";
                    subList.LastRowText += "<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";
                    subList.SubScientistName = k.SubScientistName;
                    subList.GetAllBatch = "<i class='fa fa-clone' title='View Batch No' onclick='GetAllBatchNo(" + k.ProductId + ", " + k.Id + ")'></i>";
                    subList.DispatchedStatus = k.DispatchedStatus;
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToInvoice = k.MoveToInvoice;
                    subList.IsDispatchApprove = k.IsDispatchApprove;

                    subList.IsPayment = k.SZ_Quotation.IsPayment;
                    if (k.SZ_Quotation.IsPayment.HasValue && k.SZ_Quotation.IsPayment.Value)
                    {
                        subList.IsPaymentText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPayment' checked='checked'/>";
                    }
                    else
                    {
                        subList.IsPaymentText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPayment' />";
                    }

                    subList.OrderRemark = k.OrderRemark;
                    subList.OrderRemarkText = "<input id='orderremark_" + k.Id + "' type='text' value='" + k.OrderRemark + "' title='" + k.OrderRemark + "'  style='width:200px' />";

                    subList.Reason = k.Reason;
                    subList.ReasonText = "<input id='reason_" + k.Id + "' type='text' value='" + k.Reason + "' title='" + k.Reason + "'  style='width:200px' />";

                    if (k.MoveToScientistDate.HasValue)
                    {
                        subList.MoveToScientistDateStr = k.MoveToScientistDate.Value.ToShortDateString();
                    }

                    subList.ExplainationText += "<i class='fa fa-pencil' onclick='explainationGenerate(\"" + k.Id + "\")' ></i>"; //<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";
                    subList.DifficultyLevel = k.DifficultyLevel;
                    subList.DifficultyLevelText = "<select id='difflevel_" + k.Id + "' class='clsDifficultyLevel' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.DifficultyLevel r in Enum.GetValues(typeof(EnumList.DifficultyLevel)))
                    {
                        var item = Enum.GetName(typeof(EnumList.DifficultyLevel), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.DifficultyLevel)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.DifficultyLevel)
                        {
                            selected = "selected ";
                        }
                        subList.DifficultyLevelText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                    }
                    subList.DifficultyLevelText += "</select>";

                    subList.IsPriority = k.IsPriority;
                    if (k.IsPriority.HasValue && k.IsPriority.Value)
                    {
                        subList.IsPriorityText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPriority' checked='checked'/>";
                    }
                    else
                    {
                        subList.IsPriorityText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPriority' />";
                    }
                    subList.PaymentTerms = k.SZ_Quotation.PaymentTerm;
                    model.Add(subList);
                }
                model = model.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).ThenBy(x => x.SrPo).ToList();

                if (!string.IsNullOrEmpty(searchValue))
                {


                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.SelectedScientistName != null && m.SelectedScientistName.ToLower().Contains(searchValue))
                                        || (m.CompanyName != null && m.CompanyName.ToLower().Contains(searchValue))
                                        || (m.PONumber != null && m.PONumber.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.Price != null && m.Price.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.SelectedProjectType != null && m.SelectedProjectType.ToLower().Contains(searchValue))
                                        || (m.RequiredQty != null && m.RequiredQty.ToLower().Contains(searchValue))
                                        || (m.SelectedAdditionalBatchNo != null && m.SelectedAdditionalBatchNo.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        || (m.MoveProjectDateText != null && m.MoveProjectDateText.ToString().ToLower().Contains(searchValue))
                                         || (m.EstimateCompleteDateText != null && m.EstimateCompleteDateText.ToString().ToLower().Contains(searchValue))
                                          || (m.AdminScientistStatus != null && m.AdminScientistStatus.ToLower().Contains(searchValue))
                                           || (m.ProjectStatustext != null && m.ProjectStatustext.ToLower().Contains(searchValue))
                                            || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                                        || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))).ToList();
                }

                //total number of rows count   
                recordsTotal = model.Count();
                //Paging   
                var data = model.Skip(skip).Take(pageSize).ToList();

                //var finalData = PrepareQuotationListModel(data);
                //Returning Json Data  
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                throw ex;
            }

        }

        [HttpPost]
        public ActionResult LoadProductExportData()
        {
            try
            {
                var extraSearch = Request.Form.GetValues("extra_search")[0].ToString();
                var instockother = Request.Form.GetValues("instockother")[0].ToString();
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                var fltactivity = Request.Form.GetValues("fltactivity")[0].ToString();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                var fltexportprostatusItem = Request.Form.GetValues("fltexportprostatusItem")[0].ToString();
                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;

                var searchby = string.Empty;
                var searchbyvalue = string.Empty;
                if (Request.Form.GetValues("radiobuton") != null)
                {
                    searchby = Request.Form.GetValues("radiobuton")[0].ToString();
                }
                if (Request.Form.GetValues("searchbox") != null)
                {
                    searchbyvalue = Request.Form.GetValues("searchbox")[0].ToString().Trim();
                }
                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
                string instocktype = Convert.ToString((int)EnumList.ProjectType.InStock);
                // Getting all Customer data  
                var list = (from i in db.SZ_Quotation
                            join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                            where t2.MoveToProject == true
                            && string.IsNullOrEmpty(t2.TrackingNo)
                            && (t2.IsOnHold == false || t2.IsOnHold == null)
                            && (t2.ProjectType != inhouseProjectType || t2.ProjectType == null)
                            && i.CountryTypeId == 2
                            && (t2.IsCancel == false || t2.IsCancel == null)
                            orderby t2.MoveProjectDate descending
                            select t2).Distinct();

                var splitfilters = instockother.Split(',');
                if (splitfilters[0] == "true")
                {
                    list = list.Where(x => x.ProjectType == instocktype).Distinct();
                }
                if (splitfilters[1] == "true")
                {
                    list = list.Where(x => (x.ProjectType != instocktype && x.ProjectType != inhouseProjectType) || x.ProjectType == null).Distinct();
                }
                list = list.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo);

                var subscilistItems = new List<SelectListItem>();
                var listItems = new List<SelectListItem>();
                MemoryCacheManager objCache = new MemoryCacheManager();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });

                var scienList = objCache.Get("cache.GetScientistId", () =>
                {
                    return db.GetScientistId().ToList();
                });

                var subscienList = objCache.Get("cache.subscienList", () =>
                {
                    return db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();
                });
                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                    subscilistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                });

                foreach (var term in subscienList)
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }

                    subscilistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });

                }

                var proIds = list.Select(x => x.ProductId).Distinct().ToList();

                var inventoryData = db.SZ_Inventory.Where(x => proIds.Contains(x.ProductId)).ToList();
                var productsData = db.Products.Where(x => proIds.Contains(x.Id) && x.Published == true && x.Deleted == false).ToList();
                var model = new List<ProjectListModel>();
                foreach (var k in list)
                {
                    ProjectListModel subList = new ProjectListModel();
                    subList.MSDS = "<a href='https://www.synzeal.com/Product/DownloadProductMSDS?id=" + k.ProductId + "' target='_blank' download>MSDS</a>";
                    subList.IsConversionReport = k.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    subList.ChkSaveRow = "<input type='checkbox' value='" + k.Id + "' class='clsSaverow' />";
                    subList.ReadyToDeliverScientistStatusId = db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                    if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == subList.ReadyToDeliverScientistStatusId && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                    {
                        subList.ChkFirstRow = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                    }
                    else if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == subList.ReadyToDeliverScientistStatusId)
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' />";
                    }
                    else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && k.MoveToDispatch == null)
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' />";
                    }
                    else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                    {
                        subList.ChkFirstRow = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                    }
                    if (k.IsDispatchApprove.HasValue && k.IsDispatchApprove.Value && (k.MoveToDispatch == null || k.MoveToDispatch == false))
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' style='outline: 4px solid #c00'/>";
                    }
                    subList.ProjectType = k.ProjectType;
                    subList.ProjectTypeText = "<select id='projecttype_" + k.Id + "' class='clsProjType' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ProjectType), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.ProjectType)
                        {
                            selected = "selected ";
                            subList.SelectedProjectType = text;
                        }
                        //if (text != "In-House")
                        //{
                            subList.ProjectTypeText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                        //}
                    }
                    subList.ProjectTypeText += "</select>";
                    subList.ActivityStatus = k.ActivityStatus;
                    subList.ActivityStatusText = "<select id='activitystatus_" + k.Id + "' class='clsActivityStatus' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";

                    //if (k.ActivityStatus == "Approval First")
                    //{
                    //    subList.ActivityStatusText += "<option value='Approval First' selected>Approval First</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Approval First'>Approval First</option>";
                    //}
                    ////if (k.ActivityStatus == "Data Sent")
                    ////{
                    ////    subList.ActivityStatusText += "<option value='Data Sent' selected>Data Sent</option>";
                    ////}
                    ////else
                    ////{
                    ////    subList.ActivityStatusText += "<option value='Data Sent'>Data Sent</option>";
                    ////}
                    ////if (k.ActivityStatus == "Data Correction")
                    ////{
                    ////    subList.ActivityStatusText += "<option value='Data Correction' selected>Data Correction</option>";
                    ////}
                    ////else
                    ////{
                    ////    subList.ActivityStatusText += "<option value='Data Correction'>Data Correction</option>";
                    ////}
                    ////if (k.ActivityStatus == "Data Approved")
                    ////{
                    ////    subList.ActivityStatusText += "<option value='Data Approved' selected>Data Approved</option>";
                    ////}
                    ////else
                    ////{
                    ////    subList.ActivityStatusText += "<option value='Data Approved'>Data Approved</option>";
                    ////}
                    //if (k.ActivityStatus == "Immediate Dispatch")
                    //{
                    //    subList.ActivityStatusText += "<option value='Immediate Dispatch' selected>Immediate Dispatch</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Immediate Dispatch'>Immediate Dispatch</option>";
                    //}

                    //if (k.ActivityStatus == "Short Qty Dispatch")
                    //{
                    //    subList.ActivityStatusText += "<option value='Short Qty Dispatch' selected>Short Qty Dispatch</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Short Qty Dispatch'>Short Qty Dispatch</option>";
                    //}
                    //if (k.ActivityStatus == "Repeat Order")
                    //{
                    //    subList.ActivityStatusText += "<option value='Repeat Order' selected>Repeat Order</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Repeat Order'>Repeat Order</option>";
                    //}
                    //if (k.ActivityStatus == "Data Approved")
                    //{
                    //    subList.ActivityStatusText += "<option value='Data Approved' selected>Data Approved</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Data Approved'>Data Approved</option>";
                    //}
                    //if (k.ActivityStatus == "Data Sent")
                    //{
                    //    subList.ActivityStatusText += "<option value='Data Sent' selected>Data Sent</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Data Sent'>Data Sent</option>";
                    //}
                    //if (k.ActivityStatus == "Data Correction")
                    //{
                    //    subList.ActivityStatusText += "<option value='Data Correction' selected>Data Correction</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Data Correction'>Data Correction</option>";
                    //}
                    //if (k.ActivityStatus == "Invoice Sent")
                    //{
                    //    subList.ActivityStatusText += "<option value='Invoice Sent' selected>Invoice Sent</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Invoice Sent'>Invoice Sent</option>";
                    //}
                    //if (k.ActivityStatus == "PDC Awaited")
                    //{
                    //    subList.ActivityStatusText += "<option value='PDC Awaited' selected>PDC Awaited</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='PDC Awaited'>PDC Awaited</option>";
                    //}
                    //if (k.ActivityStatus == "Advance Payment")
                    //{
                    //    subList.ActivityStatusText += "<option value='Advance Payment' selected>Advance Payment</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Advance Payment'>Advance Payment</option>";
                    //}
                    //if (k.ActivityStatus == "Payment Due")
                    //{
                    //    subList.ActivityStatusText += "<option value='Payment Due' selected>Payment Due</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Payment Due'>Payment Due</option>";
                    //}
                    //if (k.ActivityStatus == "Insufficient QTY")
                    //{
                    //    subList.ActivityStatusText += "<option value='Insufficient QTY' selected>Insufficient QTY</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Insufficient QTY'>Insufficient QTY</option>";
                    //}

                    if (k.ActivityStatus == "Approval First")
                    {
                        subList.ActivityStatusText += "<option value='Approval First' selected>Approval First</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Approval First'>Approval First</option>";
                    }
                    if (k.ActivityStatus == "Immediate Dispatch")
                    {
                        subList.ActivityStatusText += "<option value='Immediate Dispatch' selected>Immediate Dispatch</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Immediate Dispatch'>Immediate Dispatch</option>";
                    }

                    if (k.ActivityStatus == "Repeat Order")
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order' selected>Repeat Order</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order'>Repeat Order</option>";
                    }

                    if (k.ActivityStatus == "Repeat Order - Dispatch")
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Dispatch' selected>Repeat Order - Dispatch</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Dispatch'>Repeat Order - Dispatch</option>";
                    }
                    if (k.ActivityStatus == "Repeat Order - Approval First")
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Approval First' selected>Repeat Order - Approval First</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Approval First'>Repeat Order - Approval First</option>";
                    }
                    if (k.ActivityStatus == "Short Qty Dispatch")
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatch' selected>Short Qty Dispatch</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatch'>Short Qty Dispatch</option>";
                    }
                    if (k.ActivityStatus == "Short Qty Dispatched")
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatched' selected>Short Qty Dispatched</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatched'>Short Qty Dispatched</option>";
                    }
                    if (k.ActivityStatus == "Sample Request")
                    {
                        subList.ActivityStatusText += "<option value='Sample Request' selected>Sample Request</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Sample Request'>Sample Request</option>";
                    }
                    if (k.ActivityStatus == "Sample Sent")
                    {
                        subList.ActivityStatusText += "<option value='Sample Sent' selected>Sample Sent</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Sample Sent'>Sample Sent</option>";
                    }
                    if (k.ActivityStatus == "Sample Approved")
                    {
                        subList.ActivityStatusText += "<option value='Sample Approved' selected>Sample Approved</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Sample Approved'>Sample Approved</option>";
                    }
                    //if (k.ActivityStatus == "Insufficient QTY")
                    //{
                    //    subList.ActivityStatusText += "<option value='Insufficient QTY' selected>Insufficient QTY</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Insufficient QTY'>Insufficient QTY</option>";
                    //}
                    if (k.ActivityStatus == "Quote - Data Sent")
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Sent' selected>Quote - Data Sent</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Sent'>Quote - Data Sent</option>";
                    }
                    if (k.ActivityStatus == "Quote - Data Approved")
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Approved' selected>Quote - Data Approved</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Approved'>Quote - Data Approved</option>";
                    }
                    subList.ActivityStatusText += "</select>";
                    subList.ScientistName = "<select id='ScientistId_" + k.Id + "' class='scientist' scientistId='" + k.ScientistCustomerId + "' quotedetailsid='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (var r in listItems)
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.ScientistCustomerId))
                        {
                            selected = "selected ";
                            subList.SelectedScientistName = r.Text;
                        }
                        subList.ScientistName += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    }
                    subList.ScientistName += "</select>";
                    subList.ProStatus = k.ProStatus;
                    subList.MoveProjectDateText = k.MoveProjectDate.HasValue ? k.MoveProjectDate.Value.ToString("dd/MM/yyyy hh:mm tt") : "";
                    subList.AdditionalBatchNo = k.AdditionalBatchNo;
                    subList.QuoteId = k.SZ_Quotation.Id;
                    subList.ProductId = k.ProductId;
                    subList.ProductName = k.ProductName;
                    subList.TechnicalEmail = k.TechnicalEmail;
                    subList.IsPaymentPending = k.SZ_Quotation.SZ_CompanyList.IsPaymentPending;
                    subList.ScientistRemark = "<input id='sciremark_" + k.Id + "' type='text' value='" + k.ScientistRemark + "' style='width: 170px' />";
                    subList.RequiredQtyTxt = "<input id='qty_" + k.Id + "' type='text' value='" + k.RequiredQty + "' style='width: 50px' />";
                    subList.AdditionalBatchNoText = "<select id='additionalBatch_" + k.Id + "' data-quotationdetailsid='" + k.Id + "' class='ddladditionalbatch'><option value=''>--Select--</option>";
                    if (subList.ProductId.HasValue)
                    {
                        var proData = productsData.Where(x => x.Id == subList.ProductId && x.Published == true && x.Deleted == false).Count();
                        var productData = productsData.Where(x => x.Id == subList.ProductId && x.Published == true && x.Deleted == false).FirstOrDefault();
                        if (productData != null)
                        {
                            subList.IsControlledSubstance = productData.IsControlledSubstance;
                            if (!subList.IsControlledSubstance.HasValue
                                || subList.IsControlledSubstance == false)
                            {
                                subList.IsControlledSubstance = productData.IsManuallyControlledSubstance;
                            }
                        }
                        var proBatchData = inventoryData.Where(x => x.ProductId == subList.ProductId).ToList();
                        if (proBatchData.Count > 0 && proData > 0)
                        {
                            foreach (var r in proBatchData)
                            {
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }
                                string selected = string.Empty;
                                if (r.Id == subList.AdditionalBatchNo)
                                {
                                    selected = "selected ";
                                    subList.BatchNo = r.BatchNo;
                                    subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
                                }

                                subList.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' " + selected + ">" + text + "</option>";
                            }
                        }
                    }
                    subList.AdditionalBatchNoText += "</select>";
                    //subList.BatchNo = k.BatchNo;
                    subList.BatchNoText = "<input id='batchno_" + k.Id + "' type='text' value='" + k.BatchNo + "' style='width:120px' />";
                    subList.IsImageAttach = k.SZ_Quotation.IsImageAttach;
                    subList.CompanyName = k.SZ_Quotation.SZ_CompanyList.Name;
                    subList.Email = k.SZ_Quotation.EmailAddress;
                    subList.PONumber = k.SZ_Quotation.PONo;
                    subList.Ref = k.SZ_Quotation.Ref;
                    subList.Remark = k.SZ_Quotation.Remark;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.QuoteDetailsId = k.Id;
                    subList.CASNo = k.CASNo;
                    subList.IsConversionReport = k.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    var impstr = "";
                    if (subList.IsConversionReport.HasValue && subList.IsConversionReport.Value)
                    {
                        impstr += "<img src='/img/important.jpg' width='15px' height='15px' />";
                    }
                    subList.CATNo = "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>" + impstr + " " + CommonOperation.GetMatchingTagHTML(k, "Project");
                    subList.CreatedDate = k.CreatedDate;
                    subList.ImagePath = k.ImagePath;
                    subList.IsUploadServer = k.IsUploadServer;
                    subList.LeadTime = k.LeadTime;
                    subList.Price = k.Price;

                    subList.QuoteId = k.QuoteId;
                    subList.ProjectType = k.ProjectType;
                    subList.ScientistCustomerId = k.ScientistCustomerId;

                    subList.RequiredQty = k.RequiredQty;
                    subList.ProjectStatus = k.ProjectStatus;
                    subList.IsOnHold = k.IsOnHold;
                    if (k.ProjectStatus != null)
                    {
                        subList.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
                    }
                    subList.ScientistStatus = k.ScientistStatus;
                    subList.BatchCode1 = k.BatchCode1;
                    subList.BatchCode2 = k.BatchCode2;
                    subList.Qty1 = k.Qty1;
                    subList.Qty2 = k.Qty2;
                    subList.EstimateCompleteDate = k.EstimateCompleteDate;
                    if (k.EstimateCompleteDate.HasValue)
                    {
                        // subList.EstimateCompleteDateText = k.EstimateCompleteDate.Value.ToShortDateString();
                        subList.EstimateCompleteDateText = k.EstimateCompleteDate.Value.ToShortDateString();
                    }
                    //if (k.AdditionalBatchNo.HasValue)
                    //{
                    //    subList.AdditionalBatchNoText = db.SZ_Inventory.Where(x => x.Id == k.AdditionalBatchNo).Select(x => x.BatchNo).FirstOrDefault();
                    //}
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToProject = k.MoveToProject;
                    subList.Remark = k.Remark;
                    subList.SrPo = k.SrPo;
                    subList.AdminScientistStatus = k.AdminScientistStatus;
                    subList.InvoiceNo = k.InvoiceNo;
                    subList.InvoiceRemark = k.InvoiceRemark;

                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.PaymentTerms = k.SZ_Quotation.PaymentTerm;
                    subList.ScientistStatustext = "<input id='scientistStatus_" + k.Id + "' type='text' value='" + k.AdminScientistStatus + "' title='" + k.AdminScientistStatus + "'  style='width:200px' />";
                    subList.RemarkText = "<input id='remark_" + k.Id + "' type='text' value='" + k.Remark + "' title='" + k.Remark + "' style='width: 170px' />";
                    subList.LastRowText = "<a href='javascript: void(0)' id='save_" + k.Id + "' onclick='SaveProjectDetailsexport(\"" + k.Id + "\")'> Save</a> ";
                    subList.LastRowText += "<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";
                    subList.SubScientistName = "<select id='SubScientistId_" + k.Id + "' class='subscientist' subscientistId='" + k.SubScientistName + "' quotedetailsid='" + k.Id + "'><option value=''>--Select--</option>";
                    subscilistItems.ForEach(r =>
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.SubScientistName))
                        {
                            selected = "selected ";
                            subList.SelectedSubScientistName = r.Text;
                        }
                        subList.SubScientistName += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    });


                    subList.SubScientistName += "</select>";
                    subList.DispatchedStatus = k.DispatchedStatus;
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToInvoice = k.MoveToInvoice;
                    subList.IsDispatchApprove = k.IsDispatchApprove;
                    if (k.SZ_Quotation.IsPayment.HasValue && k.SZ_Quotation.IsPayment.Value)
                    {
                        subList.IsPaymentText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPayment' checked='checked'/>";
                    }
                    else
                    {
                        subList.IsPaymentText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPayment' />";
                    }

                    subList.ReportInvoiceDateText = "<input id='reportinvoiceDate_" + k.Id + "' data-value='" + k.ReportInvoiceDate + "' type='text' class='datepicker'  style='width:80px' />";
                    if (k.ReportInvoiceDate.HasValue)
                    {
                        //   subList.ReportInvoiceDateText = k.ReportInvoiceDate.Value.ToShortDateString();
                        subList.ReportInvoiceDate = k.ReportInvoiceDate.Value;
                    }
                    subList.ReasonText = "<input id='reason_" + k.Id + "' type='text' value='" + k.Reason + "' title='" + k.Reason + "'  style='width:200px' />";
                    subList.CountryType = k.SZ_Quotation.CountryType;

                    subList.OrderRemark = k.OrderRemark;
                    subList.OrderRemarkText = "<input id='orderremark_" + k.Id + "' type='text' value='" + k.OrderRemark + "' title='" + k.OrderRemark + "'  style='width:200px' />";
                    subList.COARefNumber = k.COARefNumber;
                    if (!string.IsNullOrEmpty(k.SZ_Quotation.Attachment))
                    {
                        subList.Attachment = "<a href = 'javascript:void(0)' onclick='attachment(" + k.QuoteId + ")'><i class='fa fa-paperclip'></i></a>";
                    }
                    subList.OtherProStatusText = "<select id='otherprostatus_" + k.Id + "' class='clsotherprostatus' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.ProInstockexportStatusDDL r in Enum.GetValues(typeof(EnumList.ProInstockexportStatusDDL)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ProInstockexportStatusDDL), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ProInstockexportStatusDDL)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.OtherProStatus)
                        {
                            selected = "selected ";
                            subList.SelectedOtherProStatus = text;
                        }
                        subList.OtherProStatusText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                    }
                    subList.OtherProStatusText += "</select>";
                    model.Add(subList);
                }

                model = model.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).ThenBy(x => x.SrPo).ToList();
                if (!string.IsNullOrEmpty(fltactivity))
                {
                    model = model.Where(x => x.ActivityStatus == fltactivity).ToList();
                }
                if (!string.IsNullOrEmpty(fltexportprostatusItem))
                {
                    model = model.Where(x => x.ProStatus == fltexportprostatusItem).ToList();
                }
                if (!string.IsNullOrEmpty(searchby) && !string.IsNullOrEmpty(searchbyvalue))
                {
                    searchbyvalue = searchbyvalue.ToLower();
                    if (searchby == "quoteid")
                    {
                        model = model.Where(x => x.Ref.ToLower().Contains(searchbyvalue)).ToList();
                    }
                    if (searchby == "ponumber")
                    {
                        model = model.Where(x => x.PONumber.ToLower().Contains(searchbyvalue)).ToList();
                    }
                    if (searchby == "company")
                    {
                        model = model.Where(x => x.CompanyName.ToLower().Contains(searchbyvalue)).ToList();
                    }
                    if (searchby == "productname")
                    {
                        model = model.Where(x => x.ProductName.ToLower().Contains(searchbyvalue)).ToList();
                    }
                    if (searchby == "cas")
                    {
                        model = model.Where(x => x.CASNo != null ? x.CASNo.ToLower().Contains(searchbyvalue) : false).ToList();
                    }
                    if (searchby == "cat")
                    {
                        model = model.Where(x => x.CATNo != null ? x.CATNo.ToLower().Contains(searchbyvalue) : false).ToList();
                    }
                    if (searchby == "batchno")
                    {
                        model = model.Where(x => x.BatchNo != null ? x.BatchNo.ToLower().Contains(searchbyvalue) : false).ToList();
                    }

                }
                //Search
                if (!string.IsNullOrEmpty(extraSearch))
                {
                    extraSearch = extraSearch.ToLower().Trim();
                    if (extraSearch == "all" || extraSearch == "eurofarma" || extraSearch == "brainfarma" || extraSearch == "other")
                    {
                        if (extraSearch == "eurofarma" || extraSearch == "brainfarma")
                        {
                            model = model.Where(m => m.CompanyName != null && m.CompanyName.ToLower().Contains(extraSearch)).ToList();
                        }
                        else if (extraSearch == "other")
                        {
                            model = model.Where(m => m.CompanyName != null && !m.CompanyName.ToLower().Contains("eurofarma") && !m.CompanyName.ToLower().Contains("brainfarma")).ToList();
                        }
                        else
                        {

                        }
                    }
                    if (!string.IsNullOrEmpty(searchValue))
                    {
                        model = model.Where(m => (m.SelectedScientistName != null && m.SelectedScientistName.ToLower().Contains(searchValue))
                        || (m.SelectedSubScientistName != null && m.SelectedSubScientistName.ToLower().Contains(searchValue))
                                            || (m.CompanyName != null && m.CompanyName.ToLower().Contains(searchValue))
                                            || (m.PONumber != null && m.PONumber.ToLower().Contains(searchValue))
                                            || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                            || (m.Price != null && m.Price.ToLower().Contains(searchValue))
                                            || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                            || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                            || (m.SelectedProjectType != null && m.SelectedProjectType.ToLower().Contains(searchValue))
                                            || (m.RequiredQty != null && m.RequiredQty.ToLower().Contains(searchValue))
                                            || (m.SelectedAdditionalBatchNo != null && m.SelectedAdditionalBatchNo.ToLower().Contains(searchValue))
                                            || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                            || (m.MoveProjectDateText != null && m.MoveProjectDateText.ToString().ToLower().Contains(searchValue))
                                            || (m.EstimateCompleteDateText != null && m.EstimateCompleteDateText.ToString().ToLower().Contains(searchValue))
                                            || (m.AdminScientistStatus != null && m.AdminScientistStatus.ToLower().Contains(searchValue))
                                            || (m.ProjectStatustext != null && m.ProjectStatustext.ToLower().Contains(searchValue))
                                            || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                                            || (m.ActivityStatus != null && m.ActivityStatus.ToLower().Contains(searchValue))
                                            || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))).ToList();
                    }
                }

                //total number of rows count   
                recordsTotal = model.Count();
                //Paging   
                var data = model.Skip(skip).Take(pageSize).ToList();

                //var finalData = PrepareQuotationListModel(data);
                //Returning Json Data  
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        public ActionResult Resolvequery(int id)
        {
            var data = _operationRepository.GetQuoteDetailByID(id);
            if (data != null)
            {
                data.IsQueryResolved = true;
                data.QueryResolvedDate = DateTime.Now;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();

                SZ_Log objLog = new SZ_Log();
                objLog.Id = Guid.NewGuid();
                objLog.Action = "Resolve Query";
                objLog.CreatedDate = DateTime.Now;
                objLog.Message = "Resolved query by " + SessionCookieManagement.UserEmail + " / Quote ref# " + data.SZ_Quotation.Ref + " / Quote Details Id " + data.Id;
                objLog.UserId = SessionCookieManagement.UserId;
                db.SZ_Log.Add(objLog);
                db.SaveChanges();
            }

            return Json("success", JsonRequestBehavior.AllowGet);
        }

        public ActionResult Resumequery(int id)
        {
            var data = _operationRepository.GetQuoteDetailByID(id);
            if (data != null)
            {
                data.IsQueryResolved = false;
                data.QueryResolvedDate = null;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();

                SZ_Log objLog = new SZ_Log();
                objLog.Id = Guid.NewGuid();
                objLog.Action = "Resume Query";
                objLog.CreatedDate = DateTime.Now;
                objLog.Message = "Resume Query by " + SessionCookieManagement.UserEmail + " / Quote ref# " + data.SZ_Quotation.Ref + " / Quote Details Id " + data.Id;
                objLog.UserId = SessionCookieManagement.UserId;
                db.SZ_Log.Add(objLog);
                db.SaveChanges();
            }
            return Json("success", JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public ActionResult LoadProductQueryData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();

                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;

                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);

                // Getting all Customer data  
                var list = (from i in db.SZ_Quotation
                            join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                            where !string.IsNullOrEmpty(t2.QueryText)
                            orderby t2.QueryDate descending
                            select t2).Distinct();

                list = list.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo);

                var listItems = new List<SelectListItem>();
                MemoryCacheManager objCache = new MemoryCacheManager();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });

                var scienList = objCache.Get("cache.GetScientistId", () =>
                {
                    return db.GetScientistId().ToList();
                });

                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                });

                var proIds = list.Select(x => x.ProductId).Distinct().ToList();

                var inventoryData = db.SZ_Inventory.Where(x => proIds.Contains(x.ProductId)).ToList();

                var productsdata = db.Products.Where(x => proIds.Contains(x.Id) && x.Published == true && x.Deleted == false).ToList();
                var model = new List<ProjectListModel>();
                foreach (var k in list)
                {
                    ProjectListModel subList = new ProjectListModel();
                    subList.ChkSaveRow = "<i class='fa fa-pencil' onclick='queryGenerate(" + k.Id + ")'></i>";
                    if (k.IsQueryResolved.HasValue && k.IsQueryResolved.Value)
                    {
                        subList.ResolvedQueryText = "<b><a style='color:#000' href='javascript:void(0)' onclick='Resumequery(" + k.Id + ")'>Resume</a></b>";
                    }
                    else
                    {
                        subList.ResolvedQueryText = "<b><a href='javascript:void(0)' onclick='Resolvequery(" + k.Id + ")'>Resolve</a></b>";
                    }

                    subList.ReadyToDeliverScientistStatusId = db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                    if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == subList.ReadyToDeliverScientistStatusId && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                    {
                        subList.ChkFirstRow = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                    }
                    else if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == subList.ReadyToDeliverScientistStatusId)
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' />";
                    }
                    else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && k.MoveToDispatch == null)
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' />";
                    }
                    else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                    {
                        subList.ChkFirstRow = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                    }
                    subList.ProjectType = k.ProjectType;

                    subList.ProjectTypeText = "<select id='projecttype_" + k.Id + "' class='clsProjType' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ProjectType), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.ProjectType)
                        {
                            selected = "selected ";
                            subList.SelectedProjectType = text;
                        }
                        //if (text != "In-House")
                        //{
                            subList.ProjectTypeText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                        //}
                    }
                    subList.ProjectTypeText += "</select>";
                    subList.ScientistName = "<select id='ScientistId_" + k.Id + "' class='scientist' scientistId='" + k.ScientistCustomerId + "' quotedetailsid='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (var r in listItems)
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.ScientistCustomerId))
                        {
                            selected = "selected ";
                            subList.SelectedScientistName = r.Text;
                        }
                        subList.ScientistName += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    }
                    subList.ScientistName += "</select>";
                    subList.MoveProjectDateText = k.MoveProjectDate.HasValue ? k.MoveProjectDate.Value.ToString("dd/MM/yyyy hh:mm tt") : "";
                    subList.AdditionalBatchNo = k.AdditionalBatchNo;
                    subList.QuoteId = k.SZ_Quotation.Id;
                    subList.ProductId = k.ProductId;
                    subList.ProductName = k.ProductName;
                    subList.ScientistRemark = "<input id='sciremark_" + k.Id + "' type='text' value='" + k.ScientistRemark + "' style='width: 170px' />";
                    subList.RequiredQtyTxt = "<input id='qty_" + k.Id + "' type='text' value='" + k.RequiredQty + "' style='width: 50px' />";
                    subList.AdditionalBatchNoText = "<select id='additionalBatch_" + k.Id + "'><option value=''>--Select--</option>";
                    if (subList.ProductId.HasValue)
                    {
                        var proData = productsdata.Where(x => x.Id == subList.ProductId && x.Published == true && x.Deleted == false).Count();
                        var proBatchData = inventoryData.Where(x => x.ProductId == subList.ProductId).ToList();
                        if (proBatchData.Count > 0 && proData > 0)
                        {
                            foreach (var r in proBatchData)
                            {
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }
                                string selected = string.Empty;
                                if (r.Id == subList.AdditionalBatchNo)
                                {
                                    selected = "selected ";
                                    subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
                                }

                                subList.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' " + selected + ">" + text + "</option>";
                            }
                        }
                    }
                    subList.AdditionalBatchNoText += "</select>";
                    //subList.BatchNo = k.BatchNo;
                    subList.BatchNoText = "<input id='batchno_" + k.Id + "' type='text' value='" + k.BatchNo + "' style='width:120px' />";
                    subList.IsImageAttach = k.SZ_Quotation.IsImageAttach;
                    subList.CompanyName = k.SZ_Quotation.SZ_CompanyList.Name;
                    subList.Email = k.SZ_Quotation.EmailAddress;
                    subList.PONumber = k.SZ_Quotation.PONo;
                    subList.Ref = k.SZ_Quotation.Ref;
                    subList.Remark = k.SZ_Quotation.Remark;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.QuoteDetailsId = k.Id;
                    subList.CASNo = k.CASNo;
                    subList.CATNo = k.CATNo;
                    subList.CreatedDate = k.CreatedDate;
                    subList.ImagePath = k.ImagePath;
                    subList.IsUploadServer = k.IsUploadServer;
                    subList.LeadTime = k.LeadTime;
                    subList.Price = k.Price;

                    subList.QuoteId = k.QuoteId;
                    subList.ProjectType = k.ProjectType;
                    subList.ScientistCustomerId = k.ScientistCustomerId;

                    subList.RequiredQty = k.RequiredQty;
                    subList.ProjectStatus = k.ProjectStatus;
                    subList.IsOnHold = k.IsOnHold;
                    if (k.ProjectStatus != null)
                    {
                        subList.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
                    }
                    subList.ScientistStatus = k.ScientistStatus;
                    subList.BatchCode1 = k.BatchCode1;
                    subList.BatchCode2 = k.BatchCode2;
                    subList.Qty1 = k.Qty1;
                    subList.Qty2 = k.Qty2;
                    subList.EstimateCompleteDate = k.EstimateCompleteDate;
                    if (k.EstimateCompleteDate.HasValue)
                    {
                        // subList.EstimateCompleteDateText = k.EstimateCompleteDate.Value.ToShortDateString();
                        subList.EstimateCompleteDateText = k.EstimateCompleteDate.Value.ToShortDateString();
                    }
                    //if (k.AdditionalBatchNo.HasValue)
                    //{
                    //    subList.AdditionalBatchNoText = db.SZ_Inventory.Where(x => x.Id == k.AdditionalBatchNo).Select(x => x.BatchNo).FirstOrDefault();
                    //}
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToProject = k.MoveToProject;
                    subList.Remark = k.Remark;
                    subList.SrPo = k.SrPo;
                    subList.AdminScientistStatus = k.AdminScientistStatus;
                    subList.InvoiceNo = k.InvoiceNo;
                    subList.InvoiceRemark = k.InvoiceRemark;

                    subList.MoveProjectDate = k.MoveProjectDate;

                    subList.ScientistStatustext = "<input id='scientistStatus_" + k.Id + "' type='text' value='" + k.AdminScientistStatus + "' title='" + k.AdminScientistStatus + "'  style='width:200px' />";
                    subList.RemarkText = "<input id='remark_" + k.Id + "' type='text' value='" + k.Remark + "' title='" + k.Remark + "' style='width: 170px' />";
                    subList.LastRowText = "<a href='javascript: void(0)' id='save_" + k.Id + "' onclick='SaveProjectDetailsexport(\"" + k.Id + "\")'> Save</a> ";
                    subList.LastRowText += "<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";
                    subList.SubScientistName = k.SubScientistName;
                    subList.DispatchedStatus = k.DispatchedStatus;
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToInvoice = k.MoveToInvoice;
                    subList.IsDispatchApprove = k.IsDispatchApprove;
                    if (k.SZ_Quotation.IsPayment.HasValue && k.SZ_Quotation.IsPayment.Value)
                    {
                        subList.IsPaymentText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPayment' checked='checked'/>";
                    }
                    else
                    {
                        subList.IsPaymentText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPayment' />";
                    }
                    subList.IsAssignProjectQuery = k.IsAssignProjectQuery;
                    subList.IsAssignScientistQuery = k.IsAssignScientistQuery;
                    subList.QueryDate = k.QueryDate;
                    subList.IsQueryResolved = k.IsQueryResolved;
                    model.Add(subList);
                }
                //Sorting  
                //if (!string.IsNullOrEmpty(sortColumn) && !string.IsNullOrEmpty(sortColumnDir))
                //{
                //    model = model.OrderBy(sortColumn + " " + sortColumnDir).ToList();
                //}
                //else
                //{
                model = model.OrderByDescending(x => x.QueryDate).ThenBy(x => x.SrPo).ThenBy(x => x.SrPo).ToList();
                // model = model.OrderBy(x => x.SrPo).ThenByDescending(x=>x.MoveProjectDate).ToList();
                //}

                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.SelectedScientistName != null && m.SelectedScientistName.ToLower().Contains(searchValue))
                                        || (m.CompanyName != null && m.CompanyName.ToLower().Contains(searchValue))
                                        || (m.PONumber != null && m.PONumber.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.Price != null && m.Price.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.SelectedProjectType != null && m.SelectedProjectType.ToLower().Contains(searchValue))
                                        || (m.RequiredQty != null && m.RequiredQty.ToLower().Contains(searchValue))
                                        || (m.SelectedAdditionalBatchNo != null && m.SelectedAdditionalBatchNo.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        || (m.MoveProjectDateText != null && m.MoveProjectDateText.ToString().ToLower().Contains(searchValue))
                                         || (m.EstimateCompleteDateText != null && m.EstimateCompleteDateText.ToString().ToLower().Contains(searchValue))
                                          || (m.AdminScientistStatus != null && m.AdminScientistStatus.ToLower().Contains(searchValue))
                                           || (m.ProjectStatustext != null && m.ProjectStatustext.ToLower().Contains(searchValue))
                                            || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                                        || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))).ToList();
                }

                //total number of rows count   
                recordsTotal = model.Count();
                //Paging   
                var data = model.Skip(skip).Take(pageSize).ToList();

                //var finalData = PrepareQuotationListModel(data);
                //Returning Json Data  
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                throw ex;
            }

        }


        [HttpPost]
        public ActionResult LoadAllClientAdmindata(int id, bool isClientSection = false)
        {
            try
            {
                string companyName = db.SZ_CompanyList.Where(x => x.Id == id).Select(x => x.Name).FirstOrDefault();

                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();

                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;

                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);

                // Getting all Customer data  
                var list = (from i in db.SZ_Quotation
                            join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                            where t2.MoveToProject == true && string.IsNullOrEmpty(t2.TrackingNo) && (t2.IsOnHold == false || t2.IsOnHold == null)
                            && (t2.ProjectType != inhouseProjectType || t2.ProjectType == null)
                             //&& i.CompanyName.ToLower() == companyName.ToLower()
                             && i.CompanyId == id
                            orderby t2.MoveProjectDate descending
                            select t2).Distinct();

                list = list.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo);

                var listItems = new List<SelectListItem>();
                MemoryCacheManager objCache = new MemoryCacheManager();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });

                var scienList = objCache.Get("cache.GetScientistId", () =>
                {
                    return db.GetScientistId().ToList();
                });

                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                });


                var model = new List<ProjectListModel>();
                foreach (var k in list)
                {
                    ProjectListModel subList = new ProjectListModel();
                    //  subList.ChkSaveRow = "<a href='javascript:void(0)' onclick='SaveInformation(\"" + k.Id + "\")'> Save </a>";

                    subList.ChkSaveRow = "<input type='checkbox' value='" + k.Id + "' class='svcheck'>";
                    subList.ReadyToDeliverScientistStatusId = db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();

                    subList.ProjectType = k.ProjectType;

                    foreach (var r in listItems)
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.ScientistCustomerId))
                        {
                            subList.SelectedScientistName = r.Text;
                        }
                    }
                    subList.MoveProjectDateText = k.MoveProjectDate.HasValue ? k.MoveProjectDate.Value.ToString("dd/MM/yyyy hh:mm tt") : "";

                    subList.AdditionalBatchNo = k.AdditionalBatchNo;
                    subList.QuoteId = k.SZ_Quotation.Id;
                    subList.ProductId = k.ProductId;
                    subList.ProductName = k.ProductName;
                    if (subList.ProductId.HasValue)
                    {
                        var proData = db.Products.Where(x => x.Id == subList.ProductId && x.Published == true && x.Deleted == false).Count();
                        var proBatchData = db.SZ_Inventory.Where(x => x.ProductId == subList.ProductId).ToList();
                        if (proBatchData.Count > 0 && proData > 0)
                        {
                            foreach (var r in proBatchData)
                            {
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }
                                string selected = string.Empty;
                                if (r.Id == subList.AdditionalBatchNo)
                                {
                                    subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
                                    subList.BatchNo = r.BatchNo;
                                }
                            }
                        }
                    }
                    subList.RequiredQtyTxt = k.RequiredQty;

                    subList.IsImageAttach = k.SZ_Quotation.IsImageAttach;
                    subList.CompanyName = k.SZ_Quotation.SZ_CompanyList.Name;
                    subList.Email = k.SZ_Quotation.EmailAddress;
                    subList.PONumber = k.SZ_Quotation.PONo;
                    subList.Ref = k.SZ_Quotation.Ref;
                    subList.Remark = k.SZ_Quotation.Remark;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.QuoteDetailsId = k.Id;
                    subList.CASNo = k.CASNo;
                    subList.CATNo = k.CATNo;
                    subList.CreatedDate = k.CreatedDate;
                    subList.ImagePath = k.ImagePath;
                    subList.IsUploadServer = k.IsUploadServer;
                    subList.LeadTime = k.LeadTime;
                    subList.Price = k.Price;

                    subList.QuoteId = k.QuoteId;
                    subList.ProjectType = k.ProjectType;
                    subList.ScientistCustomerId = k.ScientistCustomerId;

                    subList.RequiredQty = k.RequiredQty;
                    subList.ProjectStatus = k.ProjectStatus;
                    subList.IsOnHold = k.IsOnHold;
                    if (k.ProjectStatus != null)
                    {
                        subList.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
                    }
                    subList.ScientistStatus = k.ScientistStatus;
                    subList.BatchCode1 = k.BatchCode1;
                    subList.BatchCode2 = k.BatchCode2;
                    subList.Qty1 = k.Qty1;
                    subList.Qty2 = k.Qty2;
                    subList.EstimateCompleteDate = k.EstimateCompleteDate;
                    if (k.EstimateCompleteDate.HasValue)
                    {
                        subList.EstimateCompleteDateText = k.EstimateCompleteDate.Value.AddDays(10).ToShortDateString();
                    }
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToProject = k.MoveToProject;
                    subList.Remark = k.Remark;
                    subList.SrPo = k.SrPo;
                    subList.AdminScientistStatus = k.AdminScientistStatus;
                    subList.LastStatus = k.LastStatus;
                    subList.InvoiceNo = k.InvoiceNo;
                    subList.InvoiceRemark = k.InvoiceRemark;

                    subList.MoveProjectDate = k.MoveProjectDate;

                    if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock))
                    {
                        k.AdminScientistStatus = "Synthesis is completed and analytical recording in progress.";
                    }
                    if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.Purchase))
                    {
                        k.AdminScientistStatus = "We will deliver product as per quoted time-line.";
                    }
                    subList.ClientStatus = k.ClientStatus;
                    subList.LastStatusText = "<input id='lastStatus_" + k.Id + "' type='text' value='" + k.LastStatus + "' title='" + k.LastStatus + "' style='width:200px' />";

                    subList.ClientStatusText = "<select id='clientstatus_" + k.Id + "' class='clsClientStatus' data-quoteDetailsId='" + k.Id + "'>";
                    if (k.ClientStatus == "In Progress")
                    {
                        subList.ClientStatusText += "<option value='In Progress' selected>In Progress</option>";


                    }
                    else
                    {
                        subList.ClientStatusText += "<option value='In Progress'>In Progress</option>";
                    }

                    if (k.ClientStatus == "COA/Data Sent")
                    {
                        k.AdminScientistStatus = "COA/Data Sent";
                        subList.ClientStatusText += "<option value='COA/Data Sent' selected>COA/Data Sent</option>";

                        //set est date blank
                        subList.EstimateCompleteDateText = string.Empty;
                    }
                    else
                    {
                        subList.ClientStatusText += "<option value='COA/Data Sent' disabled>COA/Data Sent</option>";
                    }

                    if (k.ClientStatus == "COA/Data Approved")
                    {
                        k.AdminScientistStatus = "COA/Data Approved";
                        subList.ClientStatusText += "<option value='COA/Data Approved' selected>COA/Data Approved</option>";

                        //set est date blank
                        subList.EstimateCompleteDateText = string.Empty;
                    }
                    else
                    {
                        subList.ClientStatusText += "<option value='COA/Data Approved'>COA/Data Approved</option>";
                    }

                    if (k.ClientStatus == "COA/Data Correction")
                    {
                        k.AdminScientistStatus = "COA/Data Correction";
                        subList.ClientStatusText += "<option value='COA/Data Correction' selected>COA/Data Correction</option>";
                        //set est date blank
                        subList.EstimateCompleteDateText = string.Empty;
                    }
                    else
                    {
                        subList.ClientStatusText += "<option value='COA/Data Correction'>COA/Data Correction</option>";
                    }

                    //if (k.ClientStatus == "Dispatched")
                    //{
                    //    subList.ClientStatusText += "<option value='Dispatched' selected>Dispatched</option>";
                    //}
                    //else
                    //{
                    //    subList.ClientStatusText += "<option value='Dispatched'>Dispatched</option>";
                    //}
                    subList.ClientStatusText += "</select>";

                    if (!string.IsNullOrEmpty(k.COAPath))
                    {
                        subList.COADownloadLink = "<a href='" + k.COAPath.Replace("..", "") + "' download='COA-" + subList.BatchNo + "'><i class='fa fa-download'></i></a>";
                    }
                    if (!string.IsNullOrEmpty(k.AnalyticalData))
                    {
                        subList.AnalyticalDataLink = "<a href='" + k.AnalyticalData.Replace("..", "") + "' download='AnalyticalData-" + subList.BatchNo + "'><i class='fa fa-download'></i></a>";
                    }
                    subList.AttachedDataList = k.AttachedDataList;

                    subList.ScientistStatustext = "<input id='scientistStatus_" + k.Id + "' type='text' value='" + k.AdminScientistStatus + "' title='" + k.AdminScientistStatus + "' style='width:200px' />";
                    //  subList.ClientRemarkText = "<input id='clientremark_" + k.Id + "' type='text' value='" + k.ClientRemark + "' title='" + k.ClientRemark + "'  style='width:200px' />";

                    subList.ClientRemarkText = "<i class='fa fa-pencil' onclick='Editclientremarks(" + k.Id + ")'></i>";
                    if (isClientSection)
                    {
                        subList.ClientRemarkText = "<a data-toggle='modal' data-target='#clientremarkModal' href='/Form/AddClientRemark/" + k.Id + "?isClientSection=true'><i class='fa fa-pencil'></i></a>";
                    }
                    else
                    {
                        subList.ClientRemarkText = "<a data-toggle='modal' data-target='#clientremarkModal' href='/Form/AddClientRemark/" + k.Id + "?isClientSection=false'><i class='fa fa-pencil'></i></a>";
                    }


                    subList.ClientAddressText = "<input id='clientaddress_" + k.Id + "' type='text' value='" + k.ClientAddress + "' title='" + k.ClientAddress + "' style='width:200px' />";
                    subList.ClientRemark = k.ClientRemark;
                    subList.ClientAddress = k.ClientAddress;
                    if (k.LastUploadDate.HasValue)
                    {
                        subList.LastUploadDateStr = k.LastUploadDate.Value.ToShortDateString();
                    }


                    if (string.IsNullOrEmpty(subList.ClientStatus))
                    {
                        subList.ClientStatus = "In Progress";
                    }

                    model.Add(subList);
                }
                model = model.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).ThenBy(x => x.SrPo).ToList();
                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    if (searchValue == "In Progress" || searchValue == "COA/Data Sent" || searchValue == "COA/Data Approved" || searchValue == "COA/Data Correction")
                    {
                        searchValue = searchValue.ToLower().Trim();
                        model = model.Where(m => (m.ClientStatus != null && m.ClientStatus.ToLower().Contains(searchValue))).ToList();
                    }
                    else
                    {
                        searchValue = searchValue.ToLower().Trim();
                        model = model.Where(m => (m.SelectedScientistName != null && m.SelectedScientistName.ToLower().Contains(searchValue))
                                            || (m.CompanyName != null && m.CompanyName.ToLower().Contains(searchValue))
                                            || (m.PONumber != null && m.PONumber.ToLower().Contains(searchValue))
                                            || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                            || (m.Price != null && m.Price.ToLower().Contains(searchValue))
                                            || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                            || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                            || (m.SelectedProjectType != null && m.SelectedProjectType.ToLower().Contains(searchValue))
                                            || (m.RequiredQty != null && m.RequiredQty.ToLower().Contains(searchValue))
                                            || (m.SelectedAdditionalBatchNo != null && m.SelectedAdditionalBatchNo.ToLower().Contains(searchValue))
                                            || (m.ClientRemark != null && m.ClientRemark.ToLower().Contains(searchValue))
                                            | (m.ClientStatus != null && m.ClientStatus.ToLower().Contains(searchValue))
                                            || (m.MoveProjectDateText != null && m.MoveProjectDateText.ToString().ToLower().Contains(searchValue))
                                             || (m.EstimateCompleteDateText != null && m.EstimateCompleteDateText.ToString().ToLower().Contains(searchValue))
                                              || (m.AdminScientistStatus != null && m.AdminScientistStatus.ToLower().Contains(searchValue))
                                               || (m.ProjectStatustext != null && m.ProjectStatustext.ToLower().Contains(searchValue))
                                                || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                                            || (m.ClientAddress != null && m.ClientAddress.ToLower().Contains(searchValue))).ToList();
                    }
                }

                //total number of rows count   
                recordsTotal = model.Count();
                //Paging   
                var data = model.Skip(skip).Take(pageSize).ToList();
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                throw ex;
            }

        }

        [HttpPost]
        public ActionResult LoadClientOnHoldData(int id, bool isClientSection = false)
        {
            try
            {
                string companyName = db.SZ_CompanyList.Where(x => x.Id == id).Select(x => x.Name).FirstOrDefault();

                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();

                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;

                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);

                // Getting all Customer data  
                var list = (from i in db.SZ_Quotation
                            join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                            where t2.MoveToProject == true && string.IsNullOrEmpty(t2.TrackingNo) && (t2.IsOnHold == true)
                            && (t2.ProjectType != inhouseProjectType || t2.ProjectType == null)
                            && i.CompanyName.ToLower() == companyName.ToLower()
                            orderby t2.MoveProjectDate descending
                            select t2).Distinct();

                list = list.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo);

                var listItems = new List<SelectListItem>();
                MemoryCacheManager objCache = new MemoryCacheManager();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });

                var scienList = objCache.Get("cache.GetScientistId", () =>
                {
                    return db.GetScientistId().ToList();
                });

                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                });

                var model = new List<ProjectListModel>();
                foreach (var k in list)
                {
                    ProjectListModel subList = new ProjectListModel();
                    //  subList.ChkSaveRow = "<a href='javascript:void(0)' onclick='SaveInformation(\"" + k.Id + "\")'> Save </a>";

                    subList.ChkSaveRow = "<input type='checkbox' value='" + k.Id + "' class='svcheck'>";
                    subList.ReadyToDeliverScientistStatusId = db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();

                    subList.ProjectType = k.ProjectType;

                    foreach (var r in listItems)
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.ScientistCustomerId))
                        {
                            subList.SelectedScientistName = r.Text;
                        }
                    }
                    subList.MoveProjectDateText = k.MoveProjectDate.HasValue ? k.MoveProjectDate.Value.ToString("dd/MM/yyyy hh:mm tt") : "";

                    subList.AdditionalBatchNo = k.AdditionalBatchNo;
                    subList.QuoteId = k.SZ_Quotation.Id;
                    subList.ProductId = k.ProductId;
                    subList.ProductName = k.ProductName;
                    if (subList.ProductId.HasValue)
                    {
                        var proData = db.Products.Where(x => x.Id == subList.ProductId && x.Published == true && x.Deleted == false).Count();
                        var proBatchData = db.SZ_Inventory.Where(x => x.ProductId == subList.ProductId).ToList();
                        if (proBatchData.Count > 0 && proData > 0)
                        {
                            foreach (var r in proBatchData)
                            {
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }
                                string selected = string.Empty;
                                if (r.Id == subList.AdditionalBatchNo)
                                {
                                    subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
                                    subList.BatchNo = r.BatchNo;
                                }
                            }
                        }
                    }
                    subList.RequiredQtyTxt = k.RequiredQty;

                    subList.IsImageAttach = k.SZ_Quotation.IsImageAttach;
                    subList.CompanyName = k.SZ_Quotation.SZ_CompanyList.Name;
                    subList.Email = k.SZ_Quotation.EmailAddress;
                    subList.PONumber = k.SZ_Quotation.PONo;
                    subList.Ref = k.SZ_Quotation.Ref;
                    subList.Remark = k.SZ_Quotation.Remark;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.QuoteDetailsId = k.Id;
                    subList.CASNo = k.CASNo;
                    subList.CATNo = k.CATNo;
                    subList.CreatedDate = k.CreatedDate;
                    subList.ImagePath = k.ImagePath;
                    subList.IsUploadServer = k.IsUploadServer;
                    subList.LeadTime = k.LeadTime;
                    subList.Price = k.Price;

                    subList.QuoteId = k.QuoteId;
                    subList.ProjectType = k.ProjectType;
                    subList.ScientistCustomerId = k.ScientistCustomerId;

                    subList.RequiredQty = k.RequiredQty;
                    subList.ProjectStatus = k.ProjectStatus;
                    subList.IsOnHold = k.IsOnHold;
                    if (k.ProjectStatus != null)
                    {
                        subList.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
                    }
                    subList.ScientistStatus = k.ScientistStatus;
                    subList.BatchCode1 = k.BatchCode1;
                    subList.BatchCode2 = k.BatchCode2;
                    subList.Qty1 = k.Qty1;
                    subList.Qty2 = k.Qty2;
                    subList.EstimateCompleteDate = k.EstimateCompleteDate;
                    if (k.EstimateCompleteDate.HasValue)
                    {
                        subList.EstimateCompleteDateText = k.EstimateCompleteDate.Value.AddDays(10).ToShortDateString();
                    }
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToProject = k.MoveToProject;
                    subList.Remark = k.Remark;
                    subList.SrPo = k.SrPo;
                    subList.AdminScientistStatus = k.AdminScientistStatus;
                    subList.LastStatus = k.LastStatus;
                    subList.InvoiceNo = k.InvoiceNo;
                    subList.InvoiceRemark = k.InvoiceRemark;

                    subList.MoveProjectDate = k.MoveProjectDate;

                    if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock))
                    {
                        k.AdminScientistStatus = "Synthesis is completed and analytical recording in progress.";
                    }
                    if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.Purchase))
                    {
                        k.AdminScientistStatus = "We will deliver product as per quoted time-line.";
                    }
                    subList.ClientStatus = k.ClientStatus;
                    subList.LastStatusText = "<input id='lastStatus_" + k.Id + "' type='text' value='" + k.LastStatus + "' title='" + k.LastStatus + "' style='width:200px' />";

                    subList.ClientStatusText = "<select id='clientstatus_" + k.Id + "' class='clsClientStatus' data-quoteDetailsId='" + k.Id + "'>";
                    if (k.ClientStatus == "In Progress")
                    {
                        subList.ClientStatusText += "<option value='In Progress' selected>In Progress</option>";


                    }
                    else
                    {
                        subList.ClientStatusText += "<option value='In Progress'>In Progress</option>";
                    }

                    if (k.ClientStatus == "COA/Data Sent")
                    {
                        k.AdminScientistStatus = "COA/Data Sent";
                        subList.ClientStatusText += "<option value='COA/Data Sent' selected>COA/Data Sent</option>";

                        //set est date blank
                        subList.EstimateCompleteDateText = string.Empty;
                    }
                    else
                    {
                        subList.ClientStatusText += "<option value='COA/Data Sent' disabled>COA/Data Sent</option>";
                    }

                    if (k.ClientStatus == "COA/Data Approved")
                    {
                        k.AdminScientistStatus = "COA/Data Approved";
                        subList.ClientStatusText += "<option value='COA/Data Approved' selected>COA/Data Approved</option>";

                        //set est date blank
                        subList.EstimateCompleteDateText = string.Empty;
                    }
                    else
                    {
                        subList.ClientStatusText += "<option value='COA/Data Approved'>COA/Data Approved</option>";
                    }

                    if (k.ClientStatus == "COA/Data Correction")
                    {
                        k.AdminScientistStatus = "COA/Data Correction";
                        subList.ClientStatusText += "<option value='COA/Data Correction' selected>COA/Data Correction</option>";
                        //set est date blank
                        subList.EstimateCompleteDateText = string.Empty;
                    }
                    else
                    {
                        subList.ClientStatusText += "<option value='COA/Data Correction'>COA/Data Correction</option>";
                    }

                    //if (k.ClientStatus == "Dispatched")
                    //{
                    //    subList.ClientStatusText += "<option value='Dispatched' selected>Dispatched</option>";
                    //}
                    //else
                    //{
                    //    subList.ClientStatusText += "<option value='Dispatched'>Dispatched</option>";
                    //}
                    subList.ClientStatusText += "</select>";

                    if (!string.IsNullOrEmpty(k.COAPath))
                    {
                        subList.COADownloadLink = "<a href='" + k.COAPath.Replace("..", "") + "' download='COA-" + subList.BatchNo + "'><i class='fa fa-download'></i></a>";
                    }
                    if (!string.IsNullOrEmpty(k.AnalyticalData))
                    {
                        subList.AnalyticalDataLink = "<a href='" + k.AnalyticalData.Replace("..", "") + "' download='AnalyticalData-" + subList.BatchNo + "'><i class='fa fa-download'></i></a>";
                    }
                    subList.AttachedDataList = k.AttachedDataList;

                    subList.ScientistStatustext = "<input id='scientistStatus_" + k.Id + "' type='text' value='" + k.AdminScientistStatus + "' title='" + k.AdminScientistStatus + "' style='width:200px' />";
                    //  subList.ClientRemarkText = "<input id='clientremark_" + k.Id + "' type='text' value='" + k.ClientRemark + "' title='" + k.ClientRemark + "'  style='width:200px' />";

                    subList.ClientRemarkText = "<i class='fa fa-pencil' onclick='Editclientremarks(" + k.Id + ")'></i>";
                    if (isClientSection)
                    {
                        subList.ClientRemarkText = "<a data-toggle='modal' data-target='#clientremarkModal' href='/Form/AddClientRemark/" + k.Id + "?isClientSection=true'><i class='fa fa-pencil'></i></a>";
                    }
                    else
                    {
                        subList.ClientRemarkText = "<a data-toggle='modal' data-target='#clientremarkModal' href='/Form/AddClientRemark/" + k.Id + "?isClientSection=false'><i class='fa fa-pencil'></i></a>";
                    }


                    subList.ClientAddressText = "<input id='clientaddress_" + k.Id + "' type='text' value='" + k.ClientAddress + "' title='" + k.ClientAddress + "' style='width:200px' />";
                    subList.ClientRemark = k.ClientRemark;
                    subList.ClientAddress = k.ClientAddress;
                    if (k.LastUploadDate.HasValue)
                    {
                        subList.LastUploadDateStr = k.LastUploadDate.Value.ToShortDateString();
                    }


                    if (string.IsNullOrEmpty(subList.ClientStatus))
                    {
                        subList.ClientStatus = "In Progress";
                    }

                    model.Add(subList);
                }
                model = model.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).ThenBy(x => x.SrPo).ToList();
                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    if (searchValue == "In Progress" || searchValue == "COA/Data Sent" || searchValue == "COA/Data Approved" || searchValue == "COA/Data Correction")
                    {
                        searchValue = searchValue.ToLower().Trim();
                        model = model.Where(m => (m.ClientStatus != null && m.ClientStatus.ToLower().Contains(searchValue))).ToList();
                    }
                    else
                    {
                        searchValue = searchValue.ToLower().Trim();
                        model = model.Where(m => (m.SelectedScientistName != null && m.SelectedScientistName.ToLower().Contains(searchValue))
                                            || (m.CompanyName != null && m.CompanyName.ToLower().Contains(searchValue))
                                            || (m.PONumber != null && m.PONumber.ToLower().Contains(searchValue))
                                            || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                            || (m.Price != null && m.Price.ToLower().Contains(searchValue))
                                            || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                            || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                            || (m.SelectedProjectType != null && m.SelectedProjectType.ToLower().Contains(searchValue))
                                            || (m.RequiredQty != null && m.RequiredQty.ToLower().Contains(searchValue))
                                            || (m.SelectedAdditionalBatchNo != null && m.SelectedAdditionalBatchNo.ToLower().Contains(searchValue))
                                            || (m.ClientRemark != null && m.ClientRemark.ToLower().Contains(searchValue))
                                            | (m.ClientStatus != null && m.ClientStatus.ToLower().Contains(searchValue))
                                            || (m.MoveProjectDateText != null && m.MoveProjectDateText.ToString().ToLower().Contains(searchValue))
                                             || (m.EstimateCompleteDateText != null && m.EstimateCompleteDateText.ToString().ToLower().Contains(searchValue))
                                              || (m.AdminScientistStatus != null && m.AdminScientistStatus.ToLower().Contains(searchValue))
                                               || (m.ProjectStatustext != null && m.ProjectStatustext.ToLower().Contains(searchValue))
                                                || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                                            || (m.ClientAddress != null && m.ClientAddress.ToLower().Contains(searchValue))).ToList();
                    }
                }

                //total number of rows count   
                recordsTotal = model.Count();
                //Paging   
                var data = model.Skip(skip).Take(pageSize).ToList();
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                throw ex;
            }

        }

        [HttpPost]
        public ActionResult LoadAllClientDispatcheddata(int id)
        {
            try
            {
                string companyName = db.SZ_CompanyList.Where(x => x.Id == id).Select(x => x.Name).FirstOrDefault();

                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();

                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;

                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);

                // Getting all Customer data  
                var list = (from i in db.SZ_Quotation
                            join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                            where !string.IsNullOrEmpty(t2.TrackingNo)
                            && i.CompanyName.ToLower() == companyName.ToLower()
                            orderby t2.MoveProjectDate descending
                            select t2).Distinct();

                list = list.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo);

                var listItems = new List<SelectListItem>();
                MemoryCacheManager objCache = new MemoryCacheManager();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });

                var scienList = objCache.Get("cache.GetScientistId", () =>
                {
                    return db.GetScientistId().ToList();
                });

                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                });


                var model = new List<ProjectListModel>();
                foreach (var k in list)
                {
                    ProjectListModel subList = new ProjectListModel();
                    subList.ReadyToDeliverScientistStatusId = db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                    subList.ProjectType = k.ProjectType;
                    subList.MoveProjectDateText = k.MoveProjectDate.HasValue ? k.MoveProjectDate.Value.ToString("dd/MM/yyyy hh:mm tt") : "";

                    subList.AdditionalBatchNo = k.AdditionalBatchNo;
                    subList.QuoteId = k.SZ_Quotation.Id;
                    subList.ProductId = k.ProductId;
                    subList.ProductName = k.ProductName;
                    if (subList.ProductId.HasValue)
                    {
                        var proData = db.Products.Where(x => x.Id == subList.ProductId && x.Published == true && x.Deleted == false).Count();
                        var proBatchData = db.SZ_Inventory.Where(x => x.ProductId == subList.ProductId).ToList();
                        if (proBatchData.Count > 0 && proData > 0)
                        {
                            foreach (var r in proBatchData)
                            {
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }
                                string selected = string.Empty;
                                if (r.Id == subList.AdditionalBatchNo)
                                {
                                    subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
                                    subList.BatchNo = r.BatchNo;
                                }
                            }
                        }
                    }
                    subList.RequiredQtyTxt = k.RequiredQty;

                    subList.IsImageAttach = k.SZ_Quotation.IsImageAttach;
                    subList.CompanyName = k.SZ_Quotation.SZ_CompanyList.Name;
                    subList.Email = k.SZ_Quotation.EmailAddress;
                    subList.PONumber = k.SZ_Quotation.PONo;
                    subList.Ref = k.SZ_Quotation.Ref;
                    subList.Remark = k.SZ_Quotation.Remark;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.QuoteDetailsId = k.Id;
                    subList.CASNo = k.CASNo;
                    subList.CATNo = k.CATNo;
                    subList.CreatedDate = k.CreatedDate;
                    subList.ImagePath = k.ImagePath;
                    subList.IsUploadServer = k.IsUploadServer;
                    subList.LeadTime = k.LeadTime;
                    subList.Price = k.Price;

                    subList.QuoteId = k.QuoteId;
                    subList.ProjectType = k.ProjectType;
                    subList.ScientistCustomerId = k.ScientistCustomerId;

                    subList.RequiredQty = k.RequiredQty;
                    subList.ProjectStatus = k.ProjectStatus;
                    subList.IsOnHold = k.IsOnHold;
                    if (k.ProjectStatus != null)
                    {
                        subList.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
                    }
                    subList.ScientistStatus = k.ScientistStatus;
                    subList.BatchCode1 = k.BatchCode1;
                    subList.BatchCode2 = k.BatchCode2;
                    subList.Qty1 = k.Qty1;
                    subList.Qty2 = k.Qty2;
                    subList.EstimateCompleteDate = k.EstimateCompleteDate;
                    if (k.EstimateCompleteDate.HasValue)
                    {
                        subList.EstimateCompleteDateText = k.EstimateCompleteDate.Value.AddDays(10).ToShortDateString();
                    }
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToProject = k.MoveToProject;
                    subList.Remark = k.Remark;
                    subList.SrPo = k.SrPo;
                    subList.AdminScientistStatus = k.AdminScientistStatus;
                    subList.LastStatus = k.LastStatus;
                    subList.InvoiceNo = k.InvoiceNo;
                    subList.InvoiceRemark = k.InvoiceRemark;

                    subList.MoveProjectDate = k.MoveProjectDate;

                    subList.ScientistStatustext = k.AdminScientistStatus;
                    subList.ClientStatusText = k.ClientStatus;

                    if (!string.IsNullOrEmpty(k.COAPath))
                    {
                        subList.COADownloadLink = "<a href='" + k.COAPath.Replace("..", "") + "' download='COA-" + subList.BatchNo + "'><i class='fa fa-download'></i></a>";
                    }
                    if (!string.IsNullOrEmpty(k.AnalyticalData))
                    {
                        subList.AnalyticalDataLink = "<a href='" + k.AnalyticalData.Replace("..", "") + "' download='AnalyticalData-" + subList.BatchNo + "'><i class='fa fa-download'></i></a>";
                    }
                    subList.AttachedDataList = k.AttachedDataList;

                    subList.ClientRemarkText = k.ClientRemark;
                    subList.ClientAddressText = k.ClientAddress;
                    subList.ClientStatus = k.ClientStatus;
                    subList.ClientRemark = k.ClientRemark;
                    subList.ClientAddress = k.ClientAddress;
                    subList.TrackingNo = k.TrackingNo;
                    if (!string.IsNullOrEmpty(k.Courier))
                    {
                        try
                        {
                            int couid = Convert.ToInt32(k.Courier);
                            subList.Courier = db.SZ_Courier.Where(x => x.Id == couid).Select(x => x.Name).FirstOrDefault();
                        }
                        catch (Exception)
                        {
                            //return error message here...
                        }
                    }
                    subList.ClientRemarkText = "<a data-toggle='modal' data-target='#clientremarkModal' href='/Form/AddClientRemark/" + k.Id + "?isClientSection=true'><i class='fa fa-pencil'></i></a>";

                    if (k.LastUploadDate.HasValue)
                    {
                        subList.LastUploadDateStr = k.LastUploadDate.Value.ToShortDateString();
                    }
                    model.Add(subList);
                }
                model = model.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).ThenBy(x => x.SrPo).ToList();
                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.SelectedScientistName != null && m.SelectedScientistName.ToLower().Contains(searchValue))
                                        || (m.CompanyName != null && m.CompanyName.ToLower().Contains(searchValue))
                                        || (m.PONumber != null && m.PONumber.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.Price != null && m.Price.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.SelectedProjectType != null && m.SelectedProjectType.ToLower().Contains(searchValue))
                                        || (m.RequiredQty != null && m.RequiredQty.ToLower().Contains(searchValue))
                                         || (m.ClientRemark != null && m.ClientRemark.ToLower().Contains(searchValue))
                                        | (m.ClientStatus != null && m.ClientStatus.ToLower().Contains(searchValue))
                                        || (m.MoveProjectDateText != null && m.MoveProjectDateText.ToString().ToLower().Contains(searchValue))
                                         || (m.EstimateCompleteDateText != null && m.EstimateCompleteDateText.ToString().ToLower().Contains(searchValue))
                                          || (m.AdminScientistStatus != null && m.AdminScientistStatus.ToLower().Contains(searchValue))
                                           || (m.ProjectStatustext != null && m.ProjectStatustext.ToLower().Contains(searchValue))
                                            || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                                        || (m.ClientAddress != null && m.ClientAddress.ToLower().Contains(searchValue))).ToList();
                }

                //total number of rows count   
                recordsTotal = model.Count();
                //Paging   
                var data = model.Skip(skip).Take(pageSize).ToList();
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                throw ex;
            }

        }


        [HttpPost]
        public ActionResult LoadAllDispatchdata()
        {
            try
            {
                db.Configuration.AutoDetectChangesEnabled = false;
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                var type = Request.Form.GetValues("type").FirstOrDefault();
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;
                var fltprostatusItem = "";
                var fltactivitystatusItem = "";
                var fltprotypeItem = "";
                if (Request.Form.GetValues("fltprostatusItem") != null)
                {
                    fltprostatusItem = Request.Form.GetValues("fltprostatusItem")[0].ToString();
                }
                if (Request.Form.GetValues("fltprostatusItem") != null)
                {
                    fltactivitystatusItem = Request.Form.GetValues("fltactivitystatusItem")[0].ToString();
                }
                if (Request.Form.GetValues("fltprotypeItem") != null)
                {
                    fltprotypeItem = Request.Form.GetValues("fltprotypeItem")[0].ToString();
                }
                var flttableName = "";
                if (Request.Form.GetValues("tableName") != null)
                {
                    flttableName = Request.Form.GetValues("tableName")[0].ToString();
                }
                MemoryCacheManager objCache = new MemoryCacheManager();
                var searchby = string.Empty;
                var searchbyvalue = string.Empty;
                if (Request.Form.GetValues("radiobuton") != null)
                {
                    searchby = Request.Form.GetValues("radiobuton")[0].ToString();
                }
                if (Request.Form.GetValues("searchbox") != null)
                {
                    searchbyvalue = Request.Form.GetValues("searchbox")[0].ToString().Trim();
                }
                var projectList = objCache.Get("cache.projectlist", () =>
                {
                    return db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("project")).ToList();
                });

                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
                string instockProjectType = Convert.ToString((int)EnumList.ProjectType.InStock);
                IQueryable<SZ_QuotationDetail> list;
                if (type == "all")
                {
                    list = (from i in db.SZ_Quotation.AsNoTracking()
                            join t2 in db.SZ_QuotationDetail.AsNoTracking() on i.Id equals t2.QuoteId
                            where t2.MoveToProject == true && string.IsNullOrEmpty(t2.TrackingNo) && (t2.IsOnHold == false || t2.IsOnHold == null)
                            && (t2.ProjectType != inhouseProjectType || t2.ProjectType == null)
                            orderby t2.MoveProjectDate descending
                            select t2).Distinct().OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).AsQueryable();
                }
                else
                {
                    int ctypeid = 1;
                    if (type == "export")
                    {
                        ctypeid = 2;
                    }
                    list = (from i in db.SZ_Quotation.AsNoTracking()
                            join t2 in db.SZ_QuotationDetail.AsNoTracking() on i.Id equals t2.QuoteId
                            where t2.MoveToProject == true && string.IsNullOrEmpty(t2.TrackingNo) && (t2.IsOnHold == false || t2.IsOnHold == null)
                           // && (t2.ProjectType != inhouseProjectType || t2.ProjectType == null)
                           && t2.ProjectType == instockProjectType
                            && i.CountryTypeId == ctypeid
                            orderby t2.MoveProjectDate descending
                            select t2).Distinct().OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).AsQueryable();
                }

                var listItems = new List<SelectListItem>();

                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.AsNoTracking().Where(x => x.KeyGroup == "Customer").ToList();
                });

                var scienList = objCache.Get("cache.GetScientistId", () =>
                {
                    return db.GetScientistId().ToList();
                });

                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                });

                var quotedetailids = list.Select(x => x.Id).ToList();
                var quotedetailsformdata = db.SZ_QuoteDetails_Form.AsNoTracking().Where(x => quotedetailids.Contains(x.QuoteDetailsId)).ToList();
                var formids = quotedetailsformdata.Select(x => x.FormId).ToList();
                var qdsubmitformList = db.SZ_QuoteDetailForm.AsNoTracking().Where(x => formids.Contains(x.Id)).ToList();
                var productids = list.Select(x => x.ProductId).ToList();
                var masterCOAData = objCache.Get("cache.mastercoadata", () =>
                {
                    return db.SZ_MasterCOA.AsNoTracking().ToList();
                });
                var childcoadata = objCache.Get("cache.childcoadata", () =>
                {
                    return db.SZ_ChildCOA.AsNoTracking().ToList();
                });
                var productsData = objCache.Get("cache.productsdata", () =>
                {
                    return db.Products.Where(x => x.Published == true && x.Deleted == false).ToList();
                });
                var ReadyToDeliverScientistStatusId = objCache.Get("cache.ReadyToDeliverScientistStatusId", () =>
                {
                    return db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                });
                var catList = objCache.Get("cache.categorydata", () =>
                {
                    return db.Categories.Where(x => x.ParentCategoryId == 0 && x.Deleted == false && x.Published).ToList();
                });
                var inventoryDatacache = objCache.Get("cache.inventoryData", () =>
                {
                    return db.SZ_Inventory.AsNoTracking().ToList();
                });
                var model = new List<ProjectListModel>();
                var catnolist = list.Select(x => x.CATNo.Trim()).ToList();
                //var queryData = db.SZ_QueryModule.AsNoTracking().Where(x => catnolist.Contains(x.CATNo.Trim())).ToList();
                var inventoryData = inventoryDatacache.Where(x => productids.Contains(x.ProductId)).ToList();
                var filledFormList = db.SZ_QuoteDetailForm.AsNoTracking().Where(x => x.IsDispatchedEntry.HasValue && x.IsDispatchedEntry.Value).ToList();

                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    list = list.Where(m => (m.SZ_Quotation.PONo != null && m.SZ_Quotation.PONo.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        || (m.Reason != null && m.Reason.ToLower().Contains(searchValue))).AsQueryable();
                }
                if (!string.IsNullOrEmpty(fltprostatusItem))
                {
                    list = list.Where(x => x.ProStatus == fltprostatusItem).AsQueryable();
                }
                if (!string.IsNullOrEmpty(fltactivitystatusItem))
                {
                    list = list.Where(x => x.ActivityStatus == fltactivitystatusItem).AsQueryable();
                }
                if (!string.IsNullOrEmpty(fltprotypeItem))
                {
                    list = list.Where(x => x.ProjectType == fltprotypeItem).AsQueryable();
                }

                if (!string.IsNullOrEmpty(searchby) && !string.IsNullOrEmpty(searchbyvalue))
                {
                    searchbyvalue = searchbyvalue.ToLower();
                    if (searchby == "quoteid")
                    {
                        list = list.Where(x => x.SZ_Quotation.Ref.ToLower().Contains(searchbyvalue)).AsQueryable();
                    }
                    if (searchby == "ponumber")
                    {
                        list = list.Where(x => x.SZ_Quotation.PONo.ToLower().Contains(searchbyvalue)).AsQueryable();
                    }
                    if (searchby == "company")
                    {
                        list = list.Where(x => x.SZ_Quotation.CompanyName.ToLower().Contains(searchbyvalue)).AsQueryable();
                    }
                    if (searchby == "productname")
                    {
                        list = list.Where(x => x.ProductName.ToLower().Contains(searchbyvalue)).AsQueryable();
                    }
                    if (searchby == "cas")
                    {
                        list = list.Where(x => x.CASNo != null ? x.CASNo.ToLower().Contains(searchbyvalue) : false).AsQueryable();
                    }
                    if (searchby == "cat")
                    {
                        list = list.Where(x => x.CATNo != null ? x.CATNo.ToLower().Contains(searchbyvalue) : false).AsQueryable();
                    }
                    if (searchby == "batchno")
                    {
                        list = list.Where(x => x.BatchNo != null ? x.BatchNo.ToLower().Contains(searchbyvalue) : false).AsQueryable();
                    }
                    if (searchby == "teamleader")
                    {
                        //list = list.Where(x => x.ScientistCustomerId.HasValue ? (x.ScientistCustomerId == searchbyvalue) : false).ToList();
                    }
                }
                //total number of rows count   
                recordsTotal = list.Count();
                var nlist = list.Skip(skip).Take(pageSize).ToList();
                foreach (var k in nlist)
                {
                    ProjectListModel subList = new ProjectListModel();
                    subList.DispatchedStatus = k.DispatchedStatus;
                    if (k.SZ_Quotation.SZ_CompanyList.ProjectTeam.HasValue)
                    {
                        var projectuser = projectList.Where(x => x.Id == k.SZ_Quotation.SZ_CompanyList.ProjectTeam).FirstOrDefault();
                        if (projectuser != null)
                        {
                            string customerName = string.Empty;
                            var genericAttr = genericData.Where(x => x.EntityId == projectuser.Id).ToList();
                            if (genericAttr.Count > 0)
                            {
                                customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                            }
                            subList.ProjectAssignName = customerName;
                        }
                    }

                    bool isApproveButton = k.IsDispatchApprove.HasValue && k.IsDispatchApprove.Value ? false : true;
                    subList.ProStatus = k.ProStatus;
                    subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clssavealltab' data-showapprovebutton='" + isApproveButton + "' />";

                    if (!string.IsNullOrEmpty(k.COAPath) || !string.IsNullOrEmpty(k.AnalyticalData))
                    {
                        subList.ChkSaveRow = "<a href='javascript:void(0)' style = 'color:darkgreen;font-weight: bold;' onclick='UploadDocumentOfProduct(\"" + k.Id + "\")'> Upload </a>";
                    }
                    else
                    {
                        subList.ChkSaveRow = "<a href='javascript:void(0)' onclick='UploadDocumentOfProduct(\"" + k.Id + "\")'> Upload </a>";
                    }

                    var form = filledFormList.Where(x => x.CATNo == k.CATNo).OrderByDescending(x => x.Id).FirstOrDefault();
                    if (form != null && k.ProStatus == Convert.ToString((int)EnumList.DispatchStatusDDl.QCApproved) && k.ProStatus == Convert.ToString((int)EnumList.DispatchStatusDDl.ReadyforDispatch))
                    {
                        subList.ChkSaveRow += " | <a href='/Form/SubmitForm/" + k.Id + "?formid=" + form.Id + "&isdispatch=true'>Edit Form</a>";
                        subList.ChkSaveRow += " | <a href='/Form/Printform/" + form.Id + "'>Submit & Print Form</a>";
                    }
                    subList.ReadyToDeliverScientistStatusId = ReadyToDeliverScientistStatusId;
                    subList.ProStatus = k.ProStatus;
                    subList.ProjectType = k.ProjectType;
                    foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ProjectType), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
                        int val = (int)r;
                        if (Convert.ToString(val) == k.ProjectType)
                        {
                            subList.SelectedProjectType = text;
                        }
                    }
                    foreach (var r in listItems)
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.ScientistCustomerId))
                        {
                            subList.SelectedScientistName = r.Text;
                        }
                    }
                    subList.MoveProjectDateText = k.MoveProjectDate.HasValue ? k.MoveProjectDate.Value.ToString("dd/MM/yyyy hh:mm tt") : "";
                    subList.AdditionalBatchNo = k.AdditionalBatchNo;
                    subList.QuoteId = k.SZ_Quotation.Id;
                    subList.ProductId = k.ProductId;
                    subList.ProductName = k.ProductName;
                    subList.ActivityStatus = k.ActivityStatus;
                    subList.AdditionalBatchNoText = "<select id='additionalBatch_" + k.Id + "' data-tablename='" + flttableName + "' data-quotationdetailsid='" + k.Id + "' class='ddladditionalbatch addbatch'><option value=''>--Select--</option>";
                    if (subList.ProductId.HasValue)
                    {
                        var proData = productsData.Where(x => x.Id == subList.ProductId).Count();
                        var proBatchData = inventoryData.Where(x => x.ProductId == subList.ProductId).ToList();
                        if (proBatchData.Count > 0 && proData > 0)
                        {
                            foreach (var r in proBatchData)
                            {
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }
                                string selected = string.Empty;
                                if (r.Id == subList.AdditionalBatchNo)
                                {
                                    selected = "selected ";
                                    subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
                                    subList.BatchNo = r.BatchNo;
                                }
                                subList.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' " + selected + ">" + text + "</option>";
                            }
                        }
                        var productData = productsData.Where(x => x.Id == subList.ProductId && x.Published == true && x.Deleted == false).FirstOrDefault();
                        if (productData != null)
                        {
                            subList.IsControlledSubstance = productData.IsControlledSubstance;
                            if (!subList.IsControlledSubstance.HasValue
                                || subList.IsControlledSubstance == false)
                            {
                                subList.IsControlledSubstance = productData.IsManuallyControlledSubstance;
                            }
                        }
                    }
                    subList.AdditionalBatchNoText += "</select>";
                    subList.ApprovalCommentsText = "<i class='fa fa-pencil' onclick='approCommentGenerate(\"" + k.Id + "\")' ></i>";
                    subList.DispatchStatusText = "<select id='dispatchstatus_" + k.Id + "' data-quotationdetailsid='" + k.Id + "' class='adddispatchstatus'><option value=''>--Select--</option>";
                    foreach (EnumList.DispatchStatusDDl r in Enum.GetValues(typeof(EnumList.DispatchStatusDDl)))
                    {
                        string selected = "";
                        var item = Enum.GetName(typeof(EnumList.DispatchStatusDDl), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.DispatchStatusDDl)(int)r);
                        int val = (int)r;
                        if (Convert.ToString(val) == k.ProStatus)
                        {
                            selected = "selected";
                            subList.SelectedDispatchStatus = text;
                        }
                        subList.DispatchStatusText += "<option value='" + val + "' " + selected + ">" + text + "</option>";

                    }
                    subList.DispatchStatusText += "</select>";
                    subList.RequiredQtyTxt = k.RequiredQty;
                    subList.IsImageAttach = k.SZ_Quotation.IsImageAttach;
                    subList.CompanyName = k.SZ_Quotation.SZ_CompanyList.Name;
                    subList.Email = k.SZ_Quotation.EmailAddress;
                    subList.PONumber = k.SZ_Quotation.PONo;
                    subList.Ref = k.SZ_Quotation.Ref;
                    subList.Remark = k.SZ_Quotation.Remark;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.QuoteDetailsId = k.Id;
                    subList.CASNo = k.CASNo;
                    string pName = "";
                    //var query = queryData.Where(x => x.CATNo.Trim().ToLower() == k.CATNo.Trim().ToLower()).OrderByDescending(x => x.Id).ToList();
                    //if (query != null && query.Count() > 0)
                    //{
                    //    var qlist = query.Select(x => x.QueryNo).ToArray();
                    //    if (query.Select(x => x.Status.ToLower()).FirstOrDefault() == "solved" ||
                    //    query.Select(x => x.Status.ToLower()).FirstOrDefault() == "close" ||
                    //    query.Select(x => x.Status.ToLower()).FirstOrDefault() == "completed")
                    //    {
                    //        pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + k.CATNo + "\", \"dispatch\")' title='" + string.Join(", ", qlist) + "' style ='float:right; color: green' ></i>";
                    //    }
                    //    else
                    //    {
                    //        pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + k.CATNo + "\", \"dispatch\")' title='" + string.Join(", ", qlist) + "' style ='float:right' ></i>";
                    //    }
                    //}

                    subList.IsConversionReport = k.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    var impstr = "";
                    if (subList.IsConversionReport.HasValue && subList.IsConversionReport.Value)
                    {
                        impstr += "<img src='/img/important.jpg' width='15px' height='15px' />";
                    }

                    subList.CATNo = k.CATNo + "" + impstr + " " + pName + CommonOperation.GetMatchingTagHTML(k, "Dispatch");
                    subList.CreatedDate = k.CreatedDate;
                    subList.ImagePath = k.ImagePath;
                    subList.IsUploadServer = k.IsUploadServer;
                    subList.LeadTime = k.LeadTime;
                    subList.Price = k.Price;
                    subList.QuoteId = k.QuoteId;
                    subList.ProjectType = k.ProjectType;
                    subList.ScientistCustomerId = k.ScientistCustomerId;
                    subList.RequiredQty = k.RequiredQty;
                    subList.ProjectStatus = k.ProjectStatus;
                    subList.IsOnHold = k.IsOnHold;
                    if (k.ProjectStatus != null)
                    {
                        subList.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
                    }
                    subList.ScientistStatus = k.ScientistStatus;
                    subList.BatchCode1 = k.BatchCode1;
                    subList.BatchCode2 = k.BatchCode2;
                    subList.Qty1 = k.Qty1;
                    subList.Qty2 = k.Qty2;
                    subList.EstimateCompleteDate = k.EstimateCompleteDate;
                    if (k.EstimateCompleteDate.HasValue)
                    {
                        subList.EstimateCompleteDateText = k.EstimateCompleteDate.Value.ToShortDateString();
                    }
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToProject = k.MoveToProject;
                    subList.Remark = k.Remark;
                    subList.SrPo = k.SrPo;
                    subList.AdminScientistStatus = k.AdminScientistStatus;
                    subList.LastStatus = k.LastStatus;
                    subList.InvoiceNo = k.InvoiceNo;
                    subList.InvoiceRemark = k.InvoiceRemark;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.ClientStatusText = "<select id='clientstatus_" + k.Id + "' class='clsClientStatus' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    subList.ClientStatusText += "<option value='In progress'>In progress</option>";
                    subList.ClientStatusText += "<option value='COA/Data Sent'>COA/Data Sent</option>";
                    subList.ClientStatusText += "<option value='COA/Data Approved'>COA/Data Approved</option>";
                    subList.ClientStatusText += "<option value='COA/Data Correction'>COA/Data Correction</option>";
                    //subList.ClientStatusText += "<option value='Dispatched'>Dispatched</option>";
                    subList.ClientStatusText += "</select>";
                    subList.ClientStatus = k.ClientStatus;
                    subList.ClientRemark = k.ClientRemark;
                    subList.ClientAddress = k.ClientAddress;
                    if (!string.IsNullOrEmpty(k.COAPath))
                    {
                        subList.COADownloadLink = "<a href='" + k.COAPath.Replace("..", "") + "' download='COA-" + subList.BatchNo + "'><i class='fa fa-download'></i></a>";
                    }
                    if (!string.IsNullOrEmpty(k.AnalyticalData))
                    {
                        subList.AnalyticalDataLink = "<a href='" + k.AnalyticalData.Replace("..", "") + "' download='AnalyticalData-" + subList.BatchNo + "'><i class='fa fa-download'></i></a>";
                    }
                    subList.ClientRemarkText = "<a data-toggle='modal' data-target='#clientremarkModal' href='/Form/AddClientRemark/" + k.Id + "?isClientSection=false'><i class='fa fa-pencil'></i></a>";
                    subList.AttachedDataList = k.AttachedDataList;

                    string coaText = "";

                    coaText = "<select id='coa_" + k.Id + "' class='addcoa'><option value=''>--Select--</option>";
                    int bId = k.AdditionalBatchNo.HasValue ? k.AdditionalBatchNo.Value : 0;
                    if (bId != 0)
                    {
                        var mastercoa = masterCOAData.Where(x => x.BatchId == bId).FirstOrDefault();
                        if (mastercoa != null)
                        {
                            subList.BatchNo = mastercoa.BatchNo;
                            var listchildcoa = childcoadata.Where(x => x.MasterCOAID == mastercoa.Id).ToList();
                            if (listchildcoa != null && listchildcoa.Count > 0)
                            {
                                foreach (var ccoa in listchildcoa)
                                {
                                    if (k.COAId == ccoa.Id)
                                    {
                                        coaText += "<option value='" + ccoa.Id.ToString() + "' data-value='" + k.AdditionalBatchNo + "' selected>" + ccoa.RefNo + "</option>";
                                    }
                                    else
                                    {
                                        coaText += "<option value='" + ccoa.Id.ToString() + "' data-value='" + k.AdditionalBatchNo + "'>" + ccoa.RefNo + "</option>";
                                    }
                                }
                            }
                        }
                    }
                    subList.COAText = coaText;
                    if (k.IsDispatchApprove.HasValue && k.IsDispatchApprove.Value)
                    {
                        subList.LastRowText = "<i class='fa fa-check'></i>";
                    }
                    else
                    {
                        subList.LastRowText = "<i class='fa fa-remove'></i>";
                    }
                    subList.IsDispatchApprove = k.IsDispatchApprove;
                    subList.Reason = k.Reason;
                    subList.SuggChemName = k.SZ_Quotation.SuggChemName;
                    if (k.LastUploadDate.HasValue)
                    {
                        subList.LastUploadDateStr = k.LastUploadDate.Value.ToShortDateString();
                    }
                    if (!string.IsNullOrEmpty(k.SZ_Quotation.Attachment))
                    {
                        subList.Attachment = "<a href='javascript: void(0)' onclick='attachment(" + k.QuoteId + ")'> <i class='fa fa-paperclip'></i></a>";
                    }
                    subList.ReasonText = "<input id='reason_" + k.Id + "' type='text' value='" + k.Reason + "' title='" + k.Reason + "'  style='width:200px' />";
                    subList.CountryType = k.SZ_Quotation.CountryType;
                    subList.OrderRemark = k.OrderRemark;
                    subList.OrderRemarkText = "<input id='orderremark_" + k.Id + "' type='text' value='" + k.OrderRemark + "' title='" + k.OrderRemark + "'  style='width:200px' />";
                    subList.EstimateCompleteDate = k.EstimateCompleteDate;
                    subList.EstimateCompleteDateText = "<input id='esticompleteDate_" + k.Id + "' data-value='" + k.EstimateCompleteDate + "' type='text' class='datepicker'  style='width:80px' />";
                    subList.ChangeBatch = "<i class='fa fa-clone' title='Change Batch No' onclick='GetAllBatchNo(" + k.ProductId + "," + k.Id + ")' ></i>";

                    var formid = quotedetailsformdata.Where(x => x.QuoteDetailsId == k.Id).Select(x => x.FormId).FirstOrDefault();
                    var qdsubmitform = qdsubmitformList.Where(x => x.Id == formid).FirstOrDefault();
                    if (qdsubmitform != null)
                    {
                        if (!string.IsNullOrEmpty(qdsubmitform.SpectralDataAttachment))
                        {
                            subList.SpectralData = "<a href='" + qdsubmitform.SpectralDataAttachment.Replace("..", "") + "' download='SpectralData-" + subList.BatchNo + "'><i class='fa fa-download'></i></a>";
                        }
                    }
                    subList.ActivityStatusText = "<select id='activitystatus_" + k.Id + "' class='clsActivityStatus' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";

                    if (k.ActivityStatus == "Invoice Sent")
                    {
                        subList.ActivityStatusText += "<option value='Invoice Sent' selected>Invoice Sent</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Invoice Sent'>Invoice Sent</option>";
                    }
                    if (k.ActivityStatus == "PDC Awaited")
                    {
                        subList.ActivityStatusText += "<option value='PDC Awaited' selected>PDC Awaited</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='PDC Awaited'>PDC Awaited</option>";
                    }
                    if (k.ActivityStatus == "Advance Payment")
                    {
                        subList.ActivityStatusText += "<option value='Advance Payment' selected>Advance Payment</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Advance Payment'>Advance Payment</option>";
                    }
                    if (k.ActivityStatus == "Payment Due")
                    {
                        subList.ActivityStatusText += "<option value='Payment Due' selected>Payment Due</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Payment Due'>Payment Due</option>";
                    }
                    subList.ActivityStatusText += "</select>";

                    model.Add(subList);
                }
                model = model.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).ToList();
                //Search

                //Paging   
                var data = model;
                //var data = model.Skip(skip).Take(pageSize).ToList();
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }
        }

        //[HttpPost]
        //public ActionResult LoadAllDispatchdata()
        //{
        //    try
        //    {
        //        db.Configuration.AutoDetectChangesEnabled = false;
        //        var draw = Request.Form.GetValues("draw").FirstOrDefault();
        //        var start = Request.Form.GetValues("start").FirstOrDefault();
        //        var length = Request.Form.GetValues("length").FirstOrDefault();
        //        var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
        //        var type = Request.Form.GetValues("type").FirstOrDefault();
        //        int pageSize = length != null ? Convert.ToInt32(length) : 0;
        //        int skip = start != null ? Convert.ToInt32(start) : 0;
        //        int recordsTotal = 0;
        //        var fltprostatusItem = "";
        //        var fltactivitystatusItem = "";
        //        var fltprotypeItem = "";
        //        if (Request.Form.GetValues("fltprostatusItem") != null)
        //        {
        //            fltprostatusItem = Request.Form.GetValues("fltprostatusItem")[0].ToString();
        //        }
        //        if (Request.Form.GetValues("fltprostatusItem") != null)
        //        {
        //            fltactivitystatusItem = Request.Form.GetValues("fltactivitystatusItem")[0].ToString();
        //        }
        //        if (Request.Form.GetValues("fltprotypeItem") != null)
        //        {
        //            fltprotypeItem = Request.Form.GetValues("fltprotypeItem")[0].ToString();
        //        }
        //        var flttableName = "";
        //        if (Request.Form.GetValues("tableName") != null)
        //        {
        //            flttableName = Request.Form.GetValues("tableName")[0].ToString();
        //        }
        //        MemoryCacheManager objCache = new MemoryCacheManager();
        //        var searchby = string.Empty;
        //        var searchbyvalue = string.Empty;
        //        if (Request.Form.GetValues("radiobuton") != null)
        //        {
        //            searchby = Request.Form.GetValues("radiobuton")[0].ToString();
        //        }
        //        if (Request.Form.GetValues("searchbox") != null)
        //        {
        //            searchbyvalue = Request.Form.GetValues("searchbox")[0].ToString().Trim();
        //        }
        //        var projectList = objCache.Get("cache.projectlist", () =>
        //        {
        //            return db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("project")).ToList();
        //        });

        //        string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
        //        string instockProjectType = Convert.ToString((int)EnumList.ProjectType.InStock);
        //        var list = new List<SZ_QuotationDetail>();
        //        if (type == "all")
        //        {
        //            list = (from i in db.SZ_Quotation.AsNoTracking()
        //                    join t2 in db.SZ_QuotationDetail.AsNoTracking() on i.Id equals t2.QuoteId
        //                    where t2.MoveToProject == true && string.IsNullOrEmpty(t2.TrackingNo) && (t2.IsOnHold == false || t2.IsOnHold == null)
        //                    && (t2.ProjectType != inhouseProjectType || t2.ProjectType == null)
        //                    orderby t2.MoveProjectDate descending
        //                    select t2).Distinct().OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).ToList();
        //        }
        //        else
        //        {
        //            list = (from i in db.SZ_Quotation.AsNoTracking()
        //                    join t2 in db.SZ_QuotationDetail.AsNoTracking() on i.Id equals t2.QuoteId
        //                    where t2.MoveToProject == true && string.IsNullOrEmpty(t2.TrackingNo) && (t2.IsOnHold == false || t2.IsOnHold == null)
        //                   // && (t2.ProjectType != inhouseProjectType || t2.ProjectType == null)
        //                   && t2.ProjectType == instockProjectType
        //                    && i.CountryType == type
        //                    orderby t2.MoveProjectDate descending
        //                    select t2).Distinct().OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).ToList();
        //        }

        //        var listItems = new List<SelectListItem>();

        //        var genericData = objCache.Get("cache.genericData", () =>
        //        {
        //            return db.GenericAttributes.AsNoTracking().Where(x => x.KeyGroup == "Customer").ToList();
        //        });

        //        var scienList = objCache.Get("cache.GetScientistId", () =>
        //        {
        //            return db.GetScientistId().ToList();
        //        });

        //        scienList.ForEach(term =>
        //        {
        //            string customerName = string.Empty;
        //            var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
        //            if (genericAttr.Count > 0)
        //            {
        //                customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
        //            }
        //            listItems.Add(new SelectListItem
        //            {
        //                Text = customerName,
        //                Value = term.ToString()
        //            });
        //        });

        //        var quotedetailids = list.Select(x => x.Id).ToList();
        //        var quotedetailsformdata = db.SZ_QuoteDetails_Form.AsNoTracking().Where(x => quotedetailids.Contains(x.QuoteDetailsId)).ToList();
        //        var formids = quotedetailsformdata.Select(x => x.FormId).ToList();
        //        var qdsubmitformList = db.SZ_QuoteDetailForm.AsNoTracking().Where(x => formids.Contains(x.Id)).ToList();

        //        var productids = list.Select(x => x.ProductId).ToList();
        //        //var masterCOAData = db.SZ_MasterCOA.AsNoTracking().Where(x => productids.Contains(x.ProductId)).ToList();
        //        //var mastercoaids = masterCOAData.Select(x => x.Id).ToList();
        //        //var childcoadata = db.SZ_ChildCOA.AsNoTracking().Where(x => mastercoaids.Contains(x.MasterCOAID.Value)).ToList();

        //        var masterCOAData = objCache.Get("cache.mastercoadata", () =>
        //        {
        //            return db.SZ_MasterCOA.AsNoTracking().ToList();
        //        });
        //        var childcoadata = objCache.Get("cache.childcoadata", () =>
        //        {
        //            return db.SZ_ChildCOA.AsNoTracking().ToList();
        //        });
        //        var productsData = objCache.Get("cache.productsdata", () =>
        //        {
        //            return db.Products.Where(x => x.Published == true && x.Deleted == false).ToList();
        //        });

        //        //var productsData = db.Products.AsNoTracking().Where(x => productids.Contains(x.Id) && x.Published == true && x.Deleted == false).ToList();
        //        var ReadyToDeliverScientistStatusId = objCache.Get("cache.ReadyToDeliverScientistStatusId", () =>
        //        {
        //            return db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
        //        });
        //        var catList = objCache.Get("cache.categorydata", () =>
        //        {
        //            return db.Categories.Where(x => x.ParentCategoryId == 0 && x.Deleted == false && x.Published).ToList();
        //        });
        //        //var catList = db.Categories.Where(x => x.ParentCategoryId == 0 && x.Deleted == false && x.Published).ToList();

        //        var model = new List<ProjectListModel>();
        //        var catnolist = list.Select(x => x.CATNo.Trim()).ToList();   
        //        var queryData = db.SZ_QueryModule.AsNoTracking().Where(x=> catnolist.Contains(x.CATNo.Trim())).ToList();
        //        var inventoryData = db.SZ_Inventory.AsNoTracking().Where(x => productids.Contains(x.ProductId)).ToList();
        //        var filledFormList = db.SZ_QuoteDetailForm.AsNoTracking().Where(x => x.IsDispatchedEntry.HasValue && x.IsDispatchedEntry.Value).ToList();
        //        foreach (var k in list)
        //        {
        //            ProjectListModel subList = new ProjectListModel();
        //            if (k.SZ_Quotation.SZ_CompanyList.ProjectTeam.HasValue)
        //            {
        //                var projectuser = projectList.Where(x => x.Id == k.SZ_Quotation.SZ_CompanyList.ProjectTeam).FirstOrDefault();
        //                if (projectuser != null)
        //                {
        //                    string customerName = string.Empty;
        //                    var genericAttr = genericData.Where(x => x.EntityId == projectuser.Id).ToList();
        //                    if (genericAttr.Count > 0)
        //                    {
        //                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
        //                    }
        //                    subList.ProjectAssignName = customerName;
        //                }
        //            }

        //            bool isApproveButton = k.IsDispatchApprove.HasValue && k.IsDispatchApprove.Value ? false : true;


        //            subList.ProStatus = k.ProStatus;
        //            subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clssavealltab' data-showapprovebutton='" + isApproveButton + "' />";

        //            if (!string.IsNullOrEmpty(k.COAPath) || !string.IsNullOrEmpty(k.AnalyticalData))
        //            {
        //                subList.ChkSaveRow = "<a href='javascript:void(0)' style = 'color:darkgreen;font-weight: bold;' onclick='UploadDocumentOfProduct(\"" + k.Id + "\")'> Upload </a>";
        //            }
        //            else
        //            {
        //                subList.ChkSaveRow = "<a href='javascript:void(0)' onclick='UploadDocumentOfProduct(\"" + k.Id + "\")'> Upload </a>";
        //            }

        //            var form = filledFormList.Where(x => x.CATNo == k.CATNo).OrderByDescending(x => x.Id).FirstOrDefault();
        //            if (form != null && k.ProStatus == Convert.ToString((int)EnumList.DispatchStatusDDl.QCApproved) && k.ProStatus == Convert.ToString((int)EnumList.DispatchStatusDDl.ReadyforDispatch))
        //            {
        //                subList.ChkSaveRow += " | <a href='/Form/SubmitForm/" + k.Id + "?formid=" + form.Id + "&isdispatch=true'>Edit Form</a>";
        //                subList.ChkSaveRow += " | <a href='/Form/Printform/" + form.Id + "'>Submit & Print Form</a>";
        //            }
        //            subList.ReadyToDeliverScientistStatusId = ReadyToDeliverScientistStatusId;
        //            subList.ProStatus = k.ProStatus;
        //            subList.ProjectType = k.ProjectType;
        //            foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
        //            {
        //                var item = Enum.GetName(typeof(EnumList.ProjectType), r);
        //                var test = r.ToString();
        //                string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
        //                int val = (int)r;
        //                if (Convert.ToString(val) == k.ProjectType)
        //                {
        //                    subList.SelectedProjectType = text;
        //                }
        //            }
        //            foreach (var r in listItems)
        //            {
        //                string selected = string.Empty;
        //                if (r.Value == Convert.ToString(k.ScientistCustomerId))
        //                {
        //                    subList.SelectedScientistName = r.Text;
        //                }
        //            }
        //            subList.MoveProjectDateText = k.MoveProjectDate.HasValue ? k.MoveProjectDate.Value.ToString("dd/MM/yyyy hh:mm tt") : "";
        //            subList.AdditionalBatchNo = k.AdditionalBatchNo;
        //            subList.QuoteId = k.SZ_Quotation.Id;
        //            subList.ProductId = k.ProductId;
        //            subList.ProductName = k.ProductName;
        //            subList.ActivityStatus = k.ActivityStatus;
        //            subList.AdditionalBatchNoText = "<select id='additionalBatch_" + k.Id + "' data-tablename='" + flttableName + "' data-quotationdetailsid='" + k.Id + "' class='ddladditionalbatch addbatch'><option value=''>--Select--</option>";
        //            if (subList.ProductId.HasValue)
        //            {
        //                var proData = productsData.Where(x => x.Id == subList.ProductId).Count();
        //                var proBatchData = inventoryData.Where(x => x.ProductId == subList.ProductId).ToList();
        //                if (proBatchData.Count > 0 && proData > 0)
        //                {
        //                    foreach (var r in proBatchData)
        //                    {
        //                        string qty = CommonOperation.SettleQtyForSPMS(r);
        //                        string text = r.BatchNo + " (" + qty + ")";
        //                        if (r.IsApproved == false)
        //                        {
        //                            text = "*" + text;
        //                        }
        //                        string selected = string.Empty;
        //                        if (r.Id == subList.AdditionalBatchNo)
        //                        {
        //                            selected = "selected ";
        //                            subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
        //                            subList.BatchNo = r.BatchNo;
        //                        }
        //                        subList.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' " + selected + ">" + text + "</option>";
        //                    }
        //                }
        //                var productData = productsData.Where(x => x.Id == subList.ProductId && x.Published == true && x.Deleted == false).FirstOrDefault();
        //                if (productData != null)
        //                {
        //                    subList.IsControlledSubstance = productData.IsControlledSubstance;
        //                    if (!subList.IsControlledSubstance.HasValue
        //                        || subList.IsControlledSubstance == false)
        //                    {
        //                        subList.IsControlledSubstance = productData.IsManuallyControlledSubstance;
        //                    }
        //                }
        //            }
        //            subList.AdditionalBatchNoText += "</select>";
        //            subList.ApprovalCommentsText = "<i class='fa fa-pencil' onclick='approCommentGenerate(\"" + k.Id + "\")' ></i>";
        //            subList.DispatchStatusText = "<select id='dispatchstatus_" + k.Id + "' data-quotationdetailsid='" + k.Id + "' class='adddispatchstatus'><option value=''>--Select--</option>";
        //            foreach (EnumList.DispatchStatusDDl r in Enum.GetValues(typeof(EnumList.DispatchStatusDDl)))
        //            {
        //                string selected = "";
        //                var item = Enum.GetName(typeof(EnumList.DispatchStatusDDl), r);
        //                var test = r.ToString();
        //                string text = SZ_Helper.GetEnumDescription((EnumList.DispatchStatusDDl)(int)r);
        //                int val = (int)r;
        //                if (Convert.ToString(val) == k.ProStatus)
        //                {
        //                    selected = "selected";
        //                    subList.SelectedDispatchStatus = text;
        //                }
        //                subList.DispatchStatusText += "<option value='" + val + "' " + selected + ">" + text + "</option>";

        //            }
        //            subList.DispatchStatusText += "</select>";
        //            subList.RequiredQtyTxt = k.RequiredQty;
        //            subList.IsImageAttach = k.SZ_Quotation.IsImageAttach;
        //            subList.CompanyName = k.SZ_Quotation.SZ_CompanyList.Name;
        //            subList.Email = k.SZ_Quotation.EmailAddress;
        //            subList.PONumber = k.SZ_Quotation.PONo;
        //            subList.Ref = k.SZ_Quotation.Ref;
        //            subList.Remark = k.SZ_Quotation.Remark;
        //            subList.MoveProjectDate = k.MoveProjectDate;
        //            subList.QuoteDetailsId = k.Id;
        //            subList.CASNo = k.CASNo;
        //            string pName = "";
        //            var query = queryData.Where(x => x.CATNo.Trim().ToLower() == k.CATNo.Trim().ToLower()).OrderByDescending(x => x.Id).ToList();
        //            if (query != null && query.Count() > 0)
        //            {
        //                var qlist = query.Select(x => x.QueryNo).ToArray();
        //                if (query.Select(x => x.Status.ToLower()).FirstOrDefault() == "solved" ||
        //                query.Select(x => x.Status.ToLower()).FirstOrDefault() == "close" ||
        //                query.Select(x => x.Status.ToLower()).FirstOrDefault() == "completed")
        //                {
        //                    pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + k.CATNo + "\", \"dispatch\")' title='" + string.Join(", ", qlist) + "' style ='float:right; color: green' ></i>";
        //                }
        //                else
        //                {
        //                    pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + k.CATNo + "\", \"dispatch\")' title='" + string.Join(", ", qlist) + "' style ='float:right' ></i>";
        //                }
        //            }
        //            subList.CATNo = k.CATNo + "" + pName;
        //            subList.CreatedDate = k.CreatedDate;
        //            subList.ImagePath = k.ImagePath;
        //            subList.IsUploadServer = k.IsUploadServer;
        //            subList.LeadTime = k.LeadTime;
        //            subList.Price = k.Price;
        //            subList.QuoteId = k.QuoteId;
        //            subList.ProjectType = k.ProjectType;
        //            subList.ScientistCustomerId = k.ScientistCustomerId;
        //            subList.RequiredQty = k.RequiredQty;
        //            subList.ProjectStatus = k.ProjectStatus;
        //            subList.IsOnHold = k.IsOnHold;
        //            if (k.ProjectStatus != null)
        //            {
        //                subList.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
        //            }
        //            subList.ScientistStatus = k.ScientistStatus;
        //            subList.BatchCode1 = k.BatchCode1;
        //            subList.BatchCode2 = k.BatchCode2;
        //            subList.Qty1 = k.Qty1;
        //            subList.Qty2 = k.Qty2;
        //            subList.EstimateCompleteDate = k.EstimateCompleteDate;
        //            if (k.EstimateCompleteDate.HasValue)
        //            {
        //                subList.EstimateCompleteDateText = k.EstimateCompleteDate.Value.ToShortDateString();
        //            }
        //            subList.MoveToDispatch = k.MoveToDispatch;
        //            subList.MoveToProject = k.MoveToProject;
        //            subList.Remark = k.Remark;
        //            subList.SrPo = k.SrPo;
        //            subList.AdminScientistStatus = k.AdminScientistStatus;
        //            subList.LastStatus = k.LastStatus;
        //            subList.InvoiceNo = k.InvoiceNo;
        //            subList.InvoiceRemark = k.InvoiceRemark;
        //            subList.MoveProjectDate = k.MoveProjectDate;
        //            subList.ClientStatusText = "<select id='clientstatus_" + k.Id + "' class='clsClientStatus' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
        //            subList.ClientStatusText += "<option value='In progress'>In progress</option>";
        //            subList.ClientStatusText += "<option value='COA/Data Sent'>COA/Data Sent</option>";
        //            subList.ClientStatusText += "<option value='COA/Data Approved'>COA/Data Approved</option>";
        //            subList.ClientStatusText += "<option value='COA/Data Correction'>COA/Data Correction</option>";
        //            //subList.ClientStatusText += "<option value='Dispatched'>Dispatched</option>";
        //            subList.ClientStatusText += "</select>";
        //            subList.ClientStatus = k.ClientStatus;
        //            subList.ClientRemark = k.ClientRemark;
        //            subList.ClientAddress = k.ClientAddress;
        //            if (!string.IsNullOrEmpty(k.COAPath))
        //            {
        //                subList.COADownloadLink = "<a href='" + k.COAPath.Replace("..", "") + "' download='COA-" + subList.BatchNo + "'><i class='fa fa-download'></i></a>";
        //            }
        //            if (!string.IsNullOrEmpty(k.AnalyticalData))
        //            {
        //                subList.AnalyticalDataLink = "<a href='" + k.AnalyticalData.Replace("..", "") + "' download='AnalyticalData-" + subList.BatchNo + "'><i class='fa fa-download'></i></a>";
        //            }
        //            subList.ClientRemarkText = "<a data-toggle='modal' data-target='#clientremarkModal' href='/Form/AddClientRemark/" + k.Id + "?isClientSection=false'><i class='fa fa-pencil'></i></a>";
        //            subList.AttachedDataList = k.AttachedDataList;

        //            string coaText = "";

        //            coaText = "<select id='coa_" + k.Id + "' class='addcoa'><option value=''>--Select--</option>";
        //            int bId = k.AdditionalBatchNo.HasValue ? k.AdditionalBatchNo.Value : 0;
        //            if (bId != 0)
        //            {
        //                var mastercoa = masterCOAData.Where(x => x.BatchId == bId).FirstOrDefault();
        //                if (mastercoa != null)
        //                {
        //                    subList.BatchNo = mastercoa.BatchNo;
        //                    var listchildcoa = childcoadata.Where(x => x.MasterCOAID == mastercoa.Id).ToList();
        //                    if (listchildcoa != null && listchildcoa.Count > 0)
        //                    {
        //                        foreach (var ccoa in listchildcoa)
        //                        {
        //                            if (k.COAId == ccoa.Id)
        //                            {
        //                                coaText += "<option value='" + ccoa.Id.ToString() + "' data-value='" + k.AdditionalBatchNo + "' selected>" + ccoa.RefNo + "</option>";
        //                            }
        //                            else
        //                            {
        //                                coaText += "<option value='" + ccoa.Id.ToString() + "' data-value='" + k.AdditionalBatchNo + "'>" + ccoa.RefNo + "</option>";
        //                            }
        //                        }
        //                    }
        //                }
        //            }
        //            subList.COAText = coaText;
        //            if (k.IsDispatchApprove.HasValue && k.IsDispatchApprove.Value)
        //            {
        //                subList.LastRowText = "<i class='fa fa-check'></i>";
        //            }
        //            else
        //            {
        //                subList.LastRowText = "<i class='fa fa-remove'></i>";
        //            }
        //            subList.IsDispatchApprove = k.IsDispatchApprove;
        //            subList.Reason = k.Reason;
        //            subList.SuggChemName = k.SZ_Quotation.SuggChemName;
        //            if (k.LastUploadDate.HasValue)
        //            {
        //                subList.LastUploadDateStr = k.LastUploadDate.Value.ToShortDateString();
        //            }
        //            if (!string.IsNullOrEmpty(k.SZ_Quotation.Attachment))
        //            {
        //                subList.Attachment = "<a href='javascript: void(0)' onclick='attachment(" + k.QuoteId + ")'> <i class='fa fa-paperclip'></i></a>";
        //            }
        //            subList.ReasonText = "<input id='reason_" + k.Id + "' type='text' value='" + k.Reason + "' title='" + k.Reason + "'  style='width:200px' />";
        //            subList.CountryType = k.SZ_Quotation.CountryType;
        //            subList.OrderRemark = k.OrderRemark;
        //            subList.OrderRemarkText = "<input id='orderremark_" + k.Id + "' type='text' value='" + k.OrderRemark + "' title='" + k.OrderRemark + "'  style='width:200px' />";
        //            subList.EstimateCompleteDate = k.EstimateCompleteDate;
        //            subList.EstimateCompleteDateText = "<input id='esticompleteDate_" + k.Id + "' data-value='" + k.EstimateCompleteDate + "' type='text' class='datepicker'  style='width:80px' />";
        //            subList.ChangeBatch = "<i class='fa fa-clone' title='Change Batch No' onclick='GetAllBatchNo(" + k.ProductId + "," + k.Id + ")' ></i>";


        //            var formid = quotedetailsformdata.Where(x => x.QuoteDetailsId == k.Id).Select(x => x.FormId).FirstOrDefault();
        //            var qdsubmitform = qdsubmitformList.Where(x => x.Id == formid).FirstOrDefault();
        //            if (qdsubmitform != null)
        //            {
        //                if (!string.IsNullOrEmpty(qdsubmitform.SpectralDataAttachment))
        //                {
        //                    subList.SpectralData = "<a href='" + qdsubmitform.SpectralDataAttachment.Replace("..", "") + "' download='SpectralData-" + subList.BatchNo + "'><i class='fa fa-download'></i></a>";
        //                }
        //            }
        //            subList.ActivityStatusText = "<select id='activitystatus_" + k.Id + "' class='clsActivityStatus' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";

        //            if (k.ActivityStatus == "Invoice Sent")
        //            {
        //                subList.ActivityStatusText += "<option value='Invoice Sent' selected>Invoice Sent</option>";
        //            }
        //            else
        //            {
        //                subList.ActivityStatusText += "<option value='Invoice Sent'>Invoice Sent</option>";
        //            }
        //            if (k.ActivityStatus == "PDC Awaited")
        //            {
        //                subList.ActivityStatusText += "<option value='PDC Awaited' selected>PDC Awaited</option>";
        //            }
        //            else
        //            {
        //                subList.ActivityStatusText += "<option value='PDC Awaited'>PDC Awaited</option>";
        //            }
        //            if (k.ActivityStatus == "Advance Payment")
        //            {
        //                subList.ActivityStatusText += "<option value='Advance Payment' selected>Advance Payment</option>";
        //            }
        //            else
        //            {
        //                subList.ActivityStatusText += "<option value='Advance Payment'>Advance Payment</option>";
        //            }
        //            if (k.ActivityStatus == "Payment Due")
        //            {
        //                subList.ActivityStatusText += "<option value='Payment Due' selected>Payment Due</option>";
        //            }
        //            else
        //            {
        //                subList.ActivityStatusText += "<option value='Payment Due'>Payment Due</option>";
        //            }
        //            subList.ActivityStatusText += "</select>";

        //            model.Add(subList);
        //        }
        //        model = model.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).ToList();
        //        //Search
        //        if (!string.IsNullOrEmpty(searchValue))
        //        {
        //            searchValue = searchValue.ToLower().Trim();
        //            model = model.Where(m => (m.PONumber != null && m.PONumber.ToLower().Contains(searchValue))
        //                                || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
        //                                || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
        //                                || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
        //                                || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
        //                                || (m.Reason != null && m.Reason.ToLower().Contains(searchValue))).ToList();
        //        }
        //        if (!string.IsNullOrEmpty(fltprostatusItem))
        //        {
        //            model = model.Where(x => x.ProStatus == fltprostatusItem).ToList();
        //        }
        //        if (!string.IsNullOrEmpty(fltactivitystatusItem))
        //        {
        //            model = model.Where(x => x.ActivityStatus == fltactivitystatusItem).ToList();
        //        }
        //        if (!string.IsNullOrEmpty(fltprotypeItem))
        //        {
        //            model = model.Where(x => x.ProjectType == fltprotypeItem).ToList();
        //        }

        //        if (!string.IsNullOrEmpty(searchby) && !string.IsNullOrEmpty(searchbyvalue))
        //        {
        //            searchbyvalue = searchbyvalue.ToLower();
        //            if (searchby == "quoteid")
        //            {
        //                model = model.Where(x => x.Ref.ToLower().Contains(searchbyvalue)).ToList();
        //            }
        //            if (searchby == "ponumber")
        //            {
        //                model = model.Where(x => x.PONumber.ToLower().Contains(searchbyvalue)).ToList();
        //            }
        //            if (searchby == "company")
        //            {
        //                model = model.Where(x => x.CompanyName.ToLower().Contains(searchbyvalue)).ToList();
        //            }
        //            if (searchby == "productname")
        //            {
        //                model = model.Where(x => x.ProductName.ToLower().Contains(searchbyvalue)).ToList();
        //            }
        //            if (searchby == "cas")
        //            {
        //                model = model.Where(x => x.CASNo != null ? x.CASNo.ToLower().Contains(searchbyvalue) : false).ToList();
        //            }
        //            if (searchby == "cat")
        //            {
        //                model = model.Where(x => x.CATNo != null ? x.CATNo.ToLower().Contains(searchbyvalue) : false).ToList();
        //            }
        //            if (searchby == "batchno")
        //            {
        //                model = model.Where(x => x.BatchNo != null ? x.BatchNo.ToLower().Contains(searchbyvalue) : false).ToList();
        //            }
        //            if (searchby == "teamleader")
        //            {
        //                model = model.Where(x => !string.IsNullOrEmpty(x.SelectedScientistName) ? x.SelectedScientistName.ToLower().Contains(searchbyvalue) : false).ToList();
        //            }
        //        }
        //        //total number of rows count   
        //        recordsTotal = model.Count();
        //        //Paging   
        //        var data = model.Skip(skip).Take(pageSize).ToList();
        //        return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
        //    }
        //    catch (Exception ex)
        //    {
        //        string errortext = "Line: " + ex.LineNumber();
        //        System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

        //        throw ex;
        //    }
        //}

        //[HttpPost]
        //public ActionResult LoadFormDataInDispatchedData()
        //{
        //    try
        //    {
        //        var draw = Request.Form.GetValues("draw").FirstOrDefault();
        //        var start = Request.Form.GetValues("start").FirstOrDefault();
        //        var length = Request.Form.GetValues("length").FirstOrDefault();
        //        //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
        //        //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
        //        var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();

        //        //Paging Size (10,20,50,100)
        //        int pageSize = length != null ? Convert.ToInt32(length) : 0;
        //        int skip = start != null ? Convert.ToInt32(start) : 0;
        //        int recordsTotal = 0;

        //        string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);

        //        // Getting all Customer data  
        //        var list = (from i in db.SZ_Quotation
        //                    join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
        //                    join t4 in db.SZ_QuoteDetails_Form on t2.Id equals t4.QuoteDetailsId
        //                    join t3 in db.SZ_QuoteDetailForm on t4.FormId equals t3.Id
        //                    where t2.MoveToProject == true && string.IsNullOrEmpty(t2.TrackingNo) && (t2.IsOnHold == false || t2.IsOnHold == null)
        //                    && (t2.ProjectType != inhouseProjectType || t2.ProjectType == null)
        //                    && t3.IsDispatchedEntry == true
        //                    orderby t3.CreatedDate descending
        //                    select t2).Distinct().OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo);

        //        var listItems = new List<SelectListItem>();
        //        MemoryCacheManager objCache = new MemoryCacheManager();
        //        var genericData = objCache.Get("cache.genericData", () =>
        //        {
        //            return db.GenericAttributes.AsNoTracking().Where(x => x.KeyGroup == "Customer").ToList();
        //        });

        //        var scienList = objCache.Get("cache.GetScientistId", () =>
        //        {
        //            return db.GetScientistId().ToList();
        //        });

        //        scienList.ForEach(term =>
        //        {
        //            string customerName = string.Empty;
        //            var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
        //            if (genericAttr.Count > 0)
        //            {
        //                customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
        //            }
        //            listItems.Add(new SelectListItem
        //            {
        //                Text = customerName,
        //                Value = term.ToString()
        //            });
        //        });
        //        var productids = list.Select(x => x.ProductId).ToList();

        //        var masterCOAData = objCache.Get("cache.mastercoadata", () =>
        //        {
        //            return db.SZ_MasterCOA.AsNoTracking().ToList();
        //        });
        //        var childcoadata = objCache.Get("cache.childcoadata", () =>
        //        {
        //            return db.SZ_ChildCOA.AsNoTracking().ToList();
        //        });
        //        var productsData = objCache.Get("cache.productsdata", () =>
        //        {
        //            return db.Products.Where(x => x.Published == true && x.Deleted == false).ToList();
        //        });
        //        var ReadyToDeliverScientistStatusId = objCache.Get("cache.ReadyToDeliverScientistStatusId", () =>
        //        {
        //            return db.SZ_ScientistStatus.AsNoTracking().Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
        //        });
        //        var inventoryData = objCache.Get("cache.inventoryData", () =>
        //        {
        //            return db.SZ_Inventory.AsNoTracking().ToList();
        //        });
        //        var catList = objCache.Get("cache.categorydata", () =>
        //        {
        //            return db.Categories.AsNoTracking().Where(x => x.ParentCategoryId == 0 && x.Deleted == false && x.Published).ToList();
        //        });
        //        masterCOAData = masterCOAData.Where(x => productids.Contains(x.ProductId)).ToList();
        //        var productsdata = productsData.Where(x => productids.Contains(x.Id) && x.Deleted == false && x.Published == true).ToList();
        //        inventoryData = inventoryData.Where(x => productids.Contains(x.ProductId)).ToList();
        //        var mastercoaids = masterCOAData.Select(x => x.Id).ToList();
        //        childcoadata = childcoadata.Where(x => mastercoaids.Contains(x.MasterCOAID.Value)).ToList();
        //        var model = new List<ProjectListModel>();
        //        var queryData = db.SZ_QueryModule.AsNoTracking().AsQueryable();
        //        var filledFormList = db.SZ_QuoteDetailForm.Where(x => x.IsDispatchedEntry.HasValue && x.IsDispatchedEntry.Value).ToList();
        //        foreach (var k in list)
        //        {
        //            bool isApproveButton = k.IsDispatchApprove.HasValue && k.IsDispatchApprove.Value ? false : true;

        //            ProjectListModel subList = new ProjectListModel();
        //            subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clssavealltab' data-showapprovebutton='" + isApproveButton + "' />";
        //            string correctionstatus = Convert.ToString((int)EnumList.ApprovedStatus.QCCorrection);
        //            string approvalstatus = Convert.ToString((int)EnumList.ApprovedStatus.QCApproved);
        //            var form = filledFormList.Where(x => x.CATNo.Trim() == k.CATNo.Trim()).OrderByDescending(x => x.Id).FirstOrDefault();
        //            if (form != null)
        //            {
        //                subList.ApprovedFormStatus = form.ApprovalStatus;
        //                subList.ChkSaveRow += " <a href='/Form/SubmitForm/" + k.Id + "?formid=" + form.Id + "&isdispatch=true'>Edit Form</a>";
        //                if (form.ApprovalStatus == approvalstatus)
        //                {
        //                    subList.ChkSaveRow += " | <a href='/Form/Printform/" + form.Id + "'>Submit & Print Form</a>";
        //                }
        //            }
        //            subList.ReadyToDeliverScientistStatusId = ReadyToDeliverScientistStatusId;
        //            subList.ProjectType = k.ProjectType;
        //            foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
        //            {
        //                var item = Enum.GetName(typeof(EnumList.ProjectType), r);
        //                var test = r.ToString();
        //                string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
        //                int val = (int)r;
        //                if (Convert.ToString(val) == k.ProjectType)
        //                {
        //                    subList.SelectedProjectType = text;
        //                }
        //            }
        //            foreach (var r in listItems)
        //            {
        //                string selected = string.Empty;
        //                if (r.Value == Convert.ToString(k.ScientistCustomerId))
        //                {
        //                    subList.SelectedScientistName = r.Text;
        //                }
        //            }
        //            subList.MoveProjectDateText = k.MoveProjectDate.HasValue ? k.MoveProjectDate.Value.ToString("dd/MM/yyyy hh:mm tt") : "";
        //            subList.AdditionalBatchNo = k.AdditionalBatchNo;
        //            subList.QuoteId = k.SZ_Quotation.Id;
        //            subList.ProductId = k.ProductId;
        //            subList.ProductName = k.ProductName;
        //            subList.ActivityStatus = k.ActivityStatus;
        //            subList.AdditionalBatchNoText = "<select id='additionalBatch_" + k.Id + "' data-quotationdetailsid='" + k.Id + "' class='ddladditionalbatch addbatch'><option value=''>--Select--</option>";
        //            if (subList.ProductId.HasValue)
        //            {
        //                var proData = productsdata.Where(x => x.Id == subList.ProductId && x.Published == true && x.Deleted == false).Count();
        //                var productData = productsdata.Where(x => x.Id == subList.ProductId && x.Published == true && x.Deleted == false).FirstOrDefault();
        //                if (productData != null)
        //                {
        //                    subList.IsControlledSubstance = productData.IsControlledSubstance;
        //                    if (!subList.IsControlledSubstance.HasValue
        //                        || subList.IsControlledSubstance == false)
        //                    {
        //                        subList.IsControlledSubstance = productData.IsManuallyControlledSubstance;
        //                    }
        //                }

        //                var proBatchData = inventoryData.Where(x => x.ProductId == subList.ProductId).ToList();
        //                if (proBatchData.Count > 0 && proData > 0)
        //                {
        //                    foreach (var r in proBatchData)
        //                    {
        //                        string qty = CommonOperation.SettleQtyForSPMS(r);
        //                        string text = r.BatchNo + " (" + qty + ")";
        //                        if (r.IsApproved == false)
        //                        {
        //                            text = "*" + text;
        //                        }
        //                        string selected = string.Empty;
        //                        if (r.Id == subList.AdditionalBatchNo)
        //                        {
        //                            selected = "selected ";
        //                            subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
        //                            subList.BatchNo = r.BatchNo;
        //                        }
        //                        subList.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' " + selected + ">" + text + "</option>";
        //                    }
        //                }
        //            }
        //            subList.AdditionalBatchNoText += "</select>";
        //            subList.RequiredQtyTxt = k.RequiredQty;
        //            subList.IsImageAttach = k.SZ_Quotation.IsImageAttach;
        //            subList.CompanyName = k.SZ_Quotation.SZ_CompanyList.Name;
        //            subList.Email = k.SZ_Quotation.EmailAddress;
        //            subList.PONumber = k.SZ_Quotation.PONo;
        //            subList.Ref = k.SZ_Quotation.Ref;
        //            subList.Remark = k.SZ_Quotation.Remark;
        //            subList.MoveProjectDate = k.MoveProjectDate;
        //            subList.QuoteDetailsId = k.Id;
        //            subList.CASNo = k.CASNo;
        //            string pName = "";
        //            var query = queryData.Where(x => x.CATNo.Trim().ToLower() == k.CATNo.Trim().ToLower()).OrderByDescending(x => x.Id).ToList();
        //            if (query != null && query.Count() > 0)
        //            {
        //                var qlist = query.Select(x => x.QueryNo).ToArray();
        //                if (query.Select(x => x.Status.ToLower()).FirstOrDefault() == "solved" ||
        //                query.Select(x => x.Status.ToLower()).FirstOrDefault() == "close" ||
        //                query.Select(x => x.Status.ToLower()).FirstOrDefault() == "completed")
        //                {
        //                    pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + k.CATNo + "\", \"dispatch\")' title='" + string.Join(", ", qlist) + "' style ='float:right; color: green' ></i>";
        //                }
        //                else
        //                {
        //                    pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + k.CATNo + "\", \"dispatch\")' title='" + string.Join(", ", qlist) + "' style ='float:right' ></i>";
        //                }
        //            }
        //            subList.CATNo = k.CATNo + "" + pName;
        //            subList.CreatedDate = k.CreatedDate;
        //            subList.ImagePath = k.ImagePath;
        //            subList.IsUploadServer = k.IsUploadServer;
        //            subList.LeadTime = k.LeadTime;
        //            subList.Price = k.Price;
        //            subList.QuoteId = k.QuoteId;
        //            subList.ProjectType = k.ProjectType;
        //            subList.ScientistCustomerId = k.ScientistCustomerId;
        //            subList.RequiredQty = k.RequiredQty;
        //            subList.ProjectStatus = k.ProjectStatus;
        //            subList.IsOnHold = k.IsOnHold;
        //            if (k.ProjectStatus != null)
        //            {
        //                subList.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
        //            }
        //            subList.ScientistStatus = k.ScientistStatus;
        //            subList.BatchCode1 = k.BatchCode1;
        //            subList.BatchCode2 = k.BatchCode2;
        //            subList.Qty1 = k.Qty1;
        //            subList.Qty2 = k.Qty2;
        //            subList.EstimateCompleteDate = k.EstimateCompleteDate;
        //            if (k.EstimateCompleteDate.HasValue)
        //            {
        //                subList.EstimateCompleteDateText = k.EstimateCompleteDate.Value.ToShortDateString();
        //            }
        //            subList.MoveToDispatch = k.MoveToDispatch;
        //            subList.MoveToProject = k.MoveToProject;
        //            subList.Remark = k.Remark;
        //            subList.SrPo = k.SrPo;
        //            subList.AdminScientistStatus = k.AdminScientistStatus;
        //            subList.LastStatus = k.LastStatus;
        //            subList.InvoiceNo = k.InvoiceNo;
        //            subList.InvoiceRemark = k.InvoiceRemark;

        //            subList.MoveProjectDate = k.MoveProjectDate;
        //            subList.ClientStatusText = "<select id='clientstatus_" + k.Id + "' class='clsClientStatus' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
        //            subList.ApprovalCommentsText = "<i class='fa fa-pencil' onclick='approCommentGenerate(\"" + k.Id + "\")' ></i>";
        //            subList.ClientStatusText += "<option value='In progress'>In progress</option>";
        //            subList.ClientStatusText += "<option value='COA/Data Sent'>COA/Data Sent</option>";
        //            subList.ClientStatusText += "<option value='COA/Data Approved'>COA/Data Approved</option>";
        //            subList.ClientStatusText += "<option value='COA/Data Correction'>COA/Data Correction</option>";
        //            //subList.ClientStatusText += "<option value='Dispatched'>Dispatched</option>";
        //            subList.ClientStatusText += "</select>";
        //            subList.ClientStatus = k.ClientStatus;
        //            subList.ClientRemark = k.ClientRemark;
        //            subList.ClientAddress = k.ClientAddress;
        //            if (!string.IsNullOrEmpty(k.COAPath))
        //            {
        //                subList.COADownloadLink = "<a href='" + k.COAPath.Replace("..", "") + "' download='COA-" + subList.BatchNo + "'><i class='fa fa-download'></i></a>";
        //            }
        //            if (!string.IsNullOrEmpty(k.AnalyticalData))
        //            {
        //                subList.AnalyticalDataLink = "<a href='" + k.AnalyticalData.Replace("..", "") + "' download='AnalyticalData-" + subList.BatchNo + "'><i class='fa fa-download'></i></a>";
        //            }
        //            subList.ClientRemarkText = "<a data-toggle='modal' data-target='#clientremarkModal' href='/Form/AddClientRemark/" + k.Id + "?isClientSection=false'><i class='fa fa-pencil'></i></a>";
        //            subList.AttachedDataList = k.AttachedDataList;

        //            string coaText = "";

        //            coaText = "<select id='coa_" + k.Id + "' class='addcoa'><option value=''>--Select--</option>";
        //            int bId = k.AdditionalBatchNo.HasValue ? k.AdditionalBatchNo.Value : 0;
        //            if (bId != 0)
        //            {
        //                var mastercoa = masterCOAData.Where(x => x.BatchId == bId).FirstOrDefault();
        //                if (mastercoa != null)
        //                {
        //                    subList.BatchNo = mastercoa.BatchNo;
        //                    var listchildcoa = childcoadata.Where(x => x.MasterCOAID == mastercoa.Id).ToList();
        //                    if (listchildcoa != null && listchildcoa.Count > 0)
        //                    {
        //                        foreach (var ccoa in listchildcoa)
        //                        {
        //                            if (k.COAId == ccoa.Id)
        //                            {
        //                                coaText += "<option value='" + ccoa.Id.ToString() + "' data-value='" + k.AdditionalBatchNo + "' selected>" + ccoa.RefNo + "</option>";
        //                            }
        //                            else
        //                            {
        //                                coaText += "<option value='" + ccoa.Id.ToString() + "' data-value='" + k.AdditionalBatchNo + "'>" + ccoa.RefNo + "</option>";
        //                            }
        //                        }

        //                    }
        //                }
        //            }
        //            subList.COAText = coaText;

        //            if (k.IsDispatchApprove.HasValue && k.IsDispatchApprove.Value)
        //            {
        //                subList.LastRowText = "<i class='fa fa-check'></i>";
        //            }
        //            else
        //            {
        //                subList.LastRowText = "<i class='fa fa-remove'></i>";
        //            }
        //            subList.IsDispatchApprove = k.IsDispatchApprove;
        //            subList.Reason = k.Reason;
        //            subList.SuggChemName = k.SZ_Quotation.SuggChemName;
        //            if (k.LastUploadDate.HasValue)
        //            {
        //                subList.LastUploadDateStr = k.LastUploadDate.Value.ToShortDateString();
        //            }
        //            if (!string.IsNullOrEmpty(k.SZ_Quotation.Attachment))
        //            {
        //                subList.Attachment = "<a href='javascript: void(0)' onclick='attachment(" + k.QuoteId + ")'> <i class='fa fa-paperclip'></i></a>";
        //            }

        //            subList.ReasonText = k.Reason;

        //            //subList.ReasonText = "<input id='reason_" + k.Id + "' type='text' value='" + k.Reason + "' title='" + k.Reason + "'  style='width:200px' />";
        //            subList.CountryType = k.SZ_Quotation.CountryType;

        //            subList.OrderRemark = k.OrderRemark;
        //            subList.OrderRemarkText = "<input id='orderremark_" + k.Id + "' type='text' value='" + k.OrderRemark + "' title='" + k.OrderRemark + "'  style='width:200px' />";
        //            subList.EstimateCompleteDate = k.EstimateCompleteDate;
        //            //subList.EstimateCompleteDateText = "<input id='esticompleteDate_" + k.Id + "' data-value='" + k.EstimateCompleteDate + "' type='text' class='datepicker'  style='width:80px' />";
        //            subList.ChangeBatch = "<i class='fa fa-clone' title='Change Batch No' onclick='GetAllBatchNo(" + k.ProductId + "," + k.Id + ")' ></i>";
        //            model.Add(subList);
        //        }
        //        model = model.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).ThenBy(x => x.SrPo).ToList();
        //        //Search
        //        if (!string.IsNullOrEmpty(searchValue))
        //        {
        //            searchValue = searchValue.ToLower().Trim();
        //            model = model.Where(m => (m.PONumber != null && m.PONumber.ToLower().Contains(searchValue))
        //                                || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
        //                                || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
        //                                || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
        //                                || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))).ToList();
        //        }

        //        //total number of rows count   
        //        recordsTotal = model.Count();
        //        //Paging   
        //        var data = model.Skip(skip).Take(pageSize).ToList();
        //        return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
        //    }
        //    catch (Exception ex)
        //    {
        //        throw ex;
        //    }

        //}

        [HttpPost]
        public ActionResult LoadFormDataInDispatchedData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();

                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;

                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);

                // Getting all Customer data  
                var list = (from i in db.SZ_Quotation
                            join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                            join t4 in db.SZ_QuoteDetails_Form on t2.Id equals t4.QuoteDetailsId
                            join t3 in db.SZ_QuoteDetailForm on t4.FormId equals t3.Id
                            where t2.MoveToProject == true && string.IsNullOrEmpty(t2.TrackingNo) && (t2.IsOnHold == false || t2.IsOnHold == null)
                            && (t2.ProjectType != inhouseProjectType || t2.ProjectType == null)
                            && t3.IsDispatchedEntry == true
                            orderby t3.CreatedDate descending
                            select t2).Distinct().OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo);

                var listItems = new List<SelectListItem>();
                MemoryCacheManager objCache = new MemoryCacheManager();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.AsNoTracking().Where(x => x.KeyGroup == "Customer").ToList();
                });

                var scienList = objCache.Get("cache.GetScientistId", () =>
                {
                    return db.GetScientistId().ToList();
                });

                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                });
                var productids = list.Select(x => x.ProductId).ToList();

                var masterCOAData = objCache.Get("cache.mastercoadata", () =>
                {
                    return db.SZ_MasterCOA.AsNoTracking().ToList();
                });
                var childcoadata = objCache.Get("cache.childcoadata", () =>
                {
                    return db.SZ_ChildCOA.AsNoTracking().ToList();
                });
                var productsData = objCache.Get("cache.productsdata", () =>
                {
                    return db.Products.Where(x => x.Published == true && x.Deleted == false).ToList();
                });
                var ReadyToDeliverScientistStatusId = objCache.Get("cache.ReadyToDeliverScientistStatusId", () =>
                {
                    return db.SZ_ScientistStatus.AsNoTracking().Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                });
                var inventoryData = objCache.Get("cache.inventoryData", () =>
                {
                    return db.SZ_Inventory.AsNoTracking().ToList();
                });
                var catList = objCache.Get("cache.categorydata", () =>
                {
                    return db.Categories.AsNoTracking().Where(x => x.ParentCategoryId == 0 && x.Deleted == false && x.Published).ToList();
                });
                masterCOAData = masterCOAData.Where(x => productids.Contains(x.ProductId)).ToList();
                var productsdata = productsData.Where(x => productids.Contains(x.Id) && x.Deleted == false && x.Published == true).ToList();
                inventoryData = inventoryData.Where(x => productids.Contains(x.ProductId)).ToList();
                var mastercoaids = masterCOAData.Select(x => x.Id).ToList();
                childcoadata = childcoadata.Where(x => mastercoaids.Contains(x.MasterCOAID.Value)).ToList();
                var model = new List<ProjectListModel>();
                var queryData = db.SZ_QueryModule.AsNoTracking().AsQueryable();
                var filledFormList = db.SZ_QuoteDetailForm.Where(x => x.IsDispatchedEntry.HasValue && x.IsDispatchedEntry.Value).ToList();

                //Search
                var mainlist = list.ToList();
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    mainlist = mainlist.Where(m => (m.SZ_Quotation.PONo != null && m.SZ_Quotation.PONo.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))).ToList();
                }
                //total number of rows count   
                recordsTotal = mainlist.Count;
                mainlist = mainlist.Skip(skip).Take(pageSize).ToList();

                foreach (var k in mainlist)
                {
                    bool isApproveButton = k.IsDispatchApprove.HasValue && k.IsDispatchApprove.Value ? false : true;

                    ProjectListModel subList = new ProjectListModel();
                    subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clssavealltab' data-showapprovebutton='" + isApproveButton + "' />";
                    string correctionstatus = Convert.ToString((int)EnumList.ApprovedStatus.QCCorrection);
                    string approvalstatus = Convert.ToString((int)EnumList.ApprovedStatus.QCApproved);
                    var form = filledFormList.Where(x => x.CATNo.Trim() == k.CATNo.Trim()).OrderByDescending(x => x.Id).FirstOrDefault();
                    if (form != null)
                    {
                        subList.ApprovedFormStatus = form.ApprovalStatus;
                        subList.ChkSaveRow += " <a href='/Form/SubmitForm/" + k.Id + "?formid=" + form.Id + "&isdispatch=true'>Edit Form</a>";
                        if (form.ApprovalStatus == approvalstatus)
                        {
                            subList.ChkSaveRow += " | <a href='/Form/Printform/" + form.Id + "'>Submit & Print Form</a>";
                        }
                    }
                    subList.ReadyToDeliverScientistStatusId = ReadyToDeliverScientistStatusId;
                    subList.ProjectType = k.ProjectType;
                    foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ProjectType), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
                        int val = (int)r;
                        if (Convert.ToString(val) == k.ProjectType)
                        {
                            subList.SelectedProjectType = text;
                        }
                    }
                    foreach (var r in listItems)
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.ScientistCustomerId))
                        {
                            subList.SelectedScientistName = r.Text;
                        }
                    }
                    subList.MoveProjectDateText = k.MoveProjectDate.HasValue ? k.MoveProjectDate.Value.ToString("dd/MM/yyyy hh:mm tt") : "";
                    subList.AdditionalBatchNo = k.AdditionalBatchNo;
                    subList.QuoteId = k.SZ_Quotation.Id;
                    subList.ProductId = k.ProductId;
                    subList.ProductName = k.ProductName;
                    subList.ActivityStatus = k.ActivityStatus;
                    subList.AdditionalBatchNoText = "<select id='additionalBatch_" + k.Id + "' data-quotationdetailsid='" + k.Id + "' class='ddladditionalbatch addbatch'><option value=''>--Select--</option>";
                    if (subList.ProductId.HasValue)
                    {
                        var proData = productsdata.Where(x => x.Id == subList.ProductId && x.Published == true && x.Deleted == false).Count();
                        var productData = productsdata.Where(x => x.Id == subList.ProductId && x.Published == true && x.Deleted == false).FirstOrDefault();
                        if (productData != null)
                        {
                            subList.IsControlledSubstance = productData.IsControlledSubstance;
                            if (!subList.IsControlledSubstance.HasValue
                                || subList.IsControlledSubstance == false)
                            {
                                subList.IsControlledSubstance = productData.IsManuallyControlledSubstance;
                            }
                        }

                        var proBatchData = inventoryData.Where(x => x.ProductId == subList.ProductId).ToList();
                        if (proBatchData.Count > 0 && proData > 0)
                        {
                            foreach (var r in proBatchData)
                            {
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }
                                string selected = string.Empty;
                                if (r.Id == subList.AdditionalBatchNo)
                                {
                                    selected = "selected ";
                                    subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
                                    subList.BatchNo = r.BatchNo;
                                }
                                subList.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' " + selected + ">" + text + "</option>";
                            }
                        }
                    }
                    subList.AdditionalBatchNoText += "</select>";
                    subList.RequiredQtyTxt = k.RequiredQty;
                    subList.IsImageAttach = k.SZ_Quotation.IsImageAttach;
                    subList.CompanyName = k.SZ_Quotation.SZ_CompanyList.Name;
                    subList.Email = k.SZ_Quotation.EmailAddress;
                    subList.PONumber = k.SZ_Quotation.PONo;
                    subList.Ref = k.SZ_Quotation.Ref;
                    subList.Remark = k.SZ_Quotation.Remark;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.QuoteDetailsId = k.Id;
                    subList.CASNo = k.CASNo;
                    string pName = "";
                    var query = queryData.Where(x => x.CATNo.Trim().ToLower() == k.CATNo.Trim().ToLower()).OrderByDescending(x => x.Id).ToList();
                    if (query != null && query.Count() > 0)
                    {
                        var qlist = query.Select(x => x.QueryNo).ToArray();
                        if (query.Select(x => x.Status.ToLower()).FirstOrDefault() == "solved" ||
                        query.Select(x => x.Status.ToLower()).FirstOrDefault() == "close" ||
                        query.Select(x => x.Status.ToLower()).FirstOrDefault() == "completed")
                        {
                            pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + k.CATNo + "\", \"dispatch\")' title='" + string.Join(", ", qlist) + "' style ='float:right; color: green' ></i>";
                        }
                        else
                        {
                            pName = "<i class='clstooltip fa fa-info-circle' onclick='GetQueryDataFromCatNo(\"" + k.CATNo + "\", \"dispatch\")' title='" + string.Join(", ", qlist) + "' style ='float:right' ></i>";
                        }
                    }

                    subList.IsConversionReport = k.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    var impstr = "";
                    if (subList.IsConversionReport.HasValue && subList.IsConversionReport.Value)
                    {
                        impstr += "<img src='/img/important.jpg' width='15px' height='15px' />";
                    }

                    subList.CATNo = k.CATNo + "" + pName + "" + impstr + " " + CommonOperation.GetMatchingTagHTML(k, "Dispatch");
                    subList.CreatedDate = k.CreatedDate;
                    subList.ImagePath = k.ImagePath;
                    subList.IsUploadServer = k.IsUploadServer;
                    subList.LeadTime = k.LeadTime;
                    subList.Price = k.Price;
                    subList.QuoteId = k.QuoteId;
                    subList.ProjectType = k.ProjectType;
                    subList.ScientistCustomerId = k.ScientistCustomerId;
                    subList.RequiredQty = k.RequiredQty;
                    subList.ProjectStatus = k.ProjectStatus;
                    subList.IsOnHold = k.IsOnHold;
                    if (k.ProjectStatus != null)
                    {
                        subList.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
                    }
                    subList.ScientistStatus = k.ScientistStatus;
                    subList.BatchCode1 = k.BatchCode1;
                    subList.BatchCode2 = k.BatchCode2;
                    subList.Qty1 = k.Qty1;
                    subList.Qty2 = k.Qty2;
                    subList.EstimateCompleteDate = k.EstimateCompleteDate;
                    if (k.EstimateCompleteDate.HasValue)
                    {
                        subList.EstimateCompleteDateText = k.EstimateCompleteDate.Value.ToShortDateString();
                    }
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToProject = k.MoveToProject;
                    subList.Remark = k.Remark;
                    subList.SrPo = k.SrPo;
                    subList.AdminScientistStatus = k.AdminScientistStatus;
                    subList.LastStatus = k.LastStatus;
                    subList.InvoiceNo = k.InvoiceNo;
                    subList.InvoiceRemark = k.InvoiceRemark;

                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.ClientStatusText = "<select id='clientstatus_" + k.Id + "' class='clsClientStatus' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    subList.ApprovalCommentsText = "<i class='fa fa-pencil' onclick='approCommentGenerate(\"" + k.Id + "\")' ></i>";
                    subList.ClientStatusText += "<option value='In progress'>In progress</option>";
                    subList.ClientStatusText += "<option value='COA/Data Sent'>COA/Data Sent</option>";
                    subList.ClientStatusText += "<option value='COA/Data Approved'>COA/Data Approved</option>";
                    subList.ClientStatusText += "<option value='COA/Data Correction'>COA/Data Correction</option>";
                    //subList.ClientStatusText += "<option value='Dispatched'>Dispatched</option>";
                    subList.ClientStatusText += "</select>";
                    subList.ClientStatus = k.ClientStatus;
                    subList.ClientRemark = k.ClientRemark;
                    subList.ClientAddress = k.ClientAddress;
                    if (!string.IsNullOrEmpty(k.COAPath))
                    {
                        subList.COADownloadLink = "<a href='" + k.COAPath.Replace("..", "") + "' download='COA-" + subList.BatchNo + "'><i class='fa fa-download'></i></a>";
                    }
                    if (!string.IsNullOrEmpty(k.AnalyticalData))
                    {
                        subList.AnalyticalDataLink = "<a href='" + k.AnalyticalData.Replace("..", "") + "' download='AnalyticalData-" + subList.BatchNo + "'><i class='fa fa-download'></i></a>";
                    }
                    subList.ClientRemarkText = "<a data-toggle='modal' data-target='#clientremarkModal' href='/Form/AddClientRemark/" + k.Id + "?isClientSection=false'><i class='fa fa-pencil'></i></a>";
                    subList.AttachedDataList = k.AttachedDataList;

                    string coaText = "";

                    coaText = "<select id='coa_" + k.Id + "' class='addcoa'><option value=''>--Select--</option>";
                    int bId = k.AdditionalBatchNo.HasValue ? k.AdditionalBatchNo.Value : 0;
                    if (bId != 0)
                    {
                        var mastercoa = masterCOAData.Where(x => x.BatchId == bId).FirstOrDefault();
                        if (mastercoa != null)
                        {
                            subList.BatchNo = mastercoa.BatchNo;
                            var listchildcoa = childcoadata.Where(x => x.MasterCOAID == mastercoa.Id).ToList();
                            if (listchildcoa != null && listchildcoa.Count > 0)
                            {
                                foreach (var ccoa in listchildcoa)
                                {
                                    if (k.COAId == ccoa.Id)
                                    {
                                        coaText += "<option value='" + ccoa.Id.ToString() + "' data-value='" + k.AdditionalBatchNo + "' selected>" + ccoa.RefNo + "</option>";
                                    }
                                    else
                                    {
                                        coaText += "<option value='" + ccoa.Id.ToString() + "' data-value='" + k.AdditionalBatchNo + "'>" + ccoa.RefNo + "</option>";
                                    }
                                }

                            }
                        }
                    }
                    subList.COAText = coaText;

                    if (k.IsDispatchApprove.HasValue && k.IsDispatchApprove.Value)
                    {
                        subList.LastRowText = "<i class='fa fa-check'></i>";
                    }
                    else
                    {
                        subList.LastRowText = "<i class='fa fa-remove'></i>";
                    }
                    subList.IsDispatchApprove = k.IsDispatchApprove;
                    subList.Reason = k.Reason;
                    subList.SuggChemName = k.SZ_Quotation.SuggChemName;
                    if (k.LastUploadDate.HasValue)
                    {
                        subList.LastUploadDateStr = k.LastUploadDate.Value.ToShortDateString();
                    }
                    if (!string.IsNullOrEmpty(k.SZ_Quotation.Attachment))
                    {
                        subList.Attachment = "<a href='javascript: void(0)' onclick='attachment(" + k.QuoteId + ")'> <i class='fa fa-paperclip'></i></a>";
                    }

                    subList.ReasonText = k.Reason;

                    //subList.ReasonText = "<input id='reason_" + k.Id + "' type='text' value='" + k.Reason + "' title='" + k.Reason + "'  style='width:200px' />";
                    subList.CountryType = k.SZ_Quotation.CountryType;

                    subList.OrderRemark = k.OrderRemark;
                    subList.OrderRemarkText = "<input id='orderremark_" + k.Id + "' type='text' value='" + k.OrderRemark + "' title='" + k.OrderRemark + "'  style='width:200px' />";
                    subList.EstimateCompleteDate = k.EstimateCompleteDate;
                    //subList.EstimateCompleteDateText = "<input id='esticompleteDate_" + k.Id + "' data-value='" + k.EstimateCompleteDate + "' type='text' class='datepicker'  style='width:80px' />";
                    subList.ChangeBatch = "<i class='fa fa-clone' title='Change Batch No' onclick='GetAllBatchNo(" + k.ProductId + "," + k.Id + ")' ></i>";
                    model.Add(subList);
                }
                model = model.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).ThenBy(x => x.SrPo).ToList();

                //Paging   
                var data = model;
                //var data = model.Skip(skip).Take(pageSize).ToList();
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        [HttpPost]
        public ActionResult LoadDispatchedExportData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                int numberOfObjectsPerPage = Convert.ToInt32(Request.Form["length"]);

                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int pageNo = 1;
                if (skip > 0)
                {
                    pageNo = (skip / numberOfObjectsPerPage) + 1;
                }
                int sortQTY = (int)EnumList.DispatchStatus.SortQty;
                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);

                var model = (from i in db.SZ_Quotation.AsNoTracking()
                             join t2 in db.SZ_QuotationDetail.AsNoTracking() on i.Id equals t2.QuoteId
                             where t2.MoveToDispatch == true
                             && (t2.MoveToInvoice == false || t2.MoveToInvoice == null)
                             && (t2.IsOnHold == false || t2.IsOnHold == null)
                             && i.CountryTypeId == 2
                             && (t2.DispatchedStatus != sortQTY || t2.DispatchedStatus == null)
                             orderby t2.MoveDispatchDate descending
                             select t2).AsQueryable();

                var productids = model.Select(x => x.ProductId).ToList();
                MemoryCacheManager objCache = new MemoryCacheManager();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.AsNoTracking().Where(x => x.KeyGroup == "Customer").ToList();
                });

                var masterCOAData = objCache.Get("cache.mastercoadata", () =>
                {
                    return db.SZ_MasterCOA.ToList();
                });
                var childcoadata = objCache.Get("cache.childcoadata", () =>
                {
                    return db.SZ_ChildCOA.ToList();
                });
                var productsData = objCache.Get("cache.productsdata", () =>
                {
                    return db.Products.Where(x => x.Published == true && x.Deleted == false).ToList();
                });
                var inventoryData = objCache.Get("cache.inventoryData", () =>
                {
                    return db.SZ_Inventory.ToList();
                });
                var catList = objCache.Get("cache.categorydata", () =>
                {
                    return db.Categories.Where(x => x.ParentCategoryId == 0 && x.Deleted == false && x.Published).ToList();
                });
                var projectList = objCache.Get("cache.projectlist", () =>
                {
                    return db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("project")).ToList();
                });
                masterCOAData = masterCOAData.Where(x => productids.Contains(x.ProductId)).ToList();
                var compData = db.SZ_CompanyList.ToList();
                productsData = productsData.Where(x => productids.Contains(x.Id) && x.Published == true && x.Deleted == false).ToList();
                inventoryData = inventoryData.Where(x => productids.Contains(x.ProductId)).ToList();
                var mastercoaids = masterCOAData.Select(x => x.Id).ToList();
                childcoadata = childcoadata.Where(x => mastercoaids.Contains(x.MasterCOAID.Value)).ToList();
                var catnolist = model.Select(x => x.CATNo.Trim()).ToList();
                var queryLiveData = db.SZ_QueryModule.Where(x => catnolist.Contains(x.CATNo.Trim())).ToList();
                var list = new List<QuotationListModel>();
                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.SZ_Quotation.PONo != null && m.SZ_Quotation.PONo.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))).AsQueryable();
                    //|| (m.SelectedDispatchStatus != null && m.SelectedDispatchStatus.ToLower().Contains(searchValue))).ToList();
                }
                int? recordsTotal = model.Count();
                var mainmodel = model.Skip(skip).Take(pageSize).ToList();
                foreach (var k in mainmodel)
                {
                    string queryString = "";
                    var queryData = new List<SZ_QueryModule>();
                    queryData = queryLiveData.Where(x => x.CATNo.Trim() == k.CATNo.Trim()).OrderByDescending(x => x.Id).ToList();
                    if (queryData != null && queryData.Count > 0)
                    {
                        var qlist = queryData.Select(x => x.QueryNo).ToArray();
                        if (queryData.Select(x => x.Status.ToLower()).FirstOrDefault() == "solved" ||
                            queryData.Select(x => x.Status.ToLower()).FirstOrDefault() == "close" ||
                            queryData.Select(x => x.Status.ToLower()).FirstOrDefault() == "completed")
                        {
                            queryString = "<i class='clstooltip fa fa-info-circle' title='" + string.Join(", ", qlist) + "' style ='float:right; color: green' ></i>";
                        }
                        else
                        {
                            queryString = "<i class='clstooltip fa fa-info-circle' title='" + string.Join(", ", qlist) + "' style ='float:right' ></i>";
                        }
                    }
                    QuotationListModel subList = new QuotationListModel();

                    if (k.SZ_Quotation.SZ_CompanyList.ProjectTeam.HasValue)
                    {
                        var projectuser = projectList.Where(x => x.Id == k.SZ_Quotation.SZ_CompanyList.ProjectTeam).FirstOrDefault();
                        if (projectuser != null)
                        {
                            string customerName = string.Empty;
                            var genericAttr = genericData.Where(x => x.EntityId == projectuser.Id).ToList();
                            if (genericAttr.Count > 0)
                            {
                                customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                            }
                            subList.ProjectAssignName = customerName;
                        }
                    }


                    subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clssaveall' />";
                    subList.ActionRow = "";
                    if (k.DispatchedStatus.HasValue && k.DispatchedStatus.Value == (int)EnumList.DispatchStatus.Packed && k.MoveToInvoice != null && k.MoveToInvoice.Value)
                    {
                        subList.ActionRow = "<i class='fa fa-check-square' style='color:lightseagreen' ></i>";
                    }
                    else if (k.DispatchedStatus.HasValue && k.DispatchedStatus.Value == (int)EnumList.DispatchStatus.Packed)
                    {
                        subList.ActionRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' data-ponumber='" + k.SZ_Quotation.PONo + "'/>";
                    }

                    if (!string.IsNullOrEmpty(k.COAPath) || !string.IsNullOrEmpty(k.AnalyticalData))
                    {
                        subList.ChkSaveRow = "<a href='javascript:void(0)' style = 'color:darkgreen;font-weight: bold;' onclick='UploadDocumentOfProduct(\"" + k.Id + "\")'> Upload </a>";
                    }
                    else
                    {
                        subList.ChkSaveRow = "<a href='javascript:void(0)' onclick='UploadDocumentOfProduct(\"" + k.Id + "\")'> Upload </a>";
                    }
                    subList.StrProjectStatus = k.ProStatus;
                    subList.QuoteId = k.QuoteId;
                    subList.IsImageAttach = k.SZ_Quotation.IsImageAttach;
                    subList.CompanyName = k.SZ_Quotation.SZ_CompanyList.Name;
                    subList.PONumber = k.SZ_Quotation.PONo;
                    subList.Ref = k.SZ_Quotation.Ref;
                    subList.MoveDispatchDateText = k.MoveDispatchDate.HasValue ? k.MoveDispatchDate.Value.ToString("dd/MM/yyyy hh:mm tt") : "";
                    subList.Reason = k.Reason;
                    subList.ReasonText = "<input id='reason_" + k.Id + "' type='text' value='" + k.Reason + "' title='" + k.Reason + "'  style='width:200px' />";
                    if (!string.IsNullOrEmpty(k.SZ_Quotation.Attachment))
                    {
                        subList.Attachment = "<a href = 'javascript:void(0)' onclick='attachment(" + k.QuoteId + ")'><i class='fa fa-paperclip'></i></a>";
                    }
                    subList.CountryType = k.SZ_Quotation.CountryType;
                    subList.QuoteDetailsId = k.Id;
                    subList.CASNo = k.CASNo;
                    subList.IsConversionReport = k.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    var impstr = "";
                    if (subList.IsConversionReport.HasValue && subList.IsConversionReport.Value)
                    {
                        impstr += "<img src='/img/important.jpg' width='15px' height='15px' />";
                    }
                    subList.CATNo = k.CATNo + " " + queryString + " " + impstr + " " + CommonOperation.GetMatchingTagHTML(k, "Dispatch");
                    subList.CreatedDate = k.CreatedDate;
                    subList.ImagePath = k.ImagePath;
                    subList.LeadTime = k.LeadTime;
                    subList.Price = k.Price;
                    subList.ProductId = k.ProductId;
                    subList.ProductName = k.ProductName;
                    subList.QuoteId = k.QuoteId;
                    subList.ProjectType = k.ProjectType;
                    subList.ScientistCustomerId = k.ScientistCustomerId;
                    subList.RequiredQty = k.RequiredQty + " mg";
                    subList.ProjectStatus = k.ProjectStatus;
                    subList.AdditionalBatchNo = k.AdditionalBatchNo;
                    subList.AdditionalBatchNoText = "<select id='additionalBatch_" + k.Id + "' data-quotedetailsid='" + k.Id + "' class='ddladditionalbatch'><option value=''>--Select--</option>";
                    if (subList.ProductId.HasValue)
                    {
                        var proBatchData = inventoryData.Where(x => x.ProductId == subList.ProductId).ToList();
                        if (proBatchData.Count > 0/* && proData > 0*/)
                        {
                            foreach (var r in proBatchData)
                            {
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }
                                string selected = string.Empty;
                                if (subList.AdditionalBatchNo.HasValue && r.Id == subList.AdditionalBatchNo.Value)
                                {
                                    selected = "selected ";
                                    subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
                                    subList.BatchNo = r.BatchNo;
                                }

                                subList.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' " + selected + ">" + text + "</option>";
                            }
                        }
                    }
                    subList.AdditionalBatchNoText += "</select>";
                    subList.ChangeBatch = "<i class='fa fa-clone' title='Change Batch No' onclick='GetAllBatchNo(" + k.ProductId + "," + k.Id + ")' ></i>";
                    subList.COAText = GetCOA(k, masterCOAData, childcoadata);
                    subList.ActivityStatus = k.ActivityStatus;
                    subList.Remark = k.Remark;
                    subList.OrderRemark = k.OrderRemark;
                    if (k.DispatchedStatus == null)
                    {
                        k.DispatchedStatus = 0;
                    }
                    subList.DispatchStatusText = "<select id='dispatchstatus_" + k.Id + "' data-quotedetailsid='" + k.Id + "' class='clsDispatch'><option value=''>--Select--</option>";
                    foreach (EnumList.DispatchStatus r in Enum.GetValues(typeof(EnumList.DispatchStatus)))
                    {
                        string selected = "";
                        var item = Enum.GetName(typeof(EnumList.DispatchStatus), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.DispatchStatus)(int)r);
                        int val = (int)r;
                        if (Convert.ToInt32(val) == k.DispatchedStatus)
                        {
                            selected = "selected";
                            subList.SelectedDispatchStatus = text;
                        }
                        subList.DispatchStatusText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                    }
                    subList.DispatchStatusText += "</select>";
                    subList.DispatchStatusText += "<input type='number' style='display: none; width: 50px; ' id ='sortqty_" + k.Id + "' name ='sortqty_" + k.Id + "' data-requiredqty='" + k.RequiredQty + "' />";
                    subList.DispatchedStatus = k.DispatchedStatus;
                    subList.AdditionalBatchNo = k.AdditionalBatchNo;
                    subList.MoveToProject = k.MoveToProject;
                    subList.SrPo = k.SrPo;
                    subList.AdminScientistStatus = k.AdminScientistStatus;
                    subList.LastUploadDateText = k.LastUploadDate.HasValue ? k.LastUploadDate.Value.ToShortDateString() : "";
                    subList.ActivityStatus = k.ActivityStatus;
                    subList.ClientRemark = "<a data-toggle='modal' data-target='#clientremarkModal' href='/Form/AddClientRemark/" + k.Id + "?isClientSection=false'><i class='fa fa-pencil'></i></a>";
                    subList.ActivityStatusText = "<select id='activitystatus_" + k.Id + "' class='clsActivityStatus' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";

                    if (k.ActivityStatus == "Invoice Sent")
                    {
                        subList.ActivityStatusText += "<option value='Invoice Sent' selected>Invoice Sent</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Invoice Sent'>Invoice Sent</option>";
                    }
                    if (k.ActivityStatus == "PDC Awaited")
                    {
                        subList.ActivityStatusText += "<option value='PDC Awaited' selected>PDC Awaited</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='PDC Awaited'>PDC Awaited</option>";
                    }
                    if (k.ActivityStatus == "Advance Payment")
                    {
                        subList.ActivityStatusText += "<option value='Advance Payment' selected>Advance Payment</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Advance Payment'>Advance Payment</option>";
                    }
                    if (k.ActivityStatus == "Payment Due")
                    {
                        subList.ActivityStatusText += "<option value='Payment Due' selected>Payment Due</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Payment Due'>Payment Due</option>";
                    }
                    //if (k.ActivityStatus == "Insufficient QTY")
                    //{
                    //    subList.ActivityStatusText += "<option value='Insufficient QTY' selected>Insufficient QTY</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Insufficient QTY'>Insufficient QTY</option>";
                    //}
                    subList.ActivityStatusText += "</select>";
                    list.Add(subList);
                }
                var data = list;
                //var data = list.Skip(skip).Take(pageSize).ToList();
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }


        [HttpPost]
        public ActionResult LoadDispatchedLocalData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                int numberOfObjectsPerPage = Convert.ToInt32(Request.Form["length"]);

                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int pageNo = 1;
                if (skip > 0)
                {
                    pageNo = (skip / numberOfObjectsPerPage) + 1;
                }

                int sortQTY = (int)EnumList.DispatchStatus.SortQty;
                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);

                var model = (from i in db.SZ_Quotation.AsNoTracking()
                             join t2 in db.SZ_QuotationDetail.AsNoTracking() on i.Id equals t2.QuoteId
                             where t2.MoveToDispatch == true
                             && (t2.MoveToInvoice == false || t2.MoveToInvoice == null)
                             && (t2.IsOnHold == false || t2.IsOnHold == null)
                             && (i.CountryTypeId == 1 || !i.CountryTypeId.HasValue)
                             && (t2.DispatchedStatus != sortQTY || t2.DispatchedStatus == null)
                             orderby t2.MoveDispatchDate descending
                             select t2).ToList();

                var productids = model.Select(x => x.ProductId).ToList();
                MemoryCacheManager objCache = new MemoryCacheManager();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.AsNoTracking().Where(x => x.KeyGroup == "Customer").ToList();
                });
                var masterCOAData = objCache.Get("cache.mastercoadata", () =>
                {
                    return db.SZ_MasterCOA.ToList();
                });
                var childcoadata = objCache.Get("cache.childcoadata", () =>
                {
                    return db.SZ_ChildCOA.ToList();
                });
                var productsData = objCache.Get("cache.productsdata", () =>
                {
                    return db.Products.Where(x => x.Published == true && x.Deleted == false).ToList();
                });
                var ReadyToDeliverScientistStatusId = objCache.Get("cache.ReadyToDeliverScientistStatusId", () =>
                {
                    return db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                });
                var inventoryData = objCache.Get("cache.inventoryData", () =>
                {
                    return db.SZ_Inventory.ToList();
                });
                var catList = objCache.Get("cache.categorydata", () =>
                {
                    return db.Categories.Where(x => x.ParentCategoryId == 0 && x.Deleted == false && x.Published).ToList();
                });
                var projectList = objCache.Get("cache.projectlist", () =>
                {
                    return db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("project")).ToList();
                });
                masterCOAData = masterCOAData.Where(x => productids.Contains(x.ProductId)).ToList();
                var compData = db.SZ_CompanyList.ToList();
                productsData = productsData.Where(x => productids.Contains(x.Id) && x.Published == true && x.Deleted == false).ToList();
                inventoryData = inventoryData.Where(x => productids.Contains(x.ProductId)).ToList();
                var mastercoaids = masterCOAData.Select(x => x.Id).ToList();
                childcoadata = childcoadata.Where(x => mastercoaids.Contains(x.MasterCOAID.Value)).ToList();
                var catnolist = model.Select(x => x.CATNo.Trim()).Distinct().ToList();
                var queryLiveData = db.SZ_QueryModule.Where(x => catnolist.Contains(x.CATNo.Trim())).ToList();
                var list = new List<QuotationListModel>();
                foreach (var k in model)
                {
                    string queryString = "";
                    var queryData = new List<SZ_QueryModule>();
                    queryData = queryLiveData.Where(x => x.CATNo.Trim() == k.CATNo.Trim()).OrderByDescending(x => x.Id).ToList();
                    if (queryData != null && queryData.Count > 0)
                    {
                        var qlist = queryData.Select(x => x.QueryNo).ToArray();
                        if (queryData.Select(x => x.Status.ToLower()).FirstOrDefault() == "solved" ||
                            queryData.Select(x => x.Status.ToLower()).FirstOrDefault() == "close" ||
                            queryData.Select(x => x.Status.ToLower()).FirstOrDefault() == "completed")
                        {
                            queryString = "<i class='clstooltip fa fa-info-circle' title='" + string.Join(", ", qlist) + "' style ='float:right; color: green' ></i>";
                        }
                        else
                        {
                            queryString = "<i class='clstooltip fa fa-info-circle' title='" + string.Join(", ", qlist) + "' style ='float:right' ></i>";
                        }
                    }
                    QuotationListModel subList = new QuotationListModel();
                    if (k.SZ_Quotation.SZ_CompanyList.ProjectTeam.HasValue)
                    {
                        var projectuser = projectList.Where(x => x.Id == k.SZ_Quotation.SZ_CompanyList.ProjectTeam).FirstOrDefault();
                        if (projectuser != null)
                        {
                            string customerName = string.Empty;
                            var genericAttr = genericData.Where(x => x.EntityId == projectuser.Id).ToList();
                            if (genericAttr.Count > 0)
                            {
                                customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                            }
                            subList.ProjectAssignName = customerName;
                        }
                    }
                    subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clssaveall' />";
                    subList.StrProjectStatus = k.ProStatus;
                    subList.ActionRow = "";
                    if (k.DispatchedStatus.HasValue && k.DispatchedStatus.Value == (int)EnumList.DispatchStatus.Packed && k.MoveToInvoice != null && k.MoveToInvoice.Value)
                    {
                        subList.ActionRow = "<i class='fa fa-check-square' style='color:lightseagreen' ></i>";
                    }
                    else if (k.DispatchedStatus.HasValue && k.DispatchedStatus.Value == (int)EnumList.DispatchStatus.Packed)
                    {
                        subList.ActionRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' data-ponumber='" + k.SZ_Quotation.PONo + "'/>";
                    }


                    if (!string.IsNullOrEmpty(k.COAPath) || !string.IsNullOrEmpty(k.AnalyticalData))
                    {
                        subList.ChkSaveRow = "<a href='javascript:void(0)' style = 'color:darkgreen;font-weight: bold;' onclick='UploadDocumentOfProduct(\"" + k.Id + "\")'> Upload </a>";
                    }
                    else
                    {
                        subList.ChkSaveRow = "<a href='javascript:void(0)' onclick='UploadDocumentOfProduct(\"" + k.Id + "\")'> Upload </a>";
                    }
                    subList.QuoteId = k.QuoteId;
                    subList.IsImageAttach = k.SZ_Quotation.IsImageAttach;
                    subList.CompanyName = k.SZ_Quotation.SZ_CompanyList.Name;
                    subList.PONumber = k.SZ_Quotation.PONo;
                    subList.Ref = k.SZ_Quotation.Ref;
                    subList.MoveDispatchDateText = k.MoveDispatchDate.HasValue ? k.MoveDispatchDate.Value.ToString("dd/MM/yyyy hh:mm tt") : "";
                    subList.Reason = k.Reason;
                    subList.ReasonText = "<input id='reason_" + k.Id + "' type='text' value='" + k.Reason + "' title='" + k.Reason + "'  style='width:200px' />";
                    if (!string.IsNullOrEmpty(k.SZ_Quotation.Attachment))
                    {
                        subList.Attachment = "<a href = 'javascript:void(0)' onclick='attachment(" + k.QuoteId + ")'><i class='fa fa-paperclip'></i></a>";
                    }
                    subList.CountryType = k.SZ_Quotation.CountryType;
                    subList.QuoteDetailsId = k.Id;
                    subList.CASNo = k.CASNo;
                    subList.IsConversionReport = k.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    var impstr = "";
                    if (subList.IsConversionReport.HasValue && subList.IsConversionReport.Value)
                    {
                        impstr += "<img src='/img/important.jpg' width='15px' height='15px' />";
                    }
                    subList.CATNo = k.CATNo + " " + queryString + " " + impstr + " " + CommonOperation.GetMatchingTagHTML(k, "Dispatch");
                    subList.CreatedDate = k.CreatedDate;
                    subList.ImagePath = k.ImagePath;
                    subList.LeadTime = k.LeadTime;
                    subList.Price = k.Price;
                    subList.ProductId = k.ProductId;
                    subList.ProductName = k.ProductName;
                    subList.QuoteId = k.QuoteId;
                    subList.ProjectType = k.ProjectType;
                    subList.ScientistCustomerId = k.ScientistCustomerId;
                    subList.RequiredQty = k.RequiredQty + " mg";
                    subList.ProjectStatus = k.ProjectStatus;
                    subList.AdditionalBatchNo = k.AdditionalBatchNo;
                    subList.AdditionalBatchNoText = "<select id='additionalBatch_" + k.Id + "' data-quotedetailsid='" + k.Id + "' class='ddladditionalbatch'><option value=''>--Select--</option>";
                    if (subList.ProductId.HasValue)
                    {
                        var proBatchData = inventoryData.Where(x => x.ProductId == subList.ProductId).ToList();
                        if (proBatchData.Count > 0)
                        {
                            foreach (var r in proBatchData)
                            {
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }
                                string selected = string.Empty;
                                if (subList.AdditionalBatchNo.HasValue && r.Id == subList.AdditionalBatchNo)
                                {
                                    selected = "selected ";
                                    subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
                                    subList.BatchNo = r.BatchNo;
                                }

                                subList.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' " + selected + ">" + text + "</option>";
                            }
                        }
                    }
                    subList.AdditionalBatchNoText += "</select>";
                    subList.ChangeBatch = "<i class='fa fa-clone' title='Change Batch No' onclick='GetAllBatchNo(" + k.ProductId + "," + k.Id + ")' ></i>";
                    subList.COAText = GetCOA(k, masterCOAData, childcoadata);
                    subList.ActivityStatus = k.ActivityStatus;
                    subList.Remark = k.Remark;
                    subList.OrderRemark = k.OrderRemark;

                    if (k.DispatchedStatus == null)
                    {
                        k.DispatchedStatus = 0;
                    }

                    subList.DispatchStatusText = "<select id='dispatchstatus_" + k.Id + "' data-quotedetailsid='" + k.Id + "' class='clsDispatch'><option value=''>--Select--</option>";
                    foreach (EnumList.DispatchStatus r in Enum.GetValues(typeof(EnumList.DispatchStatus)))
                    {
                        string selected = "";
                        var item = Enum.GetName(typeof(EnumList.DispatchStatus), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.DispatchStatus)(int)r);
                        int val = (int)r;
                        if (Convert.ToInt32(val) == k.DispatchedStatus)
                        {
                            selected = "selected";
                            subList.SelectedDispatchStatus = text;
                        }
                        subList.DispatchStatusText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                    }
                    subList.DispatchStatusText += "</select>";
                    subList.DispatchStatusText += "<input type='number' style='display: none; width: 50px; ' id ='sortqty_" + k.Id + "' name ='sortqty_" + k.Id + "' data-requiredqty='" + k.RequiredQty + "' />";
                    subList.DispatchedStatus = k.DispatchedStatus;
                    subList.AdditionalBatchNo = k.AdditionalBatchNo;
                    subList.MoveToProject = k.MoveToProject;
                    subList.SrPo = k.SrPo;
                    subList.AdminScientistStatus = k.AdminScientistStatus;
                    subList.LastUploadDateText = k.LastUploadDate.HasValue ? k.LastUploadDate.Value.ToShortDateString() : "";
                    subList.ActivityStatus = k.ActivityStatus;
                    subList.ClientRemark = "<a data-toggle='modal' data-target='#clientremarkModal' href='/Form/AddClientRemark/" + k.Id + "?isClientSection=false'><i class='fa fa-pencil'></i></a>";
                    subList.ActivityStatusText = "<select id='activitystatus_" + k.Id + "' class='clsActivityStatus' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";

                    if (k.ActivityStatus == "Invoice Sent")
                    {
                        subList.ActivityStatusText += "<option value='Invoice Sent' selected>Invoice Sent</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Invoice Sent'>Invoice Sent</option>";
                    }
                    if (k.ActivityStatus == "PDC Awaited")
                    {
                        subList.ActivityStatusText += "<option value='PDC Awaited' selected>PDC Awaited</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='PDC Awaited'>PDC Awaited</option>";
                    }
                    if (k.ActivityStatus == "Advance Payment")
                    {
                        subList.ActivityStatusText += "<option value='Advance Payment' selected>Advance Payment</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Advance Payment'>Advance Payment</option>";
                    }
                    if (k.ActivityStatus == "Payment Due")
                    {
                        subList.ActivityStatusText += "<option value='Payment Due' selected>Payment Due</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Payment Due'>Payment Due</option>";
                    }
                    //if (k.ActivityStatus == "Insufficient QTY")
                    //{
                    //    subList.ActivityStatusText += "<option value='Insufficient QTY' selected>Insufficient QTY</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Insufficient QTY'>Insufficient QTY</option>";
                    //}
                    subList.ActivityStatusText += "</select>";
                    list.Add(subList);
                }

                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    list = list.Where(m => (m.PONumber != null && m.PONumber.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        || (m.SelectedDispatchStatus != null && m.SelectedDispatchStatus.ToLower().Contains(searchValue))).ToList();
                }
                var data = list.Skip(skip).Take(pageSize).ToList();
                int? recordsTotal = list.Count;
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }
        }

        [HttpPost]
        public ActionResult LoadDispatchedShortQTYData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                int numberOfObjectsPerPage = Convert.ToInt32(Request.Form["length"]);

                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int pageNo = 1;
                if (skip > 0)
                {
                    pageNo = (skip / numberOfObjectsPerPage) + 1;
                }
                int sortQTY = (int)EnumList.DispatchStatus.SortQty;
                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);

                var model = (from i in db.SZ_Quotation.AsNoTracking()
                             join t2 in db.SZ_QuotationDetail.AsNoTracking() on i.Id equals t2.QuoteId
                             where t2.MoveToDispatch == true
                             && (t2.MoveToInvoice == false || t2.MoveToInvoice == null)
                             && (t2.IsOnHold == false || t2.IsOnHold == null)
                             && t2.DispatchedStatus == sortQTY
                             orderby t2.MoveDispatchDate descending
                             select t2).ToList();

                var productids = model.Select(x => x.ProductId).ToList();

                MemoryCacheManager objCache = new MemoryCacheManager();

                var masterCOAData = objCache.Get("cache.mastercoadata", () =>
                {
                    return db.SZ_MasterCOA.ToList();
                });
                var childcoadata = objCache.Get("cache.childcoadata", () =>
                {
                    return db.SZ_ChildCOA.ToList();
                });
                var productsData = objCache.Get("cache.productsdata", () =>
                {
                    return db.Products.Where(x => x.Published == true && x.Deleted == false).ToList();
                });
                var ReadyToDeliverScientistStatusId = objCache.Get("cache.ReadyToDeliverScientistStatusId", () =>
                {
                    return db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                });
                var inventoryData = objCache.Get("cache.inventoryData", () =>
                {
                    return db.SZ_Inventory.ToList();
                });
                var catList = objCache.Get("cache.categorydata", () =>
                {
                    return db.Categories.Where(x => x.ParentCategoryId == 0 && x.Deleted == false && x.Published).ToList();
                });

                masterCOAData = masterCOAData.Where(x => productids.Contains(x.ProductId)).ToList();
                var compData = db.SZ_CompanyList.ToList();
                productsData = productsData.Where(x => productids.Contains(x.Id) && x.Published == true && x.Deleted == false).ToList();
                inventoryData = inventoryData.Where(x => productids.Contains(x.ProductId)).ToList();
                var mastercoaids = masterCOAData.Select(x => x.Id).ToList();
                childcoadata = childcoadata.Where(x => mastercoaids.Contains(x.MasterCOAID.Value)).ToList();
                var catnolist = model.Select(x => x.CATNo.Trim()).Distinct().ToList();
                var queryLiveData = db.SZ_QueryModule.Where(x => catnolist.Contains(x.CATNo.Trim())).ToList();
                var list = new List<QuotationListModel>();
                foreach (var k in model)
                {
                    string queryString = "";
                    var queryData = new List<SZ_QueryModule>();
                    queryData = queryLiveData.Where(x => x.CATNo.Trim() == k.CATNo.Trim()).OrderByDescending(x => x.Id).ToList();
                    if (queryData != null && queryData.Count > 0)
                    {
                        var qlist = queryData.Select(x => x.QueryNo).ToArray();
                        if (queryData.Select(x => x.Status.ToLower()).FirstOrDefault() == "solved" ||
                            queryData.Select(x => x.Status.ToLower()).FirstOrDefault() == "close" ||
                            queryData.Select(x => x.Status.ToLower()).FirstOrDefault() == "completed")
                        {
                            queryString = "<i class='clstooltip fa fa-info-circle' title='" + string.Join(", ", qlist) + "' style ='float:right; color: green' ></i>";
                        }
                        else
                        {
                            queryString = "<i class='clstooltip fa fa-info-circle' title='" + string.Join(", ", qlist) + "' style ='float:right' ></i>";
                        }
                    }
                    QuotationListModel subList = new QuotationListModel();
                    subList.StrProjectStatus = k.ProStatus;
                    subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clssaveall' />";
                    subList.ActionRow = "";
                    if (k.DispatchedStatus.HasValue && k.DispatchedStatus.Value == (int)EnumList.DispatchStatus.Packed && k.MoveToInvoice != null && k.MoveToInvoice.Value)
                    {
                        subList.ActionRow = "<i class='fa fa-check-square' style='color:lightseagreen' ></i>";
                    }
                    else if (k.DispatchedStatus.HasValue && k.DispatchedStatus.Value == (int)EnumList.DispatchStatus.Packed)
                    {
                        subList.ActionRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' data-ponumber='" + k.SZ_Quotation.PONo + "'/>";
                    }
                    subList.LastRow = "<a href='javascript: void(0)' id='save_" + k.Id + "' onclick='SaveDispatchDetailsSort(" + k.Id + ")'> Save</a>";
                    subList.QuoteId = k.QuoteId;
                    subList.IsImageAttach = k.SZ_Quotation.IsImageAttach;
                    subList.CompanyName = k.SZ_Quotation.SZ_CompanyList.Name;
                    subList.PONumber = k.SZ_Quotation.PONo;
                    subList.Ref = k.SZ_Quotation.Ref;
                    subList.MoveDispatchDateText = k.MoveDispatchDate.HasValue ? k.MoveDispatchDate.Value.ToShortDateString() : "";
                    subList.Reason = k.Reason;
                    subList.ReasonText = "<input id='reason_" + k.Id + "' type='text' value='" + k.Reason + "' title='" + k.Reason + "'  style='width:200px' />";
                    if (!string.IsNullOrEmpty(k.SZ_Quotation.Attachment))
                    {
                        subList.Attachment = "<a href = 'javascript:void(0)' onclick='attachment(" + k.QuoteId + ")'><i class='fa fa-paperclip'></i></a>";
                    }
                    subList.CountryType = k.SZ_Quotation.CountryType;
                    subList.QuoteDetailsId = k.Id;
                    subList.CASNo = k.CASNo;
                    subList.IsConversionReport = k.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    var impstr = "";
                    if (subList.IsConversionReport.HasValue && subList.IsConversionReport.Value)
                    {
                        impstr += "<img src='/img/important.jpg' width='15px' height='15px' />";
                    }
                    subList.CATNo = k.CATNo + " " + queryString + " " + impstr + " " + CommonOperation.GetMatchingTagHTML(k, "Dispatch");
                    subList.CreatedDate = k.CreatedDate;
                    subList.ImagePath = k.ImagePath;
                    subList.LeadTime = k.LeadTime;
                    subList.Price = k.Price;
                    subList.ProductId = k.ProductId;
                    subList.ProductName = k.ProductName;
                    subList.QuoteId = k.QuoteId;
                    subList.ProjectType = k.ProjectType;
                    subList.ScientistCustomerId = k.ScientistCustomerId;
                    subList.RequiredQty = k.RequiredQty + " mg";
                    subList.ProjectStatus = k.ProjectStatus;
                    subList.AdditionalBatchNo = k.AdditionalBatchNo;
                    subList.AdditionalBatchNoText = "<select id='sortadditionalBatch_" + k.Id + "' data-quotedetailsid='" + k.Id + "' class='ddladditionalbatch'><option value=''>--Select--</option>";
                    if (subList.ProductId.HasValue)
                    {
                        var proBatchData = inventoryData.Where(x => x.ProductId == subList.ProductId).ToList();
                        if (proBatchData.Count > 0)
                        {
                            foreach (var r in proBatchData)
                            {
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }
                                string selected = string.Empty;
                                if (subList.AdditionalBatchNo.HasValue && r.Id == subList.AdditionalBatchNo)
                                {
                                    selected = "selected ";
                                    subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
                                    subList.BatchNo = r.BatchNo;
                                }
                                subList.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' " + selected + ">" + text + "</option>";
                            }
                        }
                    }
                    subList.AdditionalBatchNoText += "</select>";
                    subList.ChangeBatch = "<i class='fa fa-clone' title='Change Batch No' onclick='GetAllBatchNo(" + k.ProductId + "," + k.Id + ")' ></i>";
                    subList.COAText = GetCOA(k, masterCOAData, childcoadata);
                    subList.ActivityStatus = k.ActivityStatus;
                    subList.Remark = "<input id='sortremark_" + k.Id + "' type='text' value ='" + k.Remark + "' style ='width: 170px' title ='" + k.Remark + "' />";
                    subList.OrderRemark = k.OrderRemark;
                    if (k.DispatchedStatus == null)
                    {
                        k.DispatchedStatus = 0;
                    }
                    subList.DispatchStatusText = "<select id='sortdispatchstatus_" + k.Id + "' data-quotedetailsid='" + k.Id + "' class='clsDispatch'><option value=''>--Select--</option>";
                    foreach (EnumList.DispatchStatus r in Enum.GetValues(typeof(EnumList.DispatchStatus)))
                    {
                        string selected = "";
                        var item = Enum.GetName(typeof(EnumList.DispatchStatus), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.DispatchStatus)(int)r);
                        int val = (int)r;
                        if (val == k.DispatchedStatus)
                        {
                            selected = "selected";
                            subList.SelectedDispatchStatus = text;
                        }
                        subList.DispatchStatusText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                    }
                    subList.DispatchStatusText += "</select>";
                    subList.DispatchStatusText += "<input type='number' style='display: none; width: 50px; ' id ='sortqty_" + k.Id + "' name ='sortqty_" + k.Id + "' data-requiredqty='" + k.RequiredQty + "' />";
                    subList.DispatchedStatus = k.DispatchedStatus;
                    subList.AdditionalBatchNo = k.AdditionalBatchNo;
                    subList.MoveToProject = k.MoveToProject;
                    subList.SrPo = k.SrPo;
                    subList.AdminScientistStatus = k.AdminScientistStatus;
                    subList.LastUploadDateText = k.LastUploadDate.HasValue ? k.LastUploadDate.Value.ToShortDateString() : "";
                    subList.ActivityStatus = k.ActivityStatus;
                    subList.ClientRemark = "<a data-toggle='modal' data-target='#clientremarkModal' href='/Form/AddClientRemark/" + k.Id + "?isClientSection=false'><i class='fa fa-pencil'></i></a>";
                    subList.ActivityStatusText = "<select id='activitystatus_" + k.Id + "' class='clsActivityStatus' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";

                    if (k.ActivityStatus == "Invoice Sent")
                    {
                        subList.ActivityStatusText += "<option value='Invoice Sent' selected>Invoice Sent</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Invoice Sent'>Invoice Sent</option>";
                    }
                    if (k.ActivityStatus == "PDC Awaited")
                    {
                        subList.ActivityStatusText += "<option value='PDC Awaited' selected>PDC Awaited</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='PDC Awaited'>PDC Awaited</option>";
                    }
                    if (k.ActivityStatus == "Advance Payment")
                    {
                        subList.ActivityStatusText += "<option value='Advance Payment' selected>Advance Payment</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Advance Payment'>Advance Payment</option>";
                    }
                    if (k.ActivityStatus == "Payment Due")
                    {
                        subList.ActivityStatusText += "<option value='Payment Due' selected>Payment Due</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Payment Due'>Payment Due</option>";
                    }

                    subList.ActivityStatusText += "</select>";
                    list.Add(subList);
                }

                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    list = list.Where(m => (m.PONumber != null && m.PONumber.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        || (m.SelectedDispatchStatus != null && m.SelectedDispatchStatus.ToLower().Contains(searchValue))).ToList();
                }
                var data = list.Skip(skip).Take(pageSize).ToList();
                int? recordsTotal = list.Count;
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }


        [HttpPost]
        public ActionResult LoadAllDelivereddata()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                int numberOfObjectsPerPage = Convert.ToInt32(Request.Form["length"]);

                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int pageNo = 1;
                if (skip > 0)
                {
                    pageNo = (skip / numberOfObjectsPerPage) + 1;
                }

                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);

                var list = db.DispatchedDeliveredList(searchValue, pageNo, pageSize).ToList();

                MemoryCacheManager objCache = new MemoryCacheManager();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.AsNoTracking().Where(x => x.KeyGroup == "Customer").ToList();
                }); var listItems = new List<SelectListItem>();

                var scienList = db.GetScientistId().ToList();
                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                });

                var masterCOAData = objCache.Get("cache.mastercoadata", () =>
                {
                    return db.SZ_MasterCOA.ToList();
                });
                var childcoadata = objCache.Get("cache.childcoadata", () =>
                {
                    return db.SZ_ChildCOA.ToList();
                });
                var ReadyToDeliverScientistStatusId = objCache.Get("cache.ReadyToDeliverScientistStatusId", () =>
                {
                    return db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                });
                var inventory = objCache.Get("cache.inventoryData", () =>
                {
                    return db.SZ_Inventory.ToList();
                });


                var projectList = objCache.Get("cache.projectlist", () =>
                {
                    return db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("project")).ToList();
                });


                var productids = list.Select(x => x.ProductId).ToList();
                masterCOAData = masterCOAData.Where(x => productids.Contains(x.ProductId)).ToList();
                var mastercoaids = masterCOAData.Select(x => x.Id).ToList();
                childcoadata = childcoadata.Where(x => mastercoaids.Contains(x.MasterCOAID.Value)).ToList();

                var quoteids = list.Select(x => x.QuoteId).ToList();
                var quotedata = db.SZ_Quotation.Where(x => quoteids.Contains(x.Id)).ToList();

                var model = new List<ProjectListModel>();
                foreach (var k in list)
                {
                    ProjectListModel subList = new ProjectListModel();

                    var qdata = quotedata.Where(x => x.Id == k.QuoteId).FirstOrDefault();
                    if (qdata != null)
                    {
                        if (qdata.SZ_CompanyList.ProjectTeam.HasValue)
                        {
                            var projectuser = projectList.Where(x => x.Id == qdata.SZ_CompanyList.ProjectTeam).FirstOrDefault();
                            if (projectuser != null)
                            {
                                string customerName = string.Empty;
                                var genericAttr = genericData.Where(x => x.EntityId == projectuser.Id).ToList();
                                if (genericAttr.Count > 0)
                                {
                                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                                }
                                subList.ProjectAssignName = customerName;
                            }
                        }
                    }

                    subList.TotalRecord = k.TotalRecord;
                    subList.ChkFirstRow = "<input type='checkbox' value='" + k.QuoteDetailsId + "' class='clsSaverow' />";
                    subList.ChkSaveRow = "<a href='javascript:void(0)' onclick='UploadDocumentOfProduct(\"" + k.QuoteDetailsId + "\")'> Upload </a>";
                    subList.ReadyToDeliverScientistStatusId = ReadyToDeliverScientistStatusId;

                    subList.ProjectType = k.ProjectType;
                    foreach (var r in listItems)
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.ScientistCustomerId))
                        {
                            subList.SelectedScientistName = r.Text;
                        }
                    }
                    subList.InvoicedDateText = k.InvoicedDate.HasValue ? k.InvoicedDate.Value.ToShortDateString() : "";
                    subList.AdditionalBatchNo = k.AdditionalBatchNo;
                    subList.QuoteId = k.QuoteId;
                    subList.ProductId = k.ProductId;
                    subList.ProductName = k.ProductName;
                    subList.OrderRemark = k.OrderRemark;
                    subList.AdditionalBatchNoText = "<select id='additionalBatch_" + k.QuoteDetailsId + "' data-quotationdetailsid='" + k.QuoteDetailsId + "' class='ddladditionalbatch'><option value=''>--Select--</option>";
                    if (subList.ProductId.HasValue)
                    {
                        //var proData = db.Products.Where(x => x.Id == subList.ProductId && x.Published == true && x.Deleted == false).Count();
                        var proBatchData = inventory.Where(x => x.ProductId == subList.ProductId).ToList();
                        if (proBatchData.Count > 0/* && proData > 0*/)
                        {
                            foreach (var r in proBatchData)
                            {
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }
                                string selected = string.Empty;
                                if (r.Id == subList.AdditionalBatchNo)
                                {
                                    selected = "selected ";
                                    subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
                                    subList.BatchNo = r.BatchNo;
                                }

                                subList.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' " + selected + ">" + text + "</option>";
                            }
                        }
                    }
                    subList.AdditionalBatchNoText += "</select>";
                    subList.RequiredQtyTxt = k.RequiredQty;
                    subList.COAText = GetCOA(k, masterCOAData, childcoadata);
                    subList.IsImageAttach = k.IsImageAttach;
                    subList.CompanyName = k.CompanyName;
                    subList.Email = k.EmailAddress;
                    subList.PONumber = k.PONo;
                    subList.Ref = k.Ref;
                    subList.Remark = k.QuotedetailsRemark;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.QuoteDetailsId = k.QuoteDetailsId;
                    subList.CASNo = k.CASNo;
                    subList.CATNo = k.CATNo;
                    subList.CreatedDate = k.CreatedDate.Value;
                    //subList.ImagePath = k.IsImageAttach;
                    subList.IsUploadServer = k.IsUploadServer;
                    subList.LeadTime = k.LeadTime;
                    subList.Price = k.Price;

                    subList.QuoteId = k.QuoteId;
                    subList.ProjectType = k.ProjectType;
                    subList.ScientistCustomerId = k.ScientistCustomerId;

                    subList.RequiredQty = k.RequiredQty;
                    subList.ProjectStatus = k.ProjectStatus;
                    subList.IsOnHold = k.IsOnHold;
                    if (k.ProjectStatus != null)
                    {
                        subList.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
                    }
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.ClientStatusText = "<select id='clientstatus_" + k.QuoteDetailsId + "' class='clsClientStatus' data-quoteDetailsId='" + k.QuoteDetailsId + "'><option value=''>--Select--</option>";

                    subList.ClientStatusText += "<option value='In progress'>In progress</option>";
                    subList.ClientStatusText += "<option value='COA/Data Sent'>COA/Data Sent</option>";
                    subList.ClientStatusText += "<option value='COA/Data Approved'>COA/Data Approved</option>";
                    subList.ClientStatusText += "<option value='COA/Data Correction'>COA/Data Correction</option>";

                    subList.ClientStatusText += "</select>";
                    subList.ClientRemarkText = "<a data-toggle='modal' data-target='#clientremarkModal' href='/Form/AddClientRemark/" + k.QuoteDetailsId + "?isClientSection=false'><i class='fa fa-pencil'></i></a>";
                    subList.ChangeBatch = "<i class='fa fa-clone' title='Change Batch No' onclick='GetAllBatchNo(" + k.ProductId + "," + k.QuoteDetailsId + ")' ></i>";

                    model.Add(subList);
                }
                model = model.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).ThenBy(x => x.SrPo).ToList();

                int? recordsTotal = model.Select(x => x.TotalRecord).FirstOrDefault();
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = model });
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        [HttpPost]
        public ActionResult LoadProductNoActionData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;
                string synthesis = Convert.ToString((int)EnumList.ProjectType.Synthesis);
                string pursynthesis = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
                var list = (from i in db.SZ_Quotation.AsNoTracking()
                            join t2 in db.SZ_QuotationDetail.AsNoTracking() on i.Id equals t2.QuoteId
                            where (t2.MoveToProject == true && string.IsNullOrEmpty(t2.TrackingNo)
                                    && (t2.IsOnHold == false || t2.IsOnHold == null)
                                    && (t2.ProjectType == null || t2.ProjectType == string.Empty || (t2.ProjectType == synthesis && !t2.ScientistCustomerId.HasValue)))
                                    || (string.IsNullOrEmpty(t2.RequiredQty) && t2.MoveToProject == true && string.IsNullOrEmpty(t2.TrackingNo)
                                    && (t2.IsOnHold == false || t2.IsOnHold == null))
                            orderby t2.MoveProjectDate descending
                            select t2).Distinct();

                string internationcompanylist = "";
                if (SessionCookieManagement.IsInternational)
                {
                    internationcompanylist = db.SZ_UserManagement.Where(x => x.UserId == SessionCookieManagement.UserId).Select(x => x.CompanyIds).FirstOrDefault();
                    if (!string.IsNullOrEmpty(internationcompanylist))
                    {
                        List<int?> cidList = new List<int?>();
                        foreach (var item in internationcompanylist.Split(','))
                        {
                            if (!string.IsNullOrEmpty(item))
                            {
                                cidList.Add(Convert.ToInt32(item));
                            }
                        }
                        list = list.Where(x => cidList.Contains(x.SZ_Quotation.CompanyId) && x.SZ_Quotation.CreatedDate >= new DateTime(2022, 05, 01)).AsQueryable();
                    }
                }

                list = list.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo);
                string pursynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
                string synthesisProjectType = Convert.ToString((int)EnumList.ProjectType.Synthesis);
                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);

                var queryData = db.SZ_QueryModule.AsQueryable();
                var quotationDetailsdata = db.SZ_QuotationDetail.AsQueryable();
                // Getting all Customer data  
                var listproductall = (from i in db.SZ_Quotation
                                      join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                                      where (t2.MoveToProject == true)
                                      && string.IsNullOrEmpty(t2.TrackingNo)
                                      && (t2.IsOnHold == false || t2.IsOnHold == null)
                                      && t2.ProjectType != inhouseProjectType
                                      && (t2.ProjectType == synthesisProjectType || t2.ProjectType == pursynthesisProjectType)
                                      && (t2.IsSynthesisLog == false || t2.IsSynthesisLog == null)
                                      && (t2.MoveToInvoice == false || t2.MoveToInvoice == null)
                                      orderby t2.MoveProjectDate descending
                                      select t2).Distinct().OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).ToList();


                var subscilistItems = new List<SelectListItem>();
                var listItems = new List<SelectListItem>();
                MemoryCacheManager objCache = new MemoryCacheManager();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });

                var scienList = objCache.Get("cache.GetScientistId", () =>
                {
                    return db.GetScientistId().ToList();
                });

                var subscienList = objCache.Get("cache.subscienList", () =>
                {
                    return db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();
                });
                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }

                    var pcount = listproductall.Where(x => x.ScientistCustomerId == term
                             && (x.ProjectType == Convert.ToString((int)EnumList.ProjectType.Synthesis)
                                || x.ProjectType == Convert.ToString((int)EnumList.ProjectType.PurSynthesis)
                                || x.ProjectType == Convert.ToString((int)EnumList.ProjectType.Drying)
                                || x.ProjectType == Convert.ToString((int)EnumList.ProjectType.ReSynthesis)
                                || x.ProjectType == Convert.ToString((int)EnumList.ProjectType.RePurification)
                            )
                        && (x.ProStatus == Convert.ToString((int)EnumList.ProStatusDDL.TroubleshootP1)
                            || x.ProStatus == Convert.ToString((int)EnumList.ProStatusDDL.TroubleshootP2)
                            || x.ProStatus == Convert.ToString((int)EnumList.ProStatusDDL.TroubleshootL1)
                            || x.ProStatus == Convert.ToString((int)EnumList.ProStatusDDL.TroubleshootL2)
                            || x.ProStatus == Convert.ToString((int)EnumList.ProStatusDDL.OrderConfirmation)
                            || x.ProStatus == Convert.ToString((int)EnumList.ProStatusDDL.LiteratureandRoute)
                            || x.ProStatus == Convert.ToString((int)EnumList.ProStatusDDL.RMRequest)
                            || x.ProStatus == Convert.ToString((int)EnumList.ProStatusDDL.RMOrdered)
                            || x.ProStatus == Convert.ToString((int)EnumList.ProStatusDDL.RMDelayed)
                            || x.ProStatus == Convert.ToString((int)EnumList.ProStatusDDL.RegretRequestRMDelayed)
                            || x.ProStatus == Convert.ToString((int)EnumList.ProStatusDDL.InHouseRMSynthesis)
                            || x.ProStatus == Convert.ToString((int)EnumList.ProStatusDDL.InProgress)
                            || x.ProStatus == Convert.ToString((int)EnumList.ProStatusDDL.ProductConfirmation)
                            || x.ProStatus == Convert.ToString((int)EnumList.ProStatusDDL.Attention)
                            || x.ProStatus == Convert.ToString((int)EnumList.ProStatusDDL.QCCorrection)
                            || x.ProStatus == Convert.ToString((int)EnumList.ProStatusDDL.QCRejected)
                            || x.ProStatus == Convert.ToString((int)EnumList.ProStatusDDL.QCRejectedDrying)
                            || x.ProStatus == Convert.ToString((int)EnumList.ProStatusDDL.QCRejectedRePurification)
                            || x.ProStatus == Convert.ToString((int)EnumList.ProStatusDDL.QCRejectedReSynthesis))
                    ).Count();

                    listItems.Add(new SelectListItem
                    {
                        Text = customerName + " (" + pcount.ToString() + ")",
                        Value = term.ToString()
                    });
                    subscilistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });

                });

                foreach (var term in subscienList)
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }

                    subscilistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                }

                var proIds = list.Select(x => x.ProductId).Distinct().ToList();
                var productsdata = db.Products.Where(x => proIds.Contains(x.Id) && x.Deleted == false && x.Published == true).ToList();
                var inventoryData = db.SZ_Inventory.Where(x => proIds.Contains(x.ProductId)).ToList();
                var ReadyToDeliverScientistStatusId = db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                var model = new List<ProjectListModel>();
                foreach (var k in list)
                {
                    ProjectListModel subList = new ProjectListModel();
                    subList.IsConversionReport = k.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    subList.ChkSaveRow = "<input type='checkbox' value='" + k.Id + "' class='clsSaverow' />";
                    subList.ReadyToDeliverScientistStatusId = ReadyToDeliverScientistStatusId;
                    if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == subList.ReadyToDeliverScientistStatusId && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                    {
                        subList.ChkFirstRow = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                    }
                    else if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == subList.ReadyToDeliverScientistStatusId)
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' data-ponumber='" + k.SZ_Quotation.PONo + "'/>";
                    }
                    else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && k.MoveToDispatch == null)
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' data-ponumber='" + k.SZ_Quotation.PONo + "' />";
                    }
                    else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                    {
                        subList.ChkFirstRow = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                    }
                    subList.ProjectType = k.ProjectType;
                    subList.ProjectTypeText = "<select id='projecttype_" + k.Id + "' class='clsProjType' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ProjectType), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.ProjectType)
                        {
                            selected = "selected ";
                            subList.SelectedProjectType = text;
                        }
                        //if (text != "In-House")
                        //{
                            subList.ProjectTypeText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                        //}
                    }
                    subList.ProjectTypeText += "</select> <i id='pursummary_" + k.Id + "' style='display:none' class='fa fa-pencil' onclick='PurchasesummaryGenerate(" + k.Id + ",&#39;project&#39;)' ></i>";

                    if (!string.IsNullOrEmpty(k.PurchaseRemark))
                    {
                        subList.ProjectTypeText += " <i class='fa fa-eye' title='" + k.PurchaseRemark + "' ></i>";
                    }

                    subList.ScientistName = "<select id='ScientistId_" + k.Id + "' class='scientist' scientistId='" + k.ScientistCustomerId + "' quotedetailsid='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (var r in listItems)
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.ScientistCustomerId))
                        {
                            selected = "selected ";
                            subList.SelectedScientistName = r.Text;
                        }
                        subList.ScientistName += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    }
                    subList.ScientistName += "</select>";
                    subList.PaymentTerms = k.SZ_Quotation.PaymentTerm;
                    subList.AdditionalBatchNo = k.AdditionalBatchNo;
                    subList.QuoteId = k.SZ_Quotation.Id;
                    subList.ProductId = k.ProductId;
                    subList.ProductName = k.ProductName;
                    subList.ScientistRemark = "<input id='sciremark_" + k.Id + "' type='text' value='" + k.ScientistRemark + "' style='width: 170px' />";
                    subList.RequiredQtyTxt = "<input id='qty_" + k.Id + "' type='text' value='" + k.RequiredQty + "' data-cat='" + k.CATNo + "' style='width: 50px' />";
                    subList.AdditionalBatchNoText = "<select id='additionalBatch_" + k.Id + "'><option value=''>--Select--</option>";
                    if (subList.ProductId.HasValue)
                    {
                        var proData = productsdata.Where(x => x.Id == subList.ProductId && x.Published == true && x.Deleted == false).Count();
                        var productData = productsdata.Where(x => x.Id == subList.ProductId && x.Published == true && x.Deleted == false).FirstOrDefault();
                        if (productData != null)
                        {
                            subList.IsControlledSubstance = productData.IsControlledSubstance;
                            if (!subList.IsControlledSubstance.HasValue
                                || subList.IsControlledSubstance == false)
                            {
                                subList.IsControlledSubstance = productData.IsManuallyControlledSubstance;
                            }
                        }
                        var proBatchData = inventoryData.Where(x => x.ProductId == subList.ProductId).ToList();
                        if (proBatchData.Count > 0 && proData > 0)
                        {
                            int loopcnt = 1;
                            foreach (var r in proBatchData)
                            {
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }
                                string selected = string.Empty;
                                if (r.Id == subList.AdditionalBatchNo)
                                {
                                    selected = "selected ";
                                    subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
                                }
                                if (loopcnt == proBatchData.Count && !subList.AdditionalBatchNo.HasValue)
                                {
                                    selected = "selected ";
                                    subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
                                }
                                loopcnt += 1;
                                subList.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' " + selected + ">" + text + "</option>";
                            }
                        }
                    }
                    subList.AdditionalBatchNoText += "</select>";
                    //subList.BatchNo = k.BatchNo;
                    subList.BatchNoText = "<input id='batchno_" + k.Id + "' type='text' value='" + k.BatchNo + "' style='width:120px' />";
                    subList.IsImageAttach = k.SZ_Quotation.IsImageAttach;
                    subList.CompanyName = k.SZ_Quotation.SZ_CompanyList.Name;
                    subList.Email = k.SZ_Quotation.EmailAddress;
                    subList.PONumber = k.SZ_Quotation.PONo;
                    subList.Ref = k.SZ_Quotation.Ref;
                    subList.Remark = k.SZ_Quotation.Remark;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.QuoteDetailsId = k.Id;
                    subList.CASNo = k.CASNo;
                    subList.IsConversionReport = k.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    var impstr = "";
                    if (subList.IsConversionReport.HasValue && subList.IsConversionReport.Value)
                    {
                        impstr += "<img src='/img/important.jpg' width='15px' height='15px' />";
                    }
                    subList.CATNo = "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>" + impstr + " " + CommonOperation.GetMatchingTagHTML(k, "Project");
                    subList.CreatedDate = k.CreatedDate;
                    subList.ImagePath = k.ImagePath;
                    subList.IsUploadServer = k.IsUploadServer;
                    subList.LeadTime = k.LeadTime;
                    subList.Price = k.Price;
                    subList.QuoteId = k.QuoteId;
                    subList.ProjectType = k.ProjectType;
                    subList.ScientistCustomerId = k.ScientistCustomerId;
                    subList.RequiredQty = k.RequiredQty;
                    subList.ProjectStatus = k.ProjectStatus;
                    subList.IsOnHold = k.IsOnHold;
                    if (k.ProjectStatus != null)
                    {
                        subList.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
                    }
                    subList.ScientistStatus = k.ScientistStatus;
                    subList.BatchCode1 = k.BatchCode1;
                    subList.BatchCode2 = k.BatchCode2;
                    subList.Qty1 = k.Qty1;
                    subList.Qty2 = k.Qty2;
                    subList.EstimateCompleteDate = k.EstimateCompleteDate;
                    subList.EstimateCompleteDateText = "<input id='esticompleteDate_" + k.Id + "' data-value='" + k.EstimateCompleteDate + "' type='text' class='datepicker'  style='width:80px' />";
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToProject = k.MoveToProject;
                    subList.Remark = k.Remark;
                    subList.SrPo = k.SrPo;
                    subList.AdminScientistStatus = k.AdminScientistStatus;
                    subList.InvoiceNo = k.InvoiceNo;
                    subList.InvoiceRemark = k.InvoiceRemark;
                    subList.MoveProjectDate = k.MoveProjectDate;

                    subList.ScientistStatustext = "<input id='scientistStatus_" + k.Id + "' type='text' value='" + k.AdminScientistStatus + "' title='" + k.AdminScientistStatus + "'   style='width:200px' />";
                    subList.RemarkText = "<input id='remark_" + k.Id + "' type='text' value='" + k.Remark + "' title='" + k.Remark + "' style='width: 170px' />";
                    subList.LastRowText = "<a href='javascript: void(0)' id='save_" + k.Id + "' onclick='SaveNoActionProjectDetails(\"" + k.Id + "\")'> Save</a> ";
                    subList.LastRowText += "<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";
                    subList.SubScientistName = "<select id='SubScientistId_" + k.Id + "' class='subscientist' subscientistId='" + k.SubScientistName + "' quotedetailsid='" + k.Id + "'><option value=''>--Select--</option>";
                    subscilistItems.ForEach(r =>
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.SubScientistName))
                        {
                            selected = "selected ";
                            subList.SelectedSubScientistName = r.Text;
                        }
                        subList.SubScientistName += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    });
                    subList.SubScientistName += "</select>";
                    subList.DispatchedStatus = k.DispatchedStatus;
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToInvoice = k.MoveToInvoice;
                    subList.IsDispatchApprove = k.IsDispatchApprove;
                    subList.DifficultyLevel = k.DifficultyLevel;
                    subList.DifficultyLevelText = "<select id='difflevel_" + k.Id + "' class='clsDifficultyLevel' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.DifficultyLevel r in Enum.GetValues(typeof(EnumList.DifficultyLevel)))
                    {
                        var item = Enum.GetName(typeof(EnumList.DifficultyLevel), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.DifficultyLevel)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.DifficultyLevel)
                        {
                            selected = "selected ";
                            subList.SelectedProjectType = text;
                        }
                        subList.DifficultyLevelText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                    }
                    subList.DifficultyLevelText += "</select>";
                    subList.MoveProjectDateText = k.MoveProjectDate.HasValue ? k.MoveProjectDate.Value.ToString("dd/MM/yyyy hh:mm tt") : "";
                    subList.IsPriority = k.IsPriority;
                    if (k.IsPriority.HasValue && k.IsPriority.Value)
                    {
                        subList.IsPriorityText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPriority' checked='checked'/>";
                    }
                    else
                    {
                        subList.IsPriorityText = "<input type='checkbox' value='" + k.Id + "' class='clsIsPriority' />";
                    }
                    subList.OrderRemark = k.OrderRemark;
                    subList.OrderRemarkText = "<input id='orderremark_" + k.Id + "' type='text' value='" + k.OrderRemark + "' title='" + k.OrderRemark + "'  style='width:200px' />";
                    subList.Reason = k.Reason;
                    subList.ReasonText = "<input id='reason_" + k.Id + "' type='text' value='" + k.Reason + "' title='" + k.Reason + "'  style='width:200px' />";
                    subList.ExplainationText += "<i class='fa fa-pencil' onclick='explainationGenerate(\"" + k.Id + "\")' ></i>"; //<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";
                    model.Add(subList);
                }
                //Sorting  
                //if (!string.IsNullOrEmpty(sortColumn) && !string.IsNullOrEmpty(sortColumnDir))
                //{
                //    model = model.OrderBy(sortColumn + " " + sortColumnDir).ToList();
                //}
                //else
                //{
                model = model.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).ThenBy(x => x.SrPo).ToList();
                // model = model.OrderBy(x => x.SrPo).ThenByDescending(x=>x.MoveProjectDate).ToList();
                //}

                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.SelectedScientistName != null && m.SelectedScientistName.ToLower().Contains(searchValue))
                                        || (m.SelectedSubScientistName != null && m.SelectedSubScientistName.ToLower().Contains(searchValue))
                                        || (m.CompanyName != null && m.CompanyName.ToLower().Contains(searchValue))
                                        || (m.PONumber != null && m.PONumber.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.Price != null && m.Price.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.SelectedProjectType != null && m.SelectedProjectType.ToLower().Contains(searchValue))
                                        || (m.RequiredQty != null && m.RequiredQty.ToLower().Contains(searchValue))
                                        || (m.SelectedAdditionalBatchNo != null && m.SelectedAdditionalBatchNo.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                         || (m.EstimateCompleteDateText != null && m.EstimateCompleteDateText.ToString().ToLower().Contains(searchValue))
                                          || (m.AdminScientistStatus != null && m.AdminScientistStatus.ToLower().Contains(searchValue))
                                           || (m.ProjectStatustext != null && m.ProjectStatustext.ToLower().Contains(searchValue))
                                            || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                                        || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))).ToList();
                }

                //total number of rows count   
                recordsTotal = model.Count();
                //Paging   
                var data = model.Skip(skip).Take(pageSize).ToList();

                //var finalData = PrepareQuotationListModel(data);
                //Returning Json Data  
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                throw ex;
            }

        }

        [HttpPost]
        public ActionResult LoadProductSynthesisData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                var searchby = string.Empty;
                var searchbyvalue = string.Empty;
                if (Request.Form.GetValues("radiobuton") != null)
                {
                    searchby = Request.Form.GetValues("radiobuton")[0].ToString();
                }
                if (Request.Form.GetValues("searchbox") != null)
                {
                    searchbyvalue = Request.Form.GetValues("searchbox")[0].ToString().Trim();
                }
                var scinameFilter = "";
                if (Request.Form.GetValues("sciname") != null)
                {
                    scinameFilter = Request.Form.GetValues("sciname")[0].ToString();
                }
                var subscinameFilter = "";
                if (Request.Form.GetValues("subsciname") != null)
                {
                    subscinameFilter = Request.Form.GetValues("subsciname")[0].ToString();
                }

                var fltprostatusItem = "";
                if (Request.Form.GetValues("fltprostatusItem") != null)
                {
                    fltprostatusItem = Request.Form.GetValues("fltprostatusItem")[0].ToString();
                }
                var fltactivity = "";
                if (Request.Form.GetValues("fltactivity") != null)
                {
                    fltactivity = Request.Form.GetValues("fltactivity")[0].ToString();
                }

                var fltprotypeItem = "";
                if (Request.Form.GetValues("fltprotypeItem") != null)
                {
                    fltprotypeItem = Request.Form.GetValues("fltprotypeItem")[0].ToString();
                }
                var fltestdate = "";
                if (Request.Form.GetValues("fltprotypeItem") != null)
                {
                    fltestdate = Request.Form.GetValues("fltestdate")[0].ToString();
                }

                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;

                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.Synthesis);
                string pursynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
                // Getting all Customer data  
                var list = (from i in db.SZ_Quotation
                            join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                            where (t2.MoveToProject == true || t2.IsSynthesisLog == true)
                            && string.IsNullOrEmpty(t2.TrackingNo)
                            && (t2.IsOnHold == false || t2.IsOnHold == null)
                            && (t2.ProjectType == inhouseProjectType || t2.ProjectType == pursynthesisProjectType)
                            && (t2.IsSynthesisLog == false || t2.IsSynthesisLog == null)
                            orderby t2.MoveProjectDate descending
                            select t2).Distinct().OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).AsQueryable();

                if (!string.IsNullOrEmpty(scinameFilter))
                {
                    int sciid = Convert.ToInt32(scinameFilter);
                    list = list.Where(x => x.ScientistCustomerId == sciid).AsQueryable();
                }
                if (!string.IsNullOrEmpty(subscinameFilter))
                {
                    string subsciid = Convert.ToString(subscinameFilter);
                    list = list.Where(x => x.SubScientistName == subsciid).AsQueryable();
                }
                if (!string.IsNullOrEmpty(fltprostatusItem))
                {
                    if (fltprostatusItem == "blank")
                    {
                        list = list.Where(x => x.ProStatus == null).AsQueryable();
                    }
                    else
                    {
                        list = list.Where(x => x.ProStatus == fltprostatusItem).AsQueryable();
                    }
                }
                if (!string.IsNullOrEmpty(fltprotypeItem))
                {
                    list = list.Where(x => x.ProjectType == fltprotypeItem).AsQueryable();
                }
                if (!string.IsNullOrEmpty(fltestdate))
                {
                    DateTime estdat = Convert.ToDateTime(fltestdate);
                    list = list.Where(x => x.EstimateCompleteDate == estdat).AsQueryable();
                }

                if (!string.IsNullOrEmpty(fltactivity))
                {
                    list = list.Where(x => x.ActivityStatus == fltactivity).AsQueryable();
                }

                if (!string.IsNullOrEmpty(searchby) && !string.IsNullOrEmpty(searchbyvalue))
                {
                    searchbyvalue = searchbyvalue.ToLower();
                    if (searchbyvalue.Contains("+"))
                    {
                        List<string> searchlist = searchbyvalue.Split('+').Select(p => p.Trim()).ToList();

                        List<SZ_QuotationDetail> objmodel = new List<SZ_QuotationDetail>();
                        foreach (var item in searchlist)
                        {
                            var d = list.Where(x => x.SZ_Quotation.CompanyName.Contains(item) ||
                                                x.SZ_Quotation.PONo.ToLower().Contains(item) ||
                                                x.ProductName.ToLower().Contains(item) ||
                                                (x.CASNo != null ? x.CASNo.ToLower().Contains(item) : false) ||
                                                (x.CATNo != null ? x.CATNo.ToLower().Contains(item) : false) ||
                                               (x.BatchNo != null ? x.BatchNo.ToLower().Contains(item) : false)).ToList();
                            if (d != null && d.Count > 0)
                            {
                                objmodel.AddRange(d);
                            }
                        }
                        if (objmodel != null && objmodel.Count > 0)
                        {
                            list = objmodel.AsQueryable();
                        }
                    }
                    else
                    {
                        if (searchby == "quoteid")
                        {
                            list = list.Where(x => x.SZ_Quotation.Ref.ToLower().Contains(searchbyvalue)).AsQueryable();
                        }
                        if (searchby == "ponumber")
                        {
                            list = list.Where(x => x.SZ_Quotation.PONo.ToLower().Contains(searchbyvalue)).AsQueryable();
                        }
                        if (searchby == "company")
                        {
                            list = list.Where(x => x.SZ_Quotation.CompanyName.ToLower().Contains(searchbyvalue)).AsQueryable();
                        }
                        if (searchby == "productname")
                        {
                            list = list.Where(x => x.ProductName.ToLower().Contains(searchbyvalue)).AsQueryable();
                        }
                        if (searchby == "cas")
                        {
                            list = list.Where(x => x.CASNo != null ? x.CASNo.ToLower().Contains(searchbyvalue) : false).AsQueryable();
                        }
                        if (searchby == "cat")
                        {
                            list = list.Where(x => x.CATNo != null ? x.CATNo.ToLower().Contains(searchbyvalue) : false).AsQueryable();
                        }
                        if (searchby == "batchno")
                        {
                            var bid = db.SZ_Inventory.Where(x => x.BatchNo.Trim().ToLower() == searchbyvalue).Select(x => x.Id).FirstOrDefault();
                            list = list.Where(x => x.AdditionalBatchNo == bid).AsQueryable();
                        }
                    }
                }
                string internationcompanylist = "";
                if (SessionCookieManagement.IsInternational)
                {
                    internationcompanylist = db.SZ_UserManagement.Where(x => x.UserId == SessionCookieManagement.UserId).Select(x => x.CompanyIds).FirstOrDefault();
                    if (!string.IsNullOrEmpty(internationcompanylist))
                    {
                        List<int?> cidList = new List<int?>();
                        foreach (var item in internationcompanylist.Split(','))
                        {
                            if (!string.IsNullOrEmpty(item))
                            {
                                cidList.Add(Convert.ToInt32(item));
                            }
                        }
                        list = list.Where(x => cidList.Contains(x.SZ_Quotation.CompanyId) && x.SZ_Quotation.CreatedDate >= new DateTime(2022, 05, 01)).AsQueryable();
                    }
                }
                var subscilistItems = new List<SelectListItem>();
                var listItems = new List<SelectListItem>();
                MemoryCacheManager objCache = new MemoryCacheManager();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });

                var scienList = objCache.Get("cache.GetScientistId", () =>
                {
                    return db.GetScientistId().ToList();
                });

                var subscienList = objCache.Get("cache.subscienList", () =>
                {
                    return db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();
                });
                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    }); subscilistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                });

                foreach (var term in subscienList)
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }

                    subscilistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });

                }
                var proIds = list.Select(x => x.ProductId).Distinct().ToList();
                var productsdata = db.Products.Where(x => proIds.Contains(x.Id) && x.Deleted == false && x.Published == true).ToList();
                var inventoryData = db.SZ_Inventory.Where(x => proIds.Contains(x.ProductId)).ToList();
                var ReadyToDeliverScientistStatusId = db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                var model = new List<ProjectListModel>();
                foreach (var k in list)
                {
                    ProjectListModel subList = new ProjectListModel();
                    subList.IsConversionReport = k.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    subList.ChkSaveRow = "<input type='checkbox' value='" + k.Id + "' class='clsSaverow' />";
                    subList.ReadyToDeliverScientistStatusId = ReadyToDeliverScientistStatusId;
                    if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == subList.ReadyToDeliverScientistStatusId && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                    {
                        subList.ChkFirstRow = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                    }
                    else if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == subList.ReadyToDeliverScientistStatusId)
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' />";
                    }
                    else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && k.MoveToDispatch == null)
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' />";
                    }
                    else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                    {
                        subList.ChkFirstRow = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                    }
                    subList.ProjectType = k.ProjectType;
                    subList.ProjectTypeText = "<select id='projecttype_" + k.Id + "' class='clsProjType' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ProjectType), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.ProjectType)
                        {
                            selected = "selected ";
                            subList.SelectedProjectType = text;
                        }
                        //if (text != "In-House")
                        //{
                            subList.ProjectTypeText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                        //}
                    }
                    subList.ProjectTypeText += "</select>";
                    subList.ScientistName = "<select id='ScientistId_" + k.Id + "' class='scientist' scientistId='" + k.ScientistCustomerId + "' quotedetailsid='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (var r in listItems)
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.ScientistCustomerId))
                        {
                            selected = "selected ";
                            subList.SelectedScientistName = r.Text;
                        }
                        subList.ScientistName += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    }
                    subList.ScientistName += "</select>";
                    subList.AdditionalBatchNo = k.AdditionalBatchNo;
                    subList.QuoteId = k.SZ_Quotation.Id;
                    subList.ProductId = k.ProductId;
                    subList.ProductName = k.ProductName;
                    subList.PaymentTerms = k.SZ_Quotation.PaymentTerm;
                    subList.ScientistRemark = "<input id='sciremark_" + k.Id + "' type='text' value='" + k.ScientistRemark + "' style='width: 170px' />";
                    subList.RequiredQtyTxt = "<input id='qty_" + k.Id + "' type='text' value='" + k.RequiredQty + "' style='width: 50px' />";
                    subList.AdditionalBatchNoText = "<select id='additionalBatch_" + k.Id + "' data-quotationdetailsid='" + k.Id + "' class='ddladditionalbatch'><option value=''>--Select--</option>";
                    if (subList.ProductId.HasValue)
                    {
                        var proData = productsdata.Where(x => x.Id == subList.ProductId && x.Published == true && x.Deleted == false).Count();
                        var productData = productsdata.Where(x => x.Id == subList.ProductId && x.Published == true && x.Deleted == false).FirstOrDefault();
                        if (productData != null)
                        {
                            subList.IsControlledSubstance = productData.IsControlledSubstance;
                            if (!subList.IsControlledSubstance.HasValue
                                || subList.IsControlledSubstance == false)
                            {
                                subList.IsControlledSubstance = productData.IsManuallyControlledSubstance;
                            }
                        }
                        if (productData != null && productData.SZ_ProductScheme != null && productData.SZ_ProductScheme.Count > 0)
                        {
                            //if (SessionCookieManagement.IsAdmin)
                            //{
                            subList.ProductScheme = "<i class='fa fa-eye' onclick='ViewProductScheme(" + k.ProductId + ")' ></i>";
                            //}
                        }
                        var proBatchData = inventoryData.Where(x => x.ProductId == subList.ProductId).ToList();
                        if (proBatchData.Count > 0 && proData > 0)
                        {
                            foreach (var r in proBatchData)
                            {
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }
                                string selected = string.Empty;
                                if (r.Id == subList.AdditionalBatchNo)
                                {
                                    selected = "selected ";
                                    subList.BatchNo = r.BatchNo;
                                    subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
                                }

                                subList.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' " + selected + ">" + text + "</option>";
                            }
                        }
                    }
                    subList.AdditionalBatchNoText += "</select>";
                    //subList.BatchNo = k.BatchNo;
                    subList.BatchNoText = "<input id='batchno_" + k.Id + "' type='text' value='" + k.BatchNo + "' style='width:120px' />";
                    subList.IsImageAttach = k.SZ_Quotation.IsImageAttach;
                    subList.CompanyName = k.SZ_Quotation.SZ_CompanyList.Name;
                    subList.Email = k.SZ_Quotation.EmailAddress;
                    subList.PONumber = k.SZ_Quotation.PONo;
                    subList.Ref = k.SZ_Quotation.Ref;
                    subList.Remark = k.SZ_Quotation.Remark;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.QuoteDetailsId = k.Id;
                    subList.CASNo = k.CASNo;
                    subList.IsConversionReport = k.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    var impstr = "";
                    if (subList.IsConversionReport.HasValue && subList.IsConversionReport.Value)
                    {
                        impstr += "<img src='/img/important.jpg' width='15px' height='15px' />";
                    }
                    subList.CATNo = "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>" + impstr + " " + CommonOperation.GetMatchingTagHTML(k, "Project");
                    subList.CreatedDate = k.CreatedDate;
                    subList.ImagePath = k.ImagePath;
                    subList.IsUploadServer = k.IsUploadServer;
                    subList.LeadTime = k.LeadTime;
                    subList.Price = k.Price;

                    subList.QuoteId = k.QuoteId;
                    subList.ProjectType = k.ProjectType;
                    subList.ScientistCustomerId = k.ScientistCustomerId;

                    subList.RequiredQty = k.RequiredQty;
                    subList.ProjectStatus = k.ProjectStatus;
                    subList.IsOnHold = k.IsOnHold;
                    if (k.ProjectStatus != null)
                    {
                        subList.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
                    }
                    subList.ScientistStatus = k.ScientistStatus;
                    subList.BatchCode1 = k.BatchCode1;
                    subList.BatchCode2 = k.BatchCode2;
                    subList.Qty1 = k.Qty1;
                    subList.Qty2 = k.Qty2;
                    subList.EstimateCompleteDate = k.EstimateCompleteDate;
                    //if (k.EstimateCompleteDate.HasValue)
                    //{
                    //    // subList.EstimateCompleteDateText = k.EstimateCompleteDate.Value.ToShortDateString();
                    //    subList.EstimateCompleteDateText = k.EstimateCompleteDate.Value.ToShortDateString();
                    //}
                    subList.EstimateCompleteDateText = "<input id='esticompleteDate_" + k.Id + "' data-value='" + k.EstimateCompleteDate + "' type='text' class='datepicker'  style='width:80px' />";
                    //if (k.AdditionalBatchNo.HasValue)
                    //{
                    //    subList.AdditionalBatchNoText = db.SZ_Inventory.Where(x => x.Id == k.AdditionalBatchNo).Select(x => x.BatchNo).FirstOrDefault();
                    //}
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToProject = k.MoveToProject;
                    subList.Remark = k.Remark;
                    subList.SrPo = k.SrPo;
                    subList.AdminScientistStatus = k.AdminScientistStatus;
                    subList.InvoiceNo = k.InvoiceNo;
                    subList.InvoiceRemark = k.InvoiceRemark;

                    subList.MoveProjectDate = k.MoveProjectDate;

                    subList.ScientistStatustext = "<input id='scientistStatus_" + k.Id + "' type='text' value='" + k.AdminScientistStatus + "' title='" + k.AdminScientistStatus + "'   style='width:200px' />";
                    subList.RemarkText = "<input id='remark_" + k.Id + "' type='text' value='" + k.Remark + "' title='" + k.Remark + "' style='width: 170px' />";
                    subList.LastRowText = "<a href='javascript: void(0)' id='save_" + k.Id + "' onclick='SaveSynthesisProjectDetails(\"" + k.Id + "\")'> Save</a> ";
                    subList.LastRowText += "<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";
                    subList.SubScientistName = "<select id='SubScientistId_" + k.Id + "' class='subscientist' subscientistId='" + k.SubScientistName + "' quotedetailsid='" + k.Id + "'><option value=''>--Select--</option>";
                    subscilistItems.ForEach(r =>
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.SubScientistName))
                        {
                            selected = "selected ";
                            subList.SelectedSubScientistName = r.Text;
                        }
                        subList.SubScientistName += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    });

                    subList.SubScientistName += "</select>";
                    subList.DispatchedStatus = k.DispatchedStatus;
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToInvoice = k.MoveToInvoice;
                    subList.IsDispatchApprove = k.IsDispatchApprove;
                    subList.OrderRemark = k.OrderRemark;
                    subList.OrderRemarkText = "<input id='orderremark_" + k.Id + "' type='text' value='" + k.OrderRemark + "' title='" + k.OrderRemark + "'  style='width:200px' />";
                    subList.Reason = k.Reason;
                    subList.ReasonText = "<input id='reason_" + k.Id + "' type='text' value='" + k.Reason + "' title='" + k.Reason + "'  style='width:200px' />";
                    subList.MoveProjectDateText = k.MoveProjectDate.HasValue ? k.MoveProjectDate.Value.ToString("dd/MM/yyyy hh:mm tt") : "";
                    subList.ProStatus = k.ProStatus;
                    subList.ProStatusText = "<select id='prostatus_" + k.Id + "' class='clsProjStatus' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.ProStatusDDL r in Enum.GetValues(typeof(EnumList.ProStatusDDL)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ProStatusDDL), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ProStatusDDL)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.ProStatus)
                        {
                            selected = "selected ";
                            subList.SelectedProStatus = text;
                        }
                        subList.ProStatusText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                    }
                    subList.ProStatusText += "</select>";
                    if (k.SynStartDate.HasValue)
                    {
                        subList.SynStartDate = k.SynStartDate.Value.ToShortDateString();
                    }
                    model.Add(subList);
                }
                //Sorting  
                //if (!string.IsNullOrEmpty(sortColumn) && !string.IsNullOrEmpty(sortColumnDir))
                //{
                //    model = model.OrderBy(sortColumn + " " + sortColumnDir).ToList();
                //}
                //else
                //{
                model = model.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).ThenBy(x => x.SrPo).ToList();
                // model = model.OrderBy(x => x.SrPo).ThenByDescending(x=>x.MoveProjectDate).ToList();
                //}

                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.SelectedScientistName != null && m.SelectedScientistName.ToLower().Contains(searchValue))
                                        || (m.SelectedSubScientistName != null && m.SelectedSubScientistName.ToLower().Contains(searchValue))
                                        || (m.CompanyName != null && m.CompanyName.ToLower().Contains(searchValue))
                                        || (m.PONumber != null && m.PONumber.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.Price != null && m.Price.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.SelectedProjectType != null && m.SelectedProjectType.ToLower().Contains(searchValue))
                                        || (m.RequiredQty != null && m.RequiredQty.ToLower().Contains(searchValue))
                                        || (m.SelectedAdditionalBatchNo != null && m.SelectedAdditionalBatchNo.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        || (m.EstimateCompleteDateText != null && m.EstimateCompleteDateText.ToString().ToLower().Contains(searchValue))
                                        || (m.AdminScientistStatus != null && m.AdminScientistStatus.ToLower().Contains(searchValue))
                                        || (m.ProjectStatustext != null && m.ProjectStatustext.ToLower().Contains(searchValue))
                                        || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                                        || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))).ToList();
                }
                if (!string.IsNullOrEmpty(searchby) && !string.IsNullOrEmpty(searchbyvalue))
                {
                    searchbyvalue = searchbyvalue.ToLower();
                    if (searchby == "quoteid")
                    {
                        model = model.Where(x => x.Ref.ToLower().Contains(searchbyvalue)).ToList();
                    }
                    if (searchby == "ponumber")
                    {
                        model = model.Where(x => x.PONumber.ToLower().Contains(searchbyvalue)).ToList();
                    }
                    if (searchby == "company")
                    {
                        model = model.Where(x => x.CompanyName.ToLower().Contains(searchbyvalue)).ToList();
                    }
                    if (searchby == "productname")
                    {
                        model = model.Where(x => x.ProductName.ToLower().Contains(searchbyvalue)).ToList();
                    }
                    if (searchby == "cas")
                    {
                        model = model.Where(x => x.CASNo != null ? x.CASNo.ToLower().Contains(searchbyvalue) : false).ToList();
                    }
                    if (searchby == "cat")
                    {
                        model = model.Where(x => x.CATNo != null ? x.CATNo.ToLower().Contains(searchbyvalue) : false).ToList();
                    }
                    if (searchby == "batchno")
                    {
                        model = model.Where(x => x.BatchNo != null ? x.BatchNo.ToLower().Contains(searchbyvalue) : false).ToList();
                    }
                }
                //total number of rows count   
                recordsTotal = model.Count();
                //Paging   
                var data = model.Skip(skip).Take(pageSize).ToList();

                //var finalData = PrepareQuotationListModel(data);
                //Returning Json Data  
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                throw ex;
            }

        }


        [HttpPost]
        public ActionResult LoadDomesticInstockData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                var fltactivity = Request.Form.GetValues("fltactivity")[0].ToString();
                var fltdomesticprostatusItem = Request.Form.GetValues("fltdomesticprostatusItem")[0].ToString();

                var searchby = string.Empty;
                var searchbyvalue = string.Empty;
                if (Request.Form.GetValues("radiobuton") != null)
                {
                    searchby = Request.Form.GetValues("radiobuton")[0].ToString();
                }
                if (Request.Form.GetValues("searchbox") != null)
                {
                    searchbyvalue = Request.Form.GetValues("searchbox")[0].ToString().Trim();
                }
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;

                string instockProjectType = Convert.ToString((int)EnumList.ProjectType.InStock);

                // Getting all Customer data  
                var list = (from i in db.SZ_Quotation
                            join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                            where (t2.MoveToProject == true)
                            && string.IsNullOrEmpty(t2.TrackingNo)
                            && (t2.IsOnHold == false || t2.IsOnHold == null)
                            && (t2.ProjectType == instockProjectType)
                            && i.CountryTypeId == 1
                            orderby t2.MoveProjectDate descending
                            select t2).Distinct().AsQueryable();

                list = list.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).AsQueryable();
                var subscilistItems = new List<SelectListItem>();
                var listItems = new List<SelectListItem>();
                MemoryCacheManager objCache = new MemoryCacheManager();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });

                var scienList = objCache.Get("cache.GetScientistId", () =>
                {
                    return db.GetScientistId().ToList();
                });

                var subscienList = objCache.Get("cache.subscienList", () =>
                {
                    return db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();
                });
                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                    subscilistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                });


                foreach (var term in subscienList)
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }

                    subscilistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });

                }
                var proIds = list.Select(x => x.ProductId).Distinct().ToList();
                var productsdata = db.Products.Where(x => proIds.Contains(x.Id) && x.Deleted == false && x.Published == true).ToList();

                var inventoryData = db.SZ_Inventory.Where(x => proIds.Contains(x.ProductId)).ToList();
                var ReadyToDeliverScientistStatusId = db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();

                list = list.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).ThenBy(x => x.SrPo).AsQueryable();
                //Search
                if (!string.IsNullOrEmpty(fltactivity))
                {
                    list = list.Where(x => x.ActivityStatus == fltactivity).AsQueryable();
                }
                if (!string.IsNullOrEmpty(fltdomesticprostatusItem))
                {
                    list = list.Where(x => x.OtherProStatus == fltdomesticprostatusItem).AsQueryable();
                }
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    //model = list.Where(m => (m.SelectedScientistName != null && m.SelectedScientistName.ToLower().Contains(searchValue))
                    //                    || (m.SelectedSubScientistName != null && m.SelectedSubScientistName.ToLower().Contains(searchValue))
                    //                    || (m.CompanyName != null && m.CompanyName.ToLower().Contains(searchValue))
                    //                    || (m.PONumber != null && m.PONumber.ToLower().Contains(searchValue))
                    //                    || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                    //                    || (m.Price != null && m.Price.ToLower().Contains(searchValue))
                    //                    || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                    //                    || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                    //                    || (m.SelectedProjectType != null && m.SelectedProjectType.ToLower().Contains(searchValue))
                    //                    || (m.RequiredQty != null && m.RequiredQty.ToLower().Contains(searchValue))
                    //               LoadDomesticInstockData     || (m.SelectedAdditionalBatchNo != null && m.SelectedAdditionalBatchNo.ToLower().Contains(searchValue))
                    //                    || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                    //                     || (m.EstimateCompleteDateText != null && m.EstimateCompleteDateText.ToString().ToLower().Contains(searchValue))
                    //                      || (m.AdminScientistStatus != null && m.AdminScientistStatus.ToLower().Contains(searchValue))
                    //                       || (m.ProjectStatustext != null && m.ProjectStatustext.ToLower().Contains(searchValue))
                    //                        || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                    //                        || (m.ActivityStatus != null && m.ActivityStatus.ToLower().Contains(searchValue))
                    //                    || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))).ToList();
                }
                if (!string.IsNullOrEmpty(searchby) && !string.IsNullOrEmpty(searchbyvalue))
                {
                    searchbyvalue = searchbyvalue.ToLower();
                    if (searchby == "quoteid")
                    {
                        list = list.Where(x => x.SZ_Quotation.Ref.ToLower().Contains(searchbyvalue)).AsQueryable();
                    }
                    if (searchby == "ponumber")
                    {
                        list = list.Where(x => x.SZ_Quotation.PONo.ToLower().Contains(searchbyvalue)).AsQueryable();
                    }
                    if (searchby == "company")
                    {
                        list = list.Where(x => x.SZ_Quotation.CompanyName.ToLower().Contains(searchbyvalue)).AsQueryable();
                    }
                    if (searchby == "productname")
                    {
                        list = list.Where(x => x.ProductName.ToLower().Contains(searchbyvalue)).AsQueryable();
                    }
                    if (searchby == "cas")
                    {
                        list = list.Where(x => x.CASNo != null ? x.CASNo.ToLower().Contains(searchbyvalue) : false).AsQueryable();
                    }
                    if (searchby == "cat")
                    {
                        list = list.Where(x => x.CATNo != null ? x.CATNo.ToLower().Contains(searchbyvalue) : false).AsQueryable();
                    }
                    if (searchby == "batchno")
                    {
                        list = list.Where(x => x.BatchNo != null ? x.BatchNo.ToLower().Contains(searchbyvalue) : false).AsQueryable();
                    }
                }
                //total number of rows count   
                recordsTotal = list.Count();
                //Paging   
                var data = list.Skip(skip).Take(pageSize).ToList();

                var model = new List<ProjectListModel>();
                foreach (var k in data)
                {
                    ProjectListModel subList = new ProjectListModel();
                    subList.IsConversionReport = k.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    subList.ChkSaveRow = "<input type='checkbox' value='" + k.Id + "' class='clsSaverow' />";
                    subList.ReadyToDeliverScientistStatusId = ReadyToDeliverScientistStatusId;
                    if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == subList.ReadyToDeliverScientistStatusId && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                    {
                        subList.ChkFirstRow = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                    }
                    else if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == subList.ReadyToDeliverScientistStatusId)
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' />";
                    }
                    else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && k.MoveToDispatch == null)
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' />";
                    }
                    else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                    {
                        subList.ChkFirstRow = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                    }
                    if (k.IsDispatchApprove.HasValue && k.IsDispatchApprove.Value && (k.MoveToDispatch == null || k.MoveToDispatch == false))
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' style='outline: 4px solid #c00'/>";
                    }
                    subList.ProjectType = k.ProjectType;

                    subList.ActivityStatus = k.ActivityStatus;
                    subList.ActivityStatusText = "<select id='activitystatus_" + k.Id + "' class='clsActivityStatus' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";

                    if (k.ActivityStatus == "Approval First")
                    {
                        subList.ActivityStatusText += "<option value='Approval First' selected>Approval First</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Approval First'>Approval First</option>";
                    }
                    if (k.ActivityStatus == "Immediate Dispatch")
                    {
                        subList.ActivityStatusText += "<option value='Immediate Dispatch' selected>Immediate Dispatch</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Immediate Dispatch'>Immediate Dispatch</option>";
                    }

                    if (k.ActivityStatus == "Repeat Order")
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order' selected>Repeat Order</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order'>Repeat Order</option>";
                    }

                    if (k.ActivityStatus == "Repeat Order - Dispatch")
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Dispatch' selected>Repeat Order - Dispatch</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Dispatch'>Repeat Order - Dispatch</option>";
                    }
                    if (k.ActivityStatus == "Repeat Order - Approval First")
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Approval First' selected>Repeat Order - Approval First</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Approval First'>Repeat Order - Approval First</option>";
                    }
                    if (k.ActivityStatus == "Short Qty Dispatch")
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatch' selected>Short Qty Dispatch</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatch'>Short Qty Dispatch</option>";
                    }
                    if (k.ActivityStatus == "Short Qty Dispatched")
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatched' selected>Short Qty Dispatched</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatched'>Short Qty Dispatched</option>";
                    }
                    if (k.ActivityStatus == "Sample Request")
                    {
                        subList.ActivityStatusText += "<option value='Sample Request' selected>Sample Request</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Sample Request'>Sample Request</option>";
                    }
                    if (k.ActivityStatus == "Sample Sent")
                    {
                        subList.ActivityStatusText += "<option value='Sample Sent' selected>Sample Sent</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Sample Sent'>Sample Sent</option>";
                    }
                    if (k.ActivityStatus == "Sample Approved")
                    {
                        subList.ActivityStatusText += "<option value='Sample Approved' selected>Sample Approved</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Sample Approved'>Sample Approved</option>";
                    }
                    if (k.ActivityStatus == "Quote - Data Sent")
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Sent' selected>Quote - Data Sent</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Sent'>Quote - Data Sent</option>";
                    }
                    if (k.ActivityStatus == "Quote - Data Approved")
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Approved' selected>Quote - Data Approved</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Approved'>Quote - Data Approved</option>";
                    }
                    subList.ActivityStatusText += "</select>";

                    subList.ProjectTypeText = "<select id='projecttype_" + k.Id + "' class='clsProjType' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ProjectType), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.ProjectType)
                        {
                            selected = "selected ";
                            subList.SelectedProjectType = text;
                        }
                        //if (text != "In-House")
                        //{
                            subList.ProjectTypeText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                        //}
                    }
                    subList.ProjectTypeText += "</select>";
                    subList.ScientistName = "<select id='ScientistId_" + k.Id + "' class='scientist' scientistId='" + k.ScientistCustomerId + "' quotedetailsid='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (var r in listItems)
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.ScientistCustomerId))
                        {
                            selected = "selected ";
                            subList.SelectedScientistName = r.Text;
                        }
                        subList.ScientistName += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    }
                    subList.ScientistName += "</select>";
                    subList.AdditionalBatchNo = k.AdditionalBatchNo;
                    subList.QuoteId = k.SZ_Quotation.Id;
                    subList.ProductId = k.ProductId;
                    subList.ProductName = k.ProductName;
                    subList.IsPaymentPending = k.SZ_Quotation.SZ_CompanyList.IsPaymentPending;
                    subList.ScientistRemark = "<input id='sciremark_" + k.Id + "' type='text' value='" + k.ScientistRemark + "' style='width: 170px' />";
                    subList.RequiredQtyTxt = "<input id='qty_" + k.Id + "' type='text' value='" + k.RequiredQty + "' style='width: 50px' />";
                    subList.AdditionalBatchNoText = "<select id='additionalBatch_" + k.Id + "' data-quotationdetailsid='" + k.Id + "' class='ddladditionalbatch'><option value=''>--Select--</option>";
                    if (subList.ProductId.HasValue)
                    {
                        var proData = productsdata.Where(x => x.Id == subList.ProductId && x.Published == true && x.Deleted == false).Count();

                        var productData = productsdata.Where(x => x.Id == subList.ProductId && x.Published == true && x.Deleted == false).FirstOrDefault();
                        if (productData != null)
                        {
                            subList.IsControlledSubstance = productData.IsControlledSubstance;
                            if (!subList.IsControlledSubstance.HasValue
                                || subList.IsControlledSubstance == false)
                            {
                                subList.IsControlledSubstance = productData.IsManuallyControlledSubstance;
                            }
                        }
                        var proBatchData = inventoryData.Where(x => x.ProductId == subList.ProductId).ToList();
                        if (proBatchData.Count > 0 && proData > 0)
                        {
                            foreach (var r in proBatchData)
                            {
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }
                                string selected = string.Empty;
                                if (r.Id == subList.AdditionalBatchNo)
                                {
                                    selected = "selected ";
                                    subList.BatchNo = r.BatchNo;
                                    subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
                                }

                                subList.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' " + selected + ">" + text + "</option>";
                            }
                        }
                    }
                    subList.AdditionalBatchNoText += "</select>";
                    //subList.BatchNo = k.BatchNo;
                    subList.BatchNoText = "<input id='batchno_" + k.Id + "' type='text' value='" + k.BatchNo + "' style='width:120px' />";
                    subList.IsImageAttach = k.SZ_Quotation.IsImageAttach;
                    subList.CompanyName = k.SZ_Quotation.SZ_CompanyList.Name;
                    subList.Email = k.SZ_Quotation.EmailAddress;
                    subList.PONumber = k.SZ_Quotation.PONo;
                    subList.Ref = k.SZ_Quotation.Ref;
                    subList.Remark = k.SZ_Quotation.Remark;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.QuoteDetailsId = k.Id;
                    subList.CASNo = k.CASNo;
                    subList.IsConversionReport = k.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    var impstr = "";
                    if (subList.IsConversionReport.HasValue && subList.IsConversionReport.Value)
                    {
                        impstr += "<img src='/img/important.jpg' width='15px' height='15px' />";
                    }
                    subList.CATNo = "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>" + impstr + " " + CommonOperation.GetMatchingTagHTML(k, "Project");
                    subList.CreatedDate = k.CreatedDate;
                    subList.ImagePath = k.ImagePath;
                    subList.IsUploadServer = k.IsUploadServer;
                    subList.LeadTime = k.LeadTime;
                    subList.Price = k.Price;

                    subList.QuoteId = k.QuoteId;
                    subList.ProjectType = k.ProjectType;
                    subList.ScientistCustomerId = k.ScientistCustomerId;

                    subList.RequiredQty = k.RequiredQty;
                    subList.ProjectStatus = k.ProjectStatus;
                    subList.IsOnHold = k.IsOnHold;
                    if (k.ProjectStatus != null)
                    {
                        subList.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
                    }
                    subList.ScientistStatus = k.ScientistStatus;
                    subList.BatchCode1 = k.BatchCode1;
                    subList.BatchCode2 = k.BatchCode2;
                    subList.Qty1 = k.Qty1;
                    subList.Qty2 = k.Qty2;
                    subList.EstimateCompleteDate = k.EstimateCompleteDate;
                    subList.EstimateCompleteDateText = "<input id='esticompleteDate_" + k.Id + "' data-value='" + k.EstimateCompleteDate + "' type='text' class='datepicker'  style='width:80px' />";
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToProject = k.MoveToProject;
                    subList.Remark = k.Remark;
                    subList.SrPo = k.SrPo;
                    subList.AdminScientistStatus = k.AdminScientistStatus;
                    subList.InvoiceNo = k.InvoiceNo;
                    subList.InvoiceRemark = k.InvoiceRemark;

                    subList.MoveProjectDate = k.MoveProjectDate;

                    subList.ScientistStatustext = "<input id='scientistStatus_" + k.Id + "' type='text' value='" + k.AdminScientistStatus + "' title='" + k.AdminScientistStatus + "'   style='width:200px' />";
                    subList.RemarkText = "<input id='remark_" + k.Id + "' type='text' value='" + k.Remark + "' title='" + k.Remark + "' style='width: 170px' />";
                    subList.LastRowText = "<a href='javascript: void(0)' id='save_" + k.Id + "' onclick='SaveSynthesisProjectDetails(\"" + k.Id + "\")'> Save</a> ";
                    subList.LastRowText += "<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";
                    subList.SubScientistName = "<select id='SubScientistId_" + k.Id + "' class='subscientist' subscientistId='" + k.SubScientistName + "' quotedetailsid='" + k.Id + "'><option value=''>--Select--</option>";
                    subscilistItems.ForEach(r =>
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.SubScientistName))
                        {
                            selected = "selected ";
                            subList.SelectedSubScientistName = r.Text;
                        }
                        subList.SubScientistName += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    });


                    subList.SubScientistName += "</select>";
                    subList.DispatchedStatus = k.DispatchedStatus;
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToInvoice = k.MoveToInvoice; subList.IsDispatchApprove = k.IsDispatchApprove;
                    subList.OrderRemark = k.OrderRemark;
                    subList.OrderRemarkText = "<input id='orderremark_" + k.Id + "' type='text' value='" + k.OrderRemark + "' title='" + k.OrderRemark + "'  style='width:200px' />";
                    subList.Reason = k.Reason;
                    subList.ReasonText = "<input id='reason_" + k.Id + "' type='text' value='" + k.Reason + "' title='" + k.Reason + "'  style='width:200px' />";
                    subList.MoveProjectDateText = k.MoveProjectDate.HasValue ? k.MoveProjectDate.Value.ToString("dd/MM/yyyy hh:mm tt") : "";
                    subList.COARefNumber = k.COARefNumber;
                    if (!string.IsNullOrEmpty(k.SZ_Quotation.Attachment))
                    {
                        subList.Attachment = "<a href = 'javascript:void(0)' onclick='attachment(" + k.QuoteId + ")'><i class='fa fa-paperclip'></i></a>";
                    }
                    subList.ProStatus = k.ProStatus;
                    subList.OtherProStatusText = "<select id='otherprostatus_" + k.Id + "' class='clsotherprostatus' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.ProInstockexportStatusDDL r in Enum.GetValues(typeof(EnumList.ProInstockexportStatusDDL)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ProInstockexportStatusDDL), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ProInstockexportStatusDDL)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.OtherProStatus)
                        {
                            selected = "selected ";
                            subList.SelectedOtherProStatus = text;
                        }
                        subList.OtherProStatusText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                    }
                    subList.OtherProStatusText += "</select>";
                    model.Add(subList);
                }
                //model = model.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).ThenBy(x => x.SrPo).ToList();
                ////Search
                //if (!string.IsNullOrEmpty(fltactivity))
                //{
                //    model = model.Where(x => x.ActivityStatus == fltactivity).ToList();
                //}
                //if (!string.IsNullOrEmpty(fltdomesticprostatusItem))
                //{
                //    model = model.Where(x => x.ProStatus == fltdomesticprostatusItem).ToList();
                //}
                //if (!string.IsNullOrEmpty(searchValue))
                //{
                //    searchValue = searchValue.ToLower().Trim();
                //    model = model.Where(m => (m.SelectedScientistName != null && m.SelectedScientistName.ToLower().Contains(searchValue))
                //                        || (m.SelectedSubScientistName != null && m.SelectedSubScientistName.ToLower().Contains(searchValue))
                //                        || (m.CompanyName != null && m.CompanyName.ToLower().Contains(searchValue))
                //                        || (m.PONumber != null && m.PONumber.ToLower().Contains(searchValue))
                //                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                //                        || (m.Price != null && m.Price.ToLower().Contains(searchValue))
                //                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                //                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                //                        || (m.SelectedProjectType != null && m.SelectedProjectType.ToLower().Contains(searchValue))
                //                        || (m.RequiredQty != null && m.RequiredQty.ToLower().Contains(searchValue))
                //                        || (m.SelectedAdditionalBatchNo != null && m.SelectedAdditionalBatchNo.ToLower().Contains(searchValue))
                //                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                //                         || (m.EstimateCompleteDateText != null && m.EstimateCompleteDateText.ToString().ToLower().Contains(searchValue))
                //                          || (m.AdminScientistStatus != null && m.AdminScientistStatus.ToLower().Contains(searchValue))
                //                           || (m.ProjectStatustext != null && m.ProjectStatustext.ToLower().Contains(searchValue))
                //                            || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                //                            || (m.ActivityStatus != null && m.ActivityStatus.ToLower().Contains(searchValue))
                //                        || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))).ToList();
                //}
                //if (!string.IsNullOrEmpty(searchby) && !string.IsNullOrEmpty(searchbyvalue))
                //{
                //    searchbyvalue = searchbyvalue.ToLower();
                //    if (searchby == "quoteid")
                //    {
                //        model = model.Where(x => x.Ref.ToLower().Contains(searchbyvalue)).ToList();
                //    }
                //    if (searchby == "ponumber")
                //    {
                //        model = model.Where(x => x.PONumber.ToLower().Contains(searchbyvalue)).ToList();
                //    }
                //    if (searchby == "company")
                //    {
                //        model = model.Where(x => x.CompanyName.ToLower().Contains(searchbyvalue)).ToList();
                //    }
                //    if (searchby == "productname")
                //    {
                //        model = model.Where(x => x.ProductName.ToLower().Contains(searchbyvalue)).ToList();
                //    }
                //    if (searchby == "cas")
                //    {
                //        model = model.Where(x => x.CASNo != null ? x.CASNo.ToLower().Contains(searchbyvalue) : false).ToList();
                //    }
                //    if (searchby == "cat")
                //    {
                //        model = model.Where(x => x.CATNo != null ? x.CATNo.ToLower().Contains(searchbyvalue) : false).ToList();
                //    }
                //    if (searchby == "batchno")
                //    {
                //        model = model.Where(x => x.BatchNo != null ? x.BatchNo.ToLower().Contains(searchbyvalue) : false).ToList();
                //    }

                //}
                ////total number of rows count   
                //recordsTotal = model.Count();
                ////Paging   
                //var data = model.Skip(skip).Take(pageSize).ToList();

                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = model });
            }
            catch (Exception ex)
            {
                throw ex;
            }

        }

        [HttpPost]
        public ActionResult DataApprovedDispatchData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();

                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;

                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.Synthesis);

                // Getting all Customer data  
                var list = (from i in db.SZ_Quotation
                            join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                            where string.IsNullOrEmpty(t2.TrackingNo) && (t2.IsOnHold == false || t2.IsOnHold == null)
                            && t2.IsDataApproved == true
                             && (t2.DataApprovedStatus != "Approved" || t2.DataApprovedStatus == null)
                            orderby t2.DataApprovalDate descending
                            select t2).Distinct();

                var proIds = list.Select(x => x.ProductId).Distinct().ToList();
                var productsdata = db.Products.Where(x => proIds.Contains(x.Id) && x.Deleted == false && x.Published == true).ToList();
                var inventoryData = db.SZ_Inventory.Where(x => proIds.Contains(x.ProductId)).ToList();
                var model = new List<DataApprovedModel>();
                foreach (var k in list)
                {
                    DataApprovedModel subList = new DataApprovedModel();
                    subList.ChkSaveRow = "<input type='checkbox' value='" + k.Id + "' class='clsSaverow' />";
                    subList.DataApprovedDateText = k.DataApprovalDate.HasValue ? k.DataApprovalDate.Value.ToShortDateString() : string.Empty;
                    subList.DataApprovalDate = k.DataApprovalDate;
                    subList.Id = k.Id;
                    subList.ProductId = k.ProductId;
                    subList.PODate = k.MoveProjectDate;
                    if (k.MoveProjectDate.HasValue)
                    {
                        subList.PODateText = k.MoveProjectDate.Value.ToShortDateString();
                    }
                    subList.ProductName = k.ProductName;
                    subList.Ref = k.SZ_Quotation.PONo;
                    subList.Remark = k.SZ_Quotation.Remark;
                    subList.CASNo = k.CASNo;
                    subList.CATNo = k.CATNo;
                    subList.QTY = k.RequiredQty;
                    subList.Remark = k.Remark;
                    subList.AdditionalBatchNo = k.AdditionalBatchNo;

                    subList.AdditionalBatchNoText = "<select id='additionalBatch_" + k.Id + "' data-quotationdetailsid='" + k.Id + "' class='ddladditionalbatch'><option value=''>--Select--</option>";
                    if (subList.ProductId.HasValue)
                    {
                        var proData = productsdata.Where(x => x.Id == subList.ProductId && x.Published == true && x.Deleted == false).Count();
                        var proBatchData = inventoryData.Where(x => x.ProductId == subList.ProductId).ToList();
                        if (proBatchData.Count > 0 && proData > 0)
                        {
                            foreach (var r in proBatchData)
                            {
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }
                                string selected = string.Empty;
                                if (r.Id == subList.AdditionalBatchNo)
                                {
                                    selected = "selected ";
                                    subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
                                }

                                subList.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' " + selected + ">" + text + "</option>";
                            }
                        }
                    }
                    subList.AdditionalBatchNoText += "</select>";
                    subList.DataApprovedStatus = k.DataApprovedStatus;
                    subList.DataApprovedStatusText = "<select id='dataapproved_" + k.Id + "' class='clsDataapproved' data-quoteDetailsId='" + k.Id + "'><option value='Pending'>Pending</option><option value='Send'>Send</option><option value='Approved'>Approved</option></select>";
                    subList.ChangeBatch = "<i class='fa fa-clone' title='Change Batch No' onclick='GetAllBatchNo(" + k.ProductId + "," + k.Id + ")' ></i>";
                    model.Add(subList);
                }
                //Sorting 
                model = model.OrderByDescending(x => x.DataApprovalDate).ToList();

                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.QTY != null && m.QTY.ToLower().Contains(searchValue))
                                        || (m.Ref != null && m.Ref.ToLower().Contains(searchValue))
                                        || (m.DataApprovedStatus != null && m.DataApprovedStatus.ToLower().Contains(searchValue))
                                        || (m.SelectedAdditionalBatchNo != null && m.SelectedAdditionalBatchNo.ToLower().Contains(searchValue))
                                        || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                                         || (m.PODateText != null && m.PODateText.ToLower().Contains(searchValue))
                                          || (m.DataApprovedDateText != null && m.DataApprovedDateText.ToLower().Contains(searchValue))
                                        ).ToList();
                }

                //total number of rows count   
                recordsTotal = model.Count();
                //Paging   
                var data = model.Skip(skip).Take(pageSize).ToList();

                //Returning Json Data  
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                throw ex;
            }

        }

        [HttpPost]
        public ActionResult LoadPurchaseData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                var purchasestatus = Request.Form.GetValues("purchasestatus")[0].ToString();
                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;
                var searchby = string.Empty;
                var searchbyvalue = string.Empty;
                if (Request.Form.GetValues("radiobuton") != null)
                {
                    searchby = Request.Form.GetValues("radiobuton")[0].ToString();
                }
                if (Request.Form.GetValues("searchbox") != null)
                {
                    searchbyvalue = Request.Form.GetValues("searchbox")[0].ToString().Trim();
                }
                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.Purchase);
                string pursynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
                // Getting all Customer data  
                var list = (from i in db.SZ_Quotation
                            join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                            where (t2.MoveToProject == true || t2.IsSynthesisLog == true)
                            && string.IsNullOrEmpty(t2.TrackingNo)
                            && (t2.IsCancel == false || t2.IsCancel == null)
                            && (t2.IsOnHold == false || t2.IsOnHold == null)
                            && (t2.ProjectType == inhouseProjectType || t2.ProjectType == pursynthesisProjectType)
                            orderby t2.PurchaseDate descending
                            select t2).Distinct();
                string internationcompanylist = "";
                if (SessionCookieManagement.IsInternational)
                {
                    internationcompanylist = db.SZ_UserManagement.Where(x => x.UserId == SessionCookieManagement.UserId).Select(x => x.CompanyIds).FirstOrDefault();
                    if (!string.IsNullOrEmpty(internationcompanylist))
                    {
                        List<int?> cidList = new List<int?>();
                        foreach (var item in internationcompanylist.Split(','))
                        {
                            if (!string.IsNullOrEmpty(item))
                            {
                                cidList.Add(Convert.ToInt32(item));
                            }
                        }
                        list = list.Where(x => cidList.Contains(x.SZ_Quotation.CompanyId) && x.SZ_Quotation.CreatedDate >= new DateTime(2022, 05, 01)).AsQueryable();
                    }
                }
                list = list.OrderByDescending(x => x.PurchaseDate);

                MemoryCacheManager objCache = new MemoryCacheManager();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });

                var scienList = objCache.Get("cache.GetScientistId", () =>
                {
                    return db.GetScientistId().ToList();
                });

                var listItems = new List<SelectListItem>();

                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                });

                var PurchaseDDLStatusItems = new List<SelectListItem>();
                PurchaseDDLStatusItems.Add(new SelectListItem
                {
                    Text = "Select",
                    Value = ""
                });
                foreach (EnumList.PurchaseStatusDDL r in Enum.GetValues(typeof(EnumList.PurchaseStatusDDL)))
                {
                    var item = Enum.GetName(typeof(EnumList.PurchaseStatusDDL), r);
                    var test = r.ToString();
                    string text = SZ_Helper.GetEnumDescription((EnumList.PurchaseStatusDDL)(int)r);
                    int val = (int)r;
                    PurchaseDDLStatusItems.Add(new SelectListItem
                    {
                        Text = text,
                        Value = val.ToString()
                    });
                }

                var proIds = list.Select(x => x.ProductId).Distinct().ToList();
                var productsdata = db.Products.Where(x => proIds.Contains(x.Id) && x.Deleted == false && x.Published == true).ToList();
                var inventoryData = db.SZ_Inventory.Where(x => proIds.Contains(x.ProductId)).ToList();
                var ReadyToDeliverScientistStatusId = db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                var model = new List<ProjectListModel>();
                foreach (var k in list)
                {
                    ProjectListModel subList = new ProjectListModel();
                    subList.IsConversionReport = k.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    subList.ChkSaveRow = "<input type='checkbox' value='" + k.Id + "' class='clsSaverow' />";
                    subList.ReadyToDeliverScientistStatusId = ReadyToDeliverScientistStatusId;
                    if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == subList.ReadyToDeliverScientistStatusId && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                    {
                        subList.ChkFirstRow = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                    }
                    else if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == subList.ReadyToDeliverScientistStatusId)
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' />";
                    }
                    else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && k.MoveToDispatch == null)
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' />";
                    }
                    else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                    {
                        subList.ChkFirstRow = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                    }
                    subList.ProjectType = k.ProjectType;
                    subList.ProjectTypeText = "<select id='projecttype_" + k.Id + "' class='clsProjType' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ProjectType), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.ProjectType)
                        {
                            selected = "selected ";
                            subList.SelectedProjectType = text;
                        }
                        //if (text != "In-House")
                        //{
                            subList.ProjectTypeText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                        //}
                    }
                    subList.ProjectTypeText += "</select>";

                    subList.ScientistName = "<select id='ScientistId_" + k.Id + "' class='scientist' scientistId='" + k.ScientistCustomerId + "' quotedetailsid='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (var r in listItems)
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.ScientistCustomerId))
                        {
                            selected = "selected ";
                            subList.SelectedScientistName = r.Text;
                        }
                        subList.ScientistName += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    }
                    subList.ScientistName += "</select>";

                    subList.PurchaseDDLStatusText = "<select id='PurchaseDDLStatus_" + k.Id + "' class='clspurchasestatus'>";
                    foreach (var r in PurchaseDDLStatusItems)
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.PurchaseDDLStatus))
                        {
                            selected = "selected ";
                            subList.PurchaseDDLStatus = r.Value;
                        }
                        subList.PurchaseDDLStatusText += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    }
                    subList.PurchaseDDLStatusText += "</select>";
                    subList.PurchaseRemark = k.PurchaseRemark;
                    subList.PurchaseRemarkText = "<input id='purremark_" + k.Id + "' type='text' value='" + k.PurchaseRemark + "' title='" + k.PurchaseRemark + "'  style='width: 170px' />";
                    subList.AdditionalBatchNo = k.AdditionalBatchNo;
                    subList.QuoteId = k.SZ_Quotation.Id;
                    subList.ProductId = k.ProductId;
                    subList.ProductName = k.ProductName;
                    subList.ScientistRemark = "<input id='sciremark_" + k.Id + "' type='text' value='" + k.ScientistRemark + "' title='" + k.ScientistRemark + "'  style='width: 170px' />";
                    subList.RequiredQtyTxt = "<input id='qty_" + k.Id + "' type='text' value='" + k.RequiredQty + "' style='width: 50px' />";
                    subList.AdditionalBatchNoText = "<select id='additionalBatch_" + k.Id + "'><option value=''>--Select--</option>";
                    if (subList.ProductId.HasValue)
                    {
                        var proData = productsdata.Where(x => x.Id == subList.ProductId && x.Published == true && x.Deleted == false).Count();
                        var productData = productsdata.Where(x => x.Id == subList.ProductId && x.Published == true && x.Deleted == false).FirstOrDefault();
                        if (productData != null)
                        {
                            subList.IsControlledSubstance = productData.IsControlledSubstance;
                            if (!subList.IsControlledSubstance.HasValue
                                || subList.IsControlledSubstance == false)
                            {
                                subList.IsControlledSubstance = productData.IsManuallyControlledSubstance;
                            }
                        }
                        var proBatchData = inventoryData.Where(x => x.ProductId == subList.ProductId).ToList();
                        if (proBatchData.Count > 0 && proData > 0)
                        {
                            foreach (var r in proBatchData)
                            {
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }
                                string selected = string.Empty;
                                if (r.Id == subList.AdditionalBatchNo)
                                {
                                    selected = "selected ";
                                    subList.BatchNo = r.BatchNo;
                                    subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
                                }

                                subList.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' " + selected + ">" + text + "</option>";
                            }
                        }
                    }
                    subList.AdditionalBatchNoText += "</select>";
                    //subList.BatchNo = k.BatchNo;
                    subList.BatchNoText = "<input id='batchno_" + k.Id + "' type='text' value='" + k.BatchNo + "' style='width:120px' />";
                    subList.PurchaseStatusText = "<input id='purchasestatus_" + k.Id + "' type='text' value='" + k.PurchaseStatus + "' title='" + k.PurchaseStatus + "' style='width:120px' />";
                    subList.IsImageAttach = k.SZ_Quotation.IsImageAttach;
                    subList.CompanyName = k.SZ_Quotation.SZ_CompanyList.Name;
                    subList.Email = k.SZ_Quotation.EmailAddress;
                    subList.PONumber = k.SZ_Quotation.PONo;
                    subList.Ref = k.SZ_Quotation.Ref;
                    subList.Remark = k.SZ_Quotation.Remark;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.QuoteDetailsId = k.Id;
                    subList.CASNo = k.CASNo;
                    subList.IsConversionReport = k.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    var impstr = "";
                    if (subList.IsConversionReport.HasValue && subList.IsConversionReport.Value)
                    {
                        impstr += "<img src='/img/important.jpg' width='15px' height='15px' />";
                    }
                    subList.CATNo = "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>" + impstr + " " + CommonOperation.GetMatchingTagHTML(k, "Project");
                    subList.CreatedDate = k.CreatedDate;
                    subList.ImagePath = k.ImagePath;
                    subList.IsUploadServer = k.IsUploadServer;
                    subList.LeadTime = k.LeadTime;
                    subList.Price = k.Price;

                    subList.QuoteId = k.QuoteId;
                    subList.ProjectType = k.ProjectType;
                    subList.ScientistCustomerId = k.ScientistCustomerId;

                    subList.RequiredQty = k.RequiredQty;
                    subList.ProjectStatus = k.ProjectStatus;
                    subList.IsOnHold = k.IsOnHold;
                    if (k.ProjectStatus != null)
                    {
                        subList.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
                    }
                    subList.ScientistStatus = k.ScientistStatus;
                    subList.BatchCode1 = k.BatchCode1;
                    subList.BatchCode2 = k.BatchCode2;
                    subList.Qty1 = k.Qty1;
                    subList.Qty2 = k.Qty2;
                    subList.EstimateCompleteDate = k.EstimateCompleteDate;
                    //if (k.EstimateCompleteDate.HasValue)
                    //{
                    //    // subList.EstimateCompleteDateText = k.EstimateCompleteDate.Value.ToShortDateString();
                    //    subList.EstimateCompleteDateText = k.EstimateCompleteDate.Value.ToShortDateString();
                    //}
                    subList.EstimateCompleteDateText = "<input id='esticompleteDate_" + k.Id + "' data-value='" + k.EstimateCompleteDate + "' type='text' class='datepicker'  style='width:80px' />";
                    //if (k.AdditionalBatchNo.HasValue)
                    //{
                    //    subList.AdditionalBatchNoText = db.SZ_Inventory.Where(x => x.Id == k.AdditionalBatchNo).Select(x => x.BatchNo).FirstOrDefault();
                    //}
                    subList.PurchaseDate = k.PurchaseDate;
                    if (k.PurchaseDate.HasValue)
                    {
                        // subList.EstimateCompleteDateText = k.EstimateCompleteDate.Value.ToShortDateString();
                        subList.PurchaseDateText = k.PurchaseDate.Value.ToShortDateString();
                    }

                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToProject = k.MoveToProject;
                    subList.Remark = k.Remark;
                    subList.SrPo = k.SrPo;
                    subList.AdminScientistStatus = k.AdminScientistStatus;
                    subList.InvoiceNo = k.InvoiceNo;
                    subList.InvoiceRemark = k.InvoiceRemark;

                    subList.MoveProjectDate = k.MoveProjectDate;

                    subList.ScientistStatustext = "<input id='scientistStatus_" + k.Id + "' type='text' value='" + k.AdminScientistStatus + "' title='" + k.AdminScientistStatus + "' style='width:200px' />";
                    subList.RemarkText = "<input id='remark_" + k.Id + "' type='text' value='" + k.Remark + "' title='" + k.Remark + "' style='width: 170px' />";
                    subList.LastRowText = "<a href='javascript: void(0)' id='save_" + k.Id + "' onclick='SavePurchaseProjectDetails(\"" + k.Id + "\")'> Save</a> ";
                    subList.LastRowText += "<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";
                    subList.SubScientistName = k.SubScientistName;
                    subList.DispatchedStatus = k.DispatchedStatus;
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToInvoice = k.MoveToInvoice;
                    subList.IsDispatchApprove = k.IsDispatchApprove;
                    subList.Reason = k.Reason;
                    subList.ReasonText = "<input id='reason_" + k.Id + "' type='text' value='" + k.Reason + "' title='" + k.Reason + "'  style='width:200px' />";

                    model.Add(subList);
                }
                //Sorting  
                //if (!string.IsNullOrEmpty(sortColumn) && !string.IsNullOrEmpty(sortColumnDir))
                //{
                //    model = model.OrderBy(sortColumn + " " + sortColumnDir).ToList();
                //}
                //else
                //{

                // model = model.OrderBy(x => x.SrPo).ThenByDescending(x=>x.MoveProjectDate).ToList();
                //}
                if (!string.IsNullOrEmpty(purchasestatus))
                {
                    model = model.Where(m => m.PurchaseDDLStatus == purchasestatus).ToList();
                }
                if (!string.IsNullOrEmpty(searchby) && !string.IsNullOrEmpty(searchbyvalue))
                {
                    searchbyvalue = searchbyvalue.ToLower();

                    if (searchby == "quoteid")
                    {
                        model = model.Where(x => x.Ref.ToLower().Contains(searchbyvalue)).ToList();
                    }
                    if (searchby == "ponumber")
                    {
                        model = model.Where(x => x.PONumber.ToLower().Contains(searchbyvalue)).ToList();
                    }
                    if (searchby == "company")
                    {
                        model = model.Where(x => x.CompanyName.ToLower().Contains(searchbyvalue)).ToList();
                    }
                    if (searchby == "productname")
                    {
                        model = model.Where(x => x.ProductName.ToLower().Contains(searchbyvalue)).ToList();
                    }
                    if (searchby == "cas")
                    {
                        model = model.Where(x => x.CASNo != null ? x.CASNo.ToLower().Contains(searchbyvalue) : false).ToList();
                    }
                    if (searchby == "cat")
                    {
                        model = model.Where(x => x.CATNo != null ? x.CATNo.ToLower().Contains(searchbyvalue) : false).ToList();
                    }
                    if (searchby == "batchno")
                    {
                        model = model.Where(x => x.BatchNo != null ? x.BatchNo.ToLower().Contains(searchbyvalue) : false).ToList();
                    }

                }
                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.SelectedScientistName != null && m.SelectedScientistName.ToLower().Contains(searchValue))
                                        || (m.CompanyName != null && m.CompanyName.ToLower().Contains(searchValue))
                                        || (m.PONumber != null && m.PONumber.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.Price != null && m.Price.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.SelectedProjectType != null && m.SelectedProjectType.ToLower().Contains(searchValue))
                                        || (m.RequiredQty != null && m.RequiredQty.ToLower().Contains(searchValue))
                                        || (m.SelectedAdditionalBatchNo != null && m.SelectedAdditionalBatchNo.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                         || (m.EstimateCompleteDateText != null && m.EstimateCompleteDateText.ToString().ToLower().Contains(searchValue))
                                          || (m.AdminScientistStatus != null && m.AdminScientistStatus.ToLower().Contains(searchValue))
                                           || (m.ProjectStatustext != null && m.ProjectStatustext.ToLower().Contains(searchValue))
                                            || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                                        || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))).ToList();
                }
                model = model.OrderByDescending(x => x.PurchaseDate).ThenBy(x => x.SrPo).ThenBy(x => x.SrPo).ToList();
                //total number of rows count   
                recordsTotal = model.Count();
                //Paging   
                var data = model.Skip(skip).Take(pageSize).ToList();

                //var finalData = PrepareQuotationListModel(data);
                //Returning Json Data  
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                throw ex;
            }

        }

        [HttpPost]
        public ActionResult LoadPurchaseRFQData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                var purchasestatus = Request.Form.GetValues("purchasestatus")[0].ToString();
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;

                var list = (from i in db.SZ_PurchaseRFQ
                            orderby i.CreatedDate descending
                            select i).Distinct();

                var PurchaseDDLStatusItems = new List<SelectListItem>();
                PurchaseDDLStatusItems.Add(new SelectListItem { Text = "Select", Value = "" });

                foreach (EnumList.PurchaseStatusDDL r in Enum.GetValues(typeof(EnumList.PurchaseStatusDDL)))
                {
                    var item = Enum.GetName(typeof(EnumList.PurchaseStatusDDL), r);
                    var test = r.ToString();
                    string text = SZ_Helper.GetEnumDescription((EnumList.PurchaseStatusDDL)(int)r);
                    int val = (int)r;
                    PurchaseDDLStatusItems.Add(new SelectListItem
                    {
                        Text = text,
                        Value = val.ToString()
                    });
                }

                var model = new List<PurchaseRFQModel>();
                foreach (var k in list)
                {
                    PurchaseRFQModel subList = new PurchaseRFQModel();
                    subList.ChkSaveRow = "<input type='checkbox' value='" + k.Id + "' class='clsSaverow' />";
                    subList.PurchaseStatusText = "<select id='PurchaseStatus_" + k.Id + "' class='clspurchasestatus'>";
                    foreach (var r in PurchaseDDLStatusItems)
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.PurchaseStatus))
                        {
                            selected = "selected ";
                            subList.PurchaseStatus = r.Text;
                        }
                        subList.PurchaseStatusText += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    }
                    subList.PurchaseStatusText += "</select>";
                    subList.PurchaseRemark = k.PurchaseRemark;
                    subList.PurchaseRemarkText = "<input id='purremark_" + k.Id + "' type='text' value='" + k.PurchaseRemark + "' title='" + k.PurchaseRemark + "'  style='width: 100%' />";
                    subList.Summary = k.Summary;
                    subList.Comment = k.Comment;
                    subList.AssignedDate = k.AssignedDate;
                    if (k.AssignedDate.HasValue)
                    {
                        subList.AssignedDateText = k.AssignedDate.Value.ToShortDateString();
                    }
                    subList.CommentText = "<input id='comment_" + k.Id + "' type='text' value='" + k.Comment + "' title='" + k.Comment + "' style='width:100%' />";
                    subList.SummaryText = "<input id='summary_" + k.Id + "' type='text' value='" + k.Summary + "' title='" + k.Summary + "' style='width:100%' />";
                    subList.CASNo = k.CASNo;
                    subList.CATNo = k.CATNo;
                    subList.ChemicalName = k.ChemicalName;

                    subList.ChemicalNameText = "<input id='chemicalName_" + k.Id + "' type='text' value='" + k.ChemicalName + "' title='" + k.ChemicalName + "' style='width:100%' />";
                    subList.CASNoText = "<input id='casno_" + k.Id + "' type='text' value='" + k.CASNo + "' title='" + k.CASNo + "' style='width:100%' />";
                    subList.CATNoText = "<input id='catno_" + k.Id + "' type='text' value='" + k.CATNo + "' title='" + k.CATNo + "' style='width:100%' />";
                    subList.RefBy = k.RefBy;
                    subList.CreatedDate = k.CreatedDate;
                    subList.Estdate = k.Estdate;
                    subList.EstdateText = "<input id='estDate_" + k.Id + "' data-value='" + k.Estdate + "' type='text' class='datepicker'  style='width:80px' />";
                    model.Add(subList);
                }

                model = model.Where(x => x.PurchaseStatus != "28" && x.PurchaseStatus != "16").ToList();

                if (!string.IsNullOrEmpty(purchasestatus))
                {
                    purchasestatus = purchasestatus.ToLower();
                    model = model.Where(m => (m.PurchaseStatus != null && m.PurchaseStatus.ToLower().Contains(purchasestatus))).ToList();
                }
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.ChemicalName != null && m.ChemicalName.ToLower().Contains(searchValue))
                                        || (m.Summary != null && m.Summary.ToLower().Contains(searchValue))).ToList();
                }
                model = model.OrderByDescending(x => x.AssignedDate).ToList();
                recordsTotal = model.Count();
                var data = model.Skip(skip).Take(pageSize).ToList();
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        public ActionResult ExportScientistData()
        {
            MemoryCacheManager objCache = new MemoryCacheManager();
            var ReadyToDeliverScientistStatusId = objCache.Get("cache.ReadyToDeliverScientistStatusId", () =>
            {
                return db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
            });
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });

            var listItems = new List<SelectListItem>();
            var scienList = objCache.Get("cache.GetScientistId", () =>
            {
                return db.GetScientistId().ToList();
            });
            scienList.ForEach(term =>
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                listItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.ToString()
                });
            });
            string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
            string pursynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
            var quotationDetailsdata = db.SZ_QuotationDetail.AsQueryable();
            string subscientistname = Convert.ToString(SessionCookieManagement.UserId);
            string qcstatus = Convert.ToString((int)Synzeal_Inventory.Models.EnumList.ApprovedStatus.QCApproved);

            var scientistName = listItems.Where(x => x.Value == SessionCookieManagement.UserId.ToString()).Select(x => x.Text).FirstOrDefault();

            var model = (from i in db.SZ_Quotation.AsNoTracking()
                         join t2 in db.SZ_QuotationDetail.AsNoTracking() on i.Id equals t2.QuoteId
                         join qf in db.SZ_QuoteDetails_Form.AsNoTracking() on t2.Id equals qf.QuoteDetailsId
                         join qff in db.SZ_QuoteDetailForm.AsNoTracking() on qf.FormId equals qff.Id
                         where (t2.ScientistCustomerId == SessionCookieManagement.UserId
                         || t2.SubScientistName == subscientistname)
                         && (ReadyToDeliverScientistStatusId == t2.ScientistStatus)
                         && (t2.IsOnHold == false || t2.IsOnHold == null)
                         && qff.ApprovalStatus == qcstatus
                         orderby t2.MoveToScientistDate descending
                         select new ExportScientistModel()
                         {
                             ProductId = t2.ProductId,
                             BatchId = t2.AdditionalBatchNo,
                             BatchCode = qff.BatchCode,
                             CASNo = t2.CASNo,
                             CATNo = t2.CATNo,
                             ProductName = t2.ProductName,
                             PurificationBy = qff.PurificationBy,
                             Purity = qff.HPLCPurity,
                             Quantity = qff.Qty,
                             ScientistName = scientistName,
                             SubscientistName = qff.ScientistName,
                             SubmissionDate = qff.CreatedDate,
                             AssignDate = t2.MoveToScientistDate,
                             NoOfFinalStep = qff.NoOfFinalStep,
                             LastStatus = t2.ProjectType,
                             Reason = t2.Reason,
                             Justification = "",
                             QueryReceived = ""
                         }).ToList();

            var pIds = model.Select(x => x.ProductId).ToList();
            var inventoryData = db.SZ_Inventory.Where(x => pIds.Contains(x.ProductId)).ToList();
            var subscientistnamelist = new List<string>();
            subscientistnamelist.Add(scientistName.ToLower());
            model.ForEach(x =>
            {
                if (!string.IsNullOrEmpty(x.SubscientistName))
                {
                    if (!subscientistnamelist.Contains(x.SubscientistName.ToLower()))
                    {
                        subscientistnamelist.Add(x.SubscientistName.ToLower());
                    }
                }
                var cnt = inventoryData.Where(z => z.ProductId == x.ProductId).Count();
                if (cnt == 1)
                {
                    x.Type = "New Product";
                }
                if (cnt > 1)
                {
                    x.Type = "Re-Synthesis";
                }
                x.SubmissionDateText = x.SubmissionDate.ToShortDateString();
                if (x.AssignDate.HasValue)
                {
                    x.Duration = (x.SubmissionDate - x.AssignDate.Value).TotalDays.ToString();
                }
                else
                {
                    x.Duration = "0";
                }
            });
            ExcelPackage ExcelPkg = new ExcelPackage();
            foreach (var name in subscientistnamelist.Where(x => !string.IsNullOrEmpty(x)))
            {
                var list = model;
                if (name != scientistName)
                {
                    list = model.Where(x => !string.IsNullOrEmpty(x.SubscientistName) && x.SubscientistName.ToLower() == name).ToList();
                }

                ExcelWorksheet wsSheet1 = ExcelPkg.Workbook.Worksheets.Add(name);
                wsSheet1.DefaultColWidth = 11;
                wsSheet1.Protection.IsProtected = false;
                wsSheet1.Protection.AllowSelectLockedCells = false;
                wsSheet1.Cells.AutoFitColumns(14, 40);
                wsSheet1.Column(3).Width = 40;
                wsSheet1.Column(3).Style.WrapText = true;

                int loopCount = 2;
                wsSheet1.Cells[loopCount, 1].Value = "#";
                wsSheet1.Cells[loopCount, 2].Value = "Batch Code";
                wsSheet1.Cells[loopCount, 3].Value = "Scientist Name";
                wsSheet1.Cells[loopCount, 4].Value = "Sub scientist Name";
                wsSheet1.Cells[loopCount, 5].Value = "Project Name";
                wsSheet1.Cells[loopCount, 6].Value = "Product Name";
                wsSheet1.Cells[loopCount, 7].Value = "CATLOG NO.";
                wsSheet1.Cells[loopCount, 8].Value = "CAS No.";
                wsSheet1.Cells[loopCount, 9].Value = "Purity(%)";
                wsSheet1.Cells[loopCount, 10].Value = "Quantity(mg)";
                wsSheet1.Cells[loopCount, 11].Value = "Submission Date";
                wsSheet1.Cells[loopCount, 12].Value = "No of Steps";
                wsSheet1.Cells[loopCount, 13].Value = "Duration";
                wsSheet1.Cells[loopCount, 14].Value = "Type";
                wsSheet1.Cells[loopCount, 15].Value = "Purification By";
                wsSheet1.Cells[loopCount, 16].Value = "Last Status";
                wsSheet1.Cells[loopCount, 17].Value = "Reason";
                wsSheet1.Cells[loopCount, 18].Value = "Justification";
                wsSheet1.Cells[loopCount, 19].Value = "Query Received";
                using (ExcelRange Rng = wsSheet1.Cells[loopCount, 1, loopCount, 19])
                {
                    Rng.Style.Font.Bold = true;
                    Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                    Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#7b7b7b");
                    Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                    Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    Rng.Style.Font.Color.SetColor(Color.White);
                    Rng.Style.WrapText = true;
                }

                loopCount = loopCount + 1;
                int srno = 1;
                foreach (var quote in list)
                {
                    wsSheet1.Cells[loopCount, 1].Value = srno;
                    wsSheet1.Cells[loopCount, 2].Value = quote.BatchCode;
                    wsSheet1.Cells[loopCount, 3].Value = quote.ScientistName;
                    wsSheet1.Cells[loopCount, 4].Value = quote.SubscientistName;
                    wsSheet1.Cells[loopCount, 5].Value = "";
                    wsSheet1.Cells[loopCount, 6].Value = quote.ProductName;
                    wsSheet1.Cells[loopCount, 7].Value = quote.CATNo;
                    wsSheet1.Cells[loopCount, 8].Value = quote.CASNo;
                    wsSheet1.Cells[loopCount, 9].Value = quote.Purity;
                    wsSheet1.Cells[loopCount, 10].Value = quote.Quantity;
                    wsSheet1.Cells[loopCount, 11].Value = quote.SubmissionDateText;
                    wsSheet1.Cells[loopCount, 12].Value = quote.NoOfFinalStep;
                    wsSheet1.Cells[loopCount, 13].Value = quote.Duration;
                    wsSheet1.Cells[loopCount, 14].Value = quote.Type;
                    wsSheet1.Cells[loopCount, 15].Value = quote.PurificationBy;
                    wsSheet1.Cells[loopCount, 16].Value = quote.LastStatus;
                    wsSheet1.Cells[loopCount, 17].Value = quote.Reason;
                    wsSheet1.Cells[loopCount, 18].Value = "";
                    wsSheet1.Cells[loopCount, 19].Value = "";
                    srno += 1;
                    loopCount += 1;
                }
            }


            string filePath = HostingEnvironment.MapPath("~/Content/Quotation/") + "ScientistData-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xlsx";
            ExcelPkg.SaveAs(new FileInfo(filePath));
            return File(filePath, "application/excel", Server.UrlEncode("ScientistData-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xls"));
        }

        public ActionResult ExportQuoteProducts(int id)
        {
            var list = (from i in db.SZ_QuotationDetail
                        where i.QuoteId == id
                        select i).OrderBy(x => x.DisplayOrder).ThenByDescending(x => x.CreatedDate).ToList();

            ExcelPackage ExcelPkg = new ExcelPackage();
            ExcelWorksheet wsSheet1 = ExcelPkg.Workbook.Worksheets.Add("Sheet1");
            wsSheet1.DefaultColWidth = 11;
            wsSheet1.Protection.IsProtected = false;
            wsSheet1.Protection.AllowSelectLockedCells = false;
            wsSheet1.Cells.AutoFitColumns(14, 40);
            wsSheet1.Column(3).Width = 40;
            wsSheet1.Column(3).Style.WrapText = true;

            int loopCount = 2;
            wsSheet1.Cells[loopCount, 1].Value = "#";
            wsSheet1.Cells[loopCount, 2].Value = "Product Name";
            wsSheet1.Cells[loopCount, 3].Value = "CAS No";
            wsSheet1.Cells[loopCount, 4].Value = "CAT No";
            wsSheet1.Cells[loopCount, 5].Value = "Price";
            wsSheet1.Cells[loopCount, 6].Value = "Lead Time";
            wsSheet1.Cells[loopCount, 7].Value = "Product Remark";
            using (ExcelRange Rng = wsSheet1.Cells[loopCount, 1, loopCount, 7])
            {
                Rng.Style.Font.Bold = true;
                Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#7b7b7b");
                Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                Rng.Style.Font.Color.SetColor(Color.White);
                Rng.Style.WrapText = true;
            }

            loopCount = loopCount + 1;
            int srno = 1;
            foreach (var quote in list)
            {
                wsSheet1.Cells[loopCount, 1].Value = srno;
                wsSheet1.Cells[loopCount, 2].Value = quote.ProductName;
                wsSheet1.Cells[loopCount, 3].Value = quote.CASNo;
                wsSheet1.Cells[loopCount, 4].Value = quote.CATNo;
                wsSheet1.Cells[loopCount, 5].Value = quote.Price;
                wsSheet1.Cells[loopCount, 6].Value = quote.LeadTime;
                wsSheet1.Cells[loopCount, 7].Value = quote.Remark;
                srno += 1;
                loopCount += 1;
            }
            string filePath = HostingEnvironment.MapPath("~/Content/Quotation/") + "Quote-" + list.Select(x => x.SZ_Quotation.Ref).FirstOrDefault() + "-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xlsx";
            ExcelPkg.SaveAs(new FileInfo(filePath));
            return File(filePath, "application/excel", Server.UrlEncode("Quote-" + list.Select(x => x.SZ_Quotation.Ref).FirstOrDefault() + "-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xls"));
        }

        public ActionResult ExportAllPurchaseRFQ()
        {
            var list = (from i in db.SZ_PurchaseRFQ
                        where i.PurchaseStatus == null || i.PurchaseStatus != "28" && i.PurchaseStatus != "16"
                        orderby i.CreatedDate descending
                        select i).Distinct();

            ExcelPackage ExcelPkg = new ExcelPackage();
            ExcelWorksheet wsSheet1 = ExcelPkg.Workbook.Worksheets.Add("Sheet1");
            wsSheet1.DefaultColWidth = 11;
            wsSheet1.Protection.IsProtected = false;
            wsSheet1.Protection.AllowSelectLockedCells = false;
            wsSheet1.Cells.AutoFitColumns(14, 40);
            wsSheet1.Column(3).Width = 40;
            wsSheet1.Column(3).Style.WrapText = true;

            int loopCount = 2;
            wsSheet1.Cells[loopCount, 1].Value = "Purchase Status";
            wsSheet1.Cells[loopCount, 2].Value = "RFQ No";
            wsSheet1.Cells[loopCount, 3].Value = "Ass. Date";
            wsSheet1.Cells[loopCount, 4].Value = "Chemical Name";
            wsSheet1.Cells[loopCount, 5].Value = "CAS No";
            wsSheet1.Cells[loopCount, 6].Value = "CAT No";
            wsSheet1.Cells[loopCount, 7].Value = "Comment";
            wsSheet1.Cells[loopCount, 8].Value = "Summary";
            wsSheet1.Cells[loopCount, 9].Value = "Est. Date";
            wsSheet1.Cells[loopCount, 10].Value = "Purchase Remark";
            wsSheet1.Cells[loopCount, 11].Value = "Ref By";
            using (ExcelRange Rng = wsSheet1.Cells[loopCount, 1, loopCount, 11])
            {
                Rng.Style.Font.Bold = true;
                Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#7b7b7b");
                Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                Rng.Style.Font.Color.SetColor(Color.White);
                Rng.Style.WrapText = true;
            }

            loopCount = loopCount + 1;
            int srno = 1;
            foreach (var quote in list)
            {
                wsSheet1.Cells[loopCount, 1].Value = GetPurchaseStatusDDLName(quote.PurchaseStatus);
                wsSheet1.Cells[loopCount, 2].Value = quote.RfqNo;
                wsSheet1.Cells[loopCount, 3].Value = quote.AssignedDate.HasValue ? quote.AssignedDate.Value.ToShortDateString() : "";
                wsSheet1.Cells[loopCount, 4].Value = quote.ChemicalName;
                wsSheet1.Cells[loopCount, 5].Value = quote.CASNo;
                wsSheet1.Cells[loopCount, 6].Value = quote.CATNo;
                wsSheet1.Cells[loopCount, 7].Value = quote.Comment;
                wsSheet1.Cells[loopCount, 8].Value = quote.Summary;
                wsSheet1.Cells[loopCount, 9].Value = quote.Estdate.HasValue ? quote.Estdate.Value.ToShortDateString() : "";
                wsSheet1.Cells[loopCount, 10].Value = quote.PurchaseRemark;
                wsSheet1.Cells[loopCount, 11].Value = quote.RefBy;
                srno += 1;
                loopCount += 1;
            }
            string filePath = HostingEnvironment.MapPath("~/Content/Quotation/") + "PurchaseRFQ-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xlsx";
            ExcelPkg.SaveAs(new FileInfo(filePath));
            return File(filePath, "application/excel", Server.UrlEncode("PurchaseRFQ-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xls"));
        }

        public ActionResult ExportThreeYearData(string countrytype, int year)
        {
            List<int> years = new List<int>();
            years.Add(year);
            years.Add(year - 1);
            years.Add(year - 2);

            MemoryCacheManager objCache = new MemoryCacheManager();
            var ReadyToDeliverScientistStatusId = objCache.Get("cache.ReadyToDeliverScientistStatusId", () =>
            {
                return db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
            });
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });

            string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
            string pursynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
            string subscientistname = Convert.ToString(SessionCookieManagement.UserId);
            string qcstatus = Convert.ToString((int)Synzeal_Inventory.Models.EnumList.ApprovedStatus.QCApproved);
            var queryData = db.SZ_QueryModule.ToList();

            TimeSpan sts = new TimeSpan(0, 0, 0);
            TimeSpan ets = new TimeSpan(23, 59, 59);
            ExcelPackage ExcelPkg = new ExcelPackage();
            foreach (var name in years)
            {
                var Startdate = new DateTime(name, 1, 1);
                var Enddate = new DateTime(name, 12, 31);
                Startdate = Startdate.Add(sts);
                Enddate = Enddate.Add(ets);
                var list = (from i in db.SZ_Quotation.AsNoTracking()
                            join t2 in db.SZ_QuotationDetail.AsNoTracking() on i.Id equals t2.QuoteId
                            where i.CountryType == countrytype
                            && !i.CreatedBy.Contains("neh")
                            && !i.CreatedBy.Contains("kavita")
                            && !i.CreatedBy.Contains("kishan")
                            && !string.IsNullOrEmpty(i.ApprovedBy)
                            && i.CreatedDate >= Startdate && i.CreatedDate <= Enddate && t2.ProductId.HasValue
                            orderby t2.MoveToScientistDate descending
                            select new ExportScientistModel()
                            {
                                //ProductName = t2.ProductName,
                                //CASNo = t2.CASNo,
                                //CATNo = t2.CATNo,
                                ProductId = t2.ProductId
                                //Price = t2.Price ,
                                //LeadTime = t2.LeadTime,
                                //ProductRemark = t2.ProductRemark,
                                //CreatedDate = i.CreatedDate
                            }).Distinct().ToList();
                var pIds = list.Select(x => x.ProductId).ToList();
                var quotedetailsMainData = db.SZ_QuotationDetail.Where(x => x.SZ_Quotation.CountryType == countrytype && x.ProductId.HasValue && pIds.Contains(x.ProductId) && x.CreatedDate >= Startdate && x.CreatedDate <= Enddate).ToList();
                var inventoryData = db.SZ_Inventory.Where(x => pIds.Contains(x.ProductId)).ToList();
                var productData = db.Products.Where(x => pIds.Contains(x.Id)).ToList();
                ExcelWorksheet wsSheet1 = ExcelPkg.Workbook.Worksheets.Add(name.ToString());
                wsSheet1.DefaultColWidth = 11;
                wsSheet1.Protection.IsProtected = false;
                wsSheet1.Protection.AllowSelectLockedCells = false;
                wsSheet1.Cells.AutoFitColumns(14, 40);
                wsSheet1.Column(3).Width = 40;
                wsSheet1.Column(3).Style.WrapText = true;

                int loopCount = 2;
                wsSheet1.Cells[loopCount, 1].Value = "#";
                wsSheet1.Cells[loopCount, 2].Value = "Product Name";
                wsSheet1.Cells[loopCount, 3].Value = "CAT No";
                wsSheet1.Cells[loopCount, 4].Value = "CAS No";
                wsSheet1.Cells[loopCount, 5].Value = "Quoted " + countrytype;
                wsSheet1.Cells[loopCount, 6].Value = "PO " + countrytype;
                wsSheet1.Cells[loopCount, 7].Value = "Total Qty Available (Single Batch highest Qty)";
                wsSheet1.Cells[loopCount, 8].Value = "Project Name";
                wsSheet1.Cells[loopCount, 9].Value = "10 mg";
                wsSheet1.Cells[loopCount, 10].Value = "25 mg";
                wsSheet1.Cells[loopCount, 11].Value = "50 mg";
                wsSheet1.Cells[loopCount, 12].Value = "100 mg";
                wsSheet1.Cells[loopCount, 13].Value = "250 mg";
                wsSheet1.Cells[loopCount, 14].Value = "500 mg";
                wsSheet1.Cells[loopCount, 15].Value = "1000 mg";
                wsSheet1.Cells[loopCount, 16].Value = "Lead Time";
                wsSheet1.Cells[loopCount, 17].Value = "Product Remarks";
                wsSheet1.Cells[loopCount, 18].Value = "Conversion";

                wsSheet1.Cells[loopCount, 19].Value = "PO Received";
                wsSheet1.Cells[loopCount, 20].Value = "No Of times Query Received";
                wsSheet1.Cells[loopCount, 21].Value = "Query Details";

                using (ExcelRange Rng = wsSheet1.Cells[loopCount, 1, loopCount, 21])
                {
                    Rng.Style.Font.Bold = true;
                    Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                    Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#7b7b7b");
                    Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                    Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    Rng.Style.Font.Color.SetColor(Color.White);
                    Rng.Style.WrapText = true;
                }

                loopCount = loopCount + 1;
                int srno = 1;
                foreach (var quote in list)
                {
                    var product = productData.Where(x => x.Id == quote.ProductId).FirstOrDefault();
                    if (product == null)
                    {
                        continue;
                    }
                    var productquotedetaildata = quotedetailsMainData.Where(x => x.ProductId == quote.ProductId).ToList();

                    wsSheet1.Cells[loopCount, 1].Value = srno;
                    wsSheet1.Cells[loopCount, 2].Value = !string.IsNullOrEmpty(product.Name) ? product.Name : "";
                    wsSheet1.Cells[loopCount, 3].Value = product.Sku;
                    wsSheet1.Cells[loopCount, 4].Value = product.ManufacturerPartNumber;
                    wsSheet1.Cells[loopCount, 5].Value = productquotedetaildata.Count;
                    wsSheet1.Cells[loopCount, 6].Value = productquotedetaildata.Where(x => x.MoveToProject == true).Count();
                    wsSheet1.Cells[loopCount, 7].Value = inventoryData.Where(x => x.ProductId == quote.ProductId).Max(x => x.AvailableQty).ToString();
                    wsSheet1.Cells[loopCount, 8].Value = product.MainCatName;
                    wsSheet1.Cells[loopCount, 9].Value = LowestPriceValue(10, productquotedetaildata.Where(x => !string.IsNullOrEmpty(x.Price) && (x.Price.Contains("10mg@") || x.Price.Contains("10 mg@"))).ToList());
                    wsSheet1.Cells[loopCount, 10].Value = LowestPriceValue(25, productquotedetaildata.Where(x => !string.IsNullOrEmpty(x.Price) && (x.Price.Contains("25mg@") || x.Price.Contains("25 mg@"))).ToList());
                    wsSheet1.Cells[loopCount, 11].Value = LowestPriceValue(50, productquotedetaildata.Where(x => !string.IsNullOrEmpty(x.Price) && (x.Price.Contains("50mg@") || x.Price.Contains("50 mg@"))).ToList());
                    wsSheet1.Cells[loopCount, 12].Value = LowestPriceValue(100, productquotedetaildata.Where(x => !string.IsNullOrEmpty(x.Price) && (x.Price.Contains("100mg@") || x.Price.Contains("100 mg@"))).ToList());
                    wsSheet1.Cells[loopCount, 13].Value = LowestPriceValue(250, productquotedetaildata.Where(x => !string.IsNullOrEmpty(x.Price) && (x.Price.Contains("250mg@") || x.Price.Contains("250 mg@"))).ToList());
                    wsSheet1.Cells[loopCount, 14].Value = LowestPriceValue(500, productquotedetaildata.Where(x => !string.IsNullOrEmpty(x.Price) && (x.Price.Contains("500mg@") || x.Price.Contains("500 mg@"))).ToList());
                    wsSheet1.Cells[loopCount, 15].Value = LowestPriceValue(1000, productquotedetaildata.Where(x => !string.IsNullOrEmpty(x.Price) && (x.Price.Contains("1000mg@") || x.Price.Contains("1000 mg@"))).ToList());
                    wsSheet1.Cells[loopCount, 16].Value = productquotedetaildata.Select(x => x.LeadTime).LastOrDefault();
                    wsSheet1.Cells[loopCount, 17].Value = productquotedetaildata.Select(x => x.ProductRemark).LastOrDefault();
                    if (productquotedetaildata.Count > 0)
                    {
                        wsSheet1.Cells[loopCount, 18].Value = productquotedetaildata.Where(x => x.MoveToProject == true).Count() / productquotedetaildata.Count + "%";
                    }
                    else
                    {
                        wsSheet1.Cells[loopCount, 18].Value = "0%";
                    }


                    wsSheet1.Cells[loopCount, 19].Value = String.Join(", ", productquotedetaildata.Where(x => x.MoveToProject == true).Select(x => x.SZ_Quotation.PONo + "(" + x.Price + ")").ToList());
                    wsSheet1.Cells[loopCount, 20].Value = queryData.Where(x => x.CATNo == product.Sku).Count();
                    wsSheet1.Cells[loopCount, 21].Value = String.Join(", ", queryData.Where(x => x.CATNo == product.Sku).Select(x => x.QueryNo + "(" + x.QuerySubject + ")").ToList());

                    srno += 1;
                    loopCount += 1;
                }
            }

            string filePath = HostingEnvironment.MapPath("~/Content/Quotation/") + countrytype + "-ThreeyearData-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xlsx";
            ExcelPkg.SaveAs(new FileInfo(filePath));
            return File(filePath, "application/excel", Server.UrlEncode(countrytype + "-ThreeyearData-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xls"));
        }

        public string LowestPriceValue(int qty, List<SZ_QuotationDetail> quoteDetailList)
        {
            List<PriceQtyModel> priceqtyModel = new List<PriceQtyModel>();
            foreach (var item in quoteDetailList)
            {
                if (!string.IsNullOrEmpty(item.Price))
                {
                    priceqtyModel.AddRange(item.Price.PreparePriceModel());
                }
            }
            return priceqtyModel.Where(x => x.MG == qty.ToString()).Min(x => x.Price);
        }

        [HttpPost]
        public ActionResult LoadPurchaseSubmittedData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                var purchasestatus = Request.Form.GetValues("purchasestatus")[0].ToString();
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;

                var quotelist = (from i in db.SZ_QuotationDetail
                                 where i.PurchaseDDLStatus == "28"
                                 orderby i.PurchaseDate descending
                                 select i).Distinct();

                var model = new List<PurchaseRFQModel>();
                foreach (var k in quotelist)
                {
                    PurchaseRFQModel subList = new PurchaseRFQModel();
                    //subList.PurchaseStatus = k.PurchaseDDLStatus;

                    if (!string.IsNullOrEmpty(k.PurchaseDDLStatus))
                    {
                        foreach (EnumList.PurchaseStatusDDL r in Enum.GetValues(typeof(EnumList.PurchaseStatusDDL)))
                        {
                            var item = Enum.GetName(typeof(EnumList.PurchaseStatusDDL), r);
                            var test = r.ToString();
                            string text = SZ_Helper.GetEnumDescription((EnumList.PurchaseStatusDDL)(int)r);
                            int val = (int)r;
                            if (val.ToString() == k.PurchaseDDLStatus)
                            {
                                subList.PurchaseStatus = text;
                            }
                        }
                    }
                    subList.PurchaseRemark = k.PurchaseRemark;
                    subList.Summary = k.PurchaseStatus;
                    subList.AssignedDate = k.PurchaseDate;
                    if (k.PurchaseDate.HasValue)
                    {
                        subList.AssignedDateText = k.PurchaseDate.Value.ToShortDateString();
                    }
                    subList.CASNo = k.CASNo;
                    subList.CATNo = "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>";
                    subList.ChemicalName = k.ProductName;
                    subList.CreatedDate = k.CreatedDate;
                    if (k.EstimateCompleteDate.HasValue)
                    {
                        subList.EstdateText = k.EstimateCompleteDate.Value.ToShortDateString();
                    }
                    model.Add(subList);
                }

                if (!string.IsNullOrEmpty(purchasestatus))
                {
                    model = model.Where(m => (m.PurchaseStatus != null && m.PurchaseStatus.ToLower().Contains(purchasestatus))).ToList();
                }
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.ChemicalName != null && m.ChemicalName.ToLower().Contains(searchValue))
                                        || (m.Summary != null && m.Summary.ToLower().Contains(searchValue))).ToList();
                }
                model = model.OrderByDescending(x => x.AssignedDate).ToList();
                recordsTotal = model.Count();
                var data = model.Skip(skip).Take(pageSize).ToList();
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                throw ex;
            }

        }


        [HttpPost]
        public ActionResult LoadPurchaseRFQSubmittedData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                var purchasestatus = Request.Form.GetValues("purchasestatus")[0].ToString();
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;

                var list = (from i in db.SZ_PurchaseRFQ
                            where i.PurchaseStatus != "28" && i.PurchaseStatus != "16"
                            orderby i.AssignedDate descending
                            select i).Distinct();

                var quotelist = (from i in db.SZ_QuotationDetail
                                 where i.PurchaseDDLStatus != "28" && i.PurchaseDDLStatus != "16"
                                 orderby i.PurchaseDate descending
                                 select i).Distinct();

                var model = new List<PurchaseRFQModel>();
                foreach (var k in list)
                {
                    PurchaseRFQModel subList = new PurchaseRFQModel();
                    subList.PurchaseStatus = k.PurchaseStatus;
                    subList.PurchaseRemark = k.PurchaseRemark;
                    subList.Summary = k.Summary;
                    subList.Comment = k.Comment;
                    subList.AssignedDate = k.AssignedDate;
                    if (k.AssignedDate.HasValue)
                    {
                        subList.AssignedDateText = k.AssignedDate.Value.ToShortDateString();
                    }
                    subList.CASNo = k.CASNo;
                    subList.CATNo = k.CATNo;
                    subList.ChemicalName = k.ChemicalName;
                    subList.RefBy = k.RefBy;
                    subList.CreatedDate = k.CreatedDate;
                    if (k.Estdate.HasValue)
                    {
                        subList.EstdateText = k.Estdate.Value.ToShortDateString();
                    }
                    model.Add(subList);
                }
                foreach (var k in quotelist)
                {
                    PurchaseRFQModel subList = new PurchaseRFQModel();
                    subList.PurchaseStatus = k.PurchaseDDLStatus;
                    subList.PurchaseRemark = k.PurchaseRemark;
                    subList.Summary = k.PurchaseStatus;
                    subList.AssignedDate = k.PurchaseDate;
                    if (k.PurchaseDate.HasValue)
                    {
                        subList.AssignedDateText = k.PurchaseDate.Value.ToShortDateString();
                    }
                    subList.CASNo = k.CASNo;
                    subList.CATNo = k.CATNo;
                    subList.ChemicalName = k.ProductName;
                    subList.CreatedDate = k.CreatedDate;
                    if (k.EstimateCompleteDate.HasValue)
                    {
                        subList.EstdateText = k.EstimateCompleteDate.Value.ToShortDateString();
                    }
                    model.Add(subList);
                }

                if (!string.IsNullOrEmpty(purchasestatus))
                {
                    model = model.Where(m => (m.PurchaseStatus != null && m.PurchaseStatus.ToLower().Contains(purchasestatus))).ToList();
                }
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.ChemicalName != null && m.ChemicalName.ToLower().Contains(searchValue))
                                        || (m.Summary != null && m.Summary.ToLower().Contains(searchValue))).ToList();
                }
                model = model.OrderByDescending(x => x.AssignedDate).ToList();
                recordsTotal = model.Count();
                var data = model.Skip(skip).Take(pageSize).ToList();
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                throw ex;
            }

        }

        [HttpPost]
        public ActionResult LoadPurchaseLoginRFQData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                var purchasestatus = Request.Form.GetValues("purchasestatus")[0].ToString();
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;

                var list = (from i in db.SZ_PurchaseRFQ
                            orderby i.CreatedDate descending
                            select i).Distinct();

                var PurchaseDDLStatusItems = new List<SelectListItem>();
                PurchaseDDLStatusItems.Add(new SelectListItem { Text = "Select", Value = "" });

                foreach (EnumList.PurchaseStatusDDL r in Enum.GetValues(typeof(EnumList.PurchaseStatusDDL)))
                {
                    var item = Enum.GetName(typeof(EnumList.PurchaseStatusDDL), r);
                    var test = r.ToString();
                    string text = SZ_Helper.GetEnumDescription((EnumList.PurchaseStatusDDL)(int)r);
                    int val = (int)r;
                    PurchaseDDLStatusItems.Add(new SelectListItem
                    {
                        Text = text,
                        Value = val.ToString()
                    });
                }

                //PurchaseDDLStatusItems.Add(new SelectListItem { Text = "RFQ", Value = "RFQ" });
                //PurchaseDDLStatusItems.Add(new SelectListItem { Text = "Quotation", Value = "Quotation" });
                //PurchaseDDLStatusItems.Add(new SelectListItem { Text = "Need Approval", Value = "Need Approval" });
                //PurchaseDDLStatusItems.Add(new SelectListItem { Text = "Approved", Value = "Approved" });
                //PurchaseDDLStatusItems.Add(new SelectListItem { Text = "Ordered", Value = "Ordered" });
                //PurchaseDDLStatusItems.Add(new SelectListItem { Text = "Submitted", Value = "Submitted" });
                //PurchaseDDLStatusItems.Add(new SelectListItem { Text = "On Hold", Value = "On Hold" });
                //PurchaseDDLStatusItems.Add(new SelectListItem { Text = "Regret", Value = "Regret" });

                var model = new List<PurchaseRFQModel>();
                foreach (var k in list)
                {
                    PurchaseRFQModel subList = new PurchaseRFQModel();
                    subList.ChkSaveRow = "<input type='checkbox' value='" + k.Id + "' class='clsSaverow' />";
                    subList.PurchaseStatusText = "<select id='PurchaseStatus_" + k.Id + "' class='clspurchasestatus'>";
                    foreach (var r in PurchaseDDLStatusItems)
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.PurchaseStatus))
                        {
                            selected = "selected ";
                            subList.PurchaseStatus = r.Value;
                        }
                        subList.PurchaseStatusText += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    }
                    subList.PurchaseStatusText += "</select>";
                    subList.PurchaseRemark = k.PurchaseRemark;
                    subList.PurchaseRemarkText = "<input id='purremark_" + k.Id + "' type='text' value='" + k.PurchaseRemark + "' title='" + k.PurchaseRemark + "'  style='width: 100%' />";
                    subList.Summary = k.Summary;
                    subList.Comment = k.Comment;
                    subList.RefBy = k.RefBy;
                    subList.AssignedDate = k.AssignedDate;
                    if (k.AssignedDate.HasValue)
                    {
                        subList.AssignedDateText = k.AssignedDate.Value.ToShortDateString();
                    }
                    subList.CommentText = "<input id='comment_" + k.Id + "' type='text' value='" + k.Comment + "' title='" + k.Comment + "' style='width:100%' />";
                    subList.SummaryText = "<input id='summary_" + k.Id + "' type='text' value='" + k.Summary + "' title='" + k.Summary + "' style='width:100%' />";
                    subList.CASNo = k.CASNo;
                    subList.CATNo = k.CATNo;
                    subList.ChemicalName = k.ChemicalName;

                    subList.ChemicalNameText = "<input id='chemicalName_" + k.Id + "' type='text' value='" + k.ChemicalName + "' title='" + k.ChemicalName + "' style='width:100%' />";
                    subList.CASNoText = "<input id='casno_" + k.Id + "' type='text' value='" + k.CASNo + "' title='" + k.CASNo + "' style='width:100%' />";
                    subList.CATNoText = "<input id='catno_" + k.Id + "' type='text' value='" + k.CATNo + "' title='" + k.CATNo + "' style='width:100%' />";

                    subList.CreatedDate = k.CreatedDate;
                    subList.Estdate = k.Estdate;
                    subList.EstdateText = "<input id='estDate_" + k.Id + "' data-value='" + k.Estdate + "' type='text' class='datepicker'  style='width:100%' />";
                    model.Add(subList);
                }
                model = model.Where(x => x.PurchaseStatus != "28" && x.PurchaseStatus != "16").ToList();

                if (!string.IsNullOrEmpty(purchasestatus))
                {
                    model = model.Where(m => m.PurchaseStatus == purchasestatus).ToList();
                }
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.ChemicalName != null && m.ChemicalName.ToLower().Contains(searchValue))
                                        || (m.Summary != null && m.Summary.ToLower().Contains(searchValue))).ToList();
                }
                model = model.OrderByDescending(x => x.AssignedDate).ToList();
                recordsTotal = model.Count();
                var data = model.Skip(skip).Take(pageSize).ToList();
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                throw ex;
            }

        }

        [HttpPost]
        public ActionResult LoadProductInstockData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                var fltinstockprostatusItem = Request.Form.GetValues("fltinstockprostatusItem")[0].ToString();
                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;
                var searchby = string.Empty;
                var searchbyvalue = string.Empty;
                if (Request.Form.GetValues("radiobuton") != null)
                {
                    searchby = Request.Form.GetValues("radiobuton")[0].ToString();
                }
                if (Request.Form.GetValues("searchbox") != null)
                {
                    searchbyvalue = Request.Form.GetValues("searchbox")[0].ToString().Trim();
                }
                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InStock);

                // Getting all Customer data  
                var list = (from i in db.SZ_Quotation
                            join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                            where t2.MoveToProject == true && string.IsNullOrEmpty(t2.TrackingNo)
                            && (t2.IsOnHold == false || t2.IsOnHold == null)
                            && (t2.ProjectType == inhouseProjectType)
                            orderby t2.MoveProjectDate descending
                            select t2).Distinct().AsQueryable();
                string internationcompanylist = "";
                if (SessionCookieManagement.IsInternational)
                {
                    internationcompanylist = db.SZ_UserManagement.Where(x => x.UserId == SessionCookieManagement.UserId).Select(x => x.CompanyIds).FirstOrDefault();
                    if (!string.IsNullOrEmpty(internationcompanylist))
                    {
                        List<int?> cidList = new List<int?>();
                        foreach (var item in internationcompanylist.Split(','))
                        {
                            if (!string.IsNullOrEmpty(item))
                            {
                                cidList.Add(Convert.ToInt32(item));
                            }
                        }
                        list = list.Where(x => cidList.Contains(x.SZ_Quotation.CompanyId) && x.SZ_Quotation.CreatedDate >= new DateTime(2022, 05, 01)).AsQueryable();
                    }
                }
                list = list.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo);
                var subscilistItems = new List<SelectListItem>();

                MemoryCacheManager objCache = new MemoryCacheManager();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });

                var scienList = objCache.Get("cache.GetScientistId", () =>
                {
                    return db.GetScientistId().ToList();
                });

                var subscienList = objCache.Get("cache.subscienList", () =>
                {
                    return db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();
                });
                var listItems = new List<SelectListItem>();

                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                    subscilistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                });


                foreach (var term in subscienList)
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }

                    subscilistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });

                }
                var proIds = list.Select(x => x.ProductId).Distinct().ToList();
                var productsdata = db.Products.Where(x => proIds.Contains(x.Id) && x.Deleted == false && x.Published == true).ToList();
                var inventoryData = db.SZ_Inventory.Where(x => proIds.Contains(x.ProductId)).ToList();
                var ReadyToDeliverScientistStatusId = db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();

                //if (!string.IsNullOrEmpty(searchValue))
                //{
                //    searchValue = searchValue.ToLower().Trim();
                //    list = list.Where(m => 
                //        (m.SelectedScientistName != null && m.SelectedScientistName.ToLower().Contains(searchValue))
                //    || (m.SelectedSubScientistName != null && m.SelectedSubScientistName.ToLower().Contains(searchValue))
                //                        || (m.CompanyName != null && m.CompanyName.ToLower().Contains(searchValue))
                //                        || (m.PONumber != null && m.PONumber.ToLower().Contains(searchValue))
                //                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                //                        || (m.Price != null && m.Price.ToLower().Contains(searchValue))
                //                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                //                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                //                        || (m.SelectedProjectType != null && m.SelectedProjectType.ToLower().Contains(searchValue))
                //                        || (m.RequiredQty != null && m.RequiredQty.ToLower().Contains(searchValue))
                //                        || (m.SelectedAdditionalBatchNo != null && m.SelectedAdditionalBatchNo.ToLower().Contains(searchValue))
                //                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                //                         || (m.EstimateCompleteDateText != null && m.EstimateCompleteDateText.ToString().ToLower().Contains(searchValue))
                //                          || (m.AdminScientistStatus != null && m.AdminScientistStatus.ToLower().Contains(searchValue))
                //                           || (m.ProjectStatustext != null && m.ProjectStatustext.ToLower().Contains(searchValue))
                //                            || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                //                            || (m.ActivityStatus != null && m.ActivityStatus.ToLower().Contains(searchValue))
                //                        || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))).AsQueryable();
                //}
                if (!string.IsNullOrEmpty(fltinstockprostatusItem))
                {
                    list = list.Where(x => x.ProStatus == fltinstockprostatusItem).AsQueryable();
                }
                if (!string.IsNullOrEmpty(searchby) && !string.IsNullOrEmpty(searchbyvalue))
                {
                    searchbyvalue = searchbyvalue.ToLower();

                    if (searchby == "quoteid")
                    {
                        list = list.Where(x => x.SZ_Quotation.Ref.ToLower().Contains(searchbyvalue)).AsQueryable();
                    }
                    if (searchby == "ponumber")
                    {
                        list = list.Where(x => x.SZ_Quotation.PONo.ToLower().Contains(searchbyvalue)).AsQueryable();
                    }
                    if (searchby == "company")
                    {
                        list = list.Where(x => x.SZ_Quotation.CompanyName.ToLower().Contains(searchbyvalue)).AsQueryable();
                    }
                    if (searchby == "productname")
                    {
                        list = list.Where(x => x.ProductName.ToLower().Contains(searchbyvalue)).AsQueryable();
                    }
                    if (searchby == "cas")
                    {
                        list = list.Where(x => x.CASNo != null ? x.CASNo.ToLower().Contains(searchbyvalue) : false).AsQueryable();
                    }
                    if (searchby == "cat")
                    {
                        list = list.Where(x => x.CATNo != null ? x.CATNo.ToLower().Contains(searchbyvalue) : false).AsQueryable();
                    }
                    if (searchby == "batchno")
                    {
                        var bid = db.SZ_Inventory.Where(x => x.BatchNo.Trim().ToLower() == searchbyvalue).Select(x => x.Id).FirstOrDefault();
                        list = list.Where(x => x.AdditionalBatchNo == bid).AsQueryable();
                        //list = list.Where(x => x.BatchNo != null ? x.BatchNo.ToLower().Contains(searchbyvalue) : false).AsQueryable();
                    }

                }
                //total number of rows count   
                recordsTotal = list.Count();
                //Paging   
                var datass = list.Skip(skip).Take(pageSize).ToList();

                var model = new List<ProjectListModel>();
                foreach (var k in datass)
                {
                    ProjectListModel subList = new ProjectListModel();
                    subList.IsConversionReport = k.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    subList.ChkSaveRow = "<input type='checkbox' value='" + k.Id + "' class='clsSaverow' />";
                    subList.ReadyToDeliverScientistStatusId = ReadyToDeliverScientistStatusId;
                    if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == subList.ReadyToDeliverScientistStatusId && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                    {
                        subList.ChkFirstRow = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                    }
                    else if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == subList.ReadyToDeliverScientistStatusId)
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' />";
                    }
                    else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && k.MoveToDispatch == null)
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' />";
                    }
                    else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                    {
                        subList.ChkFirstRow = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                    }
                    if (k.IsDispatchApprove.HasValue && k.IsDispatchApprove.Value && (k.MoveToDispatch == null || k.MoveToDispatch == false))
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' style='outline: 4px solid #c00'/>";
                    }
                    subList.ProjectType = k.ProjectType;
                    subList.PaymentTerms = k.SZ_Quotation.PaymentTerm;
                    subList.ActivityStatus = k.ActivityStatus;
                    subList.ActivityStatusText = "<select id='activitystatus_" + k.Id + "' class='clsActivityStatus' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    subList.ProStatus = k.ProStatus;
                    //if (k.ActivityStatus == "Approval First")
                    //{
                    //    subList.ActivityStatusText += "<option value='Approval First' selected>Approval First</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Approval First'>Approval First</option>";
                    //}
                    ////if (k.ActivityStatus == "Data Sent")
                    ////{
                    ////    subList.ActivityStatusText += "<option value='Data Sent' selected>Data Sent</option>";
                    ////}
                    ////else
                    ////{
                    ////    subList.ActivityStatusText += "<option value='Data Sent'>Data Sent</option>";
                    ////}
                    ////if (k.ActivityStatus == "Data Correction")
                    ////{
                    ////    subList.ActivityStatusText += "<option value='Data Correction' selected>Data Correction</option>";
                    ////}
                    ////else
                    ////{
                    ////    subList.ActivityStatusText += "<option value='Data Correction'>Data Correction</option>";
                    ////}
                    ////if (k.ActivityStatus == "Data Approved")
                    ////{
                    ////    subList.ActivityStatusText += "<option value='Data Approved' selected>Data Approved</option>";
                    ////}
                    ////else
                    ////{
                    ////    subList.ActivityStatusText += "<option value='Data Approved'>Data Approved</option>";
                    ////}
                    //if (k.ActivityStatus == "Immediate Dispatch")
                    //{
                    //    subList.ActivityStatusText += "<option value='Immediate Dispatch' selected>Immediate Dispatch</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Immediate Dispatch'>Immediate Dispatch</option>";
                    //}

                    //if (k.ActivityStatus == "Short Qty Dispatch")
                    //{
                    //    subList.ActivityStatusText += "<option value='Short Qty Dispatch' selected>Short Qty Dispatch</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Short Qty Dispatch'>Short Qty Dispatch</option>";
                    //}
                    //if (k.ActivityStatus == "Repeat Order")
                    //{
                    //    subList.ActivityStatusText += "<option value='Repeat Order' selected>Repeat Order</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Repeat Order'>Repeat Order</option>";
                    //}
                    //if (k.ActivityStatus == "Data Approved")
                    //{
                    //    subList.ActivityStatusText += "<option value='Data Approved' selected>Data Approved</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Data Approved'>Data Approved</option>";
                    //}
                    //if (k.ActivityStatus == "Data Sent")
                    //{
                    //    subList.ActivityStatusText += "<option value='Data Sent' selected>Data Sent</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Data Sent'>Data Sent</option>";
                    //}
                    //if (k.ActivityStatus == "Data Correction")
                    //{
                    //    subList.ActivityStatusText += "<option value='Data Correction' selected>Data Correction</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Data Correction'>Data Correction</option>";
                    //}
                    //if (k.ActivityStatus == "Invoice Sent")
                    //{
                    //    subList.ActivityStatusText += "<option value='Invoice Sent' selected>Invoice Sent</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Invoice Sent'>Invoice Sent</option>";
                    //}
                    //if (k.ActivityStatus == "PDC Awaited")
                    //{
                    //    subList.ActivityStatusText += "<option value='PDC Awaited' selected>PDC Awaited</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='PDC Awaited'>PDC Awaited</option>";
                    //}
                    //if (k.ActivityStatus == "Advance Payment")
                    //{
                    //    subList.ActivityStatusText += "<option value='Advance Payment' selected>Advance Payment</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Advance Payment'>Advance Payment</option>";
                    //}
                    //if (k.ActivityStatus == "Payment Due")
                    //{
                    //    subList.ActivityStatusText += "<option value='Payment Due' selected>Payment Due</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Payment Due'>Payment Due</option>";
                    //}
                    //if (k.ActivityStatus == "Insufficient QTY")
                    //{
                    //    subList.ActivityStatusText += "<option value='Insufficient QTY' selected>Insufficient QTY</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Insufficient QTY'>Insufficient QTY</option>";
                    //}

                    if (k.ActivityStatus == "Approval First")
                    {
                        subList.ActivityStatusText += "<option value='Approval First' selected>Approval First</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Approval First'>Approval First</option>";
                    }
                    if (k.ActivityStatus == "Immediate Dispatch")
                    {
                        subList.ActivityStatusText += "<option value='Immediate Dispatch' selected>Immediate Dispatch</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Immediate Dispatch'>Immediate Dispatch</option>";
                    }

                    if (k.ActivityStatus == "Repeat Order")
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order' selected>Repeat Order</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order'>Repeat Order</option>";
                    }

                    if (k.ActivityStatus == "Repeat Order - Dispatch")
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Dispatch' selected>Repeat Order - Dispatch</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Dispatch'>Repeat Order - Dispatch</option>";
                    }
                    if (k.ActivityStatus == "Repeat Order - Approval First")
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Approval First' selected>Repeat Order - Approval First</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Repeat Order - Approval First'>Repeat Order - Approval First</option>";
                    }
                    if (k.ActivityStatus == "Short Qty Dispatch")
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatch' selected>Short Qty Dispatch</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatch'>Short Qty Dispatch</option>";
                    }
                    if (k.ActivityStatus == "Short Qty Dispatched")
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatched' selected>Short Qty Dispatched</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Short Qty Dispatched'>Short Qty Dispatched</option>";
                    }
                    if (k.ActivityStatus == "Sample Request")
                    {
                        subList.ActivityStatusText += "<option value='Sample Request' selected>Sample Request</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Sample Request'>Sample Request</option>";
                    }
                    if (k.ActivityStatus == "Sample Sent")
                    {
                        subList.ActivityStatusText += "<option value='Sample Sent' selected>Sample Sent</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Sample Sent'>Sample Sent</option>";
                    }
                    if (k.ActivityStatus == "Sample Approved")
                    {
                        subList.ActivityStatusText += "<option value='Sample Approved' selected>Sample Approved</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Sample Approved'>Sample Approved</option>";
                    }
                    //if (k.ActivityStatus == "Insufficient QTY")
                    //{
                    //    subList.ActivityStatusText += "<option value='Insufficient QTY' selected>Insufficient QTY</option>";
                    //}
                    //else
                    //{
                    //    subList.ActivityStatusText += "<option value='Insufficient QTY'>Insufficient QTY</option>";
                    //}
                    if (k.ActivityStatus == "Quote - Data Sent")
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Sent' selected>Quote - Data Sent</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Sent'>Quote - Data Sent</option>";
                    }
                    if (k.ActivityStatus == "Quote - Data Approved")
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Approved' selected>Quote - Data Approved</option>";
                    }
                    else
                    {
                        subList.ActivityStatusText += "<option value='Quote - Data Approved'>Quote - Data Approved</option>";
                    }
                    subList.ActivityStatusText += "</select>";

                    subList.ProjectTypeText = "<select id='projecttype_" + k.Id + "' class='clsProjType' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ProjectType), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.ProjectType)
                        {
                            selected = "selected ";
                            subList.SelectedProjectType = text;
                        }
                        //if (text != "In-House")
                        //{
                            subList.ProjectTypeText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                        //}
                    }

                    subList.ProjectTypeText += "</select>";
                    subList.ScientistName = "<select id='ScientistId_" + k.Id + "' class='scientist' scientistId='" + k.ScientistCustomerId + "' quotedetailsid='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (var r in listItems)
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.ScientistCustomerId))
                        {
                            selected = "selected ";
                            subList.SelectedScientistName = r.Text;
                        }
                        subList.ScientistName += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    }
                    subList.ScientistName += "</select>";
                    subList.AdditionalBatchNo = k.AdditionalBatchNo;
                    subList.QuoteId = k.SZ_Quotation.Id;
                    subList.ProductId = k.ProductId;
                    subList.ProductName = k.ProductName;
                    subList.IsPaymentPending = k.SZ_Quotation.SZ_CompanyList.IsPaymentPending;
                    subList.ScientistRemark = "<input id='sciremark_" + k.Id + "' type='text' value='" + k.ScientistRemark + "' style='width: 170px' />";
                    subList.RequiredQtyTxt = "<input id='qty_" + k.Id + "' type='text' value='" + k.RequiredQty + "' style='width: 50px' />";
                    subList.AdditionalBatchNoText = "<select id='additionalBatch_" + k.Id + "' data-quotationdetailsid='" + k.Id + "' class='ddladditionalbatch'><option value=''>--Select--</option>";
                    if (subList.ProductId.HasValue)
                    {
                        var proData = productsdata.Where(x => x.Id == subList.ProductId && x.Published == true && x.Deleted == false).Count();
                        var productData = productsdata.Where(x => x.Id == subList.ProductId && x.Published == true && x.Deleted == false).FirstOrDefault();
                        if (productData != null)
                        {
                            subList.IsControlledSubstance = productData.IsControlledSubstance;
                            if (!subList.IsControlledSubstance.HasValue
                                || subList.IsControlledSubstance == false)
                            {
                                subList.IsControlledSubstance = productData.IsManuallyControlledSubstance;
                            }
                        }
                        var proBatchData = inventoryData.Where(x => x.ProductId == subList.ProductId).ToList();
                        if (proBatchData.Count > 0 && proData > 0)
                        {
                            foreach (var r in proBatchData)
                            {
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }
                                string selected = string.Empty;
                                if (r.Id == subList.AdditionalBatchNo)
                                {
                                    selected = "selected ";
                                    subList.BatchNo = r.BatchNo;
                                    subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
                                }

                                subList.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' " + selected + ">" + text + "</option>";
                            }
                        }
                    }
                    subList.AdditionalBatchNoText += "</select>";
                    //subList.BatchNo = k.BatchNo;
                    subList.BatchNoText = "<input id='batchno_" + k.Id + "' type='text' value='" + k.BatchNo + "' style='width:120px' />";
                    subList.IsImageAttach = k.SZ_Quotation.IsImageAttach;
                    subList.CompanyName = k.SZ_Quotation.SZ_CompanyList.Name;
                    subList.Email = k.SZ_Quotation.EmailAddress;
                    subList.PONumber = k.SZ_Quotation.PONo;
                    subList.Ref = k.SZ_Quotation.Ref;
                    subList.Remark = k.SZ_Quotation.Remark;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.QuoteDetailsId = k.Id;
                    subList.CASNo = k.CASNo;
                    subList.IsConversionReport = k.SZ_Quotation.SZ_CompanyList.IsConversionReport;
                    var impstr = "";
                    if (subList.IsConversionReport.HasValue && subList.IsConversionReport.Value)
                    {
                        impstr += "<img src='/img/important.jpg' width='15px' height='15px' />";
                    }
                    subList.CATNo = "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>" + impstr + " " + CommonOperation.GetMatchingTagHTML(k, "Project");
                    subList.CreatedDate = k.CreatedDate;
                    subList.ImagePath = k.ImagePath;
                    subList.IsUploadServer = k.IsUploadServer;
                    subList.LeadTime = k.LeadTime;
                    subList.Price = k.Price;
                    subList.MoveProjectDateText = k.MoveProjectDate.HasValue ? k.MoveProjectDate.Value.ToString("dd/MM/yyyy hh:mm tt") : "";
                    subList.QuoteId = k.QuoteId;
                    subList.ProjectType = k.ProjectType;
                    subList.ScientistCustomerId = k.ScientistCustomerId;

                    subList.RequiredQty = k.RequiredQty;
                    subList.ProjectStatus = k.ProjectStatus;
                    subList.IsOnHold = k.IsOnHold;
                    if (k.ProjectStatus != null)
                    {
                        subList.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
                    }
                    subList.ScientistStatus = k.ScientistStatus;
                    subList.BatchCode1 = k.BatchCode1;
                    subList.BatchCode2 = k.BatchCode2;
                    subList.Qty1 = k.Qty1;
                    subList.Qty2 = k.Qty2;
                    subList.EstimateCompleteDate = k.EstimateCompleteDate;
                    subList.EstimateCompleteDateText = "<input id='esticompleteDate_" + k.Id + "' data-value='" + k.EstimateCompleteDate + "' type='text' class='datepicker'  style='width:80px' />";

                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToProject = k.MoveToProject;
                    subList.Remark = k.Remark;
                    subList.SrPo = k.SrPo;
                    subList.AdminScientistStatus = k.AdminScientistStatus;
                    subList.InvoiceNo = k.InvoiceNo;
                    subList.InvoiceRemark = k.InvoiceRemark;

                    subList.MoveProjectDate = k.MoveProjectDate;

                    subList.ScientistStatustext = "<input id='scientistStatus_" + k.Id + "' type='text' value='" + k.AdminScientistStatus + "' title='" + k.AdminScientistStatus + "'   style='width:200px' />";
                    subList.RemarkText = "<input id='remark_" + k.Id + "' type='text' value='" + k.Remark + "' title='" + k.Remark + "' style='width: 170px' />";
                    subList.LastRowText = "<a href='javascript: void(0)' id='save_" + k.Id + "' onclick='SaveInstockProjectDetails(\"" + k.Id + "\")'> Save</a> ";
                    subList.LastRowText += "<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";
                    subList.SubScientistName = "<select id='SubScientistId_" + k.Id + "' class='subscientist' subscientistId='" + k.SubScientistName + "' quotedetailsid='" + k.Id + "'><option value=''>--Select--</option>";
                    subscilistItems.ForEach(r =>
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.SubScientistName))
                        {
                            selected = "selected ";
                            subList.SelectedSubScientistName = r.Text;
                        }
                        subList.SubScientistName += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    });


                    subList.SubScientistName += "</select>";
                    subList.DispatchedStatus = k.DispatchedStatus;
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToInvoice = k.MoveToInvoice;
                    subList.IsDispatchApprove = k.IsDispatchApprove;
                    subList.Reason = k.Reason;
                    subList.ReasonText = "<input id='reason_" + k.Id + "' type='text' value='" + k.Reason + "' title='" + k.Reason + "'  style='width:200px' />";
                    subList.OrderRemark = k.OrderRemark;
                    subList.OrderRemarkText = "<input id='orderremark_" + k.Id + "' type='text' value='" + k.OrderRemark + "' title='" + k.OrderRemark + "'  style='width:200px' />";
                    subList.COARefNumber = k.COARefNumber;
                    subList.OtherProStatusText = "<select id='otherprostatus_" + k.Id + "' class='clsotherprostatus' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.ProInstockexportStatusDDL r in Enum.GetValues(typeof(EnumList.ProInstockexportStatusDDL)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ProInstockexportStatusDDL), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ProInstockexportStatusDDL)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.OtherProStatus)
                        {
                            selected = "selected ";
                            subList.SelectedOtherProStatus = text;
                        }
                        subList.OtherProStatusText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                    }
                    subList.OtherProStatusText += "</select>";
                    model.Add(subList);
                }
                model = model.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).ThenBy(x => x.SrPo).ToList();

                var data = model;
                //var finalData = PrepareQuotationListModel(data);
                //Returning Json Data  
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                throw ex;
            }

        }

        [HttpPost]
        public ActionResult LoadProductInHouseData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();

                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;

                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);

                var datelimit = new DateTime(2024, 1, 1);
                // Getting all Customer data  
                var list = (from i in db.SZ_Quotation
                            join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                            where t2.MoveToProject == true && string.IsNullOrEmpty(t2.TrackingNo) && (t2.IsOnHold == false || t2.IsOnHold == null)
                            && (t2.ProjectType == inhouseProjectType)
                            && i.CreatedDate >= datelimit
                            orderby t2.MoveProjectDate descending
                            select t2).Distinct();

                list = list.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo);

                MemoryCacheManager objCache = new MemoryCacheManager();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });

                var scienList = objCache.Get("cache.GetScientistId", () =>
                {
                    return db.GetScientistId().ToList();
                });

                var listItems = new List<SelectListItem>();
                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                });

                var proIds = list.Select(x => x.ProductId).Distinct().ToList();
                var productsdata = db.Products.Where(x => proIds.Contains(x.Id) && x.Deleted == false && x.Published == true).ToList();
                var inventoryData = db.SZ_Inventory.Where(x => proIds.Contains(x.ProductId)).ToList();
                var ReadyToDeliverScientistStatusId = db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                var model = new List<ProjectListModel>();
                foreach (var k in list)
                {
                    ProjectListModel subList = new ProjectListModel();
                    subList.ChkSaveRow = "<input type='checkbox' value='" + k.Id + "' class='clsSaverow' />";
                    subList.ReadyToDeliverScientistStatusId = ReadyToDeliverScientistStatusId;
                    if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == subList.ReadyToDeliverScientistStatusId && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                    {
                        subList.ChkFirstRow = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                    }
                    else if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == subList.ReadyToDeliverScientistStatusId)
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' />";
                    }
                    else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && k.MoveToDispatch == null)
                    {
                        subList.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsMoveDispatch' />";
                    }
                    else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                    {
                        subList.ChkFirstRow = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                    }
                    subList.PaymentTerms = k.SZ_Quotation.PaymentTerm;
                    subList.ProjectType = k.ProjectType;
                    subList.ProjectTypeText = "<select id='projecttype_" + k.Id + "' class='clsProjType' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ProjectType), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.ProjectType)
                        {
                            selected = "selected ";
                            subList.SelectedProjectType = text;
                        }
                        subList.ProjectTypeText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                    }
                    subList.ProjectTypeText += "</select>";
                    subList.ScientistName = "<select id='ScientistId_" + k.Id + "' class='scientist' scientistId='" + k.ScientistCustomerId + "' quotedetailsid='" + k.Id + "'><option value=''>--Select--</option>";
                    foreach (var r in listItems)
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.ScientistCustomerId))
                        {
                            selected = "selected ";
                            subList.SelectedScientistName = r.Text;
                        }
                        subList.ScientistName += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    }
                    subList.ScientistRemark = "<input id='sciremark_" + k.Id + "' type='text' value='" + k.ScientistRemark + "' style='width: 170px' />";
                    subList.ScientistName += "</select>";
                    subList.AdditionalBatchNo = k.AdditionalBatchNo;
                    subList.QuoteId = k.SZ_Quotation.Id;
                    subList.ProductId = k.ProductId;
                    subList.ProductName = k.ProductName;
                    subList.RequiredQtyTxt = "<input id='qty_" + k.Id + "' type='text' value='" + k.RequiredQty + "' style='width: 50px' />";
                    subList.AdditionalBatchNoText = "<select id='additionalBatch_" + k.Id + "'><option value=''>--Select--</option>";
                    if (subList.ProductId.HasValue)
                    {
                        var proData = productsdata.Where(x => x.Id == subList.ProductId && x.Published == true && x.Deleted == false).Count();
                        var proBatchData = inventoryData.Where(x => x.ProductId == subList.ProductId).ToList();
                        if (proBatchData.Count > 0 && proData > 0)
                        {
                            foreach (var r in proBatchData)
                            {
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }
                                string selected = string.Empty;
                                if (r.Id == subList.AdditionalBatchNo)
                                {
                                    selected = "selected ";
                                    subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";
                                }

                                subList.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' " + selected + ">" + text + "</option>";
                            }
                        }
                    }
                    subList.AdditionalBatchNoText += "</select>";
                    //subList.BatchNo = k.BatchNo;
                    subList.BatchNoText = "<input id='batchno_" + k.Id + "' type='text' value='" + k.BatchNo + "' style='width:120px' />";
                    subList.IsImageAttach = k.SZ_Quotation.IsImageAttach;
                    subList.CompanyName = k.SZ_Quotation.SZ_CompanyList.Name;
                    subList.Email = k.SZ_Quotation.EmailAddress;
                    subList.PONumber = k.SZ_Quotation.PONo;
                    subList.Ref = k.SZ_Quotation.Ref;
                    subList.Remark = k.SZ_Quotation.Remark;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.QuoteDetailsId = k.Id;
                    subList.CASNo = k.CASNo;
                    subList.CATNo = k.CATNo;
                    subList.CreatedDate = k.CreatedDate;
                    subList.ImagePath = k.ImagePath;
                    subList.IsUploadServer = k.IsUploadServer;
                    subList.LeadTime = k.LeadTime;
                    subList.Price = k.Price;

                    subList.QuoteId = k.QuoteId;
                    subList.ProjectType = k.ProjectType;
                    subList.ScientistCustomerId = k.ScientistCustomerId;

                    subList.RequiredQty = k.RequiredQty;
                    subList.ProjectStatus = k.ProjectStatus;
                    subList.IsOnHold = k.IsOnHold;
                    if (k.ProjectStatus != null)
                    {
                        subList.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
                    }
                    subList.ScientistStatus = k.ScientistStatus;
                    subList.BatchCode1 = k.BatchCode1;
                    subList.BatchCode2 = k.BatchCode2;
                    subList.Qty1 = k.Qty1;
                    subList.Qty2 = k.Qty2;
                    subList.EstimateCompleteDate = k.EstimateCompleteDate;
                    //if (k.EstimateCompleteDate.HasValue)
                    //{
                    //    subList.EstimateCompleteDateText = k.EstimateCompleteDate.Value.ToShortDateString();
                    //}
                    subList.EstimateCompleteDateText = "<input id='esticompleteDate_" + k.Id + "' data-value='" + k.EstimateCompleteDate + "' type='text' class='datepicker'  style='width:80px' />";
                    //if (k.AdditionalBatchNo.HasValue)
                    //{
                    //    subList.AdditionalBatchNoText = db.SZ_Inventory.Where(x => x.Id == k.AdditionalBatchNo).Select(x => x.BatchNo).FirstOrDefault();
                    //}
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToProject = k.MoveToProject;
                    subList.Remark = k.Remark;
                    subList.SrPo = k.SrPo;
                    subList.AdminScientistStatus = k.AdminScientistStatus;
                    subList.InvoiceNo = k.InvoiceNo;
                    subList.InvoiceRemark = k.InvoiceRemark;

                    subList.MoveProjectDate = k.MoveProjectDate;

                    subList.ScientistStatustext = "<input id='scientistStatus_" + k.Id + "' type='text' value='" + k.AdminScientistStatus + "' title='" + k.AdminScientistStatus + "'  style='width:200px' />";
                    subList.RemarkText = "<input id='remark_" + k.Id + "' type='text' value='" + k.Remark + "' title='" + k.Remark + "' style='width: 170px' />";
                    subList.LastRowText = "<a href='javascript: void(0)' id='save_" + k.Id + "' onclick='SaveProjectDetailsInhouse(\"" + k.Id + "\")'> Save</a> ";
                    subList.LastRowText += "<a href='javascript:void(0)' id='onhold_" + k.Id + "' onclick='SetOnHold(\"" + k.Id + "\")'>Hold</a>";
                    subList.SubScientistName = k.SubScientistName;
                    subList.DispatchedStatus = k.DispatchedStatus;
                    subList.MoveToDispatch = k.MoveToDispatch;
                    subList.MoveToInvoice = k.MoveToInvoice;
                    subList.IsDispatchApprove = k.IsDispatchApprove;
                    model.Add(subList);
                }
                //Sorting  
                //if (!string.IsNullOrEmpty(sortColumn) && !string.IsNullOrEmpty(sortColumnDir))
                //{
                //    model = model.OrderBy(sortColumn + " " + sortColumnDir).ToList();
                //}
                //else
                //{
                model = model.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).ThenBy(x => x.SrPo).ToList();
                // model = model.OrderBy(x => x.SrPo).ThenByDescending(x=>x.MoveProjectDate).ToList();
                //}

                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.SelectedScientistName != null && m.SelectedScientistName.ToLower().Contains(searchValue))
                                        || (m.CompanyName != null && m.CompanyName.ToLower().Contains(searchValue))
                                        || (m.PONumber != null && m.PONumber.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.Price != null && m.Price.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.SelectedProjectType != null && m.SelectedProjectType.ToLower().Contains(searchValue))
                                        || (m.RequiredQty != null && m.RequiredQty.ToLower().Contains(searchValue))
                                        || (m.SelectedAdditionalBatchNo != null && m.SelectedAdditionalBatchNo.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        || (m.EstimateCompleteDateText != null && m.EstimateCompleteDateText.ToString().ToLower().Contains(searchValue))
                                        || (m.AdminScientistStatus != null && m.AdminScientistStatus.ToLower().Contains(searchValue))
                                        || (m.ProjectStatustext != null && m.ProjectStatustext.ToLower().Contains(searchValue))
                                        || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                                        || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))).ToList();
                }

                //total number of rows count   
                recordsTotal = model.Count();
                //Paging   
                var data = model.Skip(skip).Take(pageSize).ToList();

                //var finalData = PrepareQuotationListModel(data);
                //Returning Json Data  
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                throw ex;
            }

        }

        public string GetCatalog(QuotationList_Result k)
        {
            string extraCatNoText = string.Empty;
            if (!string.IsNullOrEmpty(k.CATNo))
            {
                extraCatNoText = "<i class='clstooltip fa fa-pencil' onclick='AllQuotePrice(" + k.ProductId + ")'></i>";
            }
            return "<label>" + "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>" + "" + extraCatNoText + "</label><input type='text' id='catno_" + k.QuoteDetailsId + "'  value = '" + k.CATNo + "' style = 'display:none;' /> ";
        }
        public string GetCatalog(string CATNo, int? productId)
        {
            string extraCatNoText = string.Empty;
            if (!string.IsNullOrEmpty(CATNo))
            {
                extraCatNoText = "<i class='clstooltip fa fa-pencil' onclick='AllQuotePrice(" + productId + ")'></i>";
            }
            return "<label>" + "<a href='https://www.synzeal.com/search?q=" + CATNo + "' target='_blank'>" + CATNo + "</a>" + "" + extraCatNoText + "</label>";
        }

        public string GetMoveToProjectText(QuotationList_Result k, List<CompanyList_Result> companyData)
        {
            string MoveToProjectText = "";
            if (!string.IsNullOrEmpty(k.PONo))
            {
                var branchName = companyData.Where(x => x.Id == k.CompanyId).Select(x => x.Branch).FirstOrDefault();
                if (k.MoveToProject.HasValue && k.MoveToProject.Value)
                {
                    MoveToProjectText = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                }
                else
                {
                    MoveToProjectText = "<input type='checkbox' data-branchname='" + branchName + "' value='" + k.QuoteDetailsId + "' class='clsMoveProject' data-export='" + k.CountryType + "' data-alreadyInProjectScreen='" + (k.AlreadyInPoCount > 0 ? true : false) + "'  data-alreadyInInvoiceScreen='" + (k.AlreadyInvoicePoCount > 0 ? true : false) + "'/>";
                }
            }
            return MoveToProjectText;
        }

        public string GetQuoteListActionRow(QuotationList_Result k)
        {
            string ActionRow = "";
            if (Convert.ToString(TempData["tabname"]) == "followup")
            {
                ActionRow = "<a href='javascript:void(0)' id='edit_" + k.QuoteDetailsId + "' onclick='EditProductDetails(\"" + k.QuoteDetailsId + "\")'>Edit</a>";
                ActionRow += "<a href='javascript:void(0)' id='save_" + k.QuoteDetailsId + "' onclick='SaveProductDetails(\"" + k.QuoteDetailsId + "\")' style='display:none' >Save</a> ";
            }
            else if (Convert.ToString(TempData["tabname"]) == "park")
            {
                ActionRow = "<a href='javascript:void(0)' id='edit_" + k.QuoteDetailsId + "' onclick='EditProductDetails(\"" + k.QuoteDetailsId + "\")'>Edit</a>";
                ActionRow += "<a href='javascript:void(0)' id='save_" + k.QuoteDetailsId + "' onclick='SaveProductDetails(\"" + k.QuoteDetailsId + "\")' style='display:none' >Save</a>";
                //ActionRow += "<a href='../Form/Quote/" + k.QuoteId + "' > Update</a>";
            }
            else
            {
                ActionRow = "<a href='javascript:void(0)' id='edit_" + k.QuoteDetailsId + "' onclick='EditProductDetails(\"" + k.QuoteDetailsId + "\")'>Edit</a>";
                ActionRow += "<a href='javascript:void(0)' id='save_" + k.QuoteDetailsId + "' onclick='SaveProductDetails(\"" + k.QuoteDetailsId + "\")' style='display:none' >Save</a>";
                //ActionRow += "<a href='../Form/Quote/" + k.QuoteId + "' > Update</a>";
            }
            return ActionRow;
        }

        [HttpGet]
        public JsonResult GetCOADetailsFromBatchId(int batchId)
        {
            string coaText = "";
            coaText = "<option value=''>--Select--</option>";
            var mastercoa = db.SZ_MasterCOA.Where(x => x.BatchId == batchId).FirstOrDefault();
            if (mastercoa != null)
            {
                var listchildcoa = db.SZ_ChildCOA.Where(x => x.MasterCOAID == mastercoa.Id).ToList();
                if (listchildcoa != null && listchildcoa.Count > 0)
                {
                    foreach (var ccoa in listchildcoa)
                    {
                        coaText += "<option value='" + ccoa.Id.ToString() + "' data-value='" + batchId + "'>" + ccoa.RefNo + "</option>";
                    }
                }
            }
            return Json(coaText, JsonRequestBehavior.AllowGet);
        }

        public string GetCOA(QuotationList_Result k, List<SZ_MasterCOA> masterCOAData, List<SZ_ChildCOA> childcoadata)
        {
            string coaText = "";
            coaText = "<select id='coa_" + k.QuoteDetailsId + "' class='addcoa'><option value=''>--Select--</option>";
            int bId = k.AdditionalBatchNo.HasValue ? k.AdditionalBatchNo.Value : 0;
            if (bId != 0)
            {
                var mastercoa = masterCOAData.Where(x => x.BatchId == bId).FirstOrDefault();
                if (mastercoa != null)
                {
                    var listchildcoa = childcoadata.Where(x => x.MasterCOAID == mastercoa.Id).ToList();
                    if (listchildcoa != null && listchildcoa.Count > 0)
                    {
                        foreach (var ccoa in listchildcoa)
                        {
                            if (k.COAId == ccoa.Id)
                            {
                                coaText += "<option value='" + ccoa.Id.ToString() + "' data-value='" + k.AdditionalBatchNo + "' selected>" + ccoa.RefNo + "</option>";
                            }
                            else
                            {
                                coaText += "<option value='" + ccoa.Id.ToString() + "' data-value='" + k.AdditionalBatchNo + "'>" + ccoa.RefNo + "</option>";
                            }
                        }

                    }
                }
            }
            return coaText;
        }

        public string GetCOA(DispatchedDeliveredList_Result k, List<SZ_MasterCOA> masterCOAData, List<SZ_ChildCOA> childcoadata)
        {
            string coaText = "";
            coaText = "<select id='coa_" + k.QuoteDetailsId + "' class='addcoa'><option value=''>--Select--</option>";
            int bId = k.AdditionalBatchNo.HasValue ? k.AdditionalBatchNo.Value : 0;
            if (bId != 0)
            {
                var mastercoa = masterCOAData.Where(x => x.BatchId == bId).FirstOrDefault();
                if (mastercoa != null)
                {
                    var listchildcoa = childcoadata.Where(x => x.MasterCOAID == mastercoa.Id).ToList();
                    if (listchildcoa != null && listchildcoa.Count > 0)
                    {
                        foreach (var ccoa in listchildcoa)
                        {
                            if (k.COAId == ccoa.Id)
                            {
                                coaText += "<option value='" + ccoa.Id.ToString() + "' data-value='" + k.AdditionalBatchNo + "' selected>" + ccoa.RefNo + "</option>";
                            }
                            else
                            {
                                coaText += "<option value='" + ccoa.Id.ToString() + "' data-value='" + k.AdditionalBatchNo + "'>" + ccoa.RefNo + "</option>";
                            }
                        }

                    }
                }
            }
            return coaText;
        }

        public string GetCOA(SZ_QuotationDetail k, List<SZ_MasterCOA> masterCOAData, List<SZ_ChildCOA> childcoadata)
        {
            string coaText = "";
            coaText = "<select id='coa_" + k.Id + "' class='addcoa'><option value=''>--Select--</option>";
            int bId = k.AdditionalBatchNo.HasValue ? k.AdditionalBatchNo.Value : 0;
            if (bId != 0)
            {
                var mastercoa = masterCOAData.Where(x => x.BatchId == bId).FirstOrDefault();
                if (mastercoa != null)
                {
                    var listchildcoa = childcoadata.Where(x => x.MasterCOAID == mastercoa.Id).ToList();
                    if (listchildcoa != null && listchildcoa.Count > 0)
                    {
                        foreach (var ccoa in listchildcoa)
                        {
                            if (k.COAId == ccoa.Id)
                            {
                                coaText += "<option value='" + ccoa.Id.ToString() + "' data-value='" + k.AdditionalBatchNo + "' selected>" + ccoa.RefNo + "</option>";
                            }
                            else
                            {
                                coaText += "<option value='" + ccoa.Id.ToString() + "' data-value='" + k.AdditionalBatchNo + "'>" + ccoa.RefNo + "</option>";
                            }
                        }

                    }
                }
            }
            return coaText;
        }

        public string GetActivityStatus(QuotationList_Result k, bool isDispatch = false)
        {
            string activitystatusText = "<select id='activityStatus_" + k.QuoteDetailsId + "' data-quotationdetailsid='" + k.QuoteDetailsId + "' class='ddlactivitystatus'><option value=''>--Select--</option>";

            if (k.ActivityStatus == "Approval First")
            {
                activitystatusText += "<option value='Approval First' selected>Approval First</option>";
            }
            else
            {
                activitystatusText += "<option value='Approval First'>Approval First</option>";
            }
            if (k.ActivityStatus == "Immediate Dispatch")
            {
                activitystatusText += "<option value='Immediate Dispatch' selected>Immediate Dispatch</option>";
            }
            else
            {
                activitystatusText += "<option value='Immediate Dispatch'>Immediate Dispatch</option>";
            }
            if (k.ActivityStatus == "Repeat Order")
            {
                activitystatusText += "<option value='Repeat Order' selected>Repeat Order</option>";
            }
            else
            {
                activitystatusText += "<option value='Repeat Order'>Repeat Order</option>";
            }
            if (k.ActivityStatus == "Repeat Order - Dispatch")
            {
                activitystatusText += "<option value='Repeat Order - Dispatch' selected>Repeat Order - Dispatch</option>";
            }
            else
            {
                activitystatusText += "<option value='Repeat Order - Dispatch'>Repeat Order - Dispatch</option>";
            }
            if (k.ActivityStatus == "Repeat Order - Approval First")
            {
                activitystatusText += "<option value='Repeat Order - Approval First' selected>Repeat Order - Approval First</option>";
            }
            else
            {
                activitystatusText += "<option value='Repeat Order - Approval First'>Repeat Order - Approval First</option>";
            }
            if (k.ActivityStatus == "Short Qty Dispatch")
            {
                activitystatusText += "<option value='Short Qty Dispatch' selected>Short Qty Dispatch</option>";
            }
            else
            {
                activitystatusText += "<option value='Short Qty Dispatch'>Short Qty Dispatch</option>";
            }
            if (k.ActivityStatus == "Short Qty Dispatched")
            {
                activitystatusText += "<option value='Short Qty Dispatched' selected>Short Qty Dispatched</option>";
            }
            else
            {
                activitystatusText += "<option value='Short Qty Dispatched'>Short Qty Dispatched</option>";
            }
            if (k.ActivityStatus == "Sample Request")
            {
                activitystatusText += "<option value='Sample Request' selected>Sample Request</option>";
            }
            else
            {
                activitystatusText += "<option value='Sample Request'>Sample Request</option>";
            }
            if (k.ActivityStatus == "Sample Sent")
            {
                activitystatusText += "<option value='Sample Sent' selected>Sample Sent</option>";
            }
            else
            {
                activitystatusText += "<option value='Sample Sent'>Sample Sent</option>";
            }
            if (k.ActivityStatus == "Sample Approved")
            {
                activitystatusText += "<option value='Sample Approved' selected>Sample Approved</option>";
            }
            else
            {
                activitystatusText += "<option value='Sample Approved'>Sample Approved</option>";
            }
            if (k.ActivityStatus == "Quote - Data Sent")
            {
                activitystatusText += "<option value='Quote - Data Sent' selected>Quote - Data Sent</option>";
            }
            else
            {
                activitystatusText += "<option value='Quote - Data Sent'>Quote - Data Sent</option>";
            }
            if (k.ActivityStatus == "Quote - Data Approved")
            {
                activitystatusText += "<option value='Quote - Data Approved' selected>Quote - Data Approved</option>";
            }
            else
            {
                activitystatusText += "<option value='Quote - Data Approved'>Quote - Data Approved</option>";
            }
            return activitystatusText;
        }

        public string GetAdditionalBatchNo(QuotationList_Result k, List<InventoryList_Result> inventoryList, List<SZ_ReservedQty> resQtyList, bool isDispatch = false, string tablename = null)
        {
            string AdditionalBatchNoText = "";
            if (k.ProductId.HasValue)
            {
                AdditionalBatchNoText = "<select id='additionalBatch_" + k.QuoteDetailsId + "' data-tablename='" + tablename + "' data-quotationdetailsid='" + k.QuoteDetailsId + "' class='ddladditionalbatch addbatch'><option value=''>--Select--</option>";
                var proBatchData = inventoryList.Where(x => x.ProductId == k.ProductId).OrderBy(x => x.Id).ToList();
                if (proBatchData.Count > 0)
                {
                    int probatchcount = 1;
                    foreach (var r in proBatchData)
                    {
                        string text = r.BatchNo + " (" /*+ Convert.ToInt32(r.Qty)*/;
                        if (r.AvailableQty.HasValue)
                        {
                            int availQty = Convert.ToInt32(r.AvailableQty.Value);
                            if (availQty < 0)
                            {
                                availQty = 0;
                            }
                            text += /*"/ " +*/ availQty;
                        }
                        var resdetail = resQtyList.Where(x => x.BatchId == r.Id).Sum(x => x.Qty);
                        if (resdetail > 0)
                        {
                            text += " - " + resdetail;
                        }

                        text += ")";

                        if (r.IsApproved == false)
                        {
                            text = "*" + text;
                        }

                        string selected = "";
                        if (r.Id == k.AdditionalBatchNo)
                        {
                            selected = "selected ";
                        }
                        AdditionalBatchNoText += "<option " + selected + " value='" + r.Id.ToString() + "' data-value='" + r.BatchNo + "'>" + text + "</option>";
                        probatchcount += 1;
                    }
                }
                AdditionalBatchNoText += "</select>";
            }

            return AdditionalBatchNoText;
        }

        public string GetFollowUpDescText(QuotationList_Result k)
        {
            string FollowUpDescText = "";
            if (k.IsFollowupChange.HasValue && k.IsFollowupChange.Value)
            {
                FollowUpDescText += "<i class='fa fa-pencil' style='color:red' onclick='followupdescgenerate(\"" + k.QuoteDetailsId + "\")' ></i>";
            }
            else
            {
                FollowUpDescText += "<i class='fa fa-pencil' onclick='followupdescgenerate(\"" + k.QuoteDetailsId + "\")' ></i>";
            }
            return FollowUpDescText;
        }



        public string GetActivityStatus(SZ_QuotationDetail k, bool isDispatch = false)
        {
            string activitystatusText = "<select id='activityStatus_" + k.Id + "' data-quotationdetailsid='" + k.Id + "' class='ddlactivitystatus'><option value=''>--Select--</option>";

            if (k.ActivityStatus == "Approval First")
            {
                activitystatusText += "<option value='Approval First' selected>Approval First</option>";
            }
            else
            {
                activitystatusText += "<option value='Approval First'>Approval First</option>";
            }
            if (k.ActivityStatus == "Immediate Dispatch")
            {
                activitystatusText += "<option value='Immediate Dispatch' selected>Immediate Dispatch</option>";
            }
            else
            {
                activitystatusText += "<option value='Immediate Dispatch'>Immediate Dispatch</option>";
            }
            if (k.ActivityStatus == "Repeat Order")
            {
                activitystatusText += "<option value='Repeat Order' selected>Repeat Order</option>";
            }
            else
            {
                activitystatusText += "<option value='Repeat Order'>Repeat Order</option>";
            }
            if (k.ActivityStatus == "Repeat Order - Dispatch")
            {
                activitystatusText += "<option value='Repeat Order - Dispatch' selected>Repeat Order - Dispatch</option>";
            }
            else
            {
                activitystatusText += "<option value='Repeat Order - Dispatch'>Repeat Order - Dispatch</option>";
            }
            if (k.ActivityStatus == "Repeat Order - Approval First")
            {
                activitystatusText += "<option value='Repeat Order - Approval First' selected>Repeat Order - Approval First</option>";
            }
            else
            {
                activitystatusText += "<option value='Repeat Order - Approval First'>Repeat Order - Approval First</option>";
            }
            if (k.ActivityStatus == "Short Qty Dispatch")
            {
                activitystatusText += "<option value='Short Qty Dispatch' selected>Short Qty Dispatch</option>";
            }
            else
            {
                activitystatusText += "<option value='Short Qty Dispatch'>Short Qty Dispatch</option>";
            }
            if (k.ActivityStatus == "Short Qty Dispatched")
            {
                activitystatusText += "<option value='Short Qty Dispatched' selected>Short Qty Dispatched</option>";
            }
            else
            {
                activitystatusText += "<option value='Short Qty Dispatched'>Short Qty Dispatched</option>";
            }
            if (k.ActivityStatus == "Sample Request")
            {
                activitystatusText += "<option value='Sample Request' selected>Sample Request</option>";
            }
            else
            {
                activitystatusText += "<option value='Sample Request'>Sample Request</option>";
            }
            if (k.ActivityStatus == "Sample Sent")
            {
                activitystatusText += "<option value='Sample Sent' selected>Sample Sent</option>";
            }
            else
            {
                activitystatusText += "<option value='Sample Sent'>Sample Sent</option>";
            }
            if (k.ActivityStatus == "Sample Approved")
            {
                activitystatusText += "<option value='Sample Approved' selected>Sample Approved</option>";
            }
            else
            {
                activitystatusText += "<option value='Sample Approved'>Sample Approved</option>";
            }
            if (k.ActivityStatus == "Quote - Data Sent")
            {
                activitystatusText += "<option value='Quote - Data Sent' selected>Quote - Data Sent</option>";
            }
            else
            {
                activitystatusText += "<option value='Quote - Data Sent'>Quote - Data Sent</option>";
            }
            if (k.ActivityStatus == "Quote - Data Approved")
            {
                activitystatusText += "<option value='Quote - Data Approved' selected>Quote - Data Approved</option>";
            }
            else
            {
                activitystatusText += "<option value='Quote - Data Approved'>Quote - Data Approved</option>";
            }
            return activitystatusText;
        }

        public string GetAdditionalBatchNo(SZ_QuotationDetail k, List<InventoryList_Result> inventoryList, List<SZ_ReservedQty> resQtyList, bool isDispatch = false, string tablename = null)
        {
            string AdditionalBatchNoText = "";
            if (k.ProductId.HasValue)
            {
                AdditionalBatchNoText = "<select id='additionalBatch_" + k.Id + "' data-tablename='" + tablename + "' data-quotationdetailsid='" + k.Id + "' class='ddladditionalbatch addbatch'><option value=''>--Select--</option>";
                var proBatchData = inventoryList.Where(x => x.ProductId == k.ProductId).OrderBy(x => x.Id).ToList();
                if (proBatchData.Count > 0)
                {
                    int probatchcount = 1;
                    foreach (var r in proBatchData)
                    {
                        string text = r.BatchNo + " (" /*+ Convert.ToInt32(r.Qty)*/;
                        if (r.AvailableQty.HasValue)
                        {
                            int availQty = Convert.ToInt32(r.AvailableQty.Value);
                            if (availQty < 0)
                            {
                                availQty = 0;
                            }
                            text += /*"/ " +*/ availQty;
                        }

                        var resdetail = resQtyList.Where(x => x.BatchId == r.Id).Sum(x => x.Qty);
                        if (resdetail > 0)
                        {
                            text += " - " + resdetail;
                        }

                        text += ")";
                        if (r.IsApproved == false)
                        {
                            text = "*" + text;
                        }
                        string selected = "";
                        if (r.Id == k.AdditionalBatchNo)
                        {
                            selected = "selected ";
                        }
                        AdditionalBatchNoText += "<option " + selected + " value='" + r.Id.ToString() + "' data-value='" + r.BatchNo + "'>" + text + "</option>";
                        probatchcount += 1;
                    }
                }
                AdditionalBatchNoText += "</select>";
            }

            return AdditionalBatchNoText;
        }

        public string GetFollowUpDescText(SZ_QuotationDetail k)
        {
            string FollowUpDescText = "";
            if (k.IsFollowupChange.HasValue && k.IsFollowupChange.Value)
            {
                FollowUpDescText += "<i class='fa fa-pencil' style='color:red' onclick='followupdescgenerate(\"" + k.Id + "\")' ></i>";
            }
            else
            {
                FollowUpDescText += "<i class='fa fa-pencil' onclick='followupdescgenerate(\"" + k.Id + "\")' ></i>";
            }
            return FollowUpDescText;
        }

        public IEnumerable<QuotationListModel> PrepareQuotationListModel(List<QuotationList_Result> data, bool isDispatch = false, string tablename = null)
        {
            bool isMiniAdmin = SessionCookieManagement.IsMiniAdmin;
            string synthesis = Convert.ToString((int)Synzeal_Inventory.Models.EnumList.ProjectType.Synthesis);
            string pursynthesis = Convert.ToString((int)Synzeal_Inventory.Models.EnumList.ProjectType.PurSynthesis);
            string purchase = Convert.ToString((int)Synzeal_Inventory.Models.EnumList.ProjectType.Purchase);
            var productids = data.Select(x => x.ProductId).ToList();
            var productsData = db.Products.Where(x => productids.Contains(x.Id)).ToList();
            MemoryCacheManager objCache = new MemoryCacheManager();
            var masterCOAData = objCache.Get("cache.mastercoadata", () =>
            {
                return db.SZ_MasterCOA.ToList();
            });
            var childcoadata = objCache.Get("cache.childcoadata", () =>
            {
                return db.SZ_ChildCOA.ToList();
            });
            var inventoryList = objCache.Get("cache.sp.inventoryList", () =>
            {
                return db.InventoryList().ToList();
            });
            var resQtyList = objCache.Get("cache.resQtyList", () =>
            {
                return db.SZ_ReservedQty.ToList();
            });
            masterCOAData = masterCOAData.Where(x => x.ProductId.HasValue && productids.Contains(x.ProductId)).ToList();

            var mastercoaids = masterCOAData.Select(x => x.Id).ToList();
            childcoadata = childcoadata.Where(x => mastercoaids.Contains(x.MasterCOAID.Value)).ToList();

            var compList = db.CompanyList().ToList();
            var model = new List<QuotationListModel>();
            if (data.Count() > 0)
            {
                model = (from k in data
                         select new QuotationListModel
                         {
                             FreezeQuote = k.FreezeQuote.HasValue ? k.FreezeQuote.Value : false,
                             IsControlledSubstance = productsData.Where(x => x.Id == k.ProductId).Select(x => x.IsControlledSubstance).FirstOrDefault() == true ? true : (productsData.Where(x => x.Id == k.ProductId).Select(x => x.IsManuallyControlledSubstance).FirstOrDefault()),
                             IsAlreadInProjectScreen = k.AlreadyInPoCount > 0 ? true : false,
                             IsAlreadInInvoiceScreen = k.AlreadyInvoicePoCount > 0 ? true : false,
                             PODate = k.PODate,
                             IsImportedQuote = k.IsImportedQuote,
                             EmailAddress = k.EmailAddress,
                             CreatedDate = k.CreatedDate,
                             QuoteDetailsId = k.QuoteDetailsId,
                             QuoteId = k.Id,
                             PONumber = k.PONo,
                             MoveToProject = k.MoveToProject,
                             Ref = k.Ref,
                             CompanyName = k.CompanyName,
                             ProductName = k.ProductName,
                             Price = k.Price,
                             FinalPrice = k.FinalPrice,
                             CASNo = k.CASNo,
                             CATNo = k.CATNo,
                             FollowupReason = k.FollowupReason,
                             FollowupStatus = k.FollowupStatus,
                             IsConversionReport = k.IsConversionReport,
                             CATNoText = GenerateCATNoLink(k.QuoteDetailsId, k.CATNo, k.ProductId, k.IsConversionReport),
                             LeadTime = k.LeadTime,
                             ChkFirstRow = "<input type='checkbox' value='" + k.QuoteDetailsId + "' data-refno='" + k.Ref + "' class='clsclubQuote' />",
                             PONumberText = "<label>" + k.PONo + "</label><input type='text' id='ponumber_" + k.QuoteDetailsId + "' value='" + k.PONo + "' style='display:none' />",
                             ProductNameText = "<label>" + k.ProductName + " </label><input type='text' id='productname_" + k.QuoteDetailsId + "' value='" + k.ProductName.ReplaceData("\'", @"\u0027") + "' style='display:none' />",
                             //ProductNameText = "<label>" + k.ProductName + " </label><input type='text' id='productname_" + k.QuoteDetailsId + "' value='" +  k.ProductName.Replace("\'", @"\u0027") + "' style='display:none' />",
                             PriceText = k.Price + "<input type='hidden' id='price_" + k.QuoteDetailsId + "' value='" + k.Price + "' style='display:none' /> ",
                             FinalPriceText = k.FinalPrice + "<input type='hidden' id='finalprice_" + k.QuoteDetailsId + "' value='" + k.FinalPrice + "' style='display:none' /> ",
                             CASNoText = "<label>" + k.CASNo + "</label><input type='text' id='casno_" + k.QuoteDetailsId + "'  value = '" + k.CASNo + "' style = 'display:none' /> ",
                             LeadTimeText = "<label>" + k.LeadTime + "</label><input type='text' id='leadtime_" + k.QuoteDetailsId + "'  value = '" + k.LeadTime + "' style = 'display:none;' /> ",
                             ProductRemark = "<label>" + k.ProductRemark + "</label><input type='text' id='ProductRemark_" + k.QuoteDetailsId + "'  value = '" + k.ProductRemark + "' style = 'display:none;' /> ",
                             FollowUpRemark = "<label>" + k.FollowUpRemark + "</label><input type='text' id='followUpRemark_" + k.QuoteDetailsId + "'  value = '" + k.FollowUpRemark + "' style = 'display:none;' /> ",
                             FollowUpRemarkSecond = "<label>" + k.FollowUpRemarkSecond + "</label><input type='text' id='followUpRemarkSecond_" + k.QuoteDetailsId + "'  value = '" + k.FollowUpRemarkSecond + "' style = 'display:none;' /> ",
                             TabName = Convert.ToString(TempData["tabname"]),
                             DownloadRow = "<a href='../Form/DownloadQuote/" + k.Id + "'> <i class='fa fa-download'></i></a>",
                             DownloadSampleRow = isDispatch == true ? "<a href='../Form/DownloadSampleQuote/" + k.Id + "?isdispatchquotelog=true'> <i class='fa fa-download'></i></a>" : "<a href='../Form/DownloadSampleQuote/" + k.Id + "'> <i class='fa fa-download'></i></a>",
                             ProductId = k.ProductId,
                             FollowupDescription = k.FollowupDescription,
                             ContactDetail = "<label id='lblcontactdetail_" + k.QuoteDetailsId + "'>" + k.ContactDetail + "</label><input type='text' id='contactdetail_" + k.QuoteDetailsId + "'  value = '" + k.ContactDetail + "' title= '" + k.ContactDetail + "' style = 'display:none;' /> ",
                             IsFollowUpAdminChange = k.IsFollowUpAdminChange,
                             IsFollowupChange = k.IsFollowupChange,
                             CountryType = k.CountryType,
                             //CATNoText = GetCatalog(k),
                             MoveToProjectText = GetMoveToProjectText(k, compList),
                             ActionRow = GetQuoteListActionRow(k),
                             AdditionalBatchNoText = GetAdditionalBatchNo(k, inventoryList, resQtyList, isDispatch, tablename),
                             COAId = k.COAId,
                             ActivityStatus = GetActivityStatus(k, isDispatch),
                             DownloadCOAText = !string.IsNullOrEmpty(k.QuoteBatchNo) && k.QuoteBatchNo != "0" ? "<a href='../Form/DownloadMasterCOAFromQuoteDetailsId/" + k.QuoteDetailsId + "'> <i class='fa fa-download'></i></a>" : "",
                             COAText = GetCOA(k, masterCOAData, childcoadata),
                             FollowUpDescText = GetFollowUpDescText(k),
                             IsOnHold = k.IsOnHold,
                             POValue = tablename == "followup" ? GetQuoteProductValue(k.Id) : 0,
                             AddTestCostRemark = GetAdditionalTestRemarkstring(k.AddTestCostRemark, k.QuoteDetailsId),
                             ChangeBatch = "<i class='fa fa-clone' title='Change Batch No' onclick='GetAllBatchNo(" + k.ProductId + "," + k.QuoteDetailsId + ")' ></i>",
                             FollowupAdminRemark = k.FollowupAdminRemark,
                             IsFollowupLost = k.IsFollowupLost.HasValue ? k.IsFollowupLost.Value : false,
                             IsFollowupMail = k.IsFollowupMail.HasValue ? k.IsFollowupMail.Value : false,
                             IsFollowupCall = k.IsFollowupCall.HasValue ? k.IsFollowupCall.Value : false,
                             IsFollowupWon = k.IsFollowupWon.HasValue ? k.IsFollowupWon.Value : false,
                             IsFollowupInterested = k.IsFollowupInterested.HasValue ? k.IsFollowupInterested.Value : false,
                             IsFollowupMeeting = k.IsFollowupMeeting.HasValue ? k.IsFollowupMeeting.Value : false,
                             IsFollowupLessValue = k.IsFollowupLessValue.HasValue ? k.IsFollowupLessValue.Value : false,
                             IsFollowupNegotiation = k.IsFollowupNegotiation.HasValue ? k.IsFollowupNegotiation.Value : false,
                             IsFollowupImportant = k.IsFollowupImportant.HasValue ? k.IsFollowupImportant.Value : false,
                             ItemDiscount = k.ItemDiscount
                         }).ToList();
            }
            return model;
        }

        public string GenerateCATNoLink(int quotedetailid, string catNo, int? productId, bool? isConversion = false)
        {
            string extraCatNoText = string.Empty;
            if (!string.IsNullOrEmpty(catNo))
            {
                extraCatNoText = "<i class='clstooltip fa fa-pencil' onclick='AllQuotePrice(" + productId + ")'></i>";
            }
            var str = "";
            if (isConversion.HasValue && isConversion.Value)
            {
                str += "<img src='/img/important.jpg' width='15px' height='15px' />";
            }
            MemoryCacheManager objCache = new MemoryCacheManager();

            var szProducts = objCache.Get("cache.productsdata", () =>
            {
                return db.Products.Where(x => x.Published == true && x.Deleted == false).ToList();
            });
            var isImportant = szProducts.Where(z => z.Id == productId).Select(z => z.Important).FirstOrDefault();
            int Important = 0;
            try
            {
                Important = Convert.ToInt32(isImportant);
            }
            catch (Exception e)
            {
                Important = 0;
            }
            var strimportant = "";
            if (Important > 0)
            {
                for (int i = 0; i < Important; i++)
                {
                    strimportant += "<i class='fa fa-solid fa-star' style='color: blue' ></i>";
                }
            }
            return "<input id='catno_" + quotedetailid + "' type='text' value='" + catNo + "' title='" + catNo + "' style='width:100%; display: none;' /><label id='lblcatno'>" + "<a href='https://www.synzeal.com/search?q=" + catNo + "' target='_blank'>" + catNo + "</a>" + "" + extraCatNoText + " " + str + ""+ strimportant + "</label> ";

            //var str = "<a href='https://www.synzeal.com/search?q=" + catNo + "' target='_blank'>" + catNo + "</a>";
            //if (isConversion.HasValue && isConversion.Value)
            //{
            //    str += "<img src='/img/important.jpg' width='20px' height='20px' />";
            //}
            //return str;
        }

        public IEnumerable<QuotationListModel> PrepareQuotationListModel(List<SZ_QuotationDetail> data)
        {
            bool isMiniAdmin = SessionCookieManagement.IsMiniAdmin;

            string synthesis = Convert.ToString((int)Synzeal_Inventory.Models.EnumList.ProjectType.Synthesis);
            string pursynthesis = Convert.ToString((int)Synzeal_Inventory.Models.EnumList.ProjectType.PurSynthesis);
            string purchase = Convert.ToString((int)Synzeal_Inventory.Models.EnumList.ProjectType.Purchase);

            var productids = data.Select(x => x.ProductId).ToList();
            var productsData = db.Products.Where(x => productids.Contains(x.Id)).ToList();

            MemoryCacheManager objCache = new MemoryCacheManager();
            var masterCOAData = objCache.Get("cache.mastercoadata", () =>
            {
                return db.SZ_MasterCOA.ToList();
            });
            var childcoadata = objCache.Get("cache.childcoadata", () =>
            {
                return db.SZ_ChildCOA.ToList();
            });
            var inventoryList = objCache.Get("cache.sp.inventoryList", () =>
            {
                return db.InventoryList().ToList();
            });
            var resQtyList = objCache.Get("cache.resQtyList", () =>
            {
                return db.SZ_ReservedQty.ToList();
            });

            masterCOAData = masterCOAData.Where(x => x.ProductId.HasValue && productids.Contains(x.ProductId)).ToList();

            var mastercoaids = masterCOAData.Select(x => x.Id).ToList();
            childcoadata = childcoadata.Where(x => mastercoaids.Contains(x.MasterCOAID.Value)).ToList();

            var compList = db.CompanyList().ToList();
            var model = new List<QuotationListModel>();
            if (data.Count() > 0)
            {
                model = (from k in data
                         select new QuotationListModel
                         {
                             POCopy = GetPOCOPYPDFLink(k.SZ_Quotation.QuotePDF),
                             IsControlledSubstance = productsData.Where(x => x.Id == k.ProductId).Select(x => x.IsControlledSubstance).FirstOrDefault(),
                             SAPSONo = k.SAPSONo,
                             SAPSODocEntry = k.SAPSODocEntry,
                             SAPSOLId = k.SAPSOLId,
                             IsImportedQuote = k.SZ_Quotation.IsImportedQuote,
                             EmailAddress = k.SZ_Quotation.EmailAddress,
                             CreatedDate = k.CreatedDate,
                             QuoteDetailsId = k.Id,
                             QuoteId = k.QuoteId,
                             PONumber = k.SZ_Quotation.PONo,
                             MoveToProject = k.MoveToProject,
                             Ref = k.SZ_Quotation.Ref,
                             CompanyName = k.SZ_Quotation.CompanyName,
                             ProductName = k.ProductName,
                             Price = k.Price,
                             FinalPrice = k.FinalPrice,
                             CASNo = k.CASNo,
                             CATNo = k.CATNo,
                             IsSuccessSAP = k.IsSuccessSAP,
                             CATNoLink = "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>",
                             LeadTime = k.LeadTime,
                             ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' data-refno='" + k.SZ_Quotation.Ref + "' class='clsclubQuote' />",
                             PONumberText = "<label>" + k.SZ_Quotation.PONo + "</label><input type='text' id='ponumber_" + k.Id + "' value='" + k.SZ_Quotation.PONo + "' style='display:none' />",
                             ProductNameText = "<label>" + k.ProductName + " </label><input type='text' id='productname_" + k.Id + "' value='" + k.ProductName.Replace("\'", @"\u0027") + "' style='display:none' />",
                             PriceText = k.Price + "<input type='hidden' id='price_" + k.Id + "' value='" + k.Price + "' style='display:none' /> ",
                             FinalPriceText = k.FinalPrice + "<input type='hidden' id='finalprice_" + k.Id + "' value='" + k.FinalPrice + "' style='display:none' /> ",
                             CASNoText = "<label>" + k.CASNo + "</label><input type='text' id='casno_" + k.Id + "'  value = '" + k.CASNo + "' style = 'display:none' /> ",
                             LeadTimeText = "<label>" + k.LeadTime + "</label><input type='text' id='leadtime_" + k.Id + "'  value = '" + k.LeadTime + "' style = 'display:none;' /> ",
                             ProductRemark = "<label>" + k.ProductRemark + "</label><input type='text' id='ProductRemark_" + k.Id + "'  value = '" + k.ProductRemark + "' style = 'display:none;' /> ",
                             FollowUpRemark = "<label id='lblfollowUpRemark_" + k.Id + "'>" + k.FollowUpRemark + "</label><input type='text' id='followUpRemark_" + k.Id + "'  value = '" + k.FollowUpRemark + "' style = 'display:none;' /> ",
                             FollowUpRemarkSecond = "<label>" + k.FollowUpRemarkSecond + "</label><input type='text' id='followUpRemarkSecond_" + k.Id + "'  value = '" + k.FollowUpRemarkSecond + "' style = 'display:none;' /> ",
                             ProductId = k.ProductId,
                             FollowupDescription = k.FollowupDescription,
                             ContactDetail = "<label id='lblcontactdetail_" + k.Id + "'>" + k.ContactDetail + "</label><input type='text' id='contactdetail_" + k.Id + "'  value = '" + k.ContactDetail + "' title= '" + k.ContactDetail + "' style = 'display:none;' /> ",
                             IsFollowUpAdminChange = k.IsFollowUpAdminChange,
                             IsFollowupChange = k.IsFollowupChange,
                             CountryType = k.SZ_Quotation.CountryType,
                             CATNoText = GetCatalog(k.CATNo, k.ProductId),
                             AdditionalBatchNoText = GetAdditionalBatchNo(k, inventoryList, resQtyList, false, ""),
                             COAId = k.COAId,
                             ActivityStatus = GetActivityStatus(k, false),
                             COAText = GetCOA(k, masterCOAData, childcoadata),
                             FollowUpDescText = GetFollowUpDescText(k),
                             IsOnHold = k.IsOnHold,
                             AddTestCostRemark = GetAdditionalTestRemarkstring(k.AddTestCostRemark, k.Id),
                             ChangeBatch = "<i class='fa fa-clone' title='Change Batch No' onclick='GetAllBatchNo(" + k.ProductId + "," + k.Id + ")' ></i>"
                         }).ToList();
            }
            return model;
        }

        public string GetPOCOPYPDFLink(string pdf)
        {
            var str = "";
            if (SessionCookieManagement.UserEmail == "bhavesh.prajapati@synzeal.com"
                    || SessionCookieManagement.UserEmail == "rajen@synzeal.com"
                    || SessionCookieManagement.UserEmail == "anirudhhsinh@synzeal.com"
                    || SessionCookieManagement.IsAdmin
                    || SessionCookieManagement.UserEmail == "kishan@synzeal.com"
                    || SessionCookieManagement.UserEmail == "kavita.tomar@synzeal.com"
                    || SessionCookieManagement.UserEmail == "dhrumil.trivedi@synzeal.com"
                    || SessionCookieManagement.UserEmail == "kamlesh.chitte@synzeal.com"
                    || SessionCookieManagement.UserEmail == "mansi.ghodasara@synzeal.com"
                    || SessionCookieManagement.UserEmail == "pratipalsinh.zala@synzeal.com"
                    || SessionCookieManagement.UserEmail == "yash.patel@synzeal.com"
                )
            {
                if (!string.IsNullOrEmpty(pdf))
                {
                    if (pdf.Contains(".s3"))
                    {
                        str = "<a href='" + pdf + "' download ><i class='fa fa-file-pdf-o'></i></a>";
                    }
                    else
                    {
                        str = "<a href='/Content/Attachment/" + pdf + "' download ><i class='fa fa-file-pdf-o'></i></a>";
                    }
                }
            }
            return str;
        }
        public ActionResult GetAllAdditionalTest()
        {
            MemoryCacheManager objCache = new MemoryCacheManager();
            var list = objCache.Get("cache.AdditionalTestData", () =>
            {
                return db.SZ_AdditionalTest.OrderBy(x => x.DisplayOrder).ToList();
            }); 
            return Json(list, JsonRequestBehavior.AllowGet);
        }
        public string GetAdditionalTestRemarkstring(string addTestRemark, int quoteDetailsId)
        {
            string str = string.Empty;
            if (!string.IsNullOrEmpty(addTestRemark))
            {
                str = "<i class='fa fa-eye' title='" + addTestRemark + "' onclick='GetAllAdditionaltest(&#39;" + addTestRemark + "&#39;)' ></i>";
            }
            return str;
        }

        public IEnumerable<QuotationListModel> PrepareSynthesisLogModel(List<SynthesisLog_Result> data, bool issynthesispage = false)
        {
            var listItems = new List<SelectListItem>();
            MemoryCacheManager objCache = new MemoryCacheManager();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });

            var scienList = objCache.Get("cache.GetScientistId", () =>
            {
                return db.GetScientistId().ToList();
            });

            var proids = data.Select(x => x.ProductId).ToList();
            var inventorydata = db.SZ_Inventory.Where(x => proids.Contains(x.ProductId)).ToList();
            scienList.ForEach(term =>
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                listItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.ToString()
                });
            });

            var model = new List<QuotationListModel>();
            if (data.Count() > 0)
            {
                foreach (var k in data)
                {
                    var objModel = new QuotationListModel();
                    objModel.IsAlreadInProjectScreen = k.AlreadyInPoCount > 0 ? true : false;
                    objModel.IsAlreadInInvoiceScreen = k.AlreadyInvoicePoCount > 0 ? true : false;
                    objModel.PODate = k.PODate;
                    objModel.IsImportedQuote = k.IsImportedQuote;
                    objModel.EmailAddress = k.EmailAddress;
                    objModel.CreatedDate = k.CreatedDate;
                    objModel.QuoteDetailsId = k.QuoteDetailsId;
                    objModel.QuoteId = k.QuoteId;
                    objModel.PONumber = k.PONo;
                    objModel.MoveToProject = k.MoveToProject;
                    objModel.ScientistCustomerId = k.ScientistCustomerId;
                    objModel.Ref = k.Ref;
                    objModel.CompanyName = k.CompanyName;
                    objModel.ProductName = k.ProductName;
                    objModel.Price = k.Price;
                    objModel.CASNo = k.CASNo;
                    objModel.CATNo = k.CATNo;
                    objModel.LeadTime = k.LeadTime;
                    objModel.ChkFirstRow = "<input type='checkbox' value='" + k.QuoteDetailsId + "' data-refno='" + k.Ref + "' class='clsclubQuote' />";
                    objModel.PONumberText = "<label>" + k.PONo + "</label><input type='text' id='ponumber_" + k.QuoteDetailsId + "' value='" + k.PONo + "' style='display:none;' />";
                    objModel.ProductNameText = "<label>" + k.ProductName + " </label><input type='text' id='productname_" + k.QuoteDetailsId + "' value='" + k.ProductName + "' style='display:none;' />";
                    objModel.PriceText = "<label>" + k.Price + " </label><input type='text' id='price_" + k.QuoteDetailsId + "' value='" + k.Price + "' style='display:none;' /> ";
                    objModel.CASNoText = "<label>" + k.CASNo + "</label><input type='text' id='casno_" + k.QuoteDetailsId + "'  value = '" + k.CASNo + "' style = 'display:none;' /> ";
                    objModel.CATNoText = "<label>" + k.CATNo + "</label><input type='text' id='catno_" + k.QuoteDetailsId + "'  value = '" + k.CATNo + "' style = 'display:none;' /> ";
                    objModel.LeadTimeText = "<label>" + k.LeadTime + "</label><input type='text' id='leadtime_" + k.QuoteDetailsId + "'  value = '" + k.LeadTime + "' style = 'display:none;' /> ";
                    objModel.ProductRemark = "<label>" + k.ProductRemark + "</label><input type='text' id='ProductRemark_" + k.QuoteDetailsId + "'  value = '" + k.ProductRemark + "' style = 'display:none;' /> ";
                    objModel.FollowUpRemark = "<label>" + k.FollowUpRemark + "</label><input type='text' id='followUpRemark_" + k.QuoteDetailsId + "'  value = '" + k.FollowUpRemark + "' style = 'display:none;' /> ";
                    objModel.FollowUpRemarkSecond = "<label>" + k.FollowUpRemarkSecond + "</label><input type='text' id='followUpRemarkSecond_" + k.QuoteDetailsId + "'  value = '" + k.FollowUpRemarkSecond + "' style = 'display:none;' /> ";
                    if (!string.IsNullOrEmpty(k.PONo))
                    {
                        if (k.MoveToProject.HasValue && k.MoveToProject.Value)
                        {
                            objModel.MoveToProjectText = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                        }
                        else
                        {
                            objModel.MoveToProjectText = "<input type='checkbox' value='" + k.QuoteDetailsId + "' class='clsMoveProject' data-export='" + k.CountryType + "' data-alreadyInProjectScreen='" + objModel.IsAlreadInProjectScreen + "' data-alreadyInInvoiceScreen='" + objModel.IsAlreadInInvoiceScreen + "'/>";
                        }
                    }
                    objModel.DownloadRow = "<a href='../Form/DownloadQuote/" + k.QuoteId + "'> <i class='fa fa-download'></i></a>";
                    objModel.DownloadSampleRow = "<a href='../Form/DownloadSampleQuote/" + k.QuoteId + "'> <i class='fa fa-download'></i></a>";
                    if (Convert.ToString(TempData["tabname"]) == "followup")
                    {
                        objModel.ActionRow = "<a href='javascript:void(0)' id='edit_" + k.QuoteDetailsId + "' onclick='EditProductDetails(\"" + k.QuoteDetailsId + "\")'>Edit</a>";
                        objModel.ActionRow += "<a href='javascript:void(0)' id='save_" + k.QuoteDetailsId + "' onclick='SaveProductDetails(\"" + k.QuoteDetailsId + "\")' style='display:none' >Save</a> ";
                    }
                    else
                    {
                        objModel.ActionRow = "<a href='javascript:void(0)' id='edit_" + k.QuoteDetailsId + "' onclick='EditProductDetails(\"" + k.QuoteDetailsId + "\")'>Edit</a>";
                        objModel.ActionRow += "<a href='javascript:void(0)' id='save_" + k.QuoteDetailsId + "' onclick='SaveProductDetails(\"" + k.QuoteDetailsId + "\")' style='display:none' >Save</a> | ";
                        objModel.ActionRow += "<a href='../Form/Quote/" + k.QuoteId + "' > Update</a> | ";
                        if (issynthesispage)
                        {
                            objModel.ActionRow += "<a href='javascript:void(0)' onclick='Quote.RemoveSynthesisLog(\"" + k.QuoteDetailsId + "\")' >Remove </a>";
                        }
                        else
                        {
                            objModel.ActionRow += "<a href='javascript:void(0)' onclick='Quote.deleteQuote(\"" + k.QuoteId + "\")' >Delete </a>";
                        }

                    }
                    objModel.ProductId = k.ProductId;
                    if (k.ProductId.HasValue)
                    {
                        objModel.AdditionalBatchNoText = "<select id='additionalBatch_" + k.ProductId + "' class='addbatch'><option value=''>--Select--</option>";
                        var proBatchData = inventorydata.Where(x => x.ProductId == k.ProductId).OrderBy(x => x.Id).ToList();
                        if (proBatchData.Count > 0)
                        {
                            int probatchcount = 1;
                            foreach (var r in proBatchData)
                            {
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }
                                objModel.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' data-value='" + r.BatchNo + "'>" + text + "</option>";
                                probatchcount += 1;
                            }
                        }
                        objModel.AdditionalBatchNoText += "</select>";
                    }
                    objModel.ProjectTypeText = "<select id='projecttype_" + k.QuoteDetailsId + "' class='clsProjType' data-quoteDetailsId='" + k.QuoteDetailsId + "'><option value=''>--Select--</option>";
                    foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ProjectType), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == k.ProjectType)
                        {
                            selected = "selected ";
                            objModel.SelectedProjectType = text;
                        }
                        objModel.ProjectTypeText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                    }
                    objModel.ProjectTypeText += "</select>";
                    objModel.ScientistName = "<select id='ScientistId_" + k.QuoteDetailsId + "' class='scientist' scientistId='" + k.ScientistCustomerId + "' quotedetailsid='" + k.QuoteDetailsId + "'><option value=''>--Select--</option>";
                    foreach (var r in listItems)
                    {
                        string selected = string.Empty;
                        if (r.Value == Convert.ToString(k.ScientistCustomerId))
                        {
                            selected = "selected ";
                            objModel.SelectedScientistName = r.Text;
                        }
                        objModel.ScientistName += "<option value='" + r.Value + "' " + selected + ">" + r.Text + "</option>";
                    }
                    objModel.ScientistName += "</select>";
                    model.Add(objModel);
                }
            }
            return model;
        }

        public IEnumerable<QuotationListModel> PrepareQuotationListModelInternational(IEnumerable<SZ_Quotation> data)
        {
            var model = new List<QuotationListModel>();
            if (data.Count() > 0)
            {
                foreach (var i in data)
                {
                    foreach (var k in i.SZ_QuotationDetail)
                    {
                        var objModel = new QuotationListModel();
                        objModel.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsQuote' />";
                        objModel.POReceived = !string.IsNullOrEmpty(i.PONo) ? "Yes" : "No";
                        objModel.RequiredQty = k.RequiredQty;
                        objModel.PODate = i.PODate;
                        objModel.IsImportedQuote = i.IsImportedQuote;
                        objModel.EmailAddress = i.EmailAddress;
                        objModel.CreatedDate = i.CreatedDate;
                        objModel.QuoteDate = i.CreatedDate.Value.ToShortDateString();
                        objModel.QuoteDetailsId = k.Id;
                        objModel.QuoteId = k.QuoteId;
                        objModel.PONumber = i.PONo;
                        objModel.MoveToProject = k.MoveToProject;
                        objModel.Ref = i.Ref;
                        objModel.CompanyName = i.CompanyName;
                        objModel.ProductName = k.ProductName;
                        objModel.Price = k.Price;
                        objModel.CASNo = k.CASNo;
                        objModel.CATNo = k.CATNo;
                        objModel.LeadTime = k.LeadTime;
                        objModel.PONumberText = "<label>" + i.PONo + "</label><input type='text' id='ponumber_" + k.Id + "' value='" + i.PONo + "' style='display:none;' />";
                        objModel.ProductNameText = "<label>" + k.ProductName + " </label><input type='text' id='productname_" + k.Id + "' value='" + k.ProductName + "' style='display:none;' />";
                        objModel.PriceText = "<label>" + k.Price + " </label><input type='text' id='price_" + k.Id + "' value='" + k.Price + "' style='display:none;' /> ";

                        objModel.CASNoText = "<label>" + k.CASNo + "</label><input type='text' id='casno_" + k.Id + "'  value = '" + k.CASNo + "' style = 'display:none;' /> ";
                        objModel.CATNoText = "<label>" + k.CATNo + "</label><input type='text' id='catno_" + k.Id + "'  value = '" + k.CATNo + "' style = 'display:none;' /> ";
                        objModel.LeadTimeText = "<label>" + k.LeadTime + "</label><input type='text' id='leadtime_" + k.Id + "'  value = '" + k.LeadTime + "' style = 'display:none;' /> ";
                        objModel.ProductRemark = "<label>" + k.ProductRemark + "</label><input type='text' id='ProductRemark_" + k.Id + "'  value = '" + k.ProductRemark + "' style = 'display:none;' /> ";
                        if (!string.IsNullOrEmpty(i.PONo))
                        {
                            if (k.MoveToProject.HasValue && k.MoveToProject.Value)
                            {
                                objModel.MoveToProjectText = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                            }
                            else
                            {
                                objModel.MoveToProjectText = "<input type='checkbox' value='" + k.Id + "' class='clsMoveProject' />";
                            }
                        }
                        objModel.DownloadRow = "<a href='../Form/DownloadQuote/" + i.Id + "'> <i class='fa fa-download'></i></a>";
                        objModel.DownloadSampleRow = "<a href='../Form/DownloadSampleQuote/" + i.Id + "'> <i class='fa fa-download'></i></a>";
                        objModel.ActionRow = "<a href='javascript:void(0)' id='edit_" + k.Id + "' onclick='EditProductDetails(\"" + k.Id + "\")'>Edit</a>";
                        objModel.ActionRow += "<a href='javascript:void(0)' id='save_" + k.Id + "' onclick='SaveProductDetails(\"" + k.Id + "\")' style='display:none' >Save</a>|";
                        objModel.ActionRow += "<a href='../Form/Quote/" + i.Id + "' > Update </a> |";
                        objModel.ActionRow += "<a href='javascript:void(0)' onclick='Quote.deleteQuote(\"" + i.Id + "\")' > Delete </a>";
                        objModel.InternationStatus = k.InternationStatus;
                        objModel.InternationStatusText = "<select id='internationalstatus_" + k.Id + "' class='clsInternationalStatus' data-InternationStatus='" + k.InternationStatus + "' data-quoteDetailsId='" + k.Id + "'><option value=''>--Select--</option>";

                        foreach (EnumList.InternationStatusEnum r in Enum.GetValues(typeof(EnumList.InternationStatusEnum)))
                        {
                            var item = Enum.GetName(typeof(EnumList.InternationStatusEnum), r);
                            var test = r.ToString();
                            string text = SZ_Helper.GetEnumDescription((EnumList.InternationStatusEnum)(int)r);
                            int val = (int)r;
                            string selected = "";
                            if (val == k.InternationStatus)
                            {
                                selected = "selected ";
                                objModel.SelectedProjectType = text;
                            }
                            objModel.InternationStatusText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                        }
                        objModel.InternationStatusText += "</select>";
                        objModel.Feedback = "<input type='text' id='Feedback_" + k.Id + "' name='Feedback_" + k.Id + "' value='" + k.InternationFeedback + "' style='width: 85%'/> <i class='nav-icon fas fa-pencil-alt' onclick='feedbackpopup(" + k.Id + ")' style='float: right;margin-top: 7px;'></i>";

                        objModel.PODate = i.PODate;

                        model.Add(objModel);
                    }
                }
            }
            return model;
        }

        public IEnumerable<QuotationListModel> PrepareQuotationListModel(IEnumerable<SZ_Quotation> data)
        {
            var model = new List<QuotationListModel>();
            if (data.Count() > 0)
            {
                foreach (var i in data)
                {
                    foreach (var k in i.SZ_QuotationDetail)
                    {
                        var objModel = new QuotationListModel();
                        objModel.PODate = i.PODate;
                        objModel.IsImportedQuote = i.IsImportedQuote;
                        objModel.EmailAddress = i.EmailAddress;
                        objModel.CreatedDate = i.CreatedDate;
                        objModel.QuoteDetailsId = k.Id;
                        objModel.QuoteId = k.QuoteId;
                        objModel.PONumber = i.PONo;
                        objModel.MoveToProject = k.MoveToProject;
                        objModel.Ref = i.Ref;
                        objModel.CompanyName = i.CompanyName;
                        objModel.ProductName = k.ProductName;
                        objModel.Price = k.Price;
                        objModel.CASNo = k.CASNo;
                        objModel.CATNo = k.CATNo;
                        objModel.LeadTime = k.LeadTime;
                        objModel.ChkFirstRow = "<input type='checkbox' value='" + k.Id + "' class='clsclubQuote' />";
                        objModel.PONumberText = "<label>" + i.PONo + "</label><input type='text' id='ponumber_" + k.Id + "' value='" + i.PONo + "' style='display:none;' />";
                        objModel.ProductNameText = "<label>" + k.ProductName + " </label><input type='text' id='productname_" + k.Id + "' value='" + k.ProductName + "' style='display:none;' />";
                        objModel.PriceText = "<label>" + k.Price + " </label><input type='text' id='price_" + k.Id + "' value='" + k.Price + "' style='display:none;' /> ";

                        objModel.CASNoText = "<label>" + k.CASNo + "</label><input type='text' id='casno_" + k.Id + "'  value = '" + k.CASNo + "' style = 'display:none;' /> ";
                        objModel.CATNoText = "<label>" + k.CATNo + "</label><input type='text' id='catno_" + k.Id + "'  value = '" + k.CATNo + "' style = 'display:none;' /> ";
                        objModel.LeadTimeText = "<label>" + k.LeadTime + "</label><input type='text' id='leadtime_" + k.Id + "'  value = '" + k.LeadTime + "' style = 'display:none;' /> ";
                        objModel.ProductRemark = "<label>" + k.ProductRemark + "</label><input type='text' id='ProductRemark_" + k.Id + "'  value = '" + k.ProductRemark + "' style = 'display:none;' /> ";
                        if (!string.IsNullOrEmpty(i.PONo))
                        {
                            if (k.MoveToProject.HasValue && k.MoveToProject.Value)
                            {
                                objModel.MoveToProjectText = "<i class='fa fa-check-square' style='color:lightseagreen'></i>";
                            }
                            else
                            {
                                objModel.MoveToProjectText = "<input type='checkbox' value='" + k.Id + "' class='clsMoveProject' />";
                            }
                        }
                        objModel.DownloadRow = "<a href='../Form/DownloadQuote/" + i.Id + "'> <i class='fa fa-download'></i></a>";
                        objModel.DownloadSampleRow = "<a href='../Form/DownloadSampleQuote/" + i.Id + "'> <i class='fa fa-download'></i></a>";
                        objModel.ActionRow = "<a href='javascript:void(0)' id='edit_" + k.Id + "' onclick='EditProductDetails(\"" + k.Id + "\")'>Edit</a>";
                        objModel.ActionRow += "<a href='javascript:void(0)' id='save_" + k.Id + "' onclick='SaveProductDetails(\"" + k.Id + "\")' style='display:none' >Save</a>|";
                        objModel.ActionRow += "<a href='../Form/Quote/" + i.Id + "' > Update </a> |";
                        objModel.ActionRow += "<a href='javascript:void(0)' onclick='Quote.deleteQuote(\"" + i.Id + "\")' > Delete </a>";

                        model.Add(objModel);
                    }
                }
            }
            return model;
        }

        public ActionResult GetCountQuotationList()
        {
            int noactionstatus = (int)EnumList.ProjectStatus.NoAction;
            string synthesis = Convert.ToString((int)EnumList.ProjectType.Synthesis);

            var all = db.QuotationList("", "", "", "", "all", "", "", "", null, null, null,  0, 0, "0", null, null, null, null, null, 1, 200).ToList();
            ViewBag.AllCount = all.Select(x => x.TotalRecord).FirstOrDefault();
            int AllCount = 0;
            if (ViewBag.AllCount == null)
            {
                AllCount = 0;
            }
            else
            {
                AllCount = ViewBag.AllCount;
            }
            var tobe = db.QuotationList("", "", "", "", "tobe", "", "", "", null, null, null, 0, 0, "0", null, null, null, null, null, 1, 200).ToList();
            ViewBag.TobeCount = tobe.Select(x => x.TotalRecord).FirstOrDefault();
            int TobeCount = 0;
            if (ViewBag.TobeCount == null)
            {
                TobeCount = 0;
            }
            else
            {
                TobeCount = ViewBag.TobeCount;
            }
            var tobedist = db.QuotationList("", "", "", "", "tobedistributor", "", "", "", null, null, null, 0, 0, "0", null, null, null, null, null, 1, 200).ToList();
            ViewBag.TobeDistCount = tobedist.Select(x => x.TotalRecord).FirstOrDefault();
            int TobeDistCount = 0;
            if (ViewBag.TobeDistCount == null)
            {
                TobeDistCount = 0;
            }
            else
            {
                TobeDistCount = ViewBag.TobeDistCount;
            }

            var inhouse = db.QuotationList("", "", "", "", "inhouse", "", "", "", null, null, null, 0, 0, "0", null, null, null, null, null, 1, 200).ToList();
            ViewBag.InhouseCount = inhouse.Select(x => x.TotalRecord).FirstOrDefault();
            int InhouseCount = 0;
            int FollowupCount = 0;
            int AuctionCount = 0;

            if (ViewBag.InhouseCount == null)
            {
                InhouseCount = 0;
            }
            else
            {
                InhouseCount = ViewBag.InhouseCount;
            }
            var followup = db.QuotationList("", "", "", "", "followup", "", "", "", null, null, null, 0, 0, "0", null, null, null, null, null, 1, 200).ToList();
            ViewBag.FollowupCount = followup.Select(x => x.TotalRecord).FirstOrDefault();
            if (ViewBag.FollowupCount == null)
            {
                FollowupCount = 0;
            }
            else
            {
                FollowupCount = ViewBag.FollowupCount;
            }
            var auction = db.QuotationList("", "", "", "", "auction", "", "", "", null, null, null, 0, 0, "0", null, null, null, null, null, 1, 200).ToList();
            ViewBag.AuctionCount = auction.Select(x => x.TotalRecord).FirstOrDefault();

            if (ViewBag.AuctionCount == null)
            {
                AuctionCount = 0;
            }
            else
            {
                AuctionCount = ViewBag.AuctionCount;
            }

            var approved = db.QuotationList("", "", "", "", "approved", "", "", "", null, null, null, 0, 0, "0", null, null, null, null, null, 1, 200).ToList();
            ViewBag.ApprovedCount = approved.Select(x => x.TotalRecord).FirstOrDefault();
            int ApprovedCount = 0;
            if (ViewBag.ApprovedCount == null)
            {
                ApprovedCount = 0;
            }
            else
            {
                ApprovedCount = ViewBag.ApprovedCount;
            }
            int RFQCount = db.SZ_Query.Count();

            return Json(new { RFQCount = RFQCount, AllCount = AllCount, TobeCount = TobeCount, TobeDistCount = TobeDistCount, InhouseCount = InhouseCount, FollowupCount = FollowupCount, AuctionCount = AuctionCount, ApprovedCount = ApprovedCount }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult QuotationList()
        {
            if (!SessionCookieManagement.IsAdmin
                && !SessionCookieManagement.IsFollowUp
                && !SessionCookieManagement.IsMiniAdmin
                && !SessionCookieManagement.IsInternational
                && !SessionCookieManagement.IsDomesticDispatch
                && !SessionCookieManagement.IsExportDispatch
                && SessionCookieManagement.UserEmail.ToLower() != "sandeep@synzeal.com")
            {
                return RedirectToAction("Index", "Home");
            }

            ViewBag.RFQCount = db.SZ_Query.Select(x => x.Email).Distinct().Count();


            var listCompItems = new List<SelectListItem>();
            listCompItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var compData = db.SZ_CompanyList.OrderBy(x => x.Name.Trim()).ToList();
            foreach (var term in compData)
            {
                listCompItems.Add(new SelectListItem
                {
                    Text = term.Name,
                    Value = term.Id.ToString()
                });
            }
            ViewBag.CompanyList = listCompItems;


            var GeographicalLocationList = new List<SelectListItem>();
            GeographicalLocationList.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = "",
                Selected = true
            });
            MemoryCacheManager objCache = new MemoryCacheManager();
            var geographicalLocationData = objCache.Get("cache.geographicalLocationData", () =>
            {
                return db.SZ_Geographical.OrderBy(x => x.Id).ToList();
            });

            if (geographicalLocationData != null && geographicalLocationData.Count > 0)
            {
                geographicalLocationData.ForEach(item =>
                {
                    GeographicalLocationList.Add(new SelectListItem
                    {
                        Text = item.Name,
                        Value = item.Id.ToString()
                    });
                });
            }
            ViewBag.GeographicalLocationList = GeographicalLocationList;

            var list = new List<SZ_QuotationModel>();
            return View(list);
        }


        [HttpPost]
        public JsonResult CopyMasterCOATOChildCOA(int id)
        {
            var masterrecord = db.SZ_MasterCOA.Where(x => x.BatchId == id).FirstOrDefault();
            if (masterrecord != null)
            {
                SZ_ChildCOA objchild = new SZ_ChildCOA();
                objchild.MasterCOAID = masterrecord.Id;
                objchild.ProductName = masterrecord.ProductName;
                objchild.BatchNo = masterrecord.BatchNo;
                objchild.QuantityAvailable = masterrecord.QuantityAvailable;
                objchild.AnalysisDate = masterrecord.AnalysisDate;
                objchild.HPLCGCELSD = masterrecord.HPLCGCELSD;
                objchild.TGALoss = masterrecord.TGALoss;
                objchild.ResidueOnIgnition = masterrecord.ResidueOnIgnition;
                objchild.Potency = masterrecord.Potency;
                objchild.PhysicalState = masterrecord.PhysicalState;
                objchild.SOLUBILITY = masterrecord.SOLUBILITY;
                objchild.IR = masterrecord.IR;
                objchild.Mass = masterrecord.Mass;
                objchild.HPLC = masterrecord.HPLC;
                objchild.NMR = masterrecord.NMR;
                objchild.CMR = masterrecord.CMR;
                objchild.Dept = masterrecord.Dept;
                objchild.TGA = masterrecord.TGA;
                objchild.StorageCon = masterrecord.StorageCon;
                objchild.ReTestDate = masterrecord.ReTestDate;
                objchild.SpecialInstruction = masterrecord.SpecialInstruction;
                objchild.Remark1 = masterrecord.Remark1;
                objchild.Remark2 = masterrecord.Remark2;
                objchild.CreatedDate = DateTime.Now;
                objchild.UpdatedDate = DateTime.Now;
                objchild.IsRepresentative = false;
                objchild.Purity = masterrecord.Purity;

                db.SZ_ChildCOA.Add(objchild);
                db.SaveChanges();

                return Json(new
                {
                    success = true,
                    message = "Successfully copied this COA."
                }, JsonRequestBehavior.AllowGet);
            }
            return Json(new
            {
                success = false,
                message = "Please fill up all fields and after that try to copy this COA."
            }, JsonRequestBehavior.AllowGet);
        }

        /// <summary>
        /// Fetch master and child records
        /// </summary>
        /// <param name="value"></param>
        /// <returns></returns>
        [HttpPost]
        public JsonResult FetchProductInformation(string value)
        {
            value = value.Trim().ToLower();

            var data = (from i in db.Products
                        join t2 in db.SZ_Inventory on i.Id equals t2.ProductId
                        join t3 in db.SZ_MasterCOA on t2.Id equals t3.BatchId into gj
                        from subpet in gj.DefaultIfEmpty()
                        join t4 in db.SZ_ChildCOA on subpet.Id equals t4.MasterCOAID into gjj
                        from subpets in gjj.DefaultIfEmpty()
                        where (i.Sku.Trim().ToLower() == value.Trim().ToLower() || i.ManufacturerPartNumber.Trim().ToLower() == value.Trim().ToLower() || t2.BatchNo.ToLower().Trim() == value
                        || subpet.RefNo.Trim().ToLower() == value
                        || subpets.RefNo.Trim().ToLower() == value)
                        && i.Deleted == false && i.Published == true
                        select i).FirstOrDefault();

            var masterCOAIds = new List<int>();
            if (data != null)
            {
                var list = new List<MasterCOAModel>();
                var batchlist = db.SZ_Inventory.Where(x => x.ProductId == data.Id).ToList();
                if (batchlist.Count > 0)
                {
                    var bids = batchlist.Select(x => x.Id).ToList();
                    var masterCOAData = db.SZ_MasterCOA.Where(x => bids.Contains(x.BatchId)).ToList();
                    batchlist.ForEach(item =>
                    {
                        MasterCOAModel objmodel = new MasterCOAModel();
                        objmodel.Id = item.Id;
                        objmodel.ProductId = item.ProductId;
                        objmodel.ProductName = data.Name;
                        objmodel.CASNO = data.ManufacturerPartNumber;
                        objmodel.CATNO = data.Sku;
                        objmodel.BatchNo = item.BatchNo;
                        objmodel.QuantityAvailable = Convert.ToString(item.Qty);
                        var masterrecord = masterCOAData.Where(x => x.BatchId == item.Id).FirstOrDefault();
                        if (masterrecord != null)
                        {
                            objmodel.COAId = masterrecord.Id;
                        }
                        else
                        {
                            objmodel.COAId = 0;
                        }
                        list.Add(objmodel);
                    });
                }
                return Json(new
                {
                    success = true,
                    data = PartialViewdata(this, "_PartialCOAPrdouctInformation", list)
                    //childHtml = PartialViewdata(this, "_PartialSearchChildCOA", childlist)
                }, JsonRequestBehavior.AllowGet);
            }

            return Json(new
            {
                success = false,
                message = "This catalog number is not available."
            }, JsonRequestBehavior.AllowGet);
        }


        [HttpPost]
        public JsonResult ShowCOAInformation(int szInventoryId, string batchNo, int masterCoaId)
        {
            var masterCOAIds = new List<int>();

            var list = new List<MasterCOAModel>();
            var batchlist = db.SZ_Inventory.Where(x => x.Id == szInventoryId).FirstOrDefault();
            if (batchlist != null)
            {
                MasterCOAModel objmodel = new MasterCOAModel();
                objmodel.BatchId = batchlist.Id;
                objmodel.ProductId = batchlist.ProductId;
                string uri = Domain + "api/RestAPI/ProductDetails?productId=" + batchlist.ProductId;
                using (System.Net.Http.HttpClient httpClient = new System.Net.Http.HttpClient())
                {
                    Task<String> response = httpClient.GetStringAsync(uri);
                    string productModel = JsonConvert.DeserializeObject<string>(response.Result);
                    var productRecord = JsonConvert.DeserializeObject<ProductDetailsModel>(productModel);
                    if (productRecord != null)
                    {
                        objmodel.CASNO = productRecord.ManufacturerPartNumber;
                        objmodel.CATNO = productRecord.Sku;
                        objmodel.ProductName = productRecord.Name;
                        ViewBag.ImagePath = productRecord.DefaultPictureModel.FullSizeImageUrl;
                        ViewBag.CATNo = productRecord.Sku;
                        ViewBag.CASNo = productRecord.ManufacturerPartNumber;
                        ViewBag.MolFormula = productRecord.Gtin;
                        ViewBag.MolecularWeight = productRecord.MolecularWeight;
                        ViewBag.Synonym = productRecord.Synonym;
                        ViewBag.ChemicalName = productRecord.ChemicalName;
                        ViewBag.IsControlledSubstance = productRecord.IsControlledSubstance;
                        if (!productRecord.IsControlledSubstance.HasValue
                                || productRecord.IsControlledSubstance == false)
                        {
                            ViewBag.IsControlledSubstance = productRecord.IsManuallyControlledSubstance;
                        }
                    }
                }

                var masterrecord = db.SZ_MasterCOA.Where(x => x.Id == masterCoaId).FirstOrDefault();
                if (masterrecord != null)
                {
                    masterCOAIds.Add(masterrecord.Id);
                    objmodel.IsEquation = masterrecord.IsEquation.HasValue ? masterrecord.IsEquation.Value : false;
                    objmodel.RefNo = masterrecord.RefNo;
                    objmodel.COAId = masterrecord.Id;
                    objmodel.AnalysisDate = masterrecord.AnalysisDate;
                    objmodel.BatchNo = masterrecord.BatchNo;
                    objmodel.ProductName = masterrecord.ProductName;
                    objmodel.CMR = masterrecord.CMR;
                    objmodel.Dept = masterrecord.Dept;
                    objmodel.HPLC = masterrecord.HPLC;
                    objmodel.HPLCGCELSD = masterrecord.HPLCGCELSD;
                    objmodel.IR = masterrecord.IR;
                    objmodel.Mass = masterrecord.Mass;
                    objmodel.NMR = masterrecord.NMR;
                    objmodel.PhysicalState = masterrecord.PhysicalState;
                    objmodel.Potency = masterrecord.Potency;
                    objmodel.QuantityAvailable = masterrecord.QuantityAvailable;
                    objmodel.Remark1 = masterrecord.Remark1;
                    objmodel.Remark2 = masterrecord.Remark2;
                    objmodel.ResidueOnIgnition = masterrecord.ResidueOnIgnition;
                    objmodel.ReTestDate = masterrecord.ReTestDate;
                    objmodel.SOLUBILITY = masterrecord.SOLUBILITY;
                    objmodel.SpecialInstruction = masterrecord.SpecialInstruction;
                    objmodel.StorageCon = masterrecord.StorageCon;
                    objmodel.TGA = masterrecord.TGA;
                    objmodel.TGALoss = masterrecord.TGALoss;
                    objmodel.Purity = masterrecord.Purity;
                    objmodel.Chemicalname = masterrecord.Chemicalname;
                    ViewBag.ChemicalName = masterrecord.Chemicalname;
                    ViewBag.MolFormula = masterrecord.MolFormula;
                    ViewBag.MolecularWeight = masterrecord.MolecularWeight;
                    ViewBag.Synonym = masterrecord.Synonym;
                    objmodel.Attachment = masterrecord.Attachment;
                    objmodel.AppearanceProduct = masterrecord.AppearanceProduct;
                    objmodel.Purity = masterrecord.Purity;
                    objmodel.AdditionalInfor = masterrecord.AdditionalInfor;
                    objmodel.EquationType = masterrecord.EquationType;
                    objmodel.IsLogoAttached = masterrecord.IsLogoAttached;
                    objmodel.IsManufacture = masterrecord.IsManufacture.HasValue ? masterrecord.IsManufacture.Value : false;
                    objmodel.ManufactureDate = masterrecord.ManufactureDate;
                    objmodel.OtherValue = masterrecord.OtherValue;
                    objmodel.IsShipping = masterrecord.IsShipping;
                    objmodel.CTheroretical = masterrecord.CTheroretical;
                    objmodel.HTheroretical = masterrecord.HTheroretical;
                    objmodel.NTheroretical = masterrecord.NTheroretical;
                    objmodel.STheroretical = masterrecord.STheroretical;
                    objmodel.CPractical = masterrecord.CPractical;
                    objmodel.HPractical = masterrecord.HPractical;
                    objmodel.NPractical = masterrecord.NPractical;
                    objmodel.SPractical = masterrecord.SPractical;
                    objmodel.CreatedBY = masterrecord.CreatedBy;
                    objmodel.UpdatedBY = masterrecord.UpdatedBy;
                    objmodel.WegithLossBy = masterrecord.WegithLossBy;
                    objmodel.MeltingPoint = masterrecord.MeltingPoint;
                    objmodel.qNMR = masterrecord.qNMR;
                    objmodel.CNMRText = masterrecord.CNMRText;
                }
                else
                {
                    objmodel.CNMRText = "";
                    objmodel.COAId = 0;
                    objmodel.BatchNo = batchlist.BatchNo;
                    objmodel.Mass = "Confirm";
                    objmodel.NMR = "Confirm";
                    objmodel.IR = "Confirm";
                    objmodel.EquationType = "Full";
                    objmodel.Purity = db.SZ_QuoteDetailForm.Where(x => x.BatchCode == batchlist.BatchNo).Select(x => x.HPLCPurity).FirstOrDefault();
                }
                if (string.IsNullOrEmpty(objmodel.StorageCon))
                {
                    objmodel.StorageCon = "2-8 °C for long term storage";
                }
                list.Add(objmodel);

            }
            var childlist = new List<MasterCOAModel>();
            if (masterCOAIds.Count > 0)
            {

                var childrecords = db.SZ_ChildCOA.Where(x => masterCOAIds.Contains(x.MasterCOAID.Value)).ToList();

                childrecords.ForEach(masterrecord =>
                {
                    //foreach (var masterrecord in childrecords)
                    //{
                    MasterCOAModel objmodel = new MasterCOAModel();
                    objmodel.Id = masterrecord.Id;
                    objmodel.RefNo = masterrecord.RefNo;
                    objmodel.COAId = masterrecord.Id;
                    masterCOAIds.Add(masterrecord.Id);
                    objmodel.AnalysisDate = masterrecord.AnalysisDate;
                    objmodel.BatchNo = masterrecord.BatchNo;
                    objmodel.ProductName = masterrecord.ProductName;
                    objmodel.CMR = masterrecord.CMR;
                    objmodel.Dept = masterrecord.Dept;
                    objmodel.HPLC = masterrecord.HPLC;
                    objmodel.HPLCGCELSD = masterrecord.HPLCGCELSD;
                    objmodel.IR = masterrecord.IR;
                    objmodel.Mass = masterrecord.Mass;
                    objmodel.NMR = masterrecord.NMR;
                    objmodel.PhysicalState = masterrecord.PhysicalState;
                    objmodel.Potency = masterrecord.Potency;
                    objmodel.QuantityAvailable = masterrecord.QuantityAvailable;
                    objmodel.Remark1 = masterrecord.Remark1;
                    objmodel.Remark2 = masterrecord.Remark2;
                    objmodel.ResidueOnIgnition = masterrecord.ResidueOnIgnition;
                    objmodel.ReTestDate = masterrecord.ReTestDate;
                    objmodel.SOLUBILITY = masterrecord.SOLUBILITY;
                    objmodel.SpecialInstruction = masterrecord.SpecialInstruction;
                    objmodel.StorageCon = masterrecord.StorageCon;
                    objmodel.TGA = masterrecord.TGA;
                    objmodel.TGALoss = masterrecord.TGALoss;
                    objmodel.Purity = masterrecord.Purity;
                    objmodel.IsLogoAttached = masterrecord.IsLogoAttached;
                    if (string.IsNullOrEmpty(masterrecord.StorageCon))
                    {
                        objmodel.StorageCon = "2-8 °C for long term storage";
                    }
                    objmodel.IsManufacture = masterrecord.IsManufacture.HasValue ? masterrecord.IsManufacture.Value : false;
                    objmodel.ManufactureDate = masterrecord.ManufactureDate;
                    objmodel.EquationType = masterrecord.EquationType;
                    objmodel.OtherValue = masterrecord.OtherValue;
                    objmodel.IsShipping = masterrecord.IsShipping;
                    objmodel.CreatedBY = masterrecord.CreatedBy;
                    objmodel.UpdatedBY = masterrecord.UpdatedBy;
                    objmodel.CTheroretical = masterrecord.CTheroretical;
                    objmodel.HTheroretical = masterrecord.HTheroretical;
                    objmodel.NTheroretical = masterrecord.NTheroretical;
                    objmodel.STheroretical = masterrecord.STheroretical;
                    objmodel.CPractical = masterrecord.CPractical;
                    objmodel.HPractical = masterrecord.HPractical;
                    objmodel.NPractical = masterrecord.NPractical;
                    objmodel.SPractical = masterrecord.SPractical;
                    objmodel.WegithLossBy = masterrecord.WegithLossBy;
                    objmodel.MeltingPoint = masterrecord.MeltingPoint;
                    objmodel.qNMR = masterrecord.qNMR;
                    objmodel.CNMRText = masterrecord.CNMRText;
                    childlist.Add(objmodel);
                    //}
                });
            }

            ViewBag.COAName = "Master";

            return Json(new
            {
                success = true,
                data = PartialViewdata(this, "_RightSideCOAInformation", list.Count > 0 ? list.FirstOrDefault() : new MasterCOAModel()),
                childHtml = PartialViewdata(this, "_PartialSearchChildCOA", childlist)
            }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public JsonResult ShowChildCOAInformation(int childCOAId)
        {
            var model = new MasterCOAModel();
            var masterrecord = db.SZ_ChildCOA.Where(x => x.Id == childCOAId).FirstOrDefault();
            if (masterrecord != null)
            {
                MasterCOAModel objmodel = new MasterCOAModel();
                string uri = Domain + "api/RestAPI/ProductDetails?productId=" + masterrecord.SZ_MasterCOA.ProductId;
                using (System.Net.Http.HttpClient httpClient = new System.Net.Http.HttpClient())
                {
                    Task<String> response = httpClient.GetStringAsync(uri);
                    string productModel = JsonConvert.DeserializeObject<string>(response.Result);
                    var productRecord = JsonConvert.DeserializeObject<ProductDetailsModel>(productModel);
                    if (productRecord != null)
                    {
                        objmodel.CASNO = productRecord.ManufacturerPartNumber;
                        objmodel.CATNO = productRecord.Sku;
                        objmodel.ProductName = productRecord.Name;
                        ViewBag.ImagePath = productRecord.DefaultPictureModel.FullSizeImageUrl;
                        ViewBag.CATNo = productRecord.Sku;
                        ViewBag.CASNo = productRecord.ManufacturerPartNumber;
                        ViewBag.MolFormula = productRecord.Gtin;
                        ViewBag.MolecularWeight = productRecord.MolecularWeight;
                        ViewBag.Synonym = productRecord.Synonym;
                        ViewBag.ChemicalName = productRecord.ChemicalName;
                    }
                }
                objmodel.ProductId = masterrecord.SZ_MasterCOA.ProductId.HasValue ? masterrecord.SZ_MasterCOA.ProductId.Value : 0;
                objmodel.Id = masterrecord.Id;
                objmodel.RefNo = masterrecord.RefNo;
                objmodel.COAId = masterrecord.MasterCOAID.HasValue ? masterrecord.MasterCOAID.Value : 0;
                objmodel.AnalysisDate = masterrecord.AnalysisDate;
                objmodel.BatchNo = masterrecord.BatchNo;
                objmodel.ProductName = masterrecord.ProductName;
                objmodel.CMR = masterrecord.CMR;
                objmodel.Dept = masterrecord.Dept;
                objmodel.HPLC = masterrecord.HPLC;
                objmodel.HPLCGCELSD = masterrecord.HPLCGCELSD;
                objmodel.IR = masterrecord.IR;
                objmodel.Mass = masterrecord.Mass;
                objmodel.NMR = masterrecord.NMR;
                objmodel.PhysicalState = masterrecord.PhysicalState;
                objmodel.Potency = masterrecord.Potency;
                objmodel.QuantityAvailable = masterrecord.QuantityAvailable;
                objmodel.Remark1 = masterrecord.Remark1;
                objmodel.Remark2 = masterrecord.Remark2;
                objmodel.ResidueOnIgnition = masterrecord.ResidueOnIgnition;
                objmodel.ReTestDate = masterrecord.ReTestDate;
                objmodel.SOLUBILITY = masterrecord.SOLUBILITY;
                objmodel.SpecialInstruction = masterrecord.SpecialInstruction;
                objmodel.StorageCon = masterrecord.StorageCon;
                objmodel.TGA = masterrecord.TGA;
                objmodel.TGALoss = masterrecord.TGALoss;
                objmodel.Purity = masterrecord.Purity;
                objmodel.Chemicalname = masterrecord.Chemicalname;
                ViewBag.MolFormula = masterrecord.MolFormula;
                ViewBag.MolecularWeight = masterrecord.MolecularWeight;
                ViewBag.Synonym = masterrecord.Synonym;
                ViewBag.ChemicalName = masterrecord.Chemicalname;
                objmodel.Attachment = masterrecord.Attachment;
                objmodel.AppearanceProduct = masterrecord.AppearanceProduct;
                objmodel.AdditionalInfor = masterrecord.AdditionalInfor;
                objmodel.BatchId = masterrecord.SZ_MasterCOA.BatchId;
                objmodel.IsLogoAttached = masterrecord.IsLogoAttached;
                if (string.IsNullOrEmpty(masterrecord.StorageCon))
                {
                    objmodel.StorageCon = "2-8 °C for long term storage";
                }
                if (!string.IsNullOrEmpty(masterrecord.ImagePath))
                {
                    ViewBag.ImagePath = masterrecord.ImagePath.Replace("~", "..");
                }
                objmodel.IsEquation = masterrecord.IsEquation.HasValue ? masterrecord.IsEquation.Value : false;
                objmodel.EquationType = masterrecord.EquationType;
                objmodel.OtherValue = masterrecord.OtherValue;
                objmodel.IsManufacture = masterrecord.IsManufacture.HasValue ? masterrecord.IsManufacture.Value : false;
                objmodel.ManufactureDate = masterrecord.ManufactureDate;
                objmodel.IsShipping = masterrecord.IsShipping;
                objmodel.CreatedBY = masterrecord.CreatedBy;
                objmodel.UpdatedBY = masterrecord.UpdatedBy;
                objmodel.CTheroretical = masterrecord.CTheroretical;
                objmodel.HTheroretical = masterrecord.HTheroretical;
                objmodel.NTheroretical = masterrecord.NTheroretical;
                objmodel.STheroretical = masterrecord.STheroretical;
                objmodel.CPractical = masterrecord.CPractical;
                objmodel.HPractical = masterrecord.HPractical;
                objmodel.NPractical = masterrecord.NPractical;
                objmodel.SPractical = masterrecord.SPractical;
                objmodel.WegithLossBy = masterrecord.WegithLossBy;
                objmodel.MeltingPoint = masterrecord.MeltingPoint;
                objmodel.qNMR = masterrecord.qNMR;
                model = objmodel;
            }

            ViewBag.COAName = "Child";
            return Json(new
            {
                success = true,
                childHtml = PartialViewdata(this, "_RightSideCOAInformation", model)
            }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public JsonResult ReloadChild(string value)
        {
            var data = (from i in db.Products
                            //join t2 in db.SZ_Inventory on i.Id equals t2.ProductId
                            //join t3 in db.SZ_MasterCOA on t2.Id equals t3.BatchId
                        where i.Sku.ToLower() == value.Trim().ToLower()
                        select i).FirstOrDefault();

            var masterCOAIds = new List<int>();

            if (data != null)
            {
                var batchlist = db.SZ_Inventory.Where(x => x.ProductId == data.Id).ToList();
                if (batchlist.Count > 0)
                {
                    foreach (var item in batchlist)
                    {
                        var masterrecord = db.SZ_MasterCOA.Where(x => x.BatchId == item.Id).FirstOrDefault();
                        if (masterrecord != null)
                        {
                            masterCOAIds.Add(masterrecord.Id);
                        }
                    }
                }
                var childlist = new List<MasterCOAModel>();
                if (masterCOAIds.Count > 0)
                {
                    var childrecords = db.SZ_ChildCOA.Where(x => masterCOAIds.Contains(x.MasterCOAID.Value)).ToList();
                    foreach (var masterrecord in childrecords)
                    {
                        MasterCOAModel objmodel = new MasterCOAModel();
                        objmodel.Id = masterrecord.Id;
                        masterCOAIds.Add(masterrecord.Id);
                        objmodel.AnalysisDate = masterrecord.AnalysisDate;
                        objmodel.BatchNo = masterrecord.BatchNo;
                        objmodel.ProductName = masterrecord.ProductName;
                        objmodel.CMR = masterrecord.CMR;
                        objmodel.Dept = masterrecord.Dept;
                        objmodel.HPLC = masterrecord.HPLC;
                        objmodel.HPLCGCELSD = masterrecord.HPLCGCELSD;
                        objmodel.IR = masterrecord.IR;
                        objmodel.Mass = masterrecord.Mass;
                        objmodel.NMR = masterrecord.NMR;
                        objmodel.PhysicalState = masterrecord.PhysicalState;
                        objmodel.Potency = masterrecord.Potency;
                        objmodel.QuantityAvailable = masterrecord.QuantityAvailable;
                        objmodel.Remark1 = masterrecord.Remark1;
                        objmodel.Remark2 = masterrecord.Remark2;
                        objmodel.ResidueOnIgnition = masterrecord.ResidueOnIgnition;
                        objmodel.ReTestDate = masterrecord.ReTestDate;
                        objmodel.SOLUBILITY = masterrecord.SOLUBILITY;
                        objmodel.SpecialInstruction = masterrecord.SpecialInstruction;
                        objmodel.StorageCon = masterrecord.StorageCon;
                        objmodel.TGA = masterrecord.TGA;
                        objmodel.TGALoss = masterrecord.TGALoss;
                        objmodel.EquationType = masterrecord.EquationType;
                        if (string.IsNullOrEmpty(masterrecord.StorageCon))
                        {
                            objmodel.StorageCon = "2-8 °C for long term storage";
                        }
                        childlist.Add(objmodel);
                    }
                }
                return Json(new
                {
                    success = true,
                    childHtml = PartialViewdata(this, "_PartialSearchChildCOA", childlist)
                }, JsonRequestBehavior.AllowGet);
            }
            return Json(new
            {
                success = false,
                message = "This catalog number is not available."
            }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult AddClientRemark(int id, bool isClientSection = false)
        {
            var data = _operationRepository.GetQuoteDetailByID(id);
            ViewBag.isClientSection = isClientSection;
            return View("_PartialAddClientRemark", data);
        }

        public ActionResult AddSampleReasonRequest(int id, string reason)
        {
            var data = db.SZ_SampleReason.ToList();
            ViewBag.SampleRequestDetailsId = id;
            ViewBag.reason = reason;
            var htmlstring = PartialViewdata(this, "_PartialSampleRequestReason", data);
            //return View("_PartialSampleRequestReason", data);

            return Json(new { html = htmlstring }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult GetSendEmailFromQuoteTemplate(int id)
        {
            ViewBag.QuoteId = id;
            var listItems = new List<SelectListItem>();
            listItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var terms = db.MissiveResponses.ToList();
            foreach (var term in terms)
            {
                listItems.Add(new SelectListItem
                {
                    Text = term.Name,
                    Value = term.Id.ToString()
                });
            }
            ViewBag.termsList = listItems;

            var htmlstring = PartialViewdata(this, "_PartialSendEmailFromQuoteTemplate", null);
            //return View("_PartialSampleRequestReason", data);

            return Json(new { html = htmlstring }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult AddInvoiceDocument(int id)
        {
            var listCompItems = new List<SelectListItem>();
            listCompItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var compData = db.SZ_CompanyList.OrderBy(x => x.Name.Trim()).ToList();
            foreach (var term in compData)
            {
                listCompItems.Add(new SelectListItem
                {
                    Text = term.Name,
                    Value = term.Id.ToString()
                });
            }
            ViewBag.CompanyList = listCompItems;

            var model = db.SZ_InvoiceDocument.Where(x => x.Id == id).FirstOrDefault();
            if (model == null)
            {
                model = new SZ_InvoiceDocument();
            }
            var htmlstring = PartialViewdata(this, "_PartialInvoiceDocument", model);
            return Json(new { html = htmlstring }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult showpopupInfo(int id, int quoteDetailsId)
        {
            string synthesis = Convert.ToString((int)Synzeal_Inventory.Models.EnumList.ProjectType.Synthesis);
            string pursynthesis = Convert.ToString((int)Synzeal_Inventory.Models.EnumList.ProjectType.PurSynthesis);
            string purchase = Convert.ToString((int)Synzeal_Inventory.Models.EnumList.ProjectType.Purchase);
            var quoteDetail = _operationRepository.GetQuoteDetailByID(quoteDetailsId);

            var quotePrice = db.Products.Where(x => x.Id == quoteDetail.ProductId).Select(x => x.QuotePrice).FirstOrDefault();
            var isAvailableProductDetails = new List<SZ_QuotationDetail>();
            if (!string.IsNullOrEmpty(quoteDetail.CATNo) && quoteDetail.CATNo != "na" && quoteDetail.CATNo != "NA" && quoteDetail.CATNo != "N/A")
            {
                isAvailableProductDetails = db.SZ_QuotationDetail.Where(x => x.ProductId == quoteDetail.ProductId && x.Id != quoteDetail.Id
                && x.MoveToProject == true && (x.MoveToDispatch == false || x.MoveToDispatch == null) && string.IsNullOrEmpty(x.TrackingNo)
                && (x.ProjectType == synthesis || x.ProjectType == pursynthesis || x.ProjectType == purchase)).ToList();
            }

            string htmlstring = PartialViewdata(this, "_PartialshowpopupInfo", isAvailableProductDetails);

            return Json(new
            {
                success = true,
                html = htmlstring
            }, JsonRequestBehavior.AllowGet);
        }


        public ActionResult AllQuotePrice(int id)
        {
            var product = db.Products.Where(x => x.Id == id && x.Published == true && x.Deleted == false).FirstOrDefault();

            string htmlstring = PartialViewdata(this, "_PartialQuotePrice", product);

            return Json(new
            {
                success = true,
                html = htmlstring
            }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult GetAllBatchNoByProductId(string catnumber)
        {
            var product = db.Products.Where(x => x.Sku == catnumber && x.Published == true && x.Deleted == false).FirstOrDefault();
            var InventoryData = db.SZ_Inventory.Where(x => x.ProductId == product.Id).ToList();
            var model = (from i in InventoryData
                         select new
                         {
                             Id = i.Id,
                             BatchCode = i.BatchNo,
                             Qty = i.AvailableQty
                         }).ToList();
            return Json(model, JsonRequestBehavior.AllowGet);
        }
        public ActionResult GetAllBatchNo(int id, string actiontxt, int quoteDetailsId = 0, bool visibleFormDownload = false)
        {
            ViewBag.visibleFormDownload = visibleFormDownload;
            var InventoryData = db.SZ_Inventory.Where(x => x.ProductId == id).ToList();
            var product = db.Products.Where(x => x.Id == id && x.Published == true && x.Deleted == false).FirstOrDefault();
            ViewBag.CatNo = product.Sku;
            ViewBag.action = actiontxt;
            ViewBag.QuoteDetailsId = quoteDetailsId;

            ViewBag.FormList = (from t1 in db.SZ_QuoteDetails_Form
                                join t2 in db.SZ_QuoteDetailForm on t1.FormId equals t2.Id
                                where t1.QuoteDetailsId == quoteDetailsId
                                select t2).ToList();

            string htmlstring = PartialViewdata(this, "_PartialBatchNoForretest", InventoryData);

            return Json(new
            {
                success = true,
                html = htmlstring
            }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult GetQueryDataFromCatNo(string catNo, string pagename = "")
        {
            ViewBag.CatNo = catNo;
            ViewBag.pagename = pagename;
            var InventoryData = db.SZ_QueryModule.Where(x => x.CATNo == catNo).ToList();
            string htmlstring = PartialViewdata(this, "_PartialQueryDataByCatNo", InventoryData);

            return Json(new
            {
                success = true,
                html = htmlstring
            }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult GetQuotationAuditLog(int id, string propertyName)
        {
            var model = db.SystemLogs.Where(x => x.EntityId == id && x.Entityname == "Quote").AsQueryable();
            if (!string.IsNullOrEmpty(propertyName))
            {
                model = model.Where(x => x.PropertyName == propertyName).AsQueryable();
            }
            string htmlstring = PartialViewdata(this, "_PartialSystemLog", model.OrderByDescending(x => x.CreatedDate).ToList());
            return Json(new
            {
                success = true,
                html = htmlstring
            }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult GetCOAAuditLog(int id, string status)
        {
            if (status == "master")
            {
                status = "Mastercoa";
            }
            if (status == "child")
            {
                status = "Childcoa";
            }

            var model = db.SystemLogs.Where(x => x.EntityId == id && x.Entityname == status).OrderByDescending(x => x.CreatedDate).ToList();
            string htmlstring = PartialViewdata(this, "_PartialSystemLog", model);
            return Json(new
            {
                success = true,
                html = htmlstring
            }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult GetAuditLogForQuoteDetail(int id)
        {
            var model = db.SZ_QuotationDetailLog.Where(x => x.QuoteDetailsId == id).OrderByDescending(x => x.Datetime).ToList();
            string htmlstring = PartialViewdata(this, "_PartialQuoteDetailAuditLog", model);

            return Json(new
            {
                success = true,
                html = htmlstring
            }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult GetAuditLogForQuote(int id)
        {
            var model = db.SystemLogs.Where(x => x.EntityId == id
                    && x.Entityname == "Quote"
                    && x.PropertyName != "SZ_CompanyList"
                    && x.PropertyName != "IsCOA"
                    && x.PropertyName != "IsFollowupRequired"
                    && x.PropertyName != "IsInstock"
                    && x.PropertyName != "IsCustomSynthesis"
                    && x.PropertyName != "IsPreviewed"
                    && x.PropertyName != "IsReviewed"
                    && x.PropertyName != "IsWorking"
                    && x.PropertyName != "IsStudy"
                    && x.PropertyName != "IsAnalyticalData"
                    && x.PropertyName != "IsRegret"
                    && x.PropertyName != "IsCompleted"
                    && x.PropertyName != "IsShowDashboard"
                    && x.PropertyName != "IsShippedCharge"
                    && x.PropertyName != "WorkingDate").OrderByDescending(x => x.CreatedDate).ToList();

            string htmlstring = PartialViewdata(this, "_PartialQuoteAuditLog", model);

            return Json(new
            {
                success = true,
                html = htmlstring
            }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult GetAuditLogForProject(int id)
        {
            var model = db.SZ_QuotationDetailLog.Where(x => x.QuoteDetailsId == id
                    && x.PropertyName != "SZ_CompanyList"
                    && x.PropertyName != "IsCOA"
                    && x.PropertyName != "IsFollowupRequired"
                    && x.PropertyName != "IsInstock"
                    && x.PropertyName != "IsCustomSynthesis"
                    && x.PropertyName != "IsPreviewed"
                    && x.PropertyName != "IsReviewed"
                    && x.PropertyName != "IsWorking"
                    && x.PropertyName != "IsStudy"
                    && x.PropertyName != "IsAnalyticalData"
                    && x.PropertyName != "IsRegret"
                    && x.PropertyName != "IsCompleted"
                    && x.PropertyName != "IsShowDashboard"
                    && x.PropertyName != "IsShippedCharge"
                    && x.PropertyName != "WorkingDate"
                    && x.PropertyName != "Price"
                    && x.PropertyName != "Remark").OrderByDescending(x => x.Datetime).ToList();

            string htmlstring = PartialViewdata(this, "_PartialQuoteDetailAuditLog", model);

            return Json(new
            {
                success = true,
                html = htmlstring
            }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult GetAuditLogForDispatch(int id)
        {
            var model = db.SZ_QuotationDetailLog.Where(x => x.QuoteDetailsId == id
                    && x.PropertyName != "SZ_CompanyList"
                    && x.PropertyName != "IsCOA"
                    && x.PropertyName != "IsFollowupRequired"
                    && x.PropertyName != "IsInstock"
                    && x.PropertyName != "IsCustomSynthesis"
                    && x.PropertyName != "IsPreviewed"
                    && x.PropertyName != "IsReviewed"
                    && x.PropertyName != "IsWorking"
                    && x.PropertyName != "IsStudy"
                    && x.PropertyName != "IsAnalyticalData"
                    && x.PropertyName != "IsRegret"
                    && x.PropertyName != "IsCompleted"
                    && x.PropertyName != "IsShowDashboard"
                    && x.PropertyName != "IsShippedCharge"
                    && x.PropertyName != "WorkingDate"
                    && x.PropertyName != "Price"
                    && x.PropertyName != "Remark").OrderByDescending(x => x.Datetime).ToList();

            string htmlstring = PartialViewdata(this, "_PartialQuoteDetailAuditLog", model);

            return Json(new
            {
                success = true,
                html = htmlstring
            }, JsonRequestBehavior.AllowGet);
        }


        public ActionResult chatDetails(int id)
        {
            var data = db.SZ_Clientremark.Where(x => x.QuoteDetailsId == id).ToList();
            string htmlstring = PartialViewdata(this, "_PartialChatDetails", data);

            return Json(new
            {
                success = true,
                html = htmlstring
            }, JsonRequestBehavior.AllowGet);
        }
        public ActionResult Addexplaination(int id)
        {
            var data = _operationRepository.GetQuoteDetailByID(id);
            string htmlstring = PartialViewdata(this, "_PartialExplaination", data);

            return Json(new
            {
                success = true,
                html = htmlstring
            }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult AddGLPRemark(int id)
        {
            var data = _operationRepository.GetQuoteDetailByID(id);
            string htmlstring = PartialViewdata(this, "_PartialGLPRemark", data);

            return Json(new
            {
                success = true,
                html = htmlstring
            }, JsonRequestBehavior.AllowGet);
        }
        public ActionResult AddInhouseRemark(int id)
        {
            var data = _operationRepository.GetQuoteDetailByID(id);
            string htmlstring = PartialViewdata(this, "_PartialInhouseRemark", data);

            return Json(new
            {
                success = true,
                html = htmlstring
            }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult AddJourneyComment(int id)
        {
            var data = _operationRepository.GetQuoteDetailByID(id);
            string htmlstring = PartialViewdata(this, "_PartialJourneyComment", data);

            return Json(new
            {
                success = true,
                html = htmlstring
            }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult AddPurchaseSummary(int id, string pagename)
        {
            ViewBag.PageName = pagename;
            var data = _operationRepository.GetQuoteDetailByID(id);
            string htmlstring = PartialViewdata(this, "_PartialPurchaseSummary", data);

            return Json(new
            {
                success = true,
                html = htmlstring
            }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult AddPurchaseRemark(int id)
        {
            var data = _operationRepository.GetQuoteDetailByID(id);
            string htmlstring = PartialViewdata(this, "_PartialPurchaseRemark", data);

            return Json(new
            {
                success = true,
                html = htmlstring
            }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult AddPurchaseManagementRemark(int id)
        {
            var data = _operationRepository.GetQuoteDetailByID(id);
            string htmlstring = PartialViewdata(this, "_PartialPurchaseManagementRemark", data);

            return Json(new
            {
                success = true,
                html = htmlstring
            }, JsonRequestBehavior.AllowGet);
        }


        public ActionResult AddCOARemark(int id, string page)
        {
            ViewBag.Id = id;
            ViewBag.Page = page;

            if (page == "product")
            {
                ViewBag.COARemark = db.Products.Where(x => x.Id == id).Select(x => x.COARemark).FirstOrDefault();
            }
            if (page == "mastercoa")
            {
                ViewBag.COARemark = db.SZ_MasterCOA.Where(x => x.Id == id).Select(x => x.COARemark).FirstOrDefault();
            }
            if (page == "childcoa")
            {
                ViewBag.COARemark = db.SZ_ChildCOA.Where(x => x.Id == id).Select(x => x.COARemark).FirstOrDefault();
            }

            string htmlstring = PartialViewdata(this, "_PartialCOARemark", null);

            return Json(new
            {
                success = true,
                html = htmlstring
            }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult AddApprovComment(int id, bool isScientist = false)
        {
            ViewBag.isScientist = isScientist;
            var data = _operationRepository.GetQuoteDetailByID(id);
            ViewBag.QuoteDetailsComment = db.SZ_QuoteDetailsComment.Where(x => x.QuotationDetailsId == id).OrderBy(x => x.CreatedDate).ToList();
            var formid = db.SZ_QuoteDetails_Form.Where(x => x.QuoteDetailsId == id).Select(x => x.FormId).FirstOrDefault();
            var quoteform = db.SZ_QuoteDetailForm.Where(x => x.Id == formid).OrderByDescending(x => x.Id).FirstOrDefault();
            if (quoteform != null)
            {
                ViewBag.FormRemark = quoteform.OtherAnalysis;
            }


            string htmlstring = PartialViewdata(this, "_PartialApprovedComment", data);

            return Json(new
            {
                success = true,
                html = htmlstring
            }, JsonRequestBehavior.AllowGet);
        }
        public ActionResult ChangeAvailableData(int id)
        {
            var data = db.SZ_QuoteDetailForm.Where(x => x.Id == id).FirstOrDefault();
            string htmlstring = PartialViewdata(this, "_PartialAvailableChangeData", data);

            return Json(new
            {
                success = true,
                html = htmlstring
            }, JsonRequestBehavior.AllowGet);
        }
        public ActionResult AddNewRfq()
        {
            string htmlstring = PartialViewdata(this, "_PartialAddNewRfq", new SZ_PurchaseRFQ());

            return Json(new
            {
                success = true,
                html = htmlstring
            }, JsonRequestBehavior.AllowGet);
        }


        public ActionResult ShowReactionMatrix(int quotedetailsid)
        {
            var model = db.SZ_ReactionMatrix.Where(x => x.QuoteDetailId == quotedetailsid).ToList();

            string htmlstring = PartialViewdata(this, "_PartialShowReactionMatrix", model);

            return Json(new
            {
                success = true,
                html = htmlstring
            }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult OpenBatchNoFromCat(int quotedetailsid)
        {
            ViewBag.QuoteDetailsId = quotedetailsid;
            var catno = _operationRepository.GetQuoteDetailByID(quotedetailsid).CATNo;
            catno = catno.Trim().ToLower();
            var forminventorydata = db.SZ_QuoteDetailForm.Where(x => x.CATNo.Trim().ToLower() == catno).OrderByDescending(x => x.Id).ToList();
            string htmlstring = PartialViewdata(this, "_PartialBachnoList", forminventorydata);

            return Json(new
            {
                success = true,
                html = htmlstring
            }, JsonRequestBehavior.AllowGet);
        }
        public ActionResult AddFollowpDescription(int id)
        {
            var data = _operationRepository.GetQuoteDetailByID(id);
            string htmlstring = PartialViewdata(this, "_PartialFollowpDescription", data);

            return Json(new
            {
                success = true,
                html = htmlstring
            }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult AddQuery(string ids, string sectionName)
        {
            ViewBag.ids = ids;
            int id = Convert.ToInt32(ids.Split(',')[0]);

            var data = _operationRepository.GetQuoteDetailByID(id);
            ViewBag.sectionName = sectionName;

            MemoryCacheManager objCache = new MemoryCacheManager();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });

            var scienList = objCache.Get("cache.GetScientistId", () =>
            {
                return db.GetScientistId().ToList();
            });

            var listItems = new List<SelectListItem>();

            scienList.ForEach(term =>
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                listItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.ToString()
                });
            });

            ViewBag.ScientistList = listItems;

            if ("project" == sectionName)
            {
                data.IsAssignProjectQuery = false;
            }
            else
            {
                data.IsAssignScientistQuery = false;
            }
            db.Entry(data).State = EntityState.Modified;
            db.SaveChanges();

            string htmlstring = PartialViewdata(this, "_PartialQuery", data);

            return Json(new
            {
                success = true,
                html = htmlstring
            }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult GetAllCategoryPricePopup(string mg = null, string value = null, string type = null)
        {
            ViewBag.mg = mg != "undefined" ? mg : null;
            ViewBag.value = value != "undefined" ? value : null;
            ViewBag.type = type != "undefined" ? type : null;
            var model = db.SZ_CategoryMaster.OrderBy(x => x.Name).ToList();
            string htmlstring = PartialViewdata(this, "_PartialCategoryPriceMaster", model);

            return Json(new
            {
                success = true,
                html = htmlstring
            }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public JsonResult AddQuotePriceData(string QuotePrice, int Id)
        {
            var data = db.Products.Where(x => x.Id == Id).FirstOrDefault();
            if (data != null)
            {
                data.QuotePrice = QuotePrice;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }

            return Json(true, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public JsonResult AddApprovedCommentData(string CommentText, int Id, bool isSCientist = false)
        {
            string correctionstatus = Convert.ToString((int)EnumList.ApprovedStatus.QCCorrection);

            var data = _operationRepository.GetQuoteDetailByID(Id);
            if (data != null)
            {
                SZ_QuoteDetailsComment objcomment = new SZ_QuoteDetailsComment();
                objcomment.QuotationDetailsId = data.Id;
                objcomment.ApprovedComment = CommentText.Replace("\n", "<br>");
                objcomment.CreatedDate = DateTime.Now;
                objcomment.GeneratedUserid = SessionCookieManagement.UserId;
                objcomment.GeneratedUserName = SessionCookieManagement.UserName;
                if (isSCientist)
                {
                    objcomment.IsQcView = false;
                    objcomment.IsScientistView = true;
                }
                else
                {
                    objcomment.IsQcView = true;
                    objcomment.IsScientistView = false;
                }
                db.SZ_QuoteDetailsComment.Add(objcomment);

                var invData = db.SZ_Inventory.Where(x => x.Id == data.AdditionalBatchNo).FirstOrDefault();
                if (invData != null)
                {
                    invData.QCRemark = CommentText.Replace("\n", "<br>");
                    db.Entry(invData).State = EntityState.Modified;
                }

                db.SaveChanges();

                if (data.ApprovalStatus == correctionstatus && !isSCientist)
                {
                    var customeremail = db.Customers.Where(x => x.Id == data.ScientistCustomerId).Select(x => x.Email).FirstOrDefault();

                    //Email send to QC team
                    MailMessage mail = new MailMessage();
                    ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12 |
                                       SecurityProtocolType.Tls11 |
                                       SecurityProtocolType.Tls |
                                       SecurityProtocolType.Ssl3;
                    SmtpClient SmtpServer = new SmtpClient(ConfigurationManager.AppSettings["Email.Host"]);
                    mail.From = new MailAddress(ConfigurationManager.AppSettings["Email.SynthesisUsername"], "SynZeal Standards");

                    var isDevelopment = ConfigurationManager.AppSettings["IsDevelopment"];
                    if (isDevelopment.ToLower().Contains("true"))
                    {
                        mail.To.Add(ConfigurationManager.AppSettings["DevEmailAddress"].ToString());
                    }
                    else
                    {
                        mail.To.Add(customeremail);
                        mail.CC.Add("standards@synzeal.com");
                    }
                    var formid = db.SZ_QuoteDetails_Form.Where(x => x.QuoteDetailsId == Id).Select(x => x.FormId).FirstOrDefault();
                    var qdsubmitform = db.SZ_QuoteDetailForm.Where(x => x.Id == formid).FirstOrDefault();
                    if (qdsubmitform != null)
                    {
                        if (!string.IsNullOrEmpty(qdsubmitform.SpectralDataAttachment))
                        {
                            mail.Attachments.Add(new Attachment(Server.MapPath("~/" + qdsubmitform.SpectralDataAttachment.Replace("..", ""))));
                        }
                    }

                    mail.Subject = "QC added comment for correction / CAT NO: " + data.CATNo;
                    mail.IsBodyHtml = true;
                    SmtpServer.Port = Convert.ToInt32(ConfigurationManager.AppSettings["Port"]);
                    SmtpServer.Credentials = new System.Net.NetworkCredential(ConfigurationManager.AppSettings["Email.SynthesisUsername"], ConfigurationManager.AppSettings["Email.SynthesisPassword"]);
                    mail.Body = "Dear Scientist, <br> Following product is submitted for correction. Kindly check and let us know the update. <br><br><br>";
                    //mail.Body += bodyStr;
                    mail.Body += "Comments:" + CommentText;
                    mail.Body += "<br><br>Let me know if you have any comments/suggestions.<br><br> <br>Kind  Regards,<br> QC Team <br> SynZeal Research PVT. LTD";
                    SmtpServer.EnableSsl = true;
                    SmtpServer.Send(mail);
                }

                if (data.ApprovalStatus == correctionstatus && isSCientist)
                {
                    var customeremail = db.Customers.Where(x => x.Id == data.ScientistCustomerId).Select(x => x.Email).FirstOrDefault();

                    //Email send to QC team
                    MailMessage mail = new MailMessage();
                    ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12 |
                                       SecurityProtocolType.Tls11 |
                                       SecurityProtocolType.Tls |
                                       SecurityProtocolType.Ssl3;
                    SmtpClient SmtpServer = new SmtpClient(ConfigurationManager.AppSettings["Email.Host"]);
                    mail.From = new MailAddress(ConfigurationManager.AppSettings["Email.SynthesisUsername"], "SynZeal Standards");

                    var isDevelopment = ConfigurationManager.AppSettings["IsDevelopment"];
                    if (isDevelopment.ToLower().Contains("true"))
                    {
                        mail.To.Add(ConfigurationManager.AppSettings["DevEmailAddress"].ToString());
                    }
                    else
                    {
                        mail.To.Add("qc@synzeal.com");
                        mail.CC.Add("standards@synzeal.com");
                    }

                    mail.Subject = "Scientist added comment for correction / CAT NO: " + data.CATNo;

                    mail.IsBodyHtml = true;
                    SmtpServer.Port = Convert.ToInt32(ConfigurationManager.AppSettings["Port"]);
                    SmtpServer.Credentials = new System.Net.NetworkCredential(ConfigurationManager.AppSettings["Email.SynthesisUsername"], ConfigurationManager.AppSettings["Email.SynthesisPassword"]);
                    mail.Body = "Dear QC Team, <br> Following product is submitted for correction. Kindly check and let us know the update. <br><br><br>";

                    //mail.Body += bodyStr;
                    mail.Body += "Comments:" + CommentText;

                    mail.Body += "<br><br>Let me know if you have any comments/suggestions.<br><br> <br>Kind  Regards,<br> QC Team <br> SynZeal Research PVT. LTD";
                    SmtpServer.EnableSsl = true;
                    SmtpServer.Send(mail);
                }
            }
            return Json(new
            {
                success = true
            }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public JsonResult AddExplainationData(string ExplanationText, int Id)
        {
            var data = _operationRepository.GetQuoteDetailByID(Id);
            if (data != null)
            {
                data.Explanation = ExplanationText;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json(new
            {
                success = true
            }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public JsonResult AddGLPRemarkData(string GLPRemark, int Id)
        {
            var data = _operationRepository.GetQuoteDetailByID(Id);
            if (data != null)
            {
                data.GLPRemark = GLPRemark;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json(new
            {
                success = true
            }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public JsonResult AddCOARemarkData(string COARemarkText, int Id, string Page)
        {
            if (Page == "product")
            {
                var data = db.Products.Where(x => x.Id == Id).FirstOrDefault();
                if (data != null)
                {
                    data.COARemark = COARemarkText;
                    db.Entry(data).State = EntityState.Modified;
                    db.SaveChanges();
                }
            }
            if (Page == "mastercoa")
            {
                var data = db.SZ_MasterCOA.Where(x => x.Id == Id).FirstOrDefault();
                if (data != null)
                {
                    data.COARemark = COARemarkText;
                    db.Entry(data).State = EntityState.Modified;
                    db.SaveChanges();
                }
            }
            if (Page == "childcoa")
            {
                var data = db.SZ_ChildCOA.Where(x => x.Id == Id).FirstOrDefault();
                if (data != null)
                {
                    data.COARemark = COARemarkText;
                    db.Entry(data).State = EntityState.Modified;
                    db.SaveChanges();
                }
            }
            return Json(new
            {
                success = true
            }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public JsonResult AddInhouseRemarkData(string InhouseRemarkText, int Id)
        {
            var data = _operationRepository.GetQuoteDetailByID(Id);
            if (data != null)
            {
                data.InhouseRemark = InhouseRemarkText;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json(new
            {
                success = true
            }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public JsonResult JourneyCommentData(string JourneyCommentText, int Id)
        {
            var data = _operationRepository.GetQuoteDetailByID(Id);
            if (data != null)
            {
                data.JourneyComment = JourneyCommentText;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json(new
            {
                success = true
            }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public JsonResult PurchaseSummaryData(string SummaryText, int Id)
        {
            var data = _operationRepository.GetQuoteDetailByID(Id);
            if (data != null)
            {
                data.PurchaseStatus = SummaryText;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json(new
            {
                success = true
            }, JsonRequestBehavior.AllowGet);
        }


        [HttpPost]
        public JsonResult PurchaseRemarkData(string RemarkText, int Id)
        {
            var data = _operationRepository.GetQuoteDetailByID(Id);
            if (data != null)
            {
                data.PurchaseRemark = RemarkText;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json(new
            {
                success = true
            }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public JsonResult PurchaseManagementRemarkData(string ManagementRemarkText, int Id)
        {
            var data = _operationRepository.GetQuoteDetailByID(Id);
            if (data != null)
            {
                data.PurMangRemark = ManagementRemarkText;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json(new
            {
                success = true
            }, JsonRequestBehavior.AllowGet);
        }

        public JsonResult GetDefaultDataForRules()
        {
            MemoryCacheManager objCache = new MemoryCacheManager();
            var productsData = objCache.Get("cache.productsdata", () =>
            {
                return db.Products.Where(x => x.Published == true && x.Deleted == false).ToList();
            });
            var compList = objCache.Get("cache.CompanyNamefromQuotationtab", () =>
            {
                return db.SZ_Quotation.AsNoTracking().Select(x => x.CompanyName).Distinct().OrderBy(x => x).ToList();
            });
            var inventoryData = objCache.Get("cache.inventoryData", () =>
            {
                return db.SZ_Inventory.ToList();
            });
            var poData = objCache.Get("cache.poData", () =>
            {
                return db.SZ_Quotation.Where(x => !string.IsNullOrEmpty(x.PONo)).Select(x => x.PONo).Distinct().OrderBy(x => x).ToList();
            });
            return Json(new
            {
                success = true,
                catnolist = productsData.Select(x => x.Sku).Distinct().ToList(),
                compList = compList,
                batchList = inventoryData.Select(x => x.BatchNo).Distinct().OrderBy(x => x).ToList(),
                poList = poData
            }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public JsonResult SaveRuleData(RuleModel model)
        {
            var data = db.SZ_Rule.Where(x => x.Id == model.id).FirstOrDefault();
            if (data == null)
            {
                //Insert Data
                var rule = new SZ_Rule();
                rule.Name = model.ruleName;
                rule.CreatedDate = DateTime.Now;
                rule.CreatedBy = SessionCookieManagement.UserName;
                rule.UpdatedDate = DateTime.Now;
                rule.UpdatedBy = SessionCookieManagement.UserName;
                db.SZ_Rule.Add(rule);
                db.SaveChanges();

                foreach (var item in model.rules)
                {
                    var rules = new SZ_RuleDetail();
                    rules.RuleId = rule.Id;
                    rules.Condition = model.condition;
                    rules.Tag = model.ruletag;
                    rules.Type = item.typedata;
                    rules.Query = item.query;
                    rules.Value = item.value;
                    db.SZ_RuleDetail.Add(rules);
                }
                db.SaveChanges();
            }
            else
            {
                //Update
                data.Name = model.ruleName;
                data.UpdatedDate = DateTime.Now;
                data.UpdatedBy = SessionCookieManagement.UserName;
                db.Entry(data).State = EntityState.Modified;

                if (model.rules != null && model.rules.Count > 0)
                {
                    var rulesids = model.rules.Select(x => x.ruledetailid).ToList();
                    var notInRule = data.SZ_RuleDetail.Where(x => !rulesids.Contains(x.Id)).ToList();
                    foreach (var item in notInRule)
                    {
                        db.Entry(item).State = EntityState.Deleted;
                    }
                    foreach (var item in model.rules)
                    {
                        if (item.ruledetailid == 0)
                        {
                            var rules = new SZ_RuleDetail();
                            rules.RuleId = data.Id;
                            rules.Condition = model.condition;
                            rules.Tag = model.ruletag;
                            rules.Type = item.typedata;
                            rules.Query = item.query;
                            rules.Value = item.value;
                            db.SZ_RuleDetail.Add(rules);
                        }
                        else
                        {
                            var rules = db.SZ_RuleDetail.Where(x => x.Id == item.ruledetailid).FirstOrDefault();
                            if (rules != null)
                            {
                                rules.Condition = model.condition;
                                rules.Tag = model.ruletag;
                                rules.Type = item.typedata;
                                rules.Query = item.query;
                                rules.Value = item.value;
                                db.Entry(rules).State = EntityState.Modified;
                            }
                        }
                    }
                }
                db.SaveChanges();
            }



            MemoryCacheManager objCache = new MemoryCacheManager();
            objCache.Remove("cache.tagsData");
            var tagsData = objCache.Get("cache.tagsData", () =>
            {
                return db.SZ_RuleDetail.ToList();
            });
            return Json(new
            {
                success = true
            }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public JsonResult Commonremovefollowup(List<int> ids)
        {
            foreach (var id in ids)
            {
                var quotedetailId = _operationRepository.GetQuoteDetailByID(id);
                var data = _operationRepository.GetQuoteByID(quotedetailId.QuoteId);
                if (data != null)
                {
                    data.FollowupReason = "Followup Not Required";
                    data.IsRemoveFollowup = true;
                    data.FollowupStatus = "Followup Not Required";
                    db.Entry(data).State = EntityState.Modified;
                    db.SaveChanges();
                }
            }

            return Json(new
            {
                success = true
            }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public JsonResult CommonFreezeQuote(List<int> ids)
        {
            foreach (var id in ids)
            {
                var quotedetailId = _operationRepository.GetQuoteDetailByID(id);
                var data = _operationRepository.GetQuoteByID(quotedetailId.QuoteId);
                if (data != null)
                {
                    if (data.FreezeQuote.HasValue && data.FreezeQuote == true)
                    {
                        data.FreezeQuote = false;
                        data.FollowupStatus = "";
                    }
                    else
                    {
                        data.FreezeQuote = true;
                        data.FollowupStatus = "Freeze";
                    }
                    db.Entry(data).State = EntityState.Modified;
                    db.SaveChanges();
                }
            }
            return Json(new
            {
                success = true
            }, JsonRequestBehavior.AllowGet);
        }



        [HttpPost]
        public JsonResult RemoveFollowup(int id, string followupReason)
        {
            var data = _operationRepository.GetQuoteByID(id);
            if (data != null)
            {
                data.FollowupReason = followupReason;
                data.IsRemoveFollowup = true;
                data.FollowupStatus = "Followup Not Required";
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json(new
            {
                success = true
            }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public JsonResult FreezeQuote(int id)
        {
            var data = _operationRepository.GetQuoteByID(id);
            if (data != null)
            {
                if (data.FreezeQuote.HasValue && data.FreezeQuote == true)
                {
                    data.FreezeQuote = false;
                    data.FollowupStatus = "";
                }
                else
                {
                    data.FreezeQuote = true;
                    data.FollowupStatus = "Freeze";
                }

                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json(new
            {
                success = true
            }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public JsonResult UpdateFollowupAdminRemark(int id, string followupadminremark)
        {
            var data = _operationRepository.GetQuoteByID(id);
            if (data != null)
            {
                data.FollowupAdminRemark = followupadminremark;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json(new
            {
                success = true
            }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public JsonResult CommonUpdateFollowupStatus(List<int> ids, string followupStatus)
        {
            foreach (var id in ids)
            {
                var quotedetailId = _operationRepository.GetQuoteDetailByID(id);
                var data = _operationRepository.GetQuoteByID(quotedetailId.QuoteId);
                if (data != null)
                {
                    if (followupStatus == "To be Followup")
                    {
                        if (data.IsFollowupInterested.HasValue && data.IsFollowupInterested.Value)
                        {
                            //data.FreezeQuote = true;
                            data.IsFollowupInterested = false;
                        }
                        else
                        {
                            //data.FreezeQuote = false;
                            data.IsFollowupInterested = true;
                        }
                    }
                    if (followupStatus == "Mail Sent")
                    {
                        if (data.IsFollowupMail.HasValue && data.IsFollowupMail.Value)
                        {
                            data.IsFollowupMail = false;
                        }
                        else
                        {
                            data.IsFollowupMail = true;
                        }
                    }
                    if (followupStatus == "Call")
                    {
                        if (data.IsFollowupCall.HasValue && data.IsFollowupCall.Value)
                        {
                            data.IsFollowupCall = false;
                        }
                        else
                        {
                            data.IsFollowupCall = true;
                        }
                    }
                    if (followupStatus == "Won")
                    {
                        if (data.IsFollowupWon.HasValue && data.IsFollowupWon.Value)
                        {
                            data.IsFollowupWon = false;
                        }
                        else
                        {
                            data.IsFollowupWon = true;
                        }
                    }
                    if (followupStatus == "Lost")
                    {
                        if (data.IsFollowupLost.HasValue && data.IsFollowupLost.Value)
                        {
                            data.IsFollowupLost = false;
                        }
                        else
                        {
                            data.IsFollowupLost = true;
                        }
                    }
                    if (followupStatus == "Meeting")
                    {
                        if (data.IsFollowupMeeting.HasValue && data.IsFollowupMeeting.Value)
                        {
                            data.IsFollowupMeeting = false;
                        }
                        else
                        {
                            data.IsFollowupMeeting = true;
                        }
                    }
                    if (followupStatus == "Less Value")
                    {
                        if (data.IsFollowupLessValue.HasValue && data.IsFollowupLessValue.Value)
                        {
                            data.IsFollowupLessValue = false;
                            data.FollowupReason = "Followup Not Required";
                        }
                        else
                        {
                            data.IsFollowupLessValue = true;
                            data.FollowupReason = "Followup Not Required";
                            data.IsRemoveFollowup = true;
                            data.FollowupStatus = "Followup Not Required";
                        }
                    }
                    if (followupStatus == "Negotiation")
                    {
                        if (data.IsFollowupNegotiation.HasValue && data.IsFollowupNegotiation.Value)
                        {
                            data.IsFollowupNegotiation = false;
                            data.FollowupReason = "Negotiation";
                        }
                        else
                        {
                            data.IsFollowupNegotiation = true;
                            data.FollowupReason = "";
                        }
                    }

                    if (followupStatus == "Important")
                    {
                        if (data.IsFollowupImportant.HasValue && data.IsFollowupImportant.Value)
                        {
                            data.IsFollowupImportant = false;
                        }
                        else
                        {
                            data.IsFollowupImportant = true;
                        }
                    }

                    data.FollowupStatus = followupStatus;
                    db.Entry(data).State = EntityState.Modified;
                    db.SaveChanges();
                }
            }


            return Json(new
            {
                success = true
            }, JsonRequestBehavior.AllowGet);
        }



        [HttpPost]
        public JsonResult UpdateFollowupStatus(int id, string followupStatus)
        {
            var data = _operationRepository.GetQuoteByID(id);
            if (data != null)
            {
                if (followupStatus == "To be Followup")
                {
                    if (data.IsFollowupInterested.HasValue && data.IsFollowupInterested.Value)
                    {
                        data.FreezeQuote = true;
                        data.IsFollowupInterested = false;
                    }
                    else
                    {
                        data.FreezeQuote = false;
                        data.IsFollowupInterested = true;
                    }
                }
                if (followupStatus == "Mail Sent")
                {
                    if (data.IsFollowupMail.HasValue && data.IsFollowupMail.Value)
                    {
                        data.IsFollowupMail = false;
                    }
                    else
                    {
                        data.IsFollowupMail = true;
                    }
                }
                if (followupStatus == "Call")
                {
                    if (data.IsFollowupCall.HasValue && data.IsFollowupCall.Value)
                    {
                        data.IsFollowupCall = false;
                    }
                    else
                    {
                        data.IsFollowupCall = true;
                    }
                }
                if (followupStatus == "Won")
                {
                    if (data.IsFollowupWon.HasValue && data.IsFollowupWon.Value)
                    {
                        data.IsFollowupWon = false;
                    }
                    else
                    {
                        data.IsFollowupWon = true;
                    }
                }
                if (followupStatus == "Lost")
                {
                    if (data.IsFollowupLost.HasValue && data.IsFollowupLost.Value)
                    {
                        data.IsFollowupLost = false;
                    }
                    else
                    {
                        data.IsFollowupLost = true;
                    }
                }
                if (followupStatus == "Meeting")
                {
                    if (data.IsFollowupMeeting.HasValue && data.IsFollowupMeeting.Value)
                    {
                        data.IsFollowupMeeting = false;
                    }
                    else
                    {
                        data.IsFollowupMeeting = true;
                    }
                }
                if (followupStatus == "Less Value")
                {
                    if (data.IsFollowupLessValue.HasValue && data.IsFollowupLessValue.Value)
                    {
                        data.IsFollowupLessValue = false;
                        data.FollowupReason = "Followup Not Required";
                    }
                    else
                    {
                        data.IsFollowupLessValue = true;
                        data.FollowupReason = "Followup Not Required";
                        data.IsRemoveFollowup = true;
                        data.FollowupStatus = "Followup Not Required";
                    }
                }
                if (followupStatus == "Negotiation")
                {
                    if (data.IsFollowupNegotiation.HasValue && data.IsFollowupNegotiation.Value)
                    {
                        data.IsFollowupNegotiation = false;
                        data.FollowupReason = "Negotiation";
                    }
                    else
                    {
                        data.IsFollowupNegotiation = true;
                        data.FollowupReason = "";
                    }
                }

                if (followupStatus == "Important")
                {
                    if (data.IsFollowupImportant.HasValue && data.IsFollowupImportant.Value)
                    {
                        data.IsFollowupImportant = false;
                    }
                    else
                    {
                        data.IsFollowupImportant = true;
                    }
                }

                data.FollowupStatus = followupStatus;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json(new
            {
                success = true
            }, JsonRequestBehavior.AllowGet);
        }
        [HttpPost]
        public JsonResult UpdateFollowupReason(int id, string followupReason)
        {
            var data = _operationRepository.GetQuoteByID(id);
            if (data != null)
            {
                data.FollowupReason = followupReason;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json(new
            {
                success = true
            }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public JsonResult AddFollowupDescriptionData(string FollowupDescription, int Id)
        {
            var data = _operationRepository.GetQuoteDetailByID(Id);
            if (data != null)
            {
                if (data.FollowupDescription != FollowupDescription)
                {
                    data.IsFollowupChange = true;
                }
                data.FollowupDescription = FollowupDescription;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json(new
            {
                success = true
            }, JsonRequestBehavior.AllowGet);
        }

        public JsonResult GetQuoteDetailByID(int id)
        {
            var data = _operationRepository.GetQuoteDetailByID(id);
            var jsonResult = Json(new { data = data.InternationFeedback }, JsonRequestBehavior.AllowGet);
            jsonResult.MaxJsonLength = int.MaxValue;
            return jsonResult;
        }

        [HttpPost]
        public JsonResult AddQueryData(AddQueryDataModel model)
        {
            int refNo = 1;
            string value = string.Empty;
            string matchingstring = "SZ-Q-";
            var SZ_Quotationdata = (from i in db.SZ_QueryModule
                                    where i.QueryNo.StartsWith(matchingstring)
                                    select i).ToList();
            if (SZ_Quotationdata.Count > 0)
            {
                refNo = SZ_Quotationdata.Select(x => ExtractQueryModukeRefNumber(x.QueryNo)).Max(w => w);
                int newbrokerrewf = Convert.ToInt32(refNo) + 1;

                value = "SZ-Q-" + newbrokerrewf.ToString().PadLeft(3, '0');
            }
            else
            {
                value = "SZ-Q-001";
            }

            var inventorydata = db.SZ_Inventory.AsQueryable();
            var queryModuleData = db.SZ_QueryModule.Where(x => x.Status != "Solved" && x.Status != "Completed").ToList();
            string[] ids = model.Id.Split(',');
            foreach (var id in ids)
            {
                int qdid = Convert.ToInt32(id);
                var data = _operationRepository.GetQuoteDetailByID(qdid);
                if (data != null)
                {
                    var poNumber = data.SZ_Quotation.PONo;
                    var catN = data.CATNo;
                    var isChecked = queryModuleData.Where(x => x.PONo == poNumber && x.CATNo == catN && x.Status != "Solved" && x.Status != "Completed").Any();
                    if (!isChecked)
                    {
                        SZ_QueryModule sZ_QueryModule = new SZ_QueryModule();
                        sZ_QueryModule.QuerySubject = model.QuerySubject;
                        sZ_QueryModule.QueryNo = value;
                        sZ_QueryModule.Email = model.Email;
                        sZ_QueryModule.PrimaryEmail = model.Email;
                        sZ_QueryModule.PoDate = data.SZ_Quotation.PODate;
                        sZ_QueryModule.PONo = data.SZ_Quotation.PONo;
                        sZ_QueryModule.ProductName = data.ProductName;
                        sZ_QueryModule.CASNo = data.CASNo;
                        sZ_QueryModule.CATNo = data.CATNo;
                        if (data.AdditionalBatchNo.HasValue)
                        {
                            var szinventory = inventorydata.Where(x => x.Id == data.AdditionalBatchNo).FirstOrDefault();
                            if (szinventory != null)
                            {
                                sZ_QueryModule.BatchNo = szinventory.BatchNo;
                            }
                        }
                        sZ_QueryModule.Qty = data.RequiredQty;
                        sZ_QueryModule.Status = "Open";
                        sZ_QueryModule.QuoteDetailsId = qdid;
                        sZ_QueryModule.ClientRemark = model.QueryText;
                        sZ_QueryModule.Origin = model.Origin;
                        sZ_QueryModule.QueryType = model.Type;
                        sZ_QueryModule.IsScientistResolved = false;
                        sZ_QueryModule.CreatedDate = DateTime.Now;
                        db.SZ_QueryModule.Add(sZ_QueryModule);
                        db.SaveChanges();
                    }
                }
            }

            return Json(new
            {
                success = true
            }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult NotificationList()
        {
            return View();
        }

        [HttpGet]
        public JsonResult GetNotification()
        {
            var data = db.SZ_SystemNotification.Where(x => x.IsView == false).AsQueryable();
            if (SessionCookieManagement.IsProjectLogin)
            {
                data = data.Where(x => x.ReceivedUserId == SessionCookieManagement.UserId).AsQueryable();
            }

            data = data.OrderByDescending(x => x.CreatedDate).AsQueryable();

            return Json(new { count = data.Count(), data = data.Take(5) }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public JsonResult AddClientRemarks(ClientRemarkModel model)
        {
            string remark = model.Remark;
            int id = model.Id;

            try
            {

                var data = _operationRepository.GetQuoteDetailByID(id);
                if (data != null)
                {
                    if (string.IsNullOrEmpty(data.ClientRemark) && !string.IsNullOrEmpty(model.Remark))
                    {
                        data.ClientStatus = "COA/Data Correction";
                    }
                    if (data.ClientRemark != remark && model.isClientSection)
                    {
                        string adminemail = ConfigurationManager.AppSettings["EmailAddress"];
                        if (adminemail != null)
                        {
                            try
                            {
                                MailMessage mail = new MailMessage();
                                ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12 |
                                       SecurityProtocolType.Tls11 |
                                       SecurityProtocolType.Tls |
                                       SecurityProtocolType.Ssl3;
                                SmtpClient SmtpServer = new SmtpClient(ConfigurationManager.AppSettings["Email.Host"]);
                                mail.From = new MailAddress(ConfigurationManager.AppSettings["Email.Username"], "SynZeal Standards");
                                string[] emails = adminemail.Split(';');
                                foreach (var i in emails)
                                {
                                    mail.To.Add(i);
                                }

                                //mail.To. = adminemail;
                                string logCompName = Request.Cookies["LoginCompanyName"].Value;
                                mail.Subject = logCompName + " / PO NUmber : " + data.SZ_Quotation.PONo + " / Product name : " + data.ProductName;
                                mail.Body = "Dear Admin, <br> " + logCompName + " has updated client remark. Kindly correct it and upload corrected document. Please have a look on it.  <br> Thanks";
                                mail.IsBodyHtml = true;
                                SmtpServer.Port = Convert.ToInt32(ConfigurationManager.AppSettings["Port"]);
                                SmtpServer.Credentials = new System.Net.NetworkCredential(ConfigurationManager.AppSettings["Email.Username"], ConfigurationManager.AppSettings["Email.Password"]);
                                SmtpServer.EnableSsl = true;

                                SmtpServer.Send(mail);
                            }
                            catch (Exception ex)
                            {
                                sendErrorMail(ex.LineNumber() + " " + "Error Text : " + ex.Message + " / Stack Trace : " + ex.StackTrace);
                            }
                        }
                    }
                    if (data.ClientRemark != remark && !model.isClientSection)
                    {
                        var notification = new SZ_Notification();
                        notification.CompanyId = data.SZ_Quotation.CompanyId.Value;
                        notification.CreatedDate = DateTime.Now;
                        notification.IsRead = false;
                        notification.Message = "Synzeal has changed remark of " + data.SZ_Quotation.PONo + " purchase number. Product name is " + data.ProductName;
                        db.SZ_Notification.Add(notification);
                        db.SaveChanges();

                    }

                    if (!model.isClientSection && data.ClientRemark != remark)
                    {
                        data.ResponseClientRemarkDate = DateTime.Now;
                    }

                    data.ClientRemark = remark;
                    db.Entry(data).State = EntityState.Modified;
                    db.SaveChanges();
                }

                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = ""
                }, JsonRequestBehavior.AllowGet);
            }
        }

        public ActionResult SalesSummaryData(DateTime Startdate, DateTime Enddate)
        {
            TimeSpan sts = new TimeSpan(0, 0, 0);
            TimeSpan ets = new TimeSpan(23, 59, 59);

            Startdate = Startdate.Add(sts);
            Enddate = Enddate.Add(ets);

            var quotedata = (from i in db.SZ_Quotation
                             join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                             where i.CreatedDate >= Startdate && i.CreatedDate <= Enddate
                             select t2).ToList();

            var quoteUserList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("quote")).ToList();
            MemoryCacheManager objCache = new MemoryCacheManager();

            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });
            List<SelectListItem> listBDItems = new List<SelectListItem>();
            foreach (var term in quoteUserList)
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                if (genericAttr.Count() > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                if (!customerName.ToLower().Contains("mayur")
                    && !customerName.ToLower().Contains("aniruddhsinh")
                    && !customerName.ToLower().Contains("sagar")
                    && !customerName.ToLower().Contains("kishan")
                    && !customerName.ToLower().Contains("rutwik")
                    && !customerName.ToLower().Contains("kamlesh")
                    && !customerName.ToLower().Contains("sweta")
                    )
                {
                    listBDItems.Add(new SelectListItem
                    {
                        Text = customerName.Trim(),
                        Value = term.Id.ToString()
                    });
                }
            }

            var todaymodel = new List<SalesSummaryDataModel>();
            listBDItems.ForEach(item =>
            {
                var submodel = new SalesSummaryDataModel();
                submodel.Username = item.Text;
                //submodel.Date = todaydate;
                submodel.RFQProducts = quotedata.Where(x => x.SZ_Quotation.CreatedBy == item.Text && (x.SZ_Quotation.IsRFQ == true || x.SZ_Quotation.IsRFQManually == true)).Count();
                submodel.QuoteProducts = quotedata.Where(x => x.SZ_Quotation.CreatedBy == item.Text && (x.SZ_Quotation.IsRFQ == null || x.SZ_Quotation.IsRFQ == false) && (x.SZ_Quotation.IsRFQManually == null || x.SZ_Quotation.IsRFQManually == false)).Count();
                submodel.Total = submodel.RFQProducts + submodel.QuoteProducts;
                todaymodel.Add(submodel);
            });

            var html = PartialViewdata(this, "_PartialSalesSummary", todaymodel);

            return Json(html, JsonRequestBehavior.AllowGet);
        }
        public ActionResult weeklysummary()
        {
            int inrpricerange = 500000;
            int usdpricerange = 5000;
            DateTime startDate = DateTime.Now.AddDays(-7);
            DateTime endDate = DateTime.Now.AddYears(-5);
            var model = new List<WeeklySummaryModel>();

            var quoteData = db.SZ_Quotation.Where(x =>
                    (x.IsPark == null || x.IsPark == false)
                    && (x.IsToBe == null || x.IsToBe == false)
                    && x.CreatedDate >= endDate
                    && x.CreatedDate <= startDate && string.IsNullOrEmpty(x.PONo) && !x.CompanyName.Contains("synzeal")).ToList();
            if (quoteData != null && quoteData.Count > 0)
            {
                foreach (var quote in quoteData)
                {
                    var quotedetailsData = db.SZ_QuotationDetail.Where(x => x.QuoteId == quote.Id).ToList();
                    decimal total = 0;
                    int price1total = 0;
                    int price2total = 0;
                    int price3total = 0;
                    int price4total = 0;
                    var countryType = string.IsNullOrEmpty(quote.CountryType) ? "Domestic" : quote.CountryType;    //"Domestic" ? "INR" : "USD"
                    foreach (var details in quotedetailsData)
                    {
                        if (!string.IsNullOrEmpty(details.Price))
                        {
                            var allpricedata = details.Price.Split(',');
                            if (allpricedata.Count() == 1)
                            {
                                if (allpricedata[0].IndexOf("X") != -1)
                                {
                                    try
                                    {
                                        string packs = allpricedata[0].Split('X')[1];
                                        if (packs.Contains("="))
                                        {
                                            if (Convert.ToInt32(packs.Split('=')[0]) > 1)
                                            {
                                                if (!string.IsNullOrEmpty(packs.Split('=')[1].Trim().Split(' ')[0]))
                                                {
                                                    total += Convert.ToDecimal(packs.Split('=')[1].Trim().Split(' ')[0]);
                                                    price1total += Convert.ToInt32(packs.Split('=')[1].Trim().Split(' ')[0]);
                                                }

                                            }
                                        }
                                    }
                                    catch
                                    {
                                    }
                                }
                                else
                                {
                                    try
                                    {
                                        if (!string.IsNullOrEmpty(allpricedata[0].Split(' ')[1].Split('@')[1]))
                                        {
                                            total += Convert.ToDecimal(allpricedata[0].Split(' ')[1].Split('@')[1]);
                                            price1total += Convert.ToInt32(allpricedata[0].Split(' ')[1].Split('@')[1]);
                                        }
                                    }
                                    catch
                                    {
                                        try
                                        {
                                            if (!string.IsNullOrEmpty(allpricedata[0].Split('@')[1].Trim().Split(' ')[0]))
                                            {
                                                total += Convert.ToDecimal(allpricedata[0].Split('@')[1].Trim().Split(' ')[0]);
                                                price1total += Convert.ToInt32(allpricedata[0].Split('@')[1].Trim().Split(' ')[0]);
                                            }
                                        }
                                        catch
                                        {

                                        }
                                    }
                                }
                            }
                            else
                            {
                                var cnt = new List<string>();
                                var loopcnt = 1;
                                try
                                {
                                    foreach (var item in allpricedata)
                                    {
                                        var qty = System.Text.RegularExpressions.Regex.Match(item.Split('@')[0], @"\d+").Value;
                                        var price = System.Text.RegularExpressions.Regex.Match(item.Split('@')[1], @"\d+").Value;
                                        if (item.Split('X').Count() > 1)
                                        {
                                            if (item.Split('X')[1].Contains("="))
                                            {
                                                if (!string.IsNullOrEmpty(item.Split('X')[1].Split('=')[1].Trim().Split(' ')[0]))
                                                {
                                                    total += Convert.ToDecimal(item.Split('X')[1].Split('=')[1].Trim().Split(' ')[0]);
                                                    if (loopcnt == 1)
                                                    {
                                                        price1total += Convert.ToInt32(item.Split('X')[1].Split('=')[1].Trim().Split(' ')[0]);
                                                    }
                                                    if (loopcnt == 2)
                                                    {
                                                        price2total += Convert.ToInt32(item.Split('X')[1].Split('=')[1].Trim().Split(' ')[0]);
                                                    }
                                                    if (loopcnt == 2)
                                                    {
                                                        price3total += Convert.ToInt32(item.Split('X')[1].Split('=')[1].Trim().Split(' ')[0]);
                                                    }
                                                    if (loopcnt == 3)
                                                    {
                                                        price4total += Convert.ToInt32(item.Split('X')[1].Split('=')[1].Trim().Split(' ')[0]);
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                if (!string.IsNullOrEmpty(item.Split('X')[1].Split('=')[1].Trim().Split(' ')[0]))
                                                {
                                                    total += Convert.ToDecimal(item.Split('X')[1].Split('=')[1].Trim().Split(' ')[0]);
                                                    if (loopcnt == 1)
                                                    {
                                                        price1total += Convert.ToInt32(item.Split('X')[1].Split('=')[1].Trim().Split(' ')[0]);
                                                    }
                                                    if (loopcnt == 2)
                                                    {
                                                        price2total += Convert.ToInt32(item.Split('X')[1].Split('=')[1].Trim().Split(' ')[0]);
                                                    }
                                                    if (loopcnt == 2)
                                                    {
                                                        price3total += Convert.ToInt32(item.Split('X')[1].Split('=')[1].Trim().Split(' ')[0]);
                                                    }
                                                    if (loopcnt == 3)
                                                    {
                                                        price4total += Convert.ToInt32(item.Split('X')[1].Split('=')[1].Trim().Split(' ')[0]);
                                                    }
                                                }
                                            }
                                        }
                                        loopcnt += 1;
                                    }
                                    if (cnt.Count == 1)
                                    {
                                        if (!string.IsNullOrEmpty(cnt[0].Split(' ')[1].Split('@')[1]))
                                        {
                                            total += Convert.ToDecimal(cnt[0].Split(' ')[1].Split('@')[1]);
                                        }
                                    }
                                }
                                catch (Exception)
                                {
                                    total += 0;
                                }
                            }
                        }
                    }
                    bool isaded = false;
                    if (countryType == "Domestic")
                    {
                        if (total >= inrpricerange)
                        {
                            isaded = true;
                        }
                    }
                    else
                    {
                        if (total >= usdpricerange)
                        {
                            isaded = true;
                        }
                    }

                    if (isaded)
                    {
                        foreach (var details in quotedetailsData)
                        {
                            var objmodel = new WeeklySummaryModel();
                            objmodel.Company = details.SZ_Quotation.CompanyName;
                            objmodel.Product = details.ProductName;
                            objmodel.CASNo = details.CASNo;
                            objmodel.CATNo = details.CATNo;
                            objmodel.QuoteID = details.SZ_Quotation.Ref;
                            objmodel.LeadTime = details.LeadTime;
                            objmodel.ProductRemarks = details.ProductRemark;
                            objmodel.ExportDomestic = details.SZ_Quotation.CountryType;
                            model.Add(objmodel);
                        }
                    }
                }
            }

            var htmlstring = PartialViewdata(this, "_PartialWeeklySummary", model);
            htmlstring = "<html><head></head><body style='font-family:Tahoma, Verdana, Segoe, sans-serif;font-size:11px;'>" + htmlstring + "</body></html>";
            string path = printpdf(htmlstring, "Weekly_Summary_" + DateTime.Now.ToString().Replace("/", "_").Replace(" ", "_").Replace(":", "_"), false);
            MailMessage mail = new MailMessage();
            ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12 |
                               SecurityProtocolType.Tls11 |
                               SecurityProtocolType.Tls |
                               SecurityProtocolType.Ssl3;
            SmtpClient SmtpServer = new SmtpClient(ConfigurationManager.AppSettings["Email.Host"]);
            mail.Attachments.Add(new Attachment(path));
            mail.From = new MailAddress(ConfigurationManager.AppSettings["Email.Username"], "SynZeal Standards");
            var isDevelopment = ConfigurationManager.AppSettings["IsDevelopment"];
            if (isDevelopment.ToLower().Contains("true"))
            {
                mail.To.Add(ConfigurationManager.AppSettings["DevEmailAddress"].ToString());
            }
            else
            {
                mail.To.Add("shailesh@synzeal.com");
                mail.To.Add("bd@synzeal.com");
                mail.Bcc.Add("parthsuthar2010@gmail.com");
            }
            mail.Subject = "Weekly Summary";

            mail.Body = "Hello, <br> Please find attachment. <br> Thanks";
            mail.IsBodyHtml = true;
            SmtpServer.Port = Convert.ToInt32(ConfigurationManager.AppSettings["Port"]);
            SmtpServer.Credentials = new System.Net.NetworkCredential(ConfigurationManager.AppSettings["Email.Username"], ConfigurationManager.AppSettings["Email.Password"]);
            SmtpServer.EnableSsl = true;
            SmtpServer.Send(mail);

            return Content("asd");
        }

        public ActionResult updatedailyquoteapprovalsummary()
        {
            string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.Purchase);
            string purSynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);

            var model = (from i in db.SZ_Quotation
                         join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                         where ((string.IsNullOrEmpty(t2.TrackingNo)
                         && (t2.ProjectType == inhouseProjectType || t2.ProjectType == purSynthesisProjectType)
                         && (t2.IsOnHold == false || t2.IsOnHold == null)
                         && (t2.IsCancel == false || t2.IsCancel == null)
                         && (t2.IsSynthesisLog == false || t2.IsSynthesisLog == null))
                         || t2.IsPurchase == true) && t2.PurchaseDate.HasValue
                         && t2.PurchaseDDLStatus == "22"
                         orderby t2.PurchaseDate descending
                         select t2).Distinct().ToList();

            var htmlstring = PartialViewdata(this, "_PartialUpdateQuoteApprovalSummary", model);
            htmlstring = "<html><head></head><body style='font-family:Tahoma, Verdana, Segoe, sans-serif;font-size:11px;'>" + htmlstring + "</body></html>";
            string path = printpdf(htmlstring, filenameDateWise("Quote_Approval_Summary"), false, true);
            MailMessage mail = new MailMessage();
            ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12 |
                               SecurityProtocolType.Tls11 |
                               SecurityProtocolType.Tls |
                               SecurityProtocolType.Ssl3;
            SmtpClient SmtpServer = new SmtpClient(ConfigurationManager.AppSettings["Email.Host"]);
            mail.Attachments.Add(new Attachment(path));
            mail.From = new MailAddress(ConfigurationManager.AppSettings["Email.Username"], "SynZeal Standards");
            var isDevelopment = ConfigurationManager.AppSettings["IsDevelopment"];
            if (isDevelopment.ToLower().Contains("true"))
            {
                mail.To.Add(ConfigurationManager.AppSettings["DevEmailAddress"].ToString());
            }
            else
            {
                mail.To.Add("shailesh@synzeal.com");
                mail.To.Add("scm@synzeal.com");
                mail.Bcc.Add("parth.suthar@synzeal.com");
            }
            mail.Subject = "Quote Approval Summary ";
            mail.Body = "Hello, <br> Please find attachment. <br> Thanks<br>  SynZeal Research PVT LTD";
            mail.IsBodyHtml = true;
            SmtpServer.Port = Convert.ToInt32(ConfigurationManager.AppSettings["Port"]);
            SmtpServer.Credentials = new System.Net.NetworkCredential(ConfigurationManager.AppSettings["Email.Username"], ConfigurationManager.AppSettings["Email.Password"]);
            SmtpServer.EnableSsl = true;
            SmtpServer.Send(mail);

            return Json("OK", JsonRequestBehavior.AllowGet);
        }

        public ActionResult updatedailysalessummary()
        {
            DateTime baseDate = DateTime.Today;
            TimeSpan sts = new TimeSpan(0, 0, 0);
            TimeSpan ets = new TimeSpan(23, 59, 59);

            var today = baseDate;
            var yesterday = baseDate.AddDays(-1);
            var thisWeekStart = baseDate.AddDays(-(int)baseDate.DayOfWeek).Add(sts);
            var thisWeekEnd = thisWeekStart.AddDays(7).AddSeconds(-1).Add(ets);
            var thisMonthStart = baseDate.AddDays(1 - baseDate.Day).Add(sts);
            var thisMonthEnd = thisMonthStart.AddMonths(1).AddSeconds(-1).Add(ets);
            ViewBag.Weekstart = thisWeekStart.ToShortDateString();
            ViewBag.Weekend = thisWeekEnd.ToShortDateString();
            var todaydate = DateTime.Now.AddDays(-1);
            var startdate = todaydate.StartOfDay();
            var enddate = todaydate.EndOfDay();


            int CurrentYear = DateTime.Today.Year;
            int PreviousYear = DateTime.Today.Year - 1;
            int NextYear = DateTime.Today.Year + 1;
            string PreYear = PreviousYear.ToString();
            string NexYear = NextYear.ToString();
            string CurYear = CurrentYear.ToString();
            string FinYear = null;
            var finstartdate = DateTime.Now;
            var finenddate = DateTime.Now;
            if (DateTime.Today.Month > 3)
            {
                finstartdate = new DateTime(Convert.ToInt32(CurYear), 4, 1).Add(sts);
                finenddate = new DateTime(Convert.ToInt32(NexYear), 3, 31).Add(ets);
                ViewBag.FinYear = CurYear + "-" + NexYear;
            }
            else
            {
                finstartdate = new DateTime(Convert.ToInt32(PreYear), 4, 1).Add(sts);
                finenddate = new DateTime(Convert.ToInt32(CurYear), 3, 31).Add(ets);
                ViewBag.FinYear = PreYear + "-" + CurYear;
            }

            // var quotedata = db.SZ_Quotation.Where(x => x.CreatedDate >= startdate && x.CreatedDate <= enddate).ToList();
            var quotedata = (from i in db.SZ_Quotation
                             join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                             where i.CreatedDate >= finstartdate && i.CreatedDate <= finenddate
                             select t2).ToList();

            var quoteUserList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("quote")).ToList();
            MemoryCacheManager objCache = new MemoryCacheManager();

            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });
            List<SelectListItem> listBDItems = new List<SelectListItem>();
            foreach (var term in quoteUserList)
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                if (genericAttr.Count() > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                if (!customerName.ToLower().Contains("mayur")
                    && !customerName.ToLower().Contains("aniruddhsinh")
                    && !customerName.ToLower().Contains("sagar")
                    && !customerName.ToLower().Contains("kishan")
                    && !customerName.ToLower().Contains("rutwik")
                    && !customerName.ToLower().Contains("kamlesh")
                    && !customerName.ToLower().Contains("sweta")
                    && !customerName.ToLower().Contains("kavita")
                    && !customerName.ToLower().Contains("test")
                    && !customerName.ToLower().Contains("divyesh")
                    && !customerName.ToLower().Contains("pratipalsinh")
                    && !customerName.ToLower().Contains("bhavdip")
                    && !customerName.ToLower().Contains("dhrumil")
                    && !customerName.ToLower().Contains("mansi")
                    && !customerName.ToLower().Contains("neh")
                    )
                {
                    listBDItems.Add(new SelectListItem
                    {
                        Text = customerName.Trim(),
                        Value = term.Id.ToString()
                    });
                }
            }

            var todaymodel = new List<SalesSummaryDataModel>();
            listBDItems.ForEach(item =>
            {
                //var quoteDetailsIds = quotedata.Where(x => x.CreatedDate >= startdate && x.CreatedDate <= enddate && x.SZ_Quotation.CreatedBy == item.Text).Select(x=>x.Id).ToList();
                //int projectCount = db.SZ_QuotationDetail.Where(x => quoteDetailsIds.Contains(x.Id) && x.MoveToProject == true).Count();
                //int quoteCount = quotedata.Where(x => x.CreatedDate >= startdate && x.CreatedDate <= enddate && x.SZ_Quotation.CreatedBy == item.Text).Count();

                //decimal conversion = 0;
                //if(projectCount > 0)
                //{ 
                //    conversion = ((Convert.ToDecimal(projectCount) / Convert.ToDecimal(quoteCount)) * 100);
                //}

                var submodel = new SalesSummaryDataModel();
                submodel.Username = item.Text;
                submodel.Date = todaydate;
                submodel.RFQProducts = quotedata.Where(x => x.CreatedDate >= startdate && x.CreatedDate <= enddate && x.SZ_Quotation.CreatedBy == item.Text && (x.SZ_Quotation.IsRFQ == true || x.SZ_Quotation.IsRFQManually == true)).Count();
                submodel.QuoteProducts = quotedata.Where(x => x.CreatedDate >= startdate && x.CreatedDate <= enddate && x.SZ_Quotation.CreatedBy == item.Text && (x.SZ_Quotation.IsRFQ == null || x.SZ_Quotation.IsRFQ == false) && (x.SZ_Quotation.IsRFQManually == null || x.SZ_Quotation.IsRFQManually == false)).Count();
                submodel.Total = submodel.RFQProducts + submodel.QuoteProducts;
                //submodel.Conversion = conversion + "%";
                todaymodel.Add(submodel);
            });
            int pcountttl = 0;
            int qcountttl = 0;
            var monthmodel = new List<SalesSummaryDataModel>();
            listBDItems.ForEach(item =>
            {
                var quoteDetailsIds = quotedata.Where(x => x.CreatedDate >= thisMonthStart && x.CreatedDate <= thisMonthEnd && x.SZ_Quotation.CreatedBy == item.Text).Select(x => x.Id).ToList();
                int projectCount = db.SZ_QuotationDetail.Where(x => quoteDetailsIds.Contains(x.Id) && x.MoveToProject == true).Count();
                int quoteCount = quotedata.Where(x => x.CreatedDate >= thisMonthStart && x.CreatedDate <= thisMonthEnd && x.SZ_Quotation.CreatedBy == item.Text).Count();
                pcountttl += projectCount;
                qcountttl += quoteCount;
                decimal conversion = 0;
                if (projectCount > 0)
                {
                    conversion = ((Convert.ToDecimal(projectCount) / Convert.ToDecimal(quoteCount)) * 100);
                }

                var submodel = new SalesSummaryDataModel();
                submodel.Username = item.Text;
                submodel.Date = todaydate;
                submodel.RFQProducts = quotedata.Where(x => x.SZ_Quotation.CreatedBy == item.Text && (x.SZ_Quotation.IsRFQ == true || x.SZ_Quotation.IsRFQManually == true)).Count();
                submodel.QuoteProducts = quotedata.Where(x => x.SZ_Quotation.CreatedBy == item.Text && (x.SZ_Quotation.IsRFQ == null || x.SZ_Quotation.IsRFQ == false) && (x.SZ_Quotation.IsRFQManually == null || x.SZ_Quotation.IsRFQManually == false)).Count();
                submodel.Total = submodel.RFQProducts + submodel.QuoteProducts;
                submodel.Conversion = Math.Round(conversion, 2) + "%";
                monthmodel.Add(submodel);
            });
            if (pcountttl > 0)
            {
                ViewBag.Monthconversion = Math.Round(((Convert.ToDecimal(pcountttl) / Convert.ToDecimal(qcountttl)) * 100), 2) + " %";
            }
            var weekmodel = new List<SalesSummaryDataModel>();
            listBDItems.ForEach(item =>
            {
                //var quoteDetailsIds = quotedata.Where(x => x.CreatedDate >= thisWeekStart && x.CreatedDate <= thisWeekEnd && x.SZ_Quotation.CreatedBy == item.Text).Select(x => x.Id).ToList();
                //int projectCount = db.SZ_QuotationDetail.Where(x => quoteDetailsIds.Contains(x.Id) && x.MoveToProject == true).Count();
                //int quoteCount = quotedata.Where(x => x.CreatedDate >= thisWeekStart && x.CreatedDate <= thisWeekEnd && x.SZ_Quotation.CreatedBy == item.Text).Count();

                //decimal conversion = 0;
                //if (projectCount > 0)
                //{
                //    conversion = ((Convert.ToDecimal(projectCount) / Convert.ToDecimal(quoteCount)) * 100);
                //}
                var submodel = new SalesSummaryDataModel();
                submodel.Username = item.Text;
                submodel.Date = todaydate;
                submodel.RFQProducts = quotedata.Where(x => x.CreatedDate >= thisWeekStart && x.CreatedDate <= thisWeekEnd && x.SZ_Quotation.CreatedBy == item.Text && (x.SZ_Quotation.IsRFQ == true || x.SZ_Quotation.IsRFQManually == true)).Count();
                submodel.QuoteProducts = quotedata.Where(x => x.CreatedDate >= thisWeekStart && x.CreatedDate <= thisWeekEnd && x.SZ_Quotation.CreatedBy == item.Text && (x.SZ_Quotation.IsRFQ == null || x.SZ_Quotation.IsRFQ == false) && (x.SZ_Quotation.IsRFQManually == null || x.SZ_Quotation.IsRFQManually == false)).Count();
                submodel.Total = submodel.RFQProducts + submodel.QuoteProducts;
                //submodel.Conversion = conversion + "%";
                weekmodel.Add(submodel);
            });

            var yearmodel = new List<SalesSummaryDataModel>();
            pcountttl = 0;
            qcountttl = 0;
            listBDItems.ForEach(item =>
            {
                var quoteDetailsIds = quotedata.Where(x => x.CreatedDate >= finstartdate && x.CreatedDate <= finenddate && x.SZ_Quotation.CreatedBy == item.Text).Select(x => x.Id).ToList();
                int projectCount = db.SZ_QuotationDetail.Where(x => quoteDetailsIds.Contains(x.Id) && x.MoveToProject == true).Count();
                int quoteCount = quotedata.Where(x => x.CreatedDate >= finstartdate && x.CreatedDate <= finenddate && x.SZ_Quotation.CreatedBy == item.Text).Count();
                pcountttl += projectCount;
                qcountttl += quoteCount;
                decimal conversion = 0;
                if (projectCount > 0)
                {
                    conversion = ((Convert.ToDecimal(projectCount) / Convert.ToDecimal(quoteCount)) * 100);
                }

                var submodel = new SalesSummaryDataModel();
                submodel.Username = item.Text;
                submodel.Date = todaydate;
                submodel.RFQProducts = quotedata.Where(x => x.CreatedDate >= finstartdate && x.CreatedDate <= finenddate && x.SZ_Quotation.CreatedBy == item.Text && (x.SZ_Quotation.IsRFQ == true || x.SZ_Quotation.IsRFQManually == true)).Count();
                submodel.QuoteProducts = quotedata.Where(x => x.CreatedDate >= finstartdate && x.CreatedDate <= finenddate && x.SZ_Quotation.CreatedBy == item.Text && (x.SZ_Quotation.IsRFQ == null || x.SZ_Quotation.IsRFQ == false) && (x.SZ_Quotation.IsRFQManually == null || x.SZ_Quotation.IsRFQManually == false)).Count();
                submodel.Total = submodel.RFQProducts + submodel.QuoteProducts;
                submodel.Conversion = Math.Round(conversion, 2) + "%";
                yearmodel.Add(submodel);
            });
            if (pcountttl > 0)
            {
                ViewBag.Yearconversion = Math.Round(((Convert.ToDecimal(pcountttl) / Convert.ToDecimal(qcountttl)) * 100), 2) + " %";
            }

            var model = new SalesSummaryModel();
            model.WeekData = weekmodel;
            model.MonthData = monthmodel;
            model.TodayData = todaymodel;
            model.YearData = yearmodel;

            var htmlstring = PartialViewdata(this, "_PartialUpdateSalesSummary", model);
            htmlstring = "<html><head></head><body style='font-family:Tahoma, Verdana, Segoe, sans-serif;font-size:11px;'>" + htmlstring + "</body></html>";
            string path = printpdf(htmlstring, filenameDateWise("Quotation_Summary"), false);
            MailMessage mail = new MailMessage();
            ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12 |
                               SecurityProtocolType.Tls11 |
                               SecurityProtocolType.Tls |
                               SecurityProtocolType.Ssl3;
            SmtpClient SmtpServer = new SmtpClient(ConfigurationManager.AppSettings["Email.Host"]);
            mail.Attachments.Add(new Attachment(path));
            mail.From = new MailAddress(ConfigurationManager.AppSettings["Email.Username"], "SynZeal Standards");
            var isDevelopment = ConfigurationManager.AppSettings["IsDevelopment"];
            if (isDevelopment.ToLower().Contains("true"))
            {
                mail.To.Add(ConfigurationManager.AppSettings["DevEmailAddress"].ToString());
            }
            else
            {
                mail.To.Add("shailesh@synzeal.com");
                mail.CC.Add("jitendra@synzeal.com");
                mail.Bcc.Add("parth.suthar@synzeal.com");
            }
            mail.Subject = "Quotation Summary :: " + DateTime.Now.AddDays(-1).ToShortDateString();

            mail.Body = "Hello, <br> Please find attachment. <br> Thanks";
            mail.IsBodyHtml = true;
            SmtpServer.Port = Convert.ToInt32(ConfigurationManager.AppSettings["Port"]);
            SmtpServer.Credentials = new System.Net.NetworkCredential(ConfigurationManager.AppSettings["Email.Username"], ConfigurationManager.AppSettings["Email.Password"]);
            SmtpServer.EnableSsl = true;
            SmtpServer.Send(mail);

            return Json("OK", JsonRequestBehavior.AllowGet);
        }

        public ActionResult ExportQueryPDF(string id)
        {
            var dataCATNo = ""; var dataQueryNo = "";
            var filearray = new List<string>();
            string[] ids = id.Split(',');
            foreach (var item in ids)
            {
                var i = Convert.ToInt32(item);
                var data = db.SZ_QueryModule.Where(x => x.Id == i).FirstOrDefault();
                dataCATNo = data.CATNo;
                dataQueryNo = data.QueryNo;
                var htmlstring = PartialViewdata(this, "_PartialQueryPDF", data);
                htmlstring = "<html><head></head><body style='font-family:Tahoma, Verdana, Segoe, sans-serif;font-size:11px;'>" + htmlstring + "</body></html>";
                string path = printpdf(htmlstring, data.QueryNo, true);
                filearray.Add(path);
            }

            if (filearray.Count > 1)
            {
                string specdatafilename = "Query_" + Guid.NewGuid().ToString() + ".pdf";
                string outputPdfPath = Server.MapPath("~/Content/NewProducts/" + specdatafilename);
                var output = new FileStream(outputPdfPath, FileMode.Create);
                PdfReader reader = null;
                Document sourceDocument = null;
                PdfCopy pdfCopyProvider = null;
                PdfImportedPage importedPage;
                sourceDocument = new Document();
                pdfCopyProvider = new PdfCopy(sourceDocument, output);
                //output file Open  
                sourceDocument.Open();

                foreach (var item in filearray)
                {
                    var fPath = Server.MapPath(item.Replace("..", "~"));
                    int pages = Common.TotalPageCount(fPath);

                    reader = new PdfReader(fPath);
                    //Add pages in new file  
                    for (int i = 1; i <= pages; i++)
                    {
                        try
                        {
                            importedPage = pdfCopyProvider.GetImportedPage(reader, i);
                            pdfCopyProvider.AddPage(importedPage);
                        }
                        catch (Exception ex)
                        {

                        }
                    }
                    reader.Close();
                }
                sourceDocument.Close();
                string dataoutputfile = "/content/NewProducts/" + specdatafilename;
                return File(dataoutputfile, "application/pdf", Server.UrlEncode(dataCATNo.Replace(" ", "-") + "-" + dataQueryNo + ".pdf"));
            }

            return File(Server.MapPath("~/" + filearray[0]), "application/pdf", Server.UrlEncode(dataCATNo.Replace(" ", "-") + "-" + dataQueryNo + ".pdf"));
        }

        public ActionResult GeneratedPricingData()
        {
            var szquotationdetails = db.SZ_QuotationDetail.AsNoTracking().OrderByDescending(x => x.Id).ToList();
            var model = new List<ExportPriceModel>();
            szquotationdetails.ForEach(item =>
            {
                var isExistData = model.Where(x => x.CATno == item.CATNo).FirstOrDefault();
                if (isExistData == null)
                {
                    //Add New Record
                    var subModel = new ExportPriceModel();
                    subModel.CATno = item.CATNo;
                    subModel.CASNo = item.CASNo;
                    subModel.PriceData = new List<ExportPriceDetailModel>();
                    if (!string.IsNullOrEmpty(item.Price))
                    {
                        string Currency = item.Price.ToLower().Contains("inr") ? "INR" : "USD";
                        var splpri = item.Price.Split(',');
                        foreach (var splpridetail in splpri)
                        {
                            var splpricedetail = splpridetail.Split('@');
                            try
                            {
                                var subprimodel = new ExportPriceDetailModel();

                                subprimodel.Mg = Regex.Replace(splpricedetail[0].Replace("mg", "").Trim(), "[^0-9]+", string.Empty);
                                subprimodel.Price = Regex.Replace(splpricedetail[1].Replace("mg", "").Trim(), "[^0-9]+", string.Empty);
                                subprimodel.Currency = Currency;
                                if (!string.IsNullOrEmpty(subprimodel.Price))
                                {
                                    subModel.PriceData.Add(subprimodel);
                                }
                            }
                            catch (Exception ex)
                            {

                            }
                        }
                    }
                    model.Add(subModel);
                }
                else
                {
                    if (!string.IsNullOrEmpty(item.Price))
                    {
                        string Currency = item.Price.ToLower().Contains("inr") ? "INR" : "USD";
                        var splpri = item.Price.Split(',');
                        foreach (var splpridetail in splpri)
                        {
                            var splpricedetail = splpridetail.Split('@');
                            var subprimodel = new ExportPriceDetailModel();

                            try
                            {
                                string mgValue = Regex.Replace(splpricedetail[0].Replace("mg", "").Trim(), "[^0-9]+", string.Empty);
                                string priceValue = Regex.Replace(splpricedetail[1].Replace("mg", "").Trim(), "[^0-9]+", string.Empty);
                                var isexistPriceData = isExistData.PriceData.Where(x => x.Mg == mgValue && !string.IsNullOrEmpty(x.Price) && x.Currency == Currency).FirstOrDefault();
                                if (isexistPriceData == null)
                                {
                                    subprimodel.Mg = mgValue;
                                    subprimodel.Price = priceValue;
                                    subprimodel.Currency = Currency;
                                    if (!string.IsNullOrEmpty(subprimodel.Price))
                                    {
                                        isExistData.PriceData.Add(subprimodel);
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                            }
                        }
                    }
                }
            });

            ExcelPackage ExcelPkg = new ExcelPackage();
            ExcelWorksheet wsSheet1 = ExcelPkg.Workbook.Worksheets.Add("Sheet1");
            wsSheet1.DefaultColWidth = 16;
            wsSheet1.Protection.IsProtected = false;
            wsSheet1.Protection.AllowSelectLockedCells = false;
            wsSheet1.Cells.AutoFitColumns(14, 40);
            wsSheet1.Column(3).Width = 40;
            wsSheet1.Column(3).Style.WrapText = true;

            using (ExcelRange Rng = wsSheet1.Cells[1, 1, 2, 16])
            {
                Rng.Value = "Pricing";
                Rng.Merge = true;
                Rng.Style.Font.Bold = true;
                Rng.Style.Font.Size = 22;
                Rng.Style.Font.Color.SetColor(Color.White);
                Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#7b7b7b");
                Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
            }

            int loopCount = 5;

            wsSheet1.Cells[loopCount, 1].Value = "Sr No";
            wsSheet1.Cells[loopCount, 2].Value = "CAT No";
            wsSheet1.Cells[loopCount, 3].Value = "CAS No";
            wsSheet1.Cells[loopCount, 4].Value = "Pricing";
            using (ExcelRange Rng = wsSheet1.Cells[loopCount, 1, loopCount, 16])
            {
                Rng.Style.Font.Bold = true;
                Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#7b7b7b");
                Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                Rng.Style.Font.Color.SetColor(Color.White);
                Rng.Style.WrapText = true;
            }
            loopCount = loopCount + 1;
            int srno = 1;
            foreach (var quote in model)
            {
                wsSheet1.Cells[loopCount, 1].Value = srno;
                wsSheet1.Cells[loopCount, 2].Value = quote.CATno;
                wsSheet1.Cells[loopCount, 3].Value = quote.CASNo;
                wsSheet1.Cells[loopCount, 4].Value = string.Join("", quote.PriceData.Select(x => x.Mg + " - " + x.Price + " - " + x.Currency + ", "));
                srno += 1;
                loopCount += 1;
            }
            string filePath = HostingEnvironment.MapPath("~/Content/Quotation/") + "Report-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xlsx";
            ExcelPkg.SaveAs(new FileInfo(filePath));
            return File(filePath, "application/excel", Server.UrlEncode("Report_007.xls"));
        }

        public ActionResult DownloadQuote(int id, bool saverecord = false)
        {
            var data = _operationRepository.GetQuoteByID(id);

            //var htmlstring = PartialViewdata(this, "_PartialQuotationPDF", data);
            //htmlstring = "<html><head></head><body style='font-family:Tahoma, Verdana, Segoe, sans-serif;font-size:11px;'>" + htmlstring + "</body></html>";
            //string format = "Mddyyyyhhmmss";
            //string date = DateTime.Now.ToString(format);
            //string path = printpdf(htmlstring, data.Ref + "_" + date);

            string format = "Mddyyyyhhmmss";
            string date = DateTime.Now.ToString(format);
            string path = GenerateQuotePDFPath(data, date);

            if (saverecord == true && !string.IsNullOrEmpty(path))
            {
                ////Uplaod in S3 Start
                Aws.UploadFile(path, data.CompanyName.Replace(" ", "-") + "-" + data.Ref + "_" + date + ".pdf");
                ////Uplaod in S3 end
                SZ_QuotationPDF objquotationPDF = new SZ_QuotationPDF();
                objquotationPDF.QuoteId = id;
                objquotationPDF.QuotePDF = "https://synzeal-quotation.s3.amazonaws.com/" + data.CompanyName.Replace(" ", "-") + "-" + data.Ref + "_" + date + ".pdf";
                objquotationPDF.CreatedDate = DateTime.Now;
                objquotationPDF.CreatedBy = SessionCookieManagement.UserName;
                db.Entry<SZ_QuotationPDF>(objquotationPDF).State = EntityState.Added;
                db.SaveChanges();
            }


            return File(path, "application/pdf", Server.UrlEncode(data.CompanyName.Replace(" ", "-") + "-" + data.Ref + ".pdf"));
        }

        public string GenerateQuotePDFPath(SZ_Quotation quoteData, string date)
        {
            if (quoteData != null)
            {
                if (!quoteData.QuoteValidDay.HasValue)
                {
                    quoteData.QuoteValidDay = 15;
                }
            }
            var htmlstring = PartialViewdata(this, "_PartialQuotationPDF", quoteData);
            htmlstring = "<html><head></head><body style='font-family:Tahoma, Verdana, Segoe, sans-serif;font-size:11px;'>" + htmlstring + "</body></html>";

            return printpdf(htmlstring, quoteData.Ref + "_" + date);
        }

        public ActionResult DownloadSubmittedForm(int id)
        {
            var objForm = db.SZ_QuoteDetailForm.Where(x => x.Id == id).FirstOrDefault();

            var htmlstring = PartialViewdata(this, "_PartialSubmittionFormPdf", objForm);

            htmlstring = "<html><head></head><body style='font-family:Tahoma, Verdana, Segoe, sans-serif;font-size:11px;'>" + htmlstring + "</body></html>";

            var path = printpdf(htmlstring, "submittedform-" + objForm.BatchCode.ToString() + "_" + DateTime.Now.ToString().Replace(":", "_").Replace(" ", "_").Replace("/", "_"), true);

            return File(path, "application/pdf", Server.UrlEncode(objForm.BatchCode.Replace(" ", "-") + "-" + DateTime.Now.ToString().Replace(":", "_").Replace(" ", "_").Replace("/", "_") + ".pdf"));
        }

        public ActionResult DownloadSampleQuote(int id, bool isdispatchquotelog = false)
        {
            var data = _operationRepository.GetQuoteByID(id);
            var htmlstring = PartialViewdata(this, "_PartialSampleQuotationPDF", data);
            htmlstring = "<html><head></head><body style='font-family:Tahoma, Verdana, Segoe, sans-serif;font-size:11px;'>" + htmlstring + "</body></html>";
            // string path = ConvertHTMLToPDF(htmlstring, data.Ref);
            string path = printpdf(htmlstring, data.Ref);
            if (isdispatchquotelog)
            {
                return File(path, "application/pdf", Server.UrlEncode(data.Ref + "_sample.pdf"));
            }
            return File(path, "application/pdf", Server.UrlEncode(data.CompanyName.Replace(" ", "-") + "-" + data.Ref + "_sample.pdf"));
        }

        public ActionResult GenerateReportExcel(int companyId)
        {
            var data = (from i in db.SZ_Quotation
                        join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                        where !string.IsNullOrEmpty(i.PONo) && i.CompanyId == companyId
                        orderby t2.MoveProjectDate descending
                        //&& t2.MoveToInvoice == true
                        select i).ToList();

            var model = new List<SZ_Quotation>();
            foreach (var item in data)
            {
                var isCheck = item.SZ_QuotationDetail.Where(x => string.IsNullOrEmpty(x.TrackingNo)).ToList();
                if (isCheck.Count > 0)
                {
                    model.Add(item);
                }
                else
                {
                    var maxDate = item.SZ_QuotationDetail.Max(x => x.TrackingNoDate.Value);
                    var record = item.SZ_QuotationDetail.Where(x => x.TrackingNoDate.Value == maxDate).ToList();
                    if (record != null)
                    {
                        var addInList = record.Where(x => x.TrackingNoDate.Value.AddDays(14).Date >= DateTime.Now.Date).ToList();
                        if (addInList.Count > 0)
                        {
                            model.Add(item);
                        }
                    }
                }
            }

            var result = (from i in model
                          select i).Distinct().ToList();

            ExcelPackage ExcelPkg = new ExcelPackage();
            ExcelWorksheet wsSheet1 = ExcelPkg.Workbook.Worksheets.Add("Sheet1");
            wsSheet1.DefaultColWidth = 16;
            wsSheet1.Protection.IsProtected = false;
            wsSheet1.Protection.AllowSelectLockedCells = false;
            wsSheet1.Cells.AutoFitColumns(14, 40);
            wsSheet1.Column(3).Width = 40;
            wsSheet1.Column(3).Style.WrapText = true;

            using (ExcelRange Rng = wsSheet1.Cells[1, 1, 2, 16])
            {
                Rng.Value = "SynZeal Research Pvt Ltd";
                Rng.Merge = true;
                Rng.Style.Font.Bold = true;
                Rng.Style.Font.Size = 22;
                Rng.Style.Font.Color.SetColor(Color.White);
                Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#7b7b7b");
                Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
            }

            using (ExcelRange Rng = wsSheet1.Cells[3, 1, 4, 16])
            {
                Rng.Value = "Purchase Order Status as on " + DateTime.Now.Day + "" + GetDaySuffix(DateTime.Now.Day) + " " + DateTime.Now.ToString("MMMM yy") + " / Company Name : " + data.Select(x => x.CompanyName).FirstOrDefault();
                Rng.Merge = true;
                Rng.Style.Font.Bold = true;
                Rng.Style.Font.Size = 16;
                Rng.Style.Font.Color.SetColor(Color.Black);
                Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#d0cece");
                Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
            }
            int loopCount = 5;

            wsSheet1.Cells[loopCount, 1].Value = "Sr No";
            wsSheet1.Cells[loopCount, 2].Value = "PO No";
            //wsSheet1.Cells[loopCount, 2].Value = "PO No";
            wsSheet1.Cells[loopCount, 3].Value = "PO Date";
            wsSheet1.Cells[loopCount, 4].Value = "Product Name";
            wsSheet1.Cells[loopCount, 5].Value = "Qty. (mg)";
            wsSheet1.Cells[loopCount, 6].Value = "Quote Lead Time";
            wsSheet1.Cells[loopCount, 7].Value = "CAS No";
            wsSheet1.Cells[loopCount, 8].Value = "CAT No";
            wsSheet1.Cells[loopCount, 9].Value = "Batch No";
            wsSheet1.Cells[loopCount, 10].Value = "Current Status";
            wsSheet1.Cells[loopCount, 11].Value = "Explanation";
            wsSheet1.Cells[loopCount, 12].Value = "Reason";
            wsSheet1.Cells[loopCount, 13].Value = "Estimated Completation Date";
            wsSheet1.Cells[loopCount, 14].Value = "Invoice Date";
            wsSheet1.Cells[loopCount, 15].Value = "COA Data Approved";
            wsSheet1.Cells[loopCount, 16].Value = "Dispatch Details";
            using (ExcelRange Rng = wsSheet1.Cells[loopCount, 1, loopCount, 16])
            {
                Rng.Style.Font.Bold = true;
                Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#7b7b7b");
                Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                Rng.Style.Font.Color.SetColor(Color.White);
                Rng.Style.WrapText = true;
            }
            loopCount = loopCount + 1;
            int srno = 1;
            foreach (var quote in result)
            {
                foreach (var item in quote.SZ_QuotationDetail.Where(x => x.MoveToProject == true).OrderByDescending(x => x.MoveProjectDate).ToList())
                {
                    wsSheet1.Cells[loopCount, 1].Value = srno;
                    wsSheet1.Cells[loopCount, 2].Value = quote.PONo;
                    wsSheet1.Cells[loopCount, 3].Value = quote.PODate.HasValue ? quote.PODate.Value.ToShortDateString() : "";
                    wsSheet1.Cells[loopCount, 4].Value = item.ProductName;
                    wsSheet1.Cells[loopCount, 5].Value = item.RequiredQty;
                    wsSheet1.Cells[loopCount, 6].Value = item.LeadTime;
                    wsSheet1.Cells[loopCount, 7].Value = item.CASNo;
                    wsSheet1.Cells[loopCount, 8].Value = item.CATNo;
                    wsSheet1.Cells[loopCount, 9].Value = item.BatchNo;
                    if (string.IsNullOrEmpty(item.BatchNo) && item.AdditionalBatchNo.HasValue)
                    {
                        wsSheet1.Cells[loopCount, 9].Value = db.SZ_Inventory.Where(x => x.Id == item.AdditionalBatchNo).Select(x => x.BatchNo).FirstOrDefault();
                    }

                    wsSheet1.Cells[loopCount, 10].Value = item.AdminScientistStatus;
                    wsSheet1.Cells[loopCount, 11].Value = item.Explanation;
                    wsSheet1.Cells[loopCount, 12].Value = item.Reason;
                    wsSheet1.Cells[loopCount, 13].Value = item.EstimateCompleteDate.HasValue ? item.EstimateCompleteDate.Value.ToShortDateString() : "";
                    wsSheet1.Cells[loopCount, 14].Value = item.ReportInvoiceDate;
                    wsSheet1.Cells[loopCount, 15].Value = item.COAApprovedDate.HasValue ? item.COAApprovedDate.Value.ToShortDateString() : "";
                    wsSheet1.Cells[loopCount, 16].Value = item.TrackingNo;
                    srno += 1;
                    loopCount += 1;
                }
            }
            string filePath = HostingEnvironment.MapPath("~/Content/Quotation/") + "Report-" + companyId.ToString() + "-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xlsx";
            ExcelPkg.SaveAs(new FileInfo(filePath));
            return File(filePath, "application/excel", Server.UrlEncode("Report_" + companyId.ToString().Replace("#", "_") + ".xls"));

        }

        public ActionResult PrintReportPDF(int companyId)
        {
            var data = (from i in db.SZ_Quotation
                        join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                        where !string.IsNullOrEmpty(i.PONo) && i.CompanyId == companyId
                        orderby t2.MoveProjectDate descending
                        //where !string.IsNullOrEmpty(i.PONo) && i.CompanyId == companyId
                        select i).ToList();

            var model = new List<SZ_Quotation>();
            foreach (var item in data.OrderByDescending(x => x.SZ_QuotationDetail.Select(y => y.MoveProjectDate)))
            {
                var isCheck = item.SZ_QuotationDetail.Where(x => string.IsNullOrEmpty(x.TrackingNo)).ToList();
                if (isCheck.Count > 0)
                {
                    model.Add(item);
                }
                else
                {

                    var maxDate = item.SZ_QuotationDetail.Max(x => x.TrackingNoDate.Value);
                    var record = item.SZ_QuotationDetail.Where(x => x.TrackingNoDate.Value == maxDate).ToList();
                    if (record != null)
                    {
                        var addInList = record.Where(x => x.TrackingNoDate.Value.AddDays(14).Date >= DateTime.Now.Date).ToList();
                        if (addInList.Count > 0)
                        {
                            model.Add(item);
                        }
                    }
                }
            }

            var result = (from i in model
                          select i).Distinct().ToList();

            var htmlstring = PartialViewdata(this, "_PartialPrintReport", result);
            string filename = "Report_" + DateTime.Now.ToString("dd_MM_yyyy_HH_mm_ss");
            htmlstring = "<html><head></head><body style='font-family:Tahoma, Verdana, Segoe, sans-serif;font-size:11px;'>" + htmlstring + "</body></html>";

            string path = printpdf(htmlstring, filename);
            return File(path, "application/pdf", Server.UrlEncode(filename + ".pdf"));
        }
        public ActionResult PrintExportPendingReportExcel(string Startdate, string Enddate)
        {
            var model = (from i in db.Products
                         select i).AsQueryable();
            string madeby = string.Empty;
            if (!string.IsNullOrEmpty(Startdate))
            {
                DateTime sd = Convert.ToDateTime(Startdate);
                model = model.Where(x => x.CreatedOnUtc >= sd).AsQueryable();
            }
            if (!string.IsNullOrEmpty(Enddate))
            {
                DateTime ed = Convert.ToDateTime(Enddate);
                model = model.Where(x => x.CreatedOnUtc <= ed).AsQueryable();
            }
            var outputmodel = model.ToList();
            var result = (from i in outputmodel
                          select i).Distinct().ToList();

            //if(result != null && result.Count > 0)
            //{
            //    result.ForEach(x => { 
            //        x.
            //    });
            //}

            ExcelPackage ExcelPkg = new ExcelPackage();

            var types = new List<string>();
            types.Add("All");
            types.Add("Miscellaneous");
            foreach (var itemss in types)
            {
                var newresult = new List<Product>();
                if (itemss == "All")
                {
                    newresult = result.Where(x => x.MainCatName != null && x.MainCatName.ToLower() != "miscellaneous").ToList();
                }
                else
                {
                    newresult = result.Where(x => x.MainCatName != null && x.MainCatName.ToLower() == "miscellaneous").ToList();
                }
                ExcelWorksheet wsSheet1 = ExcelPkg.Workbook.Worksheets.Add(itemss);
                wsSheet1.DefaultColWidth = 16;
                wsSheet1.Protection.IsProtected = false;
                wsSheet1.Protection.AllowSelectLockedCells = false;
                wsSheet1.Cells.AutoFitColumns(14, 40);
                wsSheet1.Column(3).Width = 40;
                wsSheet1.Column(3).Style.WrapText = true;

                int loopCount = 1;

                wsSheet1.Cells[loopCount, 1].Value = "Sr No";
                wsSheet1.Cells[loopCount, 2].Value = "Product Name";
                wsSheet1.Cells[loopCount, 3].Value = "CAT No";
                wsSheet1.Cells[loopCount, 4].Value = "CAS No";
                using (ExcelRange Rng = wsSheet1.Cells[loopCount, 1, loopCount, 4])
                {
                    Rng.Style.Font.Bold = true;
                    Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                    Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#7b7b7b");
                    Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                    Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    Rng.Style.Font.Color.SetColor(Color.White);
                    Rng.Style.WrapText = true;
                }
                loopCount = loopCount + 1;
                int srno = 1;
                foreach (var item in newresult)
                {
                    wsSheet1.Cells[loopCount, 1].Value = srno;
                    wsSheet1.Cells[loopCount, 2].Value = item.Name;
                    wsSheet1.Cells[loopCount, 3].Value = item.Sku;
                    wsSheet1.Cells[loopCount, 4].Value = item.ManufacturerPartNumber;

                    srno += 1;
                    loopCount += 1;

                }
            }
            string filePath = HostingEnvironment.MapPath("~/Content/Quotation/") + "UploadReport-" + DateTime.Now.ToShortDateString().Replace("/", "_") + "-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xlsx";
            ExcelPkg.SaveAs(new FileInfo(filePath));
            return File(filePath, "application/excel", Server.UrlEncode("UploadReport_" + DateTime.Now.ToShortDateString().Replace("#", "_") + ".xls"));

        }

        public ActionResult PrintQuotedailyReportExcel(int? CreatedBy, string Startdate, string Enddate)
        {
            var model = (from i in db.SZ_Quotation
                         select i).ToList();
            string madeby = string.Empty;
            if (CreatedBy.HasValue)
            {
                MemoryCacheManager objCache = new MemoryCacheManager();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });

                var scienList = objCache.Get("cache.GetScientistId", () =>
                {
                    return db.GetScientistId().ToList();
                });

                var sid = scienList.Where(x => x == CreatedBy).FirstOrDefault();
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == CreatedBy.Value).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                customerName = customerName.ToLower().Trim();
                model = model.Where(x => !string.IsNullOrEmpty(x.CreatedBy) && x.CreatedBy.ToLower().Trim() == customerName.ToLower().Trim()).ToList();
            }
            if (!string.IsNullOrEmpty(Startdate))
            {
                DateTime sd = Convert.ToDateTime(Startdate);
                model = model.Where(x => x.CreatedDate.Value.Date >= sd).ToList();
            }
            if (!string.IsNullOrEmpty(Enddate))
            {
                DateTime ed = Convert.ToDateTime(Enddate);
                model = model.Where(x => x.CreatedDate.Value.Date <= ed).ToList();
            }

            var result = (from i in model
                          select i).Distinct().ToList();

            ExcelPackage ExcelPkg = new ExcelPackage();
            ExcelWorksheet wsSheet1 = ExcelPkg.Workbook.Worksheets.Add("Sheet1");
            wsSheet1.DefaultColWidth = 16;
            wsSheet1.Protection.IsProtected = false;
            wsSheet1.Protection.AllowSelectLockedCells = false;
            wsSheet1.Cells.AutoFitColumns(14, 40);
            wsSheet1.Column(3).Width = 40;
            wsSheet1.Column(3).Style.WrapText = true;

            //using (ExcelRange Rng = wsSheet1.Cells[1, 1, 2, 9])
            //{
            //    Rng.Value = "SynZeal Research Pvt Ltd";
            //    Rng.Merge = true;
            //    Rng.Style.Font.Bold = true;
            //    Rng.Style.Font.Size = 22;
            //    Rng.Style.Font.Color.SetColor(Color.White);
            //    Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
            //    Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#7b7b7b");
            //    Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
            //    Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
            //}

            //using (ExcelRange Rng = wsSheet1.Cells[3, 1, 4, 9])
            //{
            //    Rng.Value = "Quote Report";
            //    Rng.Merge = true;
            //    Rng.Style.Font.Bold = true;
            //    Rng.Style.Font.Size = 16;
            //    Rng.Style.Font.Color.SetColor(Color.Black);
            //    Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
            //    Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#d0cece");
            //    Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
            //    Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
            //}
            int loopCount = 1;

            wsSheet1.Cells[loopCount, 1].Value = "Sr No";
            wsSheet1.Cells[loopCount, 2].Value = "Date";
            wsSheet1.Cells[loopCount, 3].Value = "Quote #";
            wsSheet1.Cells[loopCount, 4].Value = "Location";
            wsSheet1.Cells[loopCount, 5].Value = "Company Name";
            wsSheet1.Cells[loopCount, 6].Value = "Email";
            wsSheet1.Cells[loopCount, 7].Value = "Subject";
            wsSheet1.Cells[loopCount, 8].Value = "Product Name";
            wsSheet1.Cells[loopCount, 9].Value = "Made By";
            using (ExcelRange Rng = wsSheet1.Cells[loopCount, 1, loopCount, 9])
            {
                Rng.Style.Font.Bold = true;
                Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#7b7b7b");
                Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                Rng.Style.Font.Color.SetColor(Color.White);
                Rng.Style.WrapText = true;
            }
            loopCount = loopCount + 1;
            int srno = 1;
            foreach (var item in result)
            {
                wsSheet1.Cells[loopCount, 1].Value = srno;
                wsSheet1.Cells[loopCount, 2].Value = item.CreatedDate.HasValue ? item.CreatedDate.Value.ToShortDateString() : string.Empty;
                wsSheet1.Cells[loopCount, 3].Value = item.Ref;
                wsSheet1.Cells[loopCount, 4].Value = GetQuotePlace(item, item.SZ_QuotationDetail.OrderBy(x => x.DisplayOrder).FirstOrDefault());
                wsSheet1.Cells[loopCount, 5].Value = item.CompanyName;
                wsSheet1.Cells[loopCount, 6].Value = item.EmailAddress;
                wsSheet1.Cells[loopCount, 7].Value = item.ClientRef;
                wsSheet1.Cells[loopCount, 8].Value = item.SZ_QuotationDetail.OrderBy(x => x.DisplayOrder).Select(x => x.ProductName).FirstOrDefault();
                wsSheet1.Cells[loopCount, 9].Value = item.CreatedBy;

                srno += 1;
                loopCount += 1;

            }
            string filePath = HostingEnvironment.MapPath("~/Content/Quotation/") + "QuoteDailyReport-" + DateTime.Now.ToShortDateString().Replace("/", "_") + "-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xlsx";
            ExcelPkg.SaveAs(new FileInfo(filePath));
            return File(filePath, "application/excel", Server.UrlEncode("QuoteDailyReport_" + DateTime.Now.ToShortDateString().Replace("#", "_") + ".xls"));

        }
        public ActionResult PrintQuotedailyReportPDF(int? CreatedBy, string Startdate, string Enddate)
        {
            var model = (from i in db.SZ_Quotation
                         select i).ToList();
            string madeby = string.Empty;
            if (CreatedBy.HasValue)
            {
                MemoryCacheManager objCache = new MemoryCacheManager();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });

                var scienList = objCache.Get("cache.GetScientistId", () =>
                {
                    return db.GetScientistId().ToList();
                });

                var sid = scienList.Where(x => x == CreatedBy).FirstOrDefault();
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == sid).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                model = model.Where(x => x.CreatedBy == customerName).ToList();
            }
            if (!string.IsNullOrEmpty(Startdate))
            {
                DateTime sd = Convert.ToDateTime(Startdate);
                model = model.Where(x => x.CreatedDate.Value.Date >= sd).ToList();
            }
            if (!string.IsNullOrEmpty(Enddate))
            {
                DateTime ed = Convert.ToDateTime(Enddate);
                model = model.Where(x => x.CreatedDate.Value.Date <= ed).ToList();
            }

            var result = (from i in model
                          select i).Distinct().ToList();

            var htmlstring = PartialViewdata(this, "_PartialQuoteDailyReport", result);
            string filename = "QuoteDailyReport_" + DateTime.Now.ToString("dd_MM_yyyy_HH_mm_ss");
            htmlstring = "<html><head></head><body style='font-family:Tahoma, Verdana, Segoe, sans-serif;font-size:11px;'>" + htmlstring + "</body></html>";

            string path = printpdf(htmlstring, filename, false, true);
            return File(path, "application/pdf", Server.UrlEncode(filename + ".pdf"));
        }


        public ActionResult PrintFollowupReportExcel(int? CreatedBy, string Startdate, string Enddate)
        {

            ExcelPackage ExcelPkg = new ExcelPackage();
            List<string> countryTypeList = new List<string>();
            countryTypeList.Add("Domestic");
            countryTypeList.Add("Export");
            foreach (var countryType in countryTypeList)
            {
                var model = (from i in db.SZ_Quotation
                             join qd in db.SZ_QuotationDetail on i.Id equals qd.QuoteId
                             where i.IsFollowupRequired.HasValue && i.IsFollowupRequired == true
                              && (i.IsToBe == null || i.IsToBe == false)
                              && (i.IsPark == false || i.IsPark == null)
                              && !i.CompanyName.Contains("synzeal")
                              && (i.IsRemoveFollowup == null || i.IsRemoveFollowup == false)
                              //&& string.IsNullOrEmpty(i.PONo)
                              && i.CountryType == countryType
                             && !string.IsNullOrEmpty(i.ApprovedBy)
                             select qd).ToList();
                string madeby = string.Empty;
                if (CreatedBy.HasValue)
                {
                    model = model.Where(x => x.SZ_Quotation.CompanyId == CreatedBy).ToList();
                }
                if (!string.IsNullOrEmpty(Startdate))
                {
                    DateTime sd = Convert.ToDateTime(Startdate);
                    model = model.Where(x => x.CreatedDate.Date >= sd).ToList();
                }
                if (!string.IsNullOrEmpty(Enddate))
                {
                    DateTime ed = Convert.ToDateTime(Enddate);
                    model = model.Where(x => x.CreatedDate.Date <= ed).ToList();
                }

                var result = (from i in model
                              select i).Distinct().ToList();


                ExcelWorksheet wsSheet1 = ExcelPkg.Workbook.Worksheets.Add(countryType);
                wsSheet1.DefaultColWidth = 16;
                wsSheet1.Protection.IsProtected = false;
                wsSheet1.Protection.AllowSelectLockedCells = false;
                wsSheet1.Cells.AutoFitColumns(14, 40);
                wsSheet1.Column(3).Width = 40;
                wsSheet1.Column(3).Style.WrapText = true;

                int loopCount = 1;

                wsSheet1.Cells[loopCount, 1].Value = "Sr No";
                wsSheet1.Cells[loopCount, 2].Value = "Date";
                wsSheet1.Cells[loopCount, 3].Value = "Quote #";
                wsSheet1.Cells[loopCount, 4].Value = "Type";
                wsSheet1.Cells[loopCount, 5].Value = "Company Name";
                wsSheet1.Cells[loopCount, 6].Value = "Email";
                wsSheet1.Cells[loopCount, 7].Value = "Subject";
                wsSheet1.Cells[loopCount, 8].Value = "Product Name";
                wsSheet1.Cells[loopCount, 9].Value = "CAT No";
                wsSheet1.Cells[loopCount, 10].Value = "CAS No";
                wsSheet1.Cells[loopCount, 11].Value = "Price 1";
                wsSheet1.Cells[loopCount, 12].Value = "Price 2";
                wsSheet1.Cells[loopCount, 13].Value = "Price 3";
                wsSheet1.Cells[loopCount, 14].Value = "Price 4";
                wsSheet1.Cells[loopCount, 15].Value = "Lead Time";
                wsSheet1.Cells[loopCount, 16].Value = "Final Price";
                wsSheet1.Cells[loopCount, 17].Value = "Product Remark";
                using (ExcelRange Rng = wsSheet1.Cells[loopCount, 1, loopCount, 17])
                {
                    Rng.Style.Font.Bold = true;
                    Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                    Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#7b7b7b");
                    Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                    Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    Rng.Style.Font.Color.SetColor(Color.White);
                    Rng.Style.WrapText = true;
                }
                loopCount = loopCount + 1;
                int srno = 1;
                List<int> quoteids = result.Select(x => x.QuoteId).Distinct().ToList();

                foreach (var qid in quoteids)
                {
                    int price1total = 0;
                    int price2total = 0;
                    int price3total = 0;
                    int price4total = 0;
                    var filteritem = result.Where(x => x.QuoteId == qid).ToList();
                    foreach (var item in filteritem)
                    {
                        if (item.MoveToProject.HasValue && item.MoveToProject.Value)
                        {
                            using (ExcelRange Rng = wsSheet1.Cells[loopCount, 1, loopCount, 17])
                            {
                                Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                                Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#43F7EF");
                                Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                            }
                        }
                        List<string> pricedata = new List<string>();
                        if (!string.IsNullOrEmpty(item.Price))
                        {
                            pricedata = item.Price.Split(',').ToList();
                        }
                        wsSheet1.Cells[loopCount, 1].Value = srno;
                        wsSheet1.Cells[loopCount, 2].Value = item.CreatedDate.ToShortDateString();
                        wsSheet1.Cells[loopCount, 3].Value = item.SZ_Quotation.Ref;
                        wsSheet1.Cells[loopCount, 4].Value = item.SZ_Quotation.CountryType;
                        wsSheet1.Cells[loopCount, 5].Value = item.SZ_Quotation.CompanyName;
                        wsSheet1.Cells[loopCount, 6].Value = item.SZ_Quotation.EmailAddress;
                        wsSheet1.Cells[loopCount, 7].Value = item.SZ_Quotation.ClientRef;
                        wsSheet1.Cells[loopCount, 8].Value = item.ProductName;
                        wsSheet1.Cells[loopCount, 9].Value = item.CATNo;
                        wsSheet1.Cells[loopCount, 10].Value = item.CASNo;
                        if (pricedata != null && pricedata.Count > 0)
                        {
                            wsSheet1.Cells[loopCount, 11].Value = pricedata[0];
                            var price1str = pricedata[0].GetPriceFromPriceString();
                            if (!string.IsNullOrEmpty(price1str))
                            {
                                price1total += Convert.ToInt32(price1str);
                            }
                        }
                        else
                        {
                            wsSheet1.Cells[loopCount, 11].Value = "";
                        }
                        if (pricedata != null && pricedata.Count > 1)
                        {
                            wsSheet1.Cells[loopCount, 12].Value = pricedata[1];
                            var price2str = pricedata[1].GetPriceFromPriceString();
                            if (!string.IsNullOrEmpty(price2str))
                            {
                                price2total += Convert.ToInt32(price2str);
                            }
                        }
                        else
                        {
                            wsSheet1.Cells[loopCount, 12].Value = "";
                        }
                        if (pricedata != null && pricedata.Count > 2)
                        {
                            wsSheet1.Cells[loopCount, 13].Value = pricedata[2];
                            var price3str = pricedata[2].GetPriceFromPriceString();
                            if (!string.IsNullOrEmpty(price3str))
                            {
                                price3total += Convert.ToInt32(price3str);
                            }
                        }
                        else
                        {
                            wsSheet1.Cells[loopCount, 13].Value = "";
                        }
                        if (pricedata != null && pricedata.Count > 3)
                        {
                            wsSheet1.Cells[loopCount, 14].Value = pricedata[3];
                            var price4str = pricedata[3].GetPriceFromPriceString();
                            if (!string.IsNullOrEmpty(price4str))
                            {
                                price4total += Convert.ToInt32(price4str);
                            }
                        }
                        else
                        {
                            wsSheet1.Cells[loopCount, 14].Value = "";
                        }

                        wsSheet1.Cells[loopCount, 15].Value = item.LeadTime;
                        wsSheet1.Cells[loopCount, 16].Value = item.FinalPrice;
                        wsSheet1.Cells[loopCount, 17].Value = item.ProductRemark;
                        srno += 1;
                        loopCount += 1;
                    }

                    using (ExcelRange Rng = wsSheet1.Cells[loopCount, 1, loopCount, 17])
                    {
                        Rng.Style.Font.Bold = true;
                        Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                        Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#7b7b7b");
                        Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                        Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        Rng.Style.Font.Color.SetColor(Color.White);
                    }
                    wsSheet1.Cells[loopCount, 1].Value = srno;
                    wsSheet1.Cells[loopCount, 2].Value = filteritem[0].SZ_Quotation.CreatedDate.Value.ToShortDateString();
                    wsSheet1.Cells[loopCount, 3].Value = filteritem[0].SZ_Quotation.Ref;
                    wsSheet1.Cells[loopCount, 4].Value = filteritem[0].SZ_Quotation.CountryType;
                    wsSheet1.Cells[loopCount, 5].Value = filteritem[0].SZ_Quotation.CompanyName;
                    wsSheet1.Cells[loopCount, 6].Value = filteritem[0].SZ_Quotation.EmailAddress;
                    wsSheet1.Cells[loopCount, 7].Value = filteritem[0].SZ_Quotation.ClientRef;
                    wsSheet1.Cells[loopCount, 8].Value = "-";
                    wsSheet1.Cells[loopCount, 9].Value = "-";
                    wsSheet1.Cells[loopCount, 10].Value = "-";
                    wsSheet1.Cells[loopCount, 11].Value = price1total;
                    wsSheet1.Cells[loopCount, 12].Value = price2total;
                    wsSheet1.Cells[loopCount, 13].Value = price3total;
                    wsSheet1.Cells[loopCount, 14].Value = price4total;
                    wsSheet1.Cells[loopCount, 15].Value = "-";
                    loopCount += 1;
                    srno += 1;
                }
            }

            string filePath = HostingEnvironment.MapPath("~/Content/Quotation/") + "FollowupReport-" + DateTime.Now.ToShortDateString().Replace("/", "_") + "-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xlsx";
            ExcelPkg.SaveAs(new FileInfo(filePath));
            return File(filePath, "application/excel", Server.UrlEncode("FollowupReport_" + DateTime.Now.ToShortDateString().Replace("#", "_") + ".xls"));

        }

        public ActionResult PrintFollowupReportPDF(int? CreatedBy, string Startdate, string Enddate)
        {
            var model = (from i in db.SZ_Quotation
                         join qd in db.SZ_QuotationDetail on i.Id equals qd.QuoteId
                         where i.IsFollowupRequired.HasValue && i.IsFollowupRequired == true
                          && (i.IsToBe == null || i.IsToBe == false) && (i.IsPark == false || i.IsPark == null) && !i.CompanyName.Contains("synzeal") && (i.IsRemoveFollowup == null || i.IsRemoveFollowup == false)
                          && string.IsNullOrEmpty(i.PONo)
                         select qd).ToList();
            string madeby = string.Empty;
            if (CreatedBy.HasValue)
            {
                model = model.Where(x => x.SZ_Quotation.CompanyId == CreatedBy).ToList();
            }
            if (!string.IsNullOrEmpty(Startdate))
            {
                DateTime sd = Convert.ToDateTime(Startdate);
                model = model.Where(x => x.CreatedDate.Date >= sd).ToList();
            }
            if (!string.IsNullOrEmpty(Enddate))
            {
                DateTime ed = Convert.ToDateTime(Enddate);
                model = model.Where(x => x.CreatedDate.Date <= ed).ToList();
            }

            var result = (from i in model
                          select i).Distinct().ToList();

            var htmlstring = PartialViewdata(this, "_PartialFollowupReport", result);
            string filename = "FollowupReport_" + DateTime.Now.ToString("dd_MM_yyyy_HH_mm_ss");
            htmlstring = "<html><head></head><body style='font-family:Tahoma, Verdana, Segoe, sans-serif;font-size:11px;'>" + htmlstring + "</body></html>";

            string path = printpdf(htmlstring, filename, false, true);
            return File(path, "application/pdf", Server.UrlEncode(filename + ".pdf"));
        }

        public string GetDaySuffix(int day)
        {
            switch (day)
            {
                case 1:
                case 21:
                case 31:
                    return "st";
                case 2:
                case 22:
                    return "nd";
                case 3:
                case 23:
                    return "rd";
                default:
                    return "th";
            }
        }
        public string printpdf(string html, string LessonOrder_id, bool isReturnPath = false, bool isLandscap = false)
        {
            string filePath = HostingEnvironment.MapPath("~/Content/Quotation/");

            //Create a new stylesheet
            iTextSharp.text.html.simpleparser.StyleSheet ST = new iTextSharp.text.html.simpleparser.StyleSheet();
            //Set the default body font to our registered font's internal name
            ST.LoadTagStyle(iTextSharp.text.html.HtmlTags.LI, iTextSharp.text.html.HtmlTags.FACE, "Verdana");
            ST.LoadTagStyle(iTextSharp.text.html.HtmlTags.LI, iTextSharp.text.html.HtmlTags.COLOR, "5c5c5c");
            ST.LoadTagStyle(iTextSharp.text.html.HtmlTags.LI, iTextSharp.text.html.HtmlTags.SIZE, "2");

            ST.LoadTagStyle(iTextSharp.text.html.HtmlTags.TABLE, iTextSharp.text.html.HtmlTags.FACE, "Verdana");
            ST.LoadTagStyle(iTextSharp.text.html.HtmlTags.TABLE, iTextSharp.text.html.HtmlTags.COLOR, "5c5c5c");
            ST.LoadTagStyle(iTextSharp.text.html.HtmlTags.TABLE, iTextSharp.text.html.HtmlTags.SIZE, "2");
            ST.LoadStyle("innertbl > table", "border", "1px solid #5c5c5c");
            ST.LoadStyle("innertbl > table", "margin", "0 0 0 20px");

            if (System.IO.File.Exists(filePath + "\\" + LessonOrder_id + ".pdf"))
            {
                try
                {
                    System.IO.File.Delete(filePath + "\\" + LessonOrder_id + ".pdf");
                }
                catch (Exception)
                {

                    System.IO.File.Move(filePath + "\\" + LessonOrder_id + ".pdf", filePath + "\\" + LessonOrder_id + "_" + DateTime.Now.ToString().Replace(":", "_").Replace(" ", "_").Replace("/", "_").Replace(@"\", "_") + ".pdf");

                    //if (isReturnPath)
                    //{
                    //    return "/Content/Quotation/" + LessonOrder_id + ".pdf";
                    //}
                    //return filePath + "\\" + LessonOrder_id + ".pdf";
                }
            }

            string htmlText = html.ToString().Replace("\"", "'").Replace("<hr style='height: 3px; border: none; background-color: #6AACE1;' />", "").Replace("<hr style='padding-left: 15px;' />", "");
            Document document = new Document();
            document = new Document(iTextSharp.text.PageSize.A4, 15, 15, 15, 15);

            if (isLandscap)
            {
                document.SetPageSize(iTextSharp.text.PageSize.A4.Rotate());
            }
            FontFactory.GetFont("Verdana", 50, iTextSharp.text.BaseColor.BLUE);
            if (System.IO.File.Exists(filePath + "\\" + LessonOrder_id + ".pdf"))
            {
                System.IO.File.Delete(filePath + "\\" + LessonOrder_id + ".pdf");
            }

            PdfWriter writer = PdfWriter.GetInstance(document, new FileStream(filePath + "\\" + LessonOrder_id + ".pdf", FileMode.Create));
            writer.SetPdfVersion(PdfWriter.PDF_VERSION_1_5);
            writer.CompressionLevel = PdfStream.BEST_COMPRESSION;
            writer.SetFullCompression();
            document.Open();
            Document.Compress = true;
            using (TextReader htmlViewReader = new StringReader(htmlText))
            {
                using (var htmlWorker = new HTMLWorkerExtended(document))
                {
                    htmlWorker.Open();
                    htmlWorker.Parse(htmlViewReader);
                }
            }

            document.Close();

            if (isReturnPath)
            {
                return "/Content/Quotation/" + LessonOrder_id + ".pdf";
            }
            return filePath + "\\" + LessonOrder_id + ".pdf";

        }

        public string printpdfsecondway(string html, string LessonOrder_id)
        {
            //Create a byte array that will eventually hold our final PDF
            Byte[] bytes;
            string filePath = HostingEnvironment.MapPath("~/Content/Quotation/");

            //Boilerplate iTextSharp setup here
            //Create a stream that we can write to, in this case a MemoryStream
            using (var ms = new MemoryStream())
            {

                //Create an iTextSharp Document which is an abstraction of a PDF but **NOT** a PDF

                using (var doc = new Document())
                {

                    //Create a writer that's bound to our PDF abstraction and our stream
                    using (var writer = PdfWriter.GetInstance(doc, new FileStream(filePath + "\\" + LessonOrder_id + ".pdf", FileMode.Create)))
                    {

                        //Open the document for writing
                        doc.Open();

                        //Our sample HTML and CSS
                        var example_html = html;
                        var example_css = @"#page_1 #p1dimg1,#page_1 #p1dimg1 #p1img1{width:816px;height:529px}#page_1,#page_1 #id_1,#page_1 #id_1 #id_1_1,#page_1 #id_1 #id_1_2,#page_1 #id_2,#page_1 #id_3,.dclr{padding:0;overflow:hidden}.ft0,.ft14,.ft15,.ft4{text-decoration:underline}.td0,.td1,.td2,.td3,.td4,.td5{vertical-align:bottom}body{margin-top:0;margin-left:0}#page_1{position:relative;margin:10px 0 105px;border:none;width:816px}#page_1 #id_1{margin:5px 0 0 238px;border:none;width:578px}#page_1 #id_1 #id_1_1{float:left;margin:0;border:none;width:398px}#page_1 #id_1 #id_1_2{float:left;margin:30px 0 0;border:none;width:180px}#page_1 #id_2{margin:14px 0 0 13px;border:none;width:803px}#page_1 #id_3{margin:43px 0 0 47px;border:none;width:696px}.p0,.p1,.p2,.p3,.p4,.p5,.p6,.p7{margin-bottom:0;text-align:left}.td10,.td23{border-bottom:#000 1px solid}#page_1 #p1dimg1{position:absolute;top:0;left:0;z-index:-1}.dclr{clear:both;float:none;height:1px;margin:0}.ft0{font:37px Calibri;line-height:42px}.ft1{font:19px Calibri;line-height:23px}.ft2{font:9px Calibri;line-height:11px;position:relative;bottom:5px}.ft3{font:15px Calibri;line-height:18px}.ft4{font:700 19px Calibri;line-height:23px}.ft5{font:16px Calibri;line-height:19px}.ft6{font:700 15px Calibri;line-height:18px}.ft7{font:1px Calibri;line-height:1px}.ft14,.ft8{font:700 15px Calibri}.ft8{line-height:16px}.ft9{font:1px Calibri;line-height:8px}.ft10{font:700 27px Calibri;line-height:33px}.ft11,.ft17{font:1px Calibri}.ft11{line-height:9px}.ft12{font:700 14px Calibri;line-height:17px}.ft13{font:15px Wingdings;line-height:16px}.ft14{margin-left:11px;line-height:18px}.ft15{font:700 15px Calibri;line-height:18px}.ft16{font:15px 'Times New Roman';line-height:17px}.ft17{line-height:10px}.ft18{font:1px Calibri;line-height:11px}.p0{margin-top:0}.p1{padding-left:46px;margin-top:10px}.p2{padding-left:45px;margin-top:0}.p3{margin-top:6px}.p4{padding-left:294px;margin-top:0}.p5{padding-left:312px;margin-top:1px}.p6{padding-left:59px;margin-top:43px}.p7{margin-top:0;white-space:nowrap}.p8{text-align:left;padding-left:105px;margin-top:0;margin-bottom:0;white-space:nowrap}.p10,.p9{text-align:right;margin-top:0;white-space:nowrap;margin-bottom:0}.p9{padding-right:18px}.p10{padding-right:20px}.p11{text-align:left;padding-left:174px;margin-top:0;margin-bottom:0;white-space:nowrap}.p12{text-align:right;padding-right:17px;margin-top:0;margin-bottom:0;white-space:nowrap}.p13,.p14{text-align:center;margin-top:0;white-space:nowrap}.p13{padding-left:18px;margin-bottom:0}.p14{padding-left:17px;margin-bottom:0}.p15,.p16,.p17{text-align:left;margin-bottom:0}.p15{padding-left:35px;margin-top:47px}.p16{padding-left:1px;margin-top:0;white-space:nowrap}.p17{padding-left:35px;margin-top:18px}.p18,.p19{text-align:left;padding-left:83px}.p18{margin-top:1px;margin-bottom:0}.p19{margin-top:3px;margin-bottom:0}.p20,.p21,.p22{text-align:left;margin-top:0;margin-bottom:0;white-space:nowrap}.p20{padding-left:43px}.p21{padding-left:66px}.p22{padding-left:59px}.td0,.td1,.td2,.td3,.td4,.td5,.td6{padding:0;margin:0}.td0{width:0}.td1{width:85px}.td2{width:49px}.td3{width:652px}.td4{width:141px}.td5{width:511px}.td6{border-right:#000 1px solid;width:140px;vertical-align:bottom}.td7,.td8{width:510px;border-right:#000 1px solid;padding:0;margin:0;vertical-align:bottom}.td7{border-top:#000 1px solid}.td9{padding:0;margin:0;width:134px;vertical-align:bottom}.td10{border-right:#000 1px solid;padding:0;margin:0;width:510px;vertical-align:bottom}.td11{padding:0;margin:0;width:87px;vertical-align:bottom}.td12{padding:0;margin:0;width:47px;vertical-align:bottom}.td13{padding:0;margin:0;width:630px;vertical-align:bottom}.td14{padding:0;margin:0;width:24px;vertical-align:bottom}.td15{padding:0;margin:0;width:168px;vertical-align:bottom}.td16{padding:0;margin:0;width:9px;vertical-align:bottom}.td17{padding:0;margin:0;width:189px;vertical-align:bottom}.td18{padding:0;margin:0;width:8px;vertical-align:bottom}.td19{padding:0;margin:0;width:165px;vertical-align:bottom}.td20{padding:0;margin:0;width:184px;vertical-align:bottom}.td21{padding:0;margin:0;width:81px;vertical-align:bottom}.td22{padding:0;margin:0;width:63px;vertical-align:bottom}.td23{padding:0;margin:0;width:184px;vertical-align:bottom}.tr0{height:16px}.tr1{height:8px}.tr2{height:34px}.tr3{height:35px}.tr4{height:37px}.tr5{height:28px}.tr6{height:54px}.tr7{height:26px}.tr8{height:9px}.tr9{height:30px}.tr10{height:33px}.tr11{height:18px}.tr12{height:20px}.tr13{height:19px}.tr14{height:24px}.tr15{height:10px}.tr16{height:11px}.t0{width:786px;margin-left:4px;font:700 15px Calibri}.t2,.t3{margin-left:83px}.t1{width:764px;margin-top:13px;font:700 14px Calibri}.t2,.t3,.t4{font:15px Calibri}.t2{width:201px}.t3{width:197px}.t4{width:696px}";

                        /**************************************************
                         * Example #1                                     *
                         *                                                *
                         * Use the built-in HTMLWorker to parse the HTML. *
                         * Only inline CSS is supported.                  *
                         * ************************************************/

                        //Create a new HTMLWorker bound to our document
                        using (var htmlWorker = new iTextSharp.text.html.simpleparser.HTMLWorker(doc))
                        {

                            //HTMLWorker doesn't read a string directly but instead needs a TextReader (which StringReader subclasses)
                            using (var sr = new StringReader(example_html))
                            {

                                //Parse the HTML
                                htmlWorker.Parse(sr);
                            }
                        }

                        /**************************************************
                         * Example #2                                     *
                         *                                                *
                         * Use the XMLWorker to parse the HTML.           *
                         * Only inline CSS and absolutely linked          *
                         * CSS is supported                               *
                         * ************************************************/

                        //XMLWorker also reads from a TextReader and not directly from a string
                        using (var srHtml = new StringReader(example_html))
                        {

                            //Parse the HTML
                            iTextSharp.tool.xml.XMLWorkerHelper.GetInstance().ParseXHtml(writer, doc, srHtml);
                        }

                        /**************************************************
                         * Example #3                                     *
                         *                                                *
                         * Use the XMLWorker to parse HTML and CSS        *
                         * ************************************************/

                        //In order to read CSS as a string we need to switch to a different constructor
                        //that takes Streams instead of TextReaders.
                        //Below we convert the strings into UTF8 byte array and wrap those in MemoryStreams
                        using (var msCss = new MemoryStream(System.Text.Encoding.UTF8.GetBytes(example_css)))
                        {
                            using (var msHtml = new MemoryStream(System.Text.Encoding.UTF8.GetBytes(example_html)))
                            {

                                //Parse the HTML
                                iTextSharp.tool.xml.XMLWorkerHelper.GetInstance().ParseXHtml(writer, doc, msHtml, msCss);
                            }
                        }


                        doc.Close();
                    }
                }

                //After all of the PDF "stuff" above is done and closed but **before** we
                //close the MemoryStream, grab all of the active bytes from the stream
                bytes = ms.ToArray();
            }

            //Now we just need to do something with those bytes.
            //Here I'm writing them to disk but if you were in ASP.Net you might Response.BinaryWrite() them.
            //You could also write the bytes to a database in a varbinary() column (but please don't) or you
            //could pass them to another function for further PDF processing.
            // var testFile = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.Desktop), "test.pdf");
            System.IO.File.WriteAllBytes(filePath + "\\" + LessonOrder_id + ".pdf", bytes);
            return filePath + "\\" + LessonOrder_id + ".pdf";
        }

        public string PartialViewdata(Controller controller, string viewName, object model)
        {
            controller.ViewData.Model = model;

            using (var sw = new StringWriter())
            {
                var viewResult = ViewEngines.Engines.FindPartialView(controller.ControllerContext, viewName);
                var viewContext = new ViewContext(controller.ControllerContext, viewResult.View, controller.ViewData, controller.TempData, sw);

                viewResult.View.Render(viewContext, sw);
                viewResult.ViewEngine.ReleaseView(controller.ControllerContext, viewResult.View);

                return sw.ToString();
            }
        }

        public ActionResult Quotation(int id = 0, bool isclubquote = false)
        {
            if (!SessionCookieManagement.IsLogin)
            {
                return RedirectToAction("Index", "Home");
            }

            var listItems = new List<SelectListItem>();
            listItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var terms = db.SZ_Terms.ToList();
            foreach (var term in terms)
            {
                listItems.Add(new SelectListItem
                {
                    Text = term.Name,
                    Value = term.Id.ToString()
                });
            }

            ViewBag.termsList = listItems;

            var listCompItems = new List<SelectListItem>();
            listCompItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var compData = db.SZ_CompanyList.OrderBy(x => x.Name).ToList();
            foreach (var term in compData)
            {
                listCompItems.Add(new SelectListItem
                {
                    Text = term.Name,
                    Value = term.Id.ToString()
                });
            }

            ViewBag.listCompItems = listCompItems;

            var model = _operationRepository.GetQuoteByID(id);
            if (model == null)
            {
                model = new SZ_Quotation();
                model.PODate = DateTime.Now;
            }

            ViewBag.IsClubQuote = isclubquote;
            ViewBag.QuoteId = id;

            return View(model);
        }

        public ActionResult CompanyDetailDashboard(int id)
        {
            if (!SessionCookieManagement.IsLogin)
            {
                return RedirectToAction("Index", "Home");
            }
            if (!SessionCookieManagement.IsAdmin && !SessionCookieManagement.IsQuote)
            {
                return RedirectToAction("Index", "Home");
            }

            ViewBag.CompanyId = id;
            ViewBag.CompanyName = db.SZ_CompanyList.Where(x => x.Id == id).Select(x => x.Name).FirstOrDefault();
            var categorylist = db.Categories.Where(x => x.ParentCategoryId == 0).ToList();
            var allProList = (from c in db.Categories
                              join cp in db.Product_Category_Mapping on c.Id equals cp.CategoryId
                              join p in db.Products on cp.ProductId equals p.Id
                              join i in db.SZ_Inventory on p.Id equals i.ProductId
                              join qd in db.SZ_QuoteDetailForm on i.BatchNo equals qd.BatchCode
                              join t3 in db.SZ_QuoteDetails_Form on qd.Id equals t3.FormId
                              join qdd in db.SZ_QuotationDetail on t3.QuoteDetailsId equals qdd.Id
                              join q in db.SZ_Quotation on qdd.QuoteId equals q.Id
                              where q.CompanyId == id
                              orderby qdd.CreatedDate descending
                              select new ScientistDetailDashboardModel()
                              {
                                  ScientistName = qd.ScientistName,
                                  ParentCategoryId = c.ParentCategoryId,
                                  DiffLevel = p.DifficultyLevel,
                                  ProductName = qd.ProductName,
                                  QuantityDemand = qdd.RequiredQty,
                                  Quantity = qd.Qty,
                                  SubmitedDate = qd.CreatedDate,
                                  ScientistDate = qdd.MoveToScientistDate,
                                  //Duration = SZ_Helper.GetStringDateDiffrance(qdd.MoveToScientistDate.Value, qd.CreatedDate),
                                  QuotedLeadTime = qdd.LeadTime,
                                  PONumber = qdd.SZ_Quotation.PONo,
                                  FinalRoute = qd.NoOfFinalStep,
                                  EarlierSynthesized = qd.EarlierSynthesized,
                                  PurificationBy = qd.PurificationBy,
                                  APIcategory = c.Name,
                                  SpeDataAttachment = qd.SpectralDataAttachment
                              }).ToList();

            foreach (var item in allProList)
            {
                if (item.ScientistDate.HasValue)
                {
                    item.Duration = SZ_Helper.GetStringDateDiffrance(item.ScientistDate.Value, item.SubmitedDate);
                }
                item.APIcategory = categorylist.Where(x => x.Id == item.ParentCategoryId).Select(x => x.Name).FirstOrDefault();
                if (item.SpeDataAttachment != null)
                {
                    item.SpeDataAttachment = "<a download href='" + item.SpeDataAttachment.Replace("..", "") + "' ><i class='fa fa-download'></i></a>";
                }
            }

            return View(allProList);
        }

        public ActionResult LoadCompanyDetailDashboard(int id)
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                int numberOfObjectsPerPage = Convert.ToInt32(Request.Form["length"]);
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int pageNo = 1;
                if (skip > 0)
                {
                    pageNo = (skip / numberOfObjectsPerPage) + 1;
                }
                int? recordsTotal = 0;
                var categorylist = db.Categories.Where(x => x.ParentCategoryId == 0).ToList();
                MemoryCacheManager objCache = new MemoryCacheManager();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });

                var scienList = objCache.Get("cache.GetScientistId", () =>
                {
                    return db.GetScientistId().ToList();
                });

                var sid = scienList.Where(x => x == id).FirstOrDefault();
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == sid).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                ViewBag.ScientistName = customerName;

                customerName = customerName.ToLower().Trim();
                var allProList = (from c in db.Categories
                                  join cp in db.Product_Category_Mapping on c.Id equals cp.CategoryId
                                  join p in db.Products on cp.ProductId equals p.Id
                                  join i in db.SZ_Inventory on p.Id equals i.ProductId
                                  join qd in db.SZ_QuoteDetailForm on i.BatchNo equals qd.BatchCode
                                  join t3 in db.SZ_QuoteDetails_Form on qd.Id equals t3.FormId
                                  join qdd in db.SZ_QuotationDetail on t3.QuoteDetailsId equals qdd.Id
                                  join q in db.SZ_Quotation on qdd.QuoteId equals q.Id
                                  where q.CompanyId == id
                                  orderby qdd.CreatedDate descending
                                  select new ScientistDetailDashboardModel()
                                  {
                                      ScientistName = qd.ScientistName,
                                      DiffLevel = qdd.DifficultyLevel,
                                      ProductName = qd.ProductName,
                                      QuantityDemand = qdd.RequiredQty,
                                      Quantity = qd.Qty,
                                      SubmitedDate = qd.CreatedDate,
                                      ScientistDate = qdd.MoveToScientistDate,
                                      //Duration = SZ_Helper.GetStringDateDiffrance(qdd.MoveToScientistDate.Value, qd.CreatedDate),
                                      QuotedLeadTime = qdd.LeadTime,
                                      PONumber = qdd.SZ_Quotation.PONo,
                                      FinalRoute = qd.NoOfFinalStep,
                                      EarlierSynthesized = qd.EarlierSynthesized,
                                      PurificationBy = qd.PurificationBy,
                                      APIcategory = c.Name,
                                      SpeDataAttachment = qd.SpectralDataAttachment,
                                  }).ToList();


                foreach (var item in allProList)
                {
                    if (item.ScientistDate.HasValue)
                    {
                        item.Duration = SZ_Helper.GetStringDateDiffrance(item.ScientistDate.Value, item.SubmitedDate);
                    }
                    item.APIcategory = categorylist.Where(x => x.Id == item.ParentCategoryId).Select(x => x.Name).FirstOrDefault();
                    if (item.SpeDataAttachment != null)
                    {
                        item.SpeDataAttachment = "<a download href='" + item.SpeDataAttachment.Replace("..", "") + "' ><i class='fa fa-download'></i></a>";
                    }
                }
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    allProList = allProList.Where(m => (m.ScientistName != null && m.ScientistName.ToLower().Contains(searchValue)) ||
                                            (m.SubmitedDateText != null && m.SubmitedDateText.ToLower().Contains(searchValue)) ||
                                            (m.SubScientistName != null && m.SubScientistName.ToLower().Contains(searchValue)) ||
                                            (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue)) ||
                                            (m.Quantity != null && m.Quantity.ToLower().Contains(searchValue)) ||
                                             (m.QuantityDemand != null && m.QuantityDemand.ToLower().Contains(searchValue)) ||
                                             (m.QuotedLeadTime != null && m.QuotedLeadTime.ToLower().Contains(searchValue)) ||
                                             (m.PONumber != null && m.PONumber.ToLower().Contains(searchValue)) ||
                                             (m.EarlierSynthesized != null && m.EarlierSynthesized.ToLower().Contains(searchValue)) ||
                                             (m.Duration != null && m.Duration.ToLower().Contains(searchValue)) ||
                                             (m.PurificationBy != null && m.PurificationBy.ToLower().Contains(searchValue))
                                       ).ToList();
                }

                var allRecords = allProList;
                recordsTotal = allProList.Count();
                allProList = allProList.Skip((pageNo - 1) * numberOfObjectsPerPage).Take(numberOfObjectsPerPage).ToList();

                var jsonResult = Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = allProList, allRecords = allRecords }, JsonRequestBehavior.AllowGet);
                jsonResult.MaxJsonLength = int.MaxValue;
                return jsonResult;
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        public ActionResult ScientistDashboardDetail(int id)
        {
            if (!SessionCookieManagement.IsLogin)
            {
                return RedirectToAction("Index", "Home");
            }
            if (!SessionCookieManagement.IsAdmin && !SessionCookieManagement.IsQuote)
            {
                return RedirectToAction("Index", "Home");
            }
            ViewBag.ScientistId = id;
            MemoryCacheManager objCache = new MemoryCacheManager();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });

            string customerName = string.Empty;
            var genericAttr = genericData.Where(x => x.EntityId == id).ToList();
            if (genericAttr.Count > 0)
            {
                customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
            }
            ViewBag.ScientistName = customerName;

            return View(new List<ScientistDetailDashboardModel>());
        }

        public ActionResult saveEmailTotal(int totalemail, int days)
        {
            var startDate = new DateTime();
            var endDate = new DateTime();
            if (days == 1)
            {
                startDate = DateTime.Now.AddDays(-1);
                endDate = DateTime.Now.AddDays(-1);
            }
            else
            {
                startDate = DateTime.Now;
                endDate = DateTime.Now;
            }
            TimeSpan duration = new TimeSpan(0, 0, 0);
            TimeSpan endduration = new TimeSpan(23, 59, 59);
            startDate = startDate.Date + duration;
            endDate = endDate.Date + endduration;
            var quotesummarycurrent = db.SZ_QuoteSummary.Where(x => x.Username == "Total" && x.StartDate >= startDate && x.EndDate <= endDate).FirstOrDefault();
            if (quotesummarycurrent != null)
            {
                //Update
                quotesummarycurrent.Clarification = totalemail;
                db.Entry<SZ_QuoteSummary>(quotesummarycurrent).State = EntityState.Modified;
                db.SaveChanges();
            }
            else
            {
                //Insert
                quotesummarycurrent = new SZ_QuoteSummary();
                quotesummarycurrent.UserId = 0;
                quotesummarycurrent.Username = "Total";
                quotesummarycurrent.StartDate = startDate;
                quotesummarycurrent.EndDate = startDate;
                quotesummarycurrent.UpdatedUsername = SessionCookieManagement.UserName;
                quotesummarycurrent.Clarification = totalemail;
                db.Entry<SZ_QuoteSummary>(quotesummarycurrent).State = EntityState.Added;
                db.SaveChanges();
            }

            return Json("success", JsonRequestBehavior.AllowGet);
        }


        public ActionResult saveRegrettedTotal(int totalRegretted, int days)
        {
            var startDate = new DateTime();
            var endDate = new DateTime();
            if (days == 1)
            {
                startDate = DateTime.Now.AddDays(-1);
                endDate = DateTime.Now.AddDays(-1);
            }
            else
            {
                startDate = DateTime.Now;
                endDate = DateTime.Now;
            }
            TimeSpan duration = new TimeSpan(0, 0, 0);
            TimeSpan endduration = new TimeSpan(23, 59, 59);
            startDate = startDate.Date + duration;
            endDate = endDate.Date + endduration;
            var quotesummarycurrent = db.SZ_QuoteSummary.Where(x => x.Username == "Regretted" && x.StartDate >= startDate && x.EndDate <= endDate).FirstOrDefault();
            if (quotesummarycurrent != null)
            {
                //Update
                quotesummarycurrent.Clarification = totalRegretted;
                db.Entry<SZ_QuoteSummary>(quotesummarycurrent).State = EntityState.Modified;
                db.SaveChanges();
            }
            else
            {
                //Insert
                quotesummarycurrent = new SZ_QuoteSummary();
                quotesummarycurrent.UserId = 0;
                quotesummarycurrent.Username = "Regretted";
                quotesummarycurrent.StartDate = startDate;
                quotesummarycurrent.EndDate = startDate;
                quotesummarycurrent.UpdatedUsername = SessionCookieManagement.UserName;
                quotesummarycurrent.Clarification = totalRegretted;
                db.Entry<SZ_QuoteSummary>(quotesummarycurrent).State = EntityState.Added;
                db.SaveChanges();
            }

            return Json("success", JsonRequestBehavior.AllowGet);
        }

        public ActionResult GetlanguageList()
        {
            var list = db.Languages.OrderBy(x => x.Name).ToList();

            List<SelectListItem> CompanyList = new List<SelectListItem>();
            CompanyList.Add(new SelectListItem()
            {
                Text = "--Select--",
                Value = ""
            });

            if (list != null && list.Count > 0)
            {
                foreach (var item in list)
                {
                    CompanyList.Add(new SelectListItem()
                    {
                        Text = item.Name,
                        Value = item.Id.ToString()
                    });
                }
            }
            return Json(CompanyList, JsonRequestBehavior.AllowGet);
        }

        public ActionResult Updatelanguage(int langid)
        {
            SessionCookieManagement.DefaultCurrencyId = langid;
            return Json(langid, JsonRequestBehavior.AllowGet);
        }

        public ActionResult GetAccessedCompanyList()
        {
            var companyDataList = new List<SZ_CompanyList>();
            if (SessionCookieManagement.IsAdmin)
            {
                companyDataList = db.SZ_CompanyList.OrderBy(x => x.Name).ToList();
            }

            List<SelectListItem> CompanyList = new List<SelectListItem>();
            CompanyList.Add(new SelectListItem()
            {
                Text = "All",
                Value = "0"
            });
            var compList = db.SZ_UserManagement.Where(x => x.UserId == SessionCookieManagement.UserId).FirstOrDefault();

            if (compList != null)
            {
                var compSplit = compList.CompanyIds.Split(',');
                var compIds = new List<int>();
                if (compSplit != null && compSplit.Count() > 0)
                {
                    foreach (var item in compSplit)
                    {
                        if (!string.IsNullOrEmpty(item))
                        {
                            compIds.Add(Convert.ToInt32(item));
                        }
                    }
                }

                if (SessionCookieManagement.IsInternational)
                {
                    companyDataList = db.SZ_CompanyList.Where(x => compIds.Contains(x.Id)).OrderBy(x => x.Name).ToList();
                }

            }
            if (companyDataList != null && companyDataList.Count > 0)
            {
                foreach (var item in companyDataList)
                {
                    CompanyList.Add(new SelectListItem()
                    {
                        Text = item.Name,
                        Value = item.Id.ToString()
                    });
                }
            }
            return Json(CompanyList, JsonRequestBehavior.AllowGet);
        }

        public ActionResult Summary()
        {
            return View();
        }
        public ActionResult Graph()
        {
            return View();
        }
        public ActionResult GetSummary(int leftcompanyId, string startDate, string endDate)
        {
            List<int?> cidList = new List<int?>();
            if (leftcompanyId == 0)
            {
                string internationcompanylist = "";
                internationcompanylist = db.SZ_UserManagement.Where(x => x.UserId == SessionCookieManagement.UserId).Select(x => x.CompanyIds).FirstOrDefault();
                if (!string.IsNullOrEmpty(internationcompanylist))
                {
                    foreach (var item in internationcompanylist.Split(','))
                    {
                        if (!string.IsNullOrEmpty(item))
                        {
                            cidList.Add(Convert.ToInt32(item));
                        }
                    }
                }
            }
            else
            {
                cidList.Add(leftcompanyId);
            }

            var quotedata = db.SZ_Quotation.Where(x => cidList.Contains(x.CompanyId)).ToList();
            if (!string.IsNullOrEmpty(startDate))
            {
                DateTime sd = Convert.ToDateTime(startDate);
                quotedata = quotedata.Where(x => x.CreatedDate >= sd).ToList();
            }
            if (!string.IsNullOrEmpty(endDate))
            {
                DateTime ed = Convert.ToDateTime(endDate);
                quotedata = quotedata.Where(x => x.CreatedDate <= ed).ToList();
            }

            var companyList = db.SZ_CompanyList.Where(x => cidList.Contains(x.Id)).ToList();

            List<SummaryDashboard> model = new List<SummaryDashboard>();
            if (companyList != null && companyList.Count > 0)
            {
                companyList.ForEach(compDetails =>
                {
                    var quoteFilterData = quotedata.Where(x => x.CompanyId == compDetails.Id).ToList();
                    var submodel = new SummaryDashboard();
                    submodel.CompanyId = compDetails.Id;
                    submodel.CompanyName = compDetails.Name;
                    submodel.TotalQuote = quoteFilterData.Count;
                    submodel.TotalProduct = quoteFilterData.Select(x => x.SZ_QuotationDetail.Count).Sum();
                    submodel.TotalProductValue = GetProductValue(quotedata.Where(x => x.CompanyId == compDetails.Id).ToList());
                    submodel.TotalPO = quoteFilterData.Where(x => !string.IsNullOrEmpty(x.PONo)).Count();
                    submodel.TotalPOProduct = quoteFilterData.Where(x => !string.IsNullOrEmpty(x.PONo)).Select(x => x.SZ_QuotationDetail.Count).Sum();
                    if (submodel.TotalProduct > 0)
                    {
                        submodel.PercentageConvert = (Convert.ToDecimal(submodel.TotalPOProduct) / Convert.ToDecimal(submodel.TotalProduct)) * 100;
                    }
                    submodel.ActionRow = "<a href='javascript:void(0)' class='btn btn-primary' onclick='DetailsOfConversion(\"" + compDetails.Id + "\")' > " + CommonOperation.GetLocalizestring("account.customerorders.orderdetails") + "</a>";

                    model.Add(submodel);
                });
            }

            return Json(model, JsonRequestBehavior.AllowGet);
        }

        public int GetProductValue(List<SZ_Quotation> quoteData, bool exactMatch = false)
        {
            var value = 0;
            if (quoteData != null && quoteData.Count > 0)
            {
                List<PriceQtyModel> mainmodel = new List<PriceQtyModel>();
                foreach (var item in quoteData)
                {
                    List<PriceQtyModel> model = new List<PriceQtyModel>();

                    if (!exactMatch)
                    {
                        foreach (var qditem in item.SZ_QuotationDetail)
                        {
                            List<PriceQtyModel> objmodel = SZ_Helper.PreparePriceModel(qditem.Price);
                            model.Add(objmodel.FirstOrDefault());
                        }
                        mainmodel.Add(model.FirstOrDefault());
                        foreach (var itemss in mainmodel)
                        {
                            if (itemss != null)
                            {
                                value += Convert.ToInt32(itemss.Price);
                            }
                        }
                    }
                    else
                    {
                        foreach (var qditem in item.SZ_QuotationDetail.Where(x => x.MoveToProject == true))
                        {
                            List<PriceQtyModel> objmodel = SZ_Helper.PreparePriceModel(qditem.Price);
                            if (objmodel != null && objmodel.Count > 0)
                            {
                                var datas = objmodel.Where(x => x.MG == qditem.RequiredQty).FirstOrDefault();
                                if (datas != null)
                                {
                                    value += Convert.ToInt32(datas.Price);
                                }
                            }
                            model.Add(objmodel.Where(x => x.MG == qditem.RequiredQty).FirstOrDefault());
                        }
                    }
                }
            }
            return value;
        }

        public decimal GetQuoteProductValue(List<SZ_Quotation> quoteData)
        {
            decimal value = 0;
            if (quoteData != null && quoteData.Count > 0)
            {
                List<PriceQtyModel> mainmodel = new List<PriceQtyModel>();
                foreach (var item in quoteData)
                {
                    List<PriceQtyModel> model = new List<PriceQtyModel>();
                    foreach (var qditem in item.SZ_QuotationDetail)
                    {
                        if (qditem != null)
                        {
                            try
                            {
                                List<PriceQtyModel> objmodel = SZ_Helper.PreparePriceModel(qditem.Price);
                                if (objmodel != null && objmodel.Count > 0)
                                {
                                    string minqty = Convert.ToString(objmodel.Min(x => Convert.ToInt32(x.MG)));
                                    model.Add(objmodel.Where(x => x.MG == minqty).FirstOrDefault());
                                }
                            }
                            catch
                            {

                            }
                        }

                    }
                    mainmodel.AddRange(model);
                }


                foreach (var item in mainmodel)
                {
                    if (item != null)
                    {
                        value += Convert.ToInt32(item.Price);
                    }
                }
            }
            return value;
        }

        public decimal GetQuoteProductValue(SZ_Quotation quoteData)
        {
            decimal value = 0;
            if (quoteData != null)
            {
                List<PriceQtyModel> mainmodel = new List<PriceQtyModel>();

                List<PriceQtyModel> model = new List<PriceQtyModel>();
                foreach (var qditem in quoteData.SZ_QuotationDetail)
                {
                    if (qditem != null)
                    {
                        try
                        {
                            List<PriceQtyModel> objmodel = SZ_Helper.PreparePriceModel(qditem.Price);
                            if (objmodel != null && objmodel.Count > 0)
                            {
                                string minqty = Convert.ToString(objmodel.Min(x => Convert.ToInt32(x.MG)));
                                model.Add(objmodel.Where(x => x.MG == minqty).FirstOrDefault());
                            }
                        }
                        catch
                        {

                        }
                    }

                }
                mainmodel.AddRange(model);

                foreach (var item in mainmodel)
                {
                    if (item != null)
                    {
                        value += Convert.ToInt32(item.Price);
                    }
                }
            }
            return value;
        }

        public decimal GetQuoteProductValue(int quoteId)
        {
            decimal value = 0;
            var quoteData = db.SZ_Quotation.Where(x => x.Id == quoteId).FirstOrDefault();
            if (quoteData != null)
            {
                List<PriceQtyModel> mainmodel = new List<PriceQtyModel>();

                List<PriceQtyModel> model = new List<PriceQtyModel>();
                foreach (var qditem in quoteData.SZ_QuotationDetail)
                {
                    if (qditem != null)
                    {
                        try
                        {
                            List<PriceQtyModel> objmodel = SZ_Helper.PreparePriceModel(qditem.Price);
                            if (objmodel != null && objmodel.Count > 0)
                            {
                                string minqty = Convert.ToString(objmodel.Min(x => Convert.ToInt32(x.MG)));
                                model.Add(objmodel.Where(x => x.MG == minqty).FirstOrDefault());
                            }
                        }
                        catch
                        {

                        }
                    }

                }
                mainmodel.AddRange(model);

                foreach (var item in mainmodel)
                {
                    if (item != null)
                    {
                        value += Convert.ToInt32(item.Price);
                    }
                }
            }
            return value;
        }

        public decimal GetPOProductValue(List<SZ_Quotation> quoteData, bool isExchangeEnable = false)
        {
            decimal value = 0;
            if (quoteData != null && quoteData.Count > 0)
            {
                List<PriceQtyModel> mainmodel = new List<PriceQtyModel>();
                foreach (var item in quoteData)
                {
                    List<PriceQtyModel> model = new List<PriceQtyModel>();
                    foreach (var qditem in item.SZ_QuotationDetail.Where(x => x.MoveToProject == true))
                    {
                        if (qditem != null)
                        {
                            try
                            {
                                if (!string.IsNullOrEmpty(qditem.FinalPrice))
                                {
                                    if (isExchangeEnable)
                                    {
                                        if (item.CountryType == "Export" && !string.IsNullOrEmpty(qditem.FinalPrice))
                                        {
                                            decimal exchangerate = 0;
                                            var webRequest = WebRequest.Create(@"https://synzeal.com/exchangerate.txt");

                                            using (var response = webRequest.GetResponse())
                                            using (var content = response.GetResponseStream())
                                            using (var reader = new StreamReader(content))
                                            {
                                                exchangerate = Convert.ToDecimal(reader.ReadToEnd());
                                            }

                                            value += Convert.ToDecimal(Regex.Match(qditem.FinalPrice, @"\d+").Value) * exchangerate;
                                        }
                                        else
                                        {
                                            value += Convert.ToDecimal(Regex.Match(qditem.FinalPrice, @"\d+").Value);
                                        }
                                    }
                                    else
                                    {
                                        value += Convert.ToDecimal(Regex.Match(qditem.FinalPrice, @"\d+").Value);
                                    }
                                }
                            }
                            catch
                            {

                            }
                        }
                        //List<PriceQtyModel> objmodel = SZ_Helper.PreparePriceModel(qditem.Price, qditem.ItemDiscount);
                        //if(objmodel != null && objmodel.Count > 0)
                        //{
                        //    var datas = objmodel.Where(x => x.MG == qditem.RequiredQty).FirstOrDefault();
                        //    if(datas != null)
                        //    {
                        //        value += Convert.ToInt32(datas.Price);
                        //    }
                        //}
                        //model.Add(objmodel.Where(x=>x.MG == qditem.RequiredQty).FirstOrDefault());
                    }
                    //mainmodel.Add(model.FirstOrDefault());
                }


                //foreach (var item in mainmodel)
                //{
                //    if (item != null)
                //    {
                //        value += Convert.ToInt32(item.Price);
                //    }
                //}
            }
            return value;
        }

        public decimal GetPOProductValue(SZ_Quotation quoteData, bool isExchangeEnable = false)
        {
            decimal value = 0;
            if (quoteData != null)
            {
                var item = quoteData;
                List<PriceQtyModel> mainmodel = new List<PriceQtyModel>();

                List<PriceQtyModel> model = new List<PriceQtyModel>();
                foreach (var qditem in item.SZ_QuotationDetail.Where(x => x.MoveToProject == true))
                {
                    if (qditem != null)
                    {
                        try
                        {
                            if (!string.IsNullOrEmpty(qditem.FinalPrice))
                            {
                                if (isExchangeEnable)
                                {
                                    if (item.CountryType == "Export" && !string.IsNullOrEmpty(qditem.FinalPrice))
                                    {
                                        decimal exchangerate = 0;
                                        var webRequest = WebRequest.Create(@"https://synzeal.com/exchangerate.txt");

                                        using (var response = webRequest.GetResponse())
                                        using (var content = response.GetResponseStream())
                                        using (var reader = new StreamReader(content))
                                        {
                                            exchangerate = Convert.ToDecimal(reader.ReadToEnd());
                                        }

                                        value += Convert.ToDecimal(Regex.Match(qditem.FinalPrice, @"\d+").Value) * exchangerate;
                                    }
                                    else
                                    {
                                        value += Convert.ToDecimal(Regex.Match(qditem.FinalPrice, @"\d+").Value);
                                    }
                                }
                                else
                                {
                                    value += Convert.ToDecimal(Regex.Match(qditem.FinalPrice, @"\d+").Value);
                                }
                            }
                        }
                        catch
                        {

                        }
                    }
                    //List<PriceQtyModel> objmodel = SZ_Helper.PreparePriceModel(qditem.Price, qditem.ItemDiscount);
                    //if(objmodel != null && objmodel.Count > 0)
                    //{
                    //    var datas = objmodel.Where(x => x.MG == qditem.RequiredQty).FirstOrDefault();
                    //    if(datas != null)
                    //    {
                    //        value += Convert.ToInt32(datas.Price);
                    //    }
                    //}
                    //model.Add(objmodel.Where(x=>x.MG == qditem.RequiredQty).FirstOrDefault());
                }
                //mainmodel.Add(model.FirstOrDefault());



                //foreach (var item in mainmodel)
                //{
                //    if (item != null)
                //    {
                //        value += Convert.ToInt32(item.Price);
                //    }
                //}
            }
            return value;
        }

        public decimal GetPOProductValue(SZ_QuotationDetail quoteDetailData, bool isExchangeEnable = false)
        {
            decimal value = 0;
            if (quoteDetailData != null)
            {
                try
                {
                    if (isExchangeEnable)
                    {
                        if (quoteDetailData.SZ_Quotation.CountryType == "Export" && !string.IsNullOrEmpty(quoteDetailData.FinalPrice))
                        {
                            decimal exchangerate = 0;
                            var webRequest = WebRequest.Create(@"https://synzeal.com/exchangerate.txt");
                            using (var response = webRequest.GetResponse())
                            using (var content = response.GetResponseStream())
                            using (var reader = new StreamReader(content))
                            {
                                exchangerate = Convert.ToDecimal(reader.ReadToEnd());
                            }

                            if (!string.IsNullOrEmpty(quoteDetailData.FinalPrice))
                            {
                                value += Convert.ToDecimal(Regex.Match(quoteDetailData.FinalPrice, @"\d+").Value) * exchangerate;
                            }
                            else
                            {
                                List<PriceQtyModel> model = new List<PriceQtyModel>();
                                foreach (var item in quoteDetailData.Price.Split(','))
                                {
                                    if (quoteDetailData.RequiredQty == Convert.ToString(Regex.Match(item.Split('@')[0], @"\d+").Value))
                                    {
                                        value += Convert.ToDecimal(Regex.Match(item.Split('@')[1], @"\d+").Value) * exchangerate;
                                    }
                                }
                            }
                        }
                        else
                        {
                            if (!string.IsNullOrEmpty(quoteDetailData.FinalPrice))
                            {
                                value += Convert.ToDecimal(Regex.Match(quoteDetailData.FinalPrice, @"\d+").Value);
                            }
                            else
                            {
                                List<PriceQtyModel> model = new List<PriceQtyModel>();
                                foreach (var item in quoteDetailData.Price.Split(','))
                                {
                                    if (quoteDetailData.RequiredQty == Convert.ToString(Regex.Match(item.Split('@')[0], @"\d+").Value))
                                    {
                                        value += Convert.ToDecimal(Regex.Match(item.Split('@')[1], @"\d+").Value);
                                    }
                                }
                            }
                        }
                    }
                    else
                    {

                        if (!string.IsNullOrEmpty(quoteDetailData.FinalPrice))
                        {
                            value += Convert.ToDecimal(Regex.Match(quoteDetailData.FinalPrice, @"\d+").Value);
                        }
                        else
                        {
                            List<PriceQtyModel> model = new List<PriceQtyModel>();
                            foreach (var item in quoteDetailData.Price.Split(','))
                            {
                                if (quoteDetailData.RequiredQty == Convert.ToString(Regex.Match(item.Split('@')[0], @"\d+").Value))
                                {
                                    value += Convert.ToDecimal(Regex.Match(item.Split('@')[1], @"\d+").Value);
                                }
                            }
                        }
                    }
                }
                catch
                {

                }
            }
            return value;
        }
        public decimal GetPOProductValue(string price)
        {
            decimal value = 0;
            if (!string.IsNullOrEmpty(price))
            {
                try
                {
                    value += Convert.ToDecimal(Regex.Match(price.Split(',')[0].Split('@')[1], @"\d+").Value);
                }
                catch
                {

                }
            }
            return value;
        }

        public ActionResult Editsummary(int userid, int days, int clarification = 0, int upload = 0, int complex = 0/*, int regretted = 0*/)
        {
            var startDate = new DateTime();
            var endDate = new DateTime();
            if (days == 1)
            {
                startDate = DateTime.Now.AddDays(-1);
                endDate = DateTime.Now.AddDays(-1);
            }
            else
            {
                startDate = DateTime.Now;
                endDate = DateTime.Now;
            }
            TimeSpan duration = new TimeSpan(0, 0, 0);
            TimeSpan endduration = new TimeSpan(23, 59, 59);
            startDate = startDate.Date + duration;
            endDate = endDate.Date + endduration;
            var quotesummarycurrent = db.SZ_QuoteSummary.Where(x => x.UserId == userid && x.StartDate >= startDate && x.EndDate <= endDate).FirstOrDefault();
            if (quotesummarycurrent != null)
            {
                //Update
                quotesummarycurrent.Clarification = clarification;
                quotesummarycurrent.Upload = upload;
                quotesummarycurrent.Complex = complex;
                //quotesummarycurrent.Regretted = regretted;
                db.Entry<SZ_QuoteSummary>(quotesummarycurrent).State = EntityState.Modified;
                db.SaveChanges();
            }
            else
            {
                MemoryCacheManager objCache = new MemoryCacheManager();

                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == userid).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                //Insert
                quotesummarycurrent = new SZ_QuoteSummary();
                quotesummarycurrent.UserId = userid;
                quotesummarycurrent.Username = customerName;
                quotesummarycurrent.StartDate = startDate;
                quotesummarycurrent.EndDate = startDate;
                quotesummarycurrent.UpdatedUsername = SessionCookieManagement.UserName;
                quotesummarycurrent.Clarification = clarification;
                quotesummarycurrent.Upload = upload;
                quotesummarycurrent.Complex = complex;
                //quotesummarycurrent.Regretted = regretted;
                db.Entry<SZ_QuoteSummary>(quotesummarycurrent).State = EntityState.Added;
                db.SaveChanges();
            }

            return Json("success", JsonRequestBehavior.AllowGet);
        }

        public ActionResult LoadScientistDashboardDetail(int id)
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                int numberOfObjectsPerPage = Convert.ToInt32(Request.Form["length"]);
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();

                int skip = start != null ? Convert.ToInt32(start) : 0;
                int pageNo = 1;
                if (skip > 0)
                {
                    pageNo = (skip / numberOfObjectsPerPage) + 1;
                }
                int? recordsTotal = 0;
                var categorylist = db.Categories.Where(x => x.ParentCategoryId == 0).ToList();
                MemoryCacheManager objCache = new MemoryCacheManager();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });

                var scienList = objCache.Get("cache.GetScientistId", () =>
                {
                    return db.GetScientistId().ToList();
                });

                var sid = scienList.Where(x => x == id).FirstOrDefault();
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == sid).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                ViewBag.ScientistName = customerName;
                var customerdata = db.Customers.Where(x => x.Active == true && x.Deleted == false).ToList();

                customerName = customerName.ToLower().Trim();
                var allProList = (from c in db.Categories
                                  join cp in db.Product_Category_Mapping on c.Id equals cp.CategoryId
                                  join p in db.Products on cp.ProductId equals p.Id
                                  join i in db.SZ_Inventory on p.Id equals i.ProductId
                                  join qd in db.SZ_QuoteDetailForm on i.BatchNo equals qd.BatchCode
                                  join t3 in db.SZ_QuoteDetails_Form on qd.Id equals t3.FormId
                                  join qdd in db.SZ_QuotationDetail on t3.QuoteDetailsId equals qdd.Id
                                  where qdd.ScientistCustomerId == id
                                  && (qd.IsDispatchedEntry == false || qd.IsDispatchedEntry == null)
                                  orderby qd.SubmissionDate descending
                                  select new ScientistDetailDashboardModel()
                                  {
                                      CASNO = qd.CASNo,
                                      CATNo = qd.CATNo,
                                      ScientistName = qd.ScientistName,
                                      DiffLevel = qdd.DifficultyLevel,
                                      ProductName = qd.ProductName,
                                      QuantityDemand = qdd.RequiredQty,
                                      Quantity = qd.Qty,
                                      SubmitedDate = qd.SubmissionDate,
                                      ScientistDate = qdd.MoveToScientistDate,
                                      SubScientistName = qdd.SubScientistName,
                                      Chemist = qdd.Chemist,
                                      //Duration = SZ_Helper.GetStringDateDiffrance(qdd.MoveToScientistDate.Value, qd.CreatedDate),
                                      QuotedLeadTime = qdd.LeadTime,
                                      PONumber = qdd.SZ_Quotation.PONo,
                                      PODate = qdd.SZ_Quotation.PODate,
                                      FinalRoute = qd.NoOfFinalStep,
                                      EarlierSynthesized = qd.EarlierSynthesized,
                                      PurificationBy = qd.PurificationBy,
                                      APIcategory = c.Name,
                                      SpeDataAttachment = qd.SpectralDataAttachment,
                                  }).ToList();


                foreach (var item in allProList)
                {
                    item.CATNoText = "<a href='https://www.synzeal.com/search?q=" + item.CATNo + "' target='_blank'>" + item.CATNo + "</a>";
                    item.FirstRaw = "<input type='checkbox' class='chksave' value='" + item.QuotationDetailsId + "' />";
                    if (item.PODate.HasValue)
                    {
                        // item.Duration = SZ_Helper.GetStringDateDiffrance(item.ScientistDate.Value, item.SubmitedDate);
                        item.Duration = SZ_Helper.GetStringDateDiffrance(item.PODate.Value, item.SubmitedDate);
                    }
                    item.SubmitedDateText = item.SubmitedDate.ToShortDateString();
                    item.APIcategory = categorylist.Where(x => x.Id == item.ParentCategoryId).Select(x => x.Name).FirstOrDefault();

                    foreach (EnumList.DifficultyLevel r in Enum.GetValues(typeof(EnumList.DifficultyLevel)))
                    {
                        string text = SZ_Helper.GetEnumDescription((EnumList.DifficultyLevel)(int)r);
                        int val = (int)r;
                        if (Convert.ToString(val) == item.DiffLevel)
                        {
                            item.DiffLevelText = text;
                        }
                    }
                    if (item.SpeDataAttachment != null)
                    {
                        item.SpeDataAttachment = "<a download href='" + item.SpeDataAttachment.Replace("..", "") + "' ><i class='fa fa-download'></i></a>";
                    }

                    if (!string.IsNullOrEmpty(item.SubScientistName))
                    {
                        var isNumeric = System.Text.RegularExpressions.Regex.IsMatch(item.SubScientistName, @"\d");
                        if (isNumeric)
                        {
                            int subsciId = 0;
                            if (Int32.TryParse(item.SubScientistName, out int j))
                            {
                                subsciId = j;
                                var customer = customerdata.Where(x => x.Id == subsciId).FirstOrDefault();
                                if (customer != null)
                                {
                                    string customersName = string.Empty;
                                    var genericsAttr = genericData.Where(x => x.EntityId == customer.Id).ToList();
                                    if (genericsAttr.Count > 0)
                                    {
                                        customersName = genericsAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericsAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                                    }
                                    item.SubScientistName = customersName;
                                }
                            }
                        }
                    }
                }
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    allProList = allProList.Where(m => (m.ScientistName != null && m.ScientistName.ToLower().Contains(searchValue)) ||
                                            (m.SubmitedDateText != null && m.SubmitedDateText.ToLower().Contains(searchValue)) ||
                                            (m.SubScientistName != null && m.SubScientistName.ToLower().Contains(searchValue)) ||
                                            (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue)) ||
                                            (m.Quantity != null && m.Quantity.ToLower().Contains(searchValue)) ||
                                             (m.QuantityDemand != null && m.QuantityDemand.ToLower().Contains(searchValue)) ||
                                             (m.QuotedLeadTime != null && m.QuotedLeadTime.ToLower().Contains(searchValue)) ||
                                             (m.PONumber != null && m.PONumber.ToLower().Contains(searchValue)) ||
                                             (m.EarlierSynthesized != null && m.EarlierSynthesized.ToLower().Contains(searchValue)) ||
                                             (m.Duration != null && m.Duration.ToLower().Contains(searchValue)) ||
                                             (m.PurificationBy != null && m.PurificationBy.ToLower().Contains(searchValue))
                                       ).ToList();
                }

                var allRecords = allProList;
                recordsTotal = allProList.Count();
                allProList = allProList.Skip((pageNo - 1) * numberOfObjectsPerPage).Take(numberOfObjectsPerPage).ToList();

                var jsonResult = Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = allProList, allRecords = allRecords }, JsonRequestBehavior.AllowGet);
                jsonResult.MaxJsonLength = int.MaxValue;
                return jsonResult;
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        public ActionResult ConversionReport()
        {
            return View();
        }

        public ActionResult TodayDashboard()
        {
            if (!SessionCookieManagement.IsLogin)
            {
                return RedirectToAction("Index", "Home");
            }

            if (!SessionCookieManagement.IsAdmin &&
                !SessionCookieManagement.IsQuote &&
                !SessionCookieManagement.IsInternational)
            {
                return RedirectToAction("Index", "Home");
            }

            DashboardModel mainModel = new DashboardModel();
            string synthesisProjectType = Convert.ToString((int)EnumList.ProjectType.Synthesis);
            string pursynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
            mainModel.SynthesisCatNo = (from cp in db.SZ_QuotationDetail
                                        where (cp.ProjectType == synthesisProjectType || cp.ProjectType == pursynthesisProjectType)
                                        && (cp.MoveToDispatch == false || cp.MoveToDispatch == null)
                                        && (cp.SZ_Quotation.IsRFQManually == false || cp.SZ_Quotation.IsRFQManually == null)
                                        select cp.CATNo).Distinct().ToList();

            DateTime date = DateTime.Now.AddDays(-7);
            mainModel.Reviewed = db.SZ_Quotation.Where(x => x.IsReviewed == true && (x.IsPreApproved == null || x.IsPreApproved == false) && (x.IsRevision == null || x.IsRevision == false) && (x.IsRFQManually == null || x.IsRFQManually == false) && (x.IsQuoteApproved == null || x.IsQuoteApproved == false) && (x.IsStudy == false || x.IsStudy == null) && x.CreatedDate >= date).OrderBy(x => x.CompanyName).ToList();

            mainModel.Instock = db.SZ_Quotation.Where(x => (x.IsShowDashboard == true && x.IsInstock == true) || (x.IsInstock == true && (x.IsReviewed == false || x.IsReviewed == null) && (x.IsRFQManually == null || x.IsRFQManually == false) && (x.IsStudy == false || x.IsStudy == null) && (x.IsQuoteApproved == null || x.IsQuoteApproved == false) && (x.IsPark == null || x.IsPark == false) && (x.IsPreApproved == null || x.IsPreApproved == false) && (x.IsRevision == null || x.IsRevision == false) /*&& x.CreatedDate >= date*/)).OrderBy(x => x.CompanyName).ToList();
            mainModel.CustomSynthesis = db.SZ_Quotation.Where(x => (x.IsShowDashboard == true && x.IsCustomSynthesis == true) || x.IsCustomSynthesis == true && (x.IsStudy == false || x.IsStudy == null) && (x.IsRFQManually == null || x.IsRFQManually == false) && (x.IsReviewed == false || x.IsReviewed == null) && (x.IsQuoteApproved == null || x.IsQuoteApproved == false) && (x.IsPark == null || x.IsPark == false) && (x.IsPreApproved == null || x.IsPreApproved == false) && (x.IsRevision == null || x.IsRevision == false) /*&& x.CreatedDate >= date*/).OrderBy(x => x.CompanyName).ToList();
            mainModel.StudyData = db.SZ_Quotation.Where(x => x.IsStudy == true && (x.IsRFQManually == null || x.IsRFQManually == false) && (x.IsPreApproved == null || x.IsPreApproved == false) && (x.IsRevision == null || x.IsRevision == false)).OrderBy(x => x.CompanyName).ToList();
            mainModel.RFQQuoteData = db.SZ_Quotation.Where(x => x.IsRFQManually == true).OrderBy(x => x.CompanyName).ToList();
            mainModel.Approved = (from c in db.SZ_Quotation
                                  join cp in db.SZ_QuotationDetail on c.Id equals cp.QuoteId
                                  where c.IsQuoteApproved == true && (c.IsPark == false || c.IsPark == null)
                                  //&& c.CreatedDate >= date
                                  && (cp.IsSynthesisLog != true || cp.IsSynthesisLog == null)
                                   && (c.IsReviewed == false || c.IsReviewed == null)
                                   && (c.IsStudy == false || c.IsStudy == null)
                                   && (c.IsRFQManually == null || c.IsRFQManually == false)
                                   && (c.IsPreApproved == null || c.IsPreApproved == false)
                                   && (c.IsRevision == null || c.IsRevision == false)
                                  select c).Distinct().OrderBy(x => x.CompanyName).ToList();

            mainModel.PreApproved = (from c in db.SZ_Quotation
                                     join cp in db.SZ_QuotationDetail on c.Id equals cp.QuoteId
                                     where (c.IsQuoteApproved == false || c.IsQuoteApproved == null)
                                      && (c.IsPark == false || c.IsPark == null)
                                      && (c.IsReviewed == false || c.IsReviewed == null)
                                      && (c.IsStudy == false || c.IsStudy == null)
                                      && (c.IsRFQManually == null || c.IsRFQManually == false)
                                      && (c.IsPreApproved == true || c.IsRevision == true)
                                     select c).Distinct().OrderBy(x => x.CompanyName).ToList();

            DateTime crateddate = DateTime.Now.AddDays(-2);

            mainModel.QuotationList = (from q in db.SZ_Quotation
                                       where q.CreatedDate >= crateddate && (q.IsToBe == null || q.IsToBe == false) && (q.IsQuoteApproved == false || q.IsQuoteApproved == null) && (q.IsPark == false || q.IsPark == null) && !q.CompanyName.Contains("synzeal")
                                       && (q.IsStudy == false || q.IsStudy == null)
                                       && (q.IsRFQManually == null || q.IsRFQManually == false)
                                        && (q.IsPreApproved == null || q.IsPreApproved == false)
                                        && (q.IsRevision == null || q.IsRevision == false)
                                       select q).Distinct().OrderBy(x => x.CompanyName).ToList();

            List<MonthWiseUserDashboardDto> mainusermodel = new List<MonthWiseUserDashboardDto>();
            var startDate = DateTime.Now;
            var endDate = DateTime.Now;
            while (startDate <= endDate)
            {
                List<UserDashboardDto> model = new List<UserDashboardDto>();
                int month = startDate.Month;
                int year = startDate.Year;
                var datas = db.SZ_UserDashboard.Where(x => x.Month == month && x.Year == year).ToList();
                foreach (var item in datas)
                {
                    UserDashboardDto objModel = new UserDashboardDto();
                    objModel.Username = item.UserName;
                    objModel.AllDetails = item.AllDetails;
                    objModel.WithoutCatNo = item.WithoutCatNo;
                    objModel.WithoutCasNo = item.WithoutCasNo;
                    objModel.WithoutPrice = item.WithoutPrice;
                    objModel.TotalAdded = item.TotalAdded;
                    objModel.RevisionCatNo = item.CatNoRevision;
                    objModel.RevisionCasNo = item.CASNoRevision;
                    objModel.RevisionPrice = item.PriceRevision;
                    objModel.TotalRevisionProduct = item.TotalRevisionProduct;
                    model.Add(objModel);
                }

                MonthWiseUserDashboardDto objMainModel = new MonthWiseUserDashboardDto();
                objMainModel.MonthName = startDate.ToShortMonthName();
                objMainModel.Year = startDate.Year;
                objMainModel.UserDashboardModel = model.OrderByDescending(x => x.TotalAdded).ToList();
                mainusermodel.Add(objMainModel);
                // do something with target.Month and target.Year
                startDate = startDate.AddMonths(1);
            }
            mainModel.UserDashboardModel = mainusermodel;
            TimeSpan duration = new TimeSpan(22, 30, 0);
            TimeSpan durationend = new TimeSpan(22, 30, 0);
            var startDatesummary = DateTime.Now.AddDays(-2);
            var endstartDatesummary = DateTime.Now.AddDays(-1);
            startDatesummary = startDatesummary.Date + duration;
            endstartDatesummary = endstartDatesummary.Date + durationend;
            var endDatesummary = DateTime.Now.AddDays(-1);
            var startendDatesummary = DateTime.Now;
            startendDatesummary = startendDatesummary.Date + durationend;
            endDatesummary = endDatesummary.Date + duration;
            var listBDItems = new List<SelectListItem>();
            var quoteUserList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("quote")).ToList();
            MemoryCacheManager objCache = new MemoryCacheManager();

            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });
            foreach (var term in quoteUserList)
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                if (genericAttr.Count() > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                listBDItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.Id.ToString()
                });
            }

            var GeographicalLocationList = new List<SelectListItem>();
            GeographicalLocationList.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var geographicalLocationData = objCache.Get("cache.geographicalLocationData", () =>
            {
                return db.SZ_Geographical.OrderBy(x => x.Id).ToList();
            });

            if (geographicalLocationData != null && geographicalLocationData.Count > 0)
            {
                geographicalLocationData.ForEach(item =>
                {
                    GeographicalLocationList.Add(new SelectListItem
                    {
                        Text = item.Name,
                        Value = item.Id.ToString()
                    });
                });
            }
            ViewBag.GeographicalLocationList = GeographicalLocationList;
            var listItems = new List<SelectListItem>();
            listItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var terms = db.SZ_CompanyList.AsEnumerable();
            foreach (var term in terms)
            {
                listItems.Add(new SelectListItem
                {
                    Text = term.Name,
                    Value = term.Id.ToString()
                });
            }
            mainModel.compList = listItems;
            mainModel.RFQCount = db.SZ_Query.Select(x => x.Email).Distinct().Count();

            return View(mainModel);
        }

        public ActionResult GenerateYearWiseBDteamreport()
        {
            List<MonthWiseUserDashboardDto> mainmodel = new List<MonthWiseUserDashboardDto>();
            var startDate = new DateTime(2021, 04, 01);
            var endDate = new DateTime(2022, 03, 31);
            while (startDate <= endDate)
            {
                List<UserDashboardDto> model = new List<UserDashboardDto>();
                int month = startDate.Month;
                int year = startDate.Year;
                var datas = db.SZ_UserDashboard.Where(x => x.Month == month && x.Year == year).ToList();
                foreach (var item in datas)
                {
                    UserDashboardDto objModel = new UserDashboardDto();
                    objModel.Username = item.UserName;
                    objModel.AllDetails = item.AllDetails;
                    objModel.WithoutCatNo = item.WithoutCatNo;
                    objModel.WithoutCasNo = item.WithoutCasNo;
                    objModel.WithoutPrice = item.WithoutPrice;
                    objModel.TotalAdded = item.TotalAdded;
                    objModel.RevisionCatNo = item.CatNoRevision;
                    objModel.RevisionCasNo = item.CASNoRevision;
                    objModel.RevisionPrice = item.PriceRevision;
                    objModel.TotalRevisionProduct = item.TotalRevisionProduct;
                    model.Add(objModel);
                }

                MonthWiseUserDashboardDto objMainModel = new MonthWiseUserDashboardDto();
                objMainModel.MonthName = startDate.ToShortMonthName();
                objMainModel.Year = startDate.Year;
                objMainModel.UserDashboardModel = model.OrderByDescending(x => x.TotalAdded).ToList();
                mainmodel.Add(objMainModel);
                // do something with target.Month and target.Year
                startDate = startDate.AddMonths(1);
            }

            return View(mainmodel);
        }


        public ActionResult RecentSubmittionDashboard()
        {
            if (!SessionCookieManagement.IsLogin)
            {
                return RedirectToAction("Index", "Home");
            }
            if (!SessionCookieManagement.IsAdmin && !SessionCookieManagement.IsQuote)
            {
                return RedirectToAction("Index", "Home");
            }

            var yearItems = new List<SelectListItem>();
            var monthItems = new List<SelectListItem>();
            var weekItems = new List<SelectListItem>();
            yearItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            monthItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            weekItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            for (int i = 2018; i <= DateTime.Now.Year; i++)
            {
                yearItems.Add(new SelectListItem
                {
                    Text = i.ToString(),
                    Value = i.ToString(),
                    Selected = i == DateTime.Now.Year ? true : false
                });
            }
            for (int i = 1; i <= 12; i++)
            {
                monthItems.Add(new SelectListItem
                {
                    Text = i.ToString(),
                    Value = i.ToString()
                });
            }
            for (int i = 1; i <= 54; i++)
            {
                weekItems.Add(new SelectListItem
                {
                    Text = i.ToString(),
                    Value = i.ToString()
                });
            }
            ViewBag.YearItems = yearItems;
            ViewBag.WeekItems = weekItems;
            ViewBag.MonthItems = monthItems;
            return View(new List<ScientistDetailDashboardModel>());
        }
        public ActionResult UserDashboard()
        {
            if (!SessionCookieManagement.IsLogin)
            {
                return RedirectToAction("Index", "Home");
            }
            if (!SessionCookieManagement.IsAdmin && !SessionCookieManagement.IsQuote)
            {
                return RedirectToAction("Index", "Home");
            }


            List<MonthWiseUserDashboardDto> mainmodel = new List<MonthWiseUserDashboardDto>();
            var startDate = DateTime.Now.AddMonths(-2);
            var endDate = DateTime.Now;
            while (startDate <= endDate)
            {
                List<UserDashboardDto> model = new List<UserDashboardDto>();
                int month = startDate.Month;
                int year = startDate.Year;
                var datas = db.SZ_UserDashboard.Where(x => x.Month == month && x.Year == year).ToList();
                foreach (var item in datas)
                {
                    UserDashboardDto objModel = new UserDashboardDto();
                    objModel.Username = item.UserName;
                    objModel.AllDetails = item.AllDetails;
                    objModel.WithoutCatNo = item.WithoutCatNo;
                    objModel.WithoutCasNo = item.WithoutCasNo;
                    objModel.WithoutPrice = item.WithoutPrice;
                    objModel.TotalAdded = item.TotalAdded;
                    objModel.RevisionCatNo = item.CatNoRevision;
                    objModel.RevisionCasNo = item.CASNoRevision;
                    objModel.RevisionPrice = item.PriceRevision;
                    objModel.TotalRevisionProduct = item.TotalRevisionProduct;
                    model.Add(objModel);
                }

                MonthWiseUserDashboardDto objMainModel = new MonthWiseUserDashboardDto();
                objMainModel.MonthName = startDate.ToShortMonthName();
                objMainModel.Year = startDate.Year;
                objMainModel.UserDashboardModel = model;
                mainmodel.Add(objMainModel);
                // do something with target.Month and target.Year
                startDate = startDate.AddMonths(1);
            }
            return View(mainmodel);
        }


        public ActionResult ScientistDashboard()
        {
            if (!SessionCookieManagement.IsLogin)
            {
                return RedirectToAction("Index", "Home");
            }
            if (!SessionCookieManagement.IsAdmin && !SessionCookieManagement.IsQuote)
            {
                return RedirectToAction("Index", "Home");
            }

            var yearItems = new List<SelectListItem>();
            var monthItems = new List<SelectListItem>();
            var weekItems = new List<SelectListItem>();
            yearItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            monthItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            weekItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            for (int i = 2018; i <= DateTime.Now.Year; i++)
            {
                yearItems.Add(new SelectListItem
                {
                    Text = i.ToString(),
                    Value = i.ToString(),
                    Selected = i == DateTime.Now.Year ? true : false
                });
            }
            for (int i = 1; i <= 12; i++)
            {
                monthItems.Add(new SelectListItem
                {
                    Text = i.ToString(),
                    Value = i.ToString()
                });
            }
            for (int i = 1; i <= 54; i++)
            {
                weekItems.Add(new SelectListItem
                {
                    Text = i.ToString(),
                    Value = i.ToString()
                });
            }
            ViewBag.YearItems = yearItems;
            ViewBag.WeekItems = weekItems;
            ViewBag.MonthItems = monthItems;

            return View(new List<ScientistModel>());
        }

        public ActionResult LoadScientistDashboard()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                int numberOfObjectsPerPage = Convert.ToInt32(Request.Form["length"]);
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();

                var filterYear = Request.Form.GetValues("filterYear")[0].ToString();
                //var filterWeek = Request.Form.GetValues("filterWeek")[0].ToString();
                var filterMonth = Request.Form.GetValues("filterMonth")[0].ToString();

                int skip = start != null ? Convert.ToInt32(start) : 0;
                int pageNo = 1;
                if (skip > 0)
                {
                    pageNo = (skip / numberOfObjectsPerPage) + 1;
                }
                int? recordsTotal = 0;
                var query = new List<Product>();
                var listItems = new List<SelectListItem>();
                MemoryCacheManager objCache = new MemoryCacheManager();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });

                var scienList = objCache.Get("cache.GetScientistId", () =>
                {
                    return db.GetScientistId().ToList();
                });

                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName.Trim(),
                        Value = term.ToString()
                    });
                });

                var allscientistName = listItems.Select(x => x.Text.ToLower().Trim()).ToArray();
                var allProList = (from c in db.Categories
                                  join cp in db.Product_Category_Mapping on c.Id equals cp.CategoryId
                                  join p in db.Products on cp.ProductId equals p.Id
                                  join i in db.SZ_Inventory on p.Id equals i.ProductId
                                  join qd in db.SZ_QuoteDetailForm on i.BatchNo equals qd.BatchCode
                                  join t3 in db.SZ_QuoteDetails_Form on qd.Id equals t3.FormId
                                  join qdd in db.SZ_QuotationDetail on t3.QuoteDetailsId equals qdd.Id
                                  // where allscientistName.Contains(qd.TLName.Trim().ToLower())
                                  where scienList.Contains(qdd.ScientistCustomerId)
                                  select new ScientistDashboardDataModel()
                                  {
                                      ScientistId = qdd.ScientistCustomerId,
                                      ScientistName = qd.TLName,
                                      DiffLevel = qdd.DifficultyLevel,
                                      Year = qd.CreatedDate.Year,
                                      Month = qd.CreatedDate.Month,
                                      Date = qd.CreatedDate,
                                      Week = 0
                                  }).ToList();
                if (!string.IsNullOrEmpty(filterMonth))
                {
                    int mon = Convert.ToInt32(filterMonth);
                    allProList = allProList.Where(m => m.Month == mon).ToList();
                }
                if (!string.IsNullOrEmpty(filterYear))
                {
                    int yr = Convert.ToInt32(filterYear);
                    allProList = allProList.Where(m => m.Year == yr).ToList();
                }
                var model = new List<ScientistModel>();
                foreach (var item in listItems)
                {
                    var sciid = Convert.ToInt32(item.Value);
                    var sciname = item.Text.ToLower().Trim();
                    var ACount = allProList.Where(x => x.ScientistId == sciid && x.DiffLevel == "1").Count();
                    var BCount = allProList.Where(x => x.ScientistId == sciid && x.DiffLevel == "2").Count();
                    var CCount = allProList.Where(x => x.ScientistId == sciid && x.DiffLevel == "3").Count();
                    var DCount = allProList.Where(x => x.ScientistId == sciid && x.DiffLevel == "4").Count();
                    var ECount = allProList.Where(x => x.ScientistId == sciid && x.DiffLevel == "5").Count();

                    var objmodel = new ScientistModel();
                    objmodel.ScientistId = sciid;
                    objmodel.ScientistName = item.Text;
                    objmodel.A = ACount;
                    objmodel.B = BCount;
                    objmodel.C = CCount;
                    objmodel.D = DCount;
                    objmodel.E = ECount;
                    objmodel.TotalProduct = allProList.Where(x => x.ScientistId == sciid).Count();
                    objmodel.ActionRow = "<a href='/Form/ScientistDashboardDetail/" + objmodel.ScientistId + "'>Detailed</a>";
                    model.Add(objmodel);
                }
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.ScientistName != null && m.ScientistName.ToLower().Contains(searchValue))
                                       ).ToList();
                }

                var allRecords = model;
                recordsTotal = model.Count();
                model = model.Skip((pageNo - 1) * numberOfObjectsPerPage).Take(numberOfObjectsPerPage).ToList();

                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = model, allRecords = allRecords });
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        public ActionResult LoadRecentSubmittionDashboard()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                int numberOfObjectsPerPage = Convert.ToInt32(Request.Form["length"]);
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                int skip = start != null ? Convert.ToInt32(start) : 0;
                var filterYear = Request.Form.GetValues("filterYear")[0].ToString();
                //var filterWeek = Request.Form.GetValues("filterWeek")[0].ToString();
                var filterMonth = Request.Form.GetValues("filterMonth")[0].ToString();
                int pageNo = 1;
                if (skip > 0)
                {
                    pageNo = (skip / numberOfObjectsPerPage) + 1;
                }
                //var listItems = new List<SelectListItem>();
                //var genericData = db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                //var scienList = db.GetScientistId().ToList();
                //scienList.ForEach(term =>
                //{
                //    string customerName = string.Empty;
                //    var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                //    if (genericAttr.Count > 0)
                //    {
                //        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                //    }
                //    listItems.Add(new SelectListItem
                //    {
                //        Text = customerName,
                //        Value = term.ToString()
                //    });
                //});
                int? recordsTotal = 0;
                var categorylist = db.Categories.Where(x => x.ParentCategoryId == 0).ToList();
                var list = (from p in db.Products
                            join si in db.SZ_Inventory on p.Id equals si.ProductId
                            join qdf in db.SZ_QuoteDetailForm on si.BatchNo equals qdf.BatchCode
                            join t3 in db.SZ_QuoteDetails_Form on qdf.Id equals t3.FormId
                            join qd in db.SZ_QuotationDetail on t3.QuoteDetailsId equals qd.Id
                            join cp in db.Product_Category_Mapping on p.Id equals cp.ProductId
                            join c in db.Categories on cp.CategoryId equals c.Id
                            where p.Published == true && p.Deleted == false
                            && (qdf.IsDispatchedEntry == null || qdf.IsDispatchedEntry == false)
                            orderby si.CreatedDate descending
                            select new ScientistDetailDashboardModel
                            {
                                QuoteId = qd.SZ_Quotation.Id,
                                QuotationDetailsId = qd.Id,
                                ScientistName = qdf.ScientistName,
                                BatchNo = qdf.BatchCode,
                                //ScientistName = qd.ScientistCustomerId,
                                DiffLevel = qd.DifficultyLevel,
                                ParentCategoryId = c.ParentCategoryId,
                                ProductName = qd.ProductName,
                                QuantityDemand = qd.RequiredQty,
                                Quantity = qdf.Qty,
                                SubmitedDate = qdf.SubmissionDate,
                                ScientistDate = qd.MoveToScientistDate,
                                QuotedLeadTime = qd.LeadTime,
                                PONumber = qd.SZ_Quotation.PONo,
                                FinalRoute = qdf.NoOfFinalStep,
                                EarlierSynthesized = qdf.EarlierSynthesized,
                                PurificationBy = qdf.PurificationBy,
                                CASNO = qd.CASNo,
                                CATNo = qd.CATNo,
                                SpeDataAttachment = qdf.SpectralDataAttachment,
                                //Year = qd.CreatedDate.Year,
                                //Month = qd.CreatedDate.Month,
                                Year = qdf.SubmissionDate.Year,
                                Month = qdf.SubmissionDate.Month,
                            }).Distinct().ToList();

                if (!string.IsNullOrEmpty(filterMonth))
                {
                    int mon = Convert.ToInt32(filterMonth);
                    list = list.Where(m => m.Month == mon).ToList();
                }
                if (!string.IsNullOrEmpty(filterYear))
                {
                    int yr = Convert.ToInt32(filterYear);
                    list = list.Where(m => m.Year == yr).ToList();
                }
                foreach (var item in list)
                {
                    item.CATNoText = "<a href='https://www.synzeal.com/search?q=" + item.CATNo + "' target='_blank'>" + item.CATNo + "</a>";
                    item.FirstRaw = "<input type='checkbox' class='chksave' value='" + item.QuotationDetailsId + "' />";
                    if (item.ScientistDate.HasValue)
                    {
                        item.Duration = SZ_Helper.GetStringDateDiffrance(item.ScientistDate.Value, item.SubmitedDate);
                    }
                    item.SubmitedDateText = item.SubmitedDate.ToShortDateString();
                    item.APIcategory = categorylist.Where(x => x.Id == item.ParentCategoryId).Select(x => x.Name).FirstOrDefault();
                    item.DiffLevelText = "<select id='difflevel_" + item.QuotationDetailsId + "' class='clsDifficultyLevel' data-DiffLevel='" + item.DiffLevel + "' data-quoteDetailsId='" + item.QuotationDetailsId + "'><option value=''>--Select--</option>";
                    foreach (EnumList.DifficultyLevel r in Enum.GetValues(typeof(EnumList.DifficultyLevel)))
                    {
                        string text = SZ_Helper.GetEnumDescription((EnumList.DifficultyLevel)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == item.DiffLevel)
                        {
                            selected = "selected ";
                        }
                        item.DiffLevelText += "<option value='" + val + "' " + selected + ">" + text + "</option>";
                    }
                    if (!string.IsNullOrEmpty(item.SpeDataAttachment))
                    {
                        item.SpeDataAttachment = "<a download href='" + item.SpeDataAttachment.Replace("..", "") + "' ><i class='fa fa-download'></i></a>";
                    }

                    //item.PONumberText = "<a href='https://www.synzeal.com/search?q=" + item.CATNo + "' target='_blank'>" + item.PONumber + "</a>";
                    item.PONumberText = "<a href='../Form/Quote/" + item.QuoteId + "' target='_blank'> " + item.PONumber + "</a>";
                }
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    list = list.Where(m => (m.ScientistName != null && m.ScientistName.ToLower().Contains(searchValue)) ||
                                           (m.SubmitedDateText != null && m.SubmitedDateText.ToLower().Contains(searchValue)) ||
                                           (m.SubScientistName != null && m.SubScientistName.ToLower().Contains(searchValue)) ||
                                           (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue)) ||
                                           (m.Quantity != null && m.Quantity.ToLower().Contains(searchValue)) ||
                                           (m.QuantityDemand != null && m.QuantityDemand.ToLower().Contains(searchValue)) ||
                                           (m.QuotedLeadTime != null && m.QuotedLeadTime.ToLower().Contains(searchValue)) ||
                                           (m.PONumber != null && m.PONumber.ToLower().Contains(searchValue)) ||
                                           (m.EarlierSynthesized != null && m.EarlierSynthesized.ToLower().Contains(searchValue)) ||
                                           (m.Duration != null && m.Duration.ToLower().Contains(searchValue)) ||
                                           (m.PurificationBy != null && m.PurificationBy.ToLower().Contains(searchValue)) ||
                                           (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue)) ||
                                           (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue)) ||
                                           (m.CASNO != null && m.CASNO.ToLower().Contains(searchValue))
                                       ).ToList();
                }

                var allRecords = list;
                recordsTotal = list.Count();
                list = list.OrderByDescending(x => x.SubmitedDate).Skip((pageNo - 1) * numberOfObjectsPerPage).Take(numberOfObjectsPerPage).ToList();

                var jsonResult = Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = list, allRecords = allRecords }, JsonRequestBehavior.AllowGet);
                jsonResult.MaxJsonLength = int.MaxValue;
                return jsonResult;
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        public ActionResult MultipleQuote(int id)
        {
            if (!SessionCookieManagement.IsMiniAdmin && !SessionCookieManagement.IsAdmin && !SessionCookieManagement.IsFollowUp)
            {
                return RedirectToAction("Index", "Home");
            }
            var quote = _operationRepository.GetQuoteByID(id);
            if (quote == null)
            {
                return Json(new { success = false, message = "Quote not found" }, JsonRequestBehavior.AllowGet);
            }
            var multiplepoquote = db.SZ_Quotation.Where(x => x.PONo == quote.PONo).ToList();
            var quoteids = multiplepoquote.Select(x => x.Id).ToList();
            return Json(new { success = true, data = quoteids }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult PI(int id = 0)
        {
            if (!SessionCookieManagement.IsMiniAdmin
                && !SessionCookieManagement.IsAdmin
                && !SessionCookieManagement.IsFollowUp
                && !SessionCookieManagement.IsDomesticDispatch
                && !SessionCookieManagement.IsExportDispatch
                && !SessionCookieManagement.IsInvoice)
            {
                return RedirectToAction("Index", "Home");
            }

            var listItems = new List<SelectListItem>();
            listItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var terms = db.SZ_Terms.ToList();
            foreach (var term in terms)
            {
                listItems.Add(new SelectListItem
                {
                    Text = term.Name,
                    Value = term.Id.ToString()
                });
            }

            ViewBag.termsList = listItems;

            var listCompItems = new List<SelectListItem>();
            listCompItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var compData = db.SZ_CompanyList.OrderBy(x => x.Name.Trim()).ToList();
            foreach (var term in compData)
            {
                bool isblocked = term.IsBlockCompany.HasValue ? term.IsBlockCompany.Value : false;
                listCompItems.Add(new SelectListItem
                {
                    Text = term.Name + " " + isblocked,
                    Value = term.Id.ToString()
                });
            }

            ViewBag.listCompItems = listCompItems;

            var listPaymentTermsItems = new List<SelectListItem>();
            listPaymentTermsItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var paymentTermData = db.PaymentTerms.OrderBy(x => x.Id).ToList();
            foreach (var term in paymentTermData)
            {
                listPaymentTermsItems.Add(new SelectListItem
                {
                    Text = term.Name,
                    Value = term.Name.ToString()
                });
            }

            ViewBag.listPaymentTermsItems = listPaymentTermsItems;

            var model = db.SZ_PerformaInvoice.Where(x => x.Id == id).FirstOrDefault();
            if (model == null)
            {
                model = new SZ_PerformaInvoice();
                model.HSNCode = "38229010";

                string monthyear = string.Empty;
                if (DateTime.Now.Month < 4)
                {
                    monthyear = DateTime.Now.AddYears(-1).Year.ToString().Substring(2, 2) + "-" + DateTime.Now.Year.ToString().Substring(2, 2);
                }
                else
                {
                    monthyear = DateTime.Now.Year.ToString().Substring(2, 2) + "-" + DateTime.Now.AddYears(1).Year.ToString().Substring(2, 2);
                }

                int refNo = 1;
                string value = string.Empty;
                string matchingstring = "SRPL-PI-" + monthyear;
                var SZ_Quotationdata = (from i in db.SZ_PerformaInvoice
                                        where i.PerformaInvoiceNo.StartsWith(matchingstring)
                                        select i).ToList();
                if (SZ_Quotationdata.Count > 0)
                {
                    refNo = SZ_Quotationdata.Select(x => ExtractPINumber(x.PerformaInvoiceNo, matchingstring)).Max(w => w);
                    int newbrokerrewf = Convert.ToInt32(refNo) + 1;

                    value = matchingstring + "-" + newbrokerrewf.ToString().PadLeft(3, '0');
                }
                else
                {
                    value = matchingstring + "-001";
                }

                model.PerformaInvoiceNo = value;
            }
            else
            {
                ViewBag.BillAddress = db.SZ_CompanyAddress.Where(x => x.Id == model.BillAddressId).Select(x => x.Address).FirstOrDefault();
                ViewBag.ShipAddress = db.SZ_CompanyAddress.Where(x => x.Id == model.ShipAddressId).Select(x => x.Address).FirstOrDefault();
            }

            if (string.IsNullOrEmpty(model.HSNCode))
            {
                model.HSNCode = "38229010";
            }
            ViewBag.IsClubQuote = id == 0 ? true : false;
            ViewBag.QuoteId = id;

            var listCountryItems = new List<SelectListItem>();
            listCountryItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var countries = db.Countries.OrderBy(x => x.name).ToList();
            foreach (var term in countries)
            {
                listCountryItems.Add(new SelectListItem
                {
                    Text = term.name,
                    Value = term.name
                });
            }

            ViewBag.CountryList = listCountryItems;

            var listItemscurrency = new List<SelectListItem>();
            listItemscurrency.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var currency = db.SZ_Currency.ToList();
            foreach (var term in currency)
            {
                listItemscurrency.Add(new SelectListItem
                {
                    Text = term.Currency,
                    Value = term.Currency
                });
            }

            ViewBag.listItemscurrency = listItemscurrency;


            var listItemscourier = new List<SelectListItem>();
            listItemscourier.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var courier = db.SZ_Courier.OrderBy(x => x.Name).ToList();
            foreach (var term in courier)
            {
                listItemscourier.Add(new SelectListItem
                {
                    Text = term.Name,
                    Value = term.Name
                });
            }

            ViewBag.listItemscourier = listItemscourier;

            var billingaddressItems = new List<SelectListItem>();
            billingaddressItems.Add(new SelectListItem
            {
                Text = "New Address",
                Value = "0"
            });
            var billaddress = db.SZ_CompanyAddress.Where(x => x.IsBillAddress == true && x.CompanyId == model.CompanyId).ToList();
            foreach (var term in billaddress)
            {
                billingaddressItems.Add(new SelectListItem
                {
                    Text = term.Address,
                    Value = term.Id.ToString()
                });
            }

            ViewBag.billingaddressItems = billingaddressItems;

            var shippingaddressItems = new List<SelectListItem>();
            shippingaddressItems.Add(new SelectListItem
            {
                Text = "New Address",
                Value = "0"
            });
            var shipaddress = db.SZ_CompanyAddress.Where(x => x.IsBillAddress == true && x.CompanyId == model.CompanyId).ToList();
            foreach (var term in shipaddress)
            {
                shippingaddressItems.Add(new SelectListItem
                {
                    Text = term.Address,
                    Value = term.Id.ToString()
                });
            }
            ViewBag.shippingaddressItems = shippingaddressItems;

            return View(model);
        }

        public ActionResult GetCompanyBillingandShippingAddress(int id)
        {
            var billingaddressItems = new List<SelectListItem>();
            billingaddressItems.Add(new SelectListItem
            {
                Text = "New Address",
                Value = "0"
            });
            var billaddress = db.SZ_CompanyAddress.Where(x => x.IsBillAddress == true && x.CompanyId == id).ToList();
            foreach (var term in billaddress)
            {
                billingaddressItems.Add(new SelectListItem
                {
                    Text = term.Address,
                    Value = term.Id.ToString()
                });
            }

            var shippingaddressItems = new List<SelectListItem>();
            shippingaddressItems.Add(new SelectListItem
            {
                Text = "New Address",
                Value = "0"
            });
            var shipaddress = db.SZ_CompanyAddress.Where(x => x.IsBillAddress == true && x.CompanyId == id).ToList();
            foreach (var term in shipaddress)
            {
                shippingaddressItems.Add(new SelectListItem
                {
                    Text = term.Address,
                    Value = term.Id.ToString()
                });
            }
            return Json(new { billingAddress = billingaddressItems, shippingAddress = shippingaddressItems }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult Quote(int id = 0, bool isclubquote = false)
        {
            if (!SessionCookieManagement.IsMiniAdmin && !SessionCookieManagement.IsAdmin && !SessionCookieManagement.IsFollowUp)
            {
                return RedirectToAction("Index", "Home");
            }

            var listItems = new List<SelectListItem>();
            listItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var terms = db.SZ_Terms.AsEnumerable();
            foreach (var term in terms)
            {
                listItems.Add(new SelectListItem
                {
                    Text = term.Name,
                    Value = term.Id.ToString()
                });
            }

            ViewBag.termsList = listItems;

            var listCompItems = new List<SelectListItem>();
            listCompItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            //var compData = db.SZ_CompanyList.Where(x => x.IsBlockCompany == null || x.IsBlockCompany == false).OrderBy(x => x.Name.Trim()).ToList();
            var compData = db.SZ_CompanyList.OrderBy(x => x.Name.Trim()).AsEnumerable();
            foreach (var term in compData)
            {
                bool isblocked = term.IsBlockCompany.HasValue ? term.IsBlockCompany.Value : false;
                listCompItems.Add(new SelectListItem
                {
                    Text = term.Name + " (" + term.SAPCode + ") " + isblocked,
                    Value = term.Id.ToString()
                });
            }

            ViewBag.listCompItems = listCompItems;

            var listPaymentTermsItems = new List<SelectListItem>();
            listPaymentTermsItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var paymentTermData = db.PaymentTerms.OrderBy(x => x.Id).AsEnumerable();
            foreach (var term in paymentTermData)
            {
                listPaymentTermsItems.Add(new SelectListItem
                {
                    Text = term.Name,
                    Value = term.Name.ToString()
                });
            }

            ViewBag.listPaymentTermsItems = listPaymentTermsItems;


            var listIncoTermsItems = new List<SelectListItem>();
            listIncoTermsItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var incoTermData = db.InccoTerms.OrderBy(x => x.Id).AsEnumerable();
            foreach (var term in incoTermData)
            {
                listIncoTermsItems.Add(new SelectListItem
                {
                    Text = term.Name,
                    Value = term.Name.ToString()
                });
            }

            ViewBag.listIncoTermsItems = listIncoTermsItems;

            var model = _operationRepository.GetQuoteByID(id);
            if (model == null)
            {
                model = new SZ_Quotation();
                //TODO: Stoped PO Update Date
                //model.PODate = DateTime.Now;
            }

            ViewBag.IsClubQuote = isclubquote;
            ViewBag.QuoteId = id;

            var listCountryItems = new List<SelectListItem>();
            listCountryItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var countries = db.Countries.OrderBy(x => x.name).AsEnumerable();
            foreach (var term in countries)
            {
                listCountryItems.Add(new SelectListItem
                {
                    Text = term.name,
                    Value = term.name
                });
            }

            ViewBag.CountryList = listCountryItems;

            var listDocTypes = new List<SelectListItem>();
            listDocTypes.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            listDocTypes.Add(new SelectListItem
            {
                Text = "Commercial",
                Value = "1"
            });
            listDocTypes.Add(new SelectListItem
            {
                Text = "Non-Commercial",
                Value = "2"
            });
            ViewBag.DocumentTypeList = listDocTypes;

            if (id > 0)
            {
                try
                {
                    //List of all saved quotation pdf
                    ViewBag.SavedQuotationPDF = model.SZ_QuotationPDF.ToList();

                    if (model.WorkingDate.HasValue && model.WorkingDate.Value.AddMinutes(5) <= DateTime.Now)
                    {
                        model.WorkingDate = DateTime.Now;
                        model.IsWorking = true;
                        model.WorkingUserName = SessionCookieManagement.UserName;
                        db.Entry<SZ_Quotation>(model).State = EntityState.Modified;
                        db.SaveChanges();
                    }
                    //TODO: Add 2 columns in database and manage accordingly this 
                    if (!model.IsWorking.HasValue || model.IsWorking == false)
                    {
                        model.WorkingDate = DateTime.Now;
                        model.IsWorking = true;
                        model.WorkingUserName = SessionCookieManagement.UserName;
                        db.Entry<SZ_Quotation>(model).State = EntityState.Modified;
                        db.SaveChanges();
                    }
                    else
                    {
                        if (SessionCookieManagement.UserName != model.WorkingUserName)
                        {
                            model.HideButton = true;
                            TempData["Quotation"] = model.WorkingUserName + " is working on this quotation";
                        }
                    }
                }
                catch (DbEntityValidationException e)
                {
                    string errortext = "Line: " + e.LineNumber();


                    foreach (var eve in e.EntityValidationErrors)
                    {
                        errortext += "following validation errors:" + eve.Entry.Entity.GetType().Name + " ::: " + eve.Entry.State;
                        foreach (var ve in eve.ValidationErrors)
                        {
                            errortext += "- Property:" + ve.PropertyName + " / Error mesasge : " + ve.ErrorMessage;
                        }
                    }

                    System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Quote Data Error : " + errortext);
                    throw;
                }
            }
            ViewBag.IsQuoteViewOnly = false;
            if (SessionCookieManagement.UserId != 0 && SessionCookieManagement.UserEmail != "parthsuthar2010@gmail.com")
            {
                var customer = db.Customers.Where(x => x.Id == SessionCookieManagement.UserId).FirstOrDefault();
                if (customer.CustomerRoles.Where(x => x.Name.ToLower().Contains("project")).Count() > 0
                    && (customer.CustomerRoles.Where(x => x.Name.ToLower().Contains("price")).Count() == 0
                    && customer.CustomerRoles.Where(x => x.Name.ToLower().Contains("followup")).Count() == 0))
                {
                    ViewBag.IsQuoteViewOnly = true;
                }
            }


            var listItemscurrency = new List<SelectListItem>();
            listItemscurrency.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var currency = db.SZ_Currency.AsEnumerable();
            foreach (var term in currency)
            {
                listItemscurrency.Add(new SelectListItem
                {
                    Text = term.Currency,
                    Value = term.Currency
                });
            }

            ViewBag.listItemscurrency = listItemscurrency;

            if (!string.IsNullOrEmpty(model.ClientRef))
            {
                model.ClientRef = HttpUtility.HtmlDecode(model.ClientRef);
            }

            ViewBag.listAssignTo = CommonOperation.GetCustomerRoleSelectedList("quote");

            return View(model);
        }

        [HttpPost]
        public ActionResult LoadQuoteLogUplaodData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();

                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;
                var list = (from i in db.SZ_Quotation
                            join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                            where (t2.IsUploadServer == null || t2.IsUploadServer == false)
                            && ((string.IsNullOrEmpty(t2.CATNo) || t2.CATNo.Trim().ToLower() == "n/a" || t2.CATNo.Trim().ToLower() == "na")
                            || (string.IsNullOrEmpty(t2.CASNo)))
                            && (t2.MoveToProject == false || t2.MoveToProject == null)
                            orderby i.PODate descending
                            select t2).Distinct().ToList();

                var model = new List<PendingUploadModel>();
                foreach (var k in list)
                {
                    PendingUploadModel subList = new PendingUploadModel();
                    subList.FirstColumn = "<input type='checkbox' id='chk_" + k.Id + "' value='" + k.Id + "' class='clspendingupload' />";
                    subList.QuoteId = k.SZ_Quotation.Id;
                    subList.Ref = k.SZ_Quotation.Ref;
                    subList.PONumber = k.SZ_Quotation.PONo;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.QuoteDetailsId = k.Id;
                    subList.CASNo = k.CASNo;
                    subList.CATNo = k.CATNo;
                    subList.CATNoText = "<input type='text' id='cat_" + k.Id + "' name='cat_" + k.Id + "' value='" + k.CATNo + "' />";
                    subList.CASNoText = "<input type='text' id='cas_" + k.Id + "' name='cas_" + k.Id + "' value='" + k.CASNo + "' />";
                    subList.ProductName = k.ProductName;
                    subList.MoveToProject = k.MoveToProject;
                    subList.IsOnHold = k.IsOnHold;
                    model.Add(subList);
                }

                model = model.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.PONumber).ToList();

                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))).ToList();
                }

                //total number of rows count   
                recordsTotal = model.Count();
                //Paging   
                var data = model.Skip(skip).Take(pageSize).ToList();
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }

        }

        public string GenerateAttachmentHtml(string attachment)
        {
            if (string.IsNullOrEmpty(attachment))
            {
                return "";
            }

            string str = "";
            var records = attachment.Split(',');
            foreach (var item in records)
            {
                str += "<div class='attachitems' data-filename='" + item + "'><a href='/Content/Attachment/" + item + "' target='_blank'><i class='fa fa-download'></i></a></div>";
            }
            return str;
        }

        [HttpPost]
        public ActionResult LoadQuoteUploadData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();



                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;
                var list = (from i in db.SZ_Quotation
                            join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                            where t2.IsForceUpload == true
                            orderby i.CreatedDate descending
                            select t2).Distinct().ToList();

                var model = new List<PendingUploadModel>();
                foreach (var k in list)
                {
                    PendingUploadModel subList = new PendingUploadModel();
                    subList.FirstColumn = "<input type='checkbox' id='chk_" + k.Id + "' value='" + k.Id + "' class='clspendingupload' />";
                    subList.QuoteId = k.SZ_Quotation.Id;
                    subList.Ref = k.SZ_Quotation.Ref;
                    subList.PONumber = k.SZ_Quotation.PONo;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.QuoteDetailsId = k.Id;
                    subList.CASNo = k.CASNo;
                    subList.CATNo = k.CATNo;
                    subList.CATNoText = "<input type='text' id='cat_" + k.Id + "' name='cat_" + k.Id + "' value='" + k.CATNo + "' />";
                    subList.CASNoText = "<input type='text' id='cas_" + k.Id + "' name='cas_" + k.Id + "' value='" + k.CASNo + "' />";
                    subList.ProductName = k.ProductName;
                    subList.MoveToProject = k.MoveToProject;
                    subList.IsOnHold = k.IsOnHold;
                    subList.CreatedbyText = k.SZ_Quotation.CreatedBy;
                    subList.AttachmentText = GenerateAttachmentHtml(k.SZ_Quotation.Attachment);
                    model.Add(subList);
                }

                model = model.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.PONumber).ToList();

                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))).ToList();
                }

                //total number of rows count   
                recordsTotal = model.Count();
                //Paging   
                var data = model.Skip(skip).Take(pageSize).ToList();
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }

        }

        [HttpPost]
        public ActionResult LoadPendingUplaodDatas()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();

                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;
                var list = (from i in db.SZ_Quotation
                            join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                            where
                            //(t2.IsUploadServer == null || t2.IsUploadServer == false) &&
                            ((string.IsNullOrEmpty(t2.CATNo) || t2.CATNo.Trim().ToLower() == "n/a" || t2.CATNo.Trim().ToLower() == "na")
                            || (string.IsNullOrEmpty(t2.CASNo)))
                            && t2.MoveToProject == true
                            && (t2.MoveToDispatch == null || t2.MoveToDispatch == false)
                            orderby i.PODate descending
                            select t2).Distinct().ToList();

                var model = new List<PendingUploadModel>();
                foreach (var k in list)
                {
                    PendingUploadModel subList = new PendingUploadModel();
                    subList.FirstColumn = "<input type='checkbox' id='chk_" + k.Id + "' value='" + k.Id + "' class='clspendingupload' />";
                    subList.QuoteId = k.SZ_Quotation.Id;
                    subList.Ref = k.SZ_Quotation.Ref;
                    subList.PONumber = k.SZ_Quotation.PONo;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.QuoteDetailsId = k.Id;
                    subList.CASNo = k.CASNo;
                    subList.CATNo = k.CATNo;
                    subList.CATNoText = "<input type='text' id='cat_" + k.Id + "' name='cat_" + k.Id + "' value='" + k.CATNo + "' />";
                    subList.CASNoText = "<input type='text' id='cas_" + k.Id + "' name='cas_" + k.Id + "' value='" + k.CASNo + "' />";
                    subList.ProductName = k.ProductName;
                    subList.MoveToProject = k.MoveToProject;
                    subList.IsOnHold = k.IsOnHold;
                    model.Add(subList);
                }

                model = model.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.PONumber).ToList();

                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))).ToList();
                }

                //total number of rows count   
                recordsTotal = model.Count();
                //Paging   
                var data = model.Skip(skip).Take(pageSize).ToList();
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }

        }
        [HttpPost]
        public ActionResult LoadAllPendingUplaodData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();



                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;
                //var list = (from i in db.SZ_Quotation
                //             join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                //             where (t2.IsUploadServer == null || t2.IsUploadServer == false)
                //             && ((string.IsNullOrEmpty(t2.CATNo) || t2.CATNo.Trim().ToLower() == "n/a" || t2.CATNo.Trim().ToLower() == "na")
                //             || (string.IsNullOrEmpty(t2.CATNo)))
                //             orderby i.PODate descending
                //             select t2).Distinct().ToList();
                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
                string pursynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
                var queryData = db.SZ_QueryModule.AsNoTracking().AsQueryable();
                var quotationDetailsdata = db.SZ_QuotationDetail.AsNoTracking().AsQueryable();
                // Getting all Customer data  
                var list = (from i in db.SZ_Quotation.AsNoTracking()
                            join t2 in quotationDetailsdata on i.Id equals t2.QuoteId
                            where t2.MoveToProject == true
                            && string.IsNullOrEmpty(t2.TrackingNo)
                            && (t2.IsOnHold == false || t2.IsOnHold == null)
                            && (t2.ProjectType != inhouseProjectType || t2.ProjectType == null)
                            orderby t2.MoveProjectDate descending
                            select t2).Distinct().AsQueryable();

                list = list.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo);
                var proids = list.Select(x => x.ProductId).ToList();
                var inventorydata = db.SZ_Inventory.Where(x => proids.Contains(x.ProductId)).ToList();
                var model = new List<PendingUploadModel>();
                foreach (var k in list)
                {
                    if (k.SZ_Quotation == null)
                    {
                        continue;
                    }
                    PendingUploadModel subList = new PendingUploadModel();
                    subList.FirstColumn = "<input type='checkbox' id='chk_" + k.Id + "' value='" + k.Id + "' class='clspendingupload' />";
                    subList.QuoteId = k.SZ_Quotation.Id;
                    subList.Ref = k.SZ_Quotation.Ref;
                    subList.PONumber = k.SZ_Quotation.PONo;
                    subList.MoveProjectDate = k.MoveProjectDate;
                    subList.QuoteDetailsId = k.Id;
                    subList.CASNo = k.CASNo;
                    subList.CATNo = k.CATNo;
                    subList.CATNoText = "<input type='text' id='cat_" + k.Id + "' name='cat_" + k.Id + "' value='" + k.CATNo + "' />";
                    subList.CASNoText = "<input type='text' id='cas_" + k.Id + "' name='cas_" + k.Id + "' value='" + k.CASNo + "' />";
                    subList.ProductName = k.ProductName;
                    subList.MoveToProject = k.MoveToProject;
                    subList.IsOnHold = k.IsOnHold;
                    subList.AdditionalBatchNoText = "<select id='additionalBatch_" + k.Id + "' class='addbatch'><option value=''>--Select--</option>";
                    var proBatchData = inventorydata.Where(x => x.ProductId == k.Id).OrderBy(x => x.Id).ToList();
                    if (proBatchData.Count > 0)
                    {
                        int probatchcount = 1;
                        foreach (var r in proBatchData)
                        {
                            string qty = CommonOperation.SettleQtyForSPMS(r);
                            string text = r.BatchNo + " (" + qty + ")";
                            if (r.IsApproved == false)
                            {
                                text = "*" + text;
                            }

                            subList.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' data-value='" + r.BatchNo + "'>" + text + "</option>";
                            probatchcount += 1;
                        }
                    }
                    subList.AdditionalBatchNoText += "</select>";
                    model.Add(subList);
                }

                model = model.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.PONumber).ToList();

                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.PONumber != null && m.PONumber.ToLower().Contains(searchValue))).ToList();
                }

                //total number of rows count   
                recordsTotal = model.Count();
                //Paging   
                var data = model.Skip(skip).Take(pageSize).ToList();
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }

        }
        public ActionResult PendingUpload()
        {
            if (!SessionCookieManagement.IsLogin)
            {
                return RedirectToAction("Index", "Home");
            }

            var list = new List<SZ_QuotationModel>();
            return View(list);
        }

        public ActionResult MissiveResponse()
        {
            if (!SessionCookieManagement.IsLogin)
            {
                return RedirectToAction("Index", "Home");
            }
            var listItems = new List<SelectListItem>();
            listItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var terms = db.MissiveResponses.ToList();
            foreach (var term in terms)
            {
                listItems.Add(new SelectListItem
                {
                    Text = term.Name,
                    Value = term.Id.ToString()
                });
            }
            ViewBag.termsList = listItems;
            return View();
        }

        public ActionResult GetMissiveResponseById(int id)
        {
            var msgData = db.MissiveResponses.Where(x => x.Id == id).FirstOrDefault();
            return Json(new
            {
                data = msgData
            }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public ActionResult SaveMissiveResponseData(TermsModel model)
        {
            try
            {
                var msgData = db.MissiveResponses.FirstOrDefault(x => x.Id == model.Id);
                if (msgData != null)
                {
                    msgData.Description = model.Message;
                    db.Entry<MissiveResponse>(msgData).State = EntityState.Modified;
                    db.SaveChanges();
                }
                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        public ActionResult SendQuoteEmail(TermsModel model)
        {
            var conversionNumber = "";
            try
            {
                var quotedata = db.SZ_Quotation.Where(x => x.Id == model.QuoteId).FirstOrDefault();

                string format = "Mddyyyyhhmmss";
                string date = DateTime.Now.ToString(format);
                var quotepdf = GenerateQuotePDFPath(quotedata, date);

                var listOfCOAAttachment = new List<ConversationMessageModel.AttachmentDataModel>();

                if (quotedata.IsCOA.HasValue && quotedata.IsCOA.Value)
                {
                    var batchnos = quotedata.SZ_QuotationDetail.Select(x => x.QuoteBatchNo).Distinct().ToList();
                    var mastercoa = db.SZ_MasterCOA.Where(x => batchnos.Contains(x.BatchNo)).ToList();
                    if (mastercoa != null && mastercoa.Count > 0)
                    {
                        foreach (var item in mastercoa)
                        {
                            string batchNo = "";
                            string catno = "";
                            string productName = "";

                            batchNo = item.BatchNo;
                            catno = item.CATNo;
                            productName = item.ProductName;
                            //TODO: change this place and move up
                            if (quotedata.IsAnalyticalData.HasValue && quotedata.IsAnalyticalData.Value)
                            {
                                var coapath = GetMasterCOAAndAnylyticalDataPath(item, false, false, true);
                                if (!string.IsNullOrEmpty(coapath))
                                {
                                    byte[] coabytes = System.IO.File.ReadAllBytes(coapath);
                                    var coaBase64Result = Convert.ToBase64String(coabytes);
                                    var coapdffilename = Path.GetFileName(coapath);

                                    var coaattachment = new ConversationMessageModel.AttachmentDataModel();
                                    coaattachment.filename = productName.Replace(" ", "_") + "_" + catno + "_" + batchNo + "_COA.pdf";
                                    coaattachment.base64_data = coaBase64Result;
                                    listOfCOAAttachment.Add(coaattachment);
                                }
                            }
                            else
                            {
                                var coapath = MasterCOAPath(item);
                                byte[] coabytes = System.IO.File.ReadAllBytes(coapath);
                                var coaBase64Result = Convert.ToBase64String(coabytes);
                                var coapdffilename = Path.GetFileName(coapath);

                                var coaattachment = new ConversationMessageModel.AttachmentDataModel();
                                coaattachment.filename = productName.Replace(" ", "_") + "_" + catno + "_" + batchNo + "_COA.pdf";
                                coaattachment.base64_data = coaBase64Result;
                                listOfCOAAttachment.Add(coaattachment);
                            }
                        }
                    }
                }

                bool IsConversation = false;
                foreach (var item in quotedata.Url.Split('/'))
                {
                    if (IsConversation)
                    {
                        conversionNumber = item;
                        IsConversation = false;
                    }
                    if (item == "conversations")
                    {
                        IsConversation = true;
                    }
                }

                ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12 |
                                       SecurityProtocolType.Tls11 |
                                       SecurityProtocolType.Tls |
                                       SecurityProtocolType.Ssl3;

                ConversationMessageModel.Root ConversationModel = new ConversationMessageModel.Root();

                MyWebClient obj = new MyWebClient();

                using (WebClient webClient = new WebClient())
                {
                    webClient.BaseAddress = missiveBaseAddress;
                    webClient.Headers.Add("Authorization", missiveAuthorization);
                    webClient.Headers.Add("HOST", missiveHost);
                    webClient.Headers.Add("contact_book", missiveContractBook);
                    var json = webClient.DownloadString("v1/conversations/" + conversionNumber + "/messages");
                    ConversationModel = JsonConvert.DeserializeObject<ConversationMessageModel.Root>(json);
                }

                using (WebClient webClient = new WebClient())
                {
                    var missiveMessage = ConversationModel.messages.OrderBy(x => x.created_at).FirstOrDefault();
                    var lastmissiveMessage = ConversationModel.messages.OrderByDescending(x => x.created_at).FirstOrDefault();
                    webClient.BaseAddress = missiveBaseAddress;
                    webClient.Headers.Add("Authorization", missiveAuthorization);
                    webClient.Headers.Add("HOST", missiveHost);
                    webClient.Headers.Add("contact_book", missiveContractBook);

                    var url = "v1/drafts";
                    webClient.Headers.Add("user-agent", "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.2; .NET CLR 1.0.3705;)");
                    webClient.Headers[HttpRequestHeader.ContentType] = "application/json";

                    ConversationMessageModel.RootDraft draftmodel = new ConversationMessageModel.RootDraft();
                    var objdraftmodel = new ConversationMessageModel.Draft();
                    objdraftmodel.conversation = conversionNumber;


                    objdraftmodel.references = lastmissiveMessage.references;
                    objdraftmodel.references.Insert(0, lastmissiveMessage.email_message_id);
                    objdraftmodel.quote_previous_message = true;
                    objdraftmodel.send = false;
                    objdraftmodel.to_fields = new List<ConversationMessageModel.ToField>();
                    objdraftmodel.cc_fields = new List<ConversationMessageModel.CcField>();
                    if (Request.Url.AbsoluteUri.Contains("localhost"))
                    {
                        objdraftmodel.subject = "Test Purpose : " + missiveMessage.subject + " #" + quotedata.Ref;
                        var tofieldemail = new ConversationMessageModel.ToField()
                        {
                            name = "Parth Suthar",
                            address = "parth.suthar@synzeal.com"
                        };
                        objdraftmodel.to_fields.Add(tofieldemail);
                    }
                    else
                    {
                        objdraftmodel.subject = missiveMessage.subject + " #" + quotedata.Ref;
                    }
                    objdraftmodel.from_field = new ConversationMessageModel.FromField()
                    {
                        address = "standards@synzeal.com"
                    };

                    if (missiveMessage.from_field != null && !missiveMessage.from_field.address.Contains("@synzeal"))
                    {
                        var tofieldemail = new ConversationMessageModel.ToField()
                        {
                            name = missiveMessage.from_field.name,
                            address = missiveMessage.from_field.address
                        };
                        objdraftmodel.to_fields.Add(tofieldemail);
                    }
                    string tousername = string.Empty;

                    if (quotedata.IsRFQ.HasValue && quotedata.IsRFQ.Value)
                    {
                        if (!string.IsNullOrEmpty(quotedata.EmailAddress))
                        {
                            tousername = quotedata.EmailAddress.Split('@')[0];
                        }
                        var tofieldemail = new ConversationMessageModel.ToField()
                        {
                            name = tousername,
                            address = quotedata.EmailAddress
                        };
                        objdraftmodel.to_fields.Add(tofieldemail);
                    }
                    else
                    {
                        if (missiveMessage.to_fields != null && missiveMessage.to_fields.Count > 0)
                        {
                            foreach (var tofield in missiveMessage.to_fields)
                            {
                                if (!tofield.address.Contains("@synzeal"))
                                {
                                    if (string.IsNullOrEmpty(tousername))
                                    {
                                        tousername = tofield.name;
                                    }
                                    var tofieldemail = new ConversationMessageModel.ToField()
                                    {
                                        name = tofield.name,
                                        address = tofield.address
                                    };
                                    objdraftmodel.to_fields.Add(tofieldemail);
                                }
                            }
                        }
                        if (objdraftmodel.to_fields != null && objdraftmodel.to_fields.Count > 0)
                        {
                            if (missiveMessage.cc_fields != null && missiveMessage.cc_fields.Count > 0)
                            {
                                foreach (var ccfield in missiveMessage.cc_fields)
                                {
                                    if (!ccfield.address.Contains("@synzeal"))
                                    {
                                        var ccfieldemail = new ConversationMessageModel.CcField()
                                        {
                                            name = ccfield.name,
                                            address = ccfield.address
                                        };
                                        objdraftmodel.cc_fields.Add(ccfieldemail);
                                    }
                                }
                            }
                        }
                        else
                        {
                            if (missiveMessage.cc_fields != null && missiveMessage.cc_fields.Count > 0)
                            {
                                foreach (var ccfield in missiveMessage.cc_fields)
                                {
                                    if (!ccfield.address.Contains("@synzeal"))
                                    {
                                        var ccfieldemail = new ConversationMessageModel.ToField()
                                        {
                                            name = ccfield.name,
                                            address = ccfield.address
                                        };
                                        objdraftmodel.to_fields.Add(ccfieldemail);
                                    }
                                }
                            }
                        }
                    }
                    objdraftmodel.bcc_fields = new List<object>();
                    objdraftmodel.attachments = new List<ConversationMessageModel.AttachmentDataModel>();
                    if (!string.IsNullOrEmpty(model.Message))
                    {
                        objdraftmodel.body = model.Message.Replace("%quoteref%", quotedata.Ref).Replace("%username%", tousername);
                    }
                    else
                    {
                        objdraftmodel.body = "";
                    }


                    byte[] bytes = System.IO.File.ReadAllBytes(quotepdf);
                    var Base64Result = Convert.ToBase64String(bytes);
                    var pdffilename = Path.GetFileName(quotepdf);

                    var quoteattachment = new ConversationMessageModel.AttachmentDataModel();
                    quoteattachment.filename = quotedata.CompanyName.Replace(" ", "-") + "-" + quotedata.Ref + ".pdf";
                    quoteattachment.base64_data = Base64Result;
                    objdraftmodel.attachments.Add(quoteattachment);


                    if (listOfCOAAttachment != null)
                    {
                        listOfCOAAttachment.ForEach(i =>
                        {
                            objdraftmodel.attachments.Add(i);
                        });
                    }

                    //if (quotedata.IsCOA.HasValue && quotedata.IsCOA.Value)
                    //{
                    //    var batchnos = quotedata.SZ_QuotationDetail.Select(x => x.QuoteBatchNo).Distinct().ToList();
                    //    var mastercoa = db.SZ_MasterCOA.Where(x => batchnos.Contains(x.BatchNo)).ToList();
                    //    if (mastercoa != null && mastercoa.Count > 0)
                    //    {
                    //        foreach (var item in mastercoa)
                    //        {
                    //            string batchNo = "";
                    //            string catno = "";
                    //            string productName = "";

                    //            batchNo = item.BatchNo;
                    //            catno = item.CATNo;
                    //            productName = item.ProductName;
                    //            //TODO: change this place and move up
                    //            if (quotedata.IsAnalyticalData.HasValue && quotedata.IsAnalyticalData.Value)
                    //            {
                    //                var coapath = GetMasterCOAAndAnylyticalDataPath(item.Id, false, false, true);
                    //                if (!string.IsNullOrEmpty(coapath))
                    //                {
                    //                    byte[] coabytes = System.IO.File.ReadAllBytes(coapath);
                    //                    var coaBase64Result = Convert.ToBase64String(coabytes);
                    //                    var coapdffilename = Path.GetFileName(coapath);

                    //                    var coaattachment = new ConversationMessageModel.AttachmentDataModel();
                    //                    coaattachment.filename = productName.Replace(" ", "_") + "_" + catno + "_" + batchNo + "_COA.pdf";
                    //                    coaattachment.base64_data = coaBase64Result;
                    //                    objdraftmodel.attachments.Add(coaattachment);
                    //                }
                    //            }
                    //            else
                    //            {
                    //                var coapath = MasterCOAPath(item.Id);
                    //                byte[] coabytes = System.IO.File.ReadAllBytes(coapath);
                    //                var coaBase64Result = Convert.ToBase64String(coabytes);
                    //                var coapdffilename = Path.GetFileName(coapath);

                    //                var coaattachment = new ConversationMessageModel.AttachmentDataModel();
                    //                coaattachment.filename = productName.Replace(" ", "_") + "_" + catno + "_" + batchNo + "_COA.pdf";
                    //                coaattachment.base64_data = coaBase64Result;
                    //                objdraftmodel.attachments.Add(coaattachment);
                    //            }
                    //        }
                    //    }
                    //}

                    draftmodel.drafts = objdraftmodel;
                    string data = JsonConvert.SerializeObject(draftmodel);
                    var response = webClient.UploadString(url, data);
                    var resultddds = JsonConvert.DeserializeObject<ConversationMessageModel.RootDraft>(response);

                    quotedata.IsToBe = false;
                    quotedata.IsQuoteApproved = false;
                    quotedata.IsInstock = false;
                    quotedata.IsCustomSynthesis = false;
                    db.Entry(quotedata).State = EntityState.Modified;
                    db.SaveChanges();
                }

                //conversations
                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = "conversation Number: " + conversionNumber + " / line: " + ex.LineNumber() + " " + "Error Text : " + ex.Message + " / Stack Trace : " + ex.StackTrace
                }, JsonRequestBehavior.AllowGet);
            }
        }


        public ActionResult AddMissive()
        {
            return View();
        }

        [HttpPost]
        public JsonResult AddMissiveData(string term)
        {
            try
            {
                MissiveResponse objTerms = new MissiveResponse();
                objTerms.Name = term;
                db.MissiveResponses.Add(objTerms);
                db.SaveChanges();

                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = ""
                }, JsonRequestBehavior.AllowGet);
            }
        }


        public ActionResult Terms()
        {
            if (!SessionCookieManagement.IsLogin)
            {
                return RedirectToAction("Index", "Home");
            }
            var listItems = new List<SelectListItem>();
            listItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var terms = db.SZ_Terms.ToList();
            foreach (var term in terms)
            {
                listItems.Add(new SelectListItem
                {
                    Text = term.Name,
                    Value = term.Id.ToString()
                });
            }
            ViewBag.termsList = listItems;
            return View();
        }

        public ActionResult GetTermsById(int id)
        {
            var msgData = db.SZ_Terms.Where(x => x.Id == id).FirstOrDefault();
            return Json(new
            {
                data = msgData
            }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult DeletePIProduct(int id, bool isClubQuote = false)
        {
            var tempData = db.SZ_PerformaInvoiceDetailsData.Where(x => x.Id == id).FirstOrDefault();
            if (tempData != null)
            {
                db.Entry(tempData).State = EntityState.Deleted;
                db.SaveChanges();
            }
            return Json(true, JsonRequestBehavior.AllowGet);
        }

        public ActionResult DeleteRule(int id)
        {
            var tempData = db.SZ_Rule.Where(x => x.Id == id).FirstOrDefault();
            if (tempData != null)
            {
                var temprules = db.SZ_RuleDetail.Where(x => x.RuleId == id).ToList();
                if (temprules != null && temprules.Count > 0)
                {
                    foreach (var item in temprules)
                    {
                        db.Entry(item).State = EntityState.Deleted;
                    }
                }
                db.Entry(tempData).State = EntityState.Deleted;
                db.SaveChanges();
            }

            MemoryCacheManager objCache = new MemoryCacheManager();
            objCache.Remove("cache.tagsData");
            var tagsData = objCache.Get("cache.tagsData", () =>
            {
                return db.SZ_RuleDetail.ToList();
            });

            return Json(true, JsonRequestBehavior.AllowGet);
        }


        public ActionResult DeleteTempProduct(int id, bool isClubQuote = false)
        {
            var tempData = db.SZ_TempQuotationDetail.Where(x => x.Id == id).FirstOrDefault();
            if (tempData != null)
            {
                db.Entry(tempData).State = EntityState.Deleted;
                db.SaveChanges();
                if (isClubQuote)
                {
                    var clubRecord = db.SZ_ClubQuote.Where(x => x.TempQuoteId == id).FirstOrDefault();
                    if (clubRecord != null)
                    {
                        db.Entry(clubRecord).State = EntityState.Deleted;
                        db.SaveChanges();
                    }
                }
            }
            return Json(true, JsonRequestBehavior.AllowGet);
        }

        public ActionResult CloseCorrectionlogForQuote(int id)
        {
            var tempData = db.SZ_QuoteDetail_Correctionlog.Where(x => x.Id == id).FirstOrDefault();
            if (tempData != null)
            {
                tempData.IsClosed = true;
                db.Entry(tempData).State = EntityState.Modified;
                db.SaveChanges();
            }

            return Json(true, JsonRequestBehavior.AllowGet);
        }

        public ActionResult DeleteProductFromQuoteDetails(int id)
        {
            var tempData = _operationRepository.GetQuoteDetailByID(id);
            if (tempData != null)
            {
                SystemLog objhis = new SystemLog();
                objhis.EntityId = tempData.SZ_Quotation.Id;
                objhis.Entityname = "Quote";
                objhis.Username = SessionCookieManagement.UserName;
                objhis.CreatedDate = System.DateTime.Now;
                objhis.PropertyName = "Delete Quotation Product";
                objhis.FieldName = "Delete Quotation Product"; // need to change
                objhis.Before = tempData.CATNo;
                objhis.After = "";
                objhis.UserId = SessionCookieManagement.UserId;
                db.SystemLogs.Add(objhis);
                db.Entry(tempData).State = EntityState.Deleted;
                db.SaveChanges();

            }
            return Json(true, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public ActionResult SaveTermsData(TermsModel model)
        {
            try
            {
                var msgData = db.SZ_Terms.FirstOrDefault(x => x.Id == model.Id);
                if (msgData != null)
                {
                    msgData.Value = model.Message;
                    db.Entry<SZ_Terms>(msgData).State = EntityState.Modified;
                    db.SaveChanges();
                }
                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        public ActionResult GetTempQuoteDataById(string uniqueId)
        {
            Guid tempGuid = Guid.Parse(uniqueId);
            var tempQuoteData = db.SZ_TempQuotationDetail.Where(x => x.UniqueId == tempGuid).ToList();
            return Json(new
            {
                data = tempQuoteData
            }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult UpdateProductPrice(int productId, string price)
        {
            var product = db.Products.Where(x => x.Id == productId).FirstOrDefault();
            if (product != null)
            {
                product.QuotePrice = price;
                db.Entry(product).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json(true, JsonRequestBehavior.AllowGet);
        }

        [HttpGet]
        public ActionResult UpdateQuoteDetailsFromQuoteList(int id, string batchid, string coa, string activityStatus)
        {
            var szquotedetaildatas = _operationRepository.GetQuoteDetailByID(id);
            if (szquotedetaildatas != null)
            {
                if (!string.IsNullOrEmpty(batchid))
                {
                    szquotedetaildatas.AdditionalBatchNo = Convert.ToInt32(batchid);
                }
                else
                {
                    szquotedetaildatas.AdditionalBatchNo = null;
                }
                if (!string.IsNullOrEmpty(coa))
                {
                    szquotedetaildatas.COAId = Convert.ToInt32(coa);
                    var childCOAData = _operationRepository.GetChildCOAById(szquotedetaildatas.COAId);
                    if (childCOAData != null)
                    {
                        szquotedetaildatas.COARefNumber = childCOAData.RefNo;
                    }
                }
                else
                {
                    szquotedetaildatas.COAId = null;
                    szquotedetaildatas.COARefNumber = "";
                }
                szquotedetaildatas.ActivityStatus = activityStatus;
                db.Entry(szquotedetaildatas).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json(true, JsonRequestBehavior.AllowGet);
        }

        [HttpGet]
        public ActionResult UpdateQuoteDetailsProductRemark(int id, string productremark)
        {
            var szquotedetails = _operationRepository.GetQuoteDetailByID(id);
            if (szquotedetails != null)
            {
                var product = db.Products.Where(x => x.Id == szquotedetails.ProductId).FirstOrDefault();
                if (product != null)
                {
                    product.ProductRemark = productremark;
                    db.Entry(product).State = EntityState.Modified;
                    db.SaveChanges();
                }
            }
            return Json(true, JsonRequestBehavior.AllowGet);
        }


        public ActionResult ValidateQuoteHistory(int productId, int quoteid)
        {
            var allMatchedProducts = db.SZ_QuotationDetail.Where(z =>
                                        !string.IsNullOrEmpty(z.Price)
                                        && z.ProductId == productId
                                        && z.QuoteId != quoteid
                                        && (z.IsOnHold == null || z.IsOnHold == false)
                                        && (z.IsHoldManually == null || z.IsHoldManually == false)
                                        && (z.SZ_Quotation.IsPark == null || z.SZ_Quotation.IsPark == false)
                                        ).OrderByDescending(z => z.Id).ToList();
            if (allMatchedProducts.Count == 0)
            {
                return Json(new
                {
                    success = true,
                    redicon = false,
                    redtenicon = false,
                    firsttime = true,
                    noporeceived = false
                }, JsonRequestBehavior.AllowGet);
            }
            if (allMatchedProducts.Count == allMatchedProducts.OrderByDescending(z => z.CreatedDate).Where(z => z.SZ_Quotation != null && string.IsNullOrEmpty(z.SZ_Quotation.PONo)).Count())
            {
                return Json(new
                {
                    success = true,
                    redicon = false,
                    redtenicon = false,
                    firsttime = false,
                    noporeceived = true
                }, JsonRequestBehavior.AllowGet);
            }
            var RedIconTenCount = allMatchedProducts.OrderByDescending(z => z.CreatedDate).Take(10).Where(z => z.SZ_Quotation != null && string.IsNullOrEmpty(z.SZ_Quotation.PONo)).Count();
            if (RedIconTenCount == 10)
            {
                return Json(new
                {
                    success = true,
                    redicon = false,
                    redtenicon = true,
                    firsttime = false,
                    noporeceived = false
                }, JsonRequestBehavior.AllowGet);
            }
            var RedIconCount = allMatchedProducts.OrderByDescending(z => z.CreatedDate).Take(5).Where(z => z.SZ_Quotation != null && string.IsNullOrEmpty(z.SZ_Quotation.PONo)).Count();
            if (RedIconCount == 5)
            {
                return Json(new
                {
                    success = true,
                    redicon = true,
                    redtenicon = false,
                    firsttime = false,
                    noporeceived = false
                }, JsonRequestBehavior.AllowGet);
            }

            return Json(new
            {
                success = false
            }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult PartialProductList(int quoteId, string Layout = null, bool isHistoryLayout = false)
        {
            string synthesis = Convert.ToString((int)EnumList.ProjectType.Synthesis);
            string pursynthesis = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
            string purchase = Convert.ToString((int)EnumList.ProjectType.Purchase);
            var twoweekdays = DateTime.Now.AddDays(-14);
            ViewBag.isHistoryLayout = isHistoryLayout;
            var model = _operationRepository.GetQuoteDetailByQuoteID(quoteId);
            if (model != null && model.Count > 0)
            {
                MemoryCacheManager objCache = new MemoryCacheManager();

                var catNos = model.Select(x => x.CATNo).Distinct().ToList();
                var querydata = db.SZ_QueryModule.Where(x => catNos.Contains(x.CATNo)).ToList();
                var proids = model.Select(x => x.ProductId).Distinct().ToList();
                var productsData = objCache.Get("cache.productsdata", () =>
                {
                    return db.Products.Where(x => x.Published == true && x.Deleted == false).ToList();
                });
                var inventoryDatacache = objCache.Get("cache.inventoryData", () =>
                {
                    return db.SZ_Inventory.ToList();
                });
                var companyList = objCache.Get("cache.customerdata", () =>
                {
                    return db.SZ_CompanyList.ToList();
                });

                var maincatnamelist = (from i in productsData
                                       where proids.Contains(i.Id)
                                       select new
                                       {
                                           Id = i.Id,
                                           MainCatName = i.MainCatName,
                                           CASNo = i.ManufacturerPartNumber
                                       }).Distinct().ToList();
                var szSAPrawmaterial = (from i in db.SZ_SAPProjectNameData.ToList()
                                        join t2 in maincatnamelist on i.ProjectName equals t2.MainCatName
                                        select t2.Id).ToList();

                var szSAPcasNos = (from i in db.SZ_SAPCASNo.ToList()
                                   join t2 in maincatnamelist on i.CASNo equals t2.CASNo
                                   select t2.CASNo).ToList();

                if (Layout == null)
                {
                    ViewBag.Layout = model[0].SZ_Quotation.LayoutType;
                    if (ViewBag.Layout == null)
                    {
                        ViewBag.Layout = Layout;
                    }
                }
                else
                {
                    ViewBag.Layout = Layout;
                }
                int?[] proIds = model.Select(x => x.ProductId).ToArray();
                var szInventories = inventoryDatacache.Where(x => proIds.Contains(x.ProductId)).ToList();
                var szProducts = productsData.Where(x => proIds.Contains(x.Id)).ToList();
                var szIsSynthesisData = (from i in db.SZ_Quotation.AsNoTracking()
                                         join t2 in db.SZ_QuotationDetail.AsNoTracking() on i.Id equals t2.QuoteId
                                         where t2.ScientistCustomerId != null
                                         && proIds.Contains(t2.ProductId)
                                         && (t2.MoveToDispatch == false || t2.MoveToDispatch == null)
                                         select t2).ToList();
                foreach (var key in TempData.Keys.ToList())
                {
                    TempData.Remove(key);
                }

                string attentionStatus = Convert.ToString(EnumList.ProStatusDDL.Attention);
                string troubleshootlStatus = Convert.ToString(EnumList.ProStatusDDL.TroubleshootL2);
                string troubleshootpStatus = Convert.ToString(EnumList.ProStatusDDL.TroubleshootP2);
                string regtetsynStatus = Convert.ToString(EnumList.ProStatusDDL.RegretRequestSynthesis);
                string purificationStatus = Convert.ToString(EnumList.ProStatusDDL.Purification);

                var holdData = db.Project_HoldTab().ToList();
                var holdqid = holdData.Select(x => x.QuoteDetailsId).ToList();
                var holdproductIddata = db.SZ_QuotationDetail.AsNoTracking().Where(x =>
                    holdqid.Contains(x.Id) &&
                    (
                        x.ProStatus == attentionStatus
                        || x.ProStatus == troubleshootlStatus
                        || x.ProStatus == troubleshootpStatus
                        || x.ProStatus == regtetsynStatus
                        || x.ProStatus == purificationStatus
                    )
                ).Select(x => x.ProductId).ToList();
                var quotehideCompanyIds = companyList.Where(x => x.IsQuoteHide == true).Select(x => x.Id).ToList();
                //var proidsss = model.Select(x => x.ProductId).Distinct().ToList();
                var quotedetlist = _operationRepository.GetQuoteDetailByProductIds(proids);
                model.ForEach(x =>
                {
                    ViewData["tags_" + x.Id] = CommonOperation.GetMatchingTag(x, "Quotedetail");

                    //tags_

                    var lastsixmonth = DateTime.Now.AddMonths(-6);
                    var allMatchedProducts = quotedetlist.Where(z => !string.IsNullOrEmpty(z.Price) && z.ProductId == x.ProductId && z.QuoteId != x.QuoteId).OrderByDescending(z => z.Id).ToList();
                    var matchedProduct = allMatchedProducts.Where(z => z.CreatedDate >= lastsixmonth).OrderByDescending(z => z.Id).ToList();
                    if (holdproductIddata.Where(k => k == x.ProductId).Any())
                    {
                        ViewData["HoldProduct_" + x.Id] = true;
                    }
                    else
                    {
                        ViewData["HoldProduct_" + x.Id] = false;
                    }
                    ViewData["MatchedProduct_" + x.Id] = matchedProduct;
                    var IsControlledSubstance = szProducts.Where(z => z.Id == x.ProductId).Select(z => z.IsControlledSubstance).FirstOrDefault();

                    if (IsControlledSubstance.HasValue && IsControlledSubstance == true)
                    {
                        ViewData["IsControlledSubstance_" + x.Id] = IsControlledSubstance;
                    }
                    else
                    {
                        ViewData["IsControlledSubstance_" + x.Id] = szProducts.Where(z => z.Id == x.ProductId).Select(z => z.IsManuallyControlledSubstance).FirstOrDefault();
                    }
                    ViewData["TracebilityComment_" + x.Id] = szProducts.Where(z => z.Id == x.ProductId).Select(z => z.TracebilityComment).FirstOrDefault();
                    ViewData["IsTracebilityEnable_" + x.Id] = szProducts.Where(z => z.Id == x.ProductId).Select(z => z.IsTracebilityEnable).FirstOrDefault();
                    ViewData["Important_" + x.Id] = szProducts.Where(z => z.Id == x.ProductId).Select(z => z.Important).FirstOrDefault();
                    ViewData["IsColdShipment_" + x.Id] = false;
                    ViewData["IsIcePack_" + x.Id] = false;
                    var p = szProducts.Where(z => z.Id == x.ProductId).FirstOrDefault();
                    if (p != null)
                    {
                        if (!string.IsNullOrEmpty(p.ShippingCondition))
                        {
                            if (p.ShippingCondition == "Cold Shipment")
                            {
                                ViewData["IsColdShipment_" + x.Id] = true;
                            }
                            if (p.ShippingCondition == "Ice Pack")
                            {
                                ViewData["IsIcePack_" + x.Id] = true;
                            }
                        }
                    }


                    ViewData["BlueIcon_" + x.Id] = allMatchedProducts.Where(z => z.SZ_Quotation != null && !string.IsNullOrEmpty(z.SZ_Quotation.PONo)).Count() == 0 ? true : false;
                    ViewData["RedIcon_" + x.Id] = false;
                    var RedIconCount = allMatchedProducts.OrderByDescending(z => z.CreatedDate).Take(5).Where(z => z.SZ_Quotation != null && string.IsNullOrEmpty(z.SZ_Quotation.PONo)).Count();
                    if (RedIconCount == 5)
                    {
                        ViewData["RedIcon_" + x.Id] = true;
                    }
                    if (RedIconCount == allMatchedProducts.Count)
                    {
                        ViewData["RedIcon_" + x.Id] = true;
                    }
                    var inv = szInventories.Where(y => y.ProductId == x.ProductId).ToList();
                    if (inv != null && inv.Count > 0)
                    {
                        ViewData["BatchNo_" + x.ProductId.Value] = string.Join(", ", inv.Select(z => z.BatchNo + " (" + (Convert.ToInt32(z.AvailableQty) < 0 ? "0" : (Convert.ToInt32(z.AvailableQty)).ToString()) + ")"));
                    }
                    ViewData["IsInSynthesis_" + x.ProductId.Value] = szIsSynthesisData.Where(t => t.ProductId == x.ProductId).Select(t => t.SZ_Quotation).Any();

                    int cid = 0;
                    if (x.SZ_Quotation.Currency == "INR")
                    {
                        cid = 2514;
                    }
                    else
                    {
                        cid = 2515;
                    }

                    var filquotehidecompanyids = quotehideCompanyIds.Where(z => z != x.SZ_Quotation.CompanyId).ToList();

                    if (x.ProductId.HasValue && szSAPcasNos.Contains(x.CASNo))
                    {
                        ViewData["RawMaterial_" + x.Id] = "<a href='javascript:void(0)' onclick='getrawmaterialdatabycasno(" + x.ProductId + ")'><i class='fa fa-flask'></i></a>";
                    }

                    if (quotedetlist != null && quotedetlist.Count > 0)
                    {
                        ViewData["Lastprice_" + x.Id] = quotedetlist.Where(z => z.SZ_Quotation != null && z.QuoteId != x.QuoteId && z.SZ_Quotation.CountryType == x.SZ_Quotation.CountryType && z.ProductId == x.ProductId).OrderByDescending(z => z.CreatedDate).Select(z => z.Price).FirstOrDefault();
                    }
                    else
                    {
                        ViewData["Lastprice_" + x.Id] = "";
                    }
                    ViewData["quotePrice_" + x.Id] = szProducts.Where(z => z.Id == x.ProductId).Select(z => z.QuotePrice).FirstOrDefault();
                    ViewData["query_" + x.Id] = querydata.Where(z => z.CATNo == x.CATNo).Count();
                    var isAvailableProductDetails = new List<SZ_QuotationDetail>();
                    if (!string.IsNullOrEmpty(x.CATNo) && x.CATNo != "na" && x.CATNo != "NA" && x.CATNo != "N/A")
                    {
                        isAvailableProductDetails = quotedetlist.Where(z => z.ProductId == x.ProductId && z.Id != x.Id
                        && z.MoveToProject == true && (z.MoveToDispatch == false || z.MoveToDispatch == null) && string.IsNullOrEmpty(z.TrackingNo)
                        && (z.ProjectType == synthesis || z.ProjectType == pursynthesis || z.ProjectType == purchase)).ToList();
                    }
                    ViewData["isAvailableProductDetails_" + x.Id] = isAvailableProductDetails;
                    if (!string.IsNullOrEmpty(x.CATNo))
                    {
                        ViewData["WithPO_" + x.Id] = _operationRepository.QuotationWithPOCount(x.ProductId, x.QuoteId, x.SZ_Quotation.CountryTypeId, filquotehidecompanyids);
                        ViewData["WithoutPO_" + x.Id] = _operationRepository.QuotationWithoutPOCount(x.ProductId, x.QuoteId, x.SZ_Quotation.CountryTypeId, filquotehidecompanyids);
                        ViewData["WithPOOneYear_" + x.Id] = _operationRepository.QuotationWithPOOneYearPOCount(x.ProductId, x.QuoteId, x.SZ_Quotation.CountryTypeId, filquotehidecompanyids);
                        ViewData["WithoutPOOneYear_" + x.Id] = _operationRepository.QuotationWithoutPOOneYearPOCount(x.ProductId, x.QuoteId, x.SZ_Quotation.CountryTypeId, filquotehidecompanyids);
                    }
                });
            }
            return PartialView("_PartialProductList", model);
        }

        [HttpGet]
        public ActionResult FindBatchNoDetailsByCatNo(string catNo)
        {
            string batchNoList = string.Empty;
            var productRecord = db.Products.Where(x => x.Sku.ToLower() == catNo.Trim().ToLower()).FirstOrDefault();
            if (productRecord != null)
            {
                var szInventories = db.SZ_Inventory.Where(x => productRecord.Id == x.ProductId).ToList();
                if (szInventories != null && szInventories.Count > 0)
                {
                    batchNoList = string.Join(", ", szInventories.Select(z => z.BatchNo + " (" + z.Qty + ")"));
                }
            }

            return Json(batchNoList, JsonRequestBehavior.AllowGet);
        }

        public ActionResult PartialPIProductList(int Id)
        {
            var listItemshsncode = new List<SelectListItem>();
            listItemshsncode.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            MemoryCacheManager objCache = new MemoryCacheManager();
            var hsncode = objCache.Get("cache.hsncode", () =>
            {
                return db.SZ_HSNCode.OrderBy(x => x.Name).ToList();
            });

            foreach (var term in hsncode)
            {
                listItemshsncode.Add(new SelectListItem
                {
                    Text = term.Name,
                    Value = term.Name
                });
            }
            ViewBag.listItemshsncode = listItemshsncode;

            var model = new List<SZ_PerformaInvoiceDetailsData>();
            if (Id > 0)
            {
                model = db.SZ_PerformaInvoiceDetailsData.Where(x => x.PerformaInvoiceId == Id).ToList();
            }
            else
            {
                model = db.SZ_PerformaInvoiceDetailsData.Where(x => x.IsClub == true).ToList();
            }
            return PartialView("_PartialPIProductList", model);
        }

        public ActionResult PartialTempProductList(string uniqueId, bool isClubQuote = false)
        {
            Guid tempGuid = Guid.Parse(uniqueId);
            if (isClubQuote)
            {
                var productData = (from i in db.SZ_ClubQuote
                                   join t2 in db.SZ_QuotationDetail on i.QuotationDetailsId equals t2.Id
                                   select new
                                   {
                                       clubId = i.Id,
                                       quoteDetailsId = t2.Id
                                   }).ToList();

                foreach (var i in productData)
                {
                    var product = _operationRepository.GetQuoteDetailByID(i.quoteDetailsId);
                    if (product != null)
                    {
                        var clubCheck = db.SZ_TempQuotationDetail.Where(x => x.ClubQuoteId == i.clubId).FirstOrDefault();
                        if (clubCheck == null)
                        {
                            SZ_TempQuotationDetail objTemp = new SZ_TempQuotationDetail();
                            objTemp.ProductId = product.ProductId;
                            objTemp.CASNo = product.CASNo;
                            objTemp.CreatedDate = DateTime.Now;
                            objTemp.IsUploadServer = product.IsUploadServer;
                            objTemp.ImagePath = product.ImagePath;
                            objTemp.ProductName = product.ProductName;
                            objTemp.CATNo = product.CATNo;
                            objTemp.QuoteId = product.QuoteId;
                            objTemp.UniqueId = tempGuid;
                            objTemp.Price = product.Price;
                            objTemp.LeadTime = product.LeadTime;
                            objTemp.ClubQuoteId = i.clubId;
                            objTemp.IsSynthesisLog = false;
                            objTemp.FinalPrice = product.FinalPrice;
                            objTemp.ProductRemark = "Ref # " + product.SZ_Quotation.Ref + " / " + product.ProductRemark;
                            db.SZ_TempQuotationDetail.Add(objTemp);
                            db.SaveChanges();

                            var clubData = db.SZ_ClubQuote.Where(x => x.Id == i.clubId).FirstOrDefault();
                            if (clubData != null)
                            {
                                clubData.TempQuoteId = objTemp.Id;
                                db.Entry(clubData).State = EntityState.Modified;
                                db.SaveChanges();
                            }
                        }
                    }
                }

                var models = db.SZ_TempQuotationDetail.Where(x => x.ClubQuoteId != null).ToList();
                if (models.Count > 0)
                {

                    int?[] proIds = models.Select(x => x.ProductId).ToArray();
                    var szInventories = db.SZ_Inventory.Where(x => proIds.Contains(x.ProductId)).ToList();
                    models.ForEach(x =>
                    {
                        var inv = szInventories.Where(y => y.ProductId == x.ProductId).ToList();
                        if (inv != null && inv.Count > 0)
                        {
                            TempData["BatchNo_" + x.ProductId.Value] = string.Join(", ", inv.Select(z => z.BatchNo + " (" + z.Qty + ")"));
                        }
                    });
                }
                return PartialView("_PartialTempProductList", models);

            }
            var model = db.SZ_TempQuotationDetail.Where(x => x.UniqueId == tempGuid).ToList();
            int?[] proIdss = model.Select(x => x.ProductId).ToArray();
            var szInventoriess = db.SZ_Inventory.Where(x => proIdss.Contains(x.ProductId)).ToList();
            model.ForEach(x =>
            {
                var invs = szInventoriess.Where(y => y.ProductId == x.ProductId).ToList();
                if (invs != null && invs.Count > 0)
                {
                    TempData["BatchNo_" + x.ProductId.Value] = string.Join(", ", invs.Select(z => z.BatchNo + " (" + z.Qty + ")"));
                }
            });
            return PartialView("_PartialTempProductList", model);
        }

        public int ExtractQuoreRefNumber(string original)
        {
            string matchingstring = "SZ-" + DateTime.Now.ToString("ddMMyy") + "-";
            original = original.Replace(matchingstring, "");
            return Convert.ToInt32(new string(original.Where(c => Char.IsDigit(c)).ToArray()));
        }
        public int ExtractFormNumber(string original)
        {
            string matchingstring = "SZSF-" + DateTime.Now.ToString("ddMMyy") + "-";
            original = original.Replace(matchingstring, "");
            return Convert.ToInt32(new string(original.Where(c => Char.IsDigit(c)).ToArray()));
        }
        public int ExtractPRRequestNumber(string original)
        {
            string matchingstring = "SZ-PR-" + DateTime.Now.ToString("ddMMyy") + "-";
            original = original.Replace(matchingstring, "");
            return Convert.ToInt32(new string(original.Where(c => Char.IsDigit(c)).ToArray()));
        }

        public int ExtractSampleRequestNumber(string original)
        {
            string matchingstring = "SZ-SMP-";
            original = original.Replace(matchingstring, "");
            return Convert.ToInt32(new string(original.Where(c => Char.IsDigit(c)).ToArray()));
        }

        public int ExtractPINumber(string original, string matchingstring)
        {
            original = original.Replace(matchingstring, "");
            return Convert.ToInt32(new string(original.Where(c => Char.IsDigit(c)).ToArray()));
        }

        public int ExtractPurchaseRfqNumber(string original)
        {
            string matchingstring = "SZ-RFQ-";
            original = original.Replace(matchingstring, "");
            return Convert.ToInt32(new string(original.Where(c => Char.IsDigit(c)).ToArray()));
        }

        public int ExtractQueryModukeRefNumber(string original)
        {
            string matchingstring = "SZ-Q-";
            original = original.Replace(matchingstring, "");
            return Convert.ToInt32(new string(original.Where(c => Char.IsDigit(c)).ToArray()));
        }

        [HttpPost]
        public ActionResult ImportNewProductInTempQuote(SZ_QuotationProductModel model)
        {
            try
            {
                if (Request.Files.Count > 0)
                {
                    //  Get all files from Request object  
                    HttpFileCollectionBase files = Request.Files;
                    for (int i = 0; i < files.Count; i++)
                    {
                        HttpPostedFileBase file = files[i];
                        if ((file != null) && (file.ContentLength > 0) && !string.IsNullOrEmpty(file.FileName))
                        {
                            string fileName = file.FileName;
                            string fileContentType = file.ContentType;
                            byte[] fileBytes = new byte[file.ContentLength];
                            var data = file.InputStream.Read(fileBytes, 0, Convert.ToInt32(file.ContentLength));
                            using (var package = new ExcelPackage(file.InputStream))
                            {
                                var currentSheet = package.Workbook.Worksheets;
                                var workSheet = currentSheet.First();
                                var noOfCol = workSheet.Dimension.End.Column;
                                var noOfRow = workSheet.Dimension.End.Row;
                                for (int rowIterator = 2; rowIterator <= noOfRow; rowIterator++)
                                {
                                    string productname = workSheet.Cells[rowIterator, 1].Value.ToString();
                                    string casno = workSheet.Cells[rowIterator, 2].Value != null ? workSheet.Cells[rowIterator, 2].Value.ToString() : string.Empty;
                                    string priceQty = workSheet.Cells[rowIterator, 3].Value != null ? workSheet.Cells[rowIterator, 3].Value.ToString() : string.Empty;
                                    string leadTime = workSheet.Cells[rowIterator, 4].Value != null ? workSheet.Cells[rowIterator, 4].Value.ToString() : "";

                                    //Insert logic save in temp table
                                    SZ_TempQuotationDetail objTemp = new SZ_TempQuotationDetail();
                                    objTemp.ProductId = 0;
                                    objTemp.CASNo = casno;
                                    objTemp.CreatedDate = DateTime.Now;
                                    objTemp.IsUploadServer = model.IsUploadServer;
                                    if (model.ProductId != 0)
                                    {
                                        objTemp.IsUploadServer = true;
                                    }
                                    else
                                    {
                                        objTemp.IsUploadServer = false;
                                    }
                                    objTemp.LeadTime = leadTime;
                                    objTemp.Price = priceQty;
                                    objTemp.ImagePath = string.Empty;
                                    objTemp.ProductName = productname;
                                    objTemp.CATNo = string.Empty;
                                    objTemp.QuoteId = 0;
                                    objTemp.UniqueId = model.UniqueId;
                                    objTemp.IsSynthesisLog = false;
                                    db.SZ_TempQuotationDetail.Add(objTemp);
                                    db.SaveChanges();
                                }
                            }
                        }
                    }

                }

                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }




        [HttpPost]
        public ActionResult ImportCOAFromexcel()
        {
            try
            {
                if (Request.Files.Count > 0)
                {
                    //  Get all files from Request object  
                    HttpFileCollectionBase files = Request.Files;
                    for (int i = 0; i < files.Count; i++)
                    {
                        HttpPostedFileBase file = files[i];
                        if ((file != null) && (file.ContentLength > 0) && !string.IsNullOrEmpty(file.FileName))
                        {
                            string fileName = file.FileName;
                            string fileContentType = file.ContentType;
                            byte[] fileBytes = new byte[file.ContentLength];
                            var data = file.InputStream.Read(fileBytes, 0, Convert.ToInt32(file.ContentLength));
                            using (var package = new ExcelPackage(file.InputStream))
                            {
                                var currentSheet = package.Workbook.Worksheets;
                                var workSheet = currentSheet.First();
                                var noOfCol = workSheet.Dimension.End.Column;
                                var noOfRow = workSheet.Dimension.End.Row;
                                for (int rowIterator = 2; rowIterator <= noOfRow; rowIterator++)
                                {
                                    string CATNo = workSheet.Cells[rowIterator, 1].Value.ToString().Trim();
                                    string BatchNo = workSheet.Cells[rowIterator, 2].Value != null ? workSheet.Cells[rowIterator, 2].Value.ToString().Trim() : string.Empty;
                                    string MolFormula = workSheet.Cells[rowIterator, 3].Value != null ? workSheet.Cells[rowIterator, 3].Value.ToString() : string.Empty;
                                    string MolWeight = workSheet.Cells[rowIterator, 4].Value != null ? workSheet.Cells[rowIterator, 4].Value.ToString() : string.Empty;
                                    string ProductName = workSheet.Cells[rowIterator, 5].Value != null ? workSheet.Cells[rowIterator, 5].Value.ToString() : string.Empty;
                                    string ChemicalName = workSheet.Cells[rowIterator, 6].Value != null ? workSheet.Cells[rowIterator, 6].Value.ToString() : string.Empty;
                                    string Synonym = workSheet.Cells[rowIterator, 7].Value != null ? workSheet.Cells[rowIterator, 7].Value.ToString() : string.Empty;
                                    string Mass = workSheet.Cells[rowIterator, 8].Value != null ? workSheet.Cells[rowIterator, 8].Value.ToString() : string.Empty;
                                    string Solutibility = workSheet.Cells[rowIterator, 9].Value != null ? workSheet.Cells[rowIterator, 9].Value.ToString() : string.Empty;
                                    string IR = workSheet.Cells[rowIterator, 10].Value != null ? workSheet.Cells[rowIterator, 10].Value.ToString() : string.Empty;
                                    string Appearanceofproduct = workSheet.Cells[rowIterator, 11].Value != null ? workSheet.Cells[rowIterator, 11].Value.ToString() : string.Empty;
                                    string Purity = workSheet.Cells[rowIterator, 12].Value != null ? workSheet.Cells[rowIterator, 12].Value.ToString() : string.Empty;
                                    string PurityValue = workSheet.Cells[rowIterator, 13].Value != null ? workSheet.Cells[rowIterator, 13].Value.ToString() : string.Empty;
                                    string Storage = workSheet.Cells[rowIterator, 14].Value != null ? workSheet.Cells[rowIterator, 14].Value.ToString() : string.Empty;
                                    string TGA = workSheet.Cells[rowIterator, 15].Value != null ? workSheet.Cells[rowIterator, 15].Value.ToString() : string.Empty;
                                    string CMR = workSheet.Cells[rowIterator, 16].Value != null ? workSheet.Cells[rowIterator, 16].Value.ToString() : string.Empty;
                                    string Dept = workSheet.Cells[rowIterator, 17].Value != null ? workSheet.Cells[rowIterator, 17].Value.ToString() : string.Empty;
                                    string ROI = workSheet.Cells[rowIterator, 18].Value != null ? workSheet.Cells[rowIterator, 18].Value.ToString() : string.Empty;
                                    string NMR = workSheet.Cells[rowIterator, 19].Value != null ? workSheet.Cells[rowIterator, 19].Value.ToString() : string.Empty;
                                    string Chiral = workSheet.Cells[rowIterator, 20].Value != null ? workSheet.Cells[rowIterator, 20].Value.ToString() : string.Empty;
                                    string IsEquation = workSheet.Cells[rowIterator, 21].Value != null ? workSheet.Cells[rowIterator, 21].Value.ToString() : string.Empty;
                                    string EquationType = workSheet.Cells[rowIterator, 22].Value != null ? workSheet.Cells[rowIterator, 22].Value.ToString() : string.Empty;
                                    string AdditionalInfo = workSheet.Cells[rowIterator, 23].Value != null ? workSheet.Cells[rowIterator, 23].Value.ToString() : string.Empty;
                                    string Attachment = workSheet.Cells[rowIterator, 24].Value != null ? workSheet.Cells[rowIterator, 24].Value.ToString() : string.Empty;
                                    string AnalysisDate = workSheet.Cells[rowIterator, 25].Value != null ? workSheet.Cells[rowIterator, 25].Value.ToString() : string.Empty;
                                    string RetestDate = workSheet.Cells[rowIterator, 26].Value != null ? workSheet.Cells[rowIterator, 26].Value.ToString() : string.Empty;

                                    var masterrecord = db.SZ_MasterCOA
                                        .Where(x => x.CATNo == CATNo.Trim() && x.BatchNo == BatchNo.Trim()).FirstOrDefault();
                                    if (masterrecord == null)
                                    {
                                        var batchlist = (from z in db.Products
                                                         join t2 in db.SZ_Inventory on z.Id equals t2.ProductId
                                                         //join t3 in db.SZ_MasterCOA on t2.Id equals t3.BatchId
                                                         where (z.Sku.ToLower() == CATNo.Trim().ToLower())
                                                               && z.Deleted == false && z.Published == true
                                                         select new
                                                         {
                                                             ProductId = z.Id,
                                                             BatchId = t2.Id,
                                                             CasNo = z.ManufacturerPartNumber,
                                                             Qty = t2.Qty,
                                                             ProductName = z.Name,
                                                             CATNo = z.Sku,
                                                             MolFormula = z.Gtin,
                                                             MolWeight = z.MolecularWeight,
                                                             Synonym = z.Synonym
                                                         }).FirstOrDefault();
                                        var inventoryData = new SZ_Inventory();
                                        if (batchlist != null)
                                        {
                                            inventoryData = db.SZ_Inventory.Where(x => x.ProductId == batchlist.ProductId && x.BatchNo.Trim().ToLower() == BatchNo.Trim().ToLower()).FirstOrDefault();
                                        }
                                        masterrecord = new SZ_MasterCOA();
                                        masterrecord.RefNo = CATNo + "-" + DateTime.Now.ToString("HHmm");
                                        masterrecord.ProductName = !string.IsNullOrEmpty(ProductName) ? ProductName : batchlist.ProductName;
                                        masterrecord.CATNo = CATNo;
                                        masterrecord.ProductId = Convert.ToInt32(batchlist.ProductId);
                                        masterrecord.IsRepresentative = false;
                                        masterrecord.CASNo = batchlist.CasNo;
                                        masterrecord.MolFormula = !string.IsNullOrEmpty(MolFormula) ? MolFormula : batchlist.MolFormula;
                                        masterrecord.MolecularWeight = !string.IsNullOrEmpty(MolWeight) ? MolWeight : batchlist.MolWeight;
                                        masterrecord.AdditionalInfor = AdditionalInfo;
                                        masterrecord.IsEquation = IsEquation == "True" ? true : false;
                                        masterrecord.Dept = Dept;
                                        masterrecord.TGALoss = TGA;
                                        masterrecord.Attachment = Attachment;
                                        masterrecord.Chemicalname = ChemicalName;
                                        masterrecord.HPLCGCELSD = PurityValue;
                                        masterrecord.Purity = Purity;
                                        masterrecord.IR = IR;
                                        masterrecord.Mass = Mass;
                                        masterrecord.BatchId = inventoryData != null ? inventoryData.Id : 0;
                                        masterrecord.BatchNo = BatchNo.Trim();
                                        masterrecord.ResidueOnIgnition = ROI;
                                        masterrecord.CMR = CMR;
                                        masterrecord.NMR = NMR;
                                        masterrecord.StorageCon = !string.IsNullOrEmpty(Storage) ? Storage : "2-8 °C for long term storage";
                                        masterrecord.AppearanceProduct = Appearanceofproduct;
                                        masterrecord.SOLUBILITY = Solutibility;
                                        masterrecord.Synonym = !string.IsNullOrEmpty(Synonym) ? Synonym : batchlist.Synonym;
                                        masterrecord.CreatedDate = DateTime.Now;
                                        masterrecord.UpdatedDate = DateTime.Now;
                                        masterrecord.QuantityAvailable = inventoryData != null ? Convert.ToString(inventoryData.Qty) : null;
                                        masterrecord.EquationType = EquationType;
                                        masterrecord.Potency = Chiral;
                                        if (!string.IsNullOrEmpty(AnalysisDate))
                                        {
                                            masterrecord.AnalysisDate = Convert.ToDateTime(AnalysisDate);
                                        }
                                        else
                                        {
                                            masterrecord.AnalysisDate = null;
                                        }
                                        if (!string.IsNullOrEmpty(RetestDate))
                                        {
                                            masterrecord.ReTestDate = Convert.ToDateTime(RetestDate);
                                        }
                                        else
                                        {
                                            masterrecord.ReTestDate = null;
                                        }
                                        masterrecord.IsLogoAttached = false;
                                        db.SZ_MasterCOA.Add(masterrecord);
                                        db.SaveChanges();
                                    }
                                    else
                                    {
                                        var batchlist = (from z in db.Products
                                                         join t2 in db.SZ_Inventory on z.Id equals t2.ProductId
                                                         //join t3 in db.SZ_MasterCOA on t2.Id equals t3.BatchId
                                                         where (z.Sku.ToLower() == CATNo.Trim().ToLower())
                                                               && z.Deleted == false && z.Published == true
                                                         select new
                                                         {
                                                             ProductId = z.Id,
                                                             BatchId = t2.Id,
                                                             CasNo = z.ManufacturerPartNumber,
                                                             Qty = t2.Qty,
                                                             ProductName = z.Name,
                                                             CATNo = z.Sku,
                                                             MolFormula = z.Gtin,
                                                             MolWeight = z.MolecularWeight,
                                                             Synonym = z.Synonym
                                                         }).FirstOrDefault();

                                        var inventoryData = new SZ_Inventory();
                                        if (batchlist != null)
                                        {
                                            inventoryData = db.SZ_Inventory.Where(x => x.ProductId == batchlist.ProductId && x.BatchNo.Trim().ToLower() == BatchNo.Trim().ToLower()).FirstOrDefault();
                                        }

                                        masterrecord.RefNo = CATNo + "-" + DateTime.Now.ToString("HHmm");
                                        masterrecord.ProductName = !string.IsNullOrEmpty(ProductName) ? ProductName : batchlist.ProductName;
                                        masterrecord.CATNo = CATNo;
                                        masterrecord.ProductId = Convert.ToInt32(batchlist.ProductId);
                                        masterrecord.IsRepresentative = false;
                                        masterrecord.CASNo = batchlist.CasNo;
                                        masterrecord.MolFormula = !string.IsNullOrEmpty(MolFormula) ? MolFormula : batchlist.MolFormula;
                                        masterrecord.MolecularWeight = !string.IsNullOrEmpty(MolWeight) ? MolWeight : batchlist.MolWeight;
                                        masterrecord.AdditionalInfor = AdditionalInfo;
                                        masterrecord.IsEquation = IsEquation == "True" ? true : false;
                                        masterrecord.Dept = Dept;
                                        masterrecord.TGALoss = TGA;
                                        masterrecord.Attachment = Attachment;
                                        masterrecord.Chemicalname = ChemicalName;
                                        masterrecord.HPLCGCELSD = PurityValue;
                                        masterrecord.Purity = Purity;
                                        masterrecord.IR = IR;
                                        masterrecord.Mass = Mass;
                                        masterrecord.BatchId = inventoryData != null ? inventoryData.Id : 0;
                                        masterrecord.BatchNo = BatchNo.Trim();
                                        masterrecord.ResidueOnIgnition = ROI;
                                        masterrecord.CMR = CMR;
                                        masterrecord.NMR = NMR;
                                        masterrecord.StorageCon = !string.IsNullOrEmpty(Storage) ? Storage : "2-8 °C for long term storage";
                                        masterrecord.AppearanceProduct = Appearanceofproduct;
                                        masterrecord.SOLUBILITY = Solutibility;
                                        masterrecord.Synonym = !string.IsNullOrEmpty(Synonym) ? Synonym : batchlist.Synonym;
                                        masterrecord.CreatedDate = DateTime.Now;
                                        masterrecord.UpdatedDate = DateTime.Now;
                                        masterrecord.QuantityAvailable = inventoryData != null ? Convert.ToString(inventoryData.Qty) : null;
                                        masterrecord.EquationType = EquationType;
                                        masterrecord.Potency = Chiral;
                                        if (!string.IsNullOrEmpty(AnalysisDate))
                                        {
                                            masterrecord.AnalysisDate = Convert.ToDateTime(AnalysisDate);
                                        }
                                        else
                                        {
                                            masterrecord.AnalysisDate = null;
                                        }
                                        if (!string.IsNullOrEmpty(RetestDate))
                                        {
                                            masterrecord.ReTestDate = Convert.ToDateTime(RetestDate);
                                        }
                                        else
                                        {
                                            masterrecord.ReTestDate = null;
                                        }
                                        masterrecord.IsLogoAttached = false;
                                        db.Entry(masterrecord).State = EntityState.Modified;
                                        db.SaveChanges();

                                    }
                                }
                            }
                        }
                    }
                }

                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {

                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }


        [HttpPost]
        public ActionResult ImportNewQuoteFromexcel()
        {
            try
            {
                if (Request.Files.Count > 0)
                {
                    //  Get all files from Request object  
                    HttpFileCollectionBase files = Request.Files;
                    for (int i = 0; i < files.Count; i++)
                    {
                        //string path = AppDomain.CurrentDomain.BaseDirectory + "Uploads/";  
                        //string filename = Path.GetFileName(Request.Files[i].FileName);  

                        HttpPostedFileBase file = files[i];
                        if ((file != null) && (file.ContentLength > 0) && !string.IsNullOrEmpty(file.FileName))
                        {
                            string fileName = file.FileName;
                            string fileContentType = file.ContentType;
                            byte[] fileBytes = new byte[file.ContentLength];
                            var data = file.InputStream.Read(fileBytes, 0, Convert.ToInt32(file.ContentLength));
                            using (var package = new ExcelPackage(file.InputStream))
                            {
                                var currentSheet = package.Workbook.Worksheets;
                                var workSheet = currentSheet.First();
                                var noOfCol = workSheet.Dimension.End.Column;
                                var noOfRow = workSheet.Dimension.End.Row;
                                for (int rowIterator = 2; rowIterator <= noOfRow; rowIterator++)
                                {
                                    string referenceNo = workSheet.Cells[rowIterator, 1].Value.ToString();
                                    string companyName = workSheet.Cells[rowIterator, 2].Value != null ? workSheet.Cells[rowIterator, 2].Value.ToString() : string.Empty;
                                    string emailAddress = workSheet.Cells[rowIterator, 3].Value != null ? workSheet.Cells[rowIterator, 3].Value.ToString() : string.Empty;
                                    string poNo = workSheet.Cells[rowIterator, 4].Value != null ? workSheet.Cells[rowIterator, 4].Value.ToString() : string.Empty;
                                    string productName = workSheet.Cells[rowIterator, 5].Value != null ? workSheet.Cells[rowIterator, 5].Value.ToString() : string.Empty;
                                    string priceqty = workSheet.Cells[rowIterator, 6].Value != null ? workSheet.Cells[rowIterator, 6].Value.ToString() : string.Empty;
                                    string casNo = workSheet.Cells[rowIterator, 7].Value != null ? workSheet.Cells[rowIterator, 7].Value.ToString() : string.Empty;
                                    string catNo = workSheet.Cells[rowIterator, 8].Value != null ? workSheet.Cells[rowIterator, 8].Value.ToString() : string.Empty;
                                    string leadTime = workSheet.Cells[rowIterator, 9].Value != null ? workSheet.Cells[rowIterator, 9].Value.ToString() : string.Empty;
                                    var companyData = db.SZ_CompanyList.Where(x => x.Name.Trim().ToLower().Contains(companyName.ToLower().Trim())).FirstOrDefault();
                                    if (!string.IsNullOrEmpty(catNo))
                                    {
                                        catNo = catNo.Trim();
                                    }

                                    var productData = db.Products.Where(x => x.Deleted == false && x.Published == true && x.Sku.ToLower().Contains(catNo.ToLower())).FirstOrDefault();
                                    var model = db.SZ_Quotation.Where(x => x.Ref.Contains(referenceNo.Trim())).FirstOrDefault();
                                    if (model == null)
                                    {
                                        SZ_Quotation objquote = new SZ_Quotation();
                                        objquote.Ref = referenceNo;
                                        if (companyData != null)
                                        {
                                            objquote.CompanyId = companyData.Id;
                                            objquote.CompanyName = companyData.Name;
                                        }
                                        objquote.EmailAddress = emailAddress;
                                        objquote.IsImageAttach = true;
                                        objquote.PONo = poNo;
                                        objquote.IsImportedQuote = true;
                                        objquote.CreatedDate = DateTime.Now;
                                        objquote.CreatedBy = SessionCookieManagement.UserName;
                                        if (objquote.CountryType == "Export")
                                        {
                                            objquote.IsAnalyticalData = true;
                                            objquote.CountryType = "Export";
                                            objquote.CountryTypeId = 2;
                                        }
                                        else
                                        {
                                            objquote.CountryType = "Domestic";
                                            objquote.CountryTypeId = 1;
                                        }
                                        db.SZ_Quotation.Add(objquote);
                                        db.SaveChanges();

                                        SZ_QuotationDetail objdetails = new SZ_QuotationDetail();
                                        objdetails.IsUploadServer = true;
                                        objdetails.CASNo = !string.IsNullOrEmpty(casNo) ? casNo : string.Empty;
                                        objdetails.CATNo = catNo;
                                        objdetails.CreatedDate = DateTime.Now;
                                        objdetails.LeadTime = leadTime;
                                        objdetails.Price = priceqty;
                                        objdetails.ProductId = productData != null ? productData.Id : 0;
                                        objdetails.ProductName = productName;
                                        objdetails.QuoteId = objquote.Id;
                                        objdetails.DisplayOrder = 0;
                                        db.SZ_QuotationDetail.Add(objdetails);
                                        db.SaveChanges();
                                    }
                                    else
                                    {
                                        var quoteData = _operationRepository.GetQuoteByID(model.Id);
                                        if (quoteData != null)
                                        {
                                            if (companyData != null)
                                            {
                                                quoteData.CompanyId = companyData.Id;
                                                quoteData.CompanyName = companyData.Name;
                                            }
                                            quoteData.EmailAddress = emailAddress;
                                            quoteData.PONo = poNo;
                                            db.Entry(quoteData).State = EntityState.Modified;
                                            db.SaveChanges();

                                            SZ_QuotationDetail objdetails = new SZ_QuotationDetail();
                                            objdetails.IsUploadServer = true;
                                            objdetails.CASNo = !string.IsNullOrEmpty(casNo) ? casNo : string.Empty;
                                            objdetails.CATNo = catNo;
                                            objdetails.CreatedDate = DateTime.Now;
                                            objdetails.LeadTime = leadTime;
                                            objdetails.Price = priceqty;
                                            objdetails.ProductId = productData != null ? productData.Id : 0;
                                            objdetails.ProductName = productName;
                                            objdetails.QuoteId = quoteData.Id;
                                            objdetails.DisplayOrder = 0;
                                            db.SZ_QuotationDetail.Add(objdetails);
                                            db.SaveChanges();
                                        }
                                    }
                                }
                            }
                        }
                    }

                }

                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {

                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        public ActionResult ImportQuotationDetailsDataFromexcel()
        {
            try
            {
                var quoteId = Convert.ToInt32(Request.Form["QuoteId"]);
                if (Request.Files.Count > 0)
                {
                    //  Get all files from Request object  
                    HttpFileCollectionBase files = Request.Files;
                    for (int i = 0; i < files.Count; i++)
                    {
                        //string path = AppDomain.CurrentDomain.BaseDirectory + "Uploads/";  
                        //string filename = Path.GetFileName(Request.Files[i].FileName);  

                        HttpPostedFileBase file = files[i];
                        if ((file != null) && (file.ContentLength > 0) && !string.IsNullOrEmpty(file.FileName))
                        {
                            string fileName = file.FileName;
                            string fileContentType = file.ContentType;
                            byte[] fileBytes = new byte[file.ContentLength];
                            var data = file.InputStream.Read(fileBytes, 0, Convert.ToInt32(file.ContentLength));
                            using (var package = new ExcelPackage(file.InputStream))
                            {
                                int disorder = 0;
                                var currentSheet = package.Workbook.Worksheets;
                                var workSheet = currentSheet.First();
                                var noOfCol = workSheet.Dimension.End.Column;
                                var noOfRow = workSheet.Dimension.End.Row;
                                for (int rowIterator = 2; rowIterator <= noOfRow; rowIterator++)
                                {
                                    string referenceNo = workSheet.Cells[rowIterator, 1].Value.ToString();
                                    string productName = workSheet.Cells[rowIterator, 2].Value != null ? workSheet.Cells[rowIterator, 2].Value.ToString() : string.Empty;
                                    string casNo = workSheet.Cells[rowIterator, 3].Value != null ? workSheet.Cells[rowIterator, 3].Value.ToString() : string.Empty;
                                    string catNo = workSheet.Cells[rowIterator, 4].Value != null ? workSheet.Cells[rowIterator, 4].Value.ToString() : string.Empty;

                                    string qty1 = workSheet.Cells[rowIterator, 5].Value != null ? workSheet.Cells[rowIterator, 5].Value.ToString() : string.Empty;
                                    string packsize1 = workSheet.Cells[rowIterator, 6].Value != null ? workSheet.Cells[rowIterator, 6].Value.ToString() : string.Empty;
                                    string qty2 = workSheet.Cells[rowIterator, 7].Value != null ? workSheet.Cells[rowIterator, 7].Value.ToString() : string.Empty;
                                    string packsize2 = workSheet.Cells[rowIterator, 8].Value != null ? workSheet.Cells[rowIterator, 8].Value.ToString() : string.Empty;
                                    string qty3 = workSheet.Cells[rowIterator, 9].Value != null ? workSheet.Cells[rowIterator, 9].Value.ToString() : string.Empty;
                                    string packsize3 = workSheet.Cells[rowIterator, 10].Value != null ? workSheet.Cells[rowIterator, 10].Value.ToString() : string.Empty;
                                    string qty4 = workSheet.Cells[rowIterator, 11].Value != null ? workSheet.Cells[rowIterator, 11].Value.ToString() : string.Empty;
                                    string packsize4 = workSheet.Cells[rowIterator, 12].Value != null ? workSheet.Cells[rowIterator, 12].Value.ToString() : string.Empty;
                                    string leadtime = workSheet.Cells[rowIterator, 13].Value != null ? workSheet.Cells[rowIterator, 13].Value.ToString() : string.Empty;
                                    string productremark = workSheet.Cells[rowIterator, 14].Value != null ? workSheet.Cells[rowIterator, 14].Value.ToString() : string.Empty;

                                    if (!string.IsNullOrEmpty(catNo))
                                    {
                                        catNo = catNo.Trim();
                                    }
                                    else
                                    {
                                        if (!string.IsNullOrEmpty(casNo))
                                        {
                                            casNo = casNo.Trim();
                                            var product = db.Products.Where(x => x.ManufacturerPartNumber == casNo).FirstOrDefault();
                                            if (product != null)
                                            {
                                                catNo = product.Sku;
                                            }
                                        }
                                    }
                                    string Price = string.Empty;
                                    //100 mg@125000 INR

                                    if (!string.IsNullOrEmpty(qty1))
                                    {
                                        Price += qty1 + " mg@";
                                        if (!string.IsNullOrEmpty(packsize1))
                                        {
                                            Price += " X " + packsize1;
                                        }
                                    }
                                    if (!string.IsNullOrEmpty(qty2))
                                    {
                                        if (!string.IsNullOrEmpty(Price))
                                        {
                                            Price += ", ";
                                        }
                                        Price += qty2 + " mg@";
                                        if (!string.IsNullOrEmpty(packsize2))
                                        {
                                            Price += " X " + packsize2;
                                        }
                                    }
                                    if (!string.IsNullOrEmpty(qty3))
                                    {
                                        if (!string.IsNullOrEmpty(Price))
                                        {
                                            Price += ", ";
                                        }
                                        Price += qty3 + " mg@";
                                        if (!string.IsNullOrEmpty(packsize3))
                                        {
                                            Price += " X " + packsize3;
                                        }
                                    }
                                    if (!string.IsNullOrEmpty(qty4))
                                    {
                                        if (!string.IsNullOrEmpty(Price))
                                        {
                                            Price += ", ";
                                        }
                                        Price += qty4 + " mg@";
                                        if (!string.IsNullOrEmpty(packsize4))
                                        {
                                            Price += " X " + packsize4;
                                        }
                                    }

                                    var productData = db.Products.Where(x => x.Deleted == false && x.Published == true && x.Sku.ToLower().Contains(catNo.ToLower())).FirstOrDefault();

                                    SZ_QuotationDetail objdetails = new SZ_QuotationDetail();
                                    objdetails.IsUploadServer = true;
                                    objdetails.CASNo = !string.IsNullOrEmpty(casNo) ? casNo : string.Empty;
                                    objdetails.CATNo = catNo;
                                    objdetails.CreatedDate = DateTime.Now;
                                    objdetails.LeadTime = leadtime;
                                    objdetails.Price = Price;
                                    objdetails.ProductId = productData != null ? productData.Id : 0;
                                    objdetails.IsUploadServer = productData != null ? true : false;
                                    objdetails.CreatedDate = DateTime.Now;
                                    objdetails.ProductName = productName;
                                    objdetails.QuoteId = quoteId;
                                    objdetails.DisplayOrder = disorder;
                                    objdetails.ProductRemark = productremark;
                                    db.Entry(objdetails).State = EntityState.Added;
                                    disorder += 1;
                                }


                                db.SaveChanges();
                            }
                        }
                    }

                }

                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {

                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }


        [HttpPost]
        public ActionResult importPurchaseProductFile()
        {
            try
            {
                if (Request.Files.Count > 0)
                {
                    HttpFileCollectionBase files = Request.Files;
                    for (int i = 0; i < files.Count; i++)
                    {
                        HttpPostedFileBase file = files[i];
                        if ((file != null) && (file.ContentLength > 0) && !string.IsNullOrEmpty(file.FileName))
                        {
                            string fileName = file.FileName;
                            string fileContentType = file.ContentType;
                            byte[] fileBytes = new byte[file.ContentLength];
                            var data = file.InputStream.Read(fileBytes, 0, Convert.ToInt32(file.ContentLength));
                            using (var package = new ExcelPackage(file.InputStream))
                            {
                                var currentSheet = package.Workbook.Worksheets;
                                var workSheet = currentSheet.First();
                                var noOfCol = workSheet.Dimension.End.Column;
                                var noOfRow = workSheet.Dimension.End.Row;
                                for (int rowIterator = 2; rowIterator <= noOfRow; rowIterator++)
                                {
                                    string productName = workSheet.Cells[rowIterator, 2].Value.ToString();
                                    string casno = workSheet.Cells[rowIterator, 3].Value != null ? workSheet.Cells[rowIterator, 3].Value.ToString() : string.Empty;
                                    string suppliercatno = workSheet.Cells[rowIterator, 4].Value != null ? workSheet.Cells[rowIterator, 4].Value.ToString() : string.Empty;
                                    string make = workSheet.Cells[rowIterator, 5].Value != null ? workSheet.Cells[rowIterator, 5].Value.ToString() : string.Empty;
                                    string price = workSheet.Cells[rowIterator, 6].Value != null ? workSheet.Cells[rowIterator, 6].Value.ToString() : string.Empty;
                                    string leadtime = workSheet.Cells[rowIterator, 7].Value != null ? workSheet.Cells[rowIterator, 7].Value.ToString() : string.Empty;
                                    if (!string.IsNullOrEmpty(casno))
                                    {
                                        casno = casno.Trim();
                                    }
                                    if (!string.IsNullOrEmpty(suppliercatno))
                                    {
                                        suppliercatno = suppliercatno.Trim();
                                    }
                                    if (!string.IsNullOrEmpty(make))
                                    {
                                        make = make.Trim();
                                    }
                                    if (!string.IsNullOrEmpty(productName))
                                    {
                                        productName = productName.Trim();
                                    }
                                    if (!string.IsNullOrEmpty(leadtime))
                                    {
                                        leadtime = leadtime.Trim();
                                    }

                                    var model = db.SZ_PurchaseSupplierCatalogue.Where(x => x.CASNo.Contains(casno.Trim()) && x.SupplierCATNo.Contains(suppliercatno.Trim())).FirstOrDefault();
                                    if (model == null)
                                    {
                                        SZ_PurchaseSupplierCatalogue objquote = new SZ_PurchaseSupplierCatalogue();
                                        objquote.CASNo = casno;
                                        objquote.ProductName = productName;
                                        objquote.SupplierCATNo = suppliercatno;
                                        objquote.Make = make;
                                        objquote.Price = price;
                                        objquote.Leadtime = leadtime;
                                        objquote.CreatedDate = DateTime.Now;
                                        objquote.CreatedBy = SessionCookieManagement.UserName;
                                        objquote.UpdatedDate = DateTime.Now;
                                        objquote.UpdatedBy = SessionCookieManagement.UserName;
                                        db.SZ_PurchaseSupplierCatalogue.Add(objquote);
                                        db.SaveChanges();
                                    }
                                    else
                                    {
                                        var quoteData = db.SZ_PurchaseSupplierCatalogue.Where(x => x.Id == model.Id).FirstOrDefault();
                                        if (quoteData != null)
                                        {
                                            quoteData.CASNo = casno;
                                            quoteData.ProductName = productName;
                                            quoteData.SupplierCATNo = suppliercatno;
                                            quoteData.Make = make;
                                            quoteData.Price = price;
                                            quoteData.Leadtime = leadtime;
                                            quoteData.UpdatedDate = DateTime.Now;
                                            quoteData.UpdatedBy = SessionCookieManagement.UserName;
                                            db.Entry(quoteData).State = EntityState.Modified;
                                            db.SaveChanges();
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {

                return Json(new
                {
                    success = false,
                    message = ex.Message
                }, JsonRequestBehavior.AllowGet);
            }
        }

        public ActionResult AddTerm()
        {
            return View();
        }

        [HttpPost]
        public JsonResult AddTermsData(string term)
        {
            try
            {
                SZ_Terms objTerms = new SZ_Terms();
                objTerms.Name = term;
                db.SZ_Terms.Add(objTerms);
                db.SaveChanges();

                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = ""
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpGet]
        public ActionResult ProductDetailsBySku(string sku)
        {
            try
            {
                string uri = Domain + "/api/RestAPI/ProductDetailsBySku?sku=" + sku;
                using (HttpClient httpClient = new HttpClient())
                {
                    Task<String> response = httpClient.GetStringAsync(uri);
                    string productModel = JsonConvert.DeserializeObject<string>(response.Result);
                    var product = JsonConvert.DeserializeObject<ProductDetailsModel>(productModel);
                    return Json(new
                    {
                        success = true,
                        data = product
                    }, JsonRequestBehavior.AllowGet);
                }
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        public ActionResult SaveProductInTempQuote(SZ_QuotationProductModel model)
        {
            try
            {
                if (Request.Files.Count > 0)
                {
                    //  Get all files from Request object  
                    HttpFileCollectionBase files = Request.Files;
                    for (int i = 0; i < files.Count; i++)
                    {
                        //string path = AppDomain.CurrentDomain.BaseDirectory + "Uploads/";  
                        //string filename = Path.GetFileName(Request.Files[i].FileName);  

                        HttpPostedFileBase file = files[i];
                        string fname;
                        string extension = Path.GetExtension(file.FileName);

                        string newfname = Guid.NewGuid().ToString() + extension;
                        // Get the complete folder path and store the file inside it.  
                        fname = Path.Combine(Server.MapPath("~/Content/NewProducts/"), newfname);
                        file.SaveAs(fname);
                        model.ImagePath = "../Content/NewProducts/" + newfname;
                    }

                }

                int? maxDisplayOrderNo = _operationRepository.GetQuoteDetailByQuoteID(model.QuoteId.Value).Max(x => x.DisplayOrder);
                if (maxDisplayOrderNo.HasValue)
                {
                    maxDisplayOrderNo += 1;
                }
                else
                {
                    maxDisplayOrderNo = 1;
                }
                SZ_QuotationDetail objTemp = new SZ_QuotationDetail();
                objTemp.DisplayOrder = maxDisplayOrderNo;
                objTemp.ProductId = model.ProductId;
                objTemp.CASNo = model.CASNo;
                objTemp.CreatedDate = DateTime.Now;
                objTemp.IsUploadServer = model.IsUploadServer;
                if (model.ProductId != 0)
                {
                    objTemp.IsUploadServer = true;
                }
                else
                {
                    objTemp.IsUploadServer = false;
                }
                objTemp.LeadTime = model.LeadTime;
                objTemp.Price = model.Price;
                objTemp.ImagePath = model.ImagePath;
                objTemp.ProductName = model.ProductName;
                objTemp.CATNo = model.CATNo;
                if (string.IsNullOrEmpty(model.CATNo) || model.CATNo == "null")
                {
                    objTemp.CATNo = "";
                }
                objTemp.QuoteId = model.QuoteId.Value;
                objTemp.ProductRemark = model.Productremark;
                if (model.CompanyId.HasValue)
                {
                    var oldproductData = (from i in db.SZ_Quotation
                                          join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                                          where t2.MoveToProject == true && !string.IsNullOrEmpty(i.PONo) && i.CompanyId == model.CompanyId &&
                                          t2.ProductId == model.ProductId
                                          select i).Distinct().ToList();
                    if (oldproductData != null && oldproductData.Count > 0 && !string.IsNullOrEmpty(objTemp.CATNo))
                    {
                        objTemp.ProductRemark += " Earlier PO Ref # " + string.Join(", ", oldproductData.OrderByDescending(x => x.Id).Select(x => x.PONo).Take(5));
                        //objTemp.ProductRemark += "  Ref # " + string.Join(", ", oldproductData.Select(x => x.Ref));
                    }
                }

                var productdata = db.Products.Where(x => x.Id == model.ProductId).FirstOrDefault();
                if (productdata != null)
                {
                    if (!string.IsNullOrEmpty(objTemp.ProductRemark))
                    {
                        objTemp.ProductRemark += " ,";
                    }
                    if (productdata.ShippingCondition == "Cold Shipment")
                    {
                        objTemp.ProductRemark += " Cold Shipment Required";
                    }
                    if (!string.IsNullOrEmpty(productdata.ProductRemark))
                    {
                        objTemp.ProductRemark = productdata.ProductRemark + ", " + objTemp.ProductRemark;
                    }

                    if (productdata.IsControlledSubstance.HasValue && productdata.IsControlledSubstance.Value)
                    {
                        var currantQuote = db.SZ_Quotation.Where(x => x.Id == objTemp.QuoteId).FirstOrDefault();
                        if (currantQuote != null)
                        {
                            if (currantQuote.CountryType == "Export")
                            {
                                objTemp.IsControlledSubstanceCharge = true;
                            }
                        }
                        //if (objTemp.SZ_Quotation.CountryType == "Export")
                        //{
                        //    objTemp.IsControlledSubstanceCharge = true;
                        //}
                    }
                }

                db.SZ_QuotationDetail.Add(objTemp);
                db.SaveChanges();
                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        public ActionResult SaveInvoiceData(SZ_InvoiceModel model)
        {
            var firstquotedetailsid = model.QuoteDetailsModel.Select(x => x.QuoteDetailId).FirstOrDefault();
            SZ_InvoiceData obj = new SZ_InvoiceData();
            obj.QuoteId = model.QuoteId;
            obj.CompanyId = model.CompanyId;
            obj.CompanyName = model.CompanyName;
            var quotedata = _operationRepository.GetQuoteByID(model.QuoteId);
            if (quotedata != null)
            {
                obj.PODate = quotedata.PODate.HasValue ? quotedata.PODate.Value : DateTime.Now;
                obj.PONo = model.PONo;
            }
            var firstquotedetailsdata = _operationRepository.GetQuoteDetailByID(firstquotedetailsid);
            if (firstquotedetailsdata != null)
            {
                obj.Courier = firstquotedetailsdata.Courier;
                obj.TrackingNo = firstquotedetailsdata.TrackingNo;
            }
            obj.InvoiceNo = model.InvoiceNo;
            obj.InvoiceDate = model.InvoiceDate;
            obj.TermsId = model.TermsId;
            obj.Add1 = model.Add1;
            obj.Add2 = model.Add2;
            obj.City = model.City;
            obj.State = model.State;
            obj.PostCode = model.PostCode;
            obj.ShipAdd1 = model.ShipAdd1;
            obj.ShipAdd2 = model.ShipAdd2;
            obj.ShipCity = model.ShipCity;
            obj.ShipState = model.ShipState;
            obj.ShipPostCode = model.ShipPostCode;
            obj.ShipTelno = model.ShipTelno;
            obj.Telno = model.Telno;
            obj.Country = model.Country;
            obj.ShipCountry = model.ShipCountry;
            obj.CreatedDate = DateTime.Now;
            obj.CreatedBy = SessionCookieManagement.UserName;
            obj.Type = model.Type;
            obj.ShippingCost = model.ShippingCost;
            obj.Temperature = model.Temperature;
            obj.GrossWeight = model.GrossWeight;
            db.SZ_InvoiceData.Add(obj);
            db.SaveChanges();

            string courier = "";
            foreach (var item in model.QuoteDetailsModel)
            {
                var quotedetailsdata = _operationRepository.GetQuoteDetailByID(item.QuoteDetailId);
                if (quotedetailsdata != null)
                {
                    quotedetailsdata.TrackingNo = model.TrackingNo;
                    db.Entry(quotedetailsdata).State = EntityState.Modified;

                    courier = quotedetailsdata.Courier;
                    SZ_InvoiceDetailsData objsub = new SZ_InvoiceDetailsData();
                    objsub.InvoiceId = obj.Id;
                    objsub.QuoteDetailsId = item.QuoteDetailId;
                    objsub.ProductId = quotedetailsdata.ProductId;
                    objsub.ProductName = quotedetailsdata.ProductName;
                    objsub.CASNo = quotedetailsdata.CASNo;
                    objsub.CATNo = quotedetailsdata.CATNo;
                    objsub.ADCQty = item.ADCQty;
                    objsub.DSLNo = item.DSLNo;
                    objsub.FOB = item.FOB;
                    objsub.Remark = item.Remark;
                    var inventory = db.SZ_Inventory.Where(x => x.Id == quotedetailsdata.AdditionalBatchNo).FirstOrDefault();
                    if (inventory != null)
                    {
                        objsub.BatchNo = inventory.BatchNo;
                        objsub.BatchId = inventory.Id;
                    }
                    var coadata = db.SZ_ChildCOA.Where(x => x.Id == quotedetailsdata.COAId).FirstOrDefault();
                    if (coadata != null)
                    {
                        if (coadata.ReTestDate.HasValue)
                        {
                            objsub.RetestDate = coadata.ReTestDate.Value;
                        }
                        if (coadata.AnalysisDate.HasValue)
                        {
                            objsub.AnalysisDate = coadata.AnalysisDate.Value;
                        }
                    }
                    objsub.HSN = item.HSN;
                    objsub.Qty = quotedetailsdata.RequiredQty;
                    objsub.Unit = "MG";
                    objsub.Rate = Convert.ToDecimal(item.Rate);
                    if (!string.IsNullOrEmpty(item.Total))
                    {
                        objsub.Total = Convert.ToDecimal(item.Total);
                    }
                    objsub.CreatedDate = DateTime.Now;
                    objsub.CreatedBy = SessionCookieManagement.LoginCompanyName;
                    db.SZ_InvoiceDetailsData.Add(objsub);
                    db.SaveChanges();
                }
            }

            var companyData = db.SZ_CompanyList.Where(x => x.Id == model.CompanyId).FirstOrDefault();
            if (companyData != null)
            {
                companyData.Add1 = model.Add1;
                companyData.Add2 = model.Add2;
                companyData.City = model.City;
                companyData.State = model.State;
                companyData.PostCode = model.PostCode;
                companyData.ShipAdd1 = model.ShipAdd1;
                companyData.ShipAdd2 = model.ShipAdd2;
                companyData.ShipCity = model.ShipCity;
                companyData.ShipState = model.ShipState;
                companyData.ShipCountry = model.ShipCountry;
                companyData.Telno = model.Telno;
                companyData.ShipTelno = model.ShipTelno;
                companyData.ShipPostCode = model.ShipPostCode;
                companyData.PaymentTerms = model.TermsId;
                db.Entry(companyData).State = EntityState.Modified;
                db.SaveChanges();
            }
            if (!string.IsNullOrEmpty(obj.Courier))
            {
                var cid = Convert.ToInt32(obj.Courier);
                ViewBag.Courier = db.SZ_Courier.Where(x => x.Id == cid).Select(x => x.Name).FirstOrDefault();
            }
            var htmlstring = PartialViewdata(this, "_PartialInvoicePDF", obj);
            htmlstring = "<html><head></head><body style='font-family:Tahoma, Verdana, Segoe, sans-serif;font-size:11px;'>" + htmlstring + "</body></html>";
            string path = ConvertHTMLToPDF(htmlstring, filenameDateWise("Invoice_SynZeal_Order_Confirmation"), false, true);

            List<string> fileArray = new List<string>();

            //if (courier == "4" || courier == "1")
            //{
            //    var dhlshippingstring = PartialViewdata(this, "_PartialDHLShipping", obj);
            //    dhlshippingstring = "<html><head></head><body >" + dhlshippingstring + "</body></html>";
            //    string dhlshippingfile = ConvertHTMLToPDF(dhlshippingstring, "Invoice_SynZeal_dhlshipping", false, true);
            //    fileArray.Add(dhlshippingfile);
            //}

            var endusercertificatestring = PartialViewdata(this, "_PartialEndUserCertificate", obj);
            endusercertificatestring = "<html><head></head><body >" + endusercertificatestring + "</body></html>";
            string endusercertificatefile = ConvertHTMLToPDF(endusercertificatestring, filenameDateWise("Invoice_SynZeal_EndUserCertificate"), false, true);
            fileArray.Add(endusercertificatefile);

            var NoDGredstring = PartialViewdata(this, "_PartialNoDGred", obj);
            NoDGredstring = "<html><head></head><body>" + NoDGredstring + "</body></html>";
            string NoDGredfile = ConvertHTMLToPDF(NoDGredstring, filenameDateWise("Invoice_SynZeal_NoDGred"), false, true);
            fileArray.Add(NoDGredfile);

            ////var SCOMETDeclarationstring = PartialViewdata(this, "_PartialSCOMETDeclaration", obj);
            ////SCOMETDeclarationstring = "<html><head></head><body>" + SCOMETDeclarationstring + "</body></html>";
            ////string SCOMETDeclarationfile = ConvertHTMLToPDF(SCOMETDeclarationstring, "Invoice_SynZeal_SCOMETDeclaration", false, true);
            ////fileArray.Add(SCOMETDeclarationfile);

            ////var NDSPstring = PartialViewdata(this, "_PartialNDPSCertificate", obj);
            ////NDSPstring = "<html><head></head><body>" + NDSPstring + "</body></html>";
            ////string NDSPfile = ConvertHTMLToPDF(NDSPstring, "Invoice_SynZeal_NDSP", false, true);
            ////fileArray.Add(NDSPfile);

            ////var clarificationstring = PartialViewdata(this, "_PartialClarificationDeclaration", obj);
            ////clarificationstring = "<html><head></head><body>" + clarificationstring + "</body></html>";
            ////string clarificationfile = ConvertHTMLToPDF(clarificationstring, "Invoice_SynZeal_Clarification", false, true);
            ////fileArray.Add(clarificationfile);

            //var USDAstring = PartialViewdata(this, "_PartialUSDASTATEMENT", obj);
            //USDAstring = "<html><head></head><body>" + USDAstring + "</body></html>";
            //string USDAfile = ConvertHTMLToPDF(USDAstring, "Invoice_SynZeal_USDA", false, true);
            //fileArray.Add(USDAfile);

            //var adcstring = PartialViewdata(this, "_PartialADCSheet", obj);
            //adcstring = "<html><head></head><body>" + adcstring + "</body></html>";
            //string adcstringfile = ConvertHTMLToPDF(adcstring, "Invoice_SynZeal_USDA", false, true, true);
            //fileArray.Add(adcstringfile);

            string specdatafilename = "Merge_" + Guid.NewGuid().ToString() + ".pdf";
            string outputPdfPath = Server.MapPath("~/Content/NewProducts/" + specdatafilename);
            var output = new FileStream(outputPdfPath, FileMode.Create);
            PdfReader reader = null;
            Document sourceDocument = null;
            PdfCopy pdfCopyProvider = null;
            PdfImportedPage importedPage;
            sourceDocument = new Document();
            pdfCopyProvider = new PdfCopy(sourceDocument, output);
            //output file Open  
            sourceDocument.Open();

            foreach (var item in fileArray)
            {
                var fPath = Server.MapPath(item.Replace("..", "~"));
                int pages = Common.TotalPageCount(fPath);

                reader = new PdfReader(fPath);
                //Add pages in new file  
                for (int i = 1; i <= pages; i++)
                {
                    try
                    {
                        importedPage = pdfCopyProvider.GetImportedPage(reader, i);
                        pdfCopyProvider.AddPage(importedPage);
                    }
                    catch (Exception ex)
                    {
                        continue;
                    }
                }
                reader.Close();
            }
            sourceDocument.Close();

            try
            {
                return Json(new
                {
                    success = true,
                    path = path,
                    mergefile = "/Content/NewProducts/" + specdatafilename
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = ex.Message
                }, JsonRequestBehavior.AllowGet);
            }
        }

        public ActionResult BugList()
        {
            var model = new List<SZ_Bug>();
            return View(model);
        }

        [HttpPost]
        public ActionResult SaveProductInQuoteDetails(SZ_QuotationProductModel model)
        {
            try
            {
                if (Request.Files.Count > 0)
                {
                    //  Get all files from Request object  
                    HttpFileCollectionBase files = Request.Files;
                    for (int i = 0; i < files.Count; i++)
                    {
                        //string path = AppDomain.CurrentDomain.BaseDirectory + "Uploads/";  
                        //string filename = Path.GetFileName(Request.Files[i].FileName);  

                        HttpPostedFileBase file = files[i];
                        string fname;
                        string extension = Path.GetExtension(file.FileName);

                        string newfname = Guid.NewGuid().ToString() + extension;
                        // Get the complete folder path and store the file inside it.  
                        fname = Path.Combine(Server.MapPath("~/Content/NewProducts/"), newfname);
                        file.SaveAs(fname);
                        model.ImagePath = "../Content/NewProducts/" + newfname;
                    }

                }
                int? maxDisplayOrderNo = db.SZ_QuotationDetail.Where(x => x.QuoteId == model.QuoteId).Max(x => x.DisplayOrder);
                if (maxDisplayOrderNo.HasValue)
                {
                    maxDisplayOrderNo += 1;
                }

                SZ_QuotationDetail objTemp = new SZ_QuotationDetail();
                objTemp.QuoteId = model.QuoteId.HasValue ? model.QuoteId.Value : 0;
                objTemp.ProductId = model.ProductId;
                objTemp.CASNo = model.CASNo;
                objTemp.CreatedDate = DateTime.Now;
                objTemp.IsUploadServer = model.IsUploadServer;
                if (model.ProductId != 0)
                {
                    objTemp.IsUploadServer = true;
                }
                else
                {
                    objTemp.IsUploadServer = false;
                }
                objTemp.LeadTime = model.LeadTime;
                objTemp.Price = model.Price;
                objTemp.ImagePath = model.ImagePath;
                objTemp.ProductName = model.ProductName;
                objTemp.CATNo = model.CATNo;
                if (string.IsNullOrEmpty(model.CATNo) || model.CATNo == "null")
                {
                    objTemp.CATNo = "";
                }
                objTemp.ProductRemark = model.Productremark;
                objTemp.IsSynthesisLog = false;
                if (model.CompanyId.HasValue)
                {
                    var oldproductData = (from i in db.SZ_Quotation
                                          join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                                          where t2.MoveToProject == true && !string.IsNullOrEmpty(i.PONo) && i.CompanyId == model.CompanyId &&
                                          t2.ProductId == model.ProductId
                                          select i).Distinct().ToList();
                    if (oldproductData != null && oldproductData.Count > 0 && !string.IsNullOrEmpty(objTemp.CATNo))
                    {
                        objTemp.ProductRemark += " Earlier PO Ref # " + string.Join(", ", oldproductData.OrderByDescending(x => x.Id).Select(x => x.PONo).Take(5));
                        //objTemp.ProductRemark += "  Ref # " + string.Join(", ", oldproductData.Select(x => x.Ref));
                    }
                }
                objTemp.DisplayOrder = maxDisplayOrderNo;
                var productdata = db.Products.Where(x => x.Id == model.ProductId).FirstOrDefault();
                if (productdata != null)
                {
                    if (!string.IsNullOrEmpty(objTemp.ProductRemark))
                    {
                        objTemp.ProductRemark += " ,";
                    }
                    if (productdata.ShippingCondition == "Cold Shipment")
                    {
                        objTemp.ProductRemark += " Cold Shipment Required";
                    }
                    if (!string.IsNullOrEmpty(productdata.ProductRemark))
                    {
                        objTemp.ProductRemark = productdata.ProductRemark + ", " + objTemp.ProductRemark;
                    }
                    if (productdata.IsControlledSubstance.HasValue && productdata.IsControlledSubstance.Value)
                    {
                        var currantQuote = db.SZ_Quotation.Where(x => x.Id == objTemp.QuoteId).FirstOrDefault();
                        if (currantQuote != null)
                        {
                            if (currantQuote.CountryType == "Export")
                            {
                                objTemp.IsControlledSubstanceCharge = true;
                            }
                        }
                    }
                }
                db.SZ_QuotationDetail.Add(objTemp);
                db.SaveChanges();

                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult UpdateTempProductInfo(TempProductModel model)
        {
            try
            {
                var szquotedetails = db.SZ_TempQuotationDetail.Where(x => x.Id == model.id).FirstOrDefault();
                if (szquotedetails != null)
                {
                    szquotedetails.ProductName = model.ProductName;
                    szquotedetails.CASNo = model.casno;
                    szquotedetails.CATNo = model.catNo;
                    szquotedetails.Price = model.price;
                    szquotedetails.FinalPrice = model.finalprice;
                    szquotedetails.LeadTime = model.leadtime;
                    szquotedetails.ProductRemark = model.productremark;
                    szquotedetails.IsSynthesisLog = model.synthesislog;
                    if (!string.IsNullOrEmpty(model.estimateDispatchDate))
                    {
                        szquotedetails.EstimateDispatchDate = Convert.ToDateTime(model.estimateDispatchDate);
                    }
                    else
                    {
                        szquotedetails.EstimateDispatchDate = null;
                    }
                    db.Entry(szquotedetails).State = EntityState.Modified;
                    db.SaveChanges();
                }
                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpGet]
        public JsonResult GetMasterCOAIdFromBatchNo(string batchNo)
        {
            var mastercoa = db.SZ_MasterCOA.Where(x => x.BatchNo == batchNo).OrderByDescending(x => x.Id).FirstOrDefault();
            if (mastercoa != null)
            {
                return Json(mastercoa.Id, JsonRequestBehavior.AllowGet);
            }
            return Json(0, JsonRequestBehavior.AllowGet);
        }


        [HttpPost]
        [ValidateInput(false)]
        public ActionResult GetMasterCOAIdFromBatchNos(List<string> id)
        {
            var mastercoa = db.SZ_MasterCOA.Where(x => id.Contains(x.BatchNo)).Select(x => x.Id).ToList();
            if (mastercoa != null && mastercoa.Count > 0)
            {
                return Json(new
                {
                    data = mastercoa,
                    notavailable = db.SZ_MasterCOA.Where(x => !id.Contains(x.BatchNo)).Select(x => x.BatchNo).ToList()
                }, JsonRequestBehavior.AllowGet);
            }
            return Json(new
            {
                data = 0,
                notavailable = id
            }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult replacementProducts(List<int> id)
        {
            var iddata = id[0];
            var firstId = db.SZ_QueryModule.Where(x => x.Id == iddata).Select(x => x.QuoteDetailsId).FirstOrDefault();
            //int firstId = id[0];
            int QuoteId = 0;
            int refNo = 1;
            string value = string.Empty;
            string matchingstring = "SZ-" + DateTime.Now.ToString("ddMMyy") + "-";
            var SZ_Quotationdata = (from i in db.SZ_Quotation
                                    where i.Ref.StartsWith(matchingstring)
                                    select i).ToList();
            if (SZ_Quotationdata.Count > 0)
            {
                refNo = SZ_Quotationdata.Select(x => ExtractQuoreRefNumber(x.Ref)).Max(w => w);
                int newbrokerrewf = Convert.ToInt32(refNo) + 1;

                value = "SZ-" + DateTime.Now.ToString("ddMMyy") + "-" + newbrokerrewf.ToString().PadLeft(2, '0');
            }
            else
            {
                value = "SZ-" + DateTime.Now.ToString("ddMMyy") + "-01";
            }

            var quotedetailsdata = _operationRepository.GetQuoteDetailByID(firstId.Value);
            var quote = quotedetailsdata.SZ_Quotation;
            SZ_Quotation objquote = new SZ_Quotation();
            objquote.Ref = value;
            objquote.CompanyId = quote.CompanyId;
            objquote.CompanyName = quote.CompanyName;
            objquote.EmailAddress = quote.EmailAddress;
            objquote.ClientRef = quote.ClientRef;
            objquote.IsImageAttach = quote.IsImageAttach;
            objquote.PONo = "RE-" + (!string.IsNullOrEmpty(quote.PONo) ? quote.PONo : string.Empty);
            objquote.Remark = quote.Remark;
            objquote.TermsId = quote.TermsId;
            objquote.CountryType = quote.CountryType;
            objquote.UserDistType = quote.UserDistType;
            objquote.IsToBe = quote.IsToBe;
            objquote.IsQuoteApproved = quote.IsQuoteApproved;
            objquote.IsCOA = quote.IsCOA;
            objquote.Auction = quote.Auction;
            objquote.PODate = quote.PODate.HasValue ? quote.PODate.Value : DateTime.Now;
            objquote.SuggChemName = quote.SuggChemName;
            objquote.Attachment = quote.Attachment;
            objquote.CreatedDate = DateTime.Now;
            objquote.EmailCC = quote.EmailCC;
            objquote.IsFollowupRequired = quote.IsFollowupRequired;
            if (quote.IsQuoteApproved.HasValue && quote.IsQuoteApproved.Value)
            {
                objquote.ApprovedBy = SessionCookieManagement.UserName;
            }
            objquote.CreatedBy = SessionCookieManagement.UserName;
            if (objquote.CountryType == "Export")
            {
                objquote.IsAnalyticalData = true;

                objquote.CountryType = "Export";
                objquote.CountryTypeId = 2;
            }
            else
            {
                objquote.CountryType = "Domestic";
                objquote.CountryTypeId = 1;
            }
            db.SZ_Quotation.Add(objquote);
            db.SaveChanges();

            QuoteId = objquote.Id;

            int displayOrder = 0;
            foreach (var i in id)
            {
                var quotedetailsid = db.SZ_QueryModule.Where(x => x.Id == i).Select(x => x.QuoteDetailsId).FirstOrDefault();

                var qd = _operationRepository.GetQuoteDetailByID(quotedetailsid.Value);

                SZ_QuotationDetail objdetails = new SZ_QuotationDetail();
                objdetails.IsUploadServer = qd.IsUploadServer;
                objdetails.CASNo = qd.CASNo;
                objdetails.CATNo = qd.CATNo;
                objdetails.CreatedDate = DateTime.Now;
                objdetails.ImagePath = qd.ImagePath;
                objdetails.LeadTime = qd.LeadTime;
                objdetails.EstimateDispatchDate = qd.EstimateDispatchDate;
                objdetails.Price = qd.Price;
                objdetails.FinalPrice = qd.FinalPrice;
                objdetails.ProductId = qd.ProductId;
                objdetails.ProductName = qd.ProductName;
                objdetails.QuoteId = objquote.Id;
                objdetails.DisplayOrder = displayOrder;
                objdetails.ProductRemark = qd.ProductRemark;
                objdetails.ProcessState = (int)EnumList.ProcessState.InProgress;
                objdetails.ProjectStatus = (int)EnumList.ProjectStatus.NoAction;
                objdetails.IsSynthesisLog = qd.IsSynthesisLog;
                db.SZ_QuotationDetail.Add(objdetails);

                displayOrder += 1;
            }

            db.SaveChanges();
            return new JsonResult()
            {
                JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                Data = new { success = true, message = "Moved successfully.." }
            };
        }

        [HttpPost]
        public ActionResult SavePerformaInvoice(SZ_PerformaInvoiceModelcs model)
        {
            int performaInvoiceid = 0;
            int billingAddressId = 0;
            int shippingAddressId = 0;

            if (model.BillAddressId == 0)
            {
                if (!string.IsNullOrEmpty(model.BillAddress))
                {
                    SZ_CompanyAddress objAddress = new SZ_CompanyAddress();
                    objAddress.Address = model.BillAddress;
                    objAddress.CompanyId = model.CompanyId;
                    objAddress.Country = model.BillCountry;
                    objAddress.IsBillAddress = true;
                    objAddress.Pincode = "";
                    objAddress.TelNo = model.BillTelno;
                    objAddress.CreatedDate = DateTime.Now;
                    objAddress.Createdby = SessionCookieManagement.UserName;
                    objAddress.UpdatedDate = DateTime.Now;
                    objAddress.UpdatedBy = SessionCookieManagement.UserName;
                    db.SZ_CompanyAddress.Add(objAddress);
                    db.SaveChanges();

                    billingAddressId = objAddress.Id;
                    model.BillAddressId = objAddress.Id;
                }
            }
            else
            {
                var billadd = db.SZ_CompanyAddress.Where(x => x.Id == model.BillAddressId).FirstOrDefault();
                if (billadd != null)
                {
                    billadd.Address = model.BillAddress;
                    billadd.CompanyId = model.CompanyId;
                    billadd.Country = model.BillCountry;
                    billadd.TelNo = model.BillTelno;
                    billadd.UpdatedDate = DateTime.Now;
                    billadd.UpdatedBy = SessionCookieManagement.UserName;
                    db.Entry(billadd).State = EntityState.Modified;
                    db.SaveChanges();
                }
            }
            if (model.ShipAddressId == 0)
            {
                if (!string.IsNullOrEmpty(model.ShipAddress))
                {
                    SZ_CompanyAddress objAddress = new SZ_CompanyAddress();
                    objAddress.Address = model.ShipAddress;
                    objAddress.CompanyId = model.CompanyId;
                    objAddress.Country = model.ShipCountry;
                    objAddress.IsBillAddress = false;
                    objAddress.Pincode = "";
                    objAddress.TelNo = model.ShipTelno;
                    objAddress.CreatedDate = DateTime.Now;
                    objAddress.Createdby = SessionCookieManagement.UserName;
                    objAddress.UpdatedDate = DateTime.Now;
                    objAddress.UpdatedBy = SessionCookieManagement.UserName;
                    db.SZ_CompanyAddress.Add(objAddress);
                    db.SaveChanges();

                    shippingAddressId = objAddress.Id;
                    model.ShipAddressId = objAddress.Id;
                }
            }
            else
            {
                var shipadd = db.SZ_CompanyAddress.Where(x => x.Id == model.ShipAddressId).FirstOrDefault();
                if (shipadd != null)
                {
                    shipadd.TelNo = model.ShipTelno;
                    shipadd.Address = model.ShipAddress;
                    shipadd.CompanyId = model.CompanyId;
                    shipadd.Country = model.ShipCountry;
                    shipadd.UpdatedDate = DateTime.Now;
                    shipadd.UpdatedBy = SessionCookieManagement.UserName;
                    db.Entry(shipadd).State = EntityState.Modified;
                    db.SaveChanges();
                }
            }

            if (model.Id == 0)
            {
                SZ_PerformaInvoice objPI = new SZ_PerformaInvoice();
                objPI.CompanyId = model.CompanyId;
                objPI.CustomerPoNo = model.CustomerPoNo;
                objPI.BillCompanyName = model.BillCompanyName;
                objPI.ShipCompanyName = model.ShipCompanyName;
                objPI.PerformaInvoiceNo = model.PerformaInvoiceNo;
                objPI.PerformaInvoiceDate = model.PerformaInvoiceDate;
                objPI.TrackingNo = "";
                objPI.Courier = model.Courier;
                objPI.TermsId = model.PaymentTerm;
                objPI.BillAddressId = model.BillAddressId;
                objPI.BillCountry = model.BillCountry;
                objPI.ShipAddressId = model.ShipAddressId;
                objPI.ShipCountry = model.ShipCountry;
                objPI.BillTelno = model.BillTelno;
                objPI.ShipTelno = model.ShipTelno;
                objPI.CreatedDate = DateTime.Now;
                objPI.CreatedBy = SessionCookieManagement.UserName;
                objPI.ShippingCost = !string.IsNullOrEmpty(model.ShippingCost) ? Convert.ToInt32(model.ShippingCost) : 0;
                objPI.Temperature = "";
                objPI.GrossWeight = model.GrossWeight;
                objPI.NetWeight = model.NetWeight;
                objPI.HSNCode = model.HSNCode;
                objPI.Currency = model.Currency;
                objPI.Incoterm = model.Incoterm;
                objPI.PortOfDischarge = model.PortOfDischarge;
                objPI.IsVisibleGood = false;

                objPI.IsIGST = model.IsIGST;
                objPI.BillGSTNo = model.BillGSTNo;
                objPI.ShipGSTNo = model.ShipGSTNo;
                db.SZ_PerformaInvoice.Add(objPI);
                db.SaveChanges();

                performaInvoiceid = objPI.Id;

                var clubPI = db.SZ_PerformaInvoiceDetailsData.Where(x => x.IsClub == true).ToList();
                if (clubPI != null && clubPI.Count > 0)
                {
                    clubPI.ForEach(item =>
                    {
                        item.IsClub = false;
                        item.PerformaInvoiceId = performaInvoiceid;

                        if (!string.IsNullOrEmpty(item.QuoteDetailsPrice))
                        {
                            if (item.QuoteDetailsPrice.Contains("X"))
                            {
                                var splicross = item.QuoteDetailsPrice.Split('X');
                                var firstmg = splicross[0].Split('@')[0];
                                var secvial = splicross[1].Split('=')[0];

                                item.Qty = firstmg + " X " + secvial;
                                item.Rate = Convert.ToDecimal(splicross[0].Split('@')[1].Split(' ')[0]);
                                item.Total = Convert.ToDecimal(splicross[1].Split('=')[1].Trim().Split(' ')[0]);
                            }
                            else
                            {
                                var firstmg = item.QuoteDetailsPrice.Split('@')[0];
                                item.Qty = firstmg + " X 1";
                                item.Rate = Convert.ToDecimal(item.QuoteDetailsPrice.Split('@')[1].Split(' ')[0]);
                                item.Total = Convert.ToDecimal(item.QuoteDetailsPrice.Split('@')[1].Split(' ')[0]);
                            }
                        }
                    });
                }
                db.SaveChanges();
            }
            else
            {
                performaInvoiceid = model.Id;
                var objPI = db.SZ_PerformaInvoice.Where(x => x.Id == model.Id).FirstOrDefault();
                if (objPI != null)
                {
                    objPI.CompanyId = model.CompanyId;
                    objPI.CustomerPoNo = model.CustomerPoNo;
                    objPI.BillCompanyName = model.BillCompanyName;
                    objPI.ShipCompanyName = model.ShipCompanyName;
                    objPI.PerformaInvoiceNo = model.PerformaInvoiceNo;
                    objPI.PerformaInvoiceDate = model.PerformaInvoiceDate;
                    objPI.Courier = model.Courier;
                    objPI.TermsId = model.PaymentTerm;
                    objPI.BillAddressId = model.BillAddressId;
                    objPI.BillCountry = model.BillCountry;
                    objPI.ShipAddressId = model.ShipAddressId;
                    objPI.ShipCountry = model.ShipCountry;
                    objPI.BillTelno = model.BillTelno;
                    objPI.ShipTelno = model.ShipTelno;
                    objPI.CreatedBy = SessionCookieManagement.UserName;
                    objPI.HSNCode = model.HSNCode;
                    objPI.Currency = model.Currency;
                    objPI.Incoterm = model.Incoterm;
                    objPI.PortOfDischarge = model.PortOfDischarge;
                    objPI.Temperature = "";
                    objPI.GrossWeight = model.GrossWeight;
                    objPI.NetWeight = model.NetWeight;
                    objPI.IsVisibleGood = false;
                    objPI.ShippingCost = !string.IsNullOrEmpty(model.ShippingCost) ? Convert.ToInt32(model.ShippingCost) : 0;
                    objPI.IsIGST = model.IsIGST;
                    objPI.BillGSTNo = model.BillGSTNo;
                    objPI.ShipGSTNo = model.ShipGSTNo;
                    db.Entry(objPI).State = EntityState.Modified;
                    db.SaveChanges();
                }
            }

            string returnFilePath = string.Empty;
            if (model.SaveAndPdf)
            {
                var obj = db.SZ_PerformaInvoice.Where(x => x.Id == performaInvoiceid).FirstOrDefault();
                var htmlstring = PartialViewdata(this, "_PartialPerformaInvoicePDF", obj);
                htmlstring = "<html><head></head><body style='font-family:Tahoma, Verdana, Segoe, sans-serif;font-size:11px;'>" + htmlstring + "</body></html>";
                //string path = printpdf(htmlstring, "Invoice_SynZeal_Order_Confirmation", true);
                returnFilePath = ConvertHTMLToPDF(htmlstring, "PerformaInvoice_SynZeal_Order_Confirmation", false, true);
            }

            return Json(new
            {
                success = true,
                piId = performaInvoiceid,
                returnFilePath = returnFilePath
            }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult DownloadPI(int id)
        {
            var obj = db.SZ_PerformaInvoice.Where(x => x.Id == id).FirstOrDefault();

            var htmlstring = PartialViewdata(this, "_PartialPerformaInvoicePDFNew", obj);
            htmlstring = "<html><head></head><body style='font-family:Tahoma, Verdana, Segoe, sans-serif;font-size:11px;'>" + htmlstring + "</body></html>";
            string path = printpdf(htmlstring, "Invoice_SynZeal_Order_Confirmation", true);



            //var htmlstring = PartialViewdata(this, "_PartialPerformaInvoicePDF", obj);
            //htmlstring = "<html><head></head><body style='font-family:Tahoma, Verdana, Segoe, sans-serif;font-size:11px;'>" + htmlstring + "</body></html>";
            //string path = ConvertHTMLToPDF(htmlstring, "PerformaInvoice_SynZeal_Order_Confirmation", false, true);

            return File(path, "application/pdf", Server.UrlEncode(filenameDateWise(obj.PerformaInvoiceNo) + ".pdf"));
        }

        public void GenerateQuotation(SZ_CompanyList company, Category category, List<Product> products)
        {
            // Save Quote
            int refNo = 1;
            string value = string.Empty;
            string matchingstring = "SZ-" + DateTime.Now.ToString("ddMMyy") + "-";
            var SZ_Quotationdata = (from i in db.SZ_Quotation
                                    where i.Ref.StartsWith(matchingstring)
                                    select i).ToList();
            if (SZ_Quotationdata.Count > 0)
            {
                refNo = SZ_Quotationdata.Select(x => ExtractQuoreRefNumber(x.Ref)).Max(w => w);
                int newbrokerrewf = Convert.ToInt32(refNo) + 1;

                value = "SZ-" + DateTime.Now.ToString("ddMMyy") + "-" + newbrokerrewf.ToString().PadLeft(2, '0');
            }
            else
            {
                value = "SZ-" + DateTime.Now.ToString("ddMMyy") + "-01";
            }
            int QuoteId = 0;
            SZ_Quotation objquote = new SZ_Quotation();
            objquote.Ref = value;
            objquote.CompanyId = company.Id;
            objquote.CompanyName = company.Name;
            objquote.EmailAddress = "standards@synzeal.com";
            objquote.ClientRef = category.Name;
            objquote.IsImageAttach = true;
            objquote.PONo = string.Empty;
            objquote.Remark = string.Empty;
            objquote.TermsId = company.Name.ToLower().Contains("domestic") ? 3 : 2;
            objquote.CountryType = company.Name.ToLower().Contains("domestic") ? "Domestic" : "Export";
            if (objquote.CountryType == "Export")
            {
                objquote.CountryTypeId = 2;
            }
            else
            {
                objquote.CountryTypeId = 1;
            }
            objquote.UserDistType = "User";
            objquote.IsToBe = true;
            objquote.IsQuoteApproved = false;
            objquote.IsCOA = true;
            objquote.Auction = false;
            //TODO: Stoped PO Update Date
            //objquote.PODate = DateTime.Now;
            objquote.SuggChemName = string.Empty;
            objquote.Attachment = string.Empty;
            objquote.CreatedDate = DateTime.Now;
            objquote.EmailCC = string.Empty;
            objquote.IsFollowupRequired = false;
            objquote.IsShowDashboard = false;
            objquote.IsStudy = false;
            //if (false)
            //{
            //    objquote.ApprovedBy = SessionCookieManagement.UserName;
            //    objquote.IsShowDashboard = false;
            //    objquote.IsStudy = false;
            //}
            objquote.CreatedBy = SessionCookieManagement.UserName;
            objquote.LayoutType = "Standard";
            objquote.IsInstock = false;
            objquote.IsCustomSynthesis = false;
            objquote.IsPreviewed = false;
            objquote.IsReviewed = false;
            objquote.QuoteComment = "";
            objquote.PaymentTerm = "";
            objquote.IsShippedCharge = false;
            objquote.PurchaseName = "";
            objquote.PurchaseContactNo = "";
            objquote.PurchaseEmail = "";
            objquote.PurchaseAddress = "";
            objquote.PurchaseCity = "";
            objquote.PurchaseCountry = "";
            objquote.TechnicalName = "";
            objquote.TechnicalContactNo = "";
            objquote.TechnicalEmail = "";
            objquote.TechnicalAddress = "";
            objquote.TechnicalCity = "";
            objquote.TechnicalCountry = "";
            objquote.Currency = company.Name.ToLower().Contains("domestic") ? "INR" : "USD";
            objquote.IsAnalyticalData = false;
            objquote.IsRegret = false;
            objquote.QuotePDF = "";
            objquote.EmailReceivedDate = null;
            objquote.IsCompleted = false;
            objquote.IsRFQManually = false;
            db.SZ_Quotation.Add(objquote);
            db.SaveChanges();

            QuoteId = objquote.Id;

            int displayOrder = 0;
            foreach (var i in products)
            {
                SZ_QuotationDetail objdetails = new SZ_QuotationDetail();
                objdetails.IsUploadServer = true;
                objdetails.CASNo = i.ManufacturerPartNumber;
                objdetails.CATNo = i.Sku;
                objdetails.CreatedDate = DateTime.Now;
                objdetails.ImagePath = i.ImagePath;
                objdetails.LeadTime = i.LeadTime;
                objdetails.EstimateDispatchDate = DateTime.Now;
                objdetails.Price = company.Name.ToLower().Contains("domestic") ? "10mg@ INR, 25mg@ INR, 50mg@ INR, 100mg@ INR" : "10mg@ USD, 25mg@ USD, 50mg@ USD, 100mg@ USD";
                objdetails.FinalPrice = "";
                objdetails.ProductId = i.Id;
                objdetails.ProductName = i.Name;
                objdetails.QuoteId = objquote.Id;
                objdetails.DisplayOrder = displayOrder;
                objdetails.ProductRemark = "";
                objdetails.ProcessState = (int)EnumList.ProcessState.InProgress;
                objdetails.ProjectStatus = (int)EnumList.ProjectStatus.NoAction;
                objdetails.IsSynthesisLog = false;
                db.SZ_QuotationDetail.Add(objdetails);
                displayOrder += 1;
            }
            db.SaveChanges();
        }

        public ActionResult GenerateAPIQuoteData()
        {
            var domesticCompany = db.SZ_CompanyList.Where(x => x.Name == "BD Master - Domestic").FirstOrDefault();
            var internationalCompany = db.SZ_CompanyList.Where(x => x.Name == "BD Master - International").FirstOrDefault();

            var categoryList = db.Categories.Where(x => x.Published == true && x.Deleted == false).ToList();
            foreach (var category in categoryList.Where(x => x.ParentCategoryId == 0))
            {
                var subCategoryList = categoryList.Where(x => x.ParentCategoryId == category.Id).ToList();
                var subcatIds = subCategoryList.Select(x => x.Id).ToList();
                var products = (from i in db.Product_Category_Mapping
                                join t2 in db.Products on i.ProductId equals t2.Id
                                where subcatIds.Contains(i.CategoryId)
                                select t2).ToList();

                var isCheck = db.SZ_Quotation.Where(x => x.ClientRef.ToLower().Trim() == category.Name.ToLower().Trim()).Any();
                if (!isCheck)
                {
                    if (products != null && products.Count > 0)
                    {
                        //Domestic Quote
                        GenerateQuotation(domesticCompany, category, products);

                        GenerateQuotation(internationalCompany, category, products);
                    }
                }
            }
            return Content("");
        }

        public ActionResult RevalidateDay(int quoteId, int days)
        {
            var data = _operationRepository.GetQuoteByID(quoteId);
            if (data != null)
            {
                data.QuoteValidDay = days;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }

            return Json("success", JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public ActionResult UpdatePRRequest(SZ_PRRequest model)
        {
            var obj = db.SZ_PRRequest.Where(x => x.Id == model.Id).FirstOrDefault();
            if (obj != null)
            {
                obj.Status = model.Status;
                obj.ReceivedQuotation = model.ReceivedQuotation;
                db.Entry(obj).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json(new { success = true }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public ActionResult SavePRRequest(SZ_PRRequest model)
        {
            MemoryCacheManager objCache = new MemoryCacheManager();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });
            if (model.Id == 0)
            {
                int refNo = 1;
                string value = string.Empty;
                string matchingstring = "SZ-PR-" + DateTime.Now.ToString("ddMMyy") + "-";
                var SZ_Quotationdata = (from i in db.SZ_PRRequest
                                        where i.Ref.StartsWith(matchingstring)
                                        select i).ToList();
                if (SZ_Quotationdata.Count > 0)
                {
                    refNo = SZ_Quotationdata.Select(x => ExtractPRRequestNumber(x.Ref)).Max(w => w);
                    int newbrokerrewf = Convert.ToInt32(refNo) + 1;

                    value = "SZ-PR-" + DateTime.Now.ToString("ddMMyy") + "-" + newbrokerrewf.ToString().PadLeft(2, '0');
                }
                else
                {
                    value = "SZ-PR-" + DateTime.Now.ToString("ddMMyy") + "-01";
                }

                SZ_PRRequest obj = new SZ_PRRequest();
                obj.Ref = value;
                obj.RaisedBy = model.RaisedBy;
                obj.RaisedByUserId = model.RaisedByUserId;
                obj.CreatedBy = SessionCookieManagement.UserName;
                obj.CreatedDate = DateTime.Now;
                obj.Labno = model.Labno;
                obj.SubscientistId = model.SubscientistId;
                if (obj.SubscientistId > 0)
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == obj.SubscientistId).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    obj.SubscientistName = customerName;
                }
                obj.EmployeeCode = model.EmployeeCode;
                obj.ProductId = model.ProductId;
                obj.APIName = model.APIName;
                obj.APIID = model.APIID;
                obj.CATNo = model.CATNo;
                obj.CASNo = model.CASNo;
                obj.ProductName = model.ProductName;
                obj.Density = model.Density;
                obj.MolFormula = model.MolFormula;
                obj.MolWeight = model.MolWeight;
                obj.TotalQty = model.TotalQty;
                obj.PackSize = model.PackSize;
                obj.NoofPack = model.NoofPack;
                obj.UoM = model.UoM;
                obj.Make = model.Make;
                obj.SupplierRef = model.SupplierRef;
                obj.Status = (int)EnumList.PRRequestStatus.PRCreated;
                obj.IsRequestClosed = false;
                db.SZ_PRRequest.Add(obj);
                db.SaveChanges();
            }
            else
            {
                // Update entry
                var obj = db.SZ_PRRequest.Where(x => x.Id == model.Id).FirstOrDefault();
                if (obj != null)
                {
                    obj.RaisedBy = model.RaisedBy;
                    obj.RaisedByUserId = model.RaisedByUserId;
                    obj.Labno = model.Labno;
                    obj.SubscientistId = model.SubscientistId;
                    if (obj.SubscientistId > 0)
                    {
                        string customerName = string.Empty;
                        var genericAttr = genericData.Where(x => x.EntityId == obj.SubscientistId).ToList();
                        if (genericAttr.Count > 0)
                        {
                            customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                        }
                        obj.SubscientistName = customerName;
                    }
                    obj.EmployeeCode = model.EmployeeCode;
                    obj.ProductId = model.ProductId;
                    obj.APIName = model.APIName;
                    obj.APIID = model.APIID;
                    obj.CATNo = model.CATNo;
                    obj.CASNo = model.CASNo;
                    obj.ProductName = model.ProductName;
                    obj.Density = model.Density;
                    obj.MolFormula = model.MolFormula;
                    obj.MolWeight = model.MolWeight;
                    obj.TotalQty = model.TotalQty;
                    obj.PackSize = model.PackSize;
                    obj.NoofPack = model.NoofPack;
                    obj.UoM = model.UoM;
                    obj.Make = model.Make;
                    obj.SupplierRef = model.SupplierRef;
                    db.Entry(obj).State = EntityState.Modified;
                    db.SaveChanges();
                }
            }

            return Json(new { success = true }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult SaveConversionData(int id, string conversionnumber)
        {
            var SZ_Quotationdata = (from i in db.SZ_Quotation
                                    where i.Id == id
                                    select i).FirstOrDefault();

            if (SZ_Quotationdata != null)
            {
                SZ_Quotationdata.ConversionNumber = conversionnumber;
                db.Entry(SZ_Quotationdata).State = EntityState.Modified;
                db.SaveChanges();
            }

            return Json(new { success = true }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public JsonResult AddNewRawInQuote(FormCollection form)
        {
            try
            {
                var QuoteId = Convert.ToInt32(form.Get("QuoteId"));
                var CATNo = form.Get("CATNo");
                var DisplayOrder = Convert.ToInt32(form.Get("DisplayOrder"));
                var newdisplayorder = DisplayOrder + 1;

                var product = db.Products.Where(x => x.Sku == CATNo && x.Published == true && x.Deleted == false).FirstOrDefault();
                if (product == null)
                {
                    return Json(new
                    {
                        success = false,
                        message = "Product Not Available"
                    }, JsonRequestBehavior.AllowGet);
                }

                var szquotedetailsdata = db.SZ_QuotationDetail.Where(x => x.QuoteId == QuoteId && x.DisplayOrder >= newdisplayorder).OrderBy(x => x.DisplayOrder).ToList();
                if (szquotedetailsdata != null && szquotedetailsdata.Count > 0)
                {
                    foreach (var item in szquotedetailsdata)
                    {
                        item.DisplayOrder += 1;
                        db.Entry(item).State = EntityState.Modified;
                    }
                }

                SZ_QuotationDetail objdetails = new SZ_QuotationDetail();
                objdetails.IsUploadServer = true;
                objdetails.CASNo = product.ManufacturerPartNumber;
                objdetails.CATNo = product.Sku;
                objdetails.CreatedDate = DateTime.Now;
                objdetails.ImagePath = product.ImagePath;
                objdetails.LeadTime = "";
                objdetails.EstimateDispatchDate = null;
                objdetails.Price = "";
                objdetails.FinalPrice = "";
                objdetails.ProductId = product.Id;
                objdetails.ProductName = product.Name;
                objdetails.QuoteId = QuoteId;
                objdetails.DisplayOrder = newdisplayorder;
                objdetails.ProductRemark = "";
                objdetails.ProcessState = (int)EnumList.ProcessState.InProgress;
                objdetails.ProjectStatus = (int)EnumList.ProjectStatus.NoAction;
                objdetails.IsSynthesisLog = false;
                if (product.IsControlledSubstance.HasValue && product.IsControlledSubstance.Value)
                {
                    var currantQuote = db.SZ_Quotation.Where(x => x.Id == QuoteId).FirstOrDefault();
                    if (currantQuote != null)
                    {
                        if (currantQuote.CountryType == "Export")
                        {
                            objdetails.IsControlledSubstanceCharge = true;
                        }
                    }
                }
                db.SZ_QuotationDetail.Add(objdetails);
                db.SaveChanges();

                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = ""
                }, JsonRequestBehavior.AllowGet);
            }
        }


        [HttpPost]
        public ActionResult SaveQuote(SZ_QuotationModel model)
        {
            int QuoteId = 0;
            var productData = db.SZ_TempQuotationDetail.Where(x => x.UniqueId == model.UniqueId).ToList();
            if (model.IsClubQuotation)
            {
                productData = db.SZ_TempQuotationDetail.Where(x => x.ClubQuoteId != null).ToList();
            }
            if (model.QuoteId == 0)
            {
                int refNo = 1;
                string value = string.Empty;
                string matchingstring = "SZ-" + DateTime.Now.ToString("ddMMyy") + "-";
                var SZ_Quotationdata = (from i in db.SZ_Quotation
                                        where i.Ref.StartsWith(matchingstring)
                                        select i).ToList();
                if (SZ_Quotationdata.Count > 0)
                {
                    refNo = SZ_Quotationdata.Select(x => ExtractQuoreRefNumber(x.Ref)).Max(w => w);
                    int newbrokerrewf = Convert.ToInt32(refNo) + 1;

                    value = "SZ-" + DateTime.Now.ToString("ddMMyy") + "-" + newbrokerrewf.ToString().PadLeft(2, '0');
                }
                else
                {
                    value = "SZ-" + DateTime.Now.ToString("ddMMyy") + "-01";
                }

                SZ_Quotation objquote = new SZ_Quotation();
                objquote.QuoteValidDay = 15;
                objquote.Ref = value;
                objquote.CompanyId = model.CompanyId;
                objquote.CompanyName = db.SZ_CompanyList.Where(x => x.Id == model.CompanyId).Select(x => x.Name).FirstOrDefault();
                objquote.EmailAddress = model.Email;
                objquote.ClientRef = model.ClientRef;
                objquote.IsImageAttach = model.IsImageAttach;
                objquote.PONo = !string.IsNullOrEmpty(model.PONumber) ? model.PONumber : string.Empty;
                objquote.Remark = model.Remark;
                objquote.TermsId = model.TermsId;
                objquote.CountryType = model.CountryType;
                if (objquote.CountryType == "Export")
                {
                    objquote.CountryTypeId = 2;
                }
                else
                {
                    objquote.CountryTypeId = 1;
                }
                objquote.UserDistType = model.UserDistType;
                objquote.IsToBe = model.IsToBe;
                objquote.IsQuoteApproved = model.IsQuoteApproved;
                objquote.IsCOA = model.IsCOA;
                objquote.Auction = model.Auction;
                objquote.PODate = model.PODate.HasValue ? model.PODate.Value : DateTime.Now;
                objquote.SuggChemName = model.SuggChemName;
                objquote.Attachment = model.Attachment;
                objquote.CreatedDate = DateTime.Now;
                objquote.EmailCC = model.EmailCC;
                objquote.IsFollowupRequired = model.IsFollowupRequired;
                objquote.IsShowDashboard = model.IsShowDashboard;
                objquote.IsStudy = model.IsStudy;
                if (model.IsQuoteApproved)
                {
                    objquote.ApprovedBy = SessionCookieManagement.UserName;
                    objquote.IsShowDashboard = false;
                    objquote.IsStudy = false;
                }
                objquote.CreatedBy = SessionCookieManagement.UserName;
                objquote.LayoutType = model.LayoutType;
                objquote.IsInstock = model.IsInstock;
                objquote.IsCustomSynthesis = model.IsCustomSynthesis;
                objquote.IsPreviewed = model.IsPreviewed;
                objquote.IsReviewed = model.IsReviewed;
                objquote.QuoteComment = model.QuoteComment;
                objquote.ExternalComment = model.ExternalComment;
                objquote.PaymentTerm = model.PaymentTerm;
                objquote.IsShippedCharge = model.IsShippedCharge;
                objquote.PurchaseName = model.PurchaseName;
                objquote.PurchaseContactNo = model.PurchaseContactNo;
                objquote.PurchaseEmail = model.PurchaseEmail;
                objquote.PurchaseAddress = model.PurchaseAddress;
                objquote.PurchaseCity = model.PurchaseCity;
                objquote.PurchaseCountry = model.PurchaseCountry;
                objquote.TechnicalName = model.TechnicalName;
                objquote.TechnicalContactNo = model.TechnicalContactNo;
                objquote.TechnicalEmail = model.TechnicalEmail;
                objquote.TechnicalAddress = model.TechnicalAddress;
                objquote.TechnicalCity = model.TechnicalCity;
                objquote.TechnicalCountry = model.TechnicalCountry;
                objquote.Currency = model.Currency;
                objquote.IsAnalyticalData = model.IsAnalyticalData;
                objquote.IsPreApproved = model.IsPreApproved;
                objquote.IsRevision = model.IsRevision;
                objquote.IsRegret = model.IsRegret;
                objquote.QuotePDF = model.QuotePDF;
                objquote.EmailReceivedDate = model.EmailReceivedDate;
                objquote.IsCompleted = false;
                objquote.IsRFQManually = model.IsRFQManually;
                objquote.IsCustomPDFLayout = model.IsCustomPDFLayout;
                if (model.AssignTo.HasValue)
                {
                    objquote.AssignTo = model.AssignTo;
                }
                else
                {
                    objquote.AssignTo = SessionCookieManagement.UserId;
                }
                objquote.IsUnderCorrection = model.IsUnderCorrection;
                objquote.HelpScoatNumber = model.HelpScoatNumber;
                objquote.DocumentTypeId = model.DocumentTypeId;
                objquote.Url = model.Url;
                objquote.ConversionNumber = model.ConversionNumber;
                objquote.IncoTerm = model.IncoTerm;
                objquote.POUrl = model.POUrl;
                objquote.ShippingCharges = model.ShippingCharges;
                objquote.FollowupAdminRemark = model.FollowupAdminRemark;
                objquote.ReminderCount = model.ReminderCount;
                db.SZ_Quotation.Add(objquote);
                db.SaveChanges();

                QuoteId = objquote.Id;

                int displayOrder = 0;
                foreach (var i in productData)
                {
                    SZ_QuotationDetail objdetails = new SZ_QuotationDetail();
                    objdetails.IsUploadServer = i.IsUploadServer;
                    objdetails.CASNo = i.CASNo;
                    objdetails.CATNo = i.CATNo;
                    objdetails.CreatedDate = DateTime.Now;
                    objdetails.ImagePath = i.ImagePath;
                    objdetails.LeadTime = i.LeadTime;
                    objdetails.EstimateDispatchDate = i.EstimateDispatchDate;
                    objdetails.Price = i.Price;
                    objdetails.FinalPrice = i.FinalPrice;
                    objdetails.ProductId = i.ProductId;
                    objdetails.ProductName = i.ProductName;
                    objdetails.QuoteId = objquote.Id;
                    objdetails.DisplayOrder = displayOrder;
                    objdetails.ProductRemark = i.ProductRemark;
                    objdetails.ProcessState = (int)EnumList.ProcessState.InProgress;
                    objdetails.ProjectStatus = (int)EnumList.ProjectStatus.NoAction;
                    objdetails.IsSynthesisLog = i.IsSynthesisLog;
                    db.SZ_QuotationDetail.Add(objdetails);
                    displayOrder += 1;
                }

                if (!string.IsNullOrEmpty(model.PaymentTerm))
                {
                    if (objquote.SZ_CompanyList != null && string.IsNullOrEmpty(objquote.SZ_CompanyList.PaymentTerms))
                    {
                        objquote.SZ_CompanyList.PaymentTerms = model.PaymentTerm;
                    }
                }
                db.SaveChanges();
            }
            else
            {
                var quoteData = _operationRepository.GetQuoteByID(model.QuoteId.Value);
                if (quoteData != null)
                {
                    var oldModel = LogManagement.PrepareQuoteEntity(quoteData);

                    quoteData.PaymentTerm = model.PaymentTerm;
                    quoteData.ClientRef = model.ClientRef;
                    quoteData.CountryType = model.CountryType;
                    if (quoteData.CountryType == "Export")
                    {
                        quoteData.CountryTypeId = 2;
                    }
                    else
                    {
                        quoteData.CountryTypeId = 1;
                    }
                    quoteData.UserDistType = model.UserDistType;
                    quoteData.CompanyId = model.CompanyId;
                    quoteData.CompanyName = db.SZ_CompanyList.Where(x => x.Id == model.CompanyId).Select(x => x.Name).FirstOrDefault();
                    quoteData.EmailAddress = model.Email;
                    quoteData.IsImageAttach = model.IsImageAttach;
                    //TODO: Stoped PO Update Date
                    //if (!string.IsNullOrEmpty(model.PONumber) && string.IsNullOrEmpty(quoteData.PONo))
                    //{
                    //    quoteData.PODate = DateTime.Now;
                    //}
                    quoteData.PONo = !string.IsNullOrEmpty(model.PONumber) ? model.PONumber : string.Empty;
                    quoteData.Remark = model.Remark;
                    quoteData.TermsId = model.TermsId;
                    quoteData.IsToBe = model.IsToBe;
                    quoteData.IsShowDashboard = model.IsShowDashboard;
                    quoteData.IsStudy = model.IsStudy;
                    quoteData.IsPreApproved = model.IsPreApproved;
                    quoteData.IsRevision = model.IsRevision;
                    if (model.IsQuoteApproved && (quoteData.IsQuoteApproved == false || quoteData.IsQuoteApproved == null))
                    {
                        quoteData.IsShowDashboard = false;
                        quoteData.IsPreApproved = false;
                        quoteData.IsRevision = false;
                        if (string.IsNullOrEmpty(quoteData.ApprovedBy))
                        {
                            quoteData.ApprovedBy = SessionCookieManagement.UserName;
                        }
                        else
                        {
                            if (quoteData.ApprovedBy != SessionCookieManagement.UserName)
                            {
                                quoteData.ApprovedBy += ", " + SessionCookieManagement.UserName;
                            }
                        }
                    }
                    quoteData.IsQuoteApproved = model.IsQuoteApproved;
                    quoteData.IsCOA = model.IsCOA;
                    quoteData.Auction = model.Auction;
                    //quoteData.PODate = model.PODate.HasValue ? model.PODate.Value : DateTime.Now;
                    quoteData.SuggChemName = model.SuggChemName;
                    quoteData.Attachment = model.Attachment;
                    quoteData.EmailCC = model.EmailCC;
                    quoteData.IsFollowupRequired = model.IsFollowupRequired;
                    quoteData.IsInstock = model.IsInstock;
                    quoteData.IsCustomSynthesis = model.IsCustomSynthesis;
                    quoteData.IsPreviewed = model.IsPreviewed;
                    quoteData.IsReviewed = model.IsReviewed;
                    quoteData.QuoteComment = model.QuoteComment;
                    quoteData.ExternalComment = model.ExternalComment;
                    quoteData.WorkingDate = DateTime.Now;
                    quoteData.IsWorking = false;
                    quoteData.WorkingUserName = SessionCookieManagement.UserName;
                    quoteData.IsShippedCharge = model.IsShippedCharge;
                    quoteData.PurchaseName = model.PurchaseName;
                    quoteData.PurchaseContactNo = model.PurchaseContactNo;
                    quoteData.PurchaseEmail = model.PurchaseEmail;
                    quoteData.PurchaseAddress = model.PurchaseAddress;
                    quoteData.PurchaseCity = model.PurchaseCity;
                    quoteData.PurchaseCountry = model.PurchaseCountry;
                    quoteData.TechnicalName = model.TechnicalName;
                    quoteData.TechnicalContactNo = model.TechnicalContactNo;
                    quoteData.TechnicalEmail = model.TechnicalEmail;
                    quoteData.TechnicalAddress = model.TechnicalAddress;
                    quoteData.TechnicalCity = model.TechnicalCity;
                    quoteData.TechnicalCountry = model.TechnicalCountry;
                    quoteData.Currency = model.Currency;
                    quoteData.IsAnalyticalData = model.IsAnalyticalData;
                    quoteData.IsRegret = model.IsRegret;
                    if (!string.IsNullOrEmpty(model.QuotePDF))
                    {
                        quoteData.QuotePDF = model.QuotePDF;
                    }
                    quoteData.EmailReceivedDate = model.EmailReceivedDate;
                    if (string.IsNullOrEmpty(quoteData.CreatedBy))
                    {
                        quoteData.CreatedBy = SessionCookieManagement.UserName;
                        quoteData.CreatedDate = DateTime.Now;
                    }
                    quoteData.IsRFQManually = model.IsRFQManually;
                    quoteData.AssignTo = model.AssignTo;
                    quoteData.IsUnderCorrection = model.IsUnderCorrection;
                    quoteData.HelpScoatNumber = model.HelpScoatNumber;
                    quoteData.DocumentTypeId = model.DocumentTypeId;
                    quoteData.IsCustomPDFLayout = model.IsCustomPDFLayout;
                    quoteData.Url = model.Url;
                    quoteData.ConversionNumber = model.ConversionNumber;
                    quoteData.IncoTerm = model.IncoTerm;
                    quoteData.POUrl = model.POUrl;
                    quoteData.ShippingCharges = model.ShippingCharges;
                    quoteData.FollowupAdminRemark = model.FollowupAdminRemark;
                    quoteData.ReminderCount = model.ReminderCount;
                    db.Entry(quoteData).State = EntityState.Modified;
                    db.SaveChanges();
                    QuoteId = quoteData.Id;

                    int? maxDisplayOrderNo = db.SZ_QuotationDetail.Where(x => x.QuoteId == quoteData.Id).Max(x => x.DisplayOrder);
                    if (maxDisplayOrderNo.HasValue)
                    {
                        maxDisplayOrderNo += 1;
                    }

                    foreach (var i in productData)
                    {
                        SZ_QuotationDetail objdetails = new SZ_QuotationDetail();
                        objdetails.IsUploadServer = i.IsUploadServer;
                        objdetails.CASNo = i.CASNo;
                        objdetails.CATNo = i.CATNo;
                        objdetails.CreatedDate = DateTime.Now;
                        objdetails.ImagePath = i.ImagePath;
                        objdetails.LeadTime = i.LeadTime;
                        objdetails.Price = i.Price;
                        objdetails.FinalPrice = i.FinalPrice;
                        objdetails.ProductId = i.ProductId;
                        objdetails.ProductName = i.ProductName;
                        objdetails.QuoteId = quoteData.Id;
                        objdetails.DisplayOrder = maxDisplayOrderNo;
                        objdetails.ProductRemark = i.ProductRemark;
                        objdetails.EstimateDispatchDate = i.EstimateDispatchDate;
                        objdetails.IsSynthesisLog = i.IsSynthesisLog;
                        db.SZ_QuotationDetail.Add(objdetails);
                        maxDisplayOrderNo += 1;
                    }
                    if (!string.IsNullOrEmpty(model.PaymentTerm))
                    {
                        if (quoteData.SZ_CompanyList != null && string.IsNullOrEmpty(quoteData.SZ_CompanyList.PaymentTerms))
                        {
                            quoteData.SZ_CompanyList.PaymentTerms = model.PaymentTerm;
                        }
                    }
                    db.SaveChanges();
                    //LogManagement.AddQuoteLog(quoteData, oldModel);
                }
            }

            if (model.IsClubQuotation)
            {
                var clubdata = db.SZ_ClubQuote.ToList();
                if (clubdata != null && clubdata.Count > 0)
                {
                    clubdata.ForEach(x =>
                    {
                        db.Entry(x).State = EntityState.Deleted;
                    });
                }

                var clubmodels = db.SZ_TempQuotationDetail.Where(x => x.ClubQuoteId != null).ToList();
                if (clubmodels != null && clubmodels.Count > 0)
                {
                    clubmodels.ForEach(x =>
                    {
                        db.Entry(x).State = EntityState.Deleted;
                    });
                }
                db.SaveChanges();
            }

            if (model.SendMail)
            {
                try
                {
                    var data = _operationRepository.GetQuoteByID(QuoteId);
                    var htmlstring = PartialViewdata(this, "_PartialQuotationPDF", data);
                    htmlstring = "<html><head></head><body style='font-family:Tahoma, Verdana, Segoe, sans-serif;font-size:11px;'>" + htmlstring + "</body></html>";
                    string path = printpdf(htmlstring, data.Ref);
                    MailMessage mail = new MailMessage();
                    ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12 |
                                       SecurityProtocolType.Tls11 |
                                       SecurityProtocolType.Tls |
                                       SecurityProtocolType.Ssl3;
                    SmtpClient SmtpServer = new SmtpClient(ConfigurationManager.AppSettings["Email.Host"]);
                    mail.Attachments.Add(new Attachment(path));
                    mail.From = new MailAddress(ConfigurationManager.AppSettings["Email.Username"], "SynZeal Standards");
                    var isDevelopment = ConfigurationManager.AppSettings["IsDevelopment"];
                    if (isDevelopment.ToLower().Contains("true"))
                    {
                        mail.To.Add(ConfigurationManager.AppSettings["DevEmailAddress"].ToString());
                    }
                    else
                    {
                        mail.To.Add(data.EmailAddress);
                        if (!string.IsNullOrEmpty(data.EmailCC))
                        {
                            var cc = data.EmailCC.Split(';');
                            foreach (var c in cc)
                            {
                                if (!string.IsNullOrEmpty(c))
                                {
                                    mail.CC.Add(c);
                                }
                            }
                        }
                        mail.CC.Add("bd@synzeal.com");
                        mail.CC.Add("standards@synzeal.com");
                        mail.Bcc.Add("noreply.synzeal@gmail.com");
                        mail.ReplyToList.Add("standards@synzeal.com");
                    }
                    //mail.To. = adminemail;
                    if (!string.IsNullOrEmpty(data.ClientRef))
                    {
                        mail.Subject = "SynZeal Research Quotation : " + data.ClientRef + " / SZ Quote ID : " + data.Ref;
                    }
                    else
                    {
                        mail.Subject = "SynZeal Research Quotation : SZ Quote ID : " + data.Ref;
                    }

                    string html = System.IO.File.ReadAllText(Server.MapPath("~/Mail/Quotation.html"));
                    mail.Body = html;
                    mail.IsBodyHtml = true;
                    SmtpServer.Port = Convert.ToInt32(ConfigurationManager.AppSettings["Port"]);
                    SmtpServer.Credentials = new System.Net.NetworkCredential(ConfigurationManager.AppSettings["Email.Username"], ConfigurationManager.AppSettings["Email.Password"]);
                    SmtpServer.EnableSsl = true;
                    SmtpServer.Send(mail);
                }
                catch (Exception ex)
                {
                    sendErrorMail(ex.LineNumber() + " " + "Error Text : " + ex.Message + " / Stack Trace : " + ex.StackTrace);
                }

            }

            List<int> ids = new List<int>();
            List<int> proids = new List<int>();
            if (model.IsCOA.HasValue && model.IsCOA.Value)
            {
                var allproducts = db.SZ_QuotationDetail.Where(x => x.QuoteId == QuoteId).ToList();

                if (allproducts.Count > 0)
                {
                    foreach (var item in allproducts)
                    {
                        var mastercoa = db.SZ_MasterCOA.Where(x => x.ProductId == item.ProductId).OrderByDescending(x => x.Id).FirstOrDefault();
                        if (mastercoa != null)
                        {
                            proids.Add(item.Id);
                            ids.Add(mastercoa.Id);
                        }
                    }
                }

                if (productData != null && productData.Count > 0)
                {
                    foreach (var i in productData)
                    {
                        var mastercoa = db.SZ_MasterCOA.Where(x => x.ProductId == i.ProductId).OrderByDescending(x => x.Id).FirstOrDefault();
                        if (mastercoa != null)
                        {
                            proids.Add(i.Id);
                            ids.Add(mastercoa.Id);
                        }
                    }
                }
            }

            return Json(new
            {
                success = true,
                quoteId = QuoteId,
                isMasterCOAIds = ids,
                proids = proids,
                QuotePDF = model.QuotePDF
            }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public ActionResult SaveClubQuote(SZ_QuotationModel model)
        {
            var productData = (from i in db.SZ_ClubQuote
                               join t2 in db.SZ_QuotationDetail on i.QuotationDetailsId equals t2.Id
                               select t2).ToList();

            if (productData.Count == 0)
            {
                return Json(new
                {
                    success = false,
                    message = "Please add atleast one product."
                }, JsonRequestBehavior.AllowGet);
            }

            int refNo = 1;
            string value = string.Empty;
            string matchingstring = "SZ-" + DateTime.Now.ToString("ddMMyy") + "-";
            var SZ_Quotationdata = (from i in db.SZ_Quotation
                                    where i.Ref.StartsWith(matchingstring)
                                    select i).ToList();
            if (SZ_Quotationdata.Count > 0)
            {
                refNo = SZ_Quotationdata.Select(x => ExtractQuoreRefNumber(x.Ref)).Max(w => w);
                int newbrokerrewf = Convert.ToInt32(refNo) + 1;

                value = "SZ-" + DateTime.Now.ToString("ddMMyy") + "-" + newbrokerrewf.ToString().PadLeft(2, '0');
            }
            else
            {
                value = "SZ-" + DateTime.Now.ToString("ddMMyy") + "-01";
            }

            var company = db.SZ_CompanyList.Where(x => x.Id == model.CompanyId).FirstOrDefault();

            SZ_Quotation objquote = new SZ_Quotation();
            objquote.Ref = value;
            objquote.CompanyId = model.CompanyId;
            if (company != null)
            {
                objquote.CompanyName = company.Name;

                if (company.CountryType == "Export")
                {
                    objquote.IsAnalyticalData = true;
                    objquote.Currency = "USD";
                    objquote.CountryType = "Export";
                    objquote.CountryTypeId = 2;
                }
                else
                {
                    objquote.Currency = "INR";
                    objquote.CountryType = "Domestic";
                    objquote.CountryTypeId = 1;
                }
            }
            objquote.EmailAddress = model.Email;
            objquote.IsImageAttach = model.IsImageAttach;
            objquote.PONo = !string.IsNullOrEmpty(model.PONumber) ? model.PONumber : string.Empty;
            objquote.Remark = model.Remark;
            objquote.TermsId = model.TermsId;
            objquote.CreatedDate = DateTime.Now;
            //TODO: Stoped PO Update Date
            //if (!string.IsNullOrEmpty(model.PONumber))
            //{
            //    objquote.PODate = DateTime.Now;
            //}
            objquote.CreatedBy = SessionCookieManagement.UserName;

            db.SZ_Quotation.Add(objquote);
            db.SaveChanges();

            int displayOrder = 0;
            foreach (var i in productData)
            {
                SZ_QuotationDetail objdetails = new SZ_QuotationDetail();
                objdetails.IsUploadServer = i.IsUploadServer;
                objdetails.CASNo = i.CASNo;
                objdetails.CATNo = i.CATNo;
                objdetails.CreatedDate = DateTime.Now;
                objdetails.ImagePath = i.ImagePath;
                objdetails.LeadTime = i.LeadTime;
                objdetails.Price = i.Price;
                objdetails.ProductId = i.ProductId;
                objdetails.ProductName = i.ProductName;
                objdetails.QuoteId = objquote.Id;
                objdetails.DisplayOrder = displayOrder;
                objdetails.ProcessState = (int)EnumList.ProcessState.InProgress;
                objdetails.ProjectStatus = (int)EnumList.ProjectStatus.NoAction;
                objdetails.IsSynthesisLog = i.IsSynthesisLog;
                db.SZ_QuotationDetail.Add(objdetails);
                db.SaveChanges();
                displayOrder += 1;
            }

            var clubData = db.SZ_ClubQuote.ToList();
            foreach (var k in clubData)
            {
                db.Entry(k).State = EntityState.Deleted;
                db.SaveChanges();
            }

            return Json(new
            {
                success = true
            }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult MoveQuoteTOApproved(List<int> id)
        {
            try
            {
                List<QuotationListModel> model = new List<QuotationListModel>();
                foreach (var ids in id)
                {
                    var details = _operationRepository.GetQuoteDetailByID(ids);
                    if (details != null)
                    {
                        var quote = _operationRepository.GetQuoteByID(details.QuoteId);
                        if (quote != null)
                        {
                            quote.IsQuoteApproved = true;
                            db.Entry(quote).State = EntityState.Modified;
                            db.SaveChanges();
                        }
                    }
                }

                return Json(new
                {
                    success = true,
                    message = "Quotation moved in approved tab."
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {

                return Json(new
                {
                    success = false,
                    message = ex.Message + " / " + ex.StackTrace
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult ParkAllQuote(List<int> id, string parkreason)
        {
            try
            {
                List<QuotationListModel> model = new List<QuotationListModel>();
                foreach (var ids in id)
                {
                    var details = _operationRepository.GetQuoteByID(ids);
                    if (details != null)
                    {
                        details.ParkReason = parkreason;
                        details.IsPark = true;
                        details.IsToBe = false;
                        details.IsInstock = false;
                        details.IsCustomSynthesis = false;
                        details.IsRevision = false;
                        details.IsPreApproved = false;
                        db.Entry(details).State = EntityState.Modified;
                        db.SaveChanges();
                    }
                }

                return Json(new
                {
                    success = true,
                    message = "Quotation parked successfully."
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {

                return Json(new
                {
                    success = false,
                    message = ex.Message + " / " + ex.StackTrace
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult MoveQuoteTOAllFromApproved(List<int> id)
        {
            try
            {
                List<QuotationListModel> model = new List<QuotationListModel>();
                foreach (var ids in id)
                {
                    var details = _operationRepository.GetQuoteDetailByID(ids);
                    if (details != null)
                    {
                        var quote = _operationRepository.GetQuoteByID(details.QuoteId);
                        if (quote != null)
                        {
                            quote.IsQuoteApproved = false;
                            quote.IsToBe = false;
                            db.Entry(quote).State = EntityState.Modified;
                            db.SaveChanges();
                        }
                    }
                }

                return Json(new
                {
                    success = true,
                    message = "Quotation moved in approved tab."
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {

                return Json(new
                {
                    success = false,
                    message = ex.Message + " / " + ex.StackTrace
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult PrintQuotationListAllRecordWithDiscount(List<int> id)
        {
            try
            {
                int quoteId = 0;

                List<QuotationListModel> model = new List<QuotationListModel>();
                foreach (var ids in id)
                {
                    var details = _operationRepository.GetQuoteDetailByID(ids);
                    if (details != null)
                    {
                        int discount = 0;
                        if (details.Discount.HasValue)
                        {
                            discount = details.Discount.Value;
                        }
                        QuotationListModel objmodel = new QuotationListModel();
                        objmodel.QuoteId = details.QuoteId;
                        quoteId = details.QuoteId;
                        objmodel.CreatedDate = details.CreatedDate;
                        objmodel.PONumber = details.SZ_Quotation.PONo;
                        objmodel.PODate = details.SZ_Quotation.PODate;
                        if (details.PackDate.HasValue)
                        {
                            objmodel.PackDate = details.PackDate.Value.ToShortDateString();
                        }
                        objmodel.Price = details.Price;
                        objmodel.CASNo = details.CASNo;
                        objmodel.CATNo = details.CATNo;
                        objmodel.LeadTime = details.LeadTime;
                        objmodel.SrPo = details.SrPo;
                        objmodel.ProductName = details.ProductName;
                        objmodel.RequiredQty = details.RequiredQty;
                        //objmodel.BatchNo = details.BatchNo;
                        objmodel.CompanyName = details.SZ_Quotation.CompanyName;
                        objmodel.Ref = details.SZ_Quotation.Ref;

                        objmodel.PurposeDispatch = details.PurposeDispatch;
                        if (/*string.IsNullOrEmpty(details.BatchNo) && */details.AdditionalBatchNo.HasValue)
                        {
                            objmodel.BatchNo = db.SZ_Inventory.Where(x => x.Id == details.AdditionalBatchNo.Value).Select(x => x.BatchNo).FirstOrDefault();
                        }

                        if (objmodel.BatchNo == "undefined")
                        {
                            objmodel.BatchNo = "";
                        }

                        var pricestr = new List<string>();
                        if (!string.IsNullOrEmpty(objmodel.Price) && discount != 0)
                        {
                            var pri = objmodel.Price.Split(',');
                            if (pri != null && pri.Count() > 0)
                            {
                                foreach (var item in pri)
                                {
                                    var atpri = item.Split('@')[1];
                                    var mainpri = atpri.Trim().Split(' ')[0].Trim();
                                    var finalpri = Convert.ToInt32(mainpri) - ((Convert.ToInt32(mainpri) / 100) * discount);
                                    var currency = details.SZ_Quotation.CountryType == "Domestic" ? "INR" : "USD";
                                    if (!string.IsNullOrEmpty(details.SZ_Quotation.Currency))
                                    {
                                        currency = details.SZ_Quotation.Currency;
                                    }
                                    pricestr.Add(item.Split('@')[0] + "@" + finalpri + " " + currency);
                                }
                            }
                        }
                        if (pricestr != null && pricestr.Count > 0)
                        {
                            objmodel.Price = string.Join(", ", pricestr);
                        }

                        model.Add(objmodel);
                    }
                }


                string htmlstring = PartialViewdata(this, "_PrintQuotationListAllRecord", model);

                return Json(new
                {
                    success = true,
                    html = htmlstring
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {

                return Json(new
                {
                    success = false,
                    message = ex.Message + " / " + ex.StackTrace
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult Quicksearch()
        {
            try
            {
                string htmlstring = PartialViewdata(this, "_PartialQuickSearch", null);
                return Json(new
                {
                    success = true,
                    html = htmlstring
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {

                return Json(new
                {
                    success = false,
                    message = ex.Message + " / " + ex.StackTrace
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult PrintQuotationListAllRecord(List<int> id, string pagename = "")
        {
            try
            {
                int quoteId = 0;
                ViewBag.PageName = pagename;
                List<QuotationListModel> model = new List<QuotationListModel>();
                foreach (var ids in id)
                {
                    var details = _operationRepository.GetQuoteDetailByID(ids);
                    if (details != null)
                    {
                        QuotationListModel objmodel = new QuotationListModel();
                        if (pagename == "quotedetails")
                        {
                            var mastercoa = db.SZ_MasterCOA.Where(x => x.BatchNo == details.QuoteBatchNo).OrderByDescending(x => x.Id).FirstOrDefault();
                            if (mastercoa != null)
                            {
                                objmodel.COAId = mastercoa.Id;
                            }
                            else
                            {
                                objmodel.COAId = 0;
                            }
                            ViewBag.QuoteRef = details.SZ_Quotation.Ref;
                            ViewBag.QuoteDate = details.SZ_Quotation.CreatedDate.Value.ToShortDateString();
                            ViewBag.ValidTill = details.SZ_Quotation.CreatedDate.Value.AddDays(details.SZ_Quotation.QuoteValidDay.HasValue ? details.SZ_Quotation.QuoteValidDay.Value : 15).ToShortDateString();
                        }

                        objmodel.Discount = details.Discount;
                        objmodel.QuoteId = details.QuoteId;
                        quoteId = details.QuoteId;
                        objmodel.CreatedDate = details.CreatedDate;
                        objmodel.PONumber = details.SZ_Quotation.PONo;
                        objmodel.PODate = details.SZ_Quotation.PODate;
                        if (details.PackDate.HasValue)
                        {
                            objmodel.PackDate = details.PackDate.Value.ToShortDateString();
                        }
                        objmodel.Price = details.Price;
                        objmodel.CASNo = details.CASNo;
                        objmodel.CATNo = details.CATNo;
                        objmodel.LeadTime = details.LeadTime;
                        objmodel.SrPo = details.SrPo;
                        objmodel.ProductName = details.ProductName;
                        objmodel.RequiredQty = details.RequiredQty;
                        //objmodel.BatchNo = details.BatchNo;
                        objmodel.CompanyName = details.SZ_Quotation.CompanyName;
                        objmodel.Ref = details.SZ_Quotation.Ref;

                        objmodel.PurposeDispatch = details.PurposeDispatch;
                        if (/*string.IsNullOrEmpty(details.BatchNo) && */details.AdditionalBatchNo.HasValue)
                        {
                            objmodel.BatchNo = db.SZ_Inventory.Where(x => x.Id == details.AdditionalBatchNo.Value).Select(x => x.BatchNo).FirstOrDefault();
                        }

                        if (objmodel.BatchNo == "undefined")
                        {
                            objmodel.BatchNo = "";
                        }

                        var product = db.Products.Where(x => x.Id == details.ProductId).FirstOrDefault();
                        if (product != null)
                        {
                            objmodel.APIName = product.MainCatName;
                        }
                        objmodel.ProductRemark = details.ProductRemark;
                        model.Add(objmodel);
                    }
                }

                string htmlstring = PartialViewdata(this, "_PrintQuotationListAllRecord", model);

                return Json(new
                {
                    success = true,
                    html = htmlstring
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {

                return Json(new
                {
                    success = false,
                    message = ex.Message + " / " + ex.StackTrace
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult LoadReactionMatrixPage(List<int> id)
        {
            try
            {
                var quoteDetailsData = db.SZ_QuotationDetail.Where(x => id.Contains(x.Id)).ToList();
                var matrixData = db.SZ_ReactionMatrix.Where(x => id.Contains(x.QuoteDetailId)).ToList();
                var model = new List<ReactionMatrixModel>();

                DateTime baseDate = DateTime.Today;
                var thisWeekStart = baseDate.AddDays(-(int)baseDate.DayOfWeek);
                var thisWeekEnd = thisWeekStart.AddDays(7).AddSeconds(-1);

                DateTime prebaseDate = DateTime.Today.AddDays(-7);
                var preWeekStart = prebaseDate.AddDays(-(int)prebaseDate.DayOfWeek);
                var preWeekEnd = preWeekStart.AddDays(7).AddSeconds(-1);

                quoteDetailsData.ForEach(item =>
                {
                    var currreactionList = matrixData.Where(x => x.QuoteDetailId == item.Id
                                                            && x.SchemeFromDate.Date == thisWeekStart.Date
                                                            && x.SchemeEndDate.Date == thisWeekEnd.Date).ToList();

                    var prevreactionList = matrixData.Where(x => x.QuoteDetailId == item.Id
                                                            && x.SchemeFromDate.Date == preWeekStart.Date
                                                            && x.SchemeEndDate.Date == preWeekEnd.Date).ToList();

                    if (currreactionList != null && currreactionList.Count > 0)
                    {
                        foreach (var currreaction in currreactionList)
                        {
                            var objModel = new ReactionMatrixModel();
                            objModel.ProductId = item.ProductId;
                            objModel.QuoteDetailId = item.Id;
                            objModel.Productname = item.ProductName;
                            objModel.CASNo = item.CASNo;
                            objModel.CATNo = item.CATNo;
                            objModel.SchemeFromDate = thisWeekStart;
                            objModel.SchemeEndDate = thisWeekEnd;
                            objModel.Range = "Currant";
                            objModel.SrNo = currreaction.SrNo;
                            objModel.Scheme = currreaction.Scheme;
                            objModel.TotalStep = currreaction.TotalStep;
                            objModel.StepNo = currreaction.StepNo;
                            objModel.NoofReaction = currreaction.NoofReaction;
                            objModel.SuccessReaction = currreaction.SuccessReaction;
                            objModel.NoofPurification = currreaction.NoofPurification;
                            objModel.BatchSize = currreaction.BatchSize;
                            objModel.ExpNo = currreaction.ExpNo;
                            model.Add(objModel);
                        }
                    }
                    else
                    {
                        var objModel = new ReactionMatrixModel();
                        objModel.ProductId = item.ProductId;
                        objModel.QuoteDetailId = item.Id;
                        objModel.Productname = item.ProductName;
                        objModel.CASNo = item.CASNo;
                        objModel.CATNo = item.CATNo;
                        objModel.SchemeFromDate = thisWeekStart;
                        objModel.SchemeEndDate = thisWeekEnd;
                        objModel.Range = "Currant";
                        objModel.SrNo = 1;
                        model.Add(objModel);
                    }
                    if (prevreactionList != null && prevreactionList.Count > 0)
                    {
                        foreach (var prevreaction in prevreactionList)
                        {
                            var objPrevModel = new ReactionMatrixModel();
                            objPrevModel.ProductId = item.ProductId;
                            objPrevModel.QuoteDetailId = item.Id;
                            objPrevModel.Productname = item.ProductName;
                            objPrevModel.CASNo = item.CASNo;
                            objPrevModel.CATNo = item.CATNo;
                            objPrevModel.SchemeFromDate = preWeekStart;
                            objPrevModel.SchemeEndDate = preWeekEnd;
                            objPrevModel.Range = "Previous";
                            objPrevModel.SrNo = prevreaction.SrNo;
                            objPrevModel.Scheme = prevreaction.Scheme;
                            objPrevModel.TotalStep = prevreaction.TotalStep;
                            objPrevModel.StepNo = prevreaction.StepNo;
                            objPrevModel.NoofReaction = prevreaction.NoofReaction;
                            objPrevModel.SuccessReaction = prevreaction.SuccessReaction;
                            objPrevModel.NoofPurification = prevreaction.NoofPurification;
                            objPrevModel.BatchSize = prevreaction.BatchSize;
                            objPrevModel.ExpNo = prevreaction.ExpNo;
                            model.Add(objPrevModel);
                        }
                    }
                    else
                    {
                        var objPrevModel = new ReactionMatrixModel();
                        objPrevModel.ProductId = item.ProductId;
                        objPrevModel.QuoteDetailId = item.Id;
                        objPrevModel.Productname = item.ProductName;
                        objPrevModel.CASNo = item.CASNo;
                        objPrevModel.CATNo = item.CATNo;
                        objPrevModel.SchemeFromDate = preWeekStart;
                        objPrevModel.SchemeEndDate = preWeekEnd;
                        objPrevModel.Range = "Previous";
                        objPrevModel.SrNo = 1;
                        model.Add(objPrevModel);
                    }
                });

                string htmlstring = PartialViewdata(this, "_PartialReactionMatrixPage", model);
                return Json(new
                {
                    success = true,
                    html = htmlstring
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = ex.Message + " / " + ex.StackTrace
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult SaveReactionMatrixData(List<ReactionMatrixModel> id)
        {
            try
            {
                int quoteId = 0;
                List<QuotationListModel> model = new List<QuotationListModel>();
                foreach (var ids in id)
                {
                    var details = _operationRepository.GetQuoteDetailByID(ids.QuoteDetailId);
                    if (details != null)
                    {
                        var reactionMatrixData = db.SZ_ReactionMatrix
                                                    .Where(x => x.QuoteDetailId == ids.QuoteDetailId
                                                        && x.SchemeFromDate == ids.SchemeFromDate
                                                        && x.SchemeEndDate == ids.SchemeEndDate
                                                        && x.SrNo == ids.SrNo).FirstOrDefault();
                        if (reactionMatrixData != null)
                        {
                            reactionMatrixData.Productname = details.ProductName;
                            reactionMatrixData.CASNo = details.CASNo;
                            reactionMatrixData.CATNo = details.CATNo;
                            reactionMatrixData.ProductId = details.ProductId.HasValue ? details.ProductId.Value : 0;
                            reactionMatrixData.QuoteDetailId = details.Id;
                            reactionMatrixData.SchemeFromDate = ids.SchemeFromDate;
                            reactionMatrixData.SchemeEndDate = ids.SchemeEndDate;
                            reactionMatrixData.Scheme = ids.Scheme;
                            reactionMatrixData.TotalStep = ids.TotalStep;
                            reactionMatrixData.StepNo = ids.StepNo;
                            reactionMatrixData.NoofReaction = ids.NoofReaction;
                            reactionMatrixData.SuccessReaction = ids.SuccessReaction;
                            reactionMatrixData.NoofPurification = ids.NoofPurification;
                            reactionMatrixData.BatchSize = ids.BatchSize;
                            reactionMatrixData.ExpNo = ids.ExpNo;
                            db.Entry(reactionMatrixData).State = EntityState.Modified;
                        }
                        else
                        {
                            reactionMatrixData = new SZ_ReactionMatrix();
                            reactionMatrixData.Productname = details.ProductName;
                            reactionMatrixData.CASNo = details.CASNo;
                            reactionMatrixData.CATNo = details.CATNo;
                            reactionMatrixData.ProductId = details.ProductId.HasValue ? details.ProductId.Value : 0;
                            reactionMatrixData.QuoteDetailId = details.Id;
                            reactionMatrixData.SchemeFromDate = ids.SchemeFromDate;
                            reactionMatrixData.SchemeEndDate = ids.SchemeEndDate;
                            reactionMatrixData.Scheme = ids.Scheme;
                            reactionMatrixData.TotalStep = ids.TotalStep;
                            reactionMatrixData.StepNo = ids.StepNo;
                            reactionMatrixData.NoofReaction = ids.NoofReaction;
                            reactionMatrixData.SuccessReaction = ids.SuccessReaction;
                            reactionMatrixData.NoofPurification = ids.NoofPurification;
                            reactionMatrixData.BatchSize = ids.BatchSize;
                            reactionMatrixData.ExpNo = ids.ExpNo;
                            reactionMatrixData.SrNo = ids.SrNo;
                            reactionMatrixData.CreatedBy = SessionCookieManagement.UserId.ToString();
                            reactionMatrixData.CreatedDate = DateTime.Now;
                            db.SZ_ReactionMatrix.Add(reactionMatrixData);
                        }
                        db.SaveChanges();
                    }
                }

                string htmlstring = PartialViewdata(this, "_PrintScientistAllRecord", model);

                return Json(new
                {
                    success = true,
                    html = htmlstring
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {

                return Json(new
                {
                    success = false,
                    message = ex.Message + " / " + ex.StackTrace
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult PrintScientistAllRecord(List<int> id)
        {
            try
            {
                int quoteId = 0;

                List<QuotationListModel> model = new List<QuotationListModel>();
                foreach (var ids in id)
                {
                    var details = _operationRepository.GetQuoteDetailByID(ids);
                    if (details != null)
                    {
                        QuotationListModel objmodel = new QuotationListModel();
                        objmodel.QuoteId = details.QuoteId;
                        quoteId = details.QuoteId;
                        objmodel.CreatedDate = details.CreatedDate;
                        objmodel.PONumber = details.SZ_Quotation.PONo;
                        objmodel.PODate = details.SZ_Quotation.PODate;
                        if (details.PackDate.HasValue)
                        {
                            objmodel.PackDate = details.PackDate.Value.ToShortDateString();
                        }
                        objmodel.Price = details.Price;
                        objmodel.CASNo = details.CASNo;
                        objmodel.CATNo = details.CATNo;
                        objmodel.LeadTime = details.LeadTime;
                        objmodel.SrPo = details.SrPo;
                        objmodel.ProductName = details.ProductName;
                        objmodel.RequiredQty = details.RequiredQty;
                        //objmodel.BatchNo = details.BatchNo;
                        objmodel.CompanyName = details.SZ_Quotation.CompanyName;
                        objmodel.Ref = details.SZ_Quotation.Ref;
                        if (details.MoveToScientistDate.HasValue)
                        {
                            objmodel.MoveToScientistDate = details.MoveToScientistDate.Value.ToShortDateString();
                        }
                        if (details.EstimateCompleteDate.HasValue)
                        {
                            objmodel.EstimateCompleteDate = details.EstimateCompleteDate.Value.ToShortDateString();
                        }

                        objmodel.DataRemark = details.Remark;
                        objmodel.PurposeDispatch = details.PurposeDispatch;
                        if (/*string.IsNullOrEmpty(details.BatchNo) && */details.AdditionalBatchNo.HasValue)
                        {
                            objmodel.BatchNo = db.SZ_Inventory.Where(x => x.Id == details.AdditionalBatchNo.Value).Select(x => x.BatchNo).FirstOrDefault();
                        }

                        if (objmodel.BatchNo == "undefined")
                        {
                            objmodel.BatchNo = "";
                        }

                        model.Add(objmodel);
                    }
                }

                string htmlstring = PartialViewdata(this, "_PrintScientistAllRecord", model);

                return Json(new
                {
                    success = true,
                    html = htmlstring
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {

                return Json(new
                {
                    success = false,
                    message = ex.Message + " / " + ex.StackTrace
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult SendFollowUpMail(List<int> id)
        {
            try
            {
                int quoteId = 0;

                List<QuotationListModel> model = new List<QuotationListModel>();
                foreach (var ids in id)
                {
                    var details = _operationRepository.GetQuoteDetailByID(ids);
                    if (details != null)
                    {
                        QuotationListModel objmodel = new QuotationListModel();
                        objmodel.QuoteId = details.QuoteId;
                        quoteId = details.QuoteId;
                        objmodel.CreatedDate = details.CreatedDate;
                        objmodel.PONumber = details.SZ_Quotation.PONo;
                        objmodel.PODate = details.SZ_Quotation.PODate;
                        if (details.PackDate.HasValue)
                        {
                            objmodel.PackDate = details.PackDate.Value.ToShortDateString();
                        }
                        objmodel.Price = details.Price;
                        objmodel.CASNo = details.CASNo;
                        objmodel.CATNo = details.CATNo;
                        objmodel.LeadTime = details.LeadTime;
                        objmodel.SrPo = details.SrPo;
                        objmodel.ProductName = details.ProductName;
                        objmodel.RequiredQty = details.RequiredQty;
                        //objmodel.BatchNo = details.BatchNo;
                        objmodel.CompanyName = details.SZ_Quotation.CompanyName;
                        objmodel.Ref = details.SZ_Quotation.Ref;

                        objmodel.PurposeDispatch = details.PurposeDispatch;
                        if (/*string.IsNullOrEmpty(details.BatchNo) && */details.AdditionalBatchNo.HasValue)
                        {
                            objmodel.BatchNo = db.SZ_Inventory.Where(x => x.Id == details.AdditionalBatchNo.Value).Select(x => x.BatchNo).FirstOrDefault();
                        }

                        if (objmodel.BatchNo == "undefined")
                        {
                            objmodel.BatchNo = "";
                        }

                        model.Add(objmodel);
                    }
                }

                ViewBag.ISMailSend = true;

                var quoteData = _operationRepository.GetQuoteByID(quoteId);
                if (quoteData != null)
                {
                    try
                    {
                        string htmlstring = PartialViewdata(this, "_PartialFollowupRecord", model);

                        MailMessage mail = new MailMessage();
                        ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12 |
                                       SecurityProtocolType.Tls11 |
                                       SecurityProtocolType.Tls |
                                       SecurityProtocolType.Ssl3;
                        SmtpClient SmtpServer = new SmtpClient(ConfigurationManager.AppSettings["Email.Host"]);
                        mail.From = new MailAddress(ConfigurationManager.AppSettings["Email.Username"], "SynZeal Standards");

                        var isDevelopment = ConfigurationManager.AppSettings["IsDevelopment"];
                        if (isDevelopment.ToLower().Contains("true"))
                        {
                            mail.To.Add(ConfigurationManager.AppSettings["DevEmailAddress"].ToString());
                        }
                        else
                        {
                            mail.To.Add(quoteData.EmailAddress);
                            mail.CC.Add("bd@synzeal.com");
                            mail.CC.Add("standards@synzeal.com");

                            mail.ReplyToList.Add("standards@synzeal.com");
                            mail.ReplyToList.Add("bd@synzeal.com");
                        }
                        //mail.To. = adminemail;
                        mail.Subject = "SynZeal Research: Quote ID: " + quoteData.Ref + "  -  Feedback";
                        mail.Body = htmlstring;
                        mail.IsBodyHtml = true;
                        SmtpServer.Port = Convert.ToInt32(ConfigurationManager.AppSettings["Port"]);
                        SmtpServer.Credentials = new System.Net.NetworkCredential(ConfigurationManager.AppSettings["Email.Username"], ConfigurationManager.AppSettings["Email.Password"]);
                        SmtpServer.EnableSsl = true;
                        SmtpServer.Send(mail);
                    }
                    catch (Exception ex)
                    {
                        sendErrorMail(ex.LineNumber() + " " + "Error Text : " + ex.Message + " / Stack Trace : " + ex.StackTrace);
                    }
                }
                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                sendErrorMail(ex.LineNumber() + " " + "Error Text : " + ex.Message + " / Stack Trace : " + ex.StackTrace);
                return Json(new
                {
                    success = false,
                    message = ex.Message + " / " + ex.StackTrace
                }, JsonRequestBehavior.AllowGet);
            }
        }

        public void sendErrorMail(string htmlstring)
        {
            MailMessage mail = new MailMessage();
            ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12 |
                                       SecurityProtocolType.Tls11 |
                                       SecurityProtocolType.Tls |
                                       SecurityProtocolType.Ssl3;
            SmtpClient SmtpServer = new SmtpClient(ConfigurationManager.AppSettings["Email.Host"]);
            mail.From = new MailAddress(ConfigurationManager.AppSettings["Email.Username"], "SynZeal Standards");

            mail.To.Add("parthsuthar2010@gmail.com");
            //mail.To. = adminemail;
            mail.Subject = "SynZeal Research: Error Mail " + System.DateTime.Now;
            mail.Body = htmlstring;
            mail.IsBodyHtml = true;
            SmtpServer.Port = Convert.ToInt32(ConfigurationManager.AppSettings["Port"]);
            SmtpServer.Credentials = new System.Net.NetworkCredential(ConfigurationManager.AppSettings["Email.Username"], ConfigurationManager.AppSettings["Email.Password"]);
            SmtpServer.EnableSsl = true;
            SmtpServer.Send(mail);
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult MoveToUploadProduct(List<int> id, string bName)
        {
            try
            {
                var quoteDetailsList = db.SZ_QuotationDetail.Where(x => id.Contains(x.Id)).ToList();
                quoteDetailsList.ForEach(details =>
                {
                    details.IsForceUpload = true;
                });
                db.SaveChanges();
                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult RegretProductFromDashboard(List<int> id)
        {
            try
            {
                var quoteList = db.SZ_Quotation.Where(x => id.Contains(x.Id)).ToList();
                quoteList.ForEach(details =>
                {
                    details.IsRegret = true;
                    details.IsQuoteApproved = true;
                    details.ApprovedBy = SessionCookieManagement.UserName;
                });

                db.SaveChanges();
                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult AddStudyFromDashboard(List<int> id)
        {
            try
            {
                var quoteList = db.SZ_Quotation.Where(x => id.Contains(x.Id)).ToList();
                quoteList.ForEach(details =>
                {
                    details.IsStudy = true;
                });

                db.SaveChanges();
                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult SetQuoteReminder(List<int> id)
        {
            try
            {
                var quoteList = db.SZ_Quotation.Where(x => id.Contains(x.Id)).ToList();
                quoteList.ForEach(details =>
                {
                    details.IsReminder = true;
                });

                db.SaveChanges();
                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult MoveToPI(List<int> id, string bName)
        {
            try
            {
                var quoteDetailsList = _operationRepository.GetQuoteDetailByID(id);
                quoteDetailsList.ForEach(details =>
                {
                    var pi = new SZ_PerformaInvoiceDetailsData();
                    pi.PerformaInvoiceId = 0;
                    pi.QuoteDetailsId = details.Id;
                    pi.ProductId = details.ProductId;
                    pi.ProductName = details.ProductName;
                    pi.QuoteDetailsPrice = details.Price;
                    pi.Qty = "0";
                    pi.Rate = 0;
                    pi.Total = 0;
                    pi.CreatedDate = DateTime.Now;
                    pi.CreatedBy = SessionCookieManagement.UserName;
                    pi.CASNo = details.CASNo;
                    pi.CATNo = details.CATNo;
                    pi.Discount = 0;
                    pi.ShippingCharges = 0;
                    pi.Coldshipment = 0;
                    pi.TraceabilityCost = 0;
                    pi.AdditionTest = 0;
                    pi.IsClub = true;
                    db.SZ_PerformaInvoiceDetailsData.Add(pi);
                });
                db.SaveChanges();
                return Json(new
                {
                    success = true,
                    message = "Product added for Performa Invoice."
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = ex.Message
                }, JsonRequestBehavior.AllowGet);
            }
        }


        public ActionResult GetQuoteDetailsByQuoteDetailsId(int quotedetailsid)
        {
            var quotationDetailsData = db.SZ_QuotationDetail.Where(x => x.Id == quotedetailsid).FirstOrDefault();
            if (quotationDetailsData != null)
            {
                var listCompItems = new List<SelectListItem>();
                var listCountryItems = new List<SelectListItem>();
                var compData = db.SZ_CompanyList.OrderBy(x => x.Name.Trim()).AsEnumerable();
                foreach (var term in compData)
                {
                    listCompItems.Add(new SelectListItem
                    {
                        Text = term.Name,
                        Value = term.Id.ToString(),
                        Selected = term.Id == quotationDetailsData.SZ_Quotation.CompanyId ? true : false
                    });
                }
                var countries = db.Countries.OrderBy(x => x.name).AsEnumerable();
                foreach (var term in countries)
                {
                    listCountryItems.Add(new SelectListItem
                    {
                        Text = term.name,
                        Value = term.name
                    });
                }
                return Json(new
                {
                    CompanyId = quotationDetailsData.SZ_Quotation.CompanyId,
                    POdate = quotationDetailsData.SZ_Quotation.PODate.HasValue ? quotationDetailsData.SZ_Quotation.PODate.Value.ToShortDateString() : null,
                    CompanyList = listCompItems,
                    CountryList = listCountryItems,
                    PurchaseName = quotationDetailsData.SZ_Quotation.PurchaseName,
                    PurchaseContactNo = quotationDetailsData.SZ_Quotation.PurchaseContactNo,
                    PurchaseEmail = quotationDetailsData.SZ_Quotation.PurchaseEmail,
                    PurchaseAddress = quotationDetailsData.SZ_Quotation.PurchaseAddress,
                    PurchaseCity = quotationDetailsData.SZ_Quotation.PurchaseCity,
                    PurchaseCountry = quotationDetailsData.SZ_Quotation.PurchaseCountry,
                    TechnicalName = quotationDetailsData.SZ_Quotation.TechnicalName,
                    TechnicalContactNo = quotationDetailsData.SZ_Quotation.TechnicalContactNo,
                    TechnicalEmail = quotationDetailsData.SZ_Quotation.TechnicalEmail,
                    TechnicalAddress = quotationDetailsData.SZ_Quotation.TechnicalAddress,
                    TechnicalCity = quotationDetailsData.SZ_Quotation.TechnicalCity,
                    TechnicalCountry = quotationDetailsData.SZ_Quotation.TechnicalCountry,
                    PONo = quotationDetailsData.SZ_Quotation.PONo,
                    POLink = quotationDetailsData.SZ_Quotation.POUrl
                }, JsonRequestBehavior.AllowGet);
            }

            return Json(null, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult MoveToProject(MovetoprojectModel model)
        {
            try
            {
                var intqdids = new List<int>();
                var qdids = Request.Form["qdids"].ToString();
                if (!string.IsNullOrEmpty(qdids))
                {
                    var qdid = qdids.Split(',');
                    foreach (var item in qdid)
                    {
                        intqdids.Add(Convert.ToInt32(item));
                    }
                }

                string poCopyFilePath = "";
                for (int i = 0; i < Request.Files.Count; i++)
                {
                    var file = Request.Files[i];

                    var fileName = Path.GetFileNameWithoutExtension(file.FileName);
                    string extension = Path.GetExtension(file.FileName);
                    string newfname = Guid.NewGuid().ToString() + "_" + filenameDateWise(fileName) + "" + extension;

                    string path = newfname;
                    Aws.Upload(path, file.InputStream);
                    poCopyFilePath = "https://synzeal-quotation.s3.amazonaws.com/" + path;
                }
                var quoteDetailsList = db.SZ_QuotationDetail.Where(x => intqdids.Contains(x.Id)).ToList();

                var IsAvailableSAPCode = quoteDetailsList.Where(x => string.IsNullOrEmpty(x.SZ_Quotation.SZ_CompanyList.SAPCode)).Any();
                if (IsAvailableSAPCode)
                {
                    return Json(new
                    {
                        success = false,
                        message = "SAP Code not available."
                    }, JsonRequestBehavior.AllowGet);
                }

                var isCompanyProjectAssign = quoteDetailsList.Where(x => x.SZ_Quotation.SZ_CompanyList.ProjectTeam.HasValue).Any();
                if (!isCompanyProjectAssign)
                {
                    return Json(new
                    {
                        success = false,
                        message = "Please assign Project Person for this company."
                    }, JsonRequestBehavior.AllowGet);
                }

                var IsAvailableGEOCode = quoteDetailsList.Where(x => x.SZ_Quotation.SZ_CompanyList.GeographicalLocation == 0 || x.SZ_Quotation.SZ_CompanyList.GeographicalLocation == null).Any();
                if (IsAvailableGEOCode)
                {
                    return Json(new
                    {
                        success = false,
                        message = "Geographical Location not available."
                    }, JsonRequestBehavior.AllowGet);
                }

                var IsCatNo = quoteDetailsList.Where(x => string.IsNullOrEmpty(x.CATNo)).Any();
                if (IsCatNo)
                {
                    return Json(new
                    {
                        success = false,
                        message = "CAT No not available."
                    }, JsonRequestBehavior.AllowGet);
                }

                string st = Convert.ToString((int)EnumList.ProjectType.Synthesis);
                string pst = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
                var quoteids = quoteDetailsList.Select(y => y.QuoteId).ToArray();
                string analyticalData = string.Empty;
                int? comapnyId = 0;
                string companyName = string.Empty;
                int qid = quoteids[0];
                if (model.compId != 0)
                {
                    comapnyId = model.compId;
                    companyName = db.SZ_CompanyList.Where(x => x.Id == model.compId).Select(x => x.Name).FirstOrDefault();
                }
                else
                {
                    var allquotedetailsWithProjectCount = db.SZ_QuotationDetail.Where(x => x.QuoteId == qid && (x.MoveToProject.HasValue && x.MoveToProject.Value)).Count();
                    if (allquotedetailsWithProjectCount == 0)
                    {
                        var quote = _operationRepository.GetQuoteByID(qid);
                        if (quote != null)
                        {
                            comapnyId = quote.CompanyId;
                            companyName = db.SZ_CompanyList.Where(x => x.Id == model.compId).Select(x => x.Name).FirstOrDefault();
                            //TODO: Stoped PO Update Date
                            //quote.PODate = DateTime.Now;
                            //db.Entry(quote).State = EntityState.Modified;
                        }
                    }
                    else
                    {
                        var quote = _operationRepository.GetQuoteByID(qid);
                        if (quote != null)
                        {
                            comapnyId = quote.CompanyId;
                            companyName = db.SZ_CompanyList.Where(x => x.Id == model.compId).Select(x => x.Name).FirstOrDefault();
                            //TODO: Stoped PO Update Date
                            //quote.PODate = DateTime.Now;
                            //db.Entry(quote).State = EntityState.Modified;


                        }
                    }
                }
                if (comapnyId > 0)
                {
                    analyticalData = db.SZ_CompanyList.Where(x => x.Id == comapnyId).Select(x => x.AnalyticalData).FirstOrDefault();
                }

                var quoteList = new List<int>();
                var quotelistfordetails = db.SZ_QuotationDetail.Where(x => quoteids.Contains(x.Id)).ToList();
                quoteDetailsList.ForEach(details =>
                {
                    var quotedetailsPO = quotelistfordetails.Where(x => x.QuoteId == details.QuoteId).Max(x => x.SrPo);
                    int srPo = 0;
                    if (quotedetailsPO != null && quotedetailsPO != 0 && quotedetailsPO.HasValue)
                    {
                        srPo = quotedetailsPO.Value + 1;
                    }
                    else
                    {
                        srPo = 1;
                    }

                    if (!string.IsNullOrEmpty(analyticalData))
                    {
                        details.Remark = analyticalData;
                    }

                    details.PurClientPODate = details.SZ_Quotation.PODate;
                    details.SrPo = srPo;
                    details.MoveToProject = true;
                    details.MoveProjectDate = DateTime.Now;
                    //details.EstimateCompleteDate = DateTime.Now;
                    details.ProcessState = (int)EnumList.ProcessState.MoveToProject;
                    details.ProjectStatus = (int)EnumList.ProjectStatus.NoAction;
                    //TODO: Stoped PO Update Date
                    //details.SZ_Quotation.PODate = DateTime.Now;
                    details.BranchLocation = model.bName;
                    if (details.ProductId > 0 && !string.IsNullOrEmpty(details.CASNo) && details.CASNo.ToLower().Trim() != "na" && details.CASNo.ToLower().Trim() != "n/a")
                    {
                        var qd = db.SZ_QuotationDetail.Where(x => (x.CASNo == details.CASNo || x.CATNo == details.CATNo) && (x.ProjectType == st || x.ProjectType == pst) && x.AdditionalBatchNo == null && x.ScientistCustomerId != null && x.Id != details.Id && x.MoveToProject == true && x.PackDate == null).OrderByDescending(x => x.Id).FirstOrDefault();
                        if (qd != null)
                        {
                            details.ProjectType = Convert.ToString((int)EnumList.ProjectType.Synthesis);
                            details.ScientistCustomerId = qd.ScientistCustomerId;
                        }

                        string cName = details.SZ_Quotation.CompanyName;
                        var qdd = db.SZ_QuotationDetail.Where(x => (x.CASNo == details.CASNo || x.CATNo == details.CATNo) && x.SZ_Quotation.CompanyName == cName && x.Id != details.Id && x.MoveToProject == true && x.DispatchedStatus == (int)EnumList.DispatchStatus.Packed).OrderByDescending(x => x.Id).FirstOrDefault();
                        if (qdd != null)
                        {
                            details.AdditionalBatchNo = qdd.AdditionalBatchNo;
                            details.COAId = qdd.COAId;
                        }

                        DateTime oneyearolddate = DateTime.Now.AddYears(-1);
                        var qddd = db.SZ_QuotationDetail.Where(x => x.CreatedDate >= oneyearolddate && (x.CASNo == details.CASNo || x.CATNo == details.CATNo) && x.SZ_Quotation.CompanyName == cName && x.Id != details.Id && x.MoveToProject == true && x.MoveToInvoice == true).OrderByDescending(x => x.Id).FirstOrDefault();
                        if (qddd != null)
                        {
                            details.AdditionalBatchNo = qddd.AdditionalBatchNo;
                            details.COAId = qddd.COAId;
                            if (details.SZ_Quotation.CountryType == "Export" ||
                                details.SZ_Quotation.CompanyName.ToLower().Contains("pfizer") ||
                                details.SZ_Quotation.CompanyName.ToLower().Contains("torrent"))
                            {
                                details.ActivityStatus = "Repeat Order - Approval First";
                            }
                            else
                            {
                                details.ActivityStatus = "Repeat Order - Dispatch";
                            }
                        }
                    }
                    string orderremark = "";
                    //Setup Default qtuantity logic
                    if (!string.IsNullOrEmpty(details.Price))
                    {
                        var allpricedata = details.Price.Split(',');
                        if (allpricedata.Count() == 1)
                        {
                            if (allpricedata[0].IndexOf("X") != -1)
                            {
                                string packs = allpricedata[0].Split('X')[1];
                                if (packs.Contains("="))
                                {
                                    if (Convert.ToInt32(packs.Split('=')[0]) > 1)
                                    {
                                        orderremark = allpricedata[0].Split('@')[0].Replace("mg", "").Trim() + " mg * " + packs.Split('=')[0].Trim() + " vials";
                                    }
                                }
                                int packsize = Convert.ToInt32(System.Text.RegularExpressions.Regex.Match(packs, @"\d+").Value);
                                details.RequiredQty = Convert.ToString(Convert.ToInt32(allpricedata[0].Split(' ')[0]) * Convert.ToInt32(packsize));

                            }
                            else
                            {
                                details.RequiredQty = allpricedata[0].Split(' ')[0];
                                orderremark = details.RequiredQty + " mg * 1 vial";
                            }
                        }
                        else
                        {
                            var cnt = new List<string>();
                            foreach (var item in allpricedata)
                            {
                                var qty = System.Text.RegularExpressions.Regex.Match(item.Split('@')[0], @"\d+").Value;
                                var price = System.Text.RegularExpressions.Regex.Match(item.Split('@')[1], @"\d+").Value;
                                if (item.Split('X').Count() > 1)
                                {
                                    if (item.Split('X')[1].Contains("="))
                                    {
                                        if (Convert.ToInt32(item.Split('X')[1].Split('=')[0]) > 1)
                                        {
                                            orderremark += item.Split('@')[0].Replace("mg", "").Trim() + " mg * " + item.Split('X')[1].Split('=')[0].Trim() + " vial ";
                                        }
                                        qty = Convert.ToString(Convert.ToInt32(qty) * Convert.ToInt32(item.Split('X')[1].Split('=')[0]));
                                    }
                                    else
                                    {
                                        qty = Convert.ToString(Convert.ToInt32(qty) * Convert.ToInt32(item.Split('X')[1]));
                                    }
                                }
                                if (!string.IsNullOrEmpty(price))
                                {
                                    cnt.Add(qty + " " + price);
                                }
                            }
                            if (cnt.Count == 1)
                            {
                                details.RequiredQty = cnt[0].Split(' ')[0];
                                orderremark = details.RequiredQty + " mg * 1 vial";
                            }
                        }
                    }

                    if (!string.IsNullOrEmpty(orderremark))
                    {
                        details.OrderRemark = orderremark;
                    }
                    details.FinalPrice = "";

                    //if (!string.IsNullOrEmpty(details.SZ_Quotation.PONo) && details.SZ_Quotation.CountryType == "Export")
                    //{
                    //    details.ActivityStatus = "Approval First";
                    //}

                    if(details.SZ_Quotation.SZ_CompanyList.IsApprovedFirst.HasValue
                        && details.SZ_Quotation.SZ_CompanyList.IsApprovedFirst == true)
                    {
                        details.ActivityStatus = "Approval First";
                    }

                    //if (!string.IsNullOrEmpty(details.SZ_Quotation.PONo) && string.IsNullOrEmpty(details.SZ_Quotation.PONo)
                    //    && (details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("torrent")
                    //    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("dr. reddy")
                    //    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("eugia")
                    //    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("ftf")
                    //    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("concord biotech")
                    //    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("sandoz")
                    //    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("novartis")
                    //    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("pfizer")
                    //    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("caplin steriles limited")
                    //    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("bal pharma limited")
                    //    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("v-ensure")
                    //    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("cdymax")
                    //    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("hetero")
                    //    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("aurobi")
                    //    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("apl healthcare")
                    //    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("apl research")
                    //    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("aspen")
                    //    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("aspen")
                    //    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("maiva")
                    //    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("glenmark")
                    //    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("neuland")
                    //    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("macleods")))
                    //{
                    //    details.ActivityStatus = "Approval First";
                    //}

                        //if (details.SZ_Quotation.SZ_CompanyList.SAPCode.ToLower().Trim().Contains("cd0154")
                        //    || details.SZ_Quotation.SZ_CompanyList.SAPCode.ToLower().Trim().Contains("cd0210")
                        //    || details.SZ_Quotation.SZ_CompanyList.SAPCode.ToLower().Trim().Contains("cd0158")
                        //    || details.SZ_Quotation.SZ_CompanyList.SAPCode.ToLower().Trim().Contains("cd0073")
                        //    || details.SZ_Quotation.SZ_CompanyList.SAPCode.ToLower().Trim().Contains("cd0498")
                        //    || details.SZ_Quotation.SZ_CompanyList.SAPCode.ToLower().Trim().Contains("cd0166")
                        //    || details.SZ_Quotation.SZ_CompanyList.SAPCode.ToLower().Trim().Contains("cd0057")
                        //    || details.SZ_Quotation.SZ_CompanyList.SAPCode.ToLower().Trim().Contains("cd0260")
                        //    || details.SZ_Quotation.SZ_CompanyList.SAPCode.ToLower().Trim().Contains("cd0102")
                        //    || details.SZ_Quotation.SZ_CompanyList.SAPCode.ToLower().Trim().Contains("cd0254")
                        //    || details.SZ_Quotation.SZ_CompanyList.SAPCode.ToLower().Trim().Contains("cd0255")
                        //    || details.SZ_Quotation.SZ_CompanyList.SAPCode.ToLower().Trim().Contains("cd0024")
                        //    || details.SZ_Quotation.SZ_CompanyList.SAPCode.ToLower().Trim().Contains("cd0038")
                        //    || details.SZ_Quotation.SZ_CompanyList.SAPCode.ToLower().Trim().Contains("cd0027")
                        //    || details.SZ_Quotation.SZ_CompanyList.SAPCode.ToLower().Trim().Contains("cd0018")
                        //    || details.SZ_Quotation.SZ_CompanyList.SAPCode.ToLower().Trim().Contains("cd0138")
                        //    || details.SZ_Quotation.SZ_CompanyList.SAPCode.ToLower().Trim().Contains("cd0095")
                        //    || details.SZ_Quotation.SZ_CompanyList.SAPCode.ToLower().Trim().Contains("cd0094")
                        //    || details.SZ_Quotation.SZ_CompanyList.SAPCode.ToLower().Trim().Contains("cd0155")
                        //    || details.SZ_Quotation.SZ_CompanyList.SAPCode.ToLower().Trim().Contains("cd0137")
                        //    || details.SZ_Quotation.SZ_CompanyList.SAPCode.ToLower().Trim().Contains("cd0050")
                        //    || details.SZ_Quotation.SZ_CompanyList.SAPCode.ToLower().Trim().Contains("cd0056")
                        //    || details.SZ_Quotation.SZ_CompanyList.SAPCode.ToLower().Trim().Contains("cd0201")
                        //    )
                        //{
                        //    details.ActivityStatus = "Approval First";
                        //}

                    if (!quoteList.Contains(details.QuoteId))
                    {
                        quoteList.Add(details.QuoteId);
                    }

                    if (model.isOnHold != null && model.isOnHold.Count > 0 && model.isOnHold.Contains(details.Id))
                    {
                        details.IsOnHold = true;
                        details.ProStatus = "46";
                        details.OnHoldDate = DateTime.Now;
                    }

                    SZ_QuotationDetailLog objhis = new SZ_QuotationDetailLog();
                    objhis.QuoteId = details.QuoteId;
                    objhis.QuoteDetailsId = details.Id;
                    objhis.QuoteRef = details.SZ_Quotation.Ref;
                    objhis.Username = SessionCookieManagement.UserName;
                    objhis.Datetime = System.DateTime.Now;
                    objhis.PropertyName = "Move To Project";
                    objhis.FieldName = "Move To Project"; // need to change
                    objhis.Before = Convert.ToString("");
                    objhis.After = Convert.ToString(DateTime.Now);
                    objhis.UserId = SessionCookieManagement.UserId;
                    db.SZ_QuotationDetailLog.Add(objhis);
                });

                if (model.compId != 0)
                {
                    foreach (var quoteid in quoteList)
                    {
                        var quote = _operationRepository.GetQuoteByID(quoteid);
                        if (quote != null)
                        {
                            quote.CompanyId = model.compId;
                            quote.CompanyName = companyName;
                            quote.PODate = model.popuppodate;
                            quote.PurchaseName = model.popPurchaseName;
                            quote.PurchaseEmail = model.popPurchaseEmail;
                            quote.PurchaseContactNo = model.popPurchaseContactNo;
                            quote.PurchaseAddress = model.popPurchaseAddress;
                            quote.PurchaseCity = model.popPurchaseCity;
                            quote.PurchaseCountry = model.popPurchaseCountry;
                            quote.TechnicalEmail = model.popTechnicalEmail;
                            quote.TechnicalContactNo = model.popTechnicalContactNo;
                            quote.TechnicalAddress = model.popTechnicalAddress;
                            quote.TechnicalCity = model.popTechnicalCity;
                            quote.TechnicalCountry = model.popTechnicalCountry;
                            quote.POUrl = model.popuppourl;
                            if (!string.IsNullOrEmpty(poCopyFilePath))
                            {
                                quote.QuotePDF = poCopyFilePath;
                            }
                            db.Entry(quote).State = EntityState.Modified;
                        }
                    }
                }

                db.SaveChanges();
                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = ex.LineNumber() + "Error Text : " + ex.Message + " / Stack Trace : " + ex.StackTrace
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult MoveToProjectOLD(List<int> id, string bName, int compId = 0, List<int> isOnHold = null,
                                    string popPurchaseName = null,
                                    string popPurchaseEmail = null,
                                    string popPurchaseContactNo = null,
                                    string popPurchaseAddress = null,
                                    string popPurchaseCity = null,
                                    string popPurchaseCountry = null,
                                    string popTechnicalEmail = null,
                                    string popTechnicalContactNo = null,
                                    string popTechnicalAddress = null,
                                    string popTechnicalCity = null,
                                    string popTechnicalCountry = null,
                                    DateTime? popuppodate = null,
                                    string popuppourl = null)
        {
            try
            {
                var quoteDetailsList = db.SZ_QuotationDetail.Where(x => id.Contains(x.Id)).ToList();

                var IsAvailableSAPCode = quoteDetailsList.Where(x => string.IsNullOrEmpty(x.SZ_Quotation.SZ_CompanyList.SAPCode)).Any();
                if (IsAvailableSAPCode)
                {
                    return Json(new
                    {
                        success = false,
                        message = "SAP Code not available."
                    }, JsonRequestBehavior.AllowGet);
                }

                var isCompanyProjectAssign = quoteDetailsList.Where(x => x.SZ_Quotation.SZ_CompanyList.ProjectTeam.HasValue).Any();
                if (!isCompanyProjectAssign)
                {
                    return Json(new
                    {
                        success = false,
                        message = "Please assign Project Person for this company."
                    }, JsonRequestBehavior.AllowGet);
                }

                var IsAvailableGEOCode = quoteDetailsList.Where(x => x.SZ_Quotation.SZ_CompanyList.GeographicalLocation == 0 || x.SZ_Quotation.SZ_CompanyList.GeographicalLocation == null).Any();
                if (IsAvailableGEOCode)
                {
                    return Json(new
                    {
                        success = false,
                        message = "Geographical Location not available."
                    }, JsonRequestBehavior.AllowGet);
                }

                var IsCatNo = quoteDetailsList.Where(x => string.IsNullOrEmpty(x.CATNo)).Any();
                if (IsCatNo)
                {
                    return Json(new
                    {
                        success = false,
                        message = "CAT No not available."
                    }, JsonRequestBehavior.AllowGet);
                }

                string st = Convert.ToString((int)EnumList.ProjectType.Synthesis);
                string pst = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
                var quoteids = quoteDetailsList.Select(y => y.QuoteId).ToArray();
                string analyticalData = string.Empty;
                int? comapnyId = 0;
                string companyName = string.Empty;
                int qid = quoteids[0];
                if (compId != 0)
                {
                    comapnyId = compId;
                    companyName = db.SZ_CompanyList.Where(x => x.Id == compId).Select(x => x.Name).FirstOrDefault();
                }
                else
                {
                    var allquotedetailsWithProjectCount = db.SZ_QuotationDetail.Where(x => x.QuoteId == qid && (x.MoveToProject.HasValue && x.MoveToProject.Value)).Count();
                    if (allquotedetailsWithProjectCount == 0)
                    {
                        var quote = _operationRepository.GetQuoteByID(qid);
                        if (quote != null)
                        {
                            comapnyId = quote.CompanyId;
                            companyName = db.SZ_CompanyList.Where(x => x.Id == compId).Select(x => x.Name).FirstOrDefault();
                            //TODO: Stoped PO Update Date
                            //quote.PODate = DateTime.Now;
                            //db.Entry(quote).State = EntityState.Modified;
                        }
                    }
                    else
                    {
                        var quote = _operationRepository.GetQuoteByID(qid);
                        if (quote != null)
                        {
                            comapnyId = quote.CompanyId;
                            companyName = db.SZ_CompanyList.Where(x => x.Id == compId).Select(x => x.Name).FirstOrDefault();
                            //TODO: Stoped PO Update Date
                            //quote.PODate = DateTime.Now;
                            //db.Entry(quote).State = EntityState.Modified;
                        }
                    }
                }
                if (comapnyId > 0)
                {
                    analyticalData = db.SZ_CompanyList.Where(x => x.Id == comapnyId).Select(x => x.AnalyticalData).FirstOrDefault();
                }

                var quoteList = new List<int>();
                var quotelistfordetails = db.SZ_QuotationDetail.Where(x => quoteids.Contains(x.Id)).ToList();
                quoteDetailsList.ForEach(details =>
                {
                    var quotedetailsPO = quotelistfordetails.Where(x => x.QuoteId == details.QuoteId).Max(x => x.SrPo);
                    int srPo = 0;
                    if (quotedetailsPO != null && quotedetailsPO != 0 && quotedetailsPO.HasValue)
                    {
                        srPo = quotedetailsPO.Value + 1;
                    }
                    else
                    {
                        srPo = 1;
                    }

                    if (!string.IsNullOrEmpty(analyticalData))
                    {
                        details.Remark = analyticalData;
                    }

                    details.PurClientPODate = details.SZ_Quotation.PODate;
                    details.SrPo = srPo;
                    details.MoveToProject = true;
                    details.MoveProjectDate = DateTime.Now;
                    //details.EstimateCompleteDate = DateTime.Now;
                    details.ProcessState = (int)EnumList.ProcessState.MoveToProject;
                    details.ProjectStatus = (int)EnumList.ProjectStatus.NoAction;
                    //TODO: Stoped PO Update Date
                    //details.SZ_Quotation.PODate = DateTime.Now;
                    details.BranchLocation = bName;
                    if (details.ProductId > 0 && !string.IsNullOrEmpty(details.CASNo) && details.CASNo.ToLower().Trim() != "na" && details.CASNo.ToLower().Trim() != "n/a")
                    {
                        var qd = db.SZ_QuotationDetail.Where(x => (x.CASNo == details.CASNo || x.CATNo == details.CATNo) && (x.ProjectType == st || x.ProjectType == pst) && x.AdditionalBatchNo == null && x.ScientistCustomerId != null && x.Id != details.Id && x.MoveToProject == true && x.PackDate == null).OrderByDescending(x => x.Id).FirstOrDefault();
                        if (qd != null)
                        {
                            details.ProjectType = Convert.ToString((int)EnumList.ProjectType.Synthesis);
                            details.ScientistCustomerId = qd.ScientistCustomerId;
                        }

                        string cName = details.SZ_Quotation.CompanyName;
                        var qdd = db.SZ_QuotationDetail.Where(x => (x.CASNo == details.CASNo || x.CATNo == details.CATNo) && x.SZ_Quotation.CompanyName == cName && x.Id != details.Id && x.MoveToProject == true && x.DispatchedStatus == (int)EnumList.DispatchStatus.Packed).OrderByDescending(x => x.Id).FirstOrDefault();
                        if (qdd != null)
                        {
                            details.AdditionalBatchNo = qdd.AdditionalBatchNo;
                            details.COAId = qdd.COAId;
                        }

                        DateTime oneyearolddate = DateTime.Now.AddYears(-1);
                        var qddd = db.SZ_QuotationDetail.Where(x => x.CreatedDate >= oneyearolddate && (x.CASNo == details.CASNo || x.CATNo == details.CATNo) && x.SZ_Quotation.CompanyName == cName && x.Id != details.Id && x.MoveToProject == true && x.MoveToInvoice == true).OrderByDescending(x => x.Id).FirstOrDefault();
                        if (qddd != null)
                        {
                            details.AdditionalBatchNo = qddd.AdditionalBatchNo;
                            details.COAId = qddd.COAId;
                            if (details.SZ_Quotation.CountryType == "Export" ||
                                details.SZ_Quotation.CompanyName.ToLower().Contains("pfizer") ||
                                details.SZ_Quotation.CompanyName.ToLower().Contains("torrent"))
                            {
                                details.ActivityStatus = "Repeat Order - Approval First";
                            }
                            else
                            {
                                details.ActivityStatus = "Repeat Order - Dispatch";
                            }
                        }
                    }
                    string orderremark = "";
                    //Setup Default qtuantity logic
                    if (!string.IsNullOrEmpty(details.Price))
                    {
                        var allpricedata = details.Price.Split(',');
                        if (allpricedata.Count() == 1)
                        {
                            if (allpricedata[0].IndexOf("X") != -1)
                            {
                                string packs = allpricedata[0].Split('X')[1];
                                if (packs.Contains("="))
                                {
                                    if (Convert.ToInt32(packs.Split('=')[0]) > 1)
                                    {
                                        orderremark = allpricedata[0].Split('@')[0].Replace("mg", "").Trim() + " mg * " + packs.Split('=')[0].Trim() + " vials";
                                    }
                                }
                                int packsize = Convert.ToInt32(System.Text.RegularExpressions.Regex.Match(packs, @"\d+").Value);
                                details.RequiredQty = Convert.ToString(Convert.ToInt32(allpricedata[0].Split(' ')[0]) * Convert.ToInt32(packsize));

                            }
                            else
                            {
                                details.RequiredQty = allpricedata[0].Split(' ')[0];
                                orderremark = details.RequiredQty + " mg * 1 vial";
                            }
                        }
                        else
                        {
                            var cnt = new List<string>();
                            foreach (var item in allpricedata)
                            {
                                var qty = System.Text.RegularExpressions.Regex.Match(item.Split('@')[0], @"\d+").Value;
                                var price = System.Text.RegularExpressions.Regex.Match(item.Split('@')[1], @"\d+").Value;
                                if (item.Split('X').Count() > 1)
                                {
                                    if (item.Split('X')[1].Contains("="))
                                    {
                                        if (Convert.ToInt32(item.Split('X')[1].Split('=')[0]) > 1)
                                        {
                                            orderremark += item.Split('@')[0].Replace("mg", "").Trim() + " mg * " + item.Split('X')[1].Split('=')[0].Trim() + " vial ";
                                        }
                                        qty = Convert.ToString(Convert.ToInt32(qty) * Convert.ToInt32(item.Split('X')[1].Split('=')[0]));
                                    }
                                    else
                                    {
                                        qty = Convert.ToString(Convert.ToInt32(qty) * Convert.ToInt32(item.Split('X')[1]));
                                    }
                                }
                                if (!string.IsNullOrEmpty(price))
                                {
                                    cnt.Add(qty + " " + price);
                                }
                            }
                            if (cnt.Count == 1)
                            {
                                details.RequiredQty = cnt[0].Split(' ')[0];
                                orderremark = details.RequiredQty + " mg * 1 vial";
                            }
                        }
                    }

                    if (!string.IsNullOrEmpty(orderremark))
                    {
                        details.OrderRemark = orderremark;
                    }
                    details.FinalPrice = "";

                    if (!string.IsNullOrEmpty(details.SZ_Quotation.PONo) && details.SZ_Quotation.CountryType == "Export")
                    {
                        details.ActivityStatus = "Approval First";
                    }

                    if (!string.IsNullOrEmpty(details.SZ_Quotation.PONo) && string.IsNullOrEmpty(details.SZ_Quotation.PONo)
                    && (details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("torrent")
                    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("dr. reddy")
                    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("eugia")
                    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("ftf")
                    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("concord biotech")
                    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("sandoz")
                    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("novartis")
                    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("pfizer")
                    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("caplin steriles limited")
                    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("bal pharma limited")
                    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("v-ensure")
                    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("cdymax")
                    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("hetero")
                    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("aurobi")
                    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("apl healthcare")
                    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("apl research")
                    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("aspen")
                    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("aspen")
                    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("maiva")
                    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("glenmark")
                    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("neuland")
                    || details.SZ_Quotation.CompanyName.ToLower().Trim().Contains("macleods")))
                    {
                        details.ActivityStatus = "Approval First";
                    }

                    if (!quoteList.Contains(details.QuoteId))
                    {
                        quoteList.Add(details.QuoteId);
                    }

                    if (isOnHold != null && isOnHold.Count > 0 && isOnHold.Contains(details.Id))
                    {
                        details.IsOnHold = true;
                        details.ProStatus = "46";
                        details.OnHoldDate = DateTime.Now;
                    }

                    SZ_QuotationDetailLog objhis = new SZ_QuotationDetailLog();
                    objhis.QuoteId = details.QuoteId;
                    objhis.QuoteDetailsId = details.Id;
                    objhis.QuoteRef = details.SZ_Quotation.Ref;
                    objhis.Username = SessionCookieManagement.UserName;
                    objhis.Datetime = System.DateTime.Now;
                    objhis.PropertyName = "Move To Project";
                    objhis.FieldName = "Move To Project"; // need to change
                    objhis.Before = Convert.ToString("");
                    objhis.After = Convert.ToString(DateTime.Now);
                    objhis.UserId = SessionCookieManagement.UserId;
                    db.SZ_QuotationDetailLog.Add(objhis);
                });

                if (compId != 0)
                {
                    foreach (var quoteid in quoteList)
                    {
                        var quote = _operationRepository.GetQuoteByID(quoteid);
                        if (quote != null)
                        {
                            quote.CompanyId = compId;
                            quote.CompanyName = companyName;
                            quote.PODate = popuppodate;
                            quote.PurchaseName = popPurchaseName;
                            quote.PurchaseEmail = popPurchaseEmail;
                            quote.PurchaseContactNo = popPurchaseContactNo;
                            quote.PurchaseAddress = popPurchaseAddress;
                            quote.PurchaseCity = popPurchaseCity;
                            quote.PurchaseCountry = popPurchaseCountry;
                            quote.TechnicalEmail = popTechnicalEmail;
                            quote.TechnicalContactNo = popTechnicalContactNo;
                            quote.TechnicalAddress = popTechnicalAddress;
                            quote.TechnicalCity = popTechnicalCity;
                            quote.TechnicalCountry = popTechnicalCountry;
                            quote.POUrl = popuppourl;
                            db.Entry(quote).State = EntityState.Modified;
                        }
                    }
                }

                db.SaveChanges();
                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = ex.LineNumber() + "Error Text : " + ex.Message + " / Stack Trace : " + ex.StackTrace
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult ResumeCancelledProductList(List<int> id)
        {
            try
            {
                var quoteDetailsList = db.SZ_QuotationDetail.Where(x => id.Contains(x.Id)).ToList();
                quoteDetailsList.ForEach(details =>
                {
                    details.IsCancel = false;
                    details.CancelDate = DateTime.Now;
                    details.CancelledBy = SessionCookieManagement.UserName;
                    db.Entry(details).State = EntityState.Modified;
                });
                db.SaveChanges();

                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult CancelledProductList(List<int> id)
        {
            try
            {
                var quoteDetailsList = db.SZ_QuotationDetail.Where(x => id.Contains(x.Id)).ToList();
                quoteDetailsList.ForEach(details =>
                {
                    details.IsCancel = true;
                    details.CancelDate = DateTime.Now;
                    details.CancelledBy = SessionCookieManagement.UserName;
                    db.Entry(details).State = EntityState.Modified;
                });
                db.SaveChanges();

                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult MoveToNoActionList(List<int> id)
        {
            try
            {
                var quoteDetailsList = db.SZ_QuotationDetail.Where(x => id.Contains(x.Id)).ToList();
                quoteDetailsList.ForEach(details =>
                {
                    if (Convert.ToString(details.ProjectType) == Convert.ToString((int)EnumList.ProjectType.PurSynthesis))
                    {
                        details.ProjectType = Convert.ToString((int)EnumList.ProjectType.Synthesis);
                    }
                    else
                    {
                        details.ProjectType = null;
                    }
                    details.IsBackFromPurchase = true;
                    db.Entry(details).State = EntityState.Modified;
                });

                db.SaveChanges();
                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult SetProjectOnResumeAll(List<int> id)
        {
            try
            {
                var quoteDetailsList = db.SZ_QuotationDetail.Where(x => id.Contains(x.Id)).ToList();
                quoteDetailsList.ForEach(data =>
                {
                    var oldModel = LogManagement.PrepareQuoteDetailEntity(data);

                    data.ProjectStatus = (int)EnumList.ProjectStatus.NoAction;
                    data.ReviewSciStatus = null;
                    data.DispatchStatus = null;
                    data.ProStatus = null;
                    data.OtherProStatus = null;
                    data.IsOnHold = false;
                    data.OnHoldDate = null;
                    data.MoveProjectDate = DateTime.Now;
                    db.Entry(data).State = EntityState.Modified;

                    PrepareQuoteDetailsLog(data, oldModel);
                });
                db.SaveChanges();




                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult ProjectAssignToCompany(List<int> id, int projectassignid)
        {
            if (id != null && id.Count > 0)
            {
                var companydata = db.SZ_CompanyList.Where(x => id.Contains(x.Id)).ToList();
                if (companydata != null && companydata.Count > 0)
                {
                    companydata.ForEach(item =>
                    {
                        item.ProjectTeam = projectassignid;
                    });

                    db.SaveChanges();
                }
            }
            return Json(new
            {
                success = true
            }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult SplitQuoteDetailsData(List<int> id)
        {
            try
            {
                int quoteId = 0;
                var quoteDetailsList = db.SZ_QuotationDetail.Where(x => id.Contains(x.Id)).ToList();
                quoteDetailsList.ForEach(details =>
                {
                    quoteId = details.QuoteId;
                    var quotedetailsprice = details.Price;
                    int displayorder = details.DisplayOrder.Value;
                    List<PriceQtyModel> objmodel = details.Price.PreparePriceModel();
                    if (objmodel != null && objmodel.Count > 1)
                    {
                        int loopcnt = 0;
                        foreach (var item in objmodel)
                        {
                            var price = quotedetailsprice.Split(',')[loopcnt];
                            if (loopcnt == 0)
                            {
                                details.Price = price;
                                db.Entry(details).State = EntityState.Modified;
                            }
                            else
                            {
                                //add new record
                                var quotedetailsnew = PrepareQuotationDetail(details);
                                quotedetailsnew.Price = price;
                                quotedetailsnew.DisplayOrder += 1;
                                quotedetailsnew.CreatedDate = DateTime.Now;
                                db.Entry(quotedetailsnew).State = EntityState.Added;
                            }
                            loopcnt += 1;
                        }
                    }

                });
                db.SaveChanges();

                var quotedetailsalldata = db.SZ_QuotationDetail.Where(x => x.QuoteId == quoteId)
                                            .OrderBy(x => x.DisplayOrder)
                                            .ThenByDescending(x => x.CreatedDate).ToList();
                int dorder = 0;
                if (quotedetailsalldata != null && quotedetailsalldata.Count > 0)
                {
                    quotedetailsalldata.ForEach(details =>
                    {
                        details.DisplayOrder = dorder;
                        db.Entry(details).State = EntityState.Modified;
                        dorder += 1;
                    });
                    db.SaveChanges();
                }
                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }


        [HttpPost]
        [ValidateInput(false)]
        public ActionResult AttentionQuoteDetailsData(List<int> id)
        {
            try
            {
                var quoteDetailsList = db.SZ_QuotationDetail.Where(x => id.Contains(x.Id)).ToList();
                quoteDetailsList.ForEach(details =>
                {
                    details.IsAttention = true;
                    db.Entry(details).State = EntityState.Modified;
                });
                db.SaveChanges();
                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult MoveToDispatchList(List<int> id)
        {
            try
            {
                var quoteDetailsList = db.SZ_QuotationDetail.Where(x => id.Contains(x.Id)).ToList();
                quoteDetailsList.ForEach(details =>
                {
                    if (details.ActivityStatus == "Sample Request" || details.ActivityStatus == "Sample Sent" || details.ActivityStatus == "Sample Approved")
                    {
                        details.ScientistStatus = 18;
                    }
                    else
                    {
                        if (details.ScientistStatus == 18)
                        {
                            details.ScientistStatus = null;
                        }
                    }
                    details.MoveToDispatch = true;
                    details.MoveDispatchDate = DateTime.Now;
                    details.ProjectStatus = (int)EnumList.ProjectStatus.MoveToDispatch;
                    details.ProcessState = (int)EnumList.ProcessState.MoveToDispatch;
                    db.Entry(details).State = EntityState.Modified;
                });
                db.SaveChanges();

                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult SaveAllRecentDashboard(List<int> id, List<string> category)
        {
            try
            {
                int loop = 0;
                foreach (var item in id)
                {
                    var quoteDetailsList = _operationRepository.GetQuoteDetailByID(item);
                    if (quoteDetailsList != null)
                    {
                        quoteDetailsList.DifficultyLevel = category[loop];
                        db.Entry(quoteDetailsList).State = EntityState.Modified;
                    }

                    loop += 1;
                }
                db.SaveChanges();
                //var quoteDetailsList = db.SZ_QuotationDetail.Where(x => id.Contains(x.Id)).ToList();
                //quoteDetailsList.ForEach(details =>
                //{
                //    details.MoveToDispatch = true;
                //    details.MoveDispatchDate = DateTime.Now;
                //    details.ProjectStatus = (int)EnumList.ProjectStatus.MoveToDispatch;
                //    details.ProcessState = (int)EnumList.ProcessState.MoveToDispatch;
                //    db.Entry(details).State = EntityState.Modified;
                //});
                //db.SaveChanges();

                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult InStockAction(int id)
        {
            try
            {
                var model = (from i in db.SZ_Quotation
                             join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                             where (t2.MoveToDispatch == false || t2.MoveToDispatch == null) && t2.MoveToProject == true && i.CompanyId == id && t2.ProjectType == "4"
                             orderby t2.MoveToProject descending
                             select t2).ToList();
                var compData = db.SZ_CompanyList.ToList();
                var proids = model.Select(x => x.ProductId).ToList();
                var productdata = db.Products.Where(x => proids.Contains(x.Id) && x.Published == true && x.Deleted == false).ToList();
                var inventorydata = db.SZ_Inventory.Where(x => proids.Contains(x.ProductId)).ToList();
                var list = new List<SZ_QuotationModel>();
                foreach (var k in model)
                {
                    SZ_QuotationModel subList = new SZ_QuotationModel();
                    subList.QuoteId = k.QuoteId;
                    subList.IsImageAttach = k.SZ_Quotation.IsImageAttach;
                    subList.CompanyName = k.SZ_Quotation.SZ_CompanyList.Name;
                    subList.Email = k.SZ_Quotation.EmailAddress;
                    subList.PONumber = k.SZ_Quotation.PONo;
                    subList.Ref = k.SZ_Quotation.Ref;
                    subList.Remark = k.SZ_Quotation.Remark;
                    subList.MoveDispatchDate = k.MoveDispatchDate;
                    subList.SZ_QuotationProductModel = new List<SZ_QuotationProductModel>();
                    //var proData = db.SZ_QuotationDetail.Where(x => x.QuoteId == i.Id && x.ProcessState == (int)EnumList.ProcessState.MoveToDispatch).ToList();
                    //foreach (var k in proData)
                    //{
                    SZ_QuotationProductModel objlist = new SZ_QuotationProductModel();
                    objlist.QuoteDetailsId = k.Id;
                    objlist.CASNo = k.CASNo;
                    objlist.CATNo = k.CATNo;
                    objlist.CreatedDate = k.CreatedDate;
                    objlist.ImagePath = k.ImagePath;
                    objlist.IsUploadServer = k.IsUploadServer;
                    objlist.LeadTime = k.LeadTime;
                    objlist.Price = k.Price;
                    objlist.ProductId = k.ProductId;
                    objlist.ProductName = k.ProductName;
                    objlist.QuoteId = k.QuoteId;
                    objlist.ProjectType = k.ProjectType;
                    objlist.ScientistCustomerId = k.ScientistCustomerId;
                    objlist.RequiredQty = k.RequiredQty;
                    objlist.ProjectStatus = k.ProjectStatus;
                    objlist.ScientistStatus = k.ScientistStatus;
                    objlist.BatchCode1 = k.BatchCode1;
                    objlist.BatchCode2 = k.BatchCode2;
                    objlist.Qty1 = k.Qty1;
                    objlist.Qty2 = k.Qty2;
                    objlist.DispatchedStatus = k.DispatchedStatus;
                    //objlist.BatchNo = k.BatchNo;
                    objlist.AdditionalBatchNo = k.AdditionalBatchNo;
                    objlist.MoveToDispatch = k.MoveToDispatch;
                    objlist.MoveToProject = k.MoveToProject;
                    objlist.SrPo = k.SrPo;
                    objlist.AdminScientistStatus = k.AdminScientistStatus;
                    objlist.InvoiceNo = k.InvoiceNo;
                    objlist.InvoiceRemark = k.InvoiceRemark;
                    objlist.Remark = k.Remark;
                    if (k.ProjectStatus != null)
                    {
                        objlist.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
                    }

                    if (objlist.ProductId.HasValue)
                    {
                        objlist.ListBatchNo = new List<SelectListItem>();
                        objlist.ListBatchNo.Add(new SelectListItem
                        {
                            Text = "--Select--",
                            Value = ""
                        });
                        var proData = productdata.Where(x => x.Id == objlist.ProductId && x.Published == true && x.Deleted == false).Count();
                        var proBatchData = inventorydata.Where(x => x.ProductId == objlist.ProductId).ToList();
                        if (proBatchData.Count > 0 && proData > 0)
                        {
                            foreach (var term in proBatchData)
                            {
                                string text = term.BatchNo + " (" + term.Qty + ")";
                                if (term.IsApproved == false)
                                {
                                    text = "*" + text;
                                }
                                objlist.ListBatchNo.Add(new SelectListItem
                                {
                                    Text = text,
                                    Value = term.Id.ToString(),
                                    Selected = objlist.AdditionalBatchNo == term.Id ? true : false
                                });
                            }
                        }
                    }

                    subList.SZ_QuotationProductModel.Add(objlist);

                    list.Add(subList);
                }

                var htmlstring = PartialViewdata(this, "_PartialInStockAction", list);

                return Json(new
                {
                    success = true,
                    html = htmlstring
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult PendingAction(int id)
        {
            try
            {
                var listItems = new List<SelectListItem>();
                MemoryCacheManager objCache = new MemoryCacheManager();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });

                var scienList = objCache.Get("cache.GetScientistId", () =>
                {
                    return db.GetScientistId().ToList();
                });

                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                });

                ViewBag.ScientistList = listItems;
                var model = (from i in db.SZ_Quotation
                             join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                             where (t2.MoveToDispatch == false || t2.MoveToDispatch == null) && t2.MoveToProject == true && i.CompanyId == id && t2.ProjectStatus == 0
                             orderby t2.MoveToProject descending
                             select t2).ToList();
                var htmlstring = PartialViewdata(this, "_PartialPendingAction", model);

                return Json(new
                {
                    success = true,
                    html = htmlstring
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult PurchaseAction(int id)
        {
            try
            {
                var model = (from i in db.SZ_Quotation
                             join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                             where (t2.MoveToDispatch == false || t2.MoveToDispatch == null) && t2.MoveToProject == true && i.CompanyId == id && t2.ProjectType == "3"
                             orderby t2.MoveToProject descending
                             select t2).ToList();

                var compData = db.SZ_CompanyList.ToList();
                var proids = model.Select(x => x.ProductId).ToList();
                var productdata = db.Products.Where(x => proids.Contains(x.Id) && x.Published == true && x.Deleted == false).ToList();
                var inventorydata = db.SZ_Inventory.Where(x => proids.Contains(x.ProductId)).ToList();

                var list = new List<SZ_QuotationModel>();
                foreach (var k in model)
                {
                    SZ_QuotationModel subList = new SZ_QuotationModel();
                    subList.QuoteId = k.QuoteId;
                    subList.IsImageAttach = k.SZ_Quotation.IsImageAttach;
                    subList.CompanyName = k.SZ_Quotation.SZ_CompanyList.Name;
                    subList.Email = k.SZ_Quotation.EmailAddress;
                    subList.PONumber = k.SZ_Quotation.PONo;
                    subList.Ref = k.SZ_Quotation.Ref;
                    subList.Remark = k.SZ_Quotation.Remark;
                    subList.MoveDispatchDate = k.MoveDispatchDate;
                    subList.SZ_QuotationProductModel = new List<SZ_QuotationProductModel>();

                    SZ_QuotationProductModel objlist = new SZ_QuotationProductModel();
                    objlist.QuoteDetailsId = k.Id;
                    objlist.CASNo = k.CASNo;
                    objlist.CATNo = k.CATNo;
                    objlist.CreatedDate = k.CreatedDate;
                    objlist.ImagePath = k.ImagePath;
                    objlist.IsUploadServer = k.IsUploadServer;
                    objlist.LeadTime = k.LeadTime;
                    objlist.Price = k.Price;
                    objlist.ProductId = k.ProductId;
                    objlist.ProductName = k.ProductName;
                    objlist.QuoteId = k.QuoteId;
                    objlist.ProjectType = k.ProjectType;
                    objlist.ScientistCustomerId = k.ScientistCustomerId;
                    objlist.RequiredQty = k.RequiredQty;
                    objlist.ProjectStatus = k.ProjectStatus;
                    objlist.ScientistStatus = k.ScientistStatus;
                    objlist.BatchCode1 = k.BatchCode1;
                    objlist.BatchCode2 = k.BatchCode2;
                    objlist.Qty1 = k.Qty1;
                    objlist.Qty2 = k.Qty2;
                    objlist.DispatchedStatus = k.DispatchedStatus;
                    objlist.BatchNo = k.BatchNo;
                    objlist.AdditionalBatchNo = k.AdditionalBatchNo;
                    objlist.MoveToDispatch = k.MoveToDispatch;
                    objlist.MoveToProject = k.MoveToProject;
                    objlist.SrPo = k.SrPo;
                    objlist.AdminScientistStatus = k.AdminScientistStatus;
                    objlist.InvoiceNo = k.InvoiceNo;
                    objlist.InvoiceRemark = k.InvoiceRemark;
                    objlist.Remark = k.Remark;
                    if (k.ProjectStatus != null)
                    {
                        objlist.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
                    }

                    if (objlist.ProductId.HasValue)
                    {
                        objlist.ListBatchNo = new List<SelectListItem>();
                        objlist.ListBatchNo.Add(new SelectListItem
                        {
                            Text = "--Select--",
                            Value = ""
                        });
                        var proData = productdata.Where(x => x.Id == objlist.ProductId && x.Published == true && x.Deleted == false).Count();
                        var proBatchData = inventorydata.Where(x => x.ProductId == objlist.ProductId).ToList();
                        if (proBatchData.Count > 0 && proData > 0)
                        {
                            foreach (var term in proBatchData)
                            {
                                string text = term.BatchNo + " (" + term.Qty + ")";
                                if (term.IsApproved == false)
                                {
                                    text = "*" + text;
                                }
                                objlist.ListBatchNo.Add(new SelectListItem
                                {
                                    Text = text,
                                    Value = term.Id.ToString(),
                                    Selected = objlist.AdditionalBatchNo == term.Id ? true : false
                                });
                            }
                        }
                    }

                    subList.SZ_QuotationProductModel.Add(objlist);

                    list.Add(subList);
                }

                var htmlstring = PartialViewdata(this, "_PartialInStockAction", list);

                return Json(new
                {
                    success = true,
                    html = htmlstring
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult DataApprovedProjectRecord(List<int> id)
        {
            try
            {
                foreach (var ids in id)
                {
                    var details = _operationRepository.GetQuoteDetailByID(ids);
                    if (details != null)
                    {
                        details.IsDataApproved = true;
                        details.DataApprovalDate = DateTime.Now;
                        db.Entry(details).State = EntityState.Modified;
                        db.SaveChanges();
                    }
                }
                return Json(new
                {
                    success = true,
                    message = "Data Approved successfully and moved into dispatch screen."
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = ex.Message
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult PrintProjectRecord(List<int> id, string pageName = null)
        {
            ViewBag.pageName = pageName;
            try
            {
                List<QuotationListModel> model = new List<QuotationListModel>();
                var maindetails = _operationRepository.GetQuoteDetailByID(id);
                if (maindetails != null)
                {
                    var listofAdditionalBatchNo = maindetails.Select(x => x.AdditionalBatchNo).Distinct().ToList();
                    var inventoryData = db.SZ_Inventory.Where(x => listofAdditionalBatchNo.Contains(x.Id)).ToList();
                    maindetails.ForEach(details =>
                    {
                        QuotationListModel objmodel = new QuotationListModel();
                        objmodel.QuoteDetailsId = details.Id;
                        objmodel.PONumber = details.SZ_Quotation.PONo;
                        objmodel.PODate = details.SZ_Quotation.PODate;
                        objmodel.SrPo = details.SrPo;
                        objmodel.ProductName = details.ProductName;
                        objmodel.RequiredQty = details.RequiredQty;
                        objmodel.BatchNo = details.BatchNo;
                        objmodel.CASNo = details.CASNo;
                        objmodel.CATNo = details.CATNo;
                        objmodel.CompanyName = details.SZ_Quotation.CompanyName;
                        objmodel.Courier = details.Courier;
                        objmodel.TrackingNo = details.TrackingNo;
                        objmodel.Location = details.Location;
                        objmodel.Explanation = details.Explanation;
                        objmodel.ExplainationSecond = details.ExplainationSecond;
                        objmodel.RefName = details.RefName;
                        objmodel.PurposeDispatch = details.PurposeDispatch;
                        objmodel.OrderRemark = details.OrderRemark;
                        if (details.EstimateCompleteDate.HasValue)
                        {
                            objmodel.EstimateCompleteDate = details.EstimateCompleteDate.Value.ToShortDateString();
                        }
                        objmodel.AdminScientistStatus = details.AdminScientistStatus;
                        if (details.AdditionalBatchNo.HasValue)
                        {
                            objmodel.BatchNo = inventoryData.Where(x => x.Id == details.AdditionalBatchNo).Select(x => x.BatchNo).FirstOrDefault();
                        }

                        if (objmodel.BatchNo == "undefined")
                        {
                            objmodel.BatchNo = "";
                        }
                        objmodel.LeadTime = details.LeadTime;
                        model.Add(objmodel);
                    });
                }

                //foreach (var ids in id)
                //{
                //    var details = _operationRepository.GetQuoteDetailByID(ids);
                //    if (details != null)
                //    {
                //        QuotationListModel objmodel = new QuotationListModel();
                //        objmodel.QuoteDetailsId = details.Id;
                //        objmodel.PONumber = details.SZ_Quotation.PONo;
                //        objmodel.PODate = details.SZ_Quotation.PODate;
                //        objmodel.SrPo = details.SrPo;
                //        objmodel.ProductName = details.ProductName;
                //        objmodel.RequiredQty = details.RequiredQty;
                //        objmodel.BatchNo = details.BatchNo;
                //        objmodel.CASNo = details.CASNo;
                //        objmodel.CATNo = details.CATNo;
                //        objmodel.CompanyName = details.SZ_Quotation.CompanyName;
                //        objmodel.Courier = details.Courier;
                //        objmodel.TrackingNo = details.TrackingNo;
                //        objmodel.Location = details.Location;
                //        objmodel.Explanation = details.Explanation;
                //        objmodel.ExplainationSecond = details.ExplainationSecond;
                //        objmodel.RefName = details.RefName;
                //        objmodel.PurposeDispatch = details.PurposeDispatch;
                //        objmodel.OrderRemark = details.OrderRemark;
                //        if (details.EstimateCompleteDate.HasValue)
                //        {
                //            objmodel.EstimateCompleteDate = details.EstimateCompleteDate.Value.ToShortDateString();
                //        }
                //        objmodel.AdminScientistStatus = details.AdminScientistStatus;
                //        if (details.AdditionalBatchNo.HasValue)
                //        {
                //            objmodel.BatchNo = db.SZ_Inventory.Where(x => x.Id == details.AdditionalBatchNo).Select(x => x.BatchNo).FirstOrDefault();
                //        }

                //        if (objmodel.BatchNo == "undefined")
                //        {
                //            objmodel.BatchNo = "";
                //        }
                //        objmodel.LeadTime = details.LeadTime;
                //        model.Add(objmodel);
                //    }
                //}

                var htmlstring = PartialViewdata(this, "_PartialPrintProjectRecord", model);

                return Json(new
                {
                    success = true,
                    html = htmlstring
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult GetDispatchedSummaryByBatchId(int batchId)
        {
            try
            {
                MemoryCacheManager objCache = new MemoryCacheManager();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });

                var scienList = objCache.Get("cache.GetScientistId", () =>
                {
                    return db.GetScientistId().ToList();
                });

                var listItems = new List<SelectListItem>();
                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                });

                var model = new List<DispatchSummaryModel>();
                var list = (from i in db.SZ_QuotationDetail
                            where i.AdditionalBatchNo == batchId
                            select i).OrderByDescending(x => x.MoveProjectDate).AsEnumerable();

                var batchNo = db.SZ_Inventory.Where(x => x.Id == batchId).Select(x => x.BatchNo).FirstOrDefault();
                var queryModuleData = db.SZ_QueryModule.Where(x => x.BatchNo == batchNo).ToList();
                if (list != null && list.Count() > 0)
                {
                    foreach (var item in list)
                    {
                        string teamLeaderName = string.Empty;
                        if (item.ScientistCustomerId.HasValue)
                        {
                            string tlname = Convert.ToString(item.ScientistCustomerId);
                            teamLeaderName = listItems.Where(x => x.Value == tlname).Select(x => x.Text).FirstOrDefault();
                        }
                        var submodel = new DispatchSummaryModel();
                        submodel.BatchNo = batchNo;
                        submodel.PONo = item.SZ_Quotation.PONo;
                        submodel.CompanyName = item.SZ_Quotation.CompanyName;
                        submodel.TeamLeader = teamLeaderName;
                        submodel.ProductName = item.ProductName;

                        foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
                        {
                            var items = Enum.GetName(typeof(EnumList.ProjectType), r);
                            var test = r.ToString();
                            string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
                            int val = (int)r;
                            if (Convert.ToString(val) == item.ProjectType)
                            {
                                submodel.ProjectStatus = text;
                            }
                        }

                        submodel.Qty = item.RequiredQty;
                        submodel.CASNo = item.CASNo;
                        submodel.CATNo = item.CATNo;
                        if (item.MoveDispatchDate.HasValue)
                        {
                            submodel.DispatchedDate = item.MoveDispatchDate.Value.ToShortDateString();
                        }
                        submodel.BatchRecord = batchNo;
                        submodel.QueryReceived = queryModuleData.Where(x => x.QuoteDetailsId == item.Id).Any() == true ? "Yes" : "No";
                        model.Add(submodel);
                    }
                }
                var htmlstring = PartialViewdata(this, "_PartialDispatchSummary", model);

                return Json(new
                {
                    success = true,
                    html = htmlstring,
                    message = "No Data Found"
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception)
            {
                return Json(new
                {
                    success = false,
                    message = "No Data Found"
                }, JsonRequestBehavior.AllowGet);
            }

        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult ProjectUpdateEmail(List<int> id)
        {
            List<QuotationListModel> model = new List<QuotationListModel>();
            foreach (var ids in id)
            {
                var details = _operationRepository.GetQuoteDetailByID(ids);
                if (details != null)
                {
                    QuotationListModel objmodel = new QuotationListModel();
                    objmodel.PONumber = details.SZ_Quotation.PONo;
                    objmodel.PODate = details.SZ_Quotation.PODate;
                    objmodel.SrPo = details.SrPo;
                    objmodel.ProductName = details.ProductName;
                    objmodel.RequiredQty = details.RequiredQty;
                    objmodel.BatchNo = details.BatchNo;
                    objmodel.CASNo = details.CASNo;
                    objmodel.CATNo = details.CATNo;
                    objmodel.CompanyName = details.SZ_Quotation.CompanyName;
                    objmodel.Courier = details.Courier;
                    objmodel.TrackingNo = details.TrackingNo;
                    objmodel.Location = details.Location;
                    objmodel.RefName = details.RefName;
                    objmodel.PurposeDispatch = details.PurposeDispatch;
                    if (details.EstimateCompleteDate.HasValue)
                    {
                        objmodel.EstimateCompleteDate = details.EstimateCompleteDate.Value.ToShortDateString();
                    }
                    objmodel.AdminScientistStatus = details.AdminScientistStatus;
                    if (details.AdditionalBatchNo.HasValue)
                    {
                        objmodel.BatchNo = db.SZ_Inventory.Where(x => x.Id == details.AdditionalBatchNo).Select(x => x.BatchNo).FirstOrDefault();
                    }
                    if (objmodel.BatchNo == "undefined")
                    {
                        objmodel.BatchNo = "";
                    }
                    objmodel.LeadTime = details.LeadTime;
                    objmodel.TermsId = details.SZ_Quotation.TermsId;
                    objmodel.ClientRef = details.SZ_Quotation.ClientRef;
                    objmodel.Ref = details.SZ_Quotation.Ref;
                    objmodel.CreatedDate = details.SZ_Quotation.CreatedDate;
                    objmodel.PODate = details.SZ_Quotation.PODate;
                    objmodel.CompanyName = details.SZ_Quotation.CompanyName;
                    objmodel.DisplayOrder = details.DisplayOrder;
                    objmodel.ImagePath = details.ImagePath;
                    objmodel.Remark = details.SZ_Quotation.Remark;
                    objmodel.IsImageAttach = details.SZ_Quotation.IsImageAttach;
                    objmodel.OrderRemark = details.OrderRemark;
                    objmodel.Price = details.Price;
                    objmodel.RequiredQty = details.RequiredQty;
                    objmodel.EstimateDispatchDate = details.EstimateDispatchDate;
                    objmodel.EmailAddress = details.SZ_Quotation.EmailAddress;
                    objmodel.EmailCC = details.SZ_Quotation.EmailCC;

                    // Update Quote Details History
                    details.LastProStatus = Convert.ToString(EnumList.ProStatusDDL.OrderConfirmation);
                    details.OtherProStatus = Convert.ToString(EnumList.ProStatusDDL.OrderConfirmation);
                    details.ProStatus = Convert.ToString(EnumList.ProStatusDDL.OrderConfirmation);
                    details.DispatchStatus = Convert.ToString(EnumList.ProStatusDDL.OrderConfirmation);
                    details.ReviewSciStatus = Convert.ToString(EnumList.ProStatusDDL.OrderConfirmation);
                    details.ExplainationSecond = "Thank you for your valuable order and we confirm the safe receipt of the same. We have initiated the process to synthesize this product and we will try to complete the synthesis as per the estimated completion date.";
                    db.Entry(details).State = EntityState.Modified;

                    model.Add(objmodel);
                }
                db.SaveChanges();
            }

            try
            {
                var htmlstring = PartialViewdata(this, "_PartialProjectUpdateEmail", model);
                //htmlstring = "<html><head></head><body style='font-family:Tahoma, Verdana, Segoe, sans-serif;font-size:11px;'>" + htmlstring + "</body></html>";
                // string path = printpdf(htmlstring, "PO No Order - " + model[0].PONumber.Replace(" ", "_").Replace("/", "_").Replace(@"\", "_") + " SynZeal Order Confirmation");
                MailMessage mail = new MailMessage();
                ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12 |
                                       SecurityProtocolType.Tls11 |
                                       SecurityProtocolType.Tls |
                                       SecurityProtocolType.Ssl3;
                SmtpClient SmtpServer = new SmtpClient(ConfigurationManager.AppSettings["Email.Host"]);
                mail.From = new MailAddress(ConfigurationManager.AppSettings["Email.Username"], "SynZeal Standards");

                var isDevelopment = ConfigurationManager.AppSettings["IsDevelopment"];
                if (isDevelopment.ToLower().Contains("true"))
                {
                    mail.To.Add(ConfigurationManager.AppSettings["DevEmailAddress"].ToString());
                }
                else
                {
                    mail.To.Add(model[0].EmailAddress);
                    if (!string.IsNullOrEmpty(model[0].EmailCC))
                    {
                        var cc = model[0].EmailCC.Split(';');
                        foreach (var c in cc)
                        {
                            if (!string.IsNullOrEmpty(c))
                            {
                                mail.CC.Add(c);
                            }
                        }
                    }
                    mail.CC.Add("standards@synzeal.com");
                    mail.CC.Add("projects@synzeal.com");
                    mail.ReplyToList.Add("standards@synzeal.com");
                    mail.ReplyToList.Add("projects@synzeal.com");
                    mail.Bcc.Add("noreply.synzeal@gmail.com");
                }
                //mail.Attachments.Add(new Attachment(path));
                mail.Subject = "SynZeal Research/" + model[0].CompanyName + " : PO No " + model[0].PONumber + " Update dated " + DateTime.Now.GetOrdinalDate();

                string html = System.IO.File.ReadAllText(Server.MapPath("~/Mail/OrderConfirmation.html"));
                html = html.Replace("#ponumber#", model[0].PONumber);
                mail.Body = htmlstring;
                mail.IsBodyHtml = true;
                SmtpServer.Port = Convert.ToInt32(ConfigurationManager.AppSettings["Port"]);
                SmtpServer.Credentials = new System.Net.NetworkCredential(ConfigurationManager.AppSettings["Email.Username"], ConfigurationManager.AppSettings["Email.Password"]);
                SmtpServer.EnableSsl = true;
                SmtpServer.Send(mail);
            }
            catch (Exception ex)
            {
                sendErrorMail(ex.LineNumber() + "Error Text : " + ex.Message + " / Stack Trace : " + ex.StackTrace);
            }

            return Json(new
            {
                success = true,
                message = ""
            }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult GenerateInvoice(List<int> id)
        {
            try
            {
                int companyId = 0;
                ViewBag.CompanyId = 0;
                ViewBag.CompanyName = "";
                ViewBag.Ids = id;
                ViewBag.PONo = "";
                ViewBag.PODate = "";
                ViewBag.Email = "";
                string ponumbers = "";
                List<QuotationListModel> model = new List<QuotationListModel>();
                foreach (var ids in id)
                {
                    var details = _operationRepository.GetQuoteDetailByID(ids);
                    if (details != null)
                    {
                        ViewBag.QuoteId = details.SZ_Quotation.Id;
                        ViewBag.Email = details.SZ_Quotation.EmailAddress;
                        if (!ponumbers.Contains(details.SZ_Quotation.PONo))
                        {
                            ponumbers += details.SZ_Quotation.PONo + ", ";
                        }
                        ViewBag.PODate = details.SZ_Quotation.PODate.Value.ToShortDateString();
                        ViewBag.CompanyId = details.SZ_Quotation.CompanyId;
                        ViewBag.CompanyName = details.SZ_Quotation.CompanyName;
                        ViewBag.PaymentTerms = details.SZ_Quotation.PaymentTerm;
                        ViewBag.IsShippedCharge = details.SZ_Quotation.IsShippedCharge;
                        ViewBag.TrackingNo = details.TrackingNo;
                        if (details.SZ_Quotation.CompanyId.HasValue)
                        {
                            companyId = details.SZ_Quotation.CompanyId.Value;
                        }
                        QuotationListModel objmodel = new QuotationListModel();
                        objmodel.QuoteDetailsId = details.Id;
                        objmodel.Price = details.Price;
                        objmodel.PONumber = details.SZ_Quotation.PONo;
                        objmodel.PODate = details.SZ_Quotation.PODate;
                        objmodel.SrPo = details.SrPo;
                        objmodel.ProductName = details.ProductName;
                        objmodel.RequiredQty = details.RequiredQty;
                        objmodel.BatchNo = details.BatchNo;
                        objmodel.CASNo = details.CASNo;
                        objmodel.CATNo = details.CATNo;
                        objmodel.CompanyName = details.SZ_Quotation.CompanyName;
                        objmodel.Courier = details.Courier;
                        objmodel.TrackingNo = details.TrackingNo;
                        objmodel.Location = details.Location;
                        objmodel.RefName = details.RefName;
                        objmodel.PurposeDispatch = details.PurposeDispatch;
                        if (details.EstimateDispatchDate.HasValue)
                        {
                            objmodel.EstimateDispatchDateStr = details.EstimateDispatchDate.Value.ToShortDateString();
                        }
                        objmodel.AdminScientistStatus = details.AdminScientistStatus;
                        if (details.AdditionalBatchNo.HasValue)
                        {
                            objmodel.BatchNo = db.SZ_Inventory.Where(x => x.Id == details.AdditionalBatchNo).Select(x => x.BatchNo).FirstOrDefault();
                        }

                        if (objmodel.BatchNo == "undefined")
                        {
                            objmodel.BatchNo = "";
                        }

                        objmodel.LeadTime = details.LeadTime;
                        objmodel.FinalPrice = details.FinalPrice;

                        var coadata = db.SZ_ChildCOA.Where(x => x.Id == details.COAId).FirstOrDefault();
                        if (coadata != null)
                        {
                            if (coadata.ReTestDate.HasValue)
                            {
                                objmodel.ReTestDateStr = coadata.ReTestDate.Value.ToShortDateString();
                            }
                            if (coadata.AnalysisDate.HasValue)
                            {
                                objmodel.AnalysisDateStr = coadata.AnalysisDate.Value.ToShortDateString();
                            }
                        }

                        model.Add(objmodel);
                    }
                }
                ViewBag.PONo = ponumbers;
                var listPaymentTermsItems = new List<SelectListItem>();
                listPaymentTermsItems.Add(new SelectListItem
                {
                    Text = "--Select--",
                    Value = ""
                });
                var paymentTermData = db.PaymentTerms.OrderBy(x => x.Id).ToList();
                foreach (var term in paymentTermData)
                {
                    listPaymentTermsItems.Add(new SelectListItem
                    {
                        Text = term.Name,
                        Value = term.Name.ToString()
                    });
                }

                ViewBag.listPaymentTermsItems = listPaymentTermsItems;

                var listCountryItems = new List<SelectListItem>();
                listCountryItems.Add(new SelectListItem
                {
                    Text = "--Select--",
                    Value = ""
                });
                var countries = db.Countries.OrderBy(x => x.name).ToList();
                foreach (var term in countries)
                {
                    listCountryItems.Add(new SelectListItem
                    {
                        Text = term.name,
                        Value = term.name
                    });
                }

                ViewBag.CountryList = listCountryItems;


                var companyData = db.SZ_CompanyList.Where(x => x.Id == companyId).FirstOrDefault();
                if (companyData != null)
                {
                    ViewBag.Company = companyData;
                }

                var htmlstring = PartialViewdata(this, "_PartialGenerateInvoice", model);

                return Json(new
                {
                    success = true,
                    html = htmlstring
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }


        [HttpPost]
        [ValidateInput(false)]
        public ActionResult OrderConfirmationEmail(List<int> id)
        {
            try
            {
                var cId = 0;
                string paymentterms = "";
                ViewBag.Ids = id;
                List<QuotationListModel> model = new List<QuotationListModel>();
                foreach (var ids in id)
                {
                    var details = _operationRepository.GetQuoteDetailByID(ids);
                    if (details != null)
                    {
                        cId = details.SZ_Quotation.CompanyId.HasValue ?
                                details.SZ_Quotation.CompanyId.Value : 0;
                        ViewBag.QuoteEmailAddress = details.SZ_Quotation.EmailCC;
                        paymentterms = details.SZ_Quotation.PaymentTerm;
                        ViewBag.PaymentTerms = details.SZ_Quotation.PaymentTerm;
                        ViewBag.IsShippedCharge = details.SZ_Quotation.IsShippedCharge;
                        ViewBag.EmailAddress = details.SZ_Quotation.EmailAddress;
                        ViewBag.CountryType = details.SZ_Quotation.CountryType;
                        QuotationListModel objmodel = new QuotationListModel();
                        objmodel.QuoteDetailsId = details.Id;
                        objmodel.Price = details.Price;
                        objmodel.PONumber = details.SZ_Quotation.PONo;
                        objmodel.PODate = details.SZ_Quotation.PODate;
                        objmodel.SrPo = details.SrPo;
                        objmodel.ProductName = details.ProductName;
                        objmodel.RequiredQty = details.RequiredQty;
                        objmodel.BatchNo = details.BatchNo;
                        objmodel.CASNo = details.CASNo;
                        objmodel.CATNo = details.CATNo;
                        objmodel.CompanyName = details.SZ_Quotation.CompanyName;
                        objmodel.Courier = details.Courier;
                        objmodel.TrackingNo = details.TrackingNo;
                        objmodel.Location = details.Location;
                        objmodel.RefName = details.RefName;
                        objmodel.PurposeDispatch = details.PurposeDispatch;
                        objmodel.TracebilityCost = details.TracebilityCost;
                        objmodel.ColdShipCost = details.ColdShipCost;
                        objmodel.AddTestCost = details.AddTestCost;
                        objmodel.ItemDiscount = details.ItemDiscount;
                        if (details.EstimateDispatchDate.HasValue)
                        {
                            objmodel.EstimateDispatchDateStr = details.EstimateDispatchDate.Value.ToShortDateString();
                        }
                        objmodel.AdminScientistStatus = details.AdminScientistStatus;
                        if (details.AdditionalBatchNo.HasValue)
                        {
                            objmodel.BatchNo = db.SZ_Inventory.Where(x => x.Id == details.AdditionalBatchNo).Select(x => x.BatchNo).FirstOrDefault();
                        }
                        if (objmodel.BatchNo == "undefined")
                        {
                            objmodel.BatchNo = "";
                        }
                        objmodel.LeadTime = details.LeadTime;
                        objmodel.FinalPrice = details.FinalPrice;
                        objmodel.OrderRemark = details.OrderRemark;
                        objmodel.TechnicalEmail = details.TechnicalEmail;
                        model.Add(objmodel);
                    }
                }

                var listPaymentTermsItems = new List<SelectListItem>();
                listPaymentTermsItems.Add(new SelectListItem
                {
                    Text = "--Select--",
                    Value = ""
                });
                var paymentTermData = db.PaymentTerms.OrderBy(x => x.Id).ToList();
                foreach (var term in paymentTermData)
                {
                    listPaymentTermsItems.Add(new SelectListItem
                    {
                        Selected = paymentterms == term.Name ? true : false,
                        Text = term.Name,
                        Value = term.Name.ToString()
                    });
                }

                ViewBag.listPaymentTermsItems = listPaymentTermsItems;

                var listCompItems = new List<SelectListItem>();
                var compData = db.SZ_CompanyList.OrderBy(x => x.Name.Trim()).AsEnumerable();
                foreach (var term in compData)
                {
                    listCompItems.Add(new SelectListItem
                    {
                        Text = term.Name,
                        Value = term.Id.ToString(),
                        Selected = term.Id == cId ? true : false
                    });
                }

                ViewBag.listCompItems = listCompItems;
                var htmlstring = PartialViewdata(this, "_PartialOrderConfirmationEmail", model);
                return Json(new
                {
                    success = true,
                    html = htmlstring
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    error = ex.Message + " / " + ex.StackTrace
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [ValidateInput(false)]
        public ActionResult ProjectReportPOPUP()
        {
            try
            {
                var htmlstring = PartialViewdata(this, "_PartialProjectReportPOPUP", null);

                return Json(new
                {
                    success = true,
                    html = htmlstring
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult SendEmailOrderConfirmationAction(List<QuotationListModel> id, string toEmail, string cctoEmail, string discount, int CompanyId, bool isDownload = false, string paymentTerms = null, bool IsShippedCharge = false)
        {
            ViewBag.IsShippedCharge = IsShippedCharge;
            try
            {
                var companyData = db.SZ_CompanyList.Where(x => x.Id == CompanyId).FirstOrDefault();
                var qdids = id.Select(x => x.QuoteDetailsId).ToList();
                var quotationdetailsdatas = db.SZ_QuotationDetail.Where(x => qdids.Contains(x.Id)).ToList();
                List<QuotationListModel> model = new List<QuotationListModel>();
                foreach (var ids in id)
                {
                    var oldModel = quotationdetailsdatas.Where(x => x.Id == ids.QuoteDetailsId).FirstOrDefault();
                    var details = quotationdetailsdatas.Where(x => x.Id == ids.QuoteDetailsId).FirstOrDefault();
                    if (details != null)
                    {
                        //decimal discounts = string.IsNullOrEmpty(discount) ? 0 : Convert.ToDecimal(discount);
                        //if (discounts > 0)
                        //{
                        //    details.Discount = Convert.ToInt32(discounts);
                        //    details.ItemDiscount = discounts;
                        //}

                        decimal discounts = ids.ItemDiscount.HasValue ? ids.ItemDiscount.Value : 0;
                        details.Discount = Convert.ToInt32(discounts);
                        details.ItemDiscount = discounts;
                        details.FinalPrice = ids.FinalPrice;
                        details.LeadTime = ids.LeadTime;
                        details.OrderRemark = ids.OrderRemark;
                        if (string.IsNullOrEmpty(details.ProStatus))
                        {
                            details.ProStatus = Convert.ToString((int)EnumList.ProStatusDDL.OrderConfirmation);
                            details.OtherProStatus = Convert.ToString((int)EnumList.ProStatusDDL.OrderConfirmation);
                            details.DispatchStatus = Convert.ToString((int)EnumList.ProStatusDDL.OrderConfirmation);
                            details.ReviewSciStatus = Convert.ToString((int)EnumList.ProStatusDDL.OrderConfirmation);
                            details.ExplainationSecond = "Thank you for your valuable order and we confirm the safe receipt of the same. We have initiated the process to synthesize this product and we will try to complete the synthesis as per the estimated completion date.";
                        }
                        db.Entry(details).State = EntityState.Modified;
                        db.SaveChanges();
                        var newmodel = details;
                        PrepareQuoteDetailsLog(newmodel, oldModel);

                        var quotation = _operationRepository.GetQuoteByID(details.QuoteId);
                        if (quotation != null)
                        {
                            var oldmodelquote = LogManagement.PrepareQuoteEntity(quotation);
                            quotation.IsShippedCharge = IsShippedCharge;
                            quotation.PaymentTerm = paymentTerms;
                            if (companyData != null)
                            {
                                quotation.CompanyId = companyData.Id;
                                quotation.CompanyName = companyData.Name;
                                if (companyData.PaymentTerms != paymentTerms)
                                {
                                    companyData.PaymentTerms = paymentTerms;
                                    db.Entry(companyData).State = EntityState.Modified;
                                }
                            }
                            db.Entry(quotation).State = EntityState.Modified;
                            db.SaveChanges();
                            //LogManagement.AddQuoteLog(quotation, oldmodelquote);
                        }
                        QuotationListModel objmodel = new QuotationListModel();
                        objmodel.POUrl = details.SZ_Quotation.POUrl;
                        objmodel.PONumber = details.SZ_Quotation.PONo;
                        objmodel.PODate = details.SZ_Quotation.PODate;
                        objmodel.SrPo = details.SrPo;
                        objmodel.ProductName = details.ProductName;
                        objmodel.RequiredQty = details.RequiredQty;
                        objmodel.BatchNo = details.BatchNo;
                        objmodel.CASNo = details.CASNo;
                        objmodel.CATNo = details.CATNo;
                        objmodel.CompanyName = details.SZ_Quotation.CompanyName;
                        if (companyData != null)
                        {
                            objmodel.CompanyName = companyData.Name;
                        }
                        objmodel.Courier = details.Courier;
                        objmodel.TrackingNo = details.TrackingNo;
                        objmodel.Location = details.Location;
                        objmodel.RefName = details.RefName;
                        objmodel.PurposeDispatch = details.PurposeDispatch;
                        objmodel.DataRemark = details.Remark;
                        if (details.EstimateCompleteDate.HasValue)
                        {
                            objmodel.EstimateCompleteDate = details.EstimateCompleteDate.Value.ToShortDateString();
                        }
                        objmodel.AdminScientistStatus = details.AdminScientistStatus;
                        if (details.AdditionalBatchNo.HasValue)
                        {
                            objmodel.BatchNo = db.SZ_Inventory.Where(x => x.Id == details.AdditionalBatchNo).Select(x => x.BatchNo).FirstOrDefault();
                        }
                        if (objmodel.BatchNo == "undefined")
                        {
                            objmodel.BatchNo = "";
                        }
                        objmodel.Currency = details.SZ_Quotation.Currency;
                        objmodel.LeadTime = details.LeadTime;
                        objmodel.TermsId = details.SZ_Quotation.TermsId;
                        objmodel.ClientRef = details.SZ_Quotation.ClientRef;
                        objmodel.Ref = details.SZ_Quotation.Ref;
                        objmodel.CreatedDate = details.SZ_Quotation.CreatedDate;
                        objmodel.PODate = details.SZ_Quotation.PODate;
                        objmodel.DisplayOrder = details.DisplayOrder;
                        objmodel.ImagePath = details.ImagePath;
                        objmodel.Remark = details.SZ_Quotation.Remark;
                        objmodel.IsImageAttach = details.SZ_Quotation.IsImageAttach;
                        objmodel.OrderRemark = details.OrderRemark;
                        objmodel.Price = details.Price;
                        objmodel.RequiredQty = details.RequiredQty;
                        objmodel.EstimateDispatchDate = details.EstimateDispatchDate;
                        objmodel.FinalPrice = details.FinalPrice;
                        objmodel.AddTestCost = details.AddTestCost;
                        objmodel.ColdShipCost = details.ColdShipCost;
                        objmodel.TracebilityCost = details.TracebilityCost;
                        objmodel.TechnicalEmail = details.TechnicalEmail;
                        objmodel.TracebilityCostRemark = details.TracebilityCostRemark;
                        objmodel.ColdShipCostRemark = details.ColdShipCostRemark;
                        objmodel.AddTestCostRemark = details.AddTestCostRemark;
                        objmodel.IsRFQ = details.SZ_Quotation.IsRFQ;
                        objmodel.EmailAddress = details.SZ_Quotation.EmailAddress;
                        model.Add(objmodel);

                        var emailsuggestions = db.SZ_EmailSuggestion.Where(x => x.CompanyID == details.SZ_Quotation.CompanyId).FirstOrDefault();
                        if (emailsuggestions != null)
                        {
                            //Update records
                            string toRecord = string.Empty;
                            string ccRecord = string.Empty;
                            if (!string.IsNullOrEmpty(toEmail))
                            {
                                string[] emails = toEmail.Split(';');
                                foreach (var i in emails)
                                {
                                    if (!string.IsNullOrEmpty(i) && !emailsuggestions.ToAddress.Contains(i))
                                    {
                                        toRecord += i + ";";
                                    }
                                }
                            }
                            if (!string.IsNullOrEmpty(cctoEmail))
                            {
                                string[] emails = cctoEmail.Split(';');
                                foreach (var i in emails)
                                {
                                    if (!string.IsNullOrEmpty(i) && !emailsuggestions.CCAddress.Contains(i))
                                    {
                                        ccRecord += i + ";";
                                    }
                                }
                            }

                            if (!string.IsNullOrEmpty(ccRecord))
                            {
                                emailsuggestions.CCAddress += ";" + ccRecord;
                            }
                            if (!string.IsNullOrEmpty(toRecord))
                            {
                                emailsuggestions.ToAddress += ";" + toEmail;
                            }
                            db.Entry(emailsuggestions).State = EntityState.Modified;
                            db.SaveChanges();
                        }
                        else
                        {
                            //Insert Records
                            emailsuggestions = new SZ_EmailSuggestion();
                            emailsuggestions.CompanyID = details.SZ_Quotation.CompanyId.HasValue ? details.SZ_Quotation.CompanyId.Value : 0;
                            emailsuggestions.CreatedDate = DateTime.Now;
                            emailsuggestions.CCAddress = cctoEmail;
                            emailsuggestions.ToAddress = toEmail;
                            db.SZ_EmailSuggestion.Add(emailsuggestions);
                            db.SaveChanges();
                        }
                    }
                }

                try
                {
                    var htmlstring = PartialViewdata(this, "_PartialOrderConfirmationPDF", model);
                    //htmlstring = "<html><head></head><body style='font-family:Tahoma, Verdana, Segoe, sans-serif;font-size:11px;'>" + htmlstring + "</body></html>";
                    string path = printpdf(htmlstring, "PO_No_Order-" + model[0].PONumber.Replace(":", "_").Replace("#", "_").Replace(" ", "_").Replace("/", "_").Replace(@"\", "_") + "-" + DateTime.Now.ToString().Replace(":", "_").Replace("#", "_").Replace(" ", "_").Replace("/", "_").Replace(@"\", "_") + "_SynZeal_Order_Confirmation", isDownload);
                    if (isDownload)
                    {
                        return Json(new
                        {
                            success = true,
                            message = path.Replace(" ", "_")
                        }, JsonRequestBehavior.AllowGet);
                    }

                    var conversionNumber = "";

                    bool IsConversation = false;
                    foreach (var item in model[0].POUrl.Split('/'))
                    {
                        if (IsConversation)
                        {
                            conversionNumber = item;
                            IsConversation = false;
                        }
                        if (item == "conversations")
                        {
                            IsConversation = true;
                        }
                    }

                    ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12 |
                                       SecurityProtocolType.Tls11 |
                                       SecurityProtocolType.Tls |
                                       SecurityProtocolType.Ssl3;

                    ConversationMessageModel.Root ConversationModel = new ConversationMessageModel.Root();

                    MyWebClient obj = new MyWebClient();

                    using (WebClient webClient = new WebClient())
                    {


                        webClient.BaseAddress = missiveBaseAddress;

                        webClient.Headers.Add("Authorization", missiveAuthorization);
                        webClient.Headers.Add("HOST", missiveHost);
                        webClient.Headers.Add("contact_book", missiveContractBook);

                        var json = webClient.DownloadString("v1/conversations/" + conversionNumber + "/messages");
                        ConversationModel = JsonConvert.DeserializeObject<ConversationMessageModel.Root>(json);

                    }

                    using (WebClient webClient = new WebClient())
                    {
                        var missiveMessage = ConversationModel.messages.OrderBy(x => x.created_at).FirstOrDefault();
                        var lastmissiveMessage = ConversationModel.messages.OrderByDescending(x => x.created_at).FirstOrDefault();
                        webClient.BaseAddress = missiveBaseAddress;
                        webClient.Headers.Add("Authorization", missiveAuthorization);
                        webClient.Headers.Add("HOST", missiveHost);
                        webClient.Headers.Add("contact_book", missiveContractBook);

                        var url = "v1/drafts";
                        webClient.Headers.Add("user-agent", "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.2; .NET CLR 1.0.3705;)");
                        webClient.Headers[HttpRequestHeader.ContentType] = "application/json";

                        ConversationMessageModel.RootDraft draftmodel = new ConversationMessageModel.RootDraft();
                        var objdraftmodel = new ConversationMessageModel.Draft();
                        objdraftmodel.conversation = conversionNumber;
                        //objdraftmodel.send = true;
                        objdraftmodel.send = false;
                        objdraftmodel.references = lastmissiveMessage.references;
                        objdraftmodel.references.Insert(0, lastmissiveMessage.email_message_id);
                        objdraftmodel.quote_previous_message = true;
                        if (Request.Url.AbsoluteUri.Contains("localhost"))
                        {
                            objdraftmodel.subject = "Test Purpose : SynZeal Research Order Confirmation : PO No " + model[0].PONumber + " /SZ Quote ID: " + model[0].Ref;
                        }
                        else
                        {
                            objdraftmodel.subject = "SynZeal Research Order Confirmation : PO No " + model[0].PONumber + " /SZ Quote ID: " + model[0].Ref;
                        }
                        objdraftmodel.from_field = new ConversationMessageModel.FromField()
                        {
                            address = "standards@synzeal.com"
                        };
                        //objdraftmodel.to_fields = ConversationModel.messages[0].to_fields;
                        objdraftmodel.to_fields = new List<ConversationMessageModel.ToField>();
                        objdraftmodel.cc_fields = new List<ConversationMessageModel.CcField>();
                        objdraftmodel.message_id = lastmissiveMessage.id;

                        string tousername = string.Empty;

                        if (!string.IsNullOrEmpty(toEmail))
                        {
                            string[] emails = toEmail.Split(';');
                            foreach (var i in emails)
                            {
                                if (!string.IsNullOrEmpty(i))
                                {
                                    var ccfieldemail = new ConversationMessageModel.ToField()
                                    {
                                        name = i.Split('@')[0],
                                        address = i
                                    };
                                    objdraftmodel.to_fields.Add(ccfieldemail);
                                }
                            }
                        }
                        if (!string.IsNullOrEmpty(cctoEmail))
                        {
                            string[] emails = cctoEmail.Split(';');
                            foreach (var i in emails)
                            {
                                if (!string.IsNullOrEmpty(i))
                                {
                                    var ccfieldemail = new ConversationMessageModel.CcField()
                                    {
                                        name = i.Split('@')[0],
                                        address = i
                                    };
                                    objdraftmodel.cc_fields.Add(ccfieldemail);
                                }
                            }
                        }
                        if (missiveMessage.from_field != null && !missiveMessage.from_field.address.Contains("@synzeal"))
                        {
                            var tofieldemail = new ConversationMessageModel.ToField()
                            {
                                name = missiveMessage.from_field.name,
                                address = missiveMessage.from_field.address
                            };

                            objdraftmodel.to_fields.Add(tofieldemail);
                        }

                        if (model[0].IsRFQ.HasValue && model[0].IsRFQ.Value)
                        {
                            if (!string.IsNullOrEmpty(model[0].EmailAddress))
                            {
                                tousername = model[0].EmailAddress.Split('@')[0];
                            }

                            if (!objdraftmodel.to_fields.Select(x => x.address).Contains(model[0].EmailAddress))
                            {
                                var tofieldemail = new ConversationMessageModel.ToField()
                                {
                                    name = tousername,
                                    address = model[0].EmailAddress
                                };
                                objdraftmodel.to_fields.Add(tofieldemail);
                            }
                        }
                        else
                        {
                            if (missiveMessage.to_fields != null && missiveMessage.to_fields.Count > 0)
                            {
                                foreach (var tofield in missiveMessage.to_fields)
                                {
                                    if (!tofield.address.Contains("@synzeal"))
                                    {
                                        if (!objdraftmodel.to_fields.Select(x => x.address).Contains(tofield.address))
                                        {
                                            if (string.IsNullOrEmpty(tousername))
                                            {
                                                tousername = tofield.name;
                                            }
                                            var tofieldemail = new ConversationMessageModel.ToField()
                                            {
                                                name = tofield.name,
                                                address = tofield.address
                                            };
                                            objdraftmodel.to_fields.Add(tofieldemail);
                                        }
                                    }
                                }
                            }

                            if (objdraftmodel.to_fields != null && objdraftmodel.to_fields.Count > 0)
                            {
                                if (missiveMessage.cc_fields != null && missiveMessage.cc_fields.Count > 0)
                                {
                                    foreach (var ccfield in missiveMessage.cc_fields)
                                    {
                                        if (!ccfield.address.Contains("@synzeal"))
                                        {
                                            if (!objdraftmodel.cc_fields.Select(x => x.address).Contains(ccfield.address))
                                            {
                                                var ccfieldemail = new ConversationMessageModel.CcField()
                                                {
                                                    name = ccfield.name,
                                                    address = ccfield.address
                                                };
                                                objdraftmodel.cc_fields.Add(ccfieldemail);
                                            }
                                        }
                                    }
                                }
                            }
                            else
                            {
                                if (missiveMessage.cc_fields != null && missiveMessage.cc_fields.Count > 0)
                                {
                                    foreach (var ccfield in missiveMessage.cc_fields)
                                    {
                                        if (!ccfield.address.Contains("@synzeal"))
                                        {
                                            if (!objdraftmodel.to_fields.Select(x => x.address).Contains(ccfield.address))
                                            {
                                                var ccfieldemail = new ConversationMessageModel.ToField()
                                                {
                                                    name = ccfield.name,
                                                    address = ccfield.address
                                                };
                                                objdraftmodel.to_fields.Add(ccfieldemail);
                                            }
                                        }
                                    }
                                }
                            }
                        }

                        objdraftmodel.bcc_fields = new List<object>();
                        objdraftmodel.attachments = new List<ConversationMessageModel.AttachmentDataModel>();
                        objdraftmodel.body = "";

                        string format = "Mddyyyyhhmmss";
                        string date = DateTime.Now.ToString(format);

                        byte[] bytes = System.IO.File.ReadAllBytes(path);

                        var Base64Result = Convert.ToBase64String(bytes);
                        var pdffilename = Path.GetFileName(path);

                        var quoteattachment = new ConversationMessageModel.AttachmentDataModel();
                        quoteattachment.filename = "PO_No_Order-" + model[0].PONumber.Replace(":", "_").Replace("#", "_").Replace(" ", "_").Replace("/", "_").Replace(@"\", "_") + "-" + DateTime.Now.ToString().Replace(":", "_").Replace("#", "_").Replace(" ", "_").Replace("/", "_").Replace(@"\", "_") + "_SynZeal_Order_Confirmation.pdf";
                        quoteattachment.base64_data = Base64Result;
                        objdraftmodel.attachments.Add(quoteattachment);

                        draftmodel.drafts = objdraftmodel;
                        string data = JsonConvert.SerializeObject(draftmodel);
                        var response = webClient.UploadString(url, data);
                        var resultddds = JsonConvert.DeserializeObject<ConversationMessageModel.RootDraft>(response);

                    }


                    //TODO: Project email find
                    //MailMessage mail = new MailMessage();
                    //ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12 |
                    //                   SecurityProtocolType.Tls11 |
                    //                   SecurityProtocolType.Tls |
                    //                   SecurityProtocolType.Ssl3;
                    //SmtpClient SmtpServer = new SmtpClient(ConfigurationManager.AppSettings["Email.Host"]);
                    //mail.From = new MailAddress(ConfigurationManager.AppSettings["Email.Username"], "SynZeal Standards");

                    //var isDevelopment = ConfigurationManager.AppSettings["IsDevelopment"];
                    //if (isDevelopment.ToLower().Contains("true"))
                    //{
                    //    mail.To.Add(ConfigurationManager.AppSettings["DevEmailAddress"].ToString());
                    //}
                    //else
                    //{
                    //    if (!string.IsNullOrEmpty(toEmail))
                    //    {
                    //        string[] emails = toEmail.Split(';');
                    //        foreach (var i in emails)
                    //        {
                    //            if (!string.IsNullOrEmpty(i))
                    //            {
                    //                mail.To.Add(i);
                    //            }
                    //        }
                    //    }
                    //    if (!string.IsNullOrEmpty(cctoEmail))
                    //    {
                    //        string[] emails = cctoEmail.Split(';');
                    //        foreach (var i in emails)
                    //        {
                    //            if (!string.IsNullOrEmpty(i))
                    //            {
                    //                mail.CC.Add(i);
                    //            }
                    //        }
                    //    }
                    //    else
                    //    {
                    //        mail.To.Add("standards@synzeal.com");
                    //    }
                    //    mail.ReplyToList.Add("standards@synzeal.com");
                    //}
                    //mail.Attachments.Add(new Attachment(path));
                    //mail.Subject = "SynZeal Research Order Confirmation : PO No " + model[0].PONumber + " /SZ Quote ID: " + model[0].Ref;

                    //string html = System.IO.File.ReadAllText(Server.MapPath("~/Mail/OrderConfirmation.html"));
                    //html = html.Replace("#ponumber#", model[0].PONumber);
                    //mail.Body = html;
                    //mail.IsBodyHtml = true;
                    //SmtpServer.Port = Convert.ToInt32(ConfigurationManager.AppSettings["Port"]);
                    //SmtpServer.Credentials = new System.Net.NetworkCredential(ConfigurationManager.AppSettings["Email.Username"], ConfigurationManager.AppSettings["Email.Password"]);
                    //SmtpServer.EnableSsl = true;
                    //SmtpServer.Send(mail);
                }
                catch (Exception ex)
                {
                    sendErrorMail(ex.LineNumber() + " " + "Error Text : " + ex.Message + " / Stack Trace : " + ex.StackTrace);
                    return Json(new
                    {
                        success = false,
                        message = "Error Text : " + ex.Message + " / Stack Trace : " + ex.StackTrace
                    }, JsonRequestBehavior.AllowGet);
                }
                return Json(new
                {
                    success = true,
                    html = ""
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = ex.LineNumber() + " " + "Error Text : " + ex.Message
                }, JsonRequestBehavior.AllowGet);
            }
        }


        [HttpPost]
        [ValidateInput(false)]
        public ActionResult SendEmailForProjectUpdates(List<int> id)
        {
            try
            {
                List<QuotationListModel> model = new List<QuotationListModel>();
                foreach (var ids in id)
                {
                    var details = _operationRepository.GetQuoteDetailByID(ids);
                    if (details != null)
                    {
                        QuotationListModel objmodel = new QuotationListModel();
                        objmodel.QuoteDetailsId = details.Id;
                        objmodel.PONumber = details.SZ_Quotation.PONo;
                        objmodel.PODate = details.SZ_Quotation.PODate;
                        objmodel.SrPo = details.SrPo;
                        objmodel.ProductName = details.ProductName;
                        objmodel.RequiredQty = details.RequiredQty;
                        objmodel.BatchNo = details.BatchNo;
                        objmodel.CASNo = details.CASNo;
                        objmodel.CATNo = details.CATNo;
                        objmodel.CompanyName = details.SZ_Quotation.CompanyName;
                        objmodel.Courier = details.Courier;
                        objmodel.TrackingNo = details.TrackingNo;
                        objmodel.Location = details.Location;
                        objmodel.Explanation = details.Explanation;
                        objmodel.ExplainationSecond = details.ExplainationSecond;
                        objmodel.RefName = details.RefName;
                        objmodel.PurposeDispatch = details.PurposeDispatch;
                        objmodel.OrderRemark = details.OrderRemark;
                        if (details.EstimateCompleteDate.HasValue)
                        {
                            objmodel.EstimateCompleteDate = details.EstimateCompleteDate.Value.ToShortDateString();
                        }
                        objmodel.AdminScientistStatus = details.AdminScientistStatus;
                        if (details.AdditionalBatchNo.HasValue)
                        {
                            objmodel.BatchNo = db.SZ_Inventory.Where(x => x.Id == details.AdditionalBatchNo).Select(x => x.BatchNo).FirstOrDefault();
                        }

                        if (objmodel.BatchNo == "undefined")
                        {
                            objmodel.BatchNo = "";
                        }
                        objmodel.LeadTime = details.LeadTime;
                        objmodel.POUrl = details.SZ_Quotation.POUrl;
                        model.Add(objmodel);
                    }
                }
                try
                {
                    //model

                    var conversionNumber = "";
                    bool IsConversation = false;

                    if (string.IsNullOrEmpty(model[0].POUrl))
                    {
                        return Json(new
                        {
                            success = false,
                            message = "Please enter PO Url"
                        }, JsonRequestBehavior.AllowGet);
                    }

                    foreach (var item in model[0].POUrl.Split('/'))
                    {
                        if (IsConversation)
                        {
                            conversionNumber = item;
                            IsConversation = false;
                        }
                        if (item == "conversations")
                        {
                            IsConversation = true;
                        }
                    }

                    ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12 |
                                       SecurityProtocolType.Tls11 |
                                       SecurityProtocolType.Tls |
                                       SecurityProtocolType.Ssl3;

                    ConversationMessageModel.Root ConversationModel = new ConversationMessageModel.Root();

                    MyWebClient obj = new MyWebClient();

                    using (WebClient webClient = new WebClient())
                    {


                        webClient.BaseAddress = missiveBaseAddress;

                        webClient.Headers.Add("Authorization", missiveAuthorization);
                        webClient.Headers.Add("HOST", missiveHost);
                        webClient.Headers.Add("contact_book", missiveContractBook);

                        var json = webClient.DownloadString("v1/conversations/" + conversionNumber + "/messages");
                        ConversationModel = JsonConvert.DeserializeObject<ConversationMessageModel.Root>(json);

                    }

                    using (WebClient webClient = new WebClient())
                    {
                        var missiveMessage = ConversationModel.messages.OrderBy(x => x.created_at).FirstOrDefault();
                        var lastmissiveMessage = ConversationModel.messages.OrderByDescending(x => x.created_at).FirstOrDefault();
                        webClient.BaseAddress = missiveBaseAddress;
                        webClient.Headers.Add("Authorization", missiveAuthorization);
                        webClient.Headers.Add("HOST", missiveHost);
                        webClient.Headers.Add("contact_book", missiveContractBook);

                        var url = "v1/drafts";
                        webClient.Headers.Add("user-agent", "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.2; .NET CLR 1.0.3705;)");
                        webClient.Headers[HttpRequestHeader.ContentType] = "application/json";

                        ConversationMessageModel.RootDraft draftmodel = new ConversationMessageModel.RootDraft();
                        var objdraftmodel = new ConversationMessageModel.Draft();
                        objdraftmodel.conversation = conversionNumber;
                        //objdraftmodel.send = true;
                        objdraftmodel.send = false;
                        objdraftmodel.references = lastmissiveMessage.references;
                        objdraftmodel.references.Insert(0, lastmissiveMessage.email_message_id);
                        objdraftmodel.quote_previous_message = true;
                        if (Request.Url.AbsoluteUri.Contains("localhost"))
                        {
                            objdraftmodel.subject = "Test Purpose : SynZeal Research PVT LTD : PO No " + model[0].PONumber + " /SZ Quote ID: " + model[0].Ref;
                        }
                        else
                        {
                            objdraftmodel.subject = "SynZeal Research PVT LTD : PO No " + model[0].PONumber + " /SZ Quote ID: " + model[0].Ref;
                        }
                        objdraftmodel.from_field = new ConversationMessageModel.FromField()
                        {
                            address = "projects@synzeal.com"
                        };
                        //objdraftmodel.to_fields = ConversationModel.messages[0].to_fields;
                        objdraftmodel.to_fields = new List<ConversationMessageModel.ToField>();
                        objdraftmodel.cc_fields = new List<ConversationMessageModel.CcField>();
                        objdraftmodel.message_id = lastmissiveMessage.id;

                        string tousername = string.Empty;
                        if (missiveMessage.from_field != null && !missiveMessage.from_field.address.Contains("@synzeal"))
                        {
                            var tofieldemail = new ConversationMessageModel.ToField()
                            {
                                name = missiveMessage.from_field.name,
                                address = missiveMessage.from_field.address
                            };

                            objdraftmodel.to_fields.Add(tofieldemail);
                        }

                        if (model[0].IsRFQ.HasValue && model[0].IsRFQ.Value)
                        {
                            if (!string.IsNullOrEmpty(model[0].EmailAddress))
                            {
                                tousername = model[0].EmailAddress.Split('@')[0];
                            }

                            if (!objdraftmodel.to_fields.Select(x => x.address).Contains(model[0].EmailAddress))
                            {
                                var tofieldemail = new ConversationMessageModel.ToField()
                                {
                                    name = tousername,
                                    address = model[0].EmailAddress
                                };
                                objdraftmodel.to_fields.Add(tofieldemail);
                            }
                        }
                        else
                        {
                            if (missiveMessage.to_fields != null && missiveMessage.to_fields.Count > 0)
                            {
                                foreach (var tofield in missiveMessage.to_fields)
                                {
                                    if (!tofield.address.Contains("@synzeal"))
                                    {
                                        if (!objdraftmodel.to_fields.Select(x => x.address).Contains(tofield.address))
                                        {
                                            if (string.IsNullOrEmpty(tousername))
                                            {
                                                tousername = tofield.name;
                                            }
                                            var tofieldemail = new ConversationMessageModel.ToField()
                                            {
                                                name = tofield.name,
                                                address = tofield.address
                                            };
                                            objdraftmodel.to_fields.Add(tofieldemail);
                                        }
                                    }
                                }
                            }

                            if (objdraftmodel.to_fields != null && objdraftmodel.to_fields.Count > 0)
                            {
                                if (missiveMessage.cc_fields != null && missiveMessage.cc_fields.Count > 0)
                                {
                                    foreach (var ccfield in missiveMessage.cc_fields)
                                    {
                                        if (!ccfield.address.Contains("@synzeal"))
                                        {
                                            if (!objdraftmodel.cc_fields.Select(x => x.address).Contains(ccfield.address))
                                            {
                                                var ccfieldemail = new ConversationMessageModel.CcField()
                                                {
                                                    name = ccfield.name,
                                                    address = ccfield.address
                                                };
                                                objdraftmodel.cc_fields.Add(ccfieldemail);
                                            }
                                        }
                                    }
                                }
                            }
                            else
                            {
                                if (missiveMessage.cc_fields != null && missiveMessage.cc_fields.Count > 0)
                                {
                                    foreach (var ccfield in missiveMessage.cc_fields)
                                    {
                                        if (!ccfield.address.Contains("@synzeal"))
                                        {
                                            if (!objdraftmodel.to_fields.Select(x => x.address).Contains(ccfield.address))
                                            {
                                                var ccfieldemail = new ConversationMessageModel.ToField()
                                                {
                                                    name = ccfield.name,
                                                    address = ccfield.address
                                                };
                                                objdraftmodel.to_fields.Add(ccfieldemail);
                                            }
                                        }
                                    }
                                }
                            }
                        }

                        objdraftmodel.bcc_fields = new List<object>();
                        objdraftmodel.attachments = new List<ConversationMessageModel.AttachmentDataModel>();
                        objdraftmodel.body = "<table border='1' cellspacing='0' cellpadding='0' width='100%'>";
                        objdraftmodel.body += "<thead><tr><th>PO No.</th><th>Product Name</th><th>CAS No</th><th>CAT No</th><th>QTY. (mg)</th><th>Pack Size</th><th>Current Status</th></tr></thead>";
                        objdraftmodel.body += "<tbody>";

                        foreach (var item in model)
                        {
                            objdraftmodel.body += "<tr>";
                            objdraftmodel.body += "<td>" + item.PONumber + "</td>";
                            objdraftmodel.body += "<td>" + item.ProductName + "</td>";
                            objdraftmodel.body += "<td>" + item.CASNo + "</td>";
                            objdraftmodel.body += "<td>" + item.CATNo + "</td>";
                            objdraftmodel.body += "<td>" + item.RequiredQty + "</td>";
                            objdraftmodel.body += "<td>" + item.OrderRemark + "</td>";
                            objdraftmodel.body += "<td>" + item.ExplainationSecond + "</td>";
                            objdraftmodel.body += "</tr>";
                        }

                        objdraftmodel.body += "</tbody>";
                        objdraftmodel.body += "</table>";

                        draftmodel.drafts = objdraftmodel;
                        string data = JsonConvert.SerializeObject(draftmodel);
                        var response = webClient.UploadString(url, data);
                        var resultddds = JsonConvert.DeserializeObject<ConversationMessageModel.RootDraft>(response);

                    }
                }
                catch (Exception ex)
                {
                    sendErrorMail(ex.LineNumber() + " " + "Error Text : " + ex.Message + " / Stack Trace : " + ex.StackTrace);
                    return Json(new
                    {
                        success = false,
                        message = "Error Text : " + ex.Message + " / Stack Trace : " + ex.StackTrace
                    }, JsonRequestBehavior.AllowGet);
                }
                return Json(new
                {
                    success = true,
                    html = ""
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = ex.LineNumber() + " " + "Error Text : " + ex.Message
                }, JsonRequestBehavior.AllowGet);
            }
        }


        [HttpPost]
        [ValidateInput(false)]
        public ActionResult SendEmailInvoiceConfirmationAction(List<int> id, string toEmail, string cctoEmail, string mailfrom)
        {
            try
            {
                List<string> imagePath = new List<string>();

                for (int i = 0; i < Request.Files.Count; i++)
                {
                    var file = Request.Files[i];

                    var fileName = Path.GetFileNameWithoutExtension(file.FileName);
                    var extension = Path.GetExtension(file.FileName);
                    var imageName = file.FileName + "@" + Guid.NewGuid().ToString() + "" + extension;
                    var tempimagePath = Path.Combine(Server.MapPath("~/Content/Invoice"), imageName);
                    file.SaveAs(tempimagePath);

                    imagePath.Add("/Content/Invoice/" + imageName);
                }
                id = Request.Form.Get("id").Split(',').Select(Int32.Parse).ToList();
                List<QuotationListModel> model = new List<QuotationListModel>();
                var quotedetailsdata = db.SZ_QuotationDetail.Where(x => id.Contains(x.Id)).ToList();
                foreach (var ids in id)
                {
                    var details = quotedetailsdata.Where(x => x.Id == ids).FirstOrDefault();
                    if (details != null)
                    {
                        QuotationListModel objmodel = new QuotationListModel();
                        objmodel.PONumber = details.SZ_Quotation.PONo;
                        objmodel.PODate = details.SZ_Quotation.PODate;
                        objmodel.SrPo = details.SrPo;
                        objmodel.ProductName = details.ProductName;
                        objmodel.RequiredQty = details.RequiredQty;
                        objmodel.BatchNo = details.BatchNo;
                        objmodel.CASNo = details.CASNo;
                        objmodel.CATNo = details.CATNo;
                        objmodel.CompanyName = details.SZ_Quotation.CompanyName;
                        objmodel.Courier = details.Courier;
                        objmodel.TrackingNo = details.TrackingNo;
                        objmodel.Location = details.Location;
                        objmodel.RefName = details.RefName;
                        objmodel.PurposeDispatch = details.PurposeDispatch;
                        if (details.EstimateCompleteDate.HasValue)
                        {
                            objmodel.EstimateCompleteDate = details.EstimateCompleteDate.Value.ToShortDateString();
                        }
                        objmodel.AdminScientistStatus = details.AdminScientistStatus;
                        if (details.AdditionalBatchNo.HasValue)
                        {
                            objmodel.BatchNo = db.SZ_Inventory.Where(x => x.Id == details.AdditionalBatchNo).Select(x => x.BatchNo).FirstOrDefault();
                        }

                        if (objmodel.BatchNo == "undefined")
                        {
                            objmodel.BatchNo = "";
                        }
                        objmodel.LeadTime = details.LeadTime;
                        objmodel.TermsId = details.SZ_Quotation.TermsId;
                        objmodel.ClientRef = details.SZ_Quotation.ClientRef;
                        objmodel.Ref = details.SZ_Quotation.Ref;
                        objmodel.CreatedDate = details.SZ_Quotation.CreatedDate;
                        objmodel.PODate = details.SZ_Quotation.PODate;
                        objmodel.CompanyName = details.SZ_Quotation.CompanyName;
                        objmodel.DisplayOrder = details.DisplayOrder;
                        objmodel.ImagePath = details.ImagePath;
                        objmodel.Remark = details.SZ_Quotation.Remark;
                        objmodel.IsImageAttach = details.SZ_Quotation.IsImageAttach;
                        objmodel.OrderRemark = details.OrderRemark;
                        objmodel.Price = details.Price;
                        objmodel.RequiredQty = details.RequiredQty;
                        objmodel.EstimateDispatchDate = details.EstimateDispatchDate;
                        objmodel.PackDate = details.PackDate.HasValue ? details.PackDate.Value.ToShortDateString() : "";
                        model.Add(objmodel);

                        var emailsuggestions = db.SZ_EmailSuggestion.Where(x => x.CompanyID == details.SZ_Quotation.CompanyId).FirstOrDefault();
                        if (emailsuggestions != null)
                        {
                            //Update records
                            string toRecord = string.Empty;
                            string ccRecord = string.Empty;
                            if (!string.IsNullOrEmpty(toEmail))
                            {
                                string[] emails = toEmail.Split(';');
                                foreach (var i in emails)
                                {
                                    if (!string.IsNullOrEmpty(i) && !emailsuggestions.ToAddress.Contains(i))
                                    {
                                        toRecord += i + ";";
                                    }
                                }
                            }
                            if (!string.IsNullOrEmpty(cctoEmail))
                            {
                                string[] emails = cctoEmail.Split(';');
                                foreach (var i in emails)
                                {
                                    if (!string.IsNullOrEmpty(i) && !emailsuggestions.CCAddress.Contains(i))
                                    {
                                        ccRecord += i + ";";
                                    }
                                }
                            }

                            if (!string.IsNullOrEmpty(ccRecord))
                            {
                                emailsuggestions.CCAddress += ";" + ccRecord;
                            }
                            if (!string.IsNullOrEmpty(toRecord))
                            {
                                emailsuggestions.ToAddress += ";" + toEmail;
                            }
                            db.Entry(emailsuggestions).State = EntityState.Modified;
                            db.SaveChanges();

                        }
                        else
                        {
                            //Insert Records
                            emailsuggestions = new SZ_EmailSuggestion();
                            emailsuggestions.CompanyID = details.SZ_Quotation.CompanyId.HasValue ? details.SZ_Quotation.CompanyId.Value : 0;
                            emailsuggestions.CreatedDate = DateTime.Now;
                            emailsuggestions.CCAddress = cctoEmail;
                            emailsuggestions.ToAddress = toEmail;
                            db.SZ_EmailSuggestion.Add(emailsuggestions);
                            db.SaveChanges();
                        }
                    }
                }

                try
                {
                    MailMessage mail = new MailMessage();
                    ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12 |
                                       SecurityProtocolType.Tls11 |
                                       SecurityProtocolType.Tls |
                                       SecurityProtocolType.Ssl3;
                    SmtpClient SmtpServer = new SmtpClient(ConfigurationManager.AppSettings["Email.Host"]);
                    mail.From = new MailAddress(ConfigurationManager.AppSettings["Email.Username"], "SynZeal Standards");

                    var isDevelopment = ConfigurationManager.AppSettings["IsDevelopment"];
                    if (isDevelopment.ToLower().Contains("true"))
                    {
                        mail.To.Add(ConfigurationManager.AppSettings["DevEmailAddress"].ToString());
                    }
                    else
                    {
                        if (!string.IsNullOrEmpty(toEmail))
                        {
                            try
                            {
                                string[] emails = toEmail.Split(';');
                                foreach (var i in emails)
                                {
                                    if (!string.IsNullOrEmpty(i))
                                    {
                                        mail.To.Add(i);
                                    }
                                }
                            }
                            catch (Exception)
                            {
                                mail.To.Add(toEmail);
                            }
                        }
                        if (!string.IsNullOrEmpty(cctoEmail))
                        {
                            string[] emails = cctoEmail.Split(';');
                            foreach (var i in emails)
                            {
                                if (!string.IsNullOrEmpty(i))
                                {
                                    mail.CC.Add(i);
                                }
                            }
                        }

                    }
                    ViewBag.IsAttachment = false;
                    if (imagePath != null && imagePath.Count > 0)
                    {
                        foreach (var item in imagePath)
                        {
                            var attach = new Attachment(Server.MapPath("~" + item));
                            attach.Name = item.Split('@')[0].ToLower().Replace("/content/invoice/", "");
                            mail.Attachments.Add(attach);
                        }
                        ViewBag.IsAttachment = true;
                    }

                    var htmlstring = PartialViewdata(this, "_PartialPrintRecordMail", model);

                    mail.Subject = "SynZeal Research PVT LTD Dispatch Detail :: " + model.Select(x => x.CompanyName).FirstOrDefault() + " :: Dated : " + System.DateTime.Now.ToShortDateString();
                    htmlstring = "<html><head></head><body style='font-family:'Roboto', sans-serif;font-size:11px;'>" + htmlstring + "</body></html>";

                    mail.IsBodyHtml = true;
                    SmtpServer.Port = Convert.ToInt32(ConfigurationManager.AppSettings["Port"]);

                    if (mailfrom == "Sales")
                    {
                        mail.From = new MailAddress(ConfigurationManager.AppSettings["Email.SalesUsername"], "Sales SynZeal");
                        SmtpServer.Credentials = new System.Net.NetworkCredential(ConfigurationManager.AppSettings["Email.SalesUsername"], ConfigurationManager.AppSettings["Email.SalesPassword"]);
                        htmlstring = htmlstring.Replace("~signaturename", "Rajen Patel");
                        htmlstring = htmlstring.Replace("~signaturemobile", "+91-76980 00178");
                    }
                    else if (mailfrom == "Export")
                    {
                        mail.From = new MailAddress(ConfigurationManager.AppSettings["Email.ExportUsername"], "Export SynZeal");
                        SmtpServer.Credentials = new System.Net.NetworkCredential(ConfigurationManager.AppSettings["Email.ExportUsername"], ConfigurationManager.AppSettings["Email.ExportPassword"]);
                        htmlstring = htmlstring.Replace("~signaturename", "Ketan Malani");
                        htmlstring = htmlstring.Replace("~signaturemobile", "+91-75750 10561");
                    }
                    else
                    {
                        htmlstring = htmlstring.Replace("~signaturename", "");
                        htmlstring = htmlstring.Replace("~signaturemobile", "");
                        SmtpServer.Credentials = new System.Net.NetworkCredential(ConfigurationManager.AppSettings["Email.Username"], ConfigurationManager.AppSettings["Email.Password"]);
                    }

                    mail.Body = htmlstring;
                    SmtpServer.EnableSsl = true;
                    SmtpServer.Send(mail);
                }
                catch (Exception ex)
                {
                    sendErrorMail(ex.LineNumber() + " Email List: " + toEmail + "Error Text : " + ex.Message + " / Stack Trace : " + ex.StackTrace);
                }
                return Json(new
                {
                    success = true,
                    html = ""
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = ex.Message
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult ViewNotification(int id)
        {
            try
            {
                var details = db.SZ_Notification.Where(x => x.Id == id).FirstOrDefault();
                if (details != null)
                {
                    ViewBag.Message = details.Message;
                    details.IsRead = true;
                    db.Entry(details).State = EntityState.Modified;
                    db.SaveChanges();
                }

                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult ReminderInvoiceRecord(List<int> id)
        {
            try
            {
                var quotedetailsdata = db.SZ_QuotationDetail.Where(x => id.Contains(x.Id)).ToList();
                List<QuotationListModel> model = new List<QuotationListModel>();
                foreach (var ids in id)
                {
                    var details = quotedetailsdata.Where(x => x.Id == ids).FirstOrDefault();
                    if (details != null)
                    {
                        QuotationListModel objmodel = new QuotationListModel();
                        objmodel.PONumber = details.SZ_Quotation.PONo;
                        objmodel.PODate = details.SZ_Quotation.PODate;
                        if (details.PackDate.HasValue)
                        {
                            objmodel.PackDate = details.PackDate.Value.ToShortDateString();
                        }
                        objmodel.SrPo = details.SrPo;
                        objmodel.ProductName = details.ProductName;
                        objmodel.RequiredQty = details.RequiredQty;
                        //objmodel.BatchNo = details.BatchNo;
                        objmodel.CompanyName = details.SZ_Quotation.CompanyName;
                        objmodel.Courier = details.Courier;
                        objmodel.TrackingNo = details.TrackingNo;
                        objmodel.Location = details.Location;
                        objmodel.RefName = details.RefName;
                        objmodel.PurposeDispatch = details.PurposeDispatch;
                        if (/*string.IsNullOrEmpty(details.BatchNo) && */details.AdditionalBatchNo.HasValue)
                        {
                            objmodel.BatchNo = db.SZ_Inventory.Where(x => x.Id == details.AdditionalBatchNo.Value).Select(x => x.BatchNo).FirstOrDefault();
                        }

                        if (objmodel.BatchNo == "undefined")
                        {
                            objmodel.BatchNo = "";
                        }

                        model.Add(objmodel);
                    }
                }

                var htmlstring = PartialViewdata(this, "_PartialInvoiceReminderRecord", model);

                return Json(new
                {
                    success = true,
                    html = htmlstring
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult PrintInvoiceRecord(List<int> id)
        {
            try
            {
                var quotedetailsdata = db.SZ_QuotationDetail.Where(x => id.Contains(x.Id)).ToList();
                List<QuotationListModel> model = new List<QuotationListModel>();
                foreach (var ids in id)
                {
                    var details = quotedetailsdata.Where(x => x.Id == ids).FirstOrDefault();
                    if (details != null)
                    {
                        QuotationListModel objmodel = new QuotationListModel();
                        objmodel.PONumber = details.SZ_Quotation.PONo;
                        objmodel.PODate = details.SZ_Quotation.PODate;
                        if (details.PackDate.HasValue)
                        {
                            objmodel.PackDate = details.PackDate.Value.ToShortDateString();
                        }
                        objmodel.SrPo = details.SrPo;
                        objmodel.ProductName = details.ProductName;
                        objmodel.CASNo = details.CASNo;
                        objmodel.CATNo = details.CATNo;
                        objmodel.RequiredQty = details.RequiredQty;
                        //objmodel.BatchNo = details.BatchNo;
                        objmodel.CompanyName = details.SZ_Quotation.CompanyName;
                        objmodel.Courier = details.Courier;
                        objmodel.TrackingNo = details.TrackingNo;
                        objmodel.Location = details.Location;
                        objmodel.RefName = details.RefName;
                        objmodel.PurposeDispatch = details.PurposeDispatch;
                        if (/*string.IsNullOrEmpty(details.BatchNo) && */details.AdditionalBatchNo.HasValue)
                        {
                            objmodel.BatchNo = db.SZ_Inventory.Where(x => x.Id == details.AdditionalBatchNo.Value).Select(x => x.BatchNo).FirstOrDefault();
                        }

                        if (objmodel.BatchNo == "undefined")
                        {
                            objmodel.BatchNo = "";
                        }

                        model.Add(objmodel);
                    }
                }

                var htmlstring = PartialViewdata(this, "_PartialPrintRecord", model);

                return Json(new
                {
                    success = true,
                    html = htmlstring
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult SendInvoiceRecord(List<int> id)
        {
            try
            {
                ViewBag.Ids = id;
                var quotedetailsdata = db.SZ_QuotationDetail.Where(x => id.Contains(x.Id)).ToList();
                List<QuotationListModel> model = new List<QuotationListModel>();
                foreach (var ids in id)
                {
                    var details = quotedetailsdata.Where(x => x.Id == ids).FirstOrDefault();
                    if (details != null)
                    {
                        QuotationListModel objmodel = new QuotationListModel();
                        objmodel.PONumber = details.SZ_Quotation.PONo;
                        objmodel.PODate = details.SZ_Quotation.PODate;
                        if (details.PackDate.HasValue)
                        {
                            objmodel.PackDate = details.PackDate.Value.ToShortDateString();
                        }
                        objmodel.SrPo = details.SrPo;
                        objmodel.ProductName = details.ProductName;
                        objmodel.RequiredQty = details.RequiredQty;
                        //objmodel.BatchNo = details.BatchNo;
                        objmodel.CompanyName = details.SZ_Quotation.CompanyName;
                        objmodel.Courier = details.Courier;
                        objmodel.TrackingNo = details.TrackingNo;
                        objmodel.Location = details.Location;
                        objmodel.RefName = details.RefName;
                        objmodel.PurposeDispatch = details.PurposeDispatch;
                        if (/*string.IsNullOrEmpty(details.BatchNo) && */details.AdditionalBatchNo.HasValue)
                        {
                            objmodel.BatchNo = db.SZ_Inventory.Where(x => x.Id == details.AdditionalBatchNo.Value).Select(x => x.BatchNo).FirstOrDefault();
                        }

                        if (objmodel.BatchNo == "undefined")
                        {
                            objmodel.BatchNo = "";
                        }

                        model.Add(objmodel);
                    }
                }

                var htmlstring = PartialViewdata(this, "_PartialSendInvoiceRecord", model);

                return Json(new
                {
                    success = true,
                    html = htmlstring
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult PrintFollowupRecord(List<int> id)
        {
            try
            {
                var quotedetailsdata = db.SZ_QuotationDetail.Where(x => id.Contains(x.Id)).ToList();
                List<QuotationListModel> model = new List<QuotationListModel>();
                foreach (var ids in id)
                {
                    var details = quotedetailsdata.Where(x => x.Id == ids).FirstOrDefault();
                    if (details != null)
                    {
                        QuotationListModel objmodel = new QuotationListModel();
                        objmodel.QuoteDetailsId = details.Id;
                        objmodel.CreatedDate = details.CreatedDate;
                        objmodel.PONumber = details.SZ_Quotation.PONo;
                        objmodel.PODate = details.SZ_Quotation.PODate;
                        if (details.PackDate.HasValue)
                        {
                            objmodel.PackDate = details.PackDate.Value.ToShortDateString();
                        }
                        objmodel.Price = details.Price;
                        objmodel.CASNo = details.CASNo;
                        objmodel.CATNo = details.CATNo;
                        objmodel.LeadTime = details.LeadTime;
                        objmodel.SrPo = details.SrPo;
                        objmodel.ProductName = details.ProductName;
                        objmodel.RequiredQty = details.RequiredQty;
                        //objmodel.BatchNo = details.BatchNo;
                        objmodel.CompanyName = details.SZ_Quotation.CompanyName;
                        objmodel.Ref = details.SZ_Quotation.Ref;
                        objmodel.PurposeDispatch = details.PurposeDispatch;
                        if (/*string.IsNullOrEmpty(details.BatchNo) && */details.AdditionalBatchNo.HasValue)
                        {
                            objmodel.BatchNo = db.SZ_Inventory.Where(x => x.Id == details.AdditionalBatchNo.Value).Select(x => x.BatchNo).FirstOrDefault();
                        }

                        if (objmodel.BatchNo == "undefined")
                        {
                            objmodel.BatchNo = "";
                        }

                        model.Add(objmodel);
                    }
                }

                var htmlstring = PartialViewdata(this, "_PartialFollowupRecord", model);

                return Json(new
                {
                    success = true,
                    html = htmlstring
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        public JsonResult LoadAllCompanyList()
        {
            List<CompanyModel> model = new List<CompanyModel>();
            var companyList = db.SZ_CompanyList.OrderBy(x => x.Name).ToList();
            foreach (var item in companyList)
            {
                CompanyModel objmodel = new CompanyModel();
                objmodel.id = item.Id;
                objmodel.name = item.Name;
                model.Add(objmodel);
            }
            return Json(model, JsonRequestBehavior.AllowGet);
        }

        [HttpGet]
        public ActionResult PendingUploadExportPopup()
        {
            var htmlstring = PartialViewdata(this, "_PartialExportPendingUpload", null);

            return Json(new
            {
                success = true,
                html = htmlstring
            }, JsonRequestBehavior.AllowGet);
        }

        [HttpGet]
        public ActionResult AddNewCompanyPopup()
        {
            var listItems = new List<SelectListItem>();
            listItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var terms = db.SZ_Terms.ToList();
            foreach (var term in terms)
            {
                listItems.Add(new SelectListItem
                {
                    Text = term.Name,
                    Value = term.Id.ToString()
                });
            }

            ViewBag.termsList = listItems;
            List<CompanyModel> model = new List<CompanyModel>();
            var htmlstring = PartialViewdata(this, "_PartialNewCompanyAdd", model);

            return Json(new
            {
                success = true,
                html = htmlstring
            }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult CompanySelectionPopup(List<int> id, string companyName)
        {
            try
            {
                ViewBag.companyName = companyName;
                ViewBag.rfqItds = string.Join(",", id);
                List<CompanyModel> model = new List<CompanyModel>();
                var companyList = db.SZ_CompanyList.OrderBy(x => x.Name).ToList();
                foreach (var item in companyList)
                {
                    CompanyModel objmodel = new CompanyModel();
                    objmodel.id = item.Id;
                    objmodel.name = item.Name;
                    model.Add(objmodel);

                }

                var listItems = new List<SelectListItem>();
                listItems.Add(new SelectListItem
                {
                    Text = "--Select--",
                    Value = ""
                });
                var terms = db.SZ_Terms.ToList();
                foreach (var term in terms)
                {
                    listItems.Add(new SelectListItem
                    {
                        Text = term.Name,
                        Value = term.Id.ToString()
                    });
                }

                ViewBag.termsList = listItems;

                var htmlstring = PartialViewdata(this, "_PartialCompanySelection", model);

                return Json(new
                {
                    success = true,
                    html = htmlstring
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult SetFollowupRecord(List<int> id)
        {
            try
            {
                List<string> idss = Request.Form["id"].Split(',').ToList();
                List<QuotationListModel> model = new List<QuotationListModel>();
                foreach (var ids in idss)
                {
                    int i = Convert.ToInt32(ids);
                    var details = _operationRepository.GetQuoteDetailByID(i);
                    if (details != null)
                    {
                        details.FollowUpRemarkSecond = "Mail Sent.";
                        db.Entry(details).State = EntityState.Modified;
                        db.SaveChanges();
                    }
                }

                return Json(new
                {
                    success = true,
                    html = ""
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        public ActionResult convertquotecurrancy(int id, string to, decimal rate)
        {
            var quoteData = _operationRepository.GetQuoteByID(id);
            if (quoteData != null)
            {
                quoteData.Currency = to;
                db.Entry(quoteData).State = EntityState.Modified;

                var quoteDetailsData = db.SZ_QuotationDetail.Where(x => x.QuoteId == id).ToList();
                if (quoteDetailsData != null && quoteDetailsData.Count > 0)
                {

                    foreach (var item in quoteDetailsData)
                    {
                        var pristr = "";
                        var price = item.Price.PreparePriceModel();
                        int loop = 1;
                        int finalLoop = price.Count;
                        foreach (var pri in price)
                        {
                            var finalRate = Convert.ToDecimal(pri.Price) * rate;
                            pristr += pri.MG + " mg@" + Math.Ceiling(finalRate) + " " + to;
                            if (pri.PackSize > 0)
                            {
                                decimal Packsizerate = Math.Ceiling(finalRate) * pri.PackSize;
                                pristr += " X " + pri.PackSize + " = " + Math.Ceiling(Packsizerate) + " " + to;
                            }
                            if (finalLoop > loop)
                            {
                                pristr += ", ";
                            }
                            loop += 1;
                        }
                        item.Price = pristr;
                        db.Entry(item).State = EntityState.Modified;
                    }
                }
                db.SaveChanges();
            }
            return Json(true, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult GetTheCatPriceMatchStatus(List<PriceMatchStatusModel> id)
        {
            if (id == null)
            {
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new
                    {
                        data = "",
                        success = false,
                        message = "Moved successfully.."
                    }
                };
            }

            List<PriceMatchStatusModel> modal = new List<PriceMatchStatusModel>();
            foreach (var item in id)
            {
                PriceMatchStatusModel objModel = new PriceMatchStatusModel();
                string price = item.mg + " mg@";
                var data = db.SZ_QuotationDetail.Where(x => x.SZ_Quotation.CountryType == item.countryType
                            && x.CATNo == item.catno
                            && x.Price.Contains(price)
                            && x.Id != item.id
                            && x.SZ_Quotation.CompanyId != 2514
                            && x.SZ_Quotation.CompanyId != 2515
                            && (x.IsOnHold == null || x.IsOnHold == false)
                            && (x.IsHoldManually == null || x.IsHoldManually == false)
                            && (x.SZ_Quotation.IsPark == null || x.SZ_Quotation.IsPark == false)
                            && !string.IsNullOrEmpty(x.SZ_Quotation.ApprovedBy)).OrderByDescending(x => x.CreatedDate).FirstOrDefault();

                objModel.id = item.id;
                objModel.mg = item.mg;
                objModel.price = item.price;
                objModel.catno = item.catno;
                objModel.countryType = item.countryType;
                objModel.diff = 0;
                objModel.type = item.type;
                objModel.isUp = false;
                objModel.isDown = false;
                objModel.isSame = false;
                if (data != null)
                {
                    objModel.IsMovetoProject = data.MoveToProject.HasValue ? data.MoveToProject.Value : false;
                    objModel.currancy = data.SZ_Quotation.Currency;
                    var submodal = PrepareSuggestedPriceModel(data);
                    if (submodal.PriceList != null && submodal.PriceList.Count > 0)
                    {
                        var myprice = submodal.PriceList.Where(x => x.MG == item.mg).FirstOrDefault();
                        if (myprice != null && myprice.Price != 0)
                        {
                            objModel.timeAgo = data.CreatedDate.TimeAgo();
                            if (item.price > myprice.Price)
                            {
                                objModel.isUp = true;
                                objModel.diff = item.price - myprice.Price;
                            }
                            if (item.price < myprice.Price)
                            {
                                objModel.isDown = true;
                                objModel.diff = myprice.Price - item.price;
                            }
                            if (item.price == myprice.Price)
                            {
                                objModel.isSame = true;
                            }
                        }
                    }
                    var lastdata = db.SZ_QuotationDetail.Where(x => x.SZ_Quotation.CountryType == item.countryType
                            && x.CATNo == item.catno
                            && x.Price.Contains(price)
                            && x.Id != item.id
                            && x.SZ_Quotation.CompanyId != 2514
                            && x.SZ_Quotation.CompanyId != 2515
                            && (x.IsOnHold == null || x.IsOnHold == false)
                            && (x.IsHoldManually == null || x.IsHoldManually == false)
                            && (x.SZ_Quotation.IsPark == null || x.SZ_Quotation.IsPark == false)
                            && !string.IsNullOrEmpty(x.SZ_Quotation.ApprovedBy)
                            && x.Id != data.Id && x.SZ_Quotation.CreatedDate <= data.SZ_Quotation.CreatedDate).OrderByDescending(x => x.CreatedDate).FirstOrDefault();
                    if (lastdata != null)
                    {
                        var lastsubmodal = PrepareSuggestedPriceModel(lastdata);
                        if (lastsubmodal.PriceList != null && lastsubmodal.PriceList.Count > 0)
                        {
                            var myprice = submodal.PriceList.Where(x => x.MG == item.mg).FirstOrDefault();
                            if (myprice != null && myprice.Price != 0)
                            {
                                if (item.price > myprice.Price || item.price < myprice.Price)
                                {
                                    objModel.LastToLastPrice = myprice.Price;
                                }
                            }
                        }
                    }
                }
                modal.Add(objModel);
            }

            return new JsonResult()
            {
                JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                Data = new
                {
                    data = modal,
                    success = true,
                    message = "Moved successfully.."
                }
            };
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult MoveToInvoiceList(List<int> id)
        {
            List<string> ponos = new List<string>();
            var quotedetailsdata = db.SZ_QuotationDetail.Where(x => id.Contains(x.Id)).ToList();
            foreach (var ids in id)
            {
                var data = quotedetailsdata.Where(x => x.Id == ids).FirstOrDefault();
                if (data != null)
                {
                    if (!data.AdditionalBatchNo.HasValue)
                    {
                        ponos.Add(data.CATNo);
                        continue;
                    }
                    int batchnoId = 0;
                    if (data.AdditionalBatchNo.HasValue)
                    {
                        batchnoId = data.AdditionalBatchNo.Value;
                    }
                    data.MoveToInvoice = true;
                    data.PaymentStatus = "UnPaid";
                    data.ProcessState = (int)EnumList.ProjectStatus.MoveToInvoice;
                    data.PackDate = DateTime.Now;
                    data.MoveToInvoiceDate = DateTime.Now;
                    data.InvoiceBatchNo = db.SZ_Inventory.Where(x => x.Id == batchnoId).Select(x => x.BatchNo).FirstOrDefault();
                    data.Courier = "5";
                    db.Entry(data).State = EntityState.Modified;
                    db.SaveChanges();
                }
            }
            if (ponos.Count() > 0)
            {
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { success = false, message = "Mostly Products move. Please select bactno of " + string.Join(", ", ponos) }
                };
            }
            return new JsonResult()
            {
                JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                Data = new { success = true, message = "Moved successfully.." }
            };
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult SaveFollowupOverview(List<SZ_Quotation> quotes)
        {
            foreach (var quote in quotes)
            {
                var details = _operationRepository.GetQuoteByID(quote.Id);
                if (details != null)
                {
                    details.QuoteTotal = quote.QuoteTotal;
                    details.FollowUpComment = quote.FollowUpComment;
                    db.Entry(details).State = EntityState.Modified;
                    db.SaveChanges();
                }
            }
            return new JsonResult()
            {
                JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                Data = new { success = true, message = "Moved successfully.." }
            };
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult removeFollowupOverview(List<int> id)
        {
            foreach (var ids in id)
            {
                var details = _operationRepository.GetQuoteByID(ids);
                if (details != null)
                {
                    details.IsRemoveFollowup = true;
                    db.Entry(details).State = EntityState.Modified;
                    db.SaveChanges();
                }
            }
            return new JsonResult()
            {
                JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                Data = new { success = true, message = "Moved successfully.." }
            };
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult MoveToInHouse(List<int> id)
        {
            var quotedetailsdata = db.SZ_QuotationDetail.Where(x => id.Contains(x.Id)).ToList();
            foreach (var ids in id)
            {
                var details = quotedetailsdata.Where(x => x.Id == ids).FirstOrDefault();
                if (details != null)
                {
                    var quotedetailsPO = db.SZ_QuotationDetail.Where(x => x.QuoteId == details.QuoteId).Max(x => x.SrPo);
                    int srPo = 0;
                    if (quotedetailsPO != null && quotedetailsPO != 0 && quotedetailsPO.HasValue)
                    {
                        srPo = quotedetailsPO.Value + 1;
                    }
                    else
                    {
                        srPo = 1;
                    }
                    details.SrPo = srPo;
                    details.MoveToProject = true;
                    details.MoveProjectDate = DateTime.Now;
                    details.ProcessState = (int)EnumList.ProcessState.MoveToProject;
                    details.ProjectStatus = (int)EnumList.ProjectStatus.NoAction;
                    details.ProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
                    db.Entry(details).State = EntityState.Modified;
                    db.SaveChanges();
                }
            }
            return new JsonResult()
            {
                JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                Data = new { success = true, message = "Moved successfully.." }
            };
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult MoveToClubQuote(List<int> id)
        {
            var quotedetailsdata = db.SZ_QuotationDetail.Where(x => id.Contains(x.Id)).ToList();
            var clubquoteList = db.SZ_ClubQuote.Where(x => id.Contains(x.QuotationDetailsId)).ToList();
            quotedetailsdata.ForEach(x =>
            {
                var isCheck = clubquoteList.Where(y => y.QuotationDetailsId == x.Id).FirstOrDefault();
                if (isCheck == null)
                {
                    SZ_ClubQuote objClubQuote = new SZ_ClubQuote();
                    objClubQuote.QuotationDetailsId = x.Id;
                    db.SZ_ClubQuote.Add(objClubQuote);
                }
            });
            db.SaveChanges();
            return new JsonResult()
            {
                JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                Data = new { success = true, message = "Moved successfully.." }
            };
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult SaveSynthesisLog(ProductInfo model)
        {
            try
            {
                var szquotedetails = _operationRepository.GetQuoteDetailByID(model.id);
                if (szquotedetails != null)
                {
                    szquotedetails.IsSynthesisLog = true;
                    db.Entry(szquotedetails).State = EntityState.Modified;
                    db.SaveChanges();
                }
                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult UpdateSynthesisProductInfo(ProductInfo model)
        {
            try
            {
                var szquotedetails = _operationRepository.GetQuoteDetailByID(model.id);
                if (szquotedetails != null)
                {
                    string oldProjectType = szquotedetails.ProjectType;

                    szquotedetails.ProductRemark = model.productremark;
                    szquotedetails.ProductName = model.ProductName;

                    if (model.followUpRemark != "undefined")
                    {
                        szquotedetails.FollowUpRemark = model.followUpRemark;
                    }
                    if (model.followUpRemarkSecond != "undefined")
                    {
                        szquotedetails.FollowUpRemarkSecond = model.followUpRemarkSecond;
                    }
                    szquotedetails.CASNo = model.casno;
                    if (!string.IsNullOrEmpty(model.catNo))
                    {
                        var proData = db.Products.Where(x => x.Published == true && x.Deleted == false && x.Sku.ToLower().Trim() == model.catNo.ToLower().Trim()).FirstOrDefault();
                        if (proData != null)
                        {
                            szquotedetails.ProductId = proData.Id;
                            szquotedetails.IsUploadServer = true;
                        }
                        else
                        {
                            szquotedetails.IsUploadServer = false;
                        }
                    }
                    else
                    {
                        szquotedetails.ProductId = 0;
                        szquotedetails.IsUploadServer = false;
                    }
                    szquotedetails.ProjectType = model.projectType;
                    szquotedetails.CATNo = model.catNo;
                    szquotedetails.Price = model.price;
                    szquotedetails.LeadTime = model.leadtime;
                    szquotedetails.DisplayOrder = model.displayOrder;
                    szquotedetails.ScientistCustomerId = model.scientistCustomerid;
                    if (!string.IsNullOrEmpty(model.estimateDispatchDate))
                    {
                        szquotedetails.EstimateDispatchDate = Convert.ToDateTime(model.estimateDispatchDate);
                    }
                    else
                    {
                        szquotedetails.EstimateDispatchDate = null;
                    }
                    if ("undefined" == szquotedetails.BatchNo)
                    {
                        szquotedetails.BatchNo = "";
                    }

                    if (!string.IsNullOrEmpty(model.projectType) && Convert.ToInt32(model.projectType) == (int)EnumList.ProjectType.InStock)
                    {
                        szquotedetails.ProjectStatus = (int)EnumList.ProjectStatus.MoveToInstock;
                        if (szquotedetails.ProcessState <= (int)EnumList.ProcessState.MoveToInStock)
                        {
                            szquotedetails.ProcessState = (int)EnumList.ProcessState.MoveToInStock;
                        }
                    }
                    if (!string.IsNullOrEmpty(model.projectType) && oldProjectType != model.projectType && (Convert.ToInt32(model.projectType) == (int)EnumList.ProjectType.Purchase || Convert.ToInt32(model.projectType) == (int)EnumList.ProjectType.PurSynthesis))
                    {
                        szquotedetails.PurchaseDate = DateTime.Now;
                        szquotedetails.ProjectStatus = (int)EnumList.ProjectStatus.MoveToPurchase;
                        if (szquotedetails.ProcessState <= (int)EnumList.ProcessState.MoveToPurchase)
                        {
                            szquotedetails.ProcessState = (int)EnumList.ProcessState.MoveToPurchase;
                        }
                    }
                    db.Entry(szquotedetails).State = EntityState.Modified;
                    db.SaveChanges();
                    var szquote = _operationRepository.GetQuoteByID(szquotedetails.QuoteId);
                    if (szquote != null)
                    {

                        if (model.ponumber != "undefined" && model.ponumber != null)
                        {
                            //TODO: Stoped PO Update Date
                            //if (!string.IsNullOrEmpty(model.ponumber) && string.IsNullOrEmpty(szquote.PONo))
                            //{
                            //    szquote.PODate = DateTime.Now;
                            //}
                            szquote.PONo = model.ponumber;
                            db.Entry(szquote).State = EntityState.Modified;
                            db.SaveChanges();
                        }
                    }
                }
                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        public ActionResult GetCurrencyData()
        {
            var data = db.SZ_Currency.ToList();
            return Json(data, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult UpdatePerformaInvoiceProductInfo(PerformaInvoiceDetails model)
        {
            try
            {
                var szperformaInvoice = db.SZ_PerformaInvoiceDetailsData.Where(x => x.Id == model.id).FirstOrDefault();
                if (szperformaInvoice != null)
                {
                    szperformaInvoice.QuoteDetailsPrice = model.price;
                    szperformaInvoice.HSNCode = model.HSNCode;
                    if (!string.IsNullOrEmpty(szperformaInvoice.QuoteDetailsPrice))
                    {
                        if (szperformaInvoice.QuoteDetailsPrice.Contains("X"))
                        {
                            var splicross = szperformaInvoice.QuoteDetailsPrice.Split('X');
                            var firstmg = splicross[0].Split('@')[0];
                            var secvial = splicross[1].Split('=')[0];

                            szperformaInvoice.Qty = firstmg + " X " + secvial;
                            szperformaInvoice.Rate = Convert.ToDecimal(splicross[0].Split('@')[1].Split(' ')[0]);
                            szperformaInvoice.Total = Convert.ToDecimal(splicross[1].Split('=')[1].Trim().Split(' ')[0]);
                        }
                        else
                        {
                            var firstmg = szperformaInvoice.QuoteDetailsPrice.Split('@')[0];
                            szperformaInvoice.Qty = firstmg + " X 1";
                            szperformaInvoice.Rate = Convert.ToDecimal(szperformaInvoice.QuoteDetailsPrice.Split('@')[1].Split(' ')[0]);
                            szperformaInvoice.Total = Convert.ToDecimal(szperformaInvoice.QuoteDetailsPrice.Split('@')[1].Split(' ')[0]);
                        }
                    }

                    szperformaInvoice.TraceabilityCost = string.IsNullOrEmpty(model.trace) ? 0 : Convert.ToDecimal(model.trace);
                    szperformaInvoice.AdditionTest = string.IsNullOrEmpty(model.addtest) ? 0 : Convert.ToDecimal(model.addtest);
                    szperformaInvoice.Coldshipment = string.IsNullOrEmpty(model.coldship) ? 0 : Convert.ToDecimal(model.coldship);
                    db.Entry(szperformaInvoice).State = EntityState.Modified;
                    db.SaveChanges();
                }
                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        public ActionResult UpdateAnalyticalDataintoCompanyMaster(int id, string value)
        {
            var companyData = db.SZ_CompanyList.Where(x => x.Id == id).FirstOrDefault();
            if (companyData != null)
            {
                companyData.AnalyticalData = value;
                db.Entry(companyData).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json(new
            {
                success = true
            }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult UpdateProductInfo(ProductInfo model)
        {
            try
            {
                var oldSzQuoteModel = new SZ_Quotation();
                var szquotedetails = _operationRepository.GetQuoteDetailByID(model.id);
                if (szquotedetails != null)
                {
                    if (!string.IsNullOrEmpty(model.catNo))
                    {
                        model.catNo = model.catNo.Trim();
                    }
                    oldSzQuoteModel = LogManagement.PrepareQuoteEntity(szquotedetails.SZ_Quotation);
                    var oldModel = LogManagement.PrepareQuoteDetailEntity(szquotedetails);

                    szquotedetails.InternalComment = model.internalComment;
                    szquotedetails.ProductRemark = model.productremark;
                    szquotedetails.ProductName = model.ProductName;
                    if (!string.IsNullOrEmpty(model.batchno) && model.batchno != "undefined")
                    {
                        model.batchno = model.batchno.Trim();
                        szquotedetails.QuoteBatchNo = model.batchno.Trim().Split(' ')[0].Trim();
                    }
                    else
                    {
                        szquotedetails.QuoteBatchNo = "0";
                    }
                    if (model.followUpRemark != "undefined")
                    {
                        szquotedetails.FollowUpRemark = model.followUpRemark;
                    }
                    if (model.followUpRemarkSecond != "undefined")
                    {
                        szquotedetails.FollowUpRemarkSecond = model.followUpRemarkSecond;
                    }
                    szquotedetails.CASNo = model.casno;
                    if (!string.IsNullOrEmpty(model.catNo))
                    {
                        var proData = db.Products.Where(x => x.Published == true && x.Deleted == false && x.Sku.ToLower().Trim() == model.catNo.ToLower().Trim()).FirstOrDefault();
                        if (proData != null)
                        {
                            szquotedetails.ProductId = proData.Id;
                            if (szquotedetails.CATNo != model.catNo)
                            {
                                szquotedetails.CASNo = proData.ManufacturerPartNumber;
                            }
                            if (string.IsNullOrEmpty(szquotedetails.CASNo))
                            {
                                szquotedetails.CASNo = proData.ManufacturerPartNumber;
                            }
                            szquotedetails.IsUploadServer = true;
                        }
                        else
                        {
                            szquotedetails.ProductId = 0;
                            szquotedetails.IsUploadServer = false;
                        }
                    }
                    else
                    {
                        szquotedetails.ProductId = 0;
                        szquotedetails.IsUploadServer = false;
                    }

                    szquotedetails.CATNo = model.catNo;
                    szquotedetails.Price = model.price;
                    szquotedetails.LeadTime = model.leadtime;
                    szquotedetails.DisplayOrder = model.displayOrder;
                    szquotedetails.ItemDiscount = model.discount;
                    if (!string.IsNullOrEmpty(model.estimateDispatchDate))
                    {
                        szquotedetails.EstimateDispatchDate = Convert.ToDateTime(model.estimateDispatchDate);
                    }
                    else
                    {
                        szquotedetails.EstimateDispatchDate = null;
                    }

                    if ("undefined" == szquotedetails.BatchNo || string.IsNullOrEmpty(szquotedetails.BatchNo))
                    {
                        szquotedetails.BatchNo = "";
                    }

                    if (model.actionname == "partialproductupdate")
                    {
                        szquotedetails.IsSynthesisLog = model.synthesislog;
                        szquotedetails.FinalPrice = model.finalprice;
                    }
                    if (model.actionname == "all")
                    {
                        szquotedetails.FinalPrice = model.finalprice;
                        szquotedetails.COAId = model.coa;
                        szquotedetails.ActivityStatus = model.ActivityStatus;
                    }

                    if (model.actionname == "followup")
                    {
                        if (szquotedetails.ContactDetail != model.contactdetail)
                        {
                            szquotedetails.IsFollowUpAdminChange = true;
                            //szquotedetails.IsFollowupChange = false;
                        }
                        szquotedetails.ContactDetail = model.contactdetail;
                    }

                    var szquote = _operationRepository.GetQuoteByID(szquotedetails.QuoteId);
                    if (szquote != null)
                    {
                        if (model.ponumber != "undefined" && model.ponumber != null)
                        {
                            //TODO: Stoped PO Update Date
                            //if (!string.IsNullOrEmpty(model.ponumber) && string.IsNullOrEmpty(szquote.PONo))
                            //{
                            //    szquote.PODate = DateTime.Now;
                            //}
                            //if (!string.IsNullOrEmpty(model.ponumber) && string.IsNullOrEmpty(szquote.PONo) && szquote.CountryType == "Export")
                            //{
                            //    szquotedetails.ActivityStatus = "Approval First";
                            //}
                            if (!string.IsNullOrEmpty(model.ponumber) && string.IsNullOrEmpty(szquote.PONo) && szquote.SZ_CompanyList.IsApprovedFirst == true)
                            {
                                szquotedetails.ActivityStatus = "Approval First";
                            }
                            if (string.IsNullOrEmpty(szquote.CreatedBy))
                            {
                                szquote.CreatedBy = SessionCookieManagement.UserName;
                            }
                            szquotedetails.IsSynthesisLog = false;
                            szquote.PONo = model.ponumber;
                            db.Entry(szquote).State = EntityState.Modified;
                        }
                    }

                    szquotedetails.AddTestCost = model.addTestCost;
                    szquotedetails.AddTestCostRemark = model.addTestCostRemark;
                    if (!string.IsNullOrEmpty(szquotedetails.AddTestCostRemark))
                    {
                        szquotedetails.Remark = szquotedetails.AddTestCostRemark.Replace("(p)", "").Replace("(f)", "");
                    }
                    szquotedetails.ColdShipCost = model.coldShipCost;
                    szquotedetails.ColdShipCostRemark = model.coldShipCostRemark;
                    szquotedetails.TracebilityCostRemark = model.tracebilityCostRemark;
                    szquotedetails.TracebilityCost = model.tracebilityCost;
                    szquotedetails.TechnicalEmail = model.technicalEmail;
                    if (!string.IsNullOrEmpty(szquotedetails.TracebilityCostRemark))
                    {
                        szquotedetails.Remark += ", " + szquotedetails.TracebilityCostRemark.Replace("(p)", "").Replace("(f)", "");
                    }

                    szquotedetails.IsSuccessSAP = false;

                    db.Entry(szquotedetails).State = EntityState.Modified;
                    db.SaveChanges();

                    PrepareQuoteLog(szquote, oldSzQuoteModel);
                    PrepareQuoteDetailsLog(szquotedetails, oldModel);
                }
                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }



        [HttpPost]
        [ValidateInput(false)]
        public ActionResult UpdateNewProductInfo(List<ProductInfo> mainmodel)
        {
            try
            {
                foreach (var model in mainmodel)
                {
                    var oldSzQuoteModel = new SZ_Quotation();
                    var szquotedetails = _operationRepository.GetQuoteDetailByID(model.id);
                    if (szquotedetails != null)
                    {
                        if (!string.IsNullOrEmpty(model.catNo))
                        {
                            model.catNo = model.catNo.Trim();
                        }
                        oldSzQuoteModel = LogManagement.PrepareQuoteEntity(szquotedetails.SZ_Quotation);
                        var oldModel = LogManagement.PrepareQuoteDetailEntity(szquotedetails);

                        szquotedetails.InternalComment = model.internalComment;
                        szquotedetails.ProductRemark = model.productremark;
                        szquotedetails.ProductName = model.ProductName;
                        if (!string.IsNullOrEmpty(model.batchno) && model.batchno != "undefined")
                        {
                            model.batchno = model.batchno.Trim();
                            szquotedetails.QuoteBatchNo = model.batchno.Trim().Split(' ')[0].Trim();
                        }
                        else
                        {
                            szquotedetails.QuoteBatchNo = "0";
                        }
                        if (model.followUpRemark != "undefined")
                        {
                            szquotedetails.FollowUpRemark = model.followUpRemark;
                        }
                        if (model.followUpRemarkSecond != "undefined")
                        {
                            szquotedetails.FollowUpRemarkSecond = model.followUpRemarkSecond;
                        }
                        szquotedetails.CASNo = model.casno;
                        if (!string.IsNullOrEmpty(model.catNo))
                        {
                            var proData = db.Products.Where(x => x.Published == true && x.Deleted == false && x.Sku.ToLower().Trim() == model.catNo.ToLower().Trim()).FirstOrDefault();
                            if (proData != null)
                            {
                                szquotedetails.ProductId = proData.Id;
                                if (szquotedetails.CATNo != model.catNo)
                                {
                                    szquotedetails.CASNo = proData.ManufacturerPartNumber;
                                }
                                if (string.IsNullOrEmpty(szquotedetails.CASNo))
                                {
                                    szquotedetails.CASNo = proData.ManufacturerPartNumber;
                                }
                                szquotedetails.IsUploadServer = true;
                            }
                            else
                            {
                                szquotedetails.ProductId = 0;
                                szquotedetails.IsUploadServer = false;
                            }
                        }
                        else
                        {
                            szquotedetails.ProductId = 0;
                            szquotedetails.IsUploadServer = false;
                        }

                        szquotedetails.CATNo = model.catNo;
                        szquotedetails.Price = model.price;
                        szquotedetails.LeadTime = model.leadtime;
                        szquotedetails.DisplayOrder = model.displayOrder;
                        szquotedetails.ItemDiscount = model.discount;
                        if (!string.IsNullOrEmpty(model.estimateDispatchDate))
                        {
                            szquotedetails.EstimateDispatchDate = Convert.ToDateTime(model.estimateDispatchDate);
                        }
                        else
                        {
                            szquotedetails.EstimateDispatchDate = null;
                        }

                        if ("undefined" == szquotedetails.BatchNo || string.IsNullOrEmpty(szquotedetails.BatchNo))
                        {
                            szquotedetails.BatchNo = "";
                        }

                        if (model.actionname == "partialproductupdate")
                        {
                            szquotedetails.IsSynthesisLog = model.synthesislog;
                            szquotedetails.FinalPrice = model.finalprice;
                        }
                        if (model.actionname == "all")
                        {
                            szquotedetails.FinalPrice = model.finalprice;
                            szquotedetails.COAId = model.coa;
                            szquotedetails.ActivityStatus = model.ActivityStatus;
                        }

                        if (model.actionname == "followup")
                        {
                            if (szquotedetails.ContactDetail != model.contactdetail)
                            {
                                szquotedetails.IsFollowUpAdminChange = true;
                                //szquotedetails.IsFollowupChange = false;
                            }
                            szquotedetails.ContactDetail = model.contactdetail;
                        }

                        var szquote = _operationRepository.GetQuoteByID(szquotedetails.QuoteId);
                        if (szquote != null)
                        {
                            if (model.ponumber != "undefined" && model.ponumber != null)
                            {
                                //TODO: Stoped PO Update Date
                                //if (!string.IsNullOrEmpty(model.ponumber) && string.IsNullOrEmpty(szquote.PONo))
                                //{
                                //    szquote.PODate = DateTime.Now;
                                //}


                                //if (!string.IsNullOrEmpty(model.ponumber) && string.IsNullOrEmpty(szquote.PONo) && szquote.CountryType == "Export")
                                //{
                                //    szquotedetails.ActivityStatus = "Approval First";
                                //}
                                if (!string.IsNullOrEmpty(model.ponumber) && string.IsNullOrEmpty(szquote.PONo) && szquote.SZ_CompanyList.IsApprovedFirst == true)
                                {
                                    szquotedetails.ActivityStatus = "Approval First";
                                }
                                if (string.IsNullOrEmpty(szquote.CreatedBy))
                                {
                                    szquote.CreatedBy = SessionCookieManagement.UserName;
                                }
                                szquotedetails.IsSynthesisLog = false;
                                szquote.PONo = model.ponumber;
                                db.Entry(szquote).State = EntityState.Modified;
                            }
                        }

                        szquotedetails.AddTestCost = model.addTestCost;
                        szquotedetails.AddTestCostRemark = model.addTestCostRemark;
                        if (!string.IsNullOrEmpty(szquotedetails.AddTestCostRemark))
                        {
                            szquotedetails.Remark = szquotedetails.AddTestCostRemark.Replace("(p)", "").Replace("(f)", "");
                        }
                        szquotedetails.ColdShipCost = model.coldShipCost;
                        szquotedetails.ColdShipCostRemark = model.coldShipCostRemark;
                        szquotedetails.TracebilityCostRemark = model.tracebilityCostRemark;
                        szquotedetails.TracebilityCost = model.tracebilityCost;
                        szquotedetails.IsControlledSubstanceCharge = model.iscontrolledsubstancecharge;
                        szquotedetails.TechnicalEmail = model.technicalEmail;
                        if (!string.IsNullOrEmpty(szquotedetails.TracebilityCostRemark))
                        {
                            szquotedetails.Remark += ", " + szquotedetails.TracebilityCostRemark.Replace("(p)", "").Replace("(f)", "");
                        }

                        szquotedetails.IsSuccessSAP = false;

                        db.Entry(szquotedetails).State = EntityState.Modified;
                        db.SaveChanges();

                        PrepareQuoteLog(szquote, oldSzQuoteModel);
                        PrepareQuoteDetailsLog(szquotedetails, oldModel);
                    }
                }

                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult UpdateProductInfoAndCheck(List<ProductInfo> modelss, int compId)
        {
            try
            {
                foreach (var model in modelss)
                {
                    var szquotedetails = _operationRepository.GetQuoteDetailByID(model.id);
                    if (szquotedetails != null)
                    {
                        var oldModel = LogManagement.PrepareQuoteDetailEntity(szquotedetails);
                        szquotedetails.ProductRemark = model.productremark;
                        szquotedetails.ProductName = model.ProductName;
                        if (!string.IsNullOrEmpty(model.batchno) && model.batchno != "undefined")
                        {
                            model.batchno = model.batchno.Trim();
                            szquotedetails.QuoteBatchNo = model.batchno.Trim().Split(' ')[0].Trim();
                        }
                        else
                        {
                            szquotedetails.QuoteBatchNo = "0";
                        }
                        if (model.followUpRemark != "undefined")
                        {
                            szquotedetails.FollowUpRemark = model.followUpRemark;
                        }
                        if (model.followUpRemarkSecond != "undefined")
                        {
                            szquotedetails.FollowUpRemarkSecond = model.followUpRemarkSecond;
                        }
                        szquotedetails.CASNo = model.casno;
                        if (!string.IsNullOrEmpty(model.catNo))
                        {
                            var proData = db.Products.Where(x => x.Published == true && x.Deleted == false && x.Sku.ToLower().Trim() == model.catNo.ToLower().Trim()).FirstOrDefault();
                            if (proData != null)
                            {
                                szquotedetails.ProductId = proData.Id;
                                if (string.IsNullOrEmpty(szquotedetails.CASNo))
                                {
                                    szquotedetails.CASNo = proData.ManufacturerPartNumber;
                                }
                                szquotedetails.IsUploadServer = true;
                            }
                            else
                            {
                                szquotedetails.ProductId = 0;
                                szquotedetails.IsUploadServer = false;
                            }
                        }
                        else
                        {
                            szquotedetails.ProductId = 0;
                            szquotedetails.IsUploadServer = false;
                        }
                        szquotedetails.CATNo = model.catNo;
                        szquotedetails.Price = model.price;
                        szquotedetails.LeadTime = model.leadtime;
                        szquotedetails.DisplayOrder = model.displayOrder;
                        szquotedetails.ItemDiscount = model.discount;
                        if (!string.IsNullOrEmpty(model.estimateDispatchDate))
                        {
                            szquotedetails.EstimateDispatchDate = Convert.ToDateTime(model.estimateDispatchDate);
                        }
                        else
                        {
                            szquotedetails.EstimateDispatchDate = null;
                        }
                        if ("undefined" == szquotedetails.BatchNo || string.IsNullOrEmpty(szquotedetails.BatchNo))
                        {
                            szquotedetails.BatchNo = "";
                        }
                        if (model.actionname == "partialproductupdate")
                        {
                            szquotedetails.IsSynthesisLog = model.synthesislog;
                            szquotedetails.FinalPrice = model.finalprice;
                        }
                        if (model.actionname == "all")
                        {
                            szquotedetails.FinalPrice = model.finalprice;
                        }
                        if (model.actionname == "followup")
                        {
                            if (szquotedetails.ContactDetail != model.contactdetail)
                            {
                                szquotedetails.IsFollowUpAdminChange = true;
                            }
                            szquotedetails.ContactDetail = model.contactdetail;
                        }
                        var szquote = _operationRepository.GetQuoteByID(szquotedetails.QuoteId);
                        if (szquote != null)
                        {
                            if (model.ponumber != "undefined" && model.ponumber != null)
                            {
                                //TODO: Stoped PO Update Date
                                //if (!string.IsNullOrEmpty(model.ponumber) && string.IsNullOrEmpty(szquote.PONo))
                                //{
                                //    szquote.PODate = DateTime.Now;
                                //}
                                szquote.PONo = model.ponumber;
                                db.Entry(szquote).State = EntityState.Modified;
                                szquotedetails.IsSynthesisLog = false;
                            }
                        }

                        szquotedetails.IsSuccessSAP = false;
                        db.Entry(szquotedetails).State = EntityState.Modified;
                        db.SaveChanges();

                        PrepareQuoteDetailsLog(szquotedetails, oldModel);
                    }
                }

                // check old history data
                var sixmonth = DateTime.Now.AddMonths(-6);
                var threemonth = DateTime.Now.AddMonths(-6);
                var oldszquotedetails = new List<SZ_QuotationDetail>();
                var quotedetailsPriceList = new List<SuggestedPriceListModel>();
                foreach (var model in modelss)
                {
                    var pricelist = new List<string>();
                    if (!string.IsNullOrEmpty(model.price))
                    {
                        var splitrecords = model.price.Split(',');
                        foreach (var item in splitrecords)
                        {
                            pricelist.Add(item.Split(' ')[0].Trim() + " mg");
                        }
                    }
                    var catno = model.catNo;
                    foreach (var price in pricelist)
                    {
                        var quotedatas = _operationRepository.GetQuoteDetailByID(model.id);
                        var szquotedetails = db.SZ_QuotationDetail.Where(x => x.SZ_Quotation.CountryType == quotedatas.SZ_Quotation.CountryType && x.Price.Contains(price) && x.CATNo == catno && x.SZ_Quotation.CreatedDate >= sixmonth && x.SZ_Quotation.CompanyId == compId && x.Id != model.id).OrderByDescending(x => x.CreatedDate).FirstOrDefault();
                        if (szquotedetails != null)
                        {
                            oldszquotedetails.Add(szquotedetails);
                        }
                        else
                        {
                            var szquotedetailsother = db.SZ_QuotationDetail.Where(x => x.SZ_Quotation.CountryType == quotedatas.SZ_Quotation.CountryType && x.Price.Contains(price) && x.CATNo == catno && x.SZ_Quotation.CreatedDate >= threemonth && x.SZ_Quotation.CompanyId != compId && x.Id != model.id).OrderByDescending(x => x.CreatedDate).FirstOrDefault();
                            if (szquotedetailsother != null)
                            {
                                oldszquotedetails.Add(szquotedetailsother);
                            }
                        }
                    }

                    //var szquotedetails = db.SZ_QuotationDetail.Where(x => pricelist.Contains(x.Price) && x.CATNo == catno && x.SZ_Quotation.CreatedDate >= sixmonth && x.SZ_Quotation.CompanyId == compId && x.Id != model.id).OrderByDescending(x=>x.CreatedDate).FirstOrDefault();
                    //if (szquotedetails != null)
                    //{
                    //    oldszquotedetails.Add(szquotedetails);
                    //}
                    //else
                    //{
                    //    var szquotedetailsother = db.SZ_QuotationDetail.Where(x => pricelist.Contains(x.Price) && x.CATNo == catno && x.SZ_Quotation.CreatedDate >= threemonth && x.SZ_Quotation.CompanyId != compId && x.Id != model.id).OrderByDescending(x => x.CreatedDate).FirstOrDefault();
                    //    if (szquotedetailsother != null)
                    //    {
                    //        oldszquotedetails.Add(szquotedetailsother);
                    //    }
                    //}
                }


                var htmlstring = PartialViewdata(this, "_PartialCheckQuoteHistoryData", oldszquotedetails);


                return Json(new
                {
                    success = true,
                    html = htmlstring
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        public ActionResult ProductListBycategory(string ProductName)
        {
            try
            {
                string uri = Domain + "/api/RestAPI/ProductListBycategory?ProductName=" + ProductName.Trim();
                using (HttpClient httpClient = new HttpClient())
                {
                    Task<String> response = httpClient.GetStringAsync(uri);
                    string productModel = JsonConvert.DeserializeObject<string>(response.Result);
                    var ProductOutputModel = JsonConvert.DeserializeObject<List<ProductOverviewModel>>(productModel);
                    var htmlstring = PartialViewdata(this, "_PartialFindProductList", ProductOutputModel);

                    return new JsonResult()
                    {
                        JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                        Data = new { type = "success", data = ProductOutputModel, html = htmlstring }
                    };
                }
            }
            catch (Exception ex)
            {
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { type = "fail", data = ex.Message }
                };
            }

        }

        public ActionResult saveFindProductData(List<int> ids, string uniqueId, int quoteId = 0, int companyId = 0) // ids are null
        {
            Guid tempGuid = Guid.Parse(uniqueId);
            string uri = Domain + "/api/RestAPI/ProductDetailsByProductids?id=" + string.Join(",", ids);
            using (HttpClient httpClient = new HttpClient())
            {
                Task<String> response = httpClient.GetStringAsync(uri);
                string productModel = JsonConvert.DeserializeObject<string>(response.Result);
                var productlist = JsonConvert.DeserializeObject<List<ProductDetailsModel>>(productModel);
                int? maxDisplayOrderNo = db.SZ_QuotationDetail.Where(x => x.QuoteId == quoteId).Max(x => x.DisplayOrder);
                if (maxDisplayOrderNo.HasValue)
                {
                    maxDisplayOrderNo += 1;
                }
                else
                {
                    maxDisplayOrderNo = 1;
                }
                foreach (var product in productlist)
                {
                    string pname = string.Empty;
                    if (product != null)
                    {
                        if (product.ManufacturerPartNumber.ToLower() != "na" && product.ManufacturerPartNumber.ToLower() != "n/a")
                        {
                            pname = product.ManufacturerPartNumber;
                        }
                    }

                    var productsamedata = db.Products.Where(x => x.ManufacturerPartNumber == pname.Trim() && x.Id != product.Id && x.Published == true && x.Deleted == false).ToList();
                    var pRemark = string.Empty;
                    if (productsamedata != null && productsamedata.Count > 1)
                    {
                        List<string> sameAsArray = new List<string>();
                        foreach (var item in productsamedata)
                        {
                            if (product.Id != item.Id && !sameAsArray.Contains(item.Sku))
                            {
                                if (!string.IsNullOrEmpty(item.ManufacturerPartNumber) && item.ManufacturerPartNumber != "N/A" && item.ManufacturerPartNumber != "NA")
                                {
                                    sameAsArray.Add(item.Sku);
                                }
                            }
                        }
                        //pRemark = "Also Known as " + string.Join(", ", sameAsArray);
                    }
                    SZ_QuotationDetail objTemp = new SZ_QuotationDetail();
                    objTemp.ProductId = product.Id;
                    objTemp.CASNo = product.ManufacturerPartNumber;
                    objTemp.CreatedDate = DateTime.Now;
                    objTemp.IsUploadServer = true;
                    //objTemp.BackNoDetail = string.Join(", ", product.InventoryModel.Select(x => x.BatchNo + " (" + x.Qty + ")"));
                    objTemp.ImagePath = product.DefaultPictureModel.ImageUrl;
                    objTemp.ProductName = product.Name;
                    objTemp.CATNo = product.Sku;
                    objTemp.QuoteId = quoteId;
                    objTemp.IsSynthesisLog = false;
                    objTemp.ProductRemark = pRemark;
                    if (product != null && product.InventoryModel.Count() > 0)
                    {
                        objTemp.LeadTime = "In-Stock";
                    }

                    if (companyId != null)
                    {
                        var oldproductData = (from i in db.SZ_Quotation
                                              join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                                              where t2.MoveToProject == true && !string.IsNullOrEmpty(i.PONo) && i.CompanyId == companyId &&
                                              t2.ProductId == objTemp.ProductId
                                              select i).Distinct().ToList();
                        if (oldproductData != null && oldproductData.Count > 0 && !string.IsNullOrEmpty(objTemp.CATNo))
                        {
                            objTemp.ProductRemark += " Earlier PO Ref # " + string.Join(", ", oldproductData.OrderByDescending(x => x.Id).Select(x => x.PONo).Take(5));
                            //objTemp.ProductRemark += "  Ref # " + string.Join(", ", oldproductData.Select(x => x.Ref));
                        }
                    }
                    //var pricedata = db.SZ_PriceList.Where(x => x.ProductId == product.Id).FirstOrDefault();
                    //if (pricedata != null)
                    //{
                    //    int discount = 0;
                    //    if (!string.IsNullOrEmpty(pricedata.DiscountINR))
                    //    {
                    //        discount = Convert.ToInt32(discount);
                    //    }

                    //    List<string> objData = new List<string>();
                    //    if (!string.IsNullOrEmpty(pricedata.TenPrice))
                    //    {
                    //        objData.Add("10 mg@" + calculatePerc(pricedata.TenPrice, discount) + " INR+");
                    //    }
                    //    if (!string.IsNullOrEmpty(pricedata.TwentyFivePrice))
                    //    {
                    //        objData.Add("25 mg@" + calculatePerc(pricedata.TwentyFivePrice, discount) + " INR+");
                    //    }
                    //    if (!string.IsNullOrEmpty(pricedata.FiftyPrice))
                    //    {
                    //        objData.Add("50 mg@" + calculatePerc(pricedata.FiftyPrice, discount) + " INR+");
                    //    }
                    //    if (!string.IsNullOrEmpty(pricedata.HundredPrice))
                    //    {
                    //        objData.Add("100 mg@" + calculatePerc(pricedata.HundredPrice, discount) + " INR+");
                    //    }
                    //    if (!string.IsNullOrEmpty(pricedata.TwoHundredPrice))
                    //    {
                    //        objData.Add("200 mg@" + calculatePerc(pricedata.TwoHundredPrice, discount) + " INR+");
                    //    }
                    //    if (!string.IsNullOrEmpty(pricedata.LeadTime))
                    //    {
                    //        objTemp.LeadTime = pricedata.LeadTime;
                    //    }
                    //    objTemp.Price = string.Join(", ", objData);
                    //}
                    objTemp.DisplayOrder = maxDisplayOrderNo;

                    var productdata = db.Products.Where(x => x.Id == product.Id).FirstOrDefault();
                    if (productdata != null)
                    {
                        if (!string.IsNullOrEmpty(objTemp.ProductRemark))
                        {
                            objTemp.ProductRemark += " ,";
                        }
                        if (productdata.ShippingCondition == "Cold Shipment")
                        {
                            objTemp.ProductRemark += " Cold Shipment Required";
                        }
                        if (!string.IsNullOrEmpty(productdata.ProductRemark))
                        {
                            objTemp.ProductRemark = productdata.ProductRemark + ", " + objTemp.ProductRemark;
                        }
                    }

                    db.SZ_QuotationDetail.Add(objTemp);
                    maxDisplayOrderNo += 1;
                }
                db.SaveChanges();
            }
            return new JsonResult()
            {
                JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                Data = new { type = "success" }
            };
        }

        public ActionResult CheckDuplicateQuote(int companyId, string catno)
        {
            catno = catno.Trim().ToLower();
            var compData = db.SZ_CompanyList.Where(x => x.Id == companyId).FirstOrDefault();
            if (compData == null)
            {
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { type = "notfound" }
                };
            }
            //var data = db.SZ_Quotation.Where(x => x.CompanyName.ToLower() == compData.Name.ToLower() && string.IsNullOrEmpty(x.PONo)).FirstOrDefault();
            var data = (from i in db.SZ_Quotation
                        join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                        where string.IsNullOrEmpty(i.PONo) && i.CompanyName.Trim().ToLower() == compData.Name.Trim().ToLower()
                        && t2.CATNo.ToLower() == catno
                        //&& t2.CreatedDate.AddDays(7).Date >= DateTime.Now.Date  
                        orderby t2.CreatedDate descending
                        select t2).ToList();
            if (data != null && data.Count() > 0)
            {
                var filterdata = (from t2 in data
                                  where t2.CreatedDate.Date >= DateTime.Now.Date.AddDays(-15)
                                  select t2).ToList();

                if (filterdata != null && filterdata.Count() > 0)
                {
                    SZ_Quotation objquote = new SZ_Quotation();
                    objquote.CompanyName = filterdata[0].SZ_Quotation.CompanyName;
                    objquote.EmailAddress = filterdata[0].SZ_Quotation.EmailAddress;
                    objquote.Ref = filterdata[0].SZ_Quotation.Ref;
                    objquote.Id = filterdata[0].SZ_Quotation.Id;
                    List<SZ_QuotationDetail> objdetails = new List<SZ_QuotationDetail>();

                    foreach (var i in filterdata)
                    {
                        SZ_QuotationDetail obj = new SZ_QuotationDetail();
                        obj.ProductName = i.ProductName;
                        obj.CASNo = i.CASNo;
                        obj.CATNo = i.CATNo;
                        obj.Price = i.Price;
                        obj.LeadTime = i.LeadTime;
                        objdetails.Add(obj);
                    }
                    return new JsonResult()
                    {
                        JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                        Data = new { type = "available", quotation = objquote, quotationdetail = objdetails }
                    };
                }
            }

            return new JsonResult()
            {
                JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                Data = new { type = "notfound" }
            };
        }

        public int calculatePerc(string price, int discount)
        {

            var divide = (Convert.ToDecimal(price) * discount / 100);

            var calcPrice = Convert.ToInt32((Convert.ToDecimal(price) - divide));
            return calcPrice;
        }

        public ActionResult GetPurchaseExcelData(string casno)
        {
            casno = casno.ToLower().Trim();
            var data = db.SZ_PurchaseSupplierCatalogue.Where(x => x.CASNo.Trim().ToLower() == casno).OrderBy(x => x.Make.Contains("USP")).ToList();
            return Json(data, JsonRequestBehavior.AllowGet);
        }

        public ActionResult ProductDetailsBynamecasandcat(string ProductName, string casno = null, string catNo = null)
        {
            var product = db.Products.Where(x => x.Sku == ProductName && (x.Published == true || x.IsShowQuote == true) && x.Deleted == false).FirstOrDefault();
            if (product != null)
            {
                if (!string.IsNullOrEmpty(product.ManufacturerPartNumber))
                {
                    product.ManufacturerPartNumber = product.ManufacturerPartNumber.Trim();
                }
                if (product.ManufacturerPartNumber.ToLower() != "na" && product.ManufacturerPartNumber.ToLower() != "n/a")
                {
                    ProductName = product.ManufacturerPartNumber;
                }
            }
            string uri = Domain + "/api/RestAPI/ProductDetailsBynamecasandcat?ProductName=" + ProductName.Trim() + "&casno=" + casno + "&catNo=" + catNo;
            try
            {
                using (HttpClient httpClient = new HttpClient())
                {
                    Task<String> response = httpClient.GetStringAsync(uri);
                    if (string.IsNullOrEmpty(response.Result))
                    {
                        return new JsonResult()
                        {
                            JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                            Data = new { type = "fail", data = "Response result blank" + response.Result }
                        };
                    }
                    string productModel = JsonConvert.DeserializeObject<string>(response.Result);
                    var ProductOutputModel = JsonConvert.DeserializeObject<List<ProductOverviewModel>>(productModel);

                    if (ProductOutputModel.Count == 1)
                    {
                        if (!string.IsNullOrEmpty(ProductOutputModel[0].CasNo) && ProductOutputModel[0].CasNo.ToLower().Trim() != "na" && ProductOutputModel[0].CasNo.ToLower().Trim() != "n/a")
                        {
                            string urisecond = Domain + "/api/RestAPI/ProductDetailsBynamecasandcat?ProductName=" + ProductOutputModel[0].CasNo.Trim() + "&casno=" + casno + "&catNo=" + catNo;

                            using (HttpClient httpClientsecond = new HttpClient())
                            {
                                Task<String> responsesecond = httpClientsecond.GetStringAsync(urisecond);
                                if (!string.IsNullOrEmpty(responsesecond.Result))
                                {
                                    string productModelsecond = JsonConvert.DeserializeObject<string>(responsesecond.Result);
                                    ProductOutputModel = JsonConvert.DeserializeObject<List<ProductOverviewModel>>(productModelsecond);
                                }
                            }
                        }
                    }

                    var isApi = db.Categories.Where(x => x.Name.Trim().ToLower() == ProductName.Trim().ToLower()).Any();
                    var latestPurchaseSummary = "";
                    if (product != null)
                    {
                        latestPurchaseSummary = db.SZ_QuotationDetail.Where(x => x.ProductId == product.Id && !string.IsNullOrEmpty(x.PurchaseStatus)).Select(x => x.PurchaseStatus).FirstOrDefault();
                    }

                    foreach (var i in ProductOutputModel)
                    {
                        i.PurchaseSummary = latestPurchaseSummary;
                        if (i.InventoryModel != null && i.InventoryModel.Count > 0)
                        {
                            foreach (var item in i.InventoryModel)
                            {
                                if (item.AvailableQty.HasValue)
                                {
                                    decimal availQty = Convert.ToDecimal(item.AvailableQty.Value);
                                    if (availQty < 0)
                                    {
                                        availQty = 0;
                                    }
                                    item.Qty = availQty;
                                }
                                else
                                {
                                    item.Qty = 0;
                                }
                            }
                        }

                        if (!string.IsNullOrEmpty(casno) && i.CasNo != "N/A" && i.CasNo != "NA")
                        {
                            var allproductcas = db.Products.Where(x => x.ManufacturerPartNumber.Trim() == i.CasNo.Trim() && x.Id != i.Id && x.Published == true && x.Deleted == false).ToList();
                            if (allproductcas != null && allproductcas.Count > 0)
                            {
                                foreach (var allp in allproductcas)
                                {
                                    var inventory = db.SZ_Inventory.Where(x => x.ProductId == allp.Id).ToList();
                                    if (inventory != null && inventory.Count > 0)
                                    {
                                        foreach (var k in inventory)
                                        {
                                            Synzeal_Inventory.Models.ProductDetailsModel.ProductSZInventoryModel obj = new ProductDetailsModel.ProductSZInventoryModel();
                                            obj.BatchNo = k.BatchNo;
                                            obj.Qty = k.Qty.HasValue ? k.Qty.Value : 0;
                                            if (k.AvailableQty.HasValue)
                                            {
                                                decimal availQty = Convert.ToDecimal(k.AvailableQty.Value);
                                                if (availQty < 0)
                                                {
                                                    availQty = 0;
                                                }
                                                obj.Qty = availQty;
                                            }
                                            i.InventoryModel.Add(obj);
                                        }
                                    }
                                }
                            }
                        }

                        var pricedata = db.SZ_PriceList.Where(x => x.ProductId == i.Id && (x.IsUsd == false || x.IsUsd == null)).FirstOrDefault();
                        if (pricedata != null)
                        {
                            i.PriceModel = new ProductPriceModel();
                            i.PriceModel.Id = pricedata.Id;
                            i.PriceModel.DiscountINR = pricedata.DiscountINR;
                            i.PriceModel.DiscountUSD = pricedata.DiscountUSD;
                            i.PriceModel.LeadTime = pricedata.LeadTime;
                            i.PriceModel.TenPrice = pricedata.TenPrice;
                            i.PriceModel.TenUSD = pricedata.TenUSD;
                            i.PriceModel.TwentyFivePrice = pricedata.TwentyFivePrice;
                            i.PriceModel.TwentyfiveUSD = pricedata.TwentyfiveUSD;
                            i.PriceModel.FiftyPrice = pricedata.FiftyPrice;
                            i.PriceModel.FiftyUSD = pricedata.FiftyUSD;
                            i.PriceModel.HundredPrice = pricedata.HundredPrice;
                            i.PriceModel.OnehundredUSD = pricedata.OnehundredUSD;
                            i.PriceModel.TwoHundredPrice = pricedata.TwoHundredPrice;
                            i.PriceModel.TwohundredFiftyUSD = pricedata.TwohundredFiftyUSD;
                            i.PriceModel.FivehundredPrice = pricedata.FivehundredPrice;
                            i.PriceModel.FivehundredUSD = pricedata.FivehundredUSD;
                            i.PriceModel.OneThousandPrice = pricedata.OneThousandPrice;
                            i.PriceModel.OneThousandUSD = pricedata.OneThousandUSD;
                            i.PriceModel.IsPriceApproved = pricedata.IsPriceApproved;
                            int discount = 0;
                            if (!string.IsNullOrEmpty(pricedata.DiscountINR))
                            {
                                discount = Convert.ToInt32(pricedata.DiscountINR);
                            }
                            List<string> objData = new List<string>();
                            if (!string.IsNullOrEmpty(pricedata.TenPrice))
                            {
                                objData.Add("10 mg@" + calculatePerc(pricedata.TenPrice, discount) + " INR+");
                            }
                            if (!string.IsNullOrEmpty(pricedata.TwentyFivePrice))
                            {
                                objData.Add("25 mg@" + calculatePerc(pricedata.TwentyFivePrice, discount) + " INR+");
                            }
                            if (!string.IsNullOrEmpty(pricedata.FiftyPrice))
                            {
                                objData.Add("50 mg@" + calculatePerc(pricedata.FiftyPrice, discount) + " INR+");
                            }
                            if (!string.IsNullOrEmpty(pricedata.HundredPrice))
                            {
                                objData.Add("100 mg@" + calculatePerc(pricedata.HundredPrice, discount) + " INR+");
                            }
                            if (!string.IsNullOrEmpty(pricedata.TwoHundredPrice))
                            {
                                objData.Add("200 mg@" + calculatePerc(pricedata.TwoHundredPrice, discount) + " INR+");
                            }
                            if (!string.IsNullOrEmpty(pricedata.LeadTime))
                            {
                                i.LeadTime = pricedata.LeadTime;
                            }

                            i.INRPrice = string.Join(", ", objData);
                        }

                        var priceusddata = db.SZ_PriceList.Where(x => x.ProductId == i.Id && x.IsUsd == true).FirstOrDefault();
                        if (priceusddata != null)
                        {
                            if (i.PriceModel == null)
                            {
                                i.PriceModel = new ProductPriceModel();
                            }
                            i.PriceModel.Id = pricedata.Id;
                            i.PriceModel.DiscountUSD = pricedata.DiscountUSD;
                            i.PriceModel.LeadTime = pricedata.LeadTime;
                            i.PriceModel.TenUSD = pricedata.TenUSD;
                            i.PriceModel.TwentyfiveUSD = pricedata.TwentyfiveUSD;
                            i.PriceModel.FiftyUSD = pricedata.FiftyUSD;
                            i.PriceModel.OnehundredUSD = pricedata.OnehundredUSD;
                            i.PriceModel.TwohundredFiftyUSD = pricedata.TwohundredFiftyUSD;
                            i.PriceModel.FivehundredUSD = pricedata.FivehundredUSD;
                            i.PriceModel.OneThousandUSD = pricedata.OneThousandUSD;

                            int discount = 0;
                            if (!string.IsNullOrEmpty(pricedata.DiscountINR))
                            {
                                discount = Convert.ToInt32(pricedata.DiscountINR);
                            }
                            List<string> objData = new List<string>();
                            if (!string.IsNullOrEmpty(pricedata.TenUSD))
                            {
                                objData.Add("10 mg@" + calculatePerc(pricedata.TenUSD, discount) + " USD+");
                            }
                            if (!string.IsNullOrEmpty(pricedata.TwentyfiveUSD))
                            {
                                objData.Add("25 mg@" + calculatePerc(pricedata.TwentyfiveUSD, discount) + " USD+");
                            }
                            if (!string.IsNullOrEmpty(pricedata.FiftyUSD))
                            {
                                objData.Add("50 mg@" + calculatePerc(pricedata.FiftyUSD, discount) + " USD+");
                            }
                            if (!string.IsNullOrEmpty(pricedata.OnehundredUSD))
                            {
                                objData.Add("100 mg@" + calculatePerc(pricedata.OnehundredUSD, discount) + " USD+");
                            }
                            if (!string.IsNullOrEmpty(pricedata.TwohundredFiftyUSD))
                            {
                                objData.Add("250 mg@" + calculatePerc(pricedata.TwohundredFiftyUSD, discount) + " USD+");
                            }
                            if (!string.IsNullOrEmpty(pricedata.FivehundredUSD))
                            {
                                objData.Add("500 mg@" + calculatePerc(pricedata.FivehundredUSD, discount) + " USD+");
                            }
                            if (!string.IsNullOrEmpty(pricedata.OneThousandUSD))
                            {
                                objData.Add("1000 mg@" + calculatePerc(pricedata.OneThousandUSD, discount) + " USD+");
                            }
                            if (!string.IsNullOrEmpty(pricedata.LeadTime))
                            {
                                i.LeadTime = pricedata.LeadTime;
                            }
                            i.USDPrice = string.Join(", ", objData);
                        }
                    }



                    return new JsonResult()
                    {
                        JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                        MaxJsonLength = Int32.MaxValue,
                        Data = new { type = "success", data = ProductOutputModel, PurchaseSummary = latestPurchaseSummary, isApi = isApi }
                    };
                }
            }
            catch (Exception ex)
            {
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    MaxJsonLength = Int32.MaxValue,
                    Data = new { type = "fail", data = ex.LineNumber() + " / " + ex.Message + " / Stack :" + ex.StackTrace + " / URL : " + uri }
                };
            }
        }

        public ActionResult getProductDetailsByQuoteDetailsId(int id)
        {
            try
            {
                var model = (from x in db.SZ_QuotationDetail
                             where x.Id == id
                             select x).FirstOrDefault();
                var obj = new
                {
                    ProductId = model.ProductId,
                    ProductName = model.ProductName,
                    CASNo = model.CASNo,
                    ImagePath = model.ImagePath,
                    Price = model.Price,
                    LeadTime = model.LeadTime,
                    CATNo = model.CATNo,
                };

                if (!string.IsNullOrEmpty(model.CATNo))
                {
                    string uri = Domain + "/api/RestAPI/ProductDetailsBySku?sku=" + model.CATNo;
                    using (HttpClient httpClient = new HttpClient())
                    {
                        Task<String> response = httpClient.GetStringAsync(uri);
                        string productModel = JsonConvert.DeserializeObject<string>(response.Result);
                        var ProductOutputModel = JsonConvert.DeserializeObject<ProductDetailsModel>(productModel);
                        return new JsonResult()
                        {
                            JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                            Data = new { record = obj, inventoryModel = ProductOutputModel.InventoryModel, success = true }
                        };
                    }
                }
                else
                {
                    var ProductOutputModel = new ProductDetailsModel();
                    return new JsonResult()
                    {
                        JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                        Data = new { record = obj, inventoryModel = ProductOutputModel.InventoryModel, success = true }
                    };
                }
            }
            catch (Exception ex)
            {
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { record = ex.Message, success = false }
                };
            }
        }

        public ActionResult addPreviousProductByQuoteDetailsId(int id, int quoteId)
        {
            try
            {
                var model = (from x in db.SZ_QuotationDetail
                             where x.Id == id
                             select x).FirstOrDefault();
                var obj = new SZ_QuotationDetail
                {
                    ProductId = model.ProductId,
                    ProductName = model.ProductName,
                    CASNo = model.CASNo,
                    ImagePath = model.ImagePath,
                    Price = model.Price,
                    LeadTime = model.LeadTime,
                    CATNo = model.CATNo,
                    QuoteId = quoteId,
                    CreatedDate = DateTime.Now
                };

                db.SZ_QuotationDetail.Add(obj);
                db.SaveChanges();

                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { record = obj, success = true }
                };
            }
            catch (Exception ex)
            {
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { record = ex.Message, success = false }
                };
            }
        }

        public ActionResult addMultipleProduct(string catno, int company, int QuoteId)
        {
            try
            {
                int? maxDisplayOrderNo = db.SZ_QuotationDetail.Where(x => x.QuoteId == QuoteId).Max(x => x.DisplayOrder);
                if (maxDisplayOrderNo.HasValue)
                {
                    maxDisplayOrderNo += 1;
                }
                else
                {
                    maxDisplayOrderNo = 1;
                }
                string[] allCatNos = catno.Split(',');
                foreach (var sku in allCatNos)
                {
                    var skuno = sku.ToLower().Trim();
                    var model = db.Products.Where(x => x.Sku.ToLower() == skuno && x.Published == true && x.Deleted == false).FirstOrDefault();

                    //Insert logic save in temp table
                    SZ_QuotationDetail objTemp = new SZ_QuotationDetail();
                    objTemp.ProductId = model.Id;
                    objTemp.CASNo = model.ManufacturerPartNumber;
                    objTemp.CreatedDate = DateTime.Now;
                    objTemp.IsUploadServer = true;
                    objTemp.LeadTime = "";
                    objTemp.ProductName = model.Name;
                    objTemp.CATNo = model.Sku;
                    objTemp.QuoteId = QuoteId;
                    //objTemp.UniqueId = new Guid(UniqueId);
                    objTemp.IsSynthesisLog = false;
                    string uri = Domain + "/api/RestAPI/ProductDetails?productId=" + model.Id;
                    using (HttpClient httpClient = new HttpClient())
                    {
                        Task<String> response = httpClient.GetStringAsync(uri);
                        string productModel = JsonConvert.DeserializeObject<string>(response.Result);
                        var product = JsonConvert.DeserializeObject<ProductDetailsModel>(productModel);
                        if (product != null && product.InventoryModel != null)
                        {
                            objTemp.LeadTime = "In Stock";
                        }
                    }

                    var oldproductData = (from i in db.SZ_Quotation
                                          join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                                          where t2.MoveToProject == true && !string.IsNullOrEmpty(i.PONo) && i.CompanyId == company &&
                                          t2.ProductId == model.Id
                                          select i).Distinct().ToList();
                    if (oldproductData != null && oldproductData.Count > 0 && !string.IsNullOrEmpty(objTemp.CATNo))
                    {
                        objTemp.ProductRemark += " Earlier PO Ref # " + string.Join(", ", oldproductData.OrderByDescending(x => x.Id).Select(x => x.PONo).Take(5));
                        //objTemp.ProductRemark += "  Ref # " + string.Join(", ", oldproductData.Select(x => x.Ref));
                    }
                    objTemp.DisplayOrder = maxDisplayOrderNo;

                    var productdata = db.Products.Where(x => x.Id == model.Id).FirstOrDefault();
                    if (productdata != null)
                    {
                        if (!string.IsNullOrEmpty(objTemp.ProductRemark))
                        {
                            objTemp.ProductRemark += " ,";
                        }
                        if (productdata.ShippingCondition == "Cold Shipment")
                        {
                            objTemp.ProductRemark += " Cold Shipment Required";
                        }
                        if (!string.IsNullOrEmpty(productdata.ProductRemark))
                        {
                            objTemp.ProductRemark = productdata.ProductRemark + ", " + objTemp.ProductRemark;
                        }
                    }
                    db.SZ_QuotationDetail.Add(objTemp);

                    maxDisplayOrderNo += 1;
                    db.SaveChanges();
                }

                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult findProductPrice(SuggestedPriceListQuoteModel obj)
        {
            var outputModel = new List<SuggestedPriceListQuoteModel>();
            var item = obj;

            var quotedetailsPriceList = new List<SuggestedPriceListModel>();
            int quotedetailsId = 0;
            int quoteId = 0;
            var cid = 0;
            var countryType = "";
            string companyName = "";
            string searchValue = "";
            int productId = 0;
            var quoteData = _operationRepository.GetQuoteByID(item.quoteid);
            if (quoteData != null)
            {
                productId = quoteData.Id;
                companyName = quoteData.CompanyName;
                cid = quoteData.CompanyId.Value;
                countryType = quoteData.CountryType;
                quotedetailsId = 0;
                quoteId = quoteData.Id;
            }

            var productdata = db.Products.Where(x => x.Id == item.id).FirstOrDefault();
            if (productdata != null)
            {
                if (!string.IsNullOrEmpty(productdata.Sku))
                {
                    searchValue = productdata.Sku;
                }
                if (string.IsNullOrEmpty(searchValue) && productdata.ManufacturerPartNumber != "NA" && productdata.ManufacturerPartNumber != "N/A")
                {
                    searchValue = productdata.ManufacturerPartNumber;
                }
            }
            if (!string.IsNullOrEmpty(item.qty))
            {
                var allpricedata = item.qty.Split(',');
                foreach (var itemsdata in allpricedata)
                {
                    if (!string.IsNullOrEmpty(itemsdata))
                    {
                        var submodel = new SuggestedPriceListModel();
                        quotedetailsPriceList.Add(new SuggestedPriceListModel()
                        {
                            MG = Convert.ToInt32(itemsdata)
                        });
                    }
                }
            }

            if (quotedetailsPriceList.Count == 0)
            {
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { type = "fail", data = "Please enter qty of selected product" }
                };
            }

            string outputprice = "";
            DateTime startDate = DateTime.Now.AddYears(-1);
            DateTime endDate = DateTime.Now;

            outputprice = ExactPreparedPrice(cid.ToString(), searchValue, quotedetailsPriceList, quoteId, quotedetailsId, countryType);
            if (string.IsNullOrEmpty(outputprice))
            {
                outputprice = PreparedPrice(DateTime.MinValue, DateTime.Now.AddYears(-1), cid.ToString(), searchValue, quotedetailsPriceList, quoteId, quotedetailsId, countryType);
            }

            outputModel.Add(new SuggestedPriceListQuoteModel()
            {
                id = item.id,
                qty = outputprice,
                quoteid = item.quoteid
            });


            return new JsonResult()
            {
                JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                Data = new { type = "success", data = outputModel }
            };
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult UpdateCorrectionLog(CorrectionLogModel correctionLog)
        {
            var correctionlogData = db.SZ_QuoteDetail_Correctionlog.Where(x => x.QuoteId == correctionLog.quoteid && x.QuoteDetailsId == correctionLog.quotedetailsId && x.IsClosed == false).FirstOrDefault();
            if (correctionlogData == null)
            {
                var quotedata = db.SZ_Quotation.Where(x => x.Id == correctionLog.quoteid).OrderByDescending(x => x.Id).FirstOrDefault();
                // Insert a New Data
                correctionlogData = new SZ_QuoteDetail_Correctionlog();
                correctionlogData.QuoteBy = quotedata.CreatedBy;
                correctionlogData.QuoteId = correctionLog.quoteid;
                correctionlogData.QuoteDetailsId = correctionLog.quotedetailsId;
                correctionlogData.Remark = correctionLog.correctionLog;
                correctionlogData.CreatedDate = DateTime.Now;
                correctionlogData.CreatedBy = SessionCookieManagement.UserName;
                correctionlogData.IsClosed = false;
                db.SZ_QuoteDetail_Correctionlog.Add(correctionlogData);
                db.SaveChanges();
            }
            else
            {
                // Update a Data
                correctionlogData.Remark = correctionLog.correctionLog;
                db.Entry(correctionlogData).State = EntityState.Modified;
                db.SaveChanges();
            }

            return new JsonResult()
            {
                JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                Data = new { type = "success" }
            };
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult UpdateMasterQuoteProducts(List<MasterPriceQuoteModel> masterPriceQuoteModel, string currency = null, bool isOverright = false)
        {
            var overrightModel = new List<MasterPriceQuoteModel>();
            var comapnyData = new SZ_CompanyList();
            var countrytype = masterPriceQuoteModel[0].countrytype;
            if (countrytype == "Domestic")
            {
                comapnyData = db.SZ_CompanyList.Where(x => x.Name == "BD Master - Domestic").FirstOrDefault();
            }
            else
            {
                comapnyData = db.SZ_CompanyList.Where(x => x.Name == "BD Master - International").FirstOrDefault();
            }
            var data = "";
            if (!isOverright)
            {

                foreach (var item in masterPriceQuoteModel)
                {
                    var isOverrightPrice = false;
                    var quotedata = (from i in db.SZ_Quotation
                                     join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                                     where t2.CATNo == item.catno && i.CompanyId == comapnyData.Id
                                     select t2).FirstOrDefault();
                    var pricedatas = new List<SuggestedPriceListModel>();
                    if (quotedata != null)
                    {
                        var price = quotedata.Price;
                        var quoteprisplit = price.Split(',');
                        //10mg@ INR, 25mg@ INR, 50mg@ INR, 100mg@ INR

                        if (quoteprisplit != null && quoteprisplit.Count() > 0)
                        {
                            foreach (var pris in quoteprisplit)
                            {
                                if (!string.IsNullOrEmpty(pris))
                                {
                                    var objModel = new SuggestedPriceListModel();
                                    //10mg@ INR
                                    objModel.MG = Convert.ToInt32(Regex.Match(pris.Split('@')[0].Trim().ToString(), @"\d+").Value);
                                    try
                                    {
                                        objModel.Price = Convert.ToInt32(Regex.Match(pris.Split('@')[1].Trim().ToString(), @"\d+").Value);
                                    }
                                    catch (Exception)
                                    {
                                        objModel.Price = 0;
                                    }
                                    pricedatas.Add(objModel);
                                }
                            }
                        }

                        var splitprice = item.qty.Split(',');
                        if (splitprice != null && splitprice.Count() > 0)
                        {
                            foreach (var pri in splitprice)
                            {
                                if (!string.IsNullOrEmpty(pri))
                                {
                                    var mg = Convert.ToInt32(pri.Split('-')[0]);
                                    var mgprice = Convert.ToInt32(pri.Split('-')[1]);
                                    var isMatching = pricedatas.Where(x => x.MG == mg).FirstOrDefault();
                                    if (isMatching != null)
                                    {
                                        if (isMatching.Price > 0)
                                        {
                                            isOverrightPrice = true;
                                        }
                                        else
                                        {
                                            isMatching.Price = mgprice;
                                        }
                                    }
                                }
                            }
                        }
                    }

                    if (isOverrightPrice)
                    {
                        overrightModel.Add(new MasterPriceQuoteModel()
                        {
                            catno = item.catno,
                            countrytype = item.countrytype,
                            qty = item.qty,
                        });
                    }
                    else
                    {
                        if (quotedata != null)
                        {
                            var str = "";
                            foreach (var priitem in pricedatas)
                            {
                                str += priitem.MG.ToString() + " mg @ " + (priitem.Price > 0 ? priitem.Price.ToString() : "") + " " + currency + ", ";
                            }

                            if (!string.IsNullOrEmpty(str))
                            {
                                str = str.Trim();
                                str = str.Remove(str.Length - 1, 1);
                            }

                            quotedata.Price = str;
                            db.Entry(quotedata).State = EntityState.Modified;
                            db.SaveChanges();
                        }
                    }
                }
            }

            return new JsonResult()
            {
                JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                Data = new { type = "success", overrightdata = overrightModel }
            };
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult ValidateQuoteProducts(List<SuggestedPriceListQuoteModel> suggestedpricemodel)
        {
            var outputModel = new List<SuggestedPriceListQuoteModel>();
            foreach (var item in suggestedpricemodel)
            {
                var quotedetailsPriceList = new List<SuggestedPriceListModel>();
                int quotedetailsId = 0;
                int quoteId = 0;
                var cid = 0;
                var countryType = "";
                string companyName = "";
                string searchValue = "";
                int productId = 0;
                string processQuoteDetailPrice = "";
                var quoteDetailsData = _operationRepository.GetQuoteDetailByID(item.id);
                if (quoteDetailsData != null)
                {
                    processQuoteDetailPrice = quoteDetailsData.Price;
                    productId = quoteDetailsData.ProductId.HasValue ? quoteDetailsData.ProductId.Value : 0;
                    companyName = quoteDetailsData.SZ_Quotation.CompanyName;
                    cid = quoteDetailsData.SZ_Quotation.CompanyId.Value;
                    countryType = quoteDetailsData.SZ_Quotation.CountryType;
                    quotedetailsId = quoteDetailsData.Id;
                    quoteId = quoteDetailsData.QuoteId;
                    if (!string.IsNullOrEmpty(quoteDetailsData.CATNo))
                    {
                        searchValue = quoteDetailsData.CATNo;
                    }
                    if (string.IsNullOrEmpty(searchValue) && quoteDetailsData.CASNo != "NA" && quoteDetailsData.CASNo != "N/A")
                    {
                        searchValue = quoteDetailsData.CASNo;
                    }
                }
                if (!string.IsNullOrEmpty(item.qty))
                {
                    var allpricedata = item.qty.Split(',');
                    foreach (var itemsdata in allpricedata)
                    {
                        if (!string.IsNullOrEmpty(itemsdata))
                        {
                            var submodel = new SuggestedPriceListModel();
                            quotedetailsPriceList.Add(new SuggestedPriceListModel()
                            {
                                MG = Convert.ToInt32(itemsdata)
                            });
                        }
                    }
                }

                if (quotedetailsPriceList.Count == 0)
                {
                    return new JsonResult()
                    {
                        JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                        Data = new { type = "fail", data = "Please enter qty of selected product" }
                    };
                }

                foreach (var qpl in quotedetailsPriceList)
                {
                    string qplmg = Convert.ToString(qpl.MG);
                    var quotedetailsData = db.SZ_QuotationDetail.Where(x => x.ProductId == productId && x.Id != quotedetailsId && x.Price.Contains(qplmg)).ToList();
                }
            }

            return new JsonResult()
            {
                JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                Data = new { type = "success", data = outputModel }
            };
        }


        [HttpPost]
        [ValidateInput(false)]
        public ActionResult CheckPriceOfList(List<SuggestedPriceListQuoteModel> suggestedpricemodel)
        {
            var outputModel = new List<SuggestedPriceListQuoteModel>();
            foreach (var item in suggestedpricemodel)
            {
                var quotedetailsPriceList = new List<SuggestedPriceListModel>();
                int quotedetailsId = 0;
                int quoteId = 0;
                var cid = 0;
                var countryType = "";
                string companyName = "";
                string searchValue = "";
                int productId = 0;
                var quoteDetailsData = _operationRepository.GetQuoteDetailByID(item.id);
                if (quoteDetailsData != null)
                {
                    productId = quoteDetailsData.ProductId.HasValue ? quoteDetailsData.ProductId.Value : 0;
                    companyName = quoteDetailsData.SZ_Quotation.CompanyName;
                    cid = quoteDetailsData.SZ_Quotation.CompanyId.Value;
                    countryType = quoteDetailsData.SZ_Quotation.CountryType;
                    quotedetailsId = quoteDetailsData.Id;
                    quoteId = quoteDetailsData.QuoteId;
                    if (!string.IsNullOrEmpty(quoteDetailsData.CATNo))
                    {
                        searchValue = quoteDetailsData.CATNo;
                    }
                    if (string.IsNullOrEmpty(searchValue) && quoteDetailsData.CASNo != "NA" && quoteDetailsData.CASNo != "N/A")
                    {
                        searchValue = quoteDetailsData.CASNo;
                    }
                }
                if (!string.IsNullOrEmpty(item.qty))
                {
                    var allpricedata = item.qty.Split(',');
                    foreach (var itemsdata in allpricedata)
                    {
                        if (!string.IsNullOrEmpty(itemsdata))
                        {
                            var submodel = new SuggestedPriceListModel();
                            quotedetailsPriceList.Add(new SuggestedPriceListModel()
                            {
                                MG = Convert.ToInt32(itemsdata)
                            });
                        }
                    }
                }

                if (quotedetailsPriceList.Count == 0)
                {
                    return new JsonResult()
                    {
                        JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                        Data = new { type = "fail", data = "Please enter qty of selected product" }
                    };
                }

                string outputprice = "";
                DateTime startDate = DateTime.Now.AddYears(-1);
                DateTime endDate = DateTime.Now;

                outputprice = ExactPreparedPrice(cid.ToString(), searchValue, quotedetailsPriceList, quoteId, quotedetailsId, countryType);
                if (string.IsNullOrEmpty(outputprice))
                {
                    outputprice = PreparedPrice(DateTime.MinValue, DateTime.Now.AddYears(-1), cid.ToString(), searchValue, quotedetailsPriceList, quoteId, quotedetailsId, countryType);
                }

                outputModel.Add(new SuggestedPriceListQuoteModel()
                {
                    id = item.id,
                    qty = outputprice,
                    quoteid = item.quoteid
                });
            }

            return new JsonResult()
            {
                JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                Data = new { type = "success", data = outputModel }
            };
        }
        public ActionResult GetCheckPrice(int rfqid, string pricedata)
        {
            var quotedetailsPriceList = new List<SuggestedPriceListModel>();
            string companyName = "";
            int productId = 0;
            var rfqData = db.Rfqs.Where(x => x.Id == rfqid).FirstOrDefault();
            if (rfqData != null)
            {
                productId = rfqData.ProductId.HasValue ? rfqData.ProductId.Value : 0;
                companyName = db.GenericAttributes.Where(x => x.KeyGroup == "Customer"
                                                 && x.Key == "Company"
                                                 && x.EntityId == rfqData.CustomerId)
                                                 .Select(x => x.Value).FirstOrDefault();
            }

            if (!string.IsNullOrEmpty(pricedata))
            {
                var allpricedata = pricedata.Split(',');
                foreach (var item in allpricedata)
                {
                    var submodel = new SuggestedPriceListModel();
                    quotedetailsPriceList.Add(new SuggestedPriceListModel() { MG = Convert.ToInt32(item) });
                }
            }

            if (quotedetailsPriceList.Count == 0)
            {
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { type = "fail", data = "Please enter qty of selected product" }
                };
            }

            string outputprice = "";
            DateTime startDate = DateTime.Now.AddYears(-1);
            DateTime endDate = DateTime.Now;
            var compData = db.SZ_CompanyList.Where(x => x.Name.ToLower().Trim() == companyName.ToLower().Trim()).FirstOrDefault();
            var cid = 0;
            var countryType = "";
            if (compData != null)
            {
                cid = compData.Id;
                countryType = compData.CountryType;
            }
            outputprice = PreparedPrice(startDate, endDate, cid.ToString(), "", quotedetailsPriceList, 0, 0, countryType);
            if (string.IsNullOrEmpty(outputprice))
            {
                outputprice = PreparedPrice(DateTime.MinValue, DateTime.Now.AddYears(-1), cid.ToString(), "", quotedetailsPriceList, 0, 0, countryType);
            }
            return new JsonResult()
            {
                JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                Data = new { type = "success", data = outputprice }
            };
        }
        public ActionResult GetSuggestedPrice(string searchValue, string company, int quotedetailsid = 0)
        {
            try
            {
                string countryType = "";
                int processQuoteId = 0;
                var quotedetailsPriceList = new List<SuggestedPriceListModel>();
                var quotationDetailsData = _operationRepository.GetQuoteDetailByID(quotedetailsid);
                if (quotationDetailsData != null && !string.IsNullOrEmpty(quotationDetailsData.Price))
                {
                    countryType = quotationDetailsData.SZ_Quotation.CountryType;
                    processQuoteId = quotationDetailsData.QuoteId;
                    var allpricedata = quotationDetailsData.Price.Split(',');
                    foreach (var item in allpricedata)
                    {
                        var submodel = new SuggestedPriceListModel();
                        var qty = System.Text.RegularExpressions.Regex.Match(item.Split('@')[0], @"\d+").Value;
                        var price = System.Text.RegularExpressions.Regex.Match(item.Split('@')[1], @"\d+").Value;
                        if (item.Split('X').Count() > 1)
                        {
                            if (item.Split('X')[1].Contains("="))
                            {
                                qty = Convert.ToString(Convert.ToInt32(qty) * Convert.ToInt32(item.Split('X')[1].Split('=')[0]));
                            }
                            else
                            {
                                qty = Convert.ToString(Convert.ToInt32(qty) * Convert.ToInt32(item.Split('X')[1]));
                            }
                        }
                        quotedetailsPriceList.Add(new SuggestedPriceListModel() { MG = Convert.ToInt32(qty) });
                    }
                }
                if (quotedetailsPriceList.Count == 0)
                {
                    return new JsonResult()
                    {
                        JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                        Data = new { type = "fail", data = "Please enter qty of selected product" }
                    };
                }

                string outputprice = "";
                DateTime startDate = DateTime.Now.AddYears(-1);
                DateTime endDate = DateTime.Now;

                outputprice = PreparedPrice(startDate, endDate, company, searchValue, quotedetailsPriceList, processQuoteId, quotedetailsid, countryType);
                if (string.IsNullOrEmpty(outputprice))
                {
                    outputprice = PreparedPrice(DateTime.MinValue, DateTime.Now.AddYears(-1), company, searchValue, quotedetailsPriceList, processQuoteId, quotedetailsid, countryType);
                }
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { type = "success", data = outputprice }
                };
            }
            catch (Exception ex)
            {
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { type = "fail", data = ex.Message }
                };
            }
        }
        public string ExactPreparedPrice(string company, string searchValue, List<SuggestedPriceListModel> quotedetailsPriceList, int processQuoteId, int quotedetailsid, string countryType)
        {
            bool isQtyMatched = false;
            string outputprice = "";
            var model = (from x in db.SZ_QuotationDetail
                         where x.Id != quotedetailsid
                         && x.QuoteId != processQuoteId && x.SZ_Quotation.CountryType == countryType
                         select x).OrderByDescending(x => x.CreatedDate).AsQueryable();

            if (!string.IsNullOrEmpty(searchValue))
            {
                searchValue = searchValue.Trim();
                if (searchValue.ToLower().StartsWith("sz-"))
                {
                    model = model.Where(x => x.CATNo.ToLower().Contains(searchValue.ToLower()) || x.SZ_Quotation.Ref.Trim().ToLower().Contains(searchValue.ToLower())).OrderByDescending(x => x.CreatedDate);
                }
                else if (Regex.IsMatch(searchValue.Replace("-", ""), @"^-?\d+$"))
                {
                    model = model.Where(x => x.CASNo.ToLower().Contains(searchValue.ToLower()) || x.SZ_Quotation.Ref.Trim().ToLower().Contains(searchValue.ToLower())).OrderByDescending(x => x.CreatedDate);
                }
                else
                {
                    model = model.Where(x => x.ProductName.ToLower().Contains(searchValue.ToLower()) || x.SZ_Quotation.Ref.Trim().ToLower().Contains(searchValue.ToLower())).OrderByDescending(x => x.CreatedDate);
                }
            }

            int cid = Convert.ToInt32(company);
            var outputModel = new List<SuggestedPriceModel>();
            if (!string.IsNullOrEmpty(company) && company != "undefined")
            {
                //same company with po
                var companyPORecords = model.Where(x => x.SZ_Quotation.CompanyId == cid && !string.IsNullOrEmpty(x.SZ_Quotation.PONo)).OrderByDescending(x => x.CreatedDate);
                if (companyPORecords.Count() > 0)
                {
                    companyPORecords.ForEach(x => outputModel.Add(PrepareSuggestedPriceModel(x)));
                    if (outputModel.Count == 0)
                    {
                        foreach (var priceqty in quotedetailsPriceList)
                        {
                            var pricelistdata = outputModel.Select(x => x.PriceList).ToList();
                            var allrecordspricelist = new List<SuggestedPriceListModel>();
                            if (pricelistdata != null && pricelistdata.Count > 0)
                            {
                                foreach (var pld in outputModel)
                                {
                                    if (pld.PriceList != null && pld.PriceList.Count > 0)
                                    {
                                        allrecordspricelist.AddRange(pld.PriceList);
                                    }
                                }
                            }
                            var matcheddata = allrecordspricelist.Where(c => c.MG == priceqty.MG).FirstOrDefault();
                            if (matcheddata != null)
                            {
                                outputprice += matcheddata.MG + " - " + matcheddata.Price + ", ";
                            }
                            else
                            {
                                if (allrecordspricelist != null && allrecordspricelist.Count > 0)
                                {
                                    var outputpricedata = CalculationMasterPrice(allrecordspricelist[0].MG, allrecordspricelist[0].Price, priceqty.MG, countryType);
                                    outputprice += priceqty.MG + " - " + outputpricedata + ", ";
                                }
                            }
                        }
                    }
                }
            }
            if (outputModel.Count > 0)
            {
                outputModel = outputModel.Where(x => x != null).OrderByDescending(x => x.QuotedDate).ToList();
            }

            //if (outputModel.Count == 0)
            {
                //Diff company with po
                var othercompanywithpoRecords = model.Where(x => x.SZ_Quotation.CompanyId != cid && !string.IsNullOrEmpty(x.SZ_Quotation.PONo)).OrderByDescending(x => x.CreatedDate);
                if (othercompanywithpoRecords.Count() > 0)
                {
                    othercompanywithpoRecords.ForEach(x => outputModel.Add(PrepareSuggestedPriceModel(x)));
                    if (outputModel.Count == 0)
                    {
                        foreach (var priceqty in quotedetailsPriceList)
                        {
                            var pricelistdata = outputModel.Select(x => x.PriceList).ToList();
                            var allrecordspricelist = new List<SuggestedPriceListModel>();
                            if (pricelistdata != null && pricelistdata.Count > 0)
                            {
                                foreach (var pld in outputModel)
                                {
                                    if (pld.PriceList != null && pld.PriceList.Count > 0)
                                    {
                                        allrecordspricelist.AddRange(pld.PriceList);
                                    }
                                }
                            }
                            var matcheddata = allrecordspricelist.Where(c => c.MG == priceqty.MG).FirstOrDefault();
                            if (matcheddata != null)
                            {
                                outputprice += matcheddata.MG + " - " + matcheddata.Price + ", ";
                            }
                            else
                            {
                                if (allrecordspricelist != null && allrecordspricelist.Count > 0)
                                {
                                    var outputpricedata = CalculationMasterPrice(allrecordspricelist[0].MG, allrecordspricelist[0].Price, priceqty.MG, countryType);
                                    outputprice += priceqty.MG + " - " + outputpricedata + ", ";
                                }
                            }
                        }
                    }
                }
            }
            //if (outputModel.Count == 0)
            {
                // same company without po
                var companyRecords = model.Where(x => x.SZ_Quotation.CompanyId == cid && string.IsNullOrEmpty(x.SZ_Quotation.PONo)).OrderByDescending(x => x.CreatedDate);
                if (companyRecords != null && companyRecords.Count() > 0)
                {
                    companyRecords.ForEach(x => outputModel.Add(PrepareSuggestedPriceModel(x)));
                }
            }

            //if (outputModel.Count == 0)
            {
                // diff company without po
                var othercompanyRecords = model.Where(x => x.SZ_Quotation.CompanyId != cid && string.IsNullOrEmpty(x.SZ_Quotation.PONo)).OrderByDescending(x => x.CreatedDate);
                if (othercompanyRecords != null && othercompanyRecords.Count() > 0)
                {
                    othercompanyRecords.ForEach(x => outputModel.Add(PrepareSuggestedPriceModel(x)));
                }
            }
            if (outputModel.Count > 0)
            {
                outputModel = outputModel.Where(x => x != null).OrderByDescending(x => x.QuotedDate).ToList();
            }
            if (outputModel.Count > 0)
            {
                foreach (var priceqty in quotedetailsPriceList)
                {
                    var pricelistdata = outputModel.Select(x => x.PriceList).ToList();
                    var allrecordspricelist = new List<SuggestedPriceListModel>();
                    if (pricelistdata != null && pricelistdata.Count > 0)
                    {
                        foreach (var pld in outputModel)
                        {
                            if (pld.PriceList != null && pld.PriceList.Count > 0)
                            {
                                allrecordspricelist.AddRange(pld.PriceList);
                            }
                        }
                    }
                    var matcheddata = allrecordspricelist.Where(x => x.MG == priceqty.MG).FirstOrDefault();
                    if (matcheddata != null)
                    {
                        outputprice += matcheddata.MG + " - " + matcheddata.Price + ", ";
                        isQtyMatched = true;
                    }
                    else
                    {
                        outputprice += priceqty.MG + " - 0, ";
                    }
                }
                //Range : 
                // 0 - 15 : 10
                // 16 - 35 : 25
                // 36 - 75 : 50
                // 76 - 175 : 100
                // 176 - 400 : 250
                // 401 - 750 : 500
                // 750 < : 1000
                if (string.IsNullOrEmpty(outputprice))
                {
                    //Check price materix range
                    foreach (var priceqty in quotedetailsPriceList)
                    {
                        var pricelistdata = outputModel.Select(x => x.PriceList).ToList();
                        var allrecordspricelist = new List<SuggestedPriceListModel>();
                        if (pricelistdata != null && pricelistdata.Count > 0)
                        {
                            foreach (var pld in outputModel)
                            {
                                if (pld.PriceList != null && pld.PriceList.Count > 0)
                                {
                                    allrecordspricelist.AddRange(pld.PriceList);
                                }
                            }
                        }
                        var matcheddata = allrecordspricelist.Where(c => c.MG == priceqty.MG).FirstOrDefault();
                        if (matcheddata != null)
                        {
                            var onemgprice = Convert.ToInt32(matcheddata.Price) / Convert.ToInt32(matcheddata.MG);
                            outputprice += priceqty.MG + " - " + (onemgprice * Convert.ToInt32(priceqty.MG)) + ", ";
                        }
                        else
                        {
                            if (allrecordspricelist != null && allrecordspricelist.Count > 0)
                            {
                                var outputpricedata = CalculationMasterPrice(allrecordspricelist[0].MG, allrecordspricelist[0].Price, priceqty.MG, countryType);
                                outputprice += priceqty.MG + " - " + outputpricedata + ", ";
                            }
                        }
                    }
                }
            }

            if (string.IsNullOrEmpty(outputprice))
            {
                foreach (var item in quotedetailsPriceList)
                {
                    outputprice += item.MG + " - 0, ";
                }
            }

            return outputprice;
        }
        public string PreparedPrice(DateTime startDate, DateTime endDate, string company, string searchValue, List<SuggestedPriceListModel> quotedetailsPriceList, int processQuoteId, int quotedetailsid, string countryType)
        {
            bool isQtyMatched = false;
            string outputprice = "";
            var model = (from x in db.SZ_QuotationDetail
                         where x.CreatedDate >= startDate && x.CreatedDate <= endDate && x.Id != quotedetailsid
                         && x.QuoteId != processQuoteId && x.SZ_Quotation.CountryType == countryType
                         select x).AsQueryable();

            if (!string.IsNullOrEmpty(searchValue))
            {
                searchValue = searchValue.Trim();
                if (searchValue.ToLower().StartsWith("sz-"))
                {
                    model = model.Where(x => x.CATNo.ToLower().Contains(searchValue.ToLower()) || x.SZ_Quotation.Ref.Trim().ToLower().Contains(searchValue.ToLower()));
                }
                else if (Regex.IsMatch(searchValue.Replace("-", ""), @"^-?\d+$"))
                {
                    model = model.Where(x => x.CASNo.ToLower().Contains(searchValue.ToLower()) || x.SZ_Quotation.Ref.Trim().ToLower().Contains(searchValue.ToLower()));
                }
                else
                {
                    model = model.Where(x => x.ProductName.ToLower().Contains(searchValue.ToLower()) || x.SZ_Quotation.Ref.Trim().ToLower().Contains(searchValue.ToLower()));
                }
            }

            int cid = Convert.ToInt32(company);
            var outputModel = new List<SuggestedPriceModel>();
            if (!string.IsNullOrEmpty(company) && company != "undefined")
            {
                var companyPORecords = model.Where(x => x.SZ_Quotation.CompanyId == cid && !string.IsNullOrEmpty(x.SZ_Quotation.PONo)).OrderByDescending(x => x.Id);
                if (companyPORecords.Count() > 0)
                {
                    companyPORecords.ForEach(x => outputModel.Add(PrepareSuggestedPriceModel(x)));
                    if (outputModel.Count == 0)
                    {
                        foreach (var priceqty in quotedetailsPriceList)
                        {
                            var range = PrepareRange(priceqty.MG);
                            var pricelistdata = outputModel.Select(x => x.PriceList).ToList();
                            var allrecordspricelist = new List<SuggestedPriceListModel>();
                            if (pricelistdata != null && pricelistdata.Count > 0)
                            {
                                foreach (var pld in outputModel)
                                {
                                    if (pld.PriceList != null && pld.PriceList.Count > 0)
                                    {
                                        allrecordspricelist.AddRange(pld.PriceList);
                                    }
                                }
                            }
                            var matcheddata = allrecordspricelist.Where(c => c.MG >= range.StartRange
                                                                        && c.MG <= range.EndRange).FirstOrDefault();
                            if (matcheddata != null)
                            {
                                outputprice += matcheddata.MG + " - " + matcheddata.Price + ", ";
                            }
                            else
                            {
                                if (allrecordspricelist != null && allrecordspricelist.Count > 0)
                                {
                                    var outputpricedata = CalculationMasterPrice(allrecordspricelist[0].MG, allrecordspricelist[0].Price, priceqty.MG, countryType);
                                    outputprice += priceqty.MG + " - " + outputpricedata + ", ";
                                }
                            }
                        }
                    }
                }
            }
            if (outputModel.Count > 0)
            {
                outputModel = outputModel.Where(x => x != null).ToList();
            }

            if (outputModel.Count == 0)
            {
                //Diff company same qty
                var othercompanywithpoRecords = model.Where(x => x.SZ_Quotation.CompanyId != cid && !string.IsNullOrEmpty(x.SZ_Quotation.PONo)).OrderByDescending(x => x.Id);
                if (othercompanywithpoRecords.Count() > 0)
                {
                    othercompanywithpoRecords.ForEach(x => outputModel.Add(PrepareSuggestedPriceModel(x)));
                    if (outputModel.Count == 0)
                    {
                        foreach (var priceqty in quotedetailsPriceList)
                        {
                            var range = PrepareRange(priceqty.MG);
                            var pricelistdata = outputModel.Select(x => x.PriceList).ToList();
                            var allrecordspricelist = new List<SuggestedPriceListModel>();
                            if (pricelistdata != null && pricelistdata.Count > 0)
                            {
                                foreach (var pld in outputModel)
                                {
                                    if (pld.PriceList != null && pld.PriceList.Count > 0)
                                    {
                                        allrecordspricelist.AddRange(pld.PriceList);
                                    }
                                }
                            }
                            var matcheddata = allrecordspricelist.Where(c => c.MG >= range.StartRange
                                                                        && c.MG <= range.EndRange).FirstOrDefault();
                            if (matcheddata != null)
                            {
                                outputprice += matcheddata.MG + " - " + matcheddata.Price + ", ";
                            }
                            else
                            {
                                if (allrecordspricelist != null && allrecordspricelist.Count > 0)
                                {
                                    var outputpricedata = CalculationMasterPrice(allrecordspricelist[0].MG, allrecordspricelist[0].Price, priceqty.MG, countryType);
                                    outputprice += priceqty.MG + " - " + outputpricedata + ", ";
                                }
                            }
                        }
                    }
                }
            }
            if (outputModel.Count == 0)
            {
                // same company without po
                var companyRecords = model.Where(x => x.SZ_Quotation.CompanyId == cid && string.IsNullOrEmpty(x.SZ_Quotation.PONo)).OrderByDescending(x => x.Id);
                if (companyRecords.Count() > 0)
                {
                    companyRecords.ForEach(x => outputModel.Add(PrepareSuggestedPriceModel(x)));
                }
            }
            if (outputModel.Count == 0)
            {
                // diff company without po
                var othercompanyRecords = model.Where(x => x.SZ_Quotation.CompanyId != cid && string.IsNullOrEmpty(x.SZ_Quotation.PONo)).OrderByDescending(x => x.Id);
                if (othercompanyRecords.Count() > 0)
                {
                    othercompanyRecords.ForEach(x => outputModel.Add(PrepareSuggestedPriceModel(x)));
                }
            }
            if (outputModel.Count > 0)
            {
                outputModel = outputModel.Where(x => x != null).ToList();
            }
            if (outputModel.Count > 0)
            {
                foreach (var priceqty in quotedetailsPriceList)
                {
                    var pricelistdata = outputModel.Select(x => x.PriceList).ToList();
                    var allrecordspricelist = new List<SuggestedPriceListModel>();
                    if (pricelistdata != null && pricelistdata.Count > 0)
                    {
                        foreach (var pld in outputModel)
                        {
                            if (pld.PriceList != null && pld.PriceList.Count > 0)
                            {
                                allrecordspricelist.AddRange(pld.PriceList);
                            }
                        }
                    }
                    var matcheddata = allrecordspricelist.Where(x => x.MG == priceqty.MG).FirstOrDefault();
                    if (matcheddata != null)
                    {
                        outputprice += matcheddata.MG + " - " + matcheddata.Price + ", ";
                        isQtyMatched = true;
                    }
                }
                //Range : 
                // 0 - 15 : 10
                // 16 - 35 : 25
                // 36 - 75 : 50
                // 76 - 175 : 100
                // 176 - 400 : 250
                // 401 - 750 : 500
                // 750 < : 1000
                if (string.IsNullOrEmpty(outputprice))
                {
                    //Check price materix range
                    foreach (var priceqty in quotedetailsPriceList)
                    {
                        var range = PrepareRange(priceqty.MG);
                        var pricelistdata = outputModel.Select(x => x.PriceList).ToList();
                        var allrecordspricelist = new List<SuggestedPriceListModel>();
                        if (pricelistdata != null && pricelistdata.Count > 0)
                        {
                            foreach (var pld in outputModel)
                            {
                                if (pld.PriceList != null && pld.PriceList.Count > 0)
                                {
                                    allrecordspricelist.AddRange(pld.PriceList);
                                }
                            }
                        }
                        var matcheddata = allrecordspricelist.Where(c => c.MG >= range.StartRange
                                                                    && c.MG <= range.EndRange).FirstOrDefault();
                        if (matcheddata != null)
                        {
                            var onemgprice = Convert.ToInt32(matcheddata.Price) / Convert.ToInt32(matcheddata.MG);
                            outputprice += priceqty.MG + " - " + (onemgprice * Convert.ToInt32(priceqty.MG)) + ", ";
                        }
                        else
                        {
                            if (allrecordspricelist != null && allrecordspricelist.Count > 0)
                            {
                                var outputpricedata = CalculationMasterPrice(allrecordspricelist[0].MG, allrecordspricelist[0].Price, priceqty.MG, countryType);
                                outputprice += priceqty.MG + " - " + outputpricedata + ", ";
                            }
                        }
                    }
                }
            }

            return outputprice;
        }
        public int? CalculationMasterPrice(int qty, int price, int requiredQty, string countryType)
        {
            var pricemasterlist = db.SZ_CategoryMaster.ToList();
            var pricelist = new SZ_CategoryMaster();
            if (string.IsNullOrEmpty(countryType))
            {
                countryType = "Domestic";
            }
            if (qty >= 0 && qty <= 15)
            {
                // 0 - 15 : 10
                if (countryType.ToLower() == "export")
                {
                    pricelist = db.SZ_CategoryMaster.Where(x => x.TenUSD == price).FirstOrDefault();
                    if (pricelist == null)
                    {
                        List<int> priceListdata = new List<int>();
                        priceListdata.AddRange(pricemasterlist.Select(x => x.TenUSD.Value).AsEnumerable());
                        int closest = priceListdata.ClosestTo(price);
                        pricelist = pricemasterlist.Where(x => x.TenUSD == closest).FirstOrDefault();
                    }
                }
                else
                {
                    pricelist = db.SZ_CategoryMaster.Where(x => x.Ten == price).FirstOrDefault();
                    if (pricelist == null)
                    {
                        List<int> priceListdata = new List<int>();
                        priceListdata.AddRange(pricemasterlist.Select(x => x.Ten.Value).AsEnumerable());
                        int closest = priceListdata.ClosestTo(price);
                        pricelist = pricemasterlist.Where(x => x.Ten == closest).FirstOrDefault();
                    }
                }
            }
            if (qty >= 16 && qty <= 35)
            {
                // 16 - 35 : 25
                if (countryType.ToLower() == "export")
                {
                    pricelist = db.SZ_CategoryMaster.Where(x => x.TwentyfiveUSD == price).FirstOrDefault();
                    if (pricelist == null)
                    {
                        List<int> priceListdata = new List<int>();
                        priceListdata.AddRange(pricemasterlist.Select(x => x.TwentyfiveUSD.Value).AsEnumerable());
                        int closest = priceListdata.ClosestTo(price);
                        pricelist = pricemasterlist.Where(x => x.TwentyfiveUSD == closest).FirstOrDefault();
                    }
                }
                else
                {
                    pricelist = db.SZ_CategoryMaster.Where(x => x.Twentyfive == price).FirstOrDefault();
                    if (pricelist == null)
                    {
                        List<int> priceListdata = new List<int>();
                        priceListdata.AddRange(pricemasterlist.Select(x => x.Twentyfive.Value).AsEnumerable());
                        int closest = priceListdata.ClosestTo(price);
                        pricelist = pricemasterlist.Where(x => x.Twentyfive == closest).FirstOrDefault();
                    }
                }
            }
            if (qty >= 36 && qty <= 75)
            {
                // 36 - 75 : 50
                if (countryType.ToLower() == "export")
                {
                    pricelist = db.SZ_CategoryMaster.Where(x => x.FiftyUSD == price).FirstOrDefault();
                    if (pricelist == null)
                    {
                        List<int> priceListdata = new List<int>();
                        priceListdata.AddRange(pricemasterlist.Select(x => x.FiftyUSD.Value).AsEnumerable());
                        int closest = priceListdata.ClosestTo(price);
                        pricelist = pricemasterlist.Where(x => x.FiftyUSD == closest).FirstOrDefault();
                    }
                }
                else
                {
                    pricelist = db.SZ_CategoryMaster.Where(x => x.Fifty == price).FirstOrDefault();
                    if (pricelist == null)
                    {
                        List<int> priceListdata = new List<int>();
                        priceListdata.AddRange(pricemasterlist.Select(x => x.Fifty.Value).AsEnumerable());
                        int closest = priceListdata.ClosestTo(price);
                        pricelist = pricemasterlist.Where(x => x.Fifty == closest).FirstOrDefault();
                    }
                }
            }
            if (qty >= 76 && qty <= 175)
            {
                // 76 - 175 : 100
                if (countryType.ToLower() == "export")
                {
                    pricelist = db.SZ_CategoryMaster.Where(x => x.OnehundredUSD == price).FirstOrDefault();
                    if (pricelist == null)
                    {
                        List<int> priceListdata = new List<int>();
                        priceListdata.AddRange(pricemasterlist.Select(x => x.OnehundredUSD.Value).AsEnumerable());
                        int closest = priceListdata.ClosestTo(price);
                        pricelist = pricemasterlist.Where(x => x.OnehundredUSD == closest).FirstOrDefault();
                    }
                }
                else
                {
                    pricelist = db.SZ_CategoryMaster.Where(x => x.Onehundred == price).FirstOrDefault();
                    if (pricelist == null)
                    {
                        List<int> priceListdata = new List<int>();
                        priceListdata.AddRange(pricemasterlist.Select(x => x.Onehundred.Value).AsEnumerable());
                        int closest = priceListdata.ClosestTo(price);
                        pricelist = pricemasterlist.Where(x => x.Onehundred == closest).FirstOrDefault();
                    }
                }
            }
            if (qty >= 176 && qty <= 400)
            {
                // 176 - 400 : 250
                if (countryType.ToLower() == "export")
                {
                    pricelist = pricemasterlist.Where(x => x.TwohundredFiftyUSD == price).FirstOrDefault();
                    if (pricelist == null)
                    {
                        List<int> priceListdata = new List<int>();
                        priceListdata.AddRange(pricemasterlist.Select(x => x.TwohundredFiftyUSD.Value).AsEnumerable());
                        int closest = priceListdata.ClosestTo(price);
                        pricelist = pricemasterlist.Where(x => x.TwohundredFiftyUSD == closest).FirstOrDefault();
                    }
                }
                else
                {
                    pricelist = db.SZ_CategoryMaster.Where(x => x.TwohundredFifty == price).FirstOrDefault();
                    if (pricelist == null)
                    {
                        List<int> priceListdata = new List<int>();
                        priceListdata.AddRange(pricemasterlist.Select(x => x.TwohundredFifty.Value).AsEnumerable());
                        int closest = priceListdata.ClosestTo(price);
                        pricelist = pricemasterlist.Where(x => x.TwohundredFifty == closest).FirstOrDefault();
                    }
                }
            }
            if (qty >= 401 && qty <= 750)
            {
                // 401 - 750 : 500
                if (countryType.ToLower() == "export")
                {
                    pricelist = db.SZ_CategoryMaster.Where(x => x.FivehundredUSD == price).FirstOrDefault();
                    if (pricelist == null)
                    {
                        List<int> priceListdata = new List<int>();
                        priceListdata.AddRange(pricemasterlist.Select(x => x.FivehundredUSD.Value).AsEnumerable());
                        int closest = priceListdata.ClosestTo(price);
                        pricelist = pricemasterlist.Where(x => x.FivehundredUSD == closest).FirstOrDefault();
                    }
                }
                else
                {
                    pricelist = db.SZ_CategoryMaster.Where(x => x.Fivehundred == price).FirstOrDefault();
                    if (pricelist == null)
                    {
                        List<int> priceListdata = new List<int>();
                        priceListdata.AddRange(pricemasterlist.Select(x => x.Fivehundred.Value).AsEnumerable());
                        int closest = priceListdata.ClosestTo(price);
                        pricelist = pricemasterlist.Where(x => x.Fivehundred == closest).FirstOrDefault();
                    }
                }
            }
            if (qty >= 751)
            {
                // 750 < : 1000
                if (countryType.ToLower() == "export")
                {
                    pricelist = db.SZ_CategoryMaster.Where(x => x.OneThousandUSD == price).FirstOrDefault();
                    if (pricelist == null)
                    {
                        List<int> priceListdata = new List<int>();
                        priceListdata.AddRange(pricemasterlist.Select(x => x.OneThousandUSD.Value).AsEnumerable());
                        int closest = priceListdata.ClosestTo(price);
                        pricelist = pricemasterlist.Where(x => x.OneThousandUSD == closest).FirstOrDefault();
                    }
                }
                else
                {
                    pricelist = db.SZ_CategoryMaster.Where(x => x.OneThousand == price).FirstOrDefault();
                    if (pricelist == null)
                    {
                        List<int> priceListdata = new List<int>();
                        priceListdata.AddRange(pricemasterlist.Select(x => x.OneThousand.Value).AsEnumerable());
                        int closest = priceListdata.ClosestTo(price);
                        pricelist = pricemasterlist.Where(x => x.OneThousand == closest).FirstOrDefault();
                    }
                }
            }
            if (pricelist == null)
                return 0;

            return CalculationGetTheRangePrice(pricelist, requiredQty, countryType.ToLower());
        }
        public int? CalculationGetTheRangePrice(SZ_CategoryMaster pricelist, int qty, string countryType)
        {
            if (qty >= 0 && qty <= 15)
            {
                // 0 - 15 : 10
                if (countryType.ToLower() == "export")
                {
                    if (pricelist.TenUSD.HasValue)
                    {
                        return (pricelist.TenUSD / 10) * qty;
                    }
                }
                else
                {
                    if (pricelist.Ten.HasValue)
                    {
                        return (pricelist.Ten / 10) * qty;
                    }
                }
            }
            if (qty >= 16 && qty <= 35)
            {
                // 16 - 35 : 25
                if (countryType.ToLower() == "export")
                {
                    if (pricelist.TwentyfiveUSD.HasValue)
                    {
                        return (pricelist.TwentyfiveUSD / 25) * qty;
                    }
                }
                else
                {
                    if (pricelist.Twentyfive.HasValue)
                    {
                        return (pricelist.Twentyfive / 25) * qty;
                    }
                }
            }
            if (qty >= 36 && qty <= 75)
            {
                // 36 - 75 : 50
                if (countryType.ToLower() == "export")
                {
                    if (pricelist.FiftyUSD.HasValue)
                    {
                        return (pricelist.FiftyUSD / 50) * qty;
                    }
                }
                else
                {
                    if (pricelist.Fifty.HasValue)
                    {
                        return (pricelist.Fifty / 50) * qty;
                    }
                }
            }
            if (qty >= 76 && qty <= 175)
            {
                // 76 - 175 : 100
                if (countryType.ToLower() == "export")
                {
                    if (pricelist.OnehundredUSD.HasValue)
                    {
                        return (pricelist.OnehundredUSD / 100) * qty;
                    }
                }
                else
                {
                    if (pricelist.Onehundred.HasValue)
                    {
                        return (pricelist.Onehundred / 100) * qty;
                    }
                }
            }
            if (qty >= 176 && qty <= 400)
            {
                // 176 - 400 : 250
                if (countryType.ToLower() == "export")
                {
                    if (pricelist.TwohundredFiftyUSD.HasValue)
                    {
                        return (pricelist.TwohundredFiftyUSD / 250) * qty;
                    }
                }
                else
                {
                    if (pricelist.TwohundredFifty.HasValue)
                    {
                        return (pricelist.TwohundredFifty / 250) * qty;
                    }
                }
            }
            if (qty >= 401 && qty <= 750)
            {
                if (countryType.ToLower() == "export")
                {
                    if (pricelist.FivehundredUSD.HasValue)
                    {
                        return (pricelist.FivehundredUSD / 500) * qty;
                    }
                }
                else
                {
                    if (pricelist.Fivehundred.HasValue)
                    {
                        return (pricelist.Fivehundred / 500) * qty;
                    }
                }
            }
            // 750 < : 1000
            if (countryType.ToLower() == "export")
            {
                if (pricelist.OneThousandUSD.HasValue)
                {
                    return (pricelist.OneThousandUSD / 1000) * qty;
                }
            }
            else
            {
                if (pricelist.OneThousand.HasValue)
                {
                    return (pricelist.OneThousand / 1000) * qty;
                }
            }
            return 0;
        }

        public PriceMasterRange PrepareRange(int qty)
        {
            if (qty >= 0 && qty <= 15)
            {
                return new PriceMasterRange()
                {
                    StartRange = 0,
                    EndRange = 15
                };
            }
            if (qty >= 16 && qty <= 35)
            {
                return new PriceMasterRange()
                {
                    StartRange = 16,
                    EndRange = 35
                };
            }
            if (qty >= 36 && qty <= 75)
            {
                return new PriceMasterRange()
                {
                    StartRange = 36,
                    EndRange = 75
                };
            }
            if (qty >= 76 && qty <= 175)
            {
                return new PriceMasterRange()
                {
                    StartRange = 76,
                    EndRange = 175
                };
            }
            if (qty >= 176 && qty <= 400)
            {
                return new PriceMasterRange()
                {
                    StartRange = 176,
                    EndRange = 400
                };
            }
            if (qty >= 401 && qty <= 750)
            {
                return new PriceMasterRange()
                {
                    StartRange = 401,
                    EndRange = 750
                };
            }
            return new PriceMasterRange()
            {
                StartRange = 751,
                EndRange = 100000000
            };
        }
        public SuggestedPriceModel PrepareSuggestedPriceModel(SZ_QuotationDetail quoteDetail)
        {
            var model = new SuggestedPriceModel();
            if (string.IsNullOrEmpty(quoteDetail.Price))
            {
                return null;
            }
            model.QuotationDetailsId = quoteDetail.Id;
            model.QuoteId = quoteDetail.QuoteId;
            model.QuotedDate = quoteDetail.SZ_Quotation.CreatedDate;
            model.PriceList = new List<SuggestedPriceListModel>();
            var allpricedata = quoteDetail.Price.Split(',');
            if (allpricedata.Count() == 1)
            {
                var submodel = new SuggestedPriceListModel();
                var qty = "";
                var price = "";
                if (allpricedata[0].IndexOf("X") != -1)
                {
                    string packs = allpricedata[0].Split('X')[1];
                    int packsize = Convert.ToInt32(System.Text.RegularExpressions.Regex.Match(packs, @"\d+").Value);
                    qty = Convert.ToString(Convert.ToInt32(allpricedata[0].Split(' ')[0]) * Convert.ToInt32(packsize));
                    if (allpricedata[0].IndexOf("=") != -1)
                    {
                        try
                        {
                            price = System.Text.RegularExpressions.Regex.Match(allpricedata[0].Split('@')[1].Split('=')[1], @"\d+").Value;
                        }
                        catch (Exception)
                        {
                            price = System.Text.RegularExpressions.Regex.Match(allpricedata[0].Split('=')[1], @"\d+").Value;
                        }
                    }
                    else
                    {
                        price = System.Text.RegularExpressions.Regex.Match(allpricedata[0].Split('@')[1], @"\d+").Value;
                    }
                }
                else
                {
                    qty = allpricedata[0].Split(' ')[0];
                    try
                    {
                        price = System.Text.RegularExpressions.Regex.Match(allpricedata[0].Split('@')[1], @"\d+").Value;
                    }
                    catch (Exception)
                    {

                    }
                }

                if (!string.IsNullOrEmpty(qty))
                {
                    submodel.MG = Convert.ToInt32(qty.Replace(".000", ""));
                    if (string.IsNullOrEmpty(price))
                    {
                        submodel.Price = 0;
                    }
                    else
                    {
                        submodel.Price = Convert.ToInt32(price);
                    }
                    model.PriceList.Add(submodel);
                }
            }
            else
            {
                var cnt = new List<string>();
                foreach (var item in allpricedata)
                {
                    try
                    {
                        var submodel = new SuggestedPriceListModel();
                        var qty = System.Text.RegularExpressions.Regex.Match(item.Split('@')[0], @"\d+").Value;
                        var price = System.Text.RegularExpressions.Regex.Match(item.Split('@')[1], @"\d+").Value;
                        if (item.Split('X').Count() > 1)
                        {
                            if (item.Split('X')[1].Contains("="))
                            {
                                qty = Convert.ToString(Convert.ToInt32(qty) * Convert.ToInt32(item.Split('X')[1].Split('=')[0]));
                            }
                            else
                            {
                                qty = Convert.ToString(Convert.ToInt32(qty) * Convert.ToInt32(item.Split('X')[1]));
                            }
                        }
                        if (!string.IsNullOrEmpty(price))
                        {
                            submodel.MG = Convert.ToInt32(qty);
                            submodel.Price = Convert.ToInt32(price);
                            model.PriceList.Add(submodel);
                        }
                    }
                    catch (Exception)
                    {
                    }
                }
            }
            return model;
        }

        [HttpPost]
        public JsonResult getPreviousInfoFromDBPaging()
        {
            try
            {
                var ProductName = string.Empty;
                var company = string.Empty;
                var countrytypesearch = string.Empty;
                var QuoteId = 0;
                var quotedetailsid = 0;
                if (Request.Form.GetValues("ProductName") != null)
                {
                    ProductName = Request.Form.GetValues("ProductName")[0].ToString(); ;
                }
                if (Request.Form.GetValues("company") != null)
                {
                    company = Request.Form.GetValues("company")[0].ToString(); ;
                }
                if (Request.Form.GetValues("QuoteId") != null)
                {
                    QuoteId = Convert.ToInt32(Request.Form.GetValues("QuoteId")[0].ToString());
                }
                if (Request.Form.GetValues("Quotedetailsid") != null)
                {
                    quotedetailsid = Convert.ToInt32(Request.Form.GetValues("Quotedetailsid")[0].ToString());
                }
                var searchby = string.Empty;
                var searchbyvalue = string.Empty;
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                int numberOfObjectsPerPage = Convert.ToInt32(Request.Form["length"]);
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int pageNo = 1;
                if (skip > 0)
                {
                    pageNo = (skip / numberOfObjectsPerPage) + 1;
                }
                int cid = 0;
                if (company != "undefined")
                {
                    cid = Convert.ToInt32(company);
                }
                if (!string.IsNullOrEmpty(ProductName))
                {
                    ProductName = ProductName.Trim().ToLower();
                }

                var model = (from x in db.SZ_QuotationDetail
                             select x).AsQueryable();
                var allmodel = model;
                if (!string.IsNullOrEmpty(ProductName))
                {
                    ProductName = ProductName.Trim();
                    if (ProductName.ToLower().StartsWith("sz-"))
                    {
                        model = model.Where(x => x.CATNo.ToLower().Contains(ProductName.ToLower()) || x.SZ_Quotation.Ref.Trim().ToLower().Contains(ProductName.ToLower()));
                    }
                    else if (Regex.IsMatch(ProductName.Replace("-", ""), @"^-?\d+$"))
                    {
                        model = model.Where(x => x.CASNo.ToLower().Contains(ProductName.ToLower()) || x.SZ_Quotation.Ref.Trim().ToLower().Contains(ProductName.ToLower()));
                    }
                    else
                    {
                        model = model.Where(x => x.ProductName.ToLower().Contains(ProductName.ToLower()) || x.SZ_Quotation.Ref.Trim().ToLower().Contains(ProductName.ToLower()));
                    }
                }

                IQueryable<SZ_QuotationDetail> outputModel = null;
                if (!string.IsNullOrEmpty(company) && company != "undefined")
                {
                    outputModel = model.Where(x => (x.SZ_Quotation.CompanyId == cid && !string.IsNullOrEmpty(x.SZ_Quotation.PONo)) ||
                                                     (x.SZ_Quotation.CompanyId != cid && !string.IsNullOrEmpty(x.SZ_Quotation.PONo)) ||
                                                     (x.SZ_Quotation.CompanyId == cid && string.IsNullOrEmpty(x.SZ_Quotation.PONo)) ||
                                                     (x.SZ_Quotation.CompanyId != cid && string.IsNullOrEmpty(x.SZ_Quotation.PONo))).OrderByDescending(x => x.Id).AsQueryable();

                }

                if (outputModel.Count() == 0)
                {
                    outputModel = (from x in db.SZ_QuotationDetail
                                   where x.SZ_Quotation.PONo == ProductName
                                   select x).OrderByDescending(x => x.Id).AsQueryable();
                }

                var results = outputModel;
                if (QuoteId != 0)
                {
                    var szalreadydetails = allmodel.Where(x => x.QuoteId == QuoteId).ToList();
                    if (szalreadydetails != null && szalreadydetails.Count > 0)
                    {
                        ViewBag.QuoteCompanyId = szalreadydetails[0].SZ_Quotation.CompanyId;

                        var ids = szalreadydetails.Select(x => x.Id).ToList();
                        results = results.Where(x => !ids.Contains(x.Id)).AsQueryable();

                        if (quotedetailsid > 0)
                        {
                            ViewBag.CurrentQuoteDetailsPrice = szalreadydetails.Where(x => x.Id == quotedetailsid).Select(x => x.Price).FirstOrDefault();
                        }
                    }
                }

                var a = results.OrderByDescending(x => x.MoveToProject).ThenByDescending(x => x.CreatedDate).ToList();
                string countryType = "";
                var companyData = db.SZ_CompanyList.Where(x => x.Id == cid).FirstOrDefault();
                if (companyData != null)
                {
                    countryType = companyData.CountryType;
                    ViewBag.ClientsuggestedComment = companyData.ClientSuggestedComment;
                }

                int productId = a.Select(x => x.ProductId.Value).FirstOrDefault();
                var synzealCompData = new SZ_CompanyList();
                if (countryType == "Domestic")
                {
                    synzealCompData = db.SZ_CompanyList.Where(x => x.Id == 2514).FirstOrDefault();
                }
                else
                {
                    synzealCompData = db.SZ_CompanyList.Where(x => x.Id == 2515).FirstOrDefault();
                }

                var szquotedetails = db.SZ_QuotationDetail.Where(x => x.SZ_Quotation.CompanyId == synzealCompData.Id && x.ProductId == productId).FirstOrDefault();
                if (szquotedetails != null)
                {
                    ViewBag.SynzealPrice = szquotedetails.Price;
                }

                var recordsTotal = a.Count;
                var modeldata = a.Skip((pageNo - 1) * numberOfObjectsPerPage).Take(numberOfObjectsPerPage).ToList();
                var latestSameCompanyData = modeldata.Where(x => x.SZ_Quotation.CompanyId == ViewBag.QuoteCompanyId).OrderByDescending(x => x.SZ_Quotation.CreatedDate).FirstOrDefault();
                var latestDiffCompanyData = modeldata.Where(x => x.SZ_Quotation.CompanyId != ViewBag.QuoteCompanyId).OrderByDescending(x => x.SZ_Quotation.CreatedDate).FirstOrDefault();
                bool setQtyRule = false;
                var isapi = Convert.ToBoolean(ViewBag.isApi);
                string currentquotedetailsprice = string.Empty;
                if (ViewBag.CurrentQuoteDetailsPrice != null)
                {
                    currentquotedetailsprice = Convert.ToString(ViewBag.CurrentQuoteDetailsPrice);
                }
                var listoutput = new List<PreviousProductModel>();
                modeldata.ForEach(k =>
                {
                    string backgroundcls = "";
                    string samecompanyhighlightcls = "";
                    string othercompanyhighlightcls = "";
                    string othercompanysameqtyhighlightcls = "";
                    if (k.MoveToProject.HasValue && k.MoveToProject.Value && k.SZ_Quotation.PONo != null && !string.IsNullOrEmpty(k.SZ_Quotation.PONo.Trim()))
                    {
                        backgroundcls = "clsbgwhiteclass";
                    }
                    else
                    {
                        backgroundcls = "clsbggreyclass";
                    }
                    if (latestSameCompanyData != null && latestSameCompanyData.Id == k.Id)
                    {
                        samecompanyhighlightcls = "samecompanyhighlightcls";
                    }
                    if (latestDiffCompanyData != null && latestDiffCompanyData.Id == k.Id)
                    {
                        othercompanyhighlightcls = "othercompanyhighlightcls";
                    }
                    if (!string.IsNullOrEmpty(currentquotedetailsprice))
                    {
                        othercompanysameqtyhighlightcls = "";
                        var priList = new List<string>();
                        foreach (var pri in currentquotedetailsprice.Split(','))
                        {
                            priList.Add(pri.Trim().Split(' ')[0]);
                        }
                        if (!string.IsNullOrEmpty(k.Price))
                        {
                            foreach (var priitem in priList)
                            {
                                bool isValidQtyRule = k.Price.Contains(priitem + " mg@");
                                if (isValidQtyRule && !setQtyRule)
                                {
                                    setQtyRule = true;
                                    othercompanysameqtyhighlightcls = "othercompanysameqtyhighlightcls";
                                }
                            }
                        }
                    }
                    var output = new PreviousProductModel();
                    if (k.SZ_Quotation.CreatedDate.HasValue)
                    {
                        output.QuoteDate = k.SZ_Quotation.CreatedDate.Value.ToShortDateString();
                    }
                    output.QuoteRef = "<a href='Form/Quote/" + k.QuoteId + "' target='_blank'>" + k.SZ_Quotation.Ref + "</a>";
                    output.CompanyName = k.SZ_Quotation.CompanyName;
                    if (k.MoveToProject.HasValue && k.MoveToProject.Value)
                    {
                        output.PONo = k.SZ_Quotation.PONo;
                    }
                    output.ProductName = "<label>" + k.ProductName.Trim() + "</label> <input type='text' id='productname_" + k.Id + "' value='" + k.ProductName.Trim() + "' style='display: none; ' /> ";
                    listoutput.Add(output);
                });

                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = listoutput });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }
        }

        public ActionResult getPreviousInfoFromDB(string ProductName, string casno, string catNo, string company, int QuoteId = 0, bool isApi = false, int quotedetailsid = 0, int productIds = 0)
        {
            try
            {
                var a = new List<SZ_QuotationDetail>();
                ViewBag.isApi = isApi;
                int cid = 0;
                if (company != "undefined")
                {
                    cid = Convert.ToInt32(company);
                }
                if (!string.IsNullOrEmpty(ProductName))
                {
                    ProductName = ProductName.Trim().ToLower();
                }
                var twoweekdays = DateTime.Now.AddDays(-14);

                //if (productIds > 0)
                //{   // new code
                //    var quoteHideCompanyListIds = db.SZ_CompanyList.Where(x => x.IsQuoteHide == true && x.Id != cid).Select(x => x.Id).ToList();

                //    var datas = db.GETPreviousDataHistory(ProductName, cid, QuoteId, quotedetailsid, productIds);
                //    var szalreadydetails = (from x in db.SZ_QuotationDetail
                //                            where ((x.SZ_Quotation.IsPark == false || x.SZ_Quotation.IsPark == null)
                //                            && x.SZ_Quotation.CompanyId != 2514
                //                            && x.SZ_Quotation.CompanyId != 2515
                //                            && !string.IsNullOrEmpty(x.SZ_Quotation.ApprovedBy))
                //                            && (x.SZ_Quotation.CompanyId.HasValue && !quoteHideCompanyListIds.Contains(x.SZ_Quotation.CompanyId.Value))
                //                            && (x.IsQuoteHide == null || x.IsQuoteHide == false)
                //                            && x.QuoteId == QuoteId
                //                            select x).ToList();

                //    var results = new List<SZ_QuotationDetail>();
                //    if (QuoteId != 0)
                //    {
                //        if (szalreadydetails != null && szalreadydetails.Count > 0)
                //        {
                //            ViewBag.QuoteCompanyId = szalreadydetails[0].SZ_Quotation.CompanyId;
                //            var ids = szalreadydetails.Select(x => x.Id).ToList();
                //            results = datas.Where(x => !ids.Contains(x.Id)).ToList();

                //            if (quotedetailsid > 0)
                //            {
                //                ViewBag.CurrentQuoteDetailsPrice = szalreadydetails.Where(x => x.Id == quotedetailsid).Select(x => x.Price).FirstOrDefault();
                //            }
                //        }
                //        else
                //        {
                //            results = datas.ToList();
                //        }
                //        a = results.OrderByDescending(x => x.MoveToProject).ThenByDescending(x => x.CreatedDate).ToList();

                //        string countryType = "";
                //        var companyData = db.SZ_CompanyList.Where(x => x.Id == cid).FirstOrDefault();
                //        if (companyData != null)
                //        {
                //            countryType = companyData.CountryType;
                //            ViewBag.ClientsuggestedComment = companyData.ClientSuggestedComment;
                //        }

                //        int productId = a.Select(x => x.ProductId.Value).FirstOrDefault();
                //        var synzealCompData = new SZ_CompanyList();
                //        if (countryType == "Domestic")
                //        {
                //            synzealCompData = db.SZ_CompanyList.Where(x => x.Id == 2514).FirstOrDefault();
                //        }
                //        else
                //        {
                //            synzealCompData = db.SZ_CompanyList.Where(x => x.Id == 2515).FirstOrDefault();
                //        }

                //        var szquotedetails = db.SZ_QuotationDetail.Where(x => x.SZ_Quotation.CompanyId == synzealCompData.Id && x.ProductId == productId).FirstOrDefault();
                //        if (szquotedetails != null)
                //        {
                //            ViewBag.SynzealPrice = szquotedetails.Price;
                //        }
                //    }
                //}
                //else
                //{

                var quoteHideCompanyListIds = db.SZ_CompanyList.Where(x => x.IsQuoteHide == true && x.Id != cid).Select(x => x.Id).ToList();

                var model = (from x in db.SZ_QuotationDetail
                             where ((x.SZ_Quotation.IsPark == false || x.SZ_Quotation.IsPark == null)
                             && x.SZ_Quotation.CompanyId != 2514
                             && x.SZ_Quotation.CompanyId != 2515
                             && !string.IsNullOrEmpty(x.SZ_Quotation.ApprovedBy))
                             && (x.SZ_Quotation.CompanyId.HasValue && !quoteHideCompanyListIds.Contains(x.SZ_Quotation.CompanyId.Value))
                             && (x.IsQuoteHide == null || x.IsQuoteHide == false)
                             //|| (string.IsNullOrEmpty(x.SZ_Quotation.ApprovedBy) &&
                             //    x.SZ_Quotation.CreatedDate >= twoweekdays)
                             select x).AsQueryable();

                var allmodel = model;
                if (productIds > 0)
                {
                    //var reg = "/^-?\d*\.?\d*$/";
                    //if(Regex.IsMatch(ProductName))
                    //model = model.Where(x => x.ProductId == productIds || x.SZ_Quotation.Ref.Trim().ToLower().Contains(ProductName.ToLower())).AsQueryable();
                    model = model.Where(x => x.ProductId == productIds).AsQueryable();
                }
                else
                {
                    if (!string.IsNullOrEmpty(ProductName))
                    {
                        ProductName = ProductName.Trim();
                        if (ProductName.ToLower().StartsWith("sz-"))
                        {
                            model = model.Where(x => x.CATNo.ToLower().Contains(ProductName.ToLower())
                                                     || x.SZ_Quotation.Ref.Trim().ToLower().Contains(ProductName.ToLower())
                                                     );
                        }
                        else if (Regex.IsMatch(ProductName.Replace("-", ""), @"^-?\d+$"))
                        {
                            model = model.Where(x => x.CASNo.ToLower().Contains(ProductName.ToLower())
                                                    || x.SZ_Quotation.Ref.Trim().ToLower().Contains(ProductName.ToLower()));
                        }
                        else
                        {
                            model = model.Where(x => x.ProductName.ToLower().Contains(ProductName.ToLower()) || x.SZ_Quotation.Ref.Trim().ToLower().Contains(ProductName.ToLower()));
                        }
                    }
                }

                if (isApi)
                {
                    var categoryData = db.Categories.ToList();
                    var productCategoryData = db.Product_Category_Mapping.ToList();
                    var product = db.Products.Where(x => x.Sku.ToLower().Contains(ProductName.ToLower()) && x.Published == true && x.Deleted == false).FirstOrDefault();
                    if (product != null)
                    {
                        var allcats = GetApiAllProduct(product.Id, categoryData, productCategoryData);
                        if (allcats != null && allcats.Count > 0)
                        {
                            model = (from x in db.SZ_QuotationDetail
                                     where allcats.Contains(x.CATNo)
                                     && x.SZ_Quotation.CompanyId == cid
                                     select x).AsQueryable();
                        }
                    }
                }

                var outputModel = new List<SZ_QuotationDetail>();
                if (!string.IsNullOrEmpty(company) && company != "undefined")
                {
                    outputModel = model.Where(x => (x.SZ_Quotation.CompanyId == cid && !string.IsNullOrEmpty(x.SZ_Quotation.PONo)) ||
                                                     (x.SZ_Quotation.CompanyId != cid && !string.IsNullOrEmpty(x.SZ_Quotation.PONo)) ||
                                                     (x.SZ_Quotation.CompanyId == cid && string.IsNullOrEmpty(x.SZ_Quotation.PONo)) ||
                                                     (x.SZ_Quotation.CompanyId != cid && string.IsNullOrEmpty(x.SZ_Quotation.PONo))).OrderByDescending(x => x.Id).ToList();
                }
                if (outputModel == null || outputModel.Count == 0)
                {
                    outputModel = (from x in db.SZ_QuotationDetail
                                   where x.SZ_Quotation.PONo == ProductName
                                   select x).OrderByDescending(x => x.Id).ToList();
                }

                var results = outputModel;
                if (QuoteId != 0)
                {
                    var szalreadydetails = allmodel.Where(x => x.QuoteId == QuoteId).ToList();
                    if (szalreadydetails != null && szalreadydetails.Count > 0)
                    {
                        ViewBag.QuoteCompanyId = szalreadydetails[0].SZ_Quotation.CompanyId;

                        var ids = szalreadydetails.Select(x => x.Id).ToList();
                        results = results.Where(x => !ids.Contains(x.Id)).ToList();

                        if (quotedetailsid > 0)
                        {
                            ViewBag.CurrentQuoteDetailsPrice = szalreadydetails.Where(x => x.Id == quotedetailsid).Select(x => x.Price).FirstOrDefault();
                        }
                    }
                }
                if (SessionCookieManagement.UserEmail == "shailesh@synzeal.com" ||
                    SessionCookieManagement.UserEmail == "karan@synzeal.com")
                {
                    a = results.OrderByDescending(x => x.CreatedDate).ToList();
                }
                else
                {
                    a = results.OrderByDescending(x => x.MoveToProject).ThenByDescending(x => x.CreatedDate).ToList();
                }
                string countryType = "";
                var companyData = db.SZ_CompanyList.Where(x => x.Id == cid).FirstOrDefault();
                if (companyData != null)
                {
                    countryType = companyData.CountryType;
                    ViewBag.ClientsuggestedComment = companyData.ClientSuggestedComment;
                }

                int productId = a.Select(x => x.ProductId.Value).FirstOrDefault();
                var synzealCompData = new SZ_CompanyList();
                if (countryType == "Domestic")
                {
                    synzealCompData = db.SZ_CompanyList.Where(x => x.Id == 2514).FirstOrDefault();
                }
                else
                {
                    synzealCompData = db.SZ_CompanyList.Where(x => x.Id == 2515).FirstOrDefault();
                }

                var szquotedetails = db.SZ_QuotationDetail.Where(x => x.SZ_Quotation.CompanyId == synzealCompData.Id && x.ProductId == productId).FirstOrDefault();
                if (szquotedetails != null)
                {
                    ViewBag.SynzealPrice = szquotedetails.Price;
                }
                //}
                return PartialView("_PartialPreviousProductList", a);
            }
            catch (Exception ex)
            {
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { type = "fail", data = ex.Message }
                };
            }
        }

        public JsonResult GetProduct(string term)
        {
            List<ProductOverviewModel> model = new List<ProductOverviewModel>();
            var nationalityList = db.Products.Where(x => x.Name.Contains(term)).ToList();
            if (nationalityList.Count > 0)
            {
                foreach (var i in nationalityList)
                {
                    ProductOverviewModel subModel = new ProductOverviewModel();
                    subModel.Id = i.Id;
                    subModel.Name = i.Name;
                    model.Add(subModel);
                }
            }
            return Json(model, JsonRequestBehavior.AllowGet);
        }

        public JsonResult GetAllEmailByCompanyId(int compId)
        {
            // var model = db.SZ_Quotation.Where(x => x.CompanyId == compId).Select(x => x.EmailAddress).Distinct().ToList();
            var model = db.GetAllEmail(compId).ToList();
            return Json(model, JsonRequestBehavior.AllowGet);
        }

        public JsonResult GetAllEmail()
        {
            //var model = db.SZ_Quotation.Select(x => x.EmailAddress).OrderBy(x => x).Distinct().ToList();
            var model = db.GetAllEmail(0).ToList();
            return Json(model, JsonRequestBehavior.AllowGet);
        }

        public JsonResult GetAllProductName(string value)
        {
            var model = db.getallproductname(value).ToList();
            // var model = db.Products.Where(x => x.Name.Contains(value) || x.Synonym.Contains(value)).Select(x => x.Name).OrderBy(x => x).Distinct().Take(10).ToList();
            return Json(model, JsonRequestBehavior.AllowGet);
        }

        public JsonResult MarkAsQc(int id)
        {
            try
            {
                var model = _operationRepository.GetQuoteDetailByID(id);
                if (model != null)
                {
                    model.IsQC = true;
                    model.QCdate = DateTime.Now;
                    db.Entry(model).State = EntityState.Modified;
                    db.SaveChanges();
                }
                return Json(true, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(false, JsonRequestBehavior.AllowGet);
            }
        }

        public JsonResult RemoveAsQc(int id)
        {
            try
            {
                var model = _operationRepository.GetQuoteDetailByID(id);
                if (model != null)
                {
                    model.IsQC = false;
                    db.Entry(model).State = EntityState.Modified;
                    db.SaveChanges();
                }
                return Json(true, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(false, JsonRequestBehavior.AllowGet);
            }
        }

        public JsonResult MarkAsPurchase(int id)
        {
            try
            {
                var model = _operationRepository.GetQuoteDetailByID(id);
                if (model != null)
                {
                    model.IsPurchase = true;
                    model.QuotePurchaseDate = DateTime.Now;
                    db.Entry(model).State = EntityState.Modified;
                    db.SaveChanges();
                }
                return Json(true, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(false, JsonRequestBehavior.AllowGet);
            }
        }

        public JsonResult RemoveAsPurchase(int id)
        {
            try
            {
                var model = _operationRepository.GetQuoteDetailByID(id);
                if (model != null)
                {
                    model.IsPurchase = false;
                    db.Entry(model).State = EntityState.Modified;
                    db.SaveChanges();
                }
                return Json(true, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(false, JsonRequestBehavior.AllowGet);
            }
        }

        public JsonResult GetCompanyDetailsFromEmail(string email)
        {
            // var model = db.SZ_Quotation.Where(x => x.EmailAddress.ToLower().Trim() == email.ToLower().Trim()).Select(x => x.CompanyId).Distinct().ToList();
            var model = db.GetCompanyDetailsFromEmail(email.ToLower().Trim()).ToList();
            return Json(model, JsonRequestBehavior.AllowGet);
        }

        public ActionResult Inventory()
        {
            if (!SessionCookieManagement.IsInventory)
            {
                return RedirectToAction("Index", "Home");
            }
            return View();
        }

        public ActionResult Dispatch()
        {
            if (!SessionCookieManagement.IsAdmin
                && !SessionCookieManagement.IsDispatch
                && !SessionCookieManagement.IsDomesticDispatch
                && !SessionCookieManagement.IsExportDispatch
                && !SessionCookieManagement.IsProjectLogin
                && !SessionCookieManagement.IsQC
                && !SessionCookieManagement.IsDocumentation)
            {
                return RedirectToAction("Index", "Home");
            }

            var prostatusItem = new List<SelectListItem>();
            prostatusItem.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            foreach (EnumList.DispatchStatusDDl r in Enum.GetValues(typeof(EnumList.DispatchStatusDDl)))
            {
                var item = Enum.GetName(typeof(EnumList.DispatchStatusDDl), r);
                var test = r.ToString();
                string text = SZ_Helper.GetEnumDescription((EnumList.DispatchStatusDDl)(int)r);
                int val = (int)r;
                prostatusItem.Add(new SelectListItem
                {
                    Text = text,
                    Value = val.ToString()
                });
            }
            ViewBag.fltprostatusItem = prostatusItem;

            var protypeItem = new List<SelectListItem>();
            protypeItem.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
            {
                var item = Enum.GetName(typeof(EnumList.ProjectType), r);
                var test = r.ToString();
                string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
                int val = (int)r;
                protypeItem.Add(new SelectListItem
                {
                    Text = text,
                    Value = val.ToString()
                });
            }
            ViewBag.fltprotypeItem = protypeItem;

            var proactivitystatusItem = new List<SelectListItem>();
            proactivitystatusItem.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            proactivitystatusItem.Add(new SelectListItem
            {
                Text = "Approval First",
                Value = "Approval First"
            });
            proactivitystatusItem.Add(new SelectListItem
            {
                Text = "Repeat Order",
                Value = "Repeat Order"
            });
            proactivitystatusItem.Add(new SelectListItem
            {
                Text = "Repeat Order - Dispatch",
                Value = "Repeat Order - Dispatch"
            });
            proactivitystatusItem.Add(new SelectListItem
            {
                Text = "Repeat Order - Approval First",
                Value = "Repeat Order - Approval First"
            });
            proactivitystatusItem.Add(new SelectListItem
            {
                Text = "Short Qty Dispatch",
                Value = "Short Qty Dispatch"
            });
            proactivitystatusItem.Add(new SelectListItem
            {
                Text = "Short Qty Dispatched",
                Value = "Short Qty Dispatched"
            });
            proactivitystatusItem.Add(new SelectListItem
            {
                Text = "Sample Request",
                Value = "Sample Request"
            });
            proactivitystatusItem.Add(new SelectListItem
            {
                Text = "Sample Sent",
                Value = "Sample Sent"
            });
            proactivitystatusItem.Add(new SelectListItem
            {
                Text = "Sample Approved",
                Value = "Sample Approved"
            });
            //proactivitystatusItem.Add(new SelectListItem
            //{
            //    Text = "Insufficient QTY",
            //    Value = "Insufficient QTY"
            //});
            proactivitystatusItem.Add(new SelectListItem
            {
                Text = "Quote - Data Sent",
                Value = "Quote - Data Sent"
            });
            proactivitystatusItem.Add(new SelectListItem
            {
                Text = "Quote - Data Approved",
                Value = "Quote - Data Approved"
            });
            ViewBag.fltproactivitystatusItem = proactivitystatusItem;

            return View();
        }

        public ActionResult Invoice()
        {
            if (!SessionCookieManagement.IsAdmin
                    && !SessionCookieManagement.IsInvoice
                    && !SessionCookieManagement.IsInternational
                    && !SessionCookieManagement.IsDomesticDispatch
                    && !SessionCookieManagement.IsExportDispatch)
            {
                return RedirectToAction("Index", "Home");
            }
            var listItems = new List<SelectListItem>();
            listItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var compList = db.SZ_CompanyList.OrderBy(x => x.Name).ToList();
            foreach (var term in compList)
            {
                listItems.Add(new SelectListItem
                {
                    Text = term.Name,
                    Value = term.Id.ToString()
                });
            }

            ViewBag.listCompItems = listItems;
            return View(new List<SZ_QuotationModel>());
        }

        public ActionResult ExportQuoteInvoiceList(string countryType)
        {
            int page = 1;
            int rows = Int32.MaxValue;
            var model = db.InvoiceList(countryType, "", "", "", "", "", page, rows).ToList();
            int pageIndex = Convert.ToInt32(page) - 1;
            int pageSize = rows;
            //var categoryData = db.Categories.ToList();
            //var productCategoryData = db.Product_Category_Mapping.ToList();
            MemoryCacheManager objCache = new MemoryCacheManager();

            var productsData = objCache.Get("cache.productsdata", () =>
            {
                return db.Products.Where(x => x.Published == true && x.Deleted == false).ToList();
            });
            System.Web.UI.WebControls.GridView gv = new System.Web.UI.WebControls.GridView();
            var modelExportdata = (from q in db.SZ_Quotation
                                   join qd in db.SZ_QuotationDetail on q.Id equals qd.QuoteId
                                   where qd.MoveToInvoice == true
                                   select new ExportInvoiceModel()
                                   {
                                       APIName = "",
                                       ProductId = qd.ProductId,
                                       CountryType = q.CountryType,
                                       BatchNo = qd.InvoiceBatchNo,
                                       Courier = qd.Courier,
                                       DeliveryStatus = qd.DeliveryStatus,
                                       DataPending = qd.DataPending,
                                       PaymentStatus = qd.PaymentStatus,
                                       PurposeDispatch = qd.PurposeDispatch,
                                       TrackingNo = qd.TrackingNo,
                                       Location = qd.Location,
                                       DeliveryDate = qd.DeliveryDate,
                                       InvoiceNo = qd.InvoiceNo,
                                       InvoiceRemark = qd.InvoiceRemark,
                                       RefName = qd.RefName,
                                       PackDate = qd.PackDate,
                                       ProductName = qd.ProductName,
                                       RequiredQty = qd.RequiredQty,
                                       LeadTime = qd.LeadTime,
                                       ProductRemark = qd.ProductRemark,
                                       Price = qd.Price,
                                       CASNo = qd.CASNo,
                                       CATNo = qd.CATNo,
                                       InvoicedDate = qd.InvoicedDate,
                                       Ref = q.Ref,
                                       CompanyName = q.CompanyName,
                                       PONo = q.PONo,
                                       PODate = q.PODate,
                                       EmailAddress = q.EmailAddress,
                                       Remark = qd.Remark,
                                       OrderRemark = qd.OrderRemark,
                                       COARefNumber = qd.COARefNumber
                                   }).ToList();

            foreach (var item in modelExportdata)
            {
                item.APIName = GetApiNameOfProduct(item.ProductId.Value, productsData);
            }

            gv.DataSource = modelExportdata;
            gv.DataBind();
            Response.ClearContent();
            Response.Buffer = true;
            Response.AddHeader("content-disposition", "attachment; filename=Invoice_" + DateTime.Now.Year + DateTime.Now.ToString("MM") + DateTime.Now.ToString("dd") + ".xls");
            Response.ContentType = "application/ms-excel";
            Response.Charset = "";
            StringWriter sw = new StringWriter();
            HtmlTextWriter htw = new HtmlTextWriter(sw);
            gv.RenderControl(htw);

            string passstr = sw.ToString().Replace(" 00:00:00", "");
            string filePath = Server.MapPath("~/Content/ExportExcel/");
            string fileName = "Invoice_" + DateTime.Now.Year + DateTime.Now.ToString("MM") + DateTime.Now.ToString("dd") + ".xls";

            // Write the rendered content to a file.
            System.IO.File.WriteAllText(filePath + fileName, passstr);
            return Json("../Content/ExportExcel/" + fileName, JsonRequestBehavior.AllowGet);
        }

        public ActionResult ExportQuoteDataList(string date)
        {
            DateTime today = DateTime.Now;
            if (!string.IsNullOrEmpty(date))
            {
                today = Convert.ToDateTime(date);
            }
            TimeSpan sts = new TimeSpan(0, 0, 0);
            TimeSpan ets = new TimeSpan(23, 59, 59);

            var Startdate = today.Add(sts);
            var Enddate = today.Add(ets);

            int page = 1;
            int rows = Int32.MaxValue;
            int pageIndex = Convert.ToInt32(page) - 1;
            int pageSize = rows;
            MemoryCacheManager objCache = new MemoryCacheManager();

            System.Web.UI.WebControls.GridView gv = new System.Web.UI.WebControls.GridView();
            var modelExportdata = (from q in db.SZ_Quotation
                                   join qd in db.SZ_QuotationDetail on q.Id equals qd.QuoteId
                                   where q.CreatedDate >= Startdate && q.CreatedDate <= Enddate
                                   select new
                                   {
                                       CompanyName = q.CompanyName,
                                       EmailAddress = q.EmailAddress,
                                       Ref = q.Ref,
                                       ProductName = qd.ProductName,
                                       CASNo = qd.CASNo,
                                       CATNo = qd.CATNo,
                                       LeadTime = qd.LeadTime,
                                       Price = qd.Price
                                   }).OrderBy(x => x.Ref).ToList();

            gv.DataSource = modelExportdata;
            gv.DataBind();
            Response.ClearContent();
            Response.Buffer = true;
            Response.AddHeader("content-disposition", "attachment; filename=Invoice_" + DateTime.Now.Year + DateTime.Now.ToString("MM") + DateTime.Now.ToString("dd") + ".xls");
            Response.ContentType = "application/ms-excel";
            Response.Charset = "";
            StringWriter sw = new StringWriter();
            HtmlTextWriter htw = new HtmlTextWriter(sw);
            gv.RenderControl(htw);

            string passstr = sw.ToString().Replace(" 00:00:00", "");
            string filePath = Server.MapPath("~/Content/ExportExcel/");
            string fileName = "Invoice_" + DateTime.Now.Year + DateTime.Now.ToString("MM") + DateTime.Now.ToString("dd") + ".xls";

            // Write the rendered content to a file.
            System.IO.File.WriteAllText(filePath + fileName, passstr);
            return Content("http://spms.synzeal.com/Content/ExportExcel/" + fileName);
        }

        public ActionResult ExportInvoiceData(string companyname, string fltcontrolledsubstance, string fltstartdate, string fltenddate, string type)
        {
            string searchValue = "";
            string internationcompanylist = "";
            if (!string.IsNullOrEmpty(companyname))
            {
                internationcompanylist = companyname;
            }

            if (SessionCookieManagement.IsInternational)
            {
                internationcompanylist = db.SZ_UserManagement.Where(x => x.UserId == SessionCookieManagement.UserId).Select(x => x.CompanyIds).FirstOrDefault();
            }
            int pageNo = 1;
            int numberOfObjectsPerPage = int.MaxValue;
            var model = db.InvoiceList(type, searchValue, internationcompanylist, fltcontrolledsubstance, fltstartdate, fltenddate, pageNo, numberOfObjectsPerPage).ToList();
            if (SessionCookieManagement.IsInternational)
            {
                model = model.Where(x => x.CreatedDate >= new DateTime(2022, 05, 01)).ToList();
            }
            var data = PrepareInvoiceListModel(model);

            ExcelPackage ExcelPkg = new ExcelPackage();
            ExcelWorksheet wsSheet1 = ExcelPkg.Workbook.Worksheets.Add("Sheet1");
            wsSheet1.DefaultColWidth = 16;
            wsSheet1.Protection.IsProtected = false;
            wsSheet1.Protection.AllowSelectLockedCells = false;
            wsSheet1.Cells.AutoFitColumns(14, 40);
            wsSheet1.Column(3).Width = 40;
            wsSheet1.Column(3).Style.WrapText = true;

            int loopCount = 2;
            wsSheet1.Cells[loopCount, 1].Value = "Sr No";
            wsSheet1.Cells[loopCount, 2].Value = "Invoice Date";
            wsSheet1.Cells[loopCount, 3].Value = "PO No";
            wsSheet1.Cells[loopCount, 4].Value = "Company Name";
            wsSheet1.Cells[loopCount, 5].Value = "Product Name";
            wsSheet1.Cells[loopCount, 6].Value = "CAT No";
            wsSheet1.Cells[loopCount, 7].Value = "CAS No";
            wsSheet1.Cells[loopCount, 8].Value = "Qty (mg)";
            wsSheet1.Cells[loopCount, 9].Value = "Batch No";
            wsSheet1.Cells[loopCount, 10].Value = "COA";
            wsSheet1.Cells[loopCount, 11].Value = "Courier";
            wsSheet1.Cells[loopCount, 12].Value = "Tracking No";
            wsSheet1.Cells[loopCount, 13].Value = "Location";
            wsSheet1.Cells[loopCount, 14].Value = "Reference Name";
            wsSheet1.Cells[loopCount, 15].Value = "Purpose of dispatch";
            wsSheet1.Cells[loopCount, 16].Value = "Delivery Date";
            wsSheet1.Cells[loopCount, 17].Value = "Delivery Status";
            wsSheet1.Cells[loopCount, 18].Value = "Data Pending";
            wsSheet1.Cells[loopCount, 19].Value = "Data Remark";
            wsSheet1.Cells[loopCount, 20].Value = "Pack Size";
            wsSheet1.Cells[loopCount, 21].Value = "Invoice Remark";
            wsSheet1.Cells[loopCount, 22].Value = "Invoice No";
            wsSheet1.Cells[loopCount, 23].Value = "Payment Status";
            using (ExcelRange Rng = wsSheet1.Cells[loopCount, 1, loopCount, 23])
            {
                Rng.Style.Font.Bold = true;
                Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#7b7b7b");
                Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                Rng.Style.Font.Color.SetColor(Color.White);
                Rng.Style.WrapText = true;
            }

            loopCount = loopCount + 1;
            int srno = 1;
            foreach (var quote in data)
            {
                wsSheet1.Cells[loopCount, 1].Value = srno;
                wsSheet1.Cells[loopCount, 2].Value = quote.InvoicedDate;
                wsSheet1.Cells[loopCount, 3].Value = quote.PONo;
                wsSheet1.Cells[loopCount, 4].Value = quote.CompanyName;
                wsSheet1.Cells[loopCount, 5].Value = quote.ProductName;
                wsSheet1.Cells[loopCount, 6].Value = quote.CASNo;
                wsSheet1.Cells[loopCount, 7].Value = quote.CATNo;
                wsSheet1.Cells[loopCount, 8].Value = quote.RequiredQty;
                wsSheet1.Cells[loopCount, 9].Value = quote.InvoiceBatchNo;
                wsSheet1.Cells[loopCount, 10].Value = quote.COARefNumber;
                wsSheet1.Cells[loopCount, 11].Value = quote.Courier;
                wsSheet1.Cells[loopCount, 12].Value = quote.TrackingNo;
                wsSheet1.Cells[loopCount, 13].Value = quote.Location;
                wsSheet1.Cells[loopCount, 14].Value = quote.RefName;
                wsSheet1.Cells[loopCount, 15].Value = quote.PurposeDispatch;
                wsSheet1.Cells[loopCount, 16].Value = quote.DeliveryDate;
                wsSheet1.Cells[loopCount, 17].Value = quote.DeliveryStatus;
                wsSheet1.Cells[loopCount, 18].Value = quote.DataPending;
                wsSheet1.Cells[loopCount, 19].Value = quote.Remark;
                wsSheet1.Cells[loopCount, 20].Value = quote.OrderRemark;
                wsSheet1.Cells[loopCount, 21].Value = quote.InvoiceRemark;
                wsSheet1.Cells[loopCount, 22].Value = quote.InvoiceNoStr;
                wsSheet1.Cells[loopCount, 23].Value = quote.PaymentStatus;
                srno += 1;
                loopCount += 1;
            }
            string filePath = HostingEnvironment.MapPath("~/Content/Quotation/") + "InvoiceReport-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xlsx";
            ExcelPkg.SaveAs(new FileInfo(filePath));
            return File(filePath, "application/excel", Server.UrlEncode("InvoiceReport-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xls"));
        }

        [HttpPost]
        public ActionResult LoadInvoiceData(string countryType)
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                int numberOfObjectsPerPage = Convert.ToInt32(Request.Form["length"]);
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int pageNo = 1;
                if (skip > 0)
                {
                    pageNo = (skip / numberOfObjectsPerPage) + 1;
                }
                var companyname = "";
                string internationcompanylist = "";
                if (Request.Form.GetValues("compName") != null)
                {
                    companyname = Request.Form.GetValues("compName")[0].ToString();
                    internationcompanylist = companyname;
                }
                var fltcontrolledsubstance = "";
                if (Request.Form.GetValues("fltcontrolledsubstance") != null)
                {
                    fltcontrolledsubstance = Request.Form.GetValues("fltcontrolledsubstance")[0].ToString();
                }
                var fltstartdate = "";
                if (Request.Form.GetValues("fltstartdate") != null)
                {
                    fltstartdate = Request.Form.GetValues("fltstartdate")[0].ToString();
                }
                var fltenddate = "";
                if (Request.Form.GetValues("fltenddate") != null)
                {
                    fltenddate = Request.Form.GetValues("fltenddate")[0].ToString();
                }

                if (SessionCookieManagement.IsInternational)
                {
                    internationcompanylist = db.SZ_UserManagement.Where(x => x.UserId == SessionCookieManagement.UserId).Select(x => x.CompanyIds).FirstOrDefault();
                }
                var model = db.InvoiceList(countryType, searchValue, internationcompanylist, fltcontrolledsubstance, fltstartdate, fltenddate, pageNo, numberOfObjectsPerPage).ToList();
                if (SessionCookieManagement.IsInternational)
                {
                    model = model.Where(x => x.CreatedDate >= new DateTime(2022, 05, 01)).ToList();
                }

                int? recordsTotal = model.Select(x => x.TotalRecord).FirstOrDefault();

                var data = PrepareInvoiceListModel(model);
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        public ActionResult LoadDocumentInvoiceData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                int numberOfObjectsPerPage = Convert.ToInt32(Request.Form["length"]);
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int pageNo = 1;
                if (skip > 0)
                {
                    pageNo = (skip / numberOfObjectsPerPage) + 1;
                }
                var model = db.SZ_InvoiceDocument.OrderByDescending(x => x.CreatedDate).ToList();

                int? recordsTotal = model.Count;
                model = model.Skip((pageNo - 1) * numberOfObjectsPerPage).Take(numberOfObjectsPerPage).ToList();

                var data = PrepareInvoiceDocumentModel(model);
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        public List<InvoiceDocumentModel> PrepareInvoiceDocumentModel(List<SZ_InvoiceDocument> documents)
        {
            var model = new List<InvoiceDocumentModel>();
            foreach (var item in documents)
            {
                if (!model.Select(x => x.InvoiceNo).Contains(item.InvoiceNo))
                {
                    var docu = new List<string>();
                    docu.Add("<a href='" + item.Path + "' download> <i class='fa fa-file-pdf-o'></i></a>");
                    var objmodel = new InvoiceDocumentModel();
                    objmodel.InvoiceNo = item.InvoiceNo;
                    objmodel.Id = item.Id;
                    objmodel.Document = docu;
                    objmodel.CompanyName = db.SZ_CompanyList.Where(x => x.Id == item.CompanyId).Select(x => x.Name).FirstOrDefault();
                    objmodel.Action = "<a href='javascript: void(0)' onclick='AddInvoiceDocument(" + item.Id + ")'> View</a>";
                    model.Add(objmodel);
                }
                else
                {
                    var modeldata = model.Where(x => x.InvoiceNo == item.InvoiceNo).FirstOrDefault();
                    if (modeldata != null)
                    {
                        modeldata.Document.Add("<a href='" + item.Path + "' download> <i class='fa fa-file-pdf-o'></i></a>");
                    }
                }
            }
            return model;
        }

        public ActionResult LoadRefstockData(string apiname)
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                int numberOfObjectsPerPage = Convert.ToInt32(Request.Form["length"]);
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int pageNo = 1;
                if (skip > 0)
                {
                    pageNo = (skip / numberOfObjectsPerPage) + 1;
                }
                var model = new List<ProductModel>();
                int? recordsTotal = 0;
                var categoryData = db.Categories.Where(x => x.ParentCategoryId == 0 && x.Deleted == false && x.Name.ToLower() == apiname.Trim().ToLower()).FirstOrDefault();
                if (categoryData != null)
                {

                    var subcategoriesId = db.Categories.Where(x => x.ParentCategoryId == categoryData.Id && x.Deleted == false).Select(x => x.Id).ToList();

                    var query = (from p in db.Products
                                 join pc in db.Product_Category_Mapping on p.Id equals pc.ProductId
                                 where subcategoriesId.Contains(pc.CategoryId) &&
                                       !p.Deleted &&
                                       p.Published
                                 orderby p.Name
                                 select p).ToList();

                    model = (from q in query
                             select new ProductModel()
                             {
                                 Smile = "<input type='checkbox' value='" + q.Id + "' class='clsSaverow' />",
                                 ProductId = q.Id,
                                 Name = q.Name,
                                 Sku = q.Sku,
                                 Gtin = q.ManufacturerPartNumber,
                                 RefStockPrice = "<input type='text' id='RefStockPrice_" + q.Id + "' value='" + q.RefStockPrice + "' />"
                             }).Skip((pageNo - 1) * numberOfObjectsPerPage).Take(numberOfObjectsPerPage).ToList();
                    recordsTotal = query.Count();
                }
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = model });
            }
            catch (Exception ex)
            {
                throw ex;
            }

        }

        public ActionResult LoadPurchaseProducMasterData(string apiname, string search)
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                int numberOfObjectsPerPage = Convert.ToInt32(Request.Form["length"]);
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int pageNo = 1;
                if (skip > 0)
                {
                    pageNo = (skip / numberOfObjectsPerPage) + 1;
                }
                var model = new List<ProductMasterModel>();
                int? recordsTotal = 0;
                var query = new List<Product>();
                if (!string.IsNullOrEmpty(search))
                {
                    query = (from p in db.Products
                             where p.Name.ToLower().Contains(search.ToLower())
                                   || p.Sku.ToLower().Contains(search.ToLower())
                                   || p.ManufacturerPartNumber.ToLower().Contains(search.ToLower())
                                   && (!p.Deleted &&
                                   p.Published)
                             orderby p.Sku
                             select p).ToList();
                }
                else
                {

                    var categoryData = db.Categories.Where(x => x.ParentCategoryId == 0 && x.Deleted == false && x.Name.ToLower() == apiname.Trim().ToLower()).FirstOrDefault();
                    if (categoryData != null)
                    {

                        var subcategoriesId = db.Categories.Where(x => x.ParentCategoryId == categoryData.Id && x.Deleted == false).Select(x => x.Id).ToList();

                        query = (from p in db.Products
                                 join pc in db.Product_Category_Mapping on p.Id equals pc.ProductId
                                 where subcategoriesId.Contains(pc.CategoryId) && !p.Deleted && p.Published
                                 orderby p.Sku
                                 select p).ToList();
                    }
                }
                var proids = query.Select(x => x.Id).ToList();
                var inventorydata = db.SZ_Inventory.Where(x => proids.Contains(x.ProductId)).ToList();
                foreach (var q in query)
                {
                    var obj = new ProductMasterModel();
                    obj.ChkRow = "<input type='checkbox' value='" + q.Id + "' class='clsSaverow' /> ";
                    obj.ProductRemark = "<div><img src='" + obj.ImagePath + "' width='100%'></div>";
                    obj.Id = q.Id;
                    obj.ProductName = q.Name;
                    obj.catNo = q.Sku;
                    obj.casno = q.ManufacturerPartNumber;
                    obj.MW = q.MolecularWeight;
                    obj.MF = q.Gtin;
                    obj.Quotationreceived = "<textarea id='Quotationreceived_" + q.Id + "' value='" + q.Quotationreceived + "' data-value='" + q.Quotationreceived + "' class='clsquotationreceived' style='width:100%' rows='4' ></textarea>";
                    obj.PurchaseComment = "<textarea id='PurchaseComment_" + q.Id + "' value='" + q.PurchaseComment + "'  data-value='" + q.PurchaseComment + "' class='clspurchasecommnet' style='width:100%' rows='4'></textarea>";
                    model.Add(obj);
                }
                var instockother = Request.Form.GetValues("instockother")[0].ToString();
                if (!string.IsNullOrEmpty(instockother))
                {
                    var splitfilters = instockother.Split(',');
                    if (splitfilters[0] == "true" && splitfilters[1] == "true")
                    {

                    }
                    else
                    {
                        if (splitfilters[0] == "true")
                        {
                            model = model.Where(x => x.IsBatchAvailable).ToList();
                        }
                        if (splitfilters[1] == "true")
                        {
                            model = model.Where(x => !x.IsBatchAvailable).ToList();
                        }
                    }
                }
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.casno != null && m.casno.ToLower().Contains(searchValue))
                                        || (m.catNo != null && m.catNo.ToLower().Contains(searchValue))
                                       || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))
                                       ).ToList();
                }

                model = model.Skip((pageNo - 1) * numberOfObjectsPerPage).Take(numberOfObjectsPerPage).ToList();
                recordsTotal = query.Count();

                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = model });
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        public ActionResult LoadProducMasterData(string apiname, string search)
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                int numberOfObjectsPerPage = Convert.ToInt32(Request.Form["length"]);
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int pageNo = 1;
                if (skip > 0)
                {
                    pageNo = (skip / numberOfObjectsPerPage) + 1;
                }
                var model = new List<ProductMasterModel>();
                int? recordsTotal = 0;
                var query = new List<Product>();
                var shippingConditions = Request.Form.GetValues("shippingConditions")[0].ToString();

                if (!string.IsNullOrEmpty(shippingConditions))
                {
                    query = (from p in db.Products
                             where p.ShippingCondition == shippingConditions
                                   && (!p.Deleted &&
                                   p.Published)
                             orderby p.Sku
                             select p).ToList();
                    query = query.Where(x => x.ShippingCondition == shippingConditions).ToList();
                }
                else
                {
                    if (!string.IsNullOrEmpty(search))
                    {
                        query = (from p in db.Products
                                 where p.Name.ToLower().Contains(search.ToLower())
                                       || p.Sku.ToLower().Contains(search.ToLower())
                                       || p.ManufacturerPartNumber.ToLower().Contains(search.ToLower())
                                       && (!p.Deleted &&
                                       p.Published)
                                 orderby p.Sku
                                 select p).ToList();
                    }
                    else
                    {

                        var categoryData = db.Categories.Where(x => x.ParentCategoryId == 0 && x.Deleted == false && x.Name.ToLower() == apiname.Trim().ToLower()).FirstOrDefault();
                        if (categoryData != null)
                        {

                            var subcategoriesId = db.Categories.Where(x => x.ParentCategoryId == categoryData.Id && x.Deleted == false).Select(x => x.Id).ToList();

                            query = (from p in db.Products
                                     join pc in db.Product_Category_Mapping on p.Id equals pc.ProductId
                                     where subcategoriesId.Contains(pc.CategoryId) && !p.Deleted && p.Published
                                     orderby p.Sku
                                     select p).ToList();
                        }
                    }
                }


                var proids = query.Select(x => x.Id).ToList();
                var inventorydata = db.SZ_Inventory.Where(x => proids.Contains(x.ProductId)).ToList();
                foreach (var q in query)
                {
                    var obj = new ProductMasterModel();
                    obj.ProductRemark = "<input type='text' id='ProductRemark_" + q.Id + "' value='" + q.ProductRemark + "' />";
                    obj.IsBatchAvailable = false;
                    obj.Id = q.Id;
                    obj.ProductName = q.Name;
                    obj.catNo = q.Sku;
                    obj.casno = q.ManufacturerPartNumber;
                    obj.ProductStatus = q.ProductStat;
                    obj.DdlStatus = "<select class='clsDllstatus' id='DdlStatus_" + q.Id + "' data-value='" + q.DdlStatus + "'> <option value='To be Synthesize'>To be Synthesize</option>" +
                        "<option value='Sourced'>Sourced</option>" +
                        "<option value='Bulk Source'>Bulk Source</option></select>";
                    obj.LeadTime = "<input type='text' id='LeadTime_" + q.Id + "' value='" + q.LeadTime + "' />";
                    obj.Appearance = "<input type='text' id='Appearance_" + q.Id + "' value='" + q.Appearance + "' />";
                    obj.ReTestRequired = "<input type='text' id='ReTestRequired_" + q.Id + "' value='" + q.ReTestRequired + "' />";
                    //obj.ShippingCondition = "<input type='text' id='ShippingCondition_" + q.Id + "' value='" + q.ShippingCondition + "' />";

                    obj.ShippingCondition = "<select class='clsshippingCondition' id='ShippingCondition_" + q.Id + "' data-value='" + q.ShippingCondition + "'> <option value=''>Select</option>" +
                        "<option value='Ambient Temperature'>Ambient Temperature</option>" +
                        "<option value='Ice Pack'>Ice Pack</option>" +
                        "<option value='Cold Shipment'>Cold Shipment</option></select>";
                    obj.EndUse = "<select class='clsEndUse' id='EndUse_" + q.Id + "' data-value='" + q.EndUse + "'> <option value=''>Select</option>" +
                        "<option value='Assay'>Assay</option>" +
                        "<option value='Resolution'>Resolution</option></select>";
                    if (q.SourceRequired.HasValue && q.SourceRequired.Value)
                    {
                        obj.SourceRequired = "<input type='checkbox' id='SourceRequired_" + q.Id + "' checked />";
                    }
                    else
                    {
                        obj.SourceRequired = "<input type='checkbox' id='SourceRequired_" + q.Id + "' />";
                    }
                    if (q.IsControlledSubstance.HasValue && q.IsControlledSubstance.Value)
                    {
                        obj.ControlledSubstance = "<input type='checkbox' class='clsControlledSubstance' id='IsControlledSubstance_" + q.Id + "' checked />";
                    }
                    else
                    {
                        obj.ControlledSubstance = "<input type='checkbox' class='clsControlledSubstance' id='IsControlledSubstance_" + q.Id + "' />";

                    }
                    if (q.IsManuallyControlledSubstance.HasValue && q.IsManuallyControlledSubstance.Value)
                    {
                        obj.ManualControlledSubstance = "<input type='checkbox' class='clsManualControlledSubstance' id='IsManuallyControlledSubstance_" + q.Id + "' checked />";
                    }
                    else
                    {
                        obj.ManualControlledSubstance = "<input type='checkbox' class='clsManualControlledSubstance' id='IsManuallyControlledSubstance_" + q.Id + "' />";

                    }
                    obj.Source = "<input type='text' id='Source_" + q.Id + "' value='" + q.Source + "' />";
                    obj.ChkRow = "<input type='checkbox' value='" + q.Id + "' class='clsSaverow' /> <div class='clsimageproduct' style='display:none'><img src='" + obj.ImagePath + "' width='100%'></div>";

                    obj.Description = "<input type='text' id='Description_" + q.Id + "' value='" + q.ShortDescription + "' />";
                    obj.HSNCode = "<input type='text'  class='clshsncode' id='HSNCode_" + q.Id + "' value='" + q.HSNCode + "' />";
                    obj.DangGoodToShip = "<input type='text' class='clsDangGoodToShip' id='DangGoodToShip_" + q.Id + "' value='" + q.DangGoodToShip + "' />";
                    obj.CountryOrigin = "<input type='text' class='clscountryorigin' id='CountryOrigin_" + q.Id + "' value='" + q.CountryOrigin + "' />";
                    obj.SameAs = "<input type='text' id='SameAs_" + q.Id + "' value='" + q.SameAs + "' />";

                    if (q.IsTracebilityEnable.HasValue && q.IsTracebilityEnable.Value)
                    {
                        obj.IsTracebility = "<input type='checkbox' id='IsTracebility_" + q.Id + "' checked />";
                    }
                    else
                    {
                        obj.IsTracebility = "<input type='checkbox' id='IsTracebility_" + q.Id + "'  />";
                    }
                    if (q.IsTechnicalReport.HasValue && q.IsTechnicalReport.Value)
                    {
                        obj.IsTechnicalReport = "<input type='checkbox' id='IsTechnicalReport_" + q.Id + "' class='clsTechnicalReport' checked />";
                    }
                    else
                    {
                        obj.IsTechnicalReport = "<input type='checkbox' id='IsTechnicalReport_" + q.Id + "' class='clsTechnicalReport'  />";
                    }
                    obj.TracebilityComment = "<input type='text' id='TracebilityComment_" + q.Id + "' value='" + q.TracebilityComment + "' />";
                    obj.Important = "<select class='clsImportant' id='Important_" + q.Id + "' data-value='" + q.Important + "'> <option value='0'>0</option>" +
                        "<option value='1'>1</option>" +
                        "<option value='2'>2</option>" +
                        "<option value='3'>3</option></select>";
                    obj.ProductDdlStatus = "<select class='clsproductDllstatus' id='productDdlStatus_" + q.Id + "' data-value='" + q.ProductStat + "'> <option value=''>Select</option>" +
                        "<option value='In Stock'>In Stock</option>" +
                        "<option value='In Stock, 3-4 days for Dispatch'>In Stock, 3-4 days for Dispatch</option>" +
                        "<option value='Limited Stock'>Limited Stock</option>" +
                        "<option value='Out of Stock'>Out of Stock</option>" +
                        "<option value='Out of Stock, Under Synthesis'>Out of Stock, Under Synthesis</option>" +
                        "<option value='Under QC Approval'>Under QC Approval</option>" +
                        "<option value='Under Synthesis'>Under Synthesis</option>" +
                        "<option value='Custom Synthesis'>Custom Synthesis</option>" +
                        "<option value='Discontinued'>Discontinued</option><option value='Inquire'>Inquire</option></select>";

                    obj.AdditionalBatchNoText = "<select id='additionalBatch_" + q.Id + "' class='addbatch'><option value=''>--Select--</option>";
                    var proBatchData = inventorydata.Where(x => x.ProductId == q.Id).OrderBy(x => x.Id).ToList();
                    if (proBatchData.Count > 0)
                    {
                        int probatchcount = 1;
                        foreach (var r in proBatchData)
                        {
                            string qty = CommonOperation.SettleQtyForSPMS(r);

                            string text = r.BatchNo + " (" + qty + ")";
                            if (r.IsApproved == false)
                            {
                                text = "*" + text;
                            }

                            obj.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' data-value='" + r.BatchNo + "'>" + text + "</option>";
                            probatchcount += 1;
                        }
                        obj.IsBatchAvailable = true;
                    }
                    obj.AdditionalBatchNoText += "</select>";
                    obj.BatchDataCheck = "<i class='fa fa-pencil' onclick='batchpopup(" + q.Id + ")'></i>";

                    obj.IR = "<a href='' id='IR_" + q.Id + "' target='_blank'></a>";
                    obj.Mass = "<a href='' id='Mass_" + q.Id + "'  target='_blank'></a>";
                    obj.HPLCGCELSD = "<a href='' id='HPLCGCELSD_" + q.Id + "'  target='_blank'></a>";
                    obj.NMR = "<a href='' id='NMR_" + q.Id + "'  target='_blank'></a>";
                    obj.qNMR = "<a href='' id='qNMR_" + q.Id + "'  target='_blank'></a>";
                    obj.TGA = "<a href='' id='TGA_" + q.Id + "'  target='_blank'></a>";
                    obj.CMR = "<a href='' id='CMR_" + q.Id + "'  target='_blank'></a>";
                    obj.DEPT = "<a href='' id='DEPT_" + q.Id + "'  target='_blank'></a>";
                    obj.HRMS = "<a href='' id='HRMS_" + q.Id + "'  target='_blank'></a>";
                    obj.ROI = "<a href='' id='ROI_" + q.Id + "'  target='_blank'></a>";
                    obj.Elemental = "<a href='' id='Elemental_" + q.Id + "'  target='_blank'></a>";
                    obj.SER = "<a href='' id='SER_" + q.Id + "'  target='_blank'></a>";
                    obj.APCIMass = "<a href='' id='APCIMass_" + q.Id + "'  target='_blank'></a>";
                    obj.NMRInterpretaion = "<a href='' id='NMRInterpretaion_" + q.Id + "'  target='_blank'></a>";
                    obj.StabilitySolution = "<a href='' id='StabilitySolution_" + q.Id + "'  target='_blank'></a>";
                    obj.StabilityRT = "<a href='' id='StabilityRT_" + q.Id + "'  target='_blank'></a>";
                    obj.Photostability = "<a href='' id='Photostability_" + q.Id + "' ></a>";
                    obj.Hygroscopic = "<a href='' id='Hygroscopic_" + q.Id + "' ></a>";
                    obj.TempSensitive = "<a href='' id='TempSensitive_" + q.Id + "' ></a>";
                    obj.Lacrymatory = "<a href='' id='Lacrymatory_" + q.Id + "' ></a>";
                    model.Add(obj);
                }
                var instockother = Request.Form.GetValues("instockother")[0].ToString();
                if (!string.IsNullOrEmpty(instockother))
                {
                    var splitfilters = instockother.Split(',');
                    if (splitfilters[0] == "true" && splitfilters[1] == "true")
                    {

                    }
                    else
                    {
                        if (splitfilters[0] == "true")
                        {
                            model = model.Where(x => x.IsBatchAvailable).ToList();
                        }
                        if (splitfilters[1] == "true")
                        {
                            model = model.Where(x => !x.IsBatchAvailable).ToList();
                        }
                    }
                }
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.casno != null && m.casno.ToLower().Contains(searchValue))
                                        || (m.catNo != null && m.catNo.ToLower().Contains(searchValue))
                                       || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))
                                       ).ToList();
                }

                model = model.Skip((pageNo - 1) * numberOfObjectsPerPage).Take(numberOfObjectsPerPage).ToList();
                recordsTotal = query.Count();

                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = model });
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }


        [HttpPost]
        [ValidateInput(false)]
        public ActionResult UpdatePurchaseProductMasterList(int id, string quotecreceived, string comment)
        {
            var data = db.Products.Where(x => x.Id == id).FirstOrDefault();
            if (data != null)
            {
                data.Quotationreceived = quotecreceived;
                data.PurchaseComment = comment;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();

            }
            return Json("", JsonRequestBehavior.AllowGet);
        }


        [HttpPost]
        [ValidateInput(false)]
        public ActionResult UpdateProductMasterList(int id, string DdlStatus, string LeadTime, string ReTestRequired,
            string ShippingCondition, bool SourceRequired,
            string Source, string Appearance, string CountryOrigin, string HSNCode, string DangGoodToShip, string ShortDescription,
            string SameAs, string productDdlStatus, bool IsControlledSubstance, string ProductRemark, bool IsManuallyControlledSubstance,
            bool IsTracebility, string TracebilityComment, int Important, string EndUse, bool IsTechnicalReport)
        {
            var data = db.Products.Where(x => x.Id == id).FirstOrDefault();
            if (data != null)
            {
                data.DdlStatus = DdlStatus;
                data.LeadTime = LeadTime;
                data.Appearance = Appearance;
                data.ReTestRequired = ReTestRequired;
                data.ShippingCondition = ShippingCondition;
                data.SourceRequired = SourceRequired;
                data.Source = Source;
                data.ProductStat = productDdlStatus;
                data.ShortDescription = ShortDescription;
                data.DangGoodToShip = DangGoodToShip;
                data.HSNCode = HSNCode;
                data.CountryOrigin = CountryOrigin;
                data.SameAs = SameAs;
                data.IsControlledSubstance = IsControlledSubstance;
                data.ProductRemark = ProductRemark;
                data.IsManuallyControlledSubstance = IsManuallyControlledSubstance;

                data.IsTracebilityEnable = IsTracebility;
                data.TracebilityComment = TracebilityComment;
                data.Important = Important;
                data.EndUse = EndUse;
                data.IsTechnicalReport = IsTechnicalReport;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();

            }
            return Json("", JsonRequestBehavior.AllowGet);
        }

        public int tabIndex()
        {
            tabindex = tabindex + 1;
            return tabindex;
        }
        public ActionResult LoadProductPriceData(string apiname, string search, bool isusd)
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                int numberOfObjectsPerPage = Convert.ToInt32(Request.Form["length"]);
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int pageNo = 1;
                if (skip > 0)
                {
                    pageNo = (skip / numberOfObjectsPerPage) + 1;
                }
                var model = new List<ProductPriceModel>();
                int? recordsTotal = 0;
                var query = new List<Product>();
                if (!string.IsNullOrEmpty(search))
                {
                    query = (from p in db.Products
                             where p.Name.ToLower().Contains(search.ToLower())
                                   || p.Sku.ToLower().Contains(search.ToLower())
                                   || p.ManufacturerPartNumber.ToLower().Contains(search.ToLower())
                                   && (!p.Deleted &&
                                   p.Published)
                             orderby p.Sku
                             select p).ToList();
                }
                else
                {

                    var categoryData = db.Categories.Where(x => x.ParentCategoryId == 0 && x.Deleted == false && x.Name.ToLower() == apiname.Trim().ToLower()).FirstOrDefault();
                    if (categoryData != null)
                    {

                        var subcategoriesId = db.Categories.Where(x => x.ParentCategoryId == categoryData.Id && x.Deleted == false).Select(x => x.Id).ToList();

                        query = (from p in db.Products
                                 join pc in db.Product_Category_Mapping on p.Id equals pc.ProductId
                                 where subcategoriesId.Contains(pc.CategoryId) &&
                                        !p.Deleted &&
                                       p.Published
                                 orderby p.Sku
                                 select p).ToList();
                    }
                }

                var priceList = db.SZ_PriceList.ToList();
                var categorymasterlist = db.SZ_CategoryMaster.OrderBy(x => x.Name).ToList();
                string synthesis = Convert.ToString((int)EnumList.ProjectType.Synthesis);
                string purSynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
                string purchase = Convert.ToString((int)EnumList.ProjectType.Purchase);
                var proids = query.Select(x => x.Id).ToList();
                var inventorydata = db.SZ_Inventory.Where(x => proids.Contains(x.ProductId)).ToList();


                foreach (var q in query)
                {
                    var pricedata = priceList.Where(x => x.ProductId == q.Id && x.IsUsd == true).FirstOrDefault();
                    var pricedataINR = priceList.Where(x => x.ProductId == q.Id && x.IsUsd == false).FirstOrDefault();

                    var obj = new ProductPriceModel();
                    obj.Id = q.Id;
                    //obj.ProductName = q.Name;
                    obj.ProductName = "<a href='javascript:void(0)' onclick='GetProductInformationForCategoryMaster(" + q.Id + ")'>" + q.Name + "</a>";
                    obj.catNo = q.Sku;
                    obj.catNoLink = "<a href='https://www.synzeal.com/search?q=" + q.Sku + "' target='_blank'>" + q.Sku + "</a>";
                    obj.casno = q.ManufacturerPartNumber;
                    obj.IsBatchAvailable = false;

                    var isAvailableProductDetails = new List<SZ_QuotationDetail>();
                    if (!string.IsNullOrEmpty(obj.catNo) && obj.catNo != "na" && obj.catNo != "NA" && obj.catNo != "N/A")
                    {
                        isAvailableProductDetails = db.SZ_QuotationDetail.Where(x => x.ProductId == q.Id
                        && x.MoveToProject == true && (x.MoveToDispatch == false || x.MoveToDispatch == null) && string.IsNullOrEmpty(x.TrackingNo)
                        && (x.ProjectType == synthesis || x.ProjectType == purSynthesisProjectType || x.ProjectType == purchase)).ToList();
                    }
                    string titletag = "";
                    if (isAvailableProductDetails.Count > 0)
                    {
                        titletag = "PO No: ";
                        foreach (var item in isAvailableProductDetails)
                        {
                            titletag += item.SZ_Quotation.PONo + "(" + item.SZ_Quotation.CompanyName + ", " + item.RequiredQty + "), ";
                        }
                    }
                    if (!string.IsNullOrEmpty(titletag))
                    {
                        obj.catNoLink += "<i class='clstooltip fa fa-info-circle' title='" + titletag + "' style ='float:right' ></i>";
                    }
                    if (isusd)
                    {
                        obj.CategoryMasterUSDText = "<select id='categorymasterUSD_" + q.Id + "' class='addusdcategorymaster'><option value=''>--Select--</option>";

                        if (categorymasterlist.Count > 0)
                        {

                            int probatchcount = 1;
                            foreach (var r in categorymasterlist)
                            {
                                var selected = string.Empty;
                                if (pricedata != null && pricedata.CategoryMasterUSdId.HasValue && pricedata.CategoryMasterUSdId.Value == r.Id)
                                {
                                    obj.CategoryMasterUSDId = pricedata.CategoryMasterUSdId;
                                    selected = " selected ";

                                    var pricestr = "<table with='100%'><thead><tr><th>10</th><th>25</th><th>50</th><th>100</th><th>250</th><th>500</th><th>1000</th></tr></thead>";
                                    pricestr += "<tbody><tr><td>" + r.TenUSD + "</td><td>" + r.TwentyfiveUSD + "</td><td>" + r.FiftyUSD + "</td><td>" + r.OnehundredUSD + "</td><td>" + r.TwohundredFiftyUSD + "</td><td>" + r.FivehundredUSD + "</td><td>" + r.OneThousandUSD + "</td></tr></tbody>";
                                    pricestr += "</table>";

                                    pricestr = "10mg@" + r.TenUSD + " USD, 25mg@" + r.TwentyfiveUSD + " USD, 50mg@" + r.FiftyUSD + " USD, 100mg@" + r.OnehundredUSD + " USD, 250mg@" + r.TwentyfiveUSD + " USD, 500mg@" + r.FivehundredUSD + " USD, 1000mg@" + r.OneThousandUSD + " USD";
                                    pricestr += "10mg@" + r.Ten + " INR, 25mg@" + r.Twentyfive + " INR, 50mg@" + r.Fifty + " INR, 100mg@" + r.Onehundred + " INR, 250mg@" + r.Twentyfive + " INR, 500mg@" + r.Fivehundred + " INR, 1000mg@" + r.OneThousand + " INR";
                                    //obj.catNoLink = obj.catNoLink + " <i class='clstooltip fa fa-info-circle' title='" + pricestr + "'></i>";
                                }

                                obj.CategoryMasterUSDText += "<option value='" + r.Id.ToString() + "' " + selected + ">" + r.Name + "</option>";
                                probatchcount += 1;
                            }
                        }
                        obj.CategoryMasterUSDText += "</select>";
                        obj.CategoryMasterUSDText += "<select id='categorymasterINR_" + q.Id + "' class='addinrcategorymaster'><option value=''>--Select--</option>";

                        if (categorymasterlist.Count > 0)
                        {

                            int probatchcount = 1;
                            foreach (var r in categorymasterlist)
                            {
                                var selected = string.Empty;
                                if (pricedata != null && pricedata.CategoryMasterINRId.HasValue && pricedata.CategoryMasterINRId.Value == r.Id)
                                {
                                    obj.CategoryMasterINRId = pricedata.CategoryMasterINRId;
                                    selected = " selected ";
                                    var pricestr = "<table with='100%'><thead><tr><th>10</th><th>25</th><th>50</th><th>100</th><th>250</th><th>500</th><th>1000</th></tr></thead>";
                                    pricestr += "<tbody><tr><td>" + r.Ten + "</td><td>" + r.Twentyfive + "</td><td>" + r.Fifty + "</td><td>" + r.Onehundred + "</td><td>" + r.TwohundredFifty + "</td><td>" + r.Fivehundred + "</td><td>" + r.OneThousand + "</td></tr></tbody>";
                                    pricestr += "</table>";

                                    pricestr = "10mg@" + r.Ten + ", 25mg@" + r.Twentyfive + ", 50mg@" + r.Fifty + ", 100mg@" + r.Onehundred + ", 250mg@" + r.TwohundredFifty + ", 500mg@" + r.Fivehundred + ", 1000mg@" + r.OneThousand;

                                    //obj.catNoLink = obj.catNoLink + " <i class='clstooltip fa fa-info-circle' title='" + pricestr + "'></i>";
                                }

                                obj.CategoryMasterUSDText += "<option value='" + r.Id.ToString() + "' " + selected + ">" + r.Name + "</option>";
                                probatchcount += 1;
                            }
                        }
                        obj.CategoryMasterUSDText += "</select>";
                    }
                    else
                    {
                        obj.CategoryMasterINRText = "<select id='categorymasterINR_" + q.Id + "' class='addinrcategorymaster'><option value=''>--Select--</option>";

                        if (categorymasterlist.Count > 0)
                        {

                            int probatchcount = 1;
                            foreach (var r in categorymasterlist)
                            {
                                var selected = string.Empty;
                                if (pricedata != null && pricedata.CategoryMasterINRId.HasValue && pricedata.CategoryMasterINRId.Value == r.Id)
                                {
                                    obj.CategoryMasterINRId = pricedata.CategoryMasterINRId;
                                    selected = " selected ";
                                    var pricestr = "<table with='100%'><thead><tr><th>10</th><th>25</th><th>50</th><th>100</th><th>250</th><th>500</th><th>1000</th></tr></thead>";
                                    pricestr += "<tbody><tr><td>" + r.Ten + "</td><td>" + r.Twentyfive + "</td><td>" + r.Fifty + "</td><td>" + r.Onehundred + "</td><td>" + r.TwohundredFifty + "</td><td>" + r.Fivehundred + "</td><td>" + r.OneThousand + "</td></tr></tbody>";
                                    pricestr += "</table>";

                                    pricestr = "10mg@" + r.Ten + ", 25mg@" + r.Twentyfive + ", 50mg@" + r.Fifty + ", 100mg@" + r.Onehundred + ", 250mg@" + r.TwohundredFifty + ", 500mg@" + r.Fivehundred + ", 1000mg@" + r.OneThousand;

                                    //obj.catNoLink = obj.catNoLink + " <i class='clstooltip fa fa-info-circle' title='" + pricestr + "'></i>";
                                }

                                obj.CategoryMasterINRText += "<option value='" + r.Id.ToString() + "' " + selected + ">" + r.Name + "</option>";
                                probatchcount += 1;
                            }
                        }
                        obj.CategoryMasterINRText += "</select>";
                    }

                    obj.AdditionalBatchNoText = "<select id='additionalBatch_" + q.Id + "' class='addbatch'><option value=''>--Select--</option>";
                    var proBatchData = inventorydata.Where(x => x.ProductId == q.Id).OrderBy(x => x.Id).ToList();
                    if (proBatchData.Count > 0)
                    {
                        int probatchcount = 1;
                        foreach (var r in proBatchData)
                        {
                            string qty = CommonOperation.SettleQtyForSPMS(r);
                            string text = r.BatchNo + " (" + qty + ")";
                            if (r.IsApproved == false)
                            {
                                text = "*" + text;
                            }

                            obj.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' data-value='" + r.BatchNo + "'>" + text + "</option>";
                            probatchcount += 1;
                        }
                        obj.IsBatchAvailable = true;
                    }
                    obj.AdditionalBatchNoText += "</select>";

                    if (pricedata != null)
                    {
                        obj.IsPriceApproved = pricedata.IsPriceApproved;
                        string ischecked = "";
                        if (obj.IsPriceApproved.HasValue && obj.IsPriceApproved.Value)
                        {
                            obj.ApprovedText = "<input type='checkbox' id='isApproved_" + q.Id + "' value='" + q.Id + "' class='clsApprovedrow' checked />";
                        }
                        else
                        {
                            obj.ApprovedText = "<input type='checkbox' id='isApproved_" + q.Id + "' value='" + q.Id + "' class='clsApprovedrow' />";
                        }
                        obj.TenUSD = "<input tabindex='" + tabIndex() + "' class='clspri' style='width: 60px;' type='text' id='TenUSD_" + q.Id + "' value='" + pricedata.TenUSD + "' onkeypress='return isNumber(event)'/>";
                        obj.TwentyfiveUSD = "<input tabindex='" + tabIndex() + "' class='clspri' style='width: 60px;' type='text' id='TwentyfiveUSD_" + q.Id + "' value='" + pricedata.TwentyfiveUSD + "'  onkeypress='return isNumber(event)'/>";
                        obj.FiftyUSD = "<input tabindex='" + tabIndex() + "' class='clspri' style='width: 60px;' type='text' id='FiftyUSD_" + q.Id + "' value='" + pricedata.FiftyUSD + "'  onkeypress='return isNumber(event)'/>";
                        obj.OnehundredUSD = "<input tabindex='" + tabIndex() + "' class='clspri' style='width: 60px;' type='text' id='OnehundredUSD_" + q.Id + "' value='" + pricedata.OnehundredUSD + "'  onkeypress='return isNumber(event)'/>";
                        obj.TwohundredFiftyUSD = "<input tabindex='" + tabIndex() + "' class='clspri' style='width: 60px;' type='text' id='TwohundredFiftyUSD_" + q.Id + "' value='" + pricedata.TwohundredFiftyUSD + "'  onkeypress='return isNumber(event)'/>";
                        obj.FivehundredUSD = "<input tabindex='" + tabIndex() + "' class='clspri' style='width: 60px;' type='text' id='FivehundredUSD_" + q.Id + "' value='" + pricedata.FivehundredUSD + "'  onkeypress='return isNumber(event)'/>";
                        obj.OneThousandUSD = "<input tabindex='" + tabIndex() + "' class='clspri' style='width: 60px;' type='text' id='OneThousandUSD_" + q.Id + "' value='" + pricedata.OneThousandUSD + "'  onkeypress='return isNumber(event)'/>";
                        obj.DiscountUSD = "<input tabindex='" + tabIndex() + "' class='clspri' style='width: 60px;' type='text' id='DiscountUSD_" + q.Id + "' value='" + pricedata.DiscountUSD + "'  onkeypress='return isNumber(event)'/>";
                        obj.LeadTime = "<input style='width: 90px;' type='text' id='LeadTime_" + q.Id + "' value='" + pricedata.LeadTime + "' />";
                        obj.ProductRemark = "<input style='width: 90px;' type='text' id='ProductRemark_" + q.Id + "' value='" + pricedata.ProductRemark + "' />";
                    }
                    else
                    {
                        obj.IsPriceApproved = false;
                        obj.ApprovedText = "<input type='checkbox' id='isApproved_" + q.Id + "' value='" + q.Id + "' class='clsApprovedrow' />";
                        obj.TenUSD = "<input tabindex='" + tabIndex() + "' class='clspri' style='width: 60px;' type='text' id='TenUSD_" + q.Id + "' value='' onkeypress='return isNumber(event)'/>";
                        obj.TwentyfiveUSD = "<input tabindex='" + tabIndex() + "' class='clspri' style='width: 60px;' type='text' id='TwentyfiveUSD_" + q.Id + "' value=''  onkeypress='return isNumber(event)'/>";
                        obj.FiftyUSD = "<input tabindex='" + tabIndex() + "' class='clspri' style='width: 60px;' type='text' id='FiftyUSD_" + q.Id + "' value=''  onkeypress='return isNumber(event)'/>";
                        obj.OnehundredUSD = "<input tabindex='" + tabIndex() + "' class='clspri' style='width: 60px;' type='text' id='OnehundredUSD_" + q.Id + "' value=''  onkeypress='return isNumber(event)'/>";
                        obj.TwohundredFiftyUSD = "<input tabindex='" + tabIndex() + "' class='clspri' style='width: 60px;' type='text' id='TwohundredFiftyUSD_" + q.Id + "' value=''  onkeypress='return isNumber(event)'/>";
                        obj.FivehundredUSD = "<input tabindex='" + tabIndex() + "' class='clspri' style='width: 60px;' type='text' id='FivehundredUSD_" + q.Id + "' value=''  onkeypress='return isNumber(event)'/>";
                        obj.OneThousandUSD = "<input tabindex='" + tabIndex() + "' class='clspri' style='width: 60px;' type='text' id='OneThousandUSD_" + q.Id + "' value=''  onkeypress='return isNumber(event)'/>";
                        obj.DiscountUSD = "<input tabindex='" + tabIndex() + "' class='clspri' style='width: 60px;' type='text' id='DiscountUSD_" + q.Id + "' value=''  onkeypress='return isNumber(event)'/>";
                        obj.LeadTime = "<input style='width: 90px;' type='text' id='LeadTime_" + q.Id + "' value=''/>";
                        obj.ProductRemark = "<input style='width: 90px;' type='text' id='ProductRemark_" + q.Id + "' value='' />";
                    }
                    obj.CopyPaste = "<a href='javascript:void(0)' onclick='copyrecord(" + q.Id + ")' title='copy'><i class='fa fa-copy'></i></a>&nbsp;&nbsp;&nbsp;<a href='javascript:void(0)' onclick='pasterecord(" + q.Id + ")' title='paste'><i class='fa fa-paste'></i></a>";
                    if (pricedata != null)
                    {
                        obj.IsPriceApproved = pricedata.IsPriceApproved;
                        string ischecked = "";
                        if (obj.IsPriceApproved.HasValue && obj.IsPriceApproved.Value)
                        {
                            obj.ApprovedText = "<input type='checkbox' id='isApproved_" + q.Id + "' value='" + q.Id + "' class='clsApprovedrow' checked />";
                        }
                        else
                        {
                            obj.ApprovedText = "<input type='checkbox' id='isApproved_" + q.Id + "' value='" + q.Id + "' class='clsApprovedrow' />";
                        }
                        obj.TenPrice = "<input tabindex='" + tabIndex() + "' class='clspri' style='width: 60px;' type='text' id='TenPrice_" + q.Id + "' value='" + pricedata.TenPrice + "' onkeypress='return isNumber(event)'/>";
                        obj.TwentyFivePrice = "<input  tabindex='" + tabIndex() + "' class='clspri' style='width: 60px;' type='text' id='TwentyFivePrice_" + q.Id + "' value='" + pricedata.TwentyFivePrice + "'  onkeypress='return isNumber(event)'/>";
                        obj.FiftyPrice = "<input  tabindex='" + tabIndex() + "' class='clspri' style='width: 60px;' type='text' id='FiftyPrice_" + q.Id + "' value='" + pricedata.FiftyPrice + "'  onkeypress='return isNumber(event)'/>";
                        obj.HundredPrice = "<input  tabindex='" + tabIndex() + "' class='clspri' style='width: 60px;' type='text' id='HundredPrice_" + q.Id + "' value='" + pricedata.HundredPrice + "'  onkeypress='return isNumber(event)'/>";
                        obj.TwoHundredPrice = "<input  tabindex='" + tabIndex() + "' class='clspri' style='width: 60px;' type='text' id='TwoHundredPrice_" + q.Id + "' value='" + pricedata.TwoHundredPrice + "'  onkeypress='return isNumber(event)'/>";
                        obj.FivehundredPrice = "<input  tabindex='" + tabIndex() + "' class='clspri' style='width: 60px;' type='text' id='FivehundredPrice_" + q.Id + "' value='" + pricedata.FivehundredPrice + "'  onkeypress='return isNumber(event)'/>";
                        obj.OneThousandPrice = "<input  tabindex='" + tabIndex() + "' class='clspri' style='width: 60px;' type='text' id='OneThousandPrice_" + q.Id + "' value='" + pricedata.OneThousandPrice + "'  onkeypress='return isNumber(event)'/>";
                        obj.DiscountINR = "<input  tabindex='" + tabIndex() + "' class='clspri' style='width: 60px;' type='text' id='DiscountINR_" + q.Id + "' value='" + pricedata.DiscountINR + "'  onkeypress='return isNumber(event)'/>";
                        obj.TenUSD += obj.TenPrice;
                        obj.TwentyfiveUSD += obj.TwentyFivePrice;
                        obj.FiftyUSD += obj.FiftyPrice;
                        obj.OnehundredUSD += obj.HundredPrice;
                        obj.TwohundredFiftyUSD += obj.TwoHundredPrice;
                        obj.FivehundredUSD += obj.FivehundredPrice;
                        obj.OneThousandUSD += obj.OneThousandPrice;
                        obj.DiscountUSD += obj.DiscountINR;
                    }
                    else
                    {
                        obj.IsPriceApproved = false;
                        obj.ApprovedText = "<input type='checkbox' id='isApproved_" + q.Id + "' value='" + q.Id + "' class='clsApprovedrow' />";
                        obj.TenPrice = "<input  tabindex='" + tabIndex() + "' class='clspri' style='width: 60px;' type='text' id='TenPrice_" + q.Id + "' value=''  onkeypress='return isNumber(event)'/>";
                        obj.TwentyFivePrice = "<input  tabindex='" + tabIndex() + "' class='clspri' style='width: 60px;' type='text' id='TwentyFivePrice_" + q.Id + "' value=''  onkeypress='return isNumber(event)'/>";
                        obj.FiftyPrice = "<input  tabindex='" + tabIndex() + "' class='clspri' style='width: 60px;' type='text' id='FiftyPrice_" + q.Id + "' value=''  onkeypress='return isNumber(event)'/>";
                        obj.HundredPrice = "<input  tabindex='" + tabIndex() + "' class='clspri' style='width: 60px;' type='text' id='HundredPrice_" + q.Id + "' value=''  onkeypress='return isNumber(event)'/>";
                        obj.TwoHundredPrice = "<input  tabindex='" + tabIndex() + "' class='clspri' style='width: 60px;' type='text' id='TwoHundredPrice_" + q.Id + "' value=''  onkeypress='return isNumber(event)'/>";
                        obj.FivehundredPrice = "<input  tabindex='" + tabIndex() + "' class='clspri' style='width: 60px;' type='text' id='FivehundredPrice_" + q.Id + "' value=''  onkeypress='return isNumber(event)'/>";
                        obj.OneThousandPrice = "<input  tabindex='" + tabIndex() + "' class='clspri' style='width: 60px;' type='text' id='OneThousandPrice_" + q.Id + "' value=''  onkeypress='return isNumber(event)'/>";
                        obj.DiscountINR = "<input  tabindex='" + tabIndex() + "' class='clspri' style='width: 60px;' type='text' id='DiscountINR_" + q.Id + "' value=''  onkeypress='return isNumber(event)'/>";
                        obj.TenUSD += obj.TenPrice;
                        obj.TwentyfiveUSD += obj.TwentyFivePrice;
                        obj.FiftyUSD += obj.FiftyPrice;
                        obj.OnehundredUSD += obj.HundredPrice;
                        obj.TwohundredFiftyUSD += obj.TwoHundredPrice;
                        obj.FivehundredUSD += obj.FivehundredPrice;
                        obj.OneThousandUSD += obj.OneThousandPrice;
                        obj.DiscountUSD += obj.DiscountINR;
                    }
                    obj.LastRow = "<i class='fa fa-cube' title='Get Details' onclick ='Quote.getPreviousQuoteInformationByCatNoForPrice(&#39;" + q.Sku + "&#39;,&#39;" + q.ManufacturerPartNumber + "&#39;)' ></i>";
                    obj.ChkRow = "<input type='checkbox' value='" + q.Id + "' class='clsSaverow' /> <div class='clsimageproduct' style='display:none'><img src='" + obj.ImagePath + "' width='100%'></div>";

                    model.Add(obj);
                }
                var instockother = Request.Form.GetValues("instockother")[0].ToString();
                if (!string.IsNullOrEmpty(instockother))
                {
                    var splitfilters = instockother.Split(',');
                    if (splitfilters[0] == "true" && splitfilters[1] == "true")
                    {

                    }
                    else
                    {
                        if (splitfilters[0] == "true")
                        {
                            model = model.Where(x => x.IsBatchAvailable).ToList();
                        }
                        if (splitfilters[1] == "true")
                        {
                            model = model.Where(x => !x.IsBatchAvailable).ToList();
                        }
                    }
                }


                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();

                    model = model.Where(m => (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                    || (m.casno != null && m.casno.ToLower().Contains(searchValue))
                                    || (m.catNo != null && m.catNo.ToLower().Contains(searchValue))
                                    || (m.RefStock != null && m.RefStock.ToLower().Contains(searchValue))
                                    || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))
                                    || (m.TenUSD != null && m.TenUSD.ToLower().Contains(searchValue))
                                    || (m.TwentyfiveUSD != null && m.TwentyfiveUSD.ToLower().Contains(searchValue))
                                    || (m.FiftyUSD != null && m.FiftyUSD.ToLower().Contains(searchValue))
                                    || (m.OnehundredUSD != null && m.OnehundredUSD.ToLower().Contains(searchValue))
                                    || (m.FivehundredUSD != null && m.FivehundredUSD.ToLower().Contains(searchValue))
                                    || (m.OneThousandUSD != null && m.OneThousandUSD.ToLower().Contains(searchValue))
                                    || (m.TwohundredFiftyUSD != null && m.TwohundredFiftyUSD.ToLower().Contains(searchValue))
                                    || (m.TenPrice != null && m.TenPrice.ToLower().Contains(searchValue))
                                    || (m.TwentyFivePrice != null && m.TwentyFivePrice.ToLower().Contains(searchValue))
                                    || (m.FiftyPrice != null && m.FiftyPrice.ToLower().Contains(searchValue))
                                    || (m.HundredPrice != null && m.HundredPrice.ToLower().Contains(searchValue))
                                    || (m.FivehundredPrice != null && m.FivehundredPrice.ToLower().Contains(searchValue))
                                    || (m.OneThousandPrice != null && m.OneThousandPrice.ToLower().Contains(searchValue))
                                    || (m.TwoHundredPrice != null && m.TwoHundredPrice.ToLower().Contains(searchValue))).ToList();
                }

                model = model.Skip((pageNo - 1) * numberOfObjectsPerPage).Take(numberOfObjectsPerPage).ToList();
                recordsTotal = query.Count();

                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = model });
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        [HttpGet]
        public ActionResult GetCategoryMasterByCategoryMasterName(int id)
        {
            var data = db.SZ_CategoryMaster.Where(x => x.Id == id).FirstOrDefault();
            return Json(data, JsonRequestBehavior.AllowGet);
        }

        public List<InvoiceListModel> PrepareInvoiceListModel(List<InvoiceList_Result> data)
        {
            string courierDll = string.Empty;
            var invoiceDetailsData = db.SZ_InvoiceDetailsData.ToList();
            var compData = db.SZ_Courier.OrderBy(x => x.Name).ToList();
            var paymenttermsData = db.PaymentTerms.ToList();
            foreach (var term in compData)
            {
                courierDll += "<option value='" + term.Id.ToString() + "'> " + term.Name + "</option>";
            }
            var model = (from i in data
                         select new InvoiceListModel()
                         {
                             IsControlledSubstance = i.IsControlledSubstance == true ? true : (i.IsManuallyControlledSubstance == true ? true : false),
                             IsConversionReport = i.IsConversionReport,
                             InvoiceBatchNo = i.InvoiceBatchNo,
                             ProductCount = i.ProductCount,
                             QuoteDetailsId = i.QuoteDetailsId,
                             QuoteId = i.QuoteId,
                             CASNo = i.CASNo,
                             CATNo = i.CATNo + "  <i class='fa fa-search' onclick='SearchDefault(\"" + i.CATNo + "\")' ></i>",
                             FirstRow = "<input type='checkbox' value='" + i.QuoteDetailsId + "' class='clsSaverow' />",
                             SecondRow = !string.IsNullOrEmpty(i.TrackingNo) ? "<input type='checkbox' value='" + i.QuoteDetailsId + "' class='clsMovePrint' />" : "",
                             ThirdRow = "<a href='javascript:void(0)' id='save_" + i.QuoteDetailsId + "' onclick='SaveInvoiceDetails(\"" + i.QuoteDetailsId + "\")'> Save</a>",
                             PackDate = i.PackDate.HasValue ? i.PackDate.Value.ToShortDateString() : "",
                             InvoicedDate = i.InvoicedDate.HasValue ? i.InvoicedDate.Value.ToShortDateString() : "",
                             PONo = i.PONo,
                             ProductName = i.ProductName,
                             RequiredQty = i.RequiredQty,
                             BatchNo = i.BatchNo,
                             CompanyName = i.CompanyName,
                             TrackingNo = i.TrackingNo,
                             Location = i.Location,
                             RefName = i.RefName,
                             DeliveryDate = i.DeliveryDate,
                             DataPending = i.DataPending,
                             InvoiceRemark = i.InvoiceRemark,
                             InvoiceNo = i.InvoiceNo,
                             DeliveryStatus = i.DeliveryStatus,
                             PaymentStatus = i.PaymentStatus,
                             PurposeDispatch = i.PurposeDispatch,
                             Courier = i.Courier,
                             Remark = i.Remark,
                             OrderRemark = i.OrderRemark,
                             COARefNumber = i.COARefNumber,
                             IsPaymentExpired = false,
                             PaymentDays = paymenttermsData.Where(x => x.Id == i.TermsId).Select(x => x.Day).FirstOrDefault(),
                             InvoicePDF = PreareInvoicePDFData(i.QuoteDetailsId, invoiceDetailsData),
                             TrackingNoStr = "<input type='text' id='tracking_" + i.QuoteDetailsId + "' value='" + i.TrackingNo + "' />",
                             LocationStr = "<input type='text' id='location_" + i.QuoteDetailsId + "' value='" + i.Location + "' />",
                             RefNameStr = "<input type='text' id='refno_" + i.QuoteDetailsId + "' value='" + i.RefName + "' />",
                             DeliveryDateStr = "<input type='text' data-value='" + i.DeliveryDate + "' id='deliverydate_" + i.QuoteDetailsId + "' class='datepickerinvoice' />",
                             DataPendingStr = "<input type='text' id='datapending_" + i.QuoteDetailsId + "' value='" + i.DataPending + "' />",
                             InvoiceRemarkStr = "<input type='text' id='remark_" + i.QuoteDetailsId + "' value='" + i.Remark + "' />",
                             InvoiceNoStr = "<input type='text' id='invoiceno_" + i.QuoteDetailsId + "' value='" + i.InvoiceNo + "' class='clsInvoiceno'/>",
                             DeliveryStatusStr = "<select id='deliverystatus_" + i.QuoteDetailsId + "'><option> --Select-- </option><option value='Delivered'> Delivered </option><option value='Intransit' selected > Intransit </option></select>",
                             PaymentStatusStr = "<select id='paymentStatus_" + i.QuoteDetailsId + "'><option value=''>--Select--</option><option value='UnPaid'> UnPaid</option><option value='Paid'>Paid</option></select>",
                             PurposeDispatchStr = "<select id='purposeofdispatch_" + i.QuoteDetailsId + "'><option>--Select--</option><option value='Commercial'>Commercial</option><option value='Replacement'>Replacement</option><option value='Sample Apporval'>Sample Apporval</option></select>",
                             CourierStr = "<select id='courier_" + i.QuoteDetailsId + "'><option>--Select--</option>" + courierDll + "</select>",
                             COAPath = !string.IsNullOrEmpty(i.COAPath) ? "<a href='" + i.COAPath + "' target='_blank'>Download</a>" : "",
                             AnalyticalData = !string.IsNullOrEmpty(i.AnalyticalData) ? "<a href='" + i.AnalyticalData + "' target='_blank'>Download</a>" : ""
                         }).ToList();

            if (model != null && model.Count > 0)
            {
                model.ForEach(x =>
                {

                    var impstr = "";
                    if (x.IsConversionReport.HasValue && x.IsConversionReport.Value)
                    {
                        impstr += "<img src='/img/important.jpg' width='15px' height='15px' />";
                    }
                    x.CATNo += " " + impstr;
                    if (x.PaymentDays != null && x.PaymentDays != 0 && x.PaymentStatus == "UnPaid" && !string.IsNullOrEmpty(x.InvoicedDate))
                    {
                        DateTime invoicedates = Convert.ToDateTime(x.InvoicedDate).AddDays(x.PaymentDays.Value).Date;
                        DateTime dates = DateTime.Now.Date;
                        if (invoicedates < dates)
                        {
                            x.IsPaymentExpired = true;
                        }
                    }
                });
            }
            return model;
        }

        public string PreareInvoicePDFData(int quoteDetailsId, List<SZ_InvoiceDetailsData> szInvoiceDetailsData)
        {
            var isAvailable = szInvoiceDetailsData.Where(x => x.QuoteDetailsId == quoteDetailsId).FirstOrDefault();
            if (isAvailable == null)
            {
                return "";
            }
            return "<a href='/Form/GenerateInvoicePdf?id=" + quoteDetailsId + "' target='_blank'>Download</a>";
        }

        public ActionResult ManageInvoice(int pdid, int id = 0)
        {
            if (!SessionCookieManagement.IsLogin)
            {
                return RedirectToAction("Index", "Home");
            }
            var model = db.SZ_Invoice.FirstOrDefault(x => x.Id == id);
            if (model == null)
            {
                model = new SZ_Invoice();
                model.DispatchDate = DateTime.Now;
            }

            var szproductdetails = db.SZ_ProjectDetail.Where(x => x.Id == pdid).FirstOrDefault();
            if (szproductdetails != null)
            {
                string uri = Domain + "/api/RestAPI/ProductDetails?productId=" + szproductdetails.ProductId;
                using (HttpClient httpClient = new HttpClient())
                {
                    Task<String> response = httpClient.GetStringAsync(uri);
                    string productModel = JsonConvert.DeserializeObject<string>(response.Result);
                    ViewBag.ProductModel = JsonConvert.DeserializeObject<ProductDetailsModel>(productModel);

                }

                var szpo = db.SZ_Project.Where(x => x.Id == szproductdetails.ProjectId).FirstOrDefault();
                if (szpo != null)
                {
                    ViewBag.PONo = szpo.PONo;
                    ViewBag.PODate = szpo.PODate;
                }
                model.ProjectId = szproductdetails.ProjectId;
            }
            model.ProjectDetailsId = pdid;

            return View(model);
        }

        public ActionResult GetQtyByBatchId(int id)
        {
            var batchData = db.SZ_Inventory.Where(x => x.Id == id).FirstOrDefault();
            return new JsonResult()
            {
                JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                Data = new { type = "success", data = batchData.Qty }
            };
        }

        [HttpPost]
        public ActionResult ManageInvoice(SZ_Invoice model)
        {
            if (model.Id == 0)
            {
                model.CreatedDate = DateTime.Now;
                db.SZ_Invoice.Add(model);
                db.SaveChanges();
                string Msg = "Invoice added successfully.";
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { type = "success", msg = Msg }
                };
            }
            else
            {
                var data = db.SZ_Invoice.Where(x => x.Id == model.Id).FirstOrDefault();
                if (data != null)
                {
                    data.BasicValue = model.BasicValue;
                    data.InvoiceNo = model.InvoiceNo;
                    data.PaymentTerm = model.PaymentTerm;
                    data.DueDate = model.DueDate;
                    data.Courier = model.Courier;
                    data.TrackingNo = model.TrackingNo;
                    data.DispatchDetail = model.DispatchDetail;
                    data.DeliveryConfirmation = model.DeliveryConfirmation;
                    data.PaymentFollowUp = model.PaymentFollowUp;
                    data.PaymentDetail = model.PaymentDetail;
                    data.CForm = model.CForm;
                    data.FirstEMail = model.FirstEMail;
                    data.SecondEmail = model.SecondEmail;
                    data.ContactNo = model.ContactNo;
                    data.PaymentStatus = model.PaymentStatus;
                    db.Entry(data).State = EntityState.Modified;
                    db.SaveChanges();
                    string Msg = "Invoice updated successfully.";
                    return new JsonResult()
                    {
                        JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                        Data = new { type = "success", msg = Msg }
                    };
                }
            }

            return View(model);
        }

        public ActionResult UpdateProductdetails(int id)
        {
            if (!SessionCookieManagement.IsLogin)
            {
                return RedirectToAction("Index", "Home");
            }
            SZ_ProjectDetail model = db.SZ_ProjectDetail.FirstOrDefault(x => x.Id == id);
            return PartialView(model);
        }

        public ActionResult Notification()
        {
            if (!SessionCookieManagement.IsClient)
            {
                return RedirectToAction("Index", "Home");
            }
            if (string.IsNullOrEmpty(SessionCookieManagement.LoginCompanyName))
            {
                return RedirectToAction("Index", "Home");
            }
            string logCompName = Request.Cookies["LoginCompanyName"].Value;
            var id = db.SZ_CompanyList.Where(x => x.Name.ToLower() == logCompName).Select(x => x.Id).FirstOrDefault();
            var model = db.SZ_Notification.Where(x => x.CompanyId == id).ToList();
            return View(model);
        }

        [HttpGet]
        public ActionResult NotificationCount()
        {
            if (!SessionCookieManagement.IsClient)
            {
                return RedirectToAction("Index", "Home");
            }
            if (string.IsNullOrEmpty(SessionCookieManagement.LoginCompanyName))
            {
                return RedirectToAction("Index", "Home");
            }

            string logCompName = Request.Cookies["LoginCompanyName"].Value;
            var id = db.SZ_CompanyList.Where(x => x.Name.ToLower() == logCompName).Select(x => x.Id).FirstOrDefault();
            var model = db.SZ_Notification.Where(x => x.CompanyId == id && !x.IsRead).ToList();
            return Json(model.Count(), JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public ActionResult SaveClientModuleInfo(int id, string clientstatus, string currentStatus, string clientremark, string clientaddress)
        {
            var data = _operationRepository.GetQuoteDetailByID(id);
            if (data != null)
            {

                if (data.ClientStatus != clientstatus)
                {
                    string adminemail = ConfigurationManager.AppSettings["EmailAddress"];
                    if (adminemail != null)
                    {
                        try
                        {
                            MailMessage mail = new MailMessage();
                            ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12 |
                                       SecurityProtocolType.Tls11 |
                                       SecurityProtocolType.Tls |
                                       SecurityProtocolType.Ssl3;
                            SmtpClient SmtpServer = new SmtpClient("smtp.gmail.com");

                            mail.From = new MailAddress("noreply.synzeal@gmail.com", "SynZeal Project Management");
                            string[] emails = adminemail.Split(';');
                            foreach (var i in emails)
                            {
                                mail.To.Add(i);
                            }
                            string logCompName = Request.Cookies["LoginCompanyName"].Value;
                            mail.Subject = logCompName + " has updated client status. PO NUmber : " + data.SZ_Quotation.PONo + " / Product Name : " + data.ProductName;
                            mail.Body = "Dear Admin, <br> " + logCompName + " has updated client status. Please have a look on it. <br> Thanks";
                            mail.IsBodyHtml = true;
                            SmtpServer.Port = 587;
                            SmtpServer.Credentials = new System.Net.NetworkCredential("noreply.synzeal@gmail.com", "Synzeal@123");
                            SmtpServer.EnableSsl = true;

                            SmtpServer.Send(mail);
                        }
                        catch (Exception ex)
                        {
                            sendErrorMail(ex.LineNumber() + " " + "Error Text : " + ex.Message + " / Stack Trace : " + ex.StackTrace);
                        }
                    }

                    if (clientstatus == "COA/Data Approved")
                    {
                        data.COAApprovedDate = DateTime.Now;
                    }
                }

                data.ClientStatus = clientstatus;
                if (clientremark != "undefined")
                {
                    if (string.IsNullOrEmpty(data.ClientRemark) && !string.IsNullOrEmpty(clientremark))
                    {
                        data.ClientStatus = "COA/Data Correction";
                    }
                    data.ClientRemark = clientremark;
                }

                data.ClientAddress = clientaddress;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }

            return Json("", JsonRequestBehavior.AllowGet);
        }
        [HttpPost]
        public ActionResult SaveClientAdminInfo(int id, string clientstatus, string currentStatus, string lastStatus, string clientremark, string clientaddress)
        {
            var data = _operationRepository.GetQuoteDetailByID(id);
            if (data != null)
            {
                data.ClientStatus = clientstatus;
                data.AdminScientistStatus = currentStatus;
                data.LastStatus = lastStatus;

                if (clientremark != "undefined")
                {
                    if (string.IsNullOrEmpty(data.ClientRemark) && !string.IsNullOrEmpty(clientremark))
                    {
                        data.ClientStatus = "COA/Data Correction";
                    }

                    if (data.ClientRemark != clientremark)
                    {
                        data.ResponseClientRemarkDate = DateTime.Now;
                    }

                    data.ClientRemark = clientremark;
                }

                data.ClientAddress = clientaddress;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }

            return Json("", JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult SaveInstockPurchaseAction(int? additionalBatch, string batchNo, int id)
        {
            var data = _operationRepository.GetQuoteDetailByID(id);
            if (data != null)
            {
                data.AdditionalBatchNo = additionalBatch;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }

            return Json("", JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult saveChildRecord(string availablequantity, string analysisdate, string HPLCGCELSD,
            string TGALoss, string ResidueOnIgnition, string Potency,
            string PhysicalState, string SOLUBILITY, string IR,
            string Mass, string HPLC, string NMR,
            string CMR, string Dept, string TGA,
            string StorageCon, string ReTestDate, string SpecialInstruction,
            string Remark1, string Remark2, int id, string Purity)
        {
            try
            {

                var masterrecord = db.SZ_ChildCOA.Where(x => x.Id == id).FirstOrDefault();
                if (masterrecord != null)
                {
                    masterrecord.HPLC = HPLC;
                    masterrecord.QuantityAvailable = availablequantity;
                    if (!string.IsNullOrEmpty(analysisdate))
                    {
                        masterrecord.AnalysisDate = Convert.ToDateTime(analysisdate);
                    }
                    else
                    {
                        masterrecord.AnalysisDate = null;
                    }
                    masterrecord.CMR = CMR;
                    masterrecord.Dept = Dept;
                    masterrecord.HPLC = HPLC;
                    masterrecord.HPLCGCELSD = HPLCGCELSD;
                    masterrecord.IR = IR;
                    masterrecord.Mass = Mass;
                    masterrecord.NMR = NMR;
                    masterrecord.PhysicalState = PhysicalState;
                    masterrecord.Potency = Potency;
                    masterrecord.QuantityAvailable = masterrecord.QuantityAvailable;
                    masterrecord.Remark1 = Remark1;
                    masterrecord.Remark2 = Remark2;
                    masterrecord.ResidueOnIgnition = ResidueOnIgnition;
                    if (!string.IsNullOrEmpty(ReTestDate))
                    {
                        masterrecord.ReTestDate = Convert.ToDateTime(ReTestDate);
                    }
                    else
                    {
                        masterrecord.ReTestDate = null;
                    }
                    masterrecord.SOLUBILITY = SOLUBILITY;
                    masterrecord.SpecialInstruction = SpecialInstruction;
                    masterrecord.StorageCon = StorageCon;
                    masterrecord.TGA = TGA;
                    masterrecord.TGALoss = TGALoss;
                    masterrecord.UpdatedDate = DateTime.Now;
                    masterrecord.Purity = Purity;
                    db.Entry(masterrecord).State = EntityState.Modified;
                    db.SaveChanges();
                }
                else
                {
                    masterrecord = new SZ_ChildCOA();
                    masterrecord.RefNo = "SZ-" + DateTime.Now.ToString("HHmm") + "-" + DateTime.Now.ToString("yy") + "-" + DateTime.Now.ToString("ddMM");
                    masterrecord.Purity = Purity;
                    masterrecord.HPLC = HPLC;
                    masterrecord.QuantityAvailable = availablequantity;
                    if (!string.IsNullOrEmpty(analysisdate))
                    {
                        masterrecord.AnalysisDate = Convert.ToDateTime(analysisdate);
                    }
                    else
                    {
                        masterrecord.AnalysisDate = null;
                    }
                    masterrecord.CMR = CMR;
                    masterrecord.Dept = Dept;
                    masterrecord.HPLC = HPLC;
                    masterrecord.HPLCGCELSD = HPLCGCELSD;
                    masterrecord.IR = IR;
                    masterrecord.Mass = Mass;
                    masterrecord.NMR = NMR;
                    masterrecord.PhysicalState = PhysicalState;
                    masterrecord.Potency = Potency;
                    masterrecord.QuantityAvailable = masterrecord.QuantityAvailable;
                    masterrecord.Remark1 = Remark1;
                    masterrecord.Remark2 = Remark2;
                    masterrecord.ResidueOnIgnition = ResidueOnIgnition;
                    if (!string.IsNullOrEmpty(ReTestDate))
                    {
                        masterrecord.ReTestDate = Convert.ToDateTime(ReTestDate);
                    }
                    else
                    {
                        masterrecord.ReTestDate = null;
                    }
                    masterrecord.SOLUBILITY = SOLUBILITY;
                    masterrecord.SpecialInstruction = SpecialInstruction;
                    masterrecord.StorageCon = StorageCon;
                    masterrecord.TGA = TGA;
                    masterrecord.TGALoss = TGALoss;
                    masterrecord.CreatedDate = DateTime.Now;
                    masterrecord.UpdatedDate = DateTime.Now;
                    db.SZ_ChildCOA.Add(masterrecord);
                    db.SaveChanges();
                }

            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = ex.Message
                }, JsonRequestBehavior.AllowGet);
            }
            return Json(new
            {
                success = true,
                message = "Information saved successfully."
            }, JsonRequestBehavior.AllowGet);
        }


        [HttpPost]
        [ValidateInput(false)]
        public ActionResult SaveMasterRecord(string availablequantity, string analysisdate, string HPLCGCELSD,
            string TGALoss, string ResidueOnIgnition, string Potency,
            string PhysicalState, string SOLUBILITY, string IR,
            string Mass, string HPLC, string NMR,
            string CMR, string Dept, string TGA,
            string StorageCon, string ReTestDate, string SpecialInstruction,
            string Remark1, string Remark2, int id, string Purity)
        {
            try
            {
                var batchlist = db.SZ_Inventory.Where(x => x.Id == id).FirstOrDefault();
                if (batchlist != null)
                {
                    var masterrecord = db.SZ_MasterCOA.Where(x => x.BatchId == batchlist.Id).FirstOrDefault();
                    if (masterrecord != null)
                    {
                        masterrecord.HPLC = HPLC;
                        masterrecord.QuantityAvailable = availablequantity;
                        if (!string.IsNullOrEmpty(analysisdate))
                        {
                            masterrecord.AnalysisDate = Convert.ToDateTime(analysisdate);
                        }
                        else
                        {
                            masterrecord.AnalysisDate = null;
                        }
                        masterrecord.CMR = CMR;
                        masterrecord.Dept = Dept;
                        masterrecord.HPLC = HPLC;
                        masterrecord.HPLCGCELSD = HPLCGCELSD;
                        masterrecord.IR = IR;
                        masterrecord.Mass = Mass;
                        masterrecord.NMR = NMR;
                        masterrecord.PhysicalState = PhysicalState;
                        masterrecord.Potency = Potency;
                        masterrecord.QuantityAvailable = masterrecord.QuantityAvailable;
                        masterrecord.Remark1 = Remark1;
                        masterrecord.Remark2 = Remark2;
                        masterrecord.Purity = Purity;
                        masterrecord.ResidueOnIgnition = ResidueOnIgnition;
                        if (!string.IsNullOrEmpty(ReTestDate))
                        {
                            masterrecord.ReTestDate = Convert.ToDateTime(ReTestDate);
                        }
                        else
                        {
                            masterrecord.ReTestDate = null;
                        }
                        masterrecord.SOLUBILITY = SOLUBILITY;
                        masterrecord.SpecialInstruction = SpecialInstruction;
                        masterrecord.StorageCon = StorageCon;
                        masterrecord.TGA = TGA;
                        masterrecord.TGALoss = TGALoss;
                        masterrecord.UpdatedDate = DateTime.Now;
                        db.Entry(masterrecord).State = EntityState.Modified;
                        db.SaveChanges();
                    }
                    else
                    {
                        masterrecord = new SZ_MasterCOA();
                        masterrecord.RefNo = "SZ-" + DateTime.Now.ToString("HHmm") + "-" + DateTime.Now.ToString("yy") + "-" + DateTime.Now.ToString("ddMM");

                        masterrecord.HPLC = HPLC;
                        masterrecord.QuantityAvailable = availablequantity;
                        if (!string.IsNullOrEmpty(analysisdate))
                        {
                            masterrecord.AnalysisDate = Convert.ToDateTime(analysisdate);
                        }
                        else
                        {
                            masterrecord.AnalysisDate = null;
                        }
                        masterrecord.BatchId = batchlist.Id;
                        masterrecord.BatchNo = batchlist.BatchNo;
                        masterrecord.ProductName = db.Products.Where(x => x.Id == batchlist.ProductId).Select(x => x.Name).FirstOrDefault();
                        masterrecord.CMR = CMR;
                        masterrecord.Dept = Dept;
                        masterrecord.HPLC = HPLC;
                        masterrecord.HPLCGCELSD = HPLCGCELSD;
                        masterrecord.IR = IR;
                        masterrecord.Mass = Mass;
                        masterrecord.NMR = NMR;
                        masterrecord.PhysicalState = PhysicalState;
                        masterrecord.Potency = Potency;
                        masterrecord.QuantityAvailable = masterrecord.QuantityAvailable;
                        masterrecord.Remark1 = Remark1;
                        masterrecord.Remark2 = Remark2;
                        masterrecord.Purity = Purity;
                        masterrecord.ResidueOnIgnition = ResidueOnIgnition;
                        if (!string.IsNullOrEmpty(ReTestDate))
                        {
                            masterrecord.ReTestDate = Convert.ToDateTime(ReTestDate);
                        }
                        else
                        {
                            masterrecord.ReTestDate = null;
                        }
                        masterrecord.SOLUBILITY = SOLUBILITY;
                        masterrecord.SpecialInstruction = SpecialInstruction;
                        masterrecord.StorageCon = StorageCon;
                        masterrecord.TGA = TGA;
                        masterrecord.TGALoss = TGALoss;
                        masterrecord.CreatedDate = DateTime.Now;
                        masterrecord.UpdatedDate = DateTime.Now;
                        db.SZ_MasterCOA.Add(masterrecord);
                        db.SaveChanges();
                    }
                }
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = ex.Message
                }, JsonRequestBehavior.AllowGet);
            }
            return Json(new
            {
                success = true,
                message = "Information saved successfully."
            }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult SavePendingAction(int? scId, string projectType, int id)
        {
            var data = _operationRepository.GetQuoteDetailByID(id);
            if (data != null)
            {
                if ((data.ScientistCustomerId == null || data.ScientistCustomerId == 0) && (scId != null && scId != 0))
                {
                    data.ProjectStatus = (int)EnumList.ProjectStatus.MoveToScientist;
                }
                if ((data.ScientistCustomerId != null && data.ScientistCustomerId != 0) && (scId == null || scId == 0))
                {
                    data.ProjectStatus = (int)EnumList.ProjectStatus.NoAction;
                }

                if (!data.ScientistCustomerId.HasValue && scId.HasValue)
                {
                    data.MoveToScientistDate = DateTime.Now;
                }
                if (data.ScientistCustomerId.HasValue && scId.HasValue && data.ScientistCustomerId.Value != scId.Value)
                {
                    //assign another scientist then update date
                    data.MoveToScientistDate = DateTime.Now;
                }

                data.ScientistCustomerId = scId;
                data.ProjectType = projectType;

                if (string.IsNullOrEmpty(projectType))
                {
                    data.ProjectStatus = (int)EnumList.ProjectStatus.NoAction;
                }

                if (!string.IsNullOrEmpty(projectType) && Convert.ToInt32(projectType) == (int)EnumList.ProjectType.InStock)
                {
                    data.ProjectStatus = (int)EnumList.ProjectStatus.MoveToInstock;
                    if (data.ProcessState <= (int)EnumList.ProcessState.MoveToInStock)
                    {
                        data.ProcessState = (int)EnumList.ProcessState.MoveToInStock;
                    }
                }
                if (!string.IsNullOrEmpty(projectType) && Convert.ToInt32(projectType) == (int)EnumList.ProjectType.Purchase)
                {
                    data.ProjectStatus = (int)EnumList.ProjectStatus.MoveToPurchase;
                    if (data.ProcessState <= (int)EnumList.ProcessState.MoveToPurchase)
                    {
                        data.ProcessState = (int)EnumList.ProcessState.MoveToPurchase;
                    }
                }

                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json("", JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult UpdateProjectPurchaseRFQInfo(PurchaseRFQModel model)
        {
            var data = db.SZ_PurchaseRFQ.Where(x => x.Id == model.Id).FirstOrDefault();
            if (data != null)
            {
                data.PurchaseRemark = model.PurchaseRemark;

                data.Comment = model.Comment;
                data.Summary = model.Summary;
                data.PurchaseStatus = model.PurchaseStatus;
                data.ChemicalName = model.ChemicalName;
                data.CASNo = model.CASNo;
                data.CATNo = model.CATNo;
                data.Estdate = model.Estdate;

                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json("", JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult UpdateProjectPurchaseInfo(SZ_QuotationProductModel model)
        {
            var data = _operationRepository.GetQuoteDetailByID(model.QuoteDetailsId);
            if (data != null)
            {
                //data.PurchaseRemark = model.PurchaseRemark;
                // Disable because we have added pencil icon

                data.Reason = model.Reason;
                data.PurchaseDDLStatus = model.PurchaseDDLStatus;
                //data.PurchaseStatus = model.PurchaseStatus;
                // Disable because we have added pencil icon

                if (data.ProjectType == Convert.ToString((int)EnumList.ProjectType.Purchase))
                {
                    data.ProStatus = data.PurchaseDDLStatus;
                    data.OtherProStatus = data.PurchaseDDLStatus;
                    data.DispatchStatus = data.PurchaseDDLStatus;
                    data.ReviewSciStatus = data.PurchaseDDLStatus;
                }

                if (model.TabName == "tblquoteapproval")
                {
                    data.PurApprovedStatus = model.PurApprovedStatus;
                    //data.PurMangRemark = model.PurMangRemark;
                }

                if (data.PurchaseDDLStatus == "28")
                {
                    if (data.EstimateCompleteDate < DateTime.Now)
                    {
                        //data.EstimateCompleteDate = DateTime.Now;
                    }
                    //data.ProjectType = Convert.ToString((int)EnumList.ProjectType.InStock);
                    data.ProStatus = Convert.ToString((int)EnumList.ProStatusDDL.DataPending);
                    data.OtherProStatus = Convert.ToString((int)EnumList.ProStatusDDL.DataPending);
                    data.DispatchStatus = Convert.ToString((int)EnumList.ProStatusDDL.DataPending);
                    data.ReviewSciStatus = Convert.ToString((int)EnumList.ProStatusDDL.DataPending);
                    data.ExplainationSecond = "Analytical data recording is in progress and we will try to complete the analysis as per estimated completion date. ";
                }

                var productdata = db.Products.Where(x => x.Id == data.ProductId).FirstOrDefault();
                if (productdata != null)
                {
                    productdata.Quotationreceived = model.PurchaseStatus;
                    db.Entry(productdata).State = EntityState.Modified;
                }

                data.EstimateCompleteDate = model.EstimateCompleteDate;
                data.PurClientPODate = model.PurClientPODate;
                data.PurOurPODt = model.PurOurPODt;
                data.PurExpectedReceiptDt = model.PurExpectedReceiptDt;
                data.PurCurrentExpDt = model.PurCurrentExpDt;
                data.PurActualReceiptDt = model.PurActualReceiptDt;
                data.PurTargetDispatchDt = model.PurTargetDispatchDt;
                data.PurPrice = model.PurPrice;
                data.PurSZPONo = model.PurSZPONo;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json("", JsonRequestBehavior.AllowGet);
        }


        [HttpPost]
        [ValidateInput(false)]
        public ActionResult UpdatePurchaseCloseStatus(List<int> id)
        {
            foreach (var item in id)
            {
                var data = _operationRepository.GetQuoteDetailByID(item);
                if (data != null)
                {
                    data.PurchaseDDLStatus = "24";
                    db.Entry(data).State = EntityState.Modified;
                    db.SaveChanges();
                }
            }
            return Json("", JsonRequestBehavior.AllowGet);
        }


        [HttpPost]
        [ValidateInput(false)]
        public ActionResult UpdateControlledSubstanceData(ControlledSubstanceModel model)
        {
            try
            {
                int id = model.id;
                var data = _operationRepository.GetQuoteDetailByID(id);
                if (data != null)
                {
                    var oldModel = LogManagement.PrepareQuoteDetailEntity(data);
                    data.LicesenStatusId = model.LicesenStatus;
                    data.PermitRequired = model.PermitRequired;
                    data.ImportPermit = model.ImportPermit;
                    data.Declaration = model.Declaration;
                    data.ExportPermitReceivedDate = model.ExportPermitReceivedDate;
                    data.ApplicationDate = model.ApplicationDate;
                    data.TechnicalWriteup = model.TechnicalWriteup;
                    data.QuaterlyDataToSubmit = model.QuaterlyDataToSubmit;
                    data.QuaterlyDataSubmited = model.QuaterlyDataSubmited;
                    data.APIRequired = model.APIRequired;
                    data.APIImpExport = model.APIImpExport;
                    data.Category = model.Category;
                    data.ImpExpo = model.ImpExpo;
                    data.NextQuater = model.NextQuater;
                    db.Entry(data).State = EntityState.Modified;
                    db.SaveChanges();
                    PrepareProjectLog(data, oldModel, model.tabname);
                }
            }

            catch (DbEntityValidationException e)
            {
                foreach (var eve in e.EntityValidationErrors)
                {
                    Console.WriteLine("Entity of type \"{0}\" in state \"{1}\" has the following validation errors:",
                        eve.Entry.Entity.GetType().Name, eve.Entry.State);
                    foreach (var ve in eve.ValidationErrors)
                    {
                        Console.WriteLine("- Property: \"{0}\", Error: \"{1}\"",
                            ve.PropertyName, ve.ErrorMessage);
                    }
                }
                throw;
            }
            return Json("", JsonRequestBehavior.AllowGet);
        }


        [HttpPost]
        [ValidateInput(false)]
        public ActionResult UpdateProjectInfo(ProjectInfoModel model)
        {
            int? scId = model.scId;
            string projectType = model.projectType;
            string qty = model.qty;
            int id = model.id;
            string batchno = model.batchno;
            string remark = model.remark;
            string additionalBatch = model.additionalBatch;
            string scientistStatus = model.scientistStatus;
            var data = _operationRepository.GetQuoteDetailByID(id);
            if (data != null)
            {
                var oldModel = LogManagement.PrepareQuoteDetailEntity(data);

                if (model.tabname == "glp")
                {

                    data.GLPStatus = model.GLPStatus;
                    if (!string.IsNullOrEmpty(model.analysisCompletionDate))
                    {
                        data.GLPAnalysisCompletionDate = Convert.ToDateTime(model.analysisCompletionDate);
                    }
                }
                else
                {
                    if ((data.ScientistCustomerId == null || data.ScientistCustomerId == 0) && (scId != null && scId != 0))
                    {
                        data.ProjectStatus = (int)EnumList.ProjectStatus.MoveToScientist;
                    }
                    if ((data.ScientistCustomerId != null && data.ScientistCustomerId != 0) && (scId == null || scId == 0))
                    {
                        data.ProjectStatus = (int)EnumList.ProjectStatus.NoAction;
                    }
                    if (!data.ScientistCustomerId.HasValue && scId.HasValue)
                    {
                        data.MoveToScientistDate = DateTime.Now;
                    }
                    if (data.ScientistCustomerId.HasValue && scId.HasValue && data.ScientistCustomerId.Value != scId.Value)
                    {
                        data.MoveToScientistDate = DateTime.Now;
                    }
                    data.ScientistCustomerId = scId;
                    if (!string.IsNullOrEmpty(additionalBatch))
                    {
                        data.AdditionalBatchNo = Convert.ToInt32(additionalBatch);
                    }
                    else
                    {
                        data.AdditionalBatchNo = null;
                    }
                    data.RequiredQty = qty;
                    data.IsSuccessSAP = false;
                    if (model.tabname == "all")
                    {
                        if (data.IsGLP != model.IsGLP && model.IsGLP == true)
                        {
                            data.GLPAssignDate = DateTime.Now;
                        }
                        data.IsGLP = model.IsGLP;
                        data.GLPStatus = model.GLPStatus;
                        if (!string.IsNullOrEmpty(model.CoaId))
                        {
                            data.COAId = Convert.ToInt32(model.CoaId);
                            data.COARefNumber = db.SZ_ChildCOA.Where(x => x.Id == data.COAId).Select(x => x.RefNo).FirstOrDefault();
                        }
                        else
                        {
                            data.COAId = null;
                            data.COARefNumber = null;
                        }
                    }
                    if (model.tabname == "glp")
                    {
                        if (data.IsGLP != model.IsGLP && model.IsGLP == true)
                        {
                            data.GLPAssignDate = DateTime.Now;
                        }
                        data.IsGLP = model.IsGLP;
                        data.GLPStatus = model.GLPStatus;
                        if (!string.IsNullOrEmpty(model.CoaId))
                        {
                            data.COAId = Convert.ToInt32(model.CoaId);
                            data.COARefNumber = db.SZ_ChildCOA.Where(x => x.Id == data.COAId).Select(x => x.RefNo).FirstOrDefault();

                        }
                        else
                        {
                            data.COAId = null;
                            data.COARefNumber = null;
                        }
                        if (!string.IsNullOrEmpty(model.analysisCompletionDate))
                        {
                            data.GLPAnalysisCompletionDate = Convert.ToDateTime(model.analysisCompletionDate);
                        }
                    }
                    if (model.tabname == "purchase")
                    {

                        data.PurchaseStatus = model.purchaseStatus;
                        data.Reason = model.reason;
                        data.PurchaseRemark = model.purchaseremark;
                        data.PurchaseDDLStatus = model.purchaseDDLStatus;
                        if (!string.IsNullOrEmpty(model.estDate))
                        {
                            var estimateCompleteDate = Convert.ToDateTime(model.estDate);
                            if (estimateCompleteDate != data.EstimateCompleteDate)
                            {
                                data.PreviousEstCompleteDate = data.EstimateCompleteDate;
                            }
                            data.EstimateCompleteDate = estimateCompleteDate;
                        }
                    }
                    else
                    {
                        if (data.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && (projectType == Convert.ToString((int)EnumList.ProjectType.Synthesis) || projectType == Convert.ToString((int)EnumList.ProjectType.Purchase) || projectType == Convert.ToString((int)EnumList.ProjectType.PurSynthesis)))
                        {
                            data.ScientistStatus = null;
                        }
                        data.Remark = remark;
                        data.ProjectType = projectType;
                        if (string.IsNullOrEmpty(projectType))
                        {
                            data.ProjectStatus = (int)EnumList.ProjectStatus.NoAction;
                        }
                        if (!string.IsNullOrEmpty(projectType) && Convert.ToInt32(projectType) == (int)EnumList.ProjectType.InStock)
                        {
                            data.ProjectStatus = (int)EnumList.ProjectStatus.MoveToInstock;
                            if (data.ProcessState <= (int)EnumList.ProcessState.MoveToInStock)
                            {
                                data.ProcessState = (int)EnumList.ProcessState.MoveToInStock;
                            }
                        }
                        if (!string.IsNullOrEmpty(projectType) && oldModel.ProjectType != projectType && (Convert.ToInt32(projectType) == (int)EnumList.ProjectType.Purchase || Convert.ToInt32(projectType) == (int)EnumList.ProjectType.PurSynthesis))
                        {
                            data.PurchaseDate = DateTime.Now;
                            data.ProjectStatus = (int)EnumList.ProjectStatus.MoveToPurchase;
                            if (data.ProcessState <= (int)EnumList.ProcessState.MoveToPurchase)
                            {
                                data.ProcessState = (int)EnumList.ProcessState.MoveToPurchase;
                            }
                        }
                        if (model.tabname != "purchase")
                        {
                            data.LastStatus = data.AdminScientistStatus;
                            data.AdminScientistStatus = scientistStatus;
                            var estimateCompleteDate = Convert.ToDateTime(model.estDate);
                            if (estimateCompleteDate != DateTime.MinValue)
                            {
                                if (estimateCompleteDate != data.EstimateCompleteDate)
                                {
                                    if (model.prostatus != Convert.ToString((int)EnumList.ProStatusDDL.DataSent)
                                        || model.prostatus != Convert.ToString((int)EnumList.ProStatusDDL.DataCorrection)
                                        || model.prostatus != Convert.ToString((int)EnumList.ProStatusDDL.DataApproved)
                                        || model.prostatus != Convert.ToString((int)EnumList.ProStatusDDL.InvoiceSent)
                                        || model.prostatus != Convert.ToString((int)EnumList.ProStatusDDL.ThirtyDaysPDC)
                                        || model.prostatus != Convert.ToString((int)EnumList.ProStatusDDL.AdvancePayment)
                                        || model.prostatus != Convert.ToString((int)EnumList.ProStatusDDL.ProductConfirmation)
                                        || model.prostatus != Convert.ToString((int)EnumList.ProStatusDDL.DataPending)
                                        || model.prostatus != Convert.ToString((int)EnumList.ProStatusDDL.RetestAnalysis))
                                    {
                                        if (data.CountEstDate == null)
                                        {
                                            data.CountEstDate = 0;
                                        }
                                        data.CountEstDate += 1;
                                    }
                                    data.PreviousEstCompleteDate = data.EstimateCompleteDate;
                                }
                                data.EstimateCompleteDate = estimateCompleteDate;
                            }
                            else
                            {
                                data.EstimateCompleteDate = null;
                            }
                        }
                        if (model.tabname == "all" || model.tabname == "noaction" || model.tabname == "synthesis" || model.tabname == "domestic" || model.tabname == "export" || model.tabname == "purchase" || model.tabname == "instock")
                        {
                            data.Reason = model.reason;
                        }
                        if (model.tabname == "all" || model.tabname == "noaction" || model.tabname == "instock" || model.tabname == "domestic" || model.tabname == "synthesis" || model.tabname == "export")
                        {
                            data.OrderRemark = model.orderremark;
                            data.SubScientistName = model.subScientistId;
                        }
                        if (model.tabname == "export")
                        {
                            if (!string.IsNullOrEmpty(model.reportinvoiceDate))
                            {
                                data.ReportInvoiceDate = Convert.ToDateTime(model.reportinvoiceDate);
                            }
                            else
                            {
                                data.ReportInvoiceDate = null;
                            }
                        }
                        if (model.tabname == "all" || model.tabname == "noaction" || model.tabname == "noaction")
                        {
                            data.DifficultyLevel = model.difflevel;
                            var product = db.Products.Where(x => x.Id == data.ProductId).FirstOrDefault();
                            if (product != null)
                            {
                                product.DifficultyLevel = model.difflevel;
                                db.Entry(product).State = EntityState.Modified;
                                //db.SaveChanges();
                            }
                        }
                        if (model.tabname == "all" || model.tabname == "synthesis")
                        {
                            if (data.ProStatus != model.prostatus)
                            {
                                data.PreviousStatus = data.ProStatus;
                            }
                            if (!string.IsNullOrEmpty(data.OtherProStatus))
                            {
                                data.LastProStatus = data.OtherProStatus;
                            }
                            data.ProStatus = model.prostatus;
                            data.OtherProStatus = model.prostatus;
                            data.DispatchStatus = model.prostatus;
                            data.ReviewSciStatus = Convert.ToString(model.prostatus);
                        }
                        if (model.tabname == "all")
                        {
                            if (data.ExplainationSecond != model.explainationsecond)
                            {
                                data.LastWeekUpdate = data.ExplainationSecond;
                            }
                            data.ExplainationSecond = model.explainationsecond;
                        }
                        if (model.tabname == "all" || model.tabname == "domestic" || model.tabname == "export" || model.tabname == "instock")
                        {
                            data.ActivityStatus = model.activity;
                        }
                        if (model.tabname == "domestic" || model.tabname == "export" || model.tabname == "instock")
                        {
                            if (!string.IsNullOrEmpty(data.OtherProStatus))
                            {
                                data.LastProStatus = data.OtherProStatus;
                            }
                            data.OtherProStatus = model.otherprostatus;
                            data.ProStatus = model.otherprostatus;
                            data.DispatchStatus = model.otherprostatus;
                            data.ReviewSciStatus = Convert.ToString(model.otherprostatus);
                        }
                    }

                    if (oldModel.ProStatus != model.prostatus
                        && (model.prostatus == Convert.ToString((int)EnumList.ProStatusDDL.DataSent)
                            || model.prostatus == Convert.ToString((int)EnumList.ProStatusDDL.DataCorrection)
                            || model.prostatus == Convert.ToString((int)EnumList.ProStatusDDL.DataApproved)
                            || model.prostatus == Convert.ToString((int)EnumList.ProStatusDDL.InvoiceSent)
                            || model.prostatus == Convert.ToString((int)EnumList.ProStatusDDL.ThirtyDaysPDC)
                            || model.prostatus == Convert.ToString((int)EnumList.ProStatusDDL.AdvancePayment))
                        )
                    {
                        if (data.EstimateCompleteDate.HasValue)
                        {
                            if (data.EstimateCompleteDate.Value.Date < DateTime.Now.Date)
                            {
                                //data.EstimateCompleteDate = DateTime.Now;
                            }
                        }
                    }

                }
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();

                PrepareProjectLog(data, oldModel, model.tabname);
            }
            return Json("", JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult UpdatePrepHPLC(ProjectInfoModel model)
        {
            int id = model.id;
            var data = _operationRepository.GetQuoteDetailByID(id);
            if (data != null)
            {
                var oldModel = LogManagement.PrepareQuoteDetailEntity(data);
                if (!string.IsNullOrEmpty(model.estDate))
                {
                    var estimateCompleteDate = Convert.ToDateTime(model.estDate);
                    if (estimateCompleteDate != data.EstimateCompleteDate)
                    {
                        data.PreviousEstCompleteDate = data.EstimateCompleteDate;
                    }
                    data.EstimateCompleteDate = estimateCompleteDate;
                }
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();

                PrepareQuoteDetailsLog(data, oldModel);
            }
            return Json("", JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult addNewPurchaseRFQData(PurchaseRFQModel model)
        {
            string customerName = "";
            var customer = db.Customers.Where(x => x.Id == SessionCookieManagement.UserId && x.Deleted == false && x.Active == true).FirstOrDefault();
            if (customer != null)
            {
                var genericAttr = db.GenericAttributes.Where(x => x.KeyGroup == "Customer" && x.EntityId == customer.Id).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
            }

            string value = string.Empty;
            string matchingstring = "SZ-RFQ-";
            var szPurchase = (from i in db.SZ_PurchaseRFQ
                              select i).ToList();
            int refNo = 0;
            if (szPurchase.Count > 0)
            {
                refNo = szPurchase.Select(x => ExtractPurchaseRfqNumber(x.RfqNo)).Max(w => w);
                int newbrokerrewf = Convert.ToInt32(refNo) + 1;
                value = "SZ-RFQ-" + newbrokerrewf.ToString().PadLeft(3, '0');
            }
            else
            {
                value = "SZ-RFQ-001";
            }

            SZ_PurchaseRFQ objPRfq = new SZ_PurchaseRFQ();
            objPRfq.CreatedBy = customerName;
            objPRfq.CreatedDate = DateTime.Now;
            objPRfq.AssignedDate = DateTime.Now;
            objPRfq.CASNo = model.CASNo;
            objPRfq.CATNo = model.CATNo;
            objPRfq.ChemicalName = model.ChemicalName;
            objPRfq.Comment = model.Comment;
            objPRfq.RfqNo = value;
            objPRfq.RefBy = model.RefBy;
            db.SZ_PurchaseRFQ.Add(objPRfq);
            db.SaveChanges();

            return Json("", JsonRequestBehavior.AllowGet);
        }

        [HttpGet]
        public ActionResult BackMoveFromProject(int id)
        {
            var data = _operationRepository.GetQuoteDetailByID(id);
            if (data != null)
            {
                var oldModel = LogManagement.PrepareQuoteDetailEntity(data);

                data.TrackingNo = null;
                data.MoveToProject = false;
                data.MoveToDispatch = false;
                data.MoveToInvoice = false;
                data.MoveDispatchDate = null;
                data.MoveProjectDate = null;
                data.MoveToInvoiceDate = null;
                data.MoveToScientistDate = null;
                data.ScientistCustomerId = null;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();

                PrepareQuoteDetailsLog(data, oldModel);

            }
            return Json("", JsonRequestBehavior.AllowGet);
        }

        [HttpGet]
        public ActionResult ChangeProductPriority(bool status, int id)
        {
            var data = _operationRepository.GetQuoteDetailByID(id);
            if (data != null)
            {
                data.IsPriority = status;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json("", JsonRequestBehavior.AllowGet);
        }

        [HttpGet]
        public ActionResult ParkQuotationdetail(bool status, int id, string parkreason)
        {
            var data = _operationRepository.GetQuoteByID(id);
            if (data != null)
            {
                data.IsPark = status;
                data.ParkReason = parkreason;
                data.IsInstock = false;
                data.IsCustomSynthesis = false;
                data.IsToBe = false;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json("", JsonRequestBehavior.AllowGet);
        }


        [HttpPost]
        [ValidateInput(false)]
        public ActionResult UpdateDataapprovedInfo(string status, int id, string additionalBatch)
        {
            var data = _operationRepository.GetQuoteDetailByID(id);
            if (data != null)
            {
                data.DataApprovedStatus = status;
                if (!string.IsNullOrEmpty(additionalBatch))
                {
                    data.AdditionalBatchNo = Convert.ToInt32(additionalBatch);
                }
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json("", JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult UpdateRefStock(string refstock, int id)
        {
            var data = db.Products.Where(x => x.Id == id).FirstOrDefault();
            if (data != null)
            {
                data.RefStockPrice = refstock;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json("", JsonRequestBehavior.AllowGet);
        }

        public ActionResult UpdateMasterPriceList(int id, string TenPrice, string TwentyFivePrice, string FiftyPrice, string HundredPrice,
            string LeadTime, string ProductRemark,
            string categorymaster, bool isUSD,
            string TenPriceUSD, string TwentyFivePriceUSD, string FiftyPriceUSD, string HundredPriceUSD, string categorymasterUSD, bool isApproved)
        {
            if (categorymaster == "undefined")
            {
                categorymaster = "";
            }
            var data = db.Products.Where(x => x.Id == id).FirstOrDefault();
            if (data != null)
            {
                var pricedata = db.SZ_PriceList.Where(x => x.ProductId == id && x.IsUsd == true).FirstOrDefault();
                if (pricedata != null)
                {
                    pricedata.TenUSD = TenPriceUSD;
                    pricedata.TwentyfiveUSD = TwentyFivePriceUSD;
                    pricedata.FiftyUSD = FiftyPriceUSD;
                    pricedata.OnehundredUSD = HundredPriceUSD;
                    pricedata.CategoryMasterUSdId = !string.IsNullOrEmpty(categorymaster) ? Convert.ToInt32(categorymaster) : 0;

                    pricedata.TenPrice = TenPrice;
                    pricedata.TwentyFivePrice = TwentyFivePrice;
                    pricedata.FiftyPrice = FiftyPrice;
                    pricedata.HundredPrice = HundredPrice;
                    pricedata.CategoryMasterINRId = !string.IsNullOrEmpty(categorymaster) ? Convert.ToInt32(categorymaster) : 0;
                    pricedata.ProductRemark = ProductRemark;
                    pricedata.LeadTime = LeadTime;
                    pricedata.IsPriceApproved = isApproved;
                    pricedata.IsUsd = true;
                    pricedata.LeadTime = LeadTime;
                    db.Entry(pricedata).State = EntityState.Modified;
                    db.SaveChanges();
                }
                else
                {
                    pricedata = new SZ_PriceList();
                    pricedata.ProductId = data.Id;
                    pricedata.TenUSD = TenPriceUSD;
                    pricedata.TwentyfiveUSD = TwentyFivePriceUSD;
                    pricedata.FiftyUSD = FiftyPriceUSD;
                    pricedata.OnehundredUSD = HundredPriceUSD;
                    pricedata.CategoryMasterUSdId = !string.IsNullOrEmpty(categorymaster) ? Convert.ToInt32(categorymaster) : 0;

                    pricedata.TenPrice = TenPrice;
                    pricedata.TwentyFivePrice = TwentyFivePrice;
                    pricedata.FiftyPrice = FiftyPrice; pricedata.HundredPrice = HundredPrice;
                    pricedata.CategoryMasterINRId = !string.IsNullOrEmpty(categorymaster) ? Convert.ToInt32(categorymaster) : 0;
                    pricedata.IsPriceApproved = isApproved;
                    pricedata.IsUsd = true;
                    pricedata.LeadTime = LeadTime;
                    pricedata.ProductRemark = ProductRemark;
                    db.Entry(pricedata).State = EntityState.Added;
                }

                var pricedataINR = db.SZ_PriceList.Where(x => x.ProductId == id && x.IsUsd == false).FirstOrDefault();
                if (pricedataINR != null)
                {

                    pricedataINR.TenUSD = TenPriceUSD;
                    pricedataINR.TwentyfiveUSD = TwentyFivePriceUSD;
                    pricedataINR.FiftyUSD = FiftyPriceUSD;
                    pricedataINR.OnehundredUSD = HundredPriceUSD;
                    pricedataINR.CategoryMasterUSdId = !string.IsNullOrEmpty(categorymaster) ? Convert.ToInt32(categorymaster) : 0;

                    pricedataINR.TenPrice = TenPrice;
                    pricedataINR.TwentyFivePrice = TwentyFivePrice;
                    pricedataINR.FiftyPrice = FiftyPrice;
                    pricedataINR.HundredPrice = HundredPrice;
                    pricedataINR.CategoryMasterINRId = !string.IsNullOrEmpty(categorymaster) ? Convert.ToInt32(categorymaster) : 0;

                    pricedataINR.LeadTime = LeadTime;
                    pricedataINR.ProductRemark = ProductRemark;
                    pricedataINR.IsPriceApproved = isApproved;
                    pricedataINR.IsUsd = false;
                    pricedataINR.LeadTime = LeadTime;
                    db.Entry(pricedataINR).State = EntityState.Modified;
                }
                else
                {
                    pricedataINR = new SZ_PriceList();
                    pricedataINR.ProductId = data.Id;
                    pricedataINR.TenUSD = TenPriceUSD;
                    pricedataINR.TwentyfiveUSD = TwentyFivePriceUSD;
                    pricedataINR.FiftyUSD = FiftyPriceUSD;
                    pricedataINR.OnehundredUSD = HundredPriceUSD;
                    pricedataINR.CategoryMasterUSdId = !string.IsNullOrEmpty(categorymaster) ? Convert.ToInt32(categorymaster) : 0;
                    pricedataINR.TenPrice = TenPrice;
                    pricedataINR.TwentyFivePrice = TwentyFivePrice;
                    pricedataINR.FiftyPrice = FiftyPrice; pricedataINR.HundredPrice = HundredPrice;
                    pricedataINR.CategoryMasterINRId = !string.IsNullOrEmpty(categorymaster) ? Convert.ToInt32(categorymaster) : 0;
                    pricedataINR.IsPriceApproved = isApproved;
                    pricedataINR.IsUsd = false;
                    pricedataINR.LeadTime = LeadTime;
                    pricedataINR.ProductRemark = ProductRemark;
                    db.Entry(pricedataINR).State = EntityState.Added;
                }
                db.SaveChanges();
            }

            return Json("", JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult UpdatePriceList(int id, string TenPrice, string TwentyFivePrice, string FiftyPrice,
            string HundredPrice, string TwoHundredPrice,
            string Discount, string LeadTime, string ProductRemark,
            string categorymaster, string FivehundredPrice, string OneThousandPrice, bool isUSD,

            string TenPriceUSD, string TwentyFivePriceUSD, string FiftyPriceUSD, string HundredPriceUSD, string TwoHundredPriceUSD,
            string DiscountUSD, string categorymasterUSD, string FivehundredPriceUSD, string OneThousandPriceUSD, bool isApproved
            )
        {
            if (categorymaster == "undefined")
            {
                categorymaster = "";
            }
            var data = db.Products.Where(x => x.Id == id).FirstOrDefault();
            if (data != null)
            {
                var pricedata = db.SZ_PriceList.Where(x => x.ProductId == id && x.IsUsd == true).FirstOrDefault();
                if (pricedata != null)
                {

                    pricedata.DiscountUSD = DiscountUSD;
                    pricedata.TenUSD = TenPriceUSD;
                    pricedata.TwentyfiveUSD = TwentyFivePriceUSD;
                    pricedata.FiftyUSD = FiftyPriceUSD;
                    pricedata.OnehundredUSD = HundredPriceUSD;
                    pricedata.TwohundredFiftyUSD = TwoHundredPriceUSD;
                    pricedata.OneThousandUSD = OneThousandPriceUSD;
                    pricedata.FivehundredUSD = FivehundredPriceUSD;
                    pricedata.CategoryMasterUSdId = !string.IsNullOrEmpty(categorymasterUSD) ? Convert.ToInt32(categorymasterUSD) : 0;
                    pricedata.FivehundredPrice = FivehundredPrice;
                    pricedata.OneThousandPrice = OneThousandPrice;
                    pricedata.TenPrice = TenPrice;
                    pricedata.TwentyFivePrice = TwentyFivePrice;
                    pricedata.FiftyPrice = FiftyPrice;
                    pricedata.HundredPrice = HundredPrice;
                    pricedata.TwoHundredPrice = TwoHundredPrice;
                    pricedata.DiscountINR = Discount;
                    pricedata.CategoryMasterINRId = !string.IsNullOrEmpty(categorymaster) ? Convert.ToInt32(categorymaster) : 0;
                    pricedata.ProductRemark = ProductRemark;
                    pricedata.LeadTime = LeadTime;
                    pricedata.IsPriceApproved = isApproved;
                    pricedata.IsUsd = true;
                    pricedata.LeadTime = LeadTime;
                    db.Entry(pricedata).State = EntityState.Modified;
                    db.SaveChanges();
                }
                else
                {
                    pricedata = new SZ_PriceList();
                    pricedata.ProductId = data.Id;
                    pricedata.DiscountUSD = DiscountUSD;
                    pricedata.TenUSD = TenPriceUSD;
                    pricedata.TwentyfiveUSD = TwentyFivePriceUSD;
                    pricedata.FiftyUSD = FiftyPriceUSD;
                    pricedata.OnehundredUSD = HundredPriceUSD;
                    pricedata.TwohundredFiftyUSD = TwoHundredPriceUSD;
                    pricedata.OneThousandUSD = OneThousandPriceUSD;
                    pricedata.FivehundredUSD = FivehundredPriceUSD;
                    pricedata.CategoryMasterUSdId = !string.IsNullOrEmpty(categorymasterUSD) ? Convert.ToInt32(categorymasterUSD) : 0;
                    pricedata.FivehundredPrice = FivehundredPrice;
                    pricedata.OneThousandPrice = OneThousandPrice;
                    pricedata.TenPrice = TenPrice;
                    pricedata.TwentyFivePrice = TwentyFivePrice;
                    pricedata.FiftyPrice = FiftyPrice;
                    pricedata.HundredPrice = HundredPrice;
                    pricedata.TwoHundredPrice = TwoHundredPrice;
                    pricedata.DiscountINR = Discount;
                    pricedata.CategoryMasterINRId = !string.IsNullOrEmpty(categorymaster) ? Convert.ToInt32(categorymaster) : 0;
                    pricedata.IsPriceApproved = isApproved;
                    pricedata.IsUsd = true;
                    pricedata.LeadTime = LeadTime;
                    pricedata.ProductRemark = ProductRemark;
                    db.Entry(pricedata).State = EntityState.Added;
                }

                var pricedataINR = db.SZ_PriceList.Where(x => x.ProductId == id && x.IsUsd == false).FirstOrDefault();
                if (pricedataINR != null)
                {

                    pricedataINR.DiscountUSD = DiscountUSD;
                    pricedataINR.TenUSD = TenPriceUSD;
                    pricedataINR.TwentyfiveUSD = TwentyFivePriceUSD;
                    pricedataINR.FiftyUSD = FiftyPriceUSD;
                    pricedataINR.OnehundredUSD = HundredPriceUSD;
                    pricedataINR.TwohundredFiftyUSD = TwoHundredPriceUSD;
                    pricedataINR.OneThousandUSD = OneThousandPriceUSD;
                    pricedataINR.FivehundredUSD = FivehundredPriceUSD;
                    pricedataINR.CategoryMasterUSdId = !string.IsNullOrEmpty(categorymasterUSD) ? Convert.ToInt32(categorymasterUSD) : 0;

                    pricedataINR.FivehundredPrice = FivehundredPrice;
                    pricedataINR.OneThousandPrice = OneThousandPrice;
                    pricedataINR.TenPrice = TenPrice;
                    pricedataINR.TwentyFivePrice = TwentyFivePrice;
                    pricedataINR.FiftyPrice = FiftyPrice;
                    pricedataINR.HundredPrice = HundredPrice;
                    pricedataINR.TwoHundredPrice = TwoHundredPrice;
                    pricedataINR.DiscountINR = Discount;
                    pricedataINR.CategoryMasterINRId = !string.IsNullOrEmpty(categorymaster) ? Convert.ToInt32(categorymaster) : 0;


                    pricedataINR.LeadTime = LeadTime;
                    pricedataINR.ProductRemark = ProductRemark;
                    pricedataINR.IsPriceApproved = isApproved;
                    pricedataINR.IsUsd = false;
                    pricedataINR.LeadTime = LeadTime;
                    pricedataINR.ProductRemark = ProductRemark;
                    db.Entry(pricedataINR).State = EntityState.Modified;
                }
                else
                {
                    pricedataINR = new SZ_PriceList();
                    pricedataINR.ProductId = data.Id;
                    pricedataINR.DiscountUSD = DiscountUSD;
                    pricedataINR.TenUSD = TenPriceUSD;
                    pricedataINR.TwentyfiveUSD = TwentyFivePriceUSD;
                    pricedataINR.FiftyUSD = FiftyPriceUSD;
                    pricedataINR.OnehundredUSD = HundredPriceUSD;
                    pricedataINR.TwohundredFiftyUSD = TwoHundredPriceUSD;
                    pricedataINR.OneThousandUSD = OneThousandPriceUSD;
                    pricedataINR.FivehundredUSD = FivehundredPriceUSD;
                    pricedataINR.CategoryMasterUSdId = !string.IsNullOrEmpty(categorymasterUSD) ? Convert.ToInt32(categorymasterUSD) : 0;

                    pricedataINR.FivehundredPrice = FivehundredPrice;
                    pricedataINR.OneThousandPrice = OneThousandPrice;
                    pricedataINR.TenPrice = TenPrice;
                    pricedataINR.TwentyFivePrice = TwentyFivePrice;
                    pricedataINR.FiftyPrice = FiftyPrice;
                    pricedataINR.HundredPrice = HundredPrice;
                    pricedataINR.TwoHundredPrice = TwoHundredPrice;
                    pricedataINR.DiscountINR = Discount;
                    pricedataINR.CategoryMasterINRId = !string.IsNullOrEmpty(categorymaster) ? Convert.ToInt32(categorymaster) : 0;
                    pricedataINR.IsPriceApproved = isApproved;
                    pricedataINR.IsUsd = false;
                    pricedataINR.LeadTime = LeadTime;
                    pricedataINR.ProductRemark = ProductRemark;
                    db.Entry(pricedataINR).State = EntityState.Added;
                }

                db.SaveChanges();

            }

            return Json("", JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult UpdatePurchaseStatus(string status, int id, string date)
        {
            var data = _operationRepository.GetQuoteDetailByID(id);
            if (data != null)
            {
                data.PurchaseStatus = status;
                data.EstimateCompleteDate = Convert.ToDateTime(date);
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json("", JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult UpdateScientistProjectInfo(ScientistProjectInfoModel model)
        {
            var data = _operationRepository.GetQuoteDetailByID(model.id);
            if (data != null)
            {
                var oldEstCompDate = data.EstimateCompleteDate;
                if (model.tabname == "scientist-All" || model.tabname == "scientist-NOACTION")
                {
                    if (model.chemist != "undefined")
                    {
                        data.Chemist = model.chemist;
                    }
                }
                if (model.tabname == "scientist-All")
                {
                    if (!string.IsNullOrEmpty(model.reviewscistatus))
                    {
                        data.ReviewSciStatus = model.reviewscistatus;
                        data.ProStatus = model.reviewscistatus;
                        data.OtherProStatus = model.reviewscistatus;
                        data.ExplainationSecond = GetSecondaryExplaination(model.reviewscistatus);
                    }
                }
                if (model.scStatus.HasValue)
                {
                    if (data.ScientistStatus != model.scStatus)
                    {
                        data.LastStatus = data.AdminScientistStatus;
                        data.AdminScientistStatus = db.SZ_ScientistStatus.Where(x => x.Id == model.scStatus).Select(x => x.Name).FirstOrDefault();
                    }
                    data.ScientistStatus = model.scStatus;
                }
                if (!string.IsNullOrEmpty(model.remark) && model.remark != "undefined")
                {
                    data.Remark = model.remark;
                }
                data.SubScientistName = model.subscientist;
                if (model.batchcode1 != "undefined")
                {
                    data.BatchCode1 = model.batchcode1;
                }
                if (model.qty1 != "undefined")
                {
                    data.Qty1 = model.qty1;
                }
                data.BatchCode2 = model.batchcode2;
                data.Qty2 = model.qty2;
                if (!string.IsNullOrEmpty(model.esticompleteDate))
                {
                    data.EstimateCompleteDate = Convert.ToDateTime(model.esticompleteDate);

                    //Update date and manage counting

                    if (oldEstCompDate.HasValue && data.EstimateCompleteDate.Value.Date != oldEstCompDate.Value.Date)
                    {
                        if (data.CountEstDate == null)
                        {
                            data.CountEstDate = 0;
                        }
                        data.CountEstDate += 1;
                    }
                }
                else
                {
                    data.EstimateCompleteDate = null;
                }
                if (!string.IsNullOrEmpty(model.SynStartDate))
                {
                    data.SynStartDate = Convert.ToDateTime(model.SynStartDate);
                }
                else
                {
                    data.SynStartDate = null;
                }
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json("", JsonRequestBehavior.AllowGet);
        }

        public string GetSecondaryExplaination(string status)
        {
            var statusId = 0;
            if (!string.IsNullOrEmpty(status))
            {
                statusId = Convert.ToInt32(status);
            }

            var explaination = "";
            if (statusId == 1)
            {
                explaination = "Thank you for your valuable order and we confirm the safe receipt of the same. We have initiated the process to synthesize this product and we will try to complete the synthesis as per the estimated completion date.";
            }
            if (statusId == 2)
            {
                explaination = "We have initiated the process to synthesize this product and we will try to complete the synthesis as per estimated completion date.";
            }
            if (statusId == 3)
            {
                explaination = "We have initiated the process to synthesize this product and we will try to complete the synthesis as per estimated completion date.";
            }
            if (statusId == 4)
            {
                explaination = "We have ordered the raw material and we will try to complete the synthesis as per estimated completion date.";
            }
            if (statusId == 5)
            {
                explaination = "We are facing delay in receiving the raw material and once we received we will complete the synthesis as per estimated completion date.";
            }
            if (statusId == 6)
            {
                explaination = "We are facing challenges to get the raw material and due to which we can't predict the completion timeline.Meanwhile we request you to source from instock vendor and we will accept order cancellation.However, once we receive the raw material we will update the same.";
            }
            if (statusId == 7)
            {
                explaination = "Due to unavailability or delay in receiving the raw material, we are doing in house raw material synthesis. So, we will try to complete the synthesis as per estimated completion date. ";
            }
            if (statusId == 8)
            {
                explaination = "Synthesis is in progress and we will try to complete the synthesis as per estimated completion date. ";
            }
            if (statusId == 9)
            {
                explaination = "We are facing synthetic challenges and we are trying to resolve as per estimated completion date.";
            }
            if (statusId == 10)
            {
                explaination = "We are facing synthetic challenges and due to no positive outcome, we are not able to  predict the completion time. We request you to source from instock vendor for immediate use. Meanwhile, we will keep working and once synthesized we will update the same. ";
            }
            if (statusId == 11)
            {
                explaination = "Final step purification is in progress and we will try to complete the purification as per estimated completion date.";
            }
            if (statusId == 12)
            {
                explaination = "We have generated the crude and currently the batch is under prep hplc purification. We will complete the purification as per estimated completion date. ";
            }
            if (statusId == 13)
            {
                explaination = "We are facing challenges in purification and we are trying to resolve in stipulated time period. ";
            }
            if (statusId == 14)
            {
                explaination = "We are facing purification challenges and due to no positive result, we can't predict the completion timeline. We request you to source from instock vendor for immediate use. Meanwhile, we will keep working and once synthesized we will update the same. ";
            }
            if (statusId == 15)
            {
                explaination = "We are facing intricate issues in the synthesis and proposed ROS outcome is not positive. We are re-visiting other routes possible. We will keep you posted on the progress at regular interval.";
            }
            if (statusId == 16)
            {
                explaination = "We are facing synthetic challenges and due to no positive result, we can't predict the completion timeline. We request you to source from instock vendor for immediate use and we will accept order cancellation.  ";
            }
            if (statusId == 17)
            {
                explaination = "We are facing challenges in purification and due to no positive results we can’t predict the completion timeline. We request you to source from instock vendor for immediate use and we will accept order cancellation.  ";
            }
            if (statusId == 18)
            {
                explaination = "Analytical data recording is in progress and we will try to complete the analysis as per estimated completion date. ";
            }
            if (statusId == 19)
            {
                explaination = "We have this product in (_) form against (_)and if this serve your purpose then please let us know enable us to dispatch the same.";
            }
            if (statusId == 20)
            {
                explaination = "We have initiated the process to synthesize this product and we will try to complete the synthesis as per estimated completion date. ";
            }
            if (statusId == 21)
            {
                explaination = "We have initiated the process to synthesize this product and we will try to complete the synthesis as per estimated completion date. ";
            }
            if (statusId == 22)
            {
                explaination = "We have initiated the process to synthesize this product and we will try to complete the synthesis as per estimated completion date. ";
            }
            if (statusId == 23)
            {
                explaination = "We have ordered the raw material and we will complete the synthesis as per estimated completion date. ";
            }
            if (statusId == 24)
            {
                explaination = "Synthesis is in progress and we will try to complete the synthesis as per estimated completion date. ";
            }
            if (statusId == 25)
            {
                explaination = "Synthesis is in progress and we will try to complete the synthesis as per estimated completion date. ";
            }
            if (statusId == 26)
            {
                explaination = "Final step purification is in progress and we will try to complete the purification as per estimated completion date. ";
            }
            if (statusId == 27)
            {
                explaination = "We are facing challenges in purification and we are trying to resolve as per estimated completion date. ";
            }
            if (statusId == 28)
            {
                explaination = "Analytical data recording is in progress and we will try to complete the analysis as per estimated completion date. ";
            }
            if (statusId == 29)
            {
                explaination = "Analytical data recording is in progress and we will try to complete the analysis as per estimated completion date. ";
            }
            if (statusId == 30)
            {
                explaination = "Instock batch re-analysis is in progress and we will try to complete the analysis as per estimated completion date. ";
            }
            if (statusId == 31)
            {
                explaination = "Batch data is under QC approval and we will submit the batch as per estimated completion date.";
            }
            if (statusId == 32)
            {
                explaination = "Batch data has been approved by QC and we will submit the batch as per estimated completion date. ";
            }
            if (statusId == 33)
            {
                explaination = "QC has raised query in submitted batch and we will resolve and submit as per estimated completion date. ";
            }
            if (statusId == 34)
            {
                explaination = "QC has rejected the batch. So we are doing synthesis again and we will try to complete the synthesis as per estimated completion date. ";
            }
            if (statusId == 35)
            {
                explaination = "QC has rejected the current batch, so we are doing re-treatment and we will try to complete the process as per estimated completion date. ";
            }
            if (statusId == 36)
            {
                explaination = "QC has rejected the current batch, so we are doing re-synthesis and we will try to complete the process as per estimated completion date. ";
            }
            if (statusId == 37)
            {
                explaination = "QC has rejected the current batch, so we are doing re-purification and we will try to complete the process as per estimated completion date. ";
            }
            if (statusId == 38)
            {
                explaination = "Product is available now and processed for dispatch. ";
            }
            if (statusId == 39)
            {
                explaination = "We have shared the data for approval and we will dispatch the product after your confirmation.";
            }
            if (statusId == 40)
            {
                explaination = "We have received your query and we will resolve after then we will share the revised data for approval. ";
            }
            if (statusId == 41)
            {
                explaination = "Data has been approved and we will dispatch as per estimated completion date.  ";
            }
            if (statusId == 42)
            {
                explaination = "We have shared the Invoice for approval and we will dispatch the product after your confirmation.";
            }
            if (statusId == 43)
            {
                explaination = "Our Account team will communicate further regarding dispatch.";
            }
            if (statusId == 44)
            {
                explaination = "Our Account team will communicate further regarding dispatch.";
            }
            if (statusId == 45)
            {
                explaination = "Our Account team will communicate further regarding dispatch.";
            }
            if (statusId == 46)
            {
                explaination = "Product is cancelled/on hold as per instruction.";
            }

            return explaination;
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult UpdateScientistProductInfoForHold(int? scStatus, int id)
        {
            var data = _operationRepository.GetQuoteDetailByID(id);
            if (data != null)
            {
                data.ScientistStatus = scStatus;
                data.IsHoldManually = true;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json("", JsonRequestBehavior.AllowGet);
        }



        [HttpPost]
        public ActionResult SetProjectOnHold(int id)
        {
            var data = _operationRepository.GetQuoteDetailByID(id);
            if (data != null)
            {
                data.ReviewSciStatus = Convert.ToString((int)EnumList.ProStatusDDL.HoldAndCancelled);
                data.DispatchStatus = Convert.ToString((int)EnumList.ProStatusDDL.HoldAndCancelled);
                data.ProStatus = Convert.ToString((int)EnumList.ProStatusDDL.HoldAndCancelled);
                data.OtherProStatus = Convert.ToString((int)EnumList.ProStatusDDL.HoldAndCancelled);
                data.ExplainationSecond = "Product is cancelled/on hold as per instruction.";
                data.ProjectStatus = (int)EnumList.ProjectStatus.Hold;
                data.IsOnHold = true;
                data.OnHoldDate = DateTime.Now;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json("", JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public ActionResult SetProjectOnResume(int id)
        {
            var data = _operationRepository.GetQuoteDetailByID(id);
            if (data != null)
            {
                data.ProjectStatus = (int)EnumList.ProjectStatus.NoAction;
                data.IsOnHold = false;
                data.OnHoldDate = null;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json("", JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public ActionResult UploadedOnServer(int id, string catno, string casno)
        {
            catno = catno.Trim();
            var product = db.Products.Where(x => x.Sku == catno).FirstOrDefault();
            if (product == null)
                return Json("noproduct", JsonRequestBehavior.AllowGet);

            var data = _operationRepository.GetQuoteDetailByID(id);
            if (data != null)
            {
                data.CATNo = catno;
                data.CASNo = casno;
                data.ProductId = product.Id;
                data.IsUploadServer = true;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json("", JsonRequestBehavior.AllowGet);
        }


        [HttpPost]
        public ActionResult SubmittedUploadProduct(List<int> id)
        {
            foreach (var item in id)
            {
                var data = _operationRepository.GetQuoteDetailByID(item);
                if (data != null)
                {
                    data.IsForceUpload = false;
                    db.Entry(data).State = EntityState.Modified;
                }
            }

            db.SaveChanges();

            return Json(new
            {
                success = true,
                message = "Product upload submitted"
            }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult UpdateInvoiceInformation(InvoiceInformationModel model)
        {
            var data = _operationRepository.GetQuoteDetailByID(model.id);
            if (data != null)
            {
                if (string.IsNullOrEmpty(data.TrackingNo) && !string.IsNullOrEmpty(model.tracking))
                {
                    data.TrackingNoDate = DateTime.Now;
                    data.InvoicedDate = DateTime.Now;
                }
                data.PaymentStatus = model.paymentStatus;
                data.InvoiceNo = model.invoiceno;
                data.Courier = model.courier;
                data.TrackingNo = model.tracking;
                data.Location = model.location;
                data.RefName = model.refno;
                data.PurposeDispatch = model.purposeofdispatch;
                data.DeliveryStatus = model.deliverystatus;
                data.DataPending = model.datapending;
                if (!string.IsNullOrEmpty(model.deliverydate))
                {
                    data.DeliveryDate = Convert.ToDateTime(model.deliverydate);
                }
                data.Remark = model.remark;
                db.Entry(data).State = EntityState.Modified;

                if (!string.IsNullOrEmpty(model.paymentStatus) && model.paymentStatus == "Paid")
                {
                    var chkdata = db.SZ_QuotationDetail.Where(x => x.InvoiceNo == model.invoiceno).ToList();
                    if (chkdata != null && chkdata.Count > 0)
                    {
                        foreach (var item in chkdata)
                        {
                            item.PaymentStatus = "Paid";
                            db.Entry(item).State = EntityState.Modified;
                        }
                    }
                }
                db.SaveChanges();
            }
            return Json("", JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult HideQuoteDetail(List<int> id)
        {
            try
            {
                foreach (var item in id)
                {
                    var data = _operationRepository.GetQuoteDetailByID(item);
                    if (data != null)
                    {
                        data.IsQuoteHide = true;
                        db.Entry(data).State = EntityState.Modified;
                        db.SaveChanges();
                    }

                }

                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { success = true, message = "Hide successfully.." }
                };
            }
            catch (Exception ex)
            {
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { success = false, message = ex.Message }
                };
            }
        }


        [HttpPost]
        [ValidateInput(false)]
        public ActionResult MovetoDispatch(int id)
        {
            try
            {
                var data = _operationRepository.GetQuoteDetailByID(id);
                if (data != null)
                {
                    data.ProjectStatus = (int)EnumList.ProjectStatus.MoveToDispatch;
                    data.ProcessState = (int)EnumList.ProcessState.MoveToDispatch;
                    db.Entry(data).State = EntityState.Modified;
                    db.SaveChanges();
                }

                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { success = true, message = "Moved successfully.." }
                };
            }
            catch (Exception ex)
            {
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { success = false, message = ex.Message }
                };
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult SaveDeliveredDispatch(int id, string additionalBatch, string coa = null)
        {
            try
            {
                var data = _operationRepository.GetQuoteDetailByID(id);
                if (data != null)
                {
                    var oldMOdel = LogManagement.PrepareQuoteDetailEntity(data);
                    if (!string.IsNullOrEmpty(additionalBatch))
                    {
                        data.AdditionalBatchNo = Convert.ToInt32(additionalBatch);
                        var invData = db.SZ_Inventory.Where(x => x.Id == data.AdditionalBatchNo).FirstOrDefault();
                        if (invData != null)
                        {
                            data.InvoiceBatchNo = invData.BatchNo;
                            data.BatchNo = invData.BatchNo;
                        }
                    }
                    else
                    {
                        data.AdditionalBatchNo = null;
                    }
                    if (!string.IsNullOrEmpty(coa))
                    {
                        data.COAId = Convert.ToInt32(coa);
                        data.COARefNumber = db.SZ_ChildCOA.Where(x => x.Id == data.COAId).Select(x => x.RefNo).FirstOrDefault();
                    }
                    else
                    {
                        data.COAId = null;
                        data.COARefNumber = "";
                    }

                    db.Entry(data).State = EntityState.Modified;
                    db.SaveChanges();

                    LogManagement.AddDispatchLog(data, oldMOdel);
                }

                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { success = true, message = "Moved successfully.." }
                };
            }
            catch (Exception ex)
            {
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { success = false, message = ex.Message }
                };
            }
        }


        [HttpPost]
        [ValidateInput(false)]
        public ActionResult SaveDispatchAll(int id, string additionalBatch, string reason = null, string esticompleteDate = null, string coa = null, string dispatchstatus = null)
        {
            try
            {
                var data = _operationRepository.GetQuoteDetailByID(id);
                if (data != null)
                {
                    var oldModel = LogManagement.PrepareQuoteDetailEntity(data);
                    var inventoryData = db.SZ_Inventory.Where(x => x.Id == data.AdditionalBatchNo).FirstOrDefault();
                    if (inventoryData != null)
                    {
                        data.ApprovalComment = inventoryData.QCRemark;
                    }

                    if (!string.IsNullOrEmpty(esticompleteDate))
                    {
                        data.EstimateCompleteDate = Convert.ToDateTime(esticompleteDate);
                    }
                    else
                    {
                        data.EstimateCompleteDate = null;
                    }
                    data.Reason = reason;
                    if (!string.IsNullOrEmpty(additionalBatch))
                    {
                        data.AdditionalBatchNo = Convert.ToInt32(additionalBatch);
                    }
                    else
                    {
                        data.AdditionalBatchNo = null;
                    }

                    if (!string.IsNullOrEmpty(coa))
                    {
                        data.COAId = Convert.ToInt32(coa);
                        data.COARefNumber = db.SZ_ChildCOA.Where(x => x.Id == data.COAId).Select(x => x.RefNo).FirstOrDefault();
                    }
                    else
                    {
                        data.COAId = null;
                        data.COARefNumber = "";
                    }
                    data.DispatchStatus = dispatchstatus;
                    data.ProStatus = dispatchstatus;
                    data.OtherProStatus = dispatchstatus;
                    data.LastExplainationSecond = data.ExplainationSecond;
                    data.ExplainationSecond = GetSecondaryExplaination(dispatchstatus);
                    if (data.DispatchStatus == Convert.ToString((int)EnumList.DispatchStatusDDl.QCApproval))
                    {
                        data.ApprovalStatus = Convert.ToString((int)EnumList.ApprovedStatus.QCApproval);
                        data.QcApprovalDate = DateTime.Now;

                        if (inventoryData != null && !inventoryData.ApprovalDate.HasValue)
                        {
                            inventoryData.ApprovalDate = DateTime.Now;
                            db.Entry(inventoryData).State = EntityState.Modified;
                        }
                    }
                    if (data.DispatchStatus == Convert.ToString((int)EnumList.DispatchStatusDDl.ReadyforDispatch))
                    {
                        data.IsDispatchApprove = true;
                    }
                    db.Entry(data).State = EntityState.Modified;
                    db.SaveChanges();

                    LogManagement.AddDispatchLog(data, oldModel);
                }

                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { success = true, message = "Moved successfully.." }
                };
            }
            catch (Exception ex)
            {
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { success = false, message = ex.Message }
                };
            }
        }
        [HttpPost]
        [ValidateInput(false)]
        public ActionResult ChangeDispatchStatus(DispatchDataModel model)
        {
            int id = model.id;
            int status = model.status;
            string additionalBatch = model.additionalBatch;
            int? sortQty = model.sortQty;
            string batchNo = model.batchNo;
            string remark = model.remark;
            string reason = model.reason;
            string coa = model.coa;
            string orderremark = model.orderremark;
            string tabname = model.tabname;
            try
            {
                bool isSortQty = false;
                int newQty = 0;
                if (status == (int)EnumList.DispatchStatus.SortQty)
                {
                    isSortQty = true;
                }
                var data = _operationRepository.GetQuoteDetailByID(id);
                if (data != null)
                {
                    var oldModel = LogManagement.PrepareQuoteDetailEntity(data);
                    if (tabname == "all")
                    {
                        data.Reason = reason;
                        data.OrderRemark = orderremark;
                    }
                    if (tabname == "list")
                    {
                        data.Reason = reason;
                    }
                    else
                    {
                        data.Remark = remark;
                        data.OrderRemark = orderremark;
                    }
                    data.BatchNo = batchNo;
                    data.DispatchedStatus = status;

                    if (oldModel.DispatchedStatus == (int)EnumList.DispatchStatus.Packed && status != (int)EnumList.DispatchStatus.Packed)
                    {
                        // Credit Inventory
                        var inv = db.SZ_Inventory.Where(x => x.Id == data.AdditionalBatchNo).FirstOrDefault();
                        if (inv != null)
                        {
                            // Deduct Inventory
                            SZ_InventoryLog objlog = new SZ_InventoryLog();
                            objlog.CreatedDate = DateTime.Now;
                            objlog.InventoryId = inv.Id;
                            objlog.CurrentQty = Convert.ToString(inv.Qty + Convert.ToDecimal(data.RequiredQty));
                            objlog.PreviousQty = Convert.ToString(inv.Qty);
                            objlog.PoNumber = data.SZ_Quotation.PONo;
                            objlog.Reason = "Cancelled Pack and credit Qty";
                            objlog.UserId = SessionCookieManagement.UserId;
                            objlog.UserName = SessionCookieManagement.UserName;
                            db.Entry(objlog).State = EntityState.Added;

                            inv.Qty = inv.Qty + Convert.ToDecimal(data.RequiredQty);
                            db.Entry(inv).State = EntityState.Modified;

                        }
                    }
                    if (status == (int)EnumList.DispatchStatus.Packed && oldModel.DispatchedStatus != (int)EnumList.DispatchStatus.Packed)
                    {
                        var inv = db.SZ_Inventory.Where(x => x.Id == data.AdditionalBatchNo).FirstOrDefault();
                        if (inv != null)
                        {
                            // Deduct Inventory
                            SZ_InventoryLog objlog = new SZ_InventoryLog();
                            objlog.CreatedDate = DateTime.Now;
                            objlog.InventoryId = inv.Id;
                            objlog.CurrentQty = Convert.ToString(inv.Qty - Convert.ToDecimal(data.RequiredQty));
                            objlog.PreviousQty = Convert.ToString(inv.Qty);
                            objlog.PoNumber = data.SZ_Quotation.PONo;
                            objlog.Reason = "Regular Dispatched";
                            objlog.UserId = SessionCookieManagement.UserId;
                            objlog.UserName = SessionCookieManagement.UserName;
                            db.Entry(objlog).State = EntityState.Added;
                            inv.Qty = inv.Qty - Convert.ToDecimal(data.RequiredQty);
                            db.Entry(inv).State = EntityState.Modified;
                        }
                    }


                    if (!string.IsNullOrEmpty(additionalBatch))
                    {
                        data.AdditionalBatchNo = Convert.ToInt32(additionalBatch);
                    }
                    else
                    {
                        data.AdditionalBatchNo = null;
                    }
                    if (!string.IsNullOrEmpty(coa))
                    {
                        data.COAId = Convert.ToInt32(coa);
                        data.COARefNumber = db.SZ_ChildCOA.Where(x => x.Id == data.COAId).Select(x => x.RefNo).FirstOrDefault();
                    }
                    else
                    {
                        data.COARefNumber = null;
                        data.COAId = null;
                    }
                    if (isSortQty)
                    {
                        if (sortQty.HasValue)
                        {
                            int orignalqty = Convert.ToInt32(data.RequiredQty);

                            newQty = Convert.ToInt32(data.RequiredQty) - sortQty.Value;
                            data.RequiredQty = Convert.ToString(newQty);
                            data.DispatchedStatus = (int)EnumList.DispatchStatus.Unpacked;

                            SZ_QuotationDetail objquoteDetails = new SZ_QuotationDetail();
                            objquoteDetails.QuoteId = data.QuoteId;
                            objquoteDetails.ProductId = data.ProductId;
                            objquoteDetails.ProductName = data.ProductName;
                            objquoteDetails.CASNo = data.CASNo;
                            objquoteDetails.ImagePath = data.ImagePath;
                            objquoteDetails.Price = data.Price;
                            objquoteDetails.LeadTime = data.LeadTime;
                            objquoteDetails.IsUploadServer = data.IsUploadServer;
                            objquoteDetails.CreatedDate = DateTime.Now;
                            objquoteDetails.CATNo = data.CATNo;
                            objquoteDetails.DisplayOrder = data.DisplayOrder;
                            objquoteDetails.ProjectType = data.ProjectType;
                            objquoteDetails.ScientistCustomerId = data.ScientistCustomerId;
                            objquoteDetails.ProjectStatus = (int)EnumList.ProjectStatus.NoAction;
                            objquoteDetails.ScientistStatus = data.ScientistStatus;
                            objquoteDetails.BatchCode1 = data.BatchCode1;
                            objquoteDetails.Qty1 = data.Qty1;
                            objquoteDetails.BatchCode2 = data.BatchCode2;
                            objquoteDetails.Qty2 = data.Qty2;
                            objquoteDetails.Courier = data.Courier;
                            objquoteDetails.TrackingNo = data.TrackingNo;
                            objquoteDetails.Location = data.Location;
                            objquoteDetails.RefName = data.RefName;
                            objquoteDetails.PurposeDispatch = data.PurposeDispatch;
                            objquoteDetails.DeliveryDate = data.DeliveryDate;
                            objquoteDetails.DispatchedStatus = (int)EnumList.DispatchStatus.SortQty;
                            objquoteDetails.ProcessState = (int)EnumList.ProcessState.MoveToProject;
                            objquoteDetails.PackDate = null;
                            objquoteDetails.DeliveryStatus = data.DeliveryStatus;
                            objquoteDetails.DataPending = data.DataPending;
                            objquoteDetails.TrackingNoDate = null;
                            objquoteDetails.EstimateCompleteDate = data.EstimateCompleteDate;
                            objquoteDetails.MoveToProject = data.MoveToProject;
                            objquoteDetails.MoveProjectDate = data.MoveProjectDate;
                            objquoteDetails.MoveDispatchDate = null;
                            objquoteDetails.MoveToDispatch = false;
                            objquoteDetails.ProjectType = null;
                            objquoteDetails.MoveToScientistDate = null;
                            objquoteDetails.BatchNo = data.BatchNo;
                            objquoteDetails.AdditionalBatchNo = data.AdditionalBatchNo;
                            objquoteDetails.Remark = data.Remark;
                            objquoteDetails.MoveToInvoice = null;
                            objquoteDetails.AdminScientistStatus = null;
                            objquoteDetails.ActivityStatus = "Short Qty Dispatched";
                            var quotedetailsPO = db.SZ_QuotationDetail.Where(x => x.QuoteId == data.QuoteId).Max(x => x.SrPo);
                            int srPo = 0;
                            if (quotedetailsPO != null && quotedetailsPO != 0 && quotedetailsPO.HasValue)
                            {
                                srPo = quotedetailsPO.Value + 1;
                            }
                            else
                            {
                                srPo = 1;
                            }
                            objquoteDetails.SrPo = srPo;
                            objquoteDetails.InvoiceRemark = null;
                            objquoteDetails.InvoiceNo = null;
                            objquoteDetails.PaymentStatus = data.PaymentStatus;
                            objquoteDetails.RequiredQty = Convert.ToString(sortQty.Value);
                            objquoteDetails.Reason = data.Reason;
                            db.SZ_QuotationDetail.Add(objquoteDetails);
                            db.SaveChanges();

                            string html = System.IO.File.ReadAllText(Server.MapPath("~/Mail/ShortQtyDispatched.html")); MailMessage mail = new MailMessage();
                            ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12 |
                                               SecurityProtocolType.Tls11 |
                                               SecurityProtocolType.Tls |
                                               SecurityProtocolType.Ssl3;
                            SmtpClient SmtpServer = new SmtpClient(ConfigurationManager.AppSettings["Email.Host"]);
                            mail.From = new MailAddress(ConfigurationManager.AppSettings["Email.Username"], "SynZeal Standards");
                            var isDevelopment = ConfigurationManager.AppSettings["IsDevelopment"];
                            if (isDevelopment.ToLower().Contains("true"))
                            {
                                mail.To.Add(ConfigurationManager.AppSettings["DevEmailAddress"].ToString());
                            }
                            else
                            {
                                mail.To.Add("projects@synzeal.com");
                            }
                            mail.Subject = "Short Qty Dispatched Product : PO # " + objquoteDetails.SZ_Quotation.PONo + " / CAT # " + objquoteDetails.CATNo;

                            html = html.Replace("#username", SessionCookieManagement.UserName);
                            html = html.Replace("#quoteref", data.SZ_Quotation.Ref);
                            html = html.Replace("#po", data.SZ_Quotation.PONo);
                            html = html.Replace("#productname", data.ProductName);
                            html = html.Replace("#catno", data.CATNo);
                            html = html.Replace("#casno", data.CASNo);
                            html = html.Replace("#orignalreqqty", Convert.ToString(orignalqty));
                            html = html.Replace("#newqty", Convert.ToString(newQty));
                            mail.Body = html;
                            mail.IsBodyHtml = true;
                            SmtpServer.Port = Convert.ToInt32(ConfigurationManager.AppSettings["Port"]);
                            SmtpServer.Credentials = new System.Net.NetworkCredential(ConfigurationManager.AppSettings["Email.Username"], ConfigurationManager.AppSettings["Email.Password"]);
                            SmtpServer.EnableSsl = true;
                            SmtpServer.Send(mail);
                        }
                    }

                    db.Entry(data).State = EntityState.Modified;
                    db.SaveChanges();

                    LogManagement.AddDispatchLog(data, oldModel);
                }

                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { success = true, message = "Moved successfully.." }
                };
            }
            catch (Exception ex)
            {
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { success = false, message = ex.Message }
                };
            }
        }


        [HttpPost]
        [ValidateInput(false)]
        public ActionResult RejectApproveProductDetail(int id)
        {
            try
            {
                var data = _operationRepository.GetQuoteDetailByID(id);
                if (data != null)
                {
                    data.IsDispatchApprove = false;
                    db.Entry(data).State = EntityState.Modified;
                    db.SaveChanges();
                }

                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { success = true, message = "Moved successfully.." }
                };
            }
            catch (Exception ex)
            {
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { success = false, message = ex.Message }
                };
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult ApproveProductDetail(int id)
        {
            try
            {
                var data = _operationRepository.GetQuoteDetailByID(id);
                if (data != null)
                {
                    data.IsDispatchApprove = true;
                    db.Entry(data).State = EntityState.Modified;
                    db.SaveChanges();
                }

                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { success = true, message = "Moved successfully.." }
                };
            }
            catch (Exception ex)
            {
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { success = false, message = ex.Message }
                };
            }
        }


        [HttpPost]
        [ValidateInput(false)]
        public ActionResult ReverseStatus(int id, string status, string activitystatus)
        {
            try
            {
                var data = _operationRepository.GetQuoteDetailByID(id);
                if (data != null)
                {
                    if (status == "project")
                    {
                        data.MoveToProject = true;
                        data.MoveToDispatch = null;
                        data.MoveDispatchDate = null;
                        data.DispatchedStatus = null;
                        data.ProcessState = (int)EnumList.ProcessState.MoveToProject;
                        data.ProjectStatus = (int)EnumList.ProjectStatus.NoAction;
                        data.ProjectType = null;
                        data.Reason = activitystatus;


                        try
                        {
                            string html = System.IO.File.ReadAllText(Server.MapPath("~/Mail/ReverseProduct.html")); MailMessage mail = new MailMessage();
                            ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12 |
                                               SecurityProtocolType.Tls11 |
                                               SecurityProtocolType.Tls |
                                               SecurityProtocolType.Ssl3;
                            SmtpClient SmtpServer = new SmtpClient(ConfigurationManager.AppSettings["Email.Host"]);
                            mail.From = new MailAddress(ConfigurationManager.AppSettings["Email.Username"], "SynZeal Standards");
                            var isDevelopment = ConfigurationManager.AppSettings["IsDevelopment"];
                            if (isDevelopment.ToLower().Contains("true"))
                            {
                                mail.To.Add(ConfigurationManager.AppSettings["DevEmailAddress"].ToString());
                            }
                            else
                            {
                                mail.To.Add("projects@synzeal.com");
                            }
                            mail.Subject = "Return Product : PO # " + data.SZ_Quotation.PONo + " / CAT # " + data.CATNo;

                            html = html.Replace("#username", SessionCookieManagement.UserName);
                            html = html.Replace("#quoteref", data.SZ_Quotation.Ref);
                            html = html.Replace("#po", data.SZ_Quotation.PONo);
                            html = html.Replace("#productname", data.ProductName);
                            html = html.Replace("#catno", data.CATNo);
                            html = html.Replace("#casno", data.CASNo);

                            mail.Body = html;
                            mail.IsBodyHtml = true;
                            SmtpServer.Port = Convert.ToInt32(ConfigurationManager.AppSettings["Port"]);
                            SmtpServer.Credentials = new System.Net.NetworkCredential(ConfigurationManager.AppSettings["Email.Username"], ConfigurationManager.AppSettings["Email.Password"]);
                            SmtpServer.EnableSsl = true;
                            SmtpServer.Send(mail);
                        }
                        catch (Exception ex)
                        {
                            sendErrorMail(ex.LineNumber() + " " + "Error Text : " + ex.Message + " / Stack Trace : " + ex.StackTrace);
                        }

                    }
                    db.Entry(data).State = EntityState.Modified;
                    db.SaveChanges();
                }

                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { success = true, message = "Moved successfully.." }
                };
            }
            catch (Exception ex)
            {
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { success = false, message = ex.Message }
                };
            }
        }

        public ActionResult SubmitForm(int id, int formid = 0, bool isprint = false, bool isdispatch = false, bool isnewform = false, bool newprodumastr = false)
        {
            if (!SessionCookieManagement.IsGLP && !SessionCookieManagement.IsAdmin && !SessionCookieManagement.IsProject && !SessionCookieManagement.IsDispatch && !SessionCookieManagement.IsScientist && !SessionCookieManagement.IsSubScientist)
            {
                return RedirectToAction("Index", "Home");
            }

            ViewBag.NewProductMaster = newprodumastr;
            ViewBag.QuotationDetailsId = id;
            ViewBag.FormId = formid;
            var model = _operationRepository.GetQuoteDetailByID(id);
            if (!isnewform)
            {
                var formdata = db.SZ_QuoteDetailForm.Where(x => x.Id == formid).FirstOrDefault();
                ViewBag.FormData = formdata;
                ViewBag.IsPrint = isprint;
                ViewBag.Isdispatch = isdispatch;
                ViewBag.QuoteDetailsComment = db.SZ_QuoteDetailsComment.Where(x => x.QuotationDetailsId == id).OrderBy(x => x.CreatedDate).ToList();
                if (formdata != null)
                {
                    ViewBag.islockForm = db.SZ_Inventory.Where(x => x.BatchNo.Trim().ToLower() == formdata.BatchCode.Trim().ToLower()).Any();
                }
            }

            var listItems = new List<SelectListItem>();
            MemoryCacheManager objCache = new MemoryCacheManager();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });

            var scienList = objCache.Get("cache.GetScientistId", () =>
            {
                return db.GetScientistId().ToList();
            });

            var subscienList = objCache.Get("cache.subscienList", () =>
            {
                return db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();
            });
            scienList.ForEach(term =>
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                listItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.ToString()
                });
            });

            foreach (var term in subscienList)
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == term.Id).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }

                listItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.Id.ToString()
                });

            }
            if (!string.IsNullOrEmpty(model.SubScientistName))
            {
                var subsci = System.Text.RegularExpressions.Regex.IsMatch(model.SubScientistName, @"\d+");
                if (subsci)
                {
                    if (System.Text.RegularExpressions.Regex.Match(model.SubScientistName, @"\d+").Value == model.SubScientistName)
                    {
                        var subsciids = Convert.ToInt32(model.SubScientistName);
                        foreach (var r in listItems)
                        {
                            string selected = string.Empty;
                            if (r.Value == Convert.ToString(subsciids))
                            {
                                model.SubScientistName = r.Text;
                            }
                        }
                    }
                }
            }

            return View(model);
        }

        public ActionResult ViewForm(int id)
        {
            if (!SessionCookieManagement.IsScientist && !SessionCookieManagement.IsSubScientist)
            {
                return RedirectToAction("Index", "Home");
            }

            ViewBag.ProcessId = id;
            ViewBag.ProductName = db.SZ_QuotationDetail.Where(x => x.Id == id).Select(x => x.ProductName).FirstOrDefault();
            var formid = db.SZ_QuoteDetails_Form.Where(x => x.QuoteDetailsId == id).Select(x => x.FormId).FirstOrDefault();
            var catno = db.SZ_QuotationDetail.Where(x => x.Id == id).Select(x => x.CATNo).FirstOrDefault();
            catno = catno.ToLower().Trim();
            var model = db.SZ_QuoteDetailForm.Where(x => x.CATNo.Trim().ToLower() == catno).ToList();
            return View(model);
        }


        public string filenameDateWise(string filename)
        {
            string format = "Mddyyyyhhmmss";
            string date = DateTime.Now.ToString(format);

            return filename + "_" + date;
        }

        public FileModel SaveFileByName(string fileuploadname, string batchcode = "")
        {
            HttpPostedFileBase file = Request.Files[fileuploadname];
            string fname;
            string extension = Path.GetExtension(file.FileName);
            string newfname = Guid.NewGuid().ToString() + "_" + filenameDateWise(fileuploadname) + "" + extension;
            fname = Path.Combine(Server.MapPath("~/Content/NewProducts/"), newfname);
            file.SaveAs(fname);

            string path = filenameDateWise(fileuploadname + "_" + batchcode) + "" + extension;
            if (!string.IsNullOrEmpty(batchcode))
            {
                Aws.Upload(path, file.InputStream);
                //path = "https://synzeal-quotation.s3.amazonaws.com/" + path;
            }

            return new FileModel()
            {
                AWSPath = "https://synzeal-quotation.s3.amazonaws.com/" + path,
                LocalPath = "../Content/NewProducts/" + newfname
            };

            //return path;
            //return "../Content/NewProducts/" + newfname;
        }

        public ActionResult GetPDFFromId(int id)
        {
            string path = string.Empty;
            var data = db.SZ_QuoteDetailForm.Where(x => x.Id == id).FirstOrDefault();
            if (data != null)
            {
                // var htmlstring = PartialViewdata(this, "_PartialSubmittionFormPdf", data);
                var htmlstring = PartialViewdata(this, "_PartialSubmittionFormPdf", data);
                path = printpdf(htmlstring, "testcoa-" + data.Id.ToString() + "_" + DateTime.Now.ToString().Replace(":", "_").Replace(" ", "_").Replace("/", "_"));
            }
            return Content(path);
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult SubmitSOPData(FormCollection form)
        {
            var model = new SZ_SOP();
            model.DepartmentName = form.Get("DepartmentName");
            model.FileName = form.Get("FileName");
            if (Request.Files.Count > 0)
            {
                if (Request.Files["FilePath"] != null)
                {
                    model.FilePath = SaveFileByName("FilePath", model.FileName).AWSPath;
                }
            }
            model.CreatedDate = DateTime.Now;
            model.CreatedBy = SessionCookieManagement.UserName;
            db.SZ_SOP.Add(model);
            db.SaveChanges();
            return Json(true, JsonRequestBehavior.AllowGet);
        }


        [HttpPost]
        [ValidateInput(false)]
        public ActionResult SubmitAvailableDataForm(FormCollection form, string radiorbTypeCompound)
        {
            try
            {
                int frmId = 0;
                string formId = form.Get("formId");
                string submissionDate = form.Get("SubmissionDate");
                string catelogueNo = form.Get("CatelogueNo");
                string projectName = form.Get("ProjectName");
                string CASNo = form.Get("CASNo");
                string productName = form.Get("ProductName");
                string NameOfScientist = form.Get("NameOfScientist");
                string BatchCode = form.Get("BatchCode");
                string NMRCodeStatus = form.Get("NMRCodeStatus");
                string JournalDate = form.Get("JournalDate");
                string DatePurity = form.Get("DatePurity");
                string MoleWeight = form.Get("MoleWeight");
                string CodeESIAPCI = form.Get("CodeESIAPCI");
                string MolecularFormula = form.Get("MolecularFormula");
                string AnalysisCode = form.Get("AnalysisCode");
                string rbTypeCompound = form.Get("radiorbTypeCompound") != "undefined" ? form.Get("radiorbTypeCompound") : null;
                string rbStateOfCompound = form.Get("radiorbStateOfCompound") != "undefined" ? form.Get("radiorbStateOfCompound") : null;
                string rbSaltMentionName = form.Get("radiorbSaltMentionName") != "undefined" ? form.Get("radiorbSaltMentionName") : null;
                string radiorbAdditionalAnalysis = form.Get("radiorbAdditionalAnalysis") != "undefined" ? form.Get("radiorbAdditionalAnalysis") : null;
                string SaltName = form.Get("SaltName");
                string DrawStructureHere = form.Get("DrawStructureHere");
                string QuantitySubmitted = form.Get("QuantitySubmitted");
                string AppearanceOtherRemarks = form.Get("AppearanceOtherRemarks");
                string NameSignofScientist = form.Get("NameSignofScientist");
                string NameSignofTeamLeader = form.Get("NameSignofTeamLeader");
                string SignofQualityAssuranceDept = form.Get("SignofQualityAssuranceDept");
                string NameSignOfReviewerwithDate = form.Get("NameSignOfReviewerwithDate");
                string SignofDocDepartment = form.Get("SignofDocDepartment");
                int QuotationDetailsId = Convert.ToInt32(form.Get("QuotationDetailsId"));
                string chkHygroscopic = form.Get("chkHygroscopic");
                string TLName = form.Get("TLName");
                string HPLCDate = form.Get("HPLCDate");
                string HPLCPurity = form.Get("HPLCPurity");
                string Error = form.Get("Error");
                string imagePath = form.Get("detFromDBImage");
                string molecularFormula = form.Get("MolecularFormula");
                string Chemist = form.Get("Chemist");
                string SolutionForm = form.Get("radioSolutionForm") != "undefined" ? form.Get("radioSolutionForm") : null;
                string SolidForm = form.Get("radioSolidForm") != "undefined" ? form.Get("radioSolidForm") : null;
                string State = form.Get("ddlState");
                string radioEarlierSynthesized = form.Get("radioEarlierSynthesized") != "undefined" ? form.Get("radioEarlierSynthesized") : null;
                string NoOfFinalStep = form.Get("NoOfFinalStep");
                string PurificationBy = form.Get("PurificationBy");
                string spectralDataAttachment = string.Empty;
                var IRAttachment = new FileModel();
                var MassAttachment = new FileModel();
                var PLCAttachment = new FileModel();
                var NMRAttchment = new FileModel();
                var QNMRAttchment = new FileModel();
                var TGAAttachment = new FileModel();
                var CMRAttchment = new FileModel();
                var DEPTAttachment = new FileModel();
                var HRMSAttachment = new FileModel();
                var ROIAttachment = new FileModel();
                var ElementralAttachment = new FileModel();
                var SERAttachment = new FileModel();
                var GCAttachment = new FileModel();
                var ELSDAttachment = new FileModel();
                var ChiralAttachmenrt = new FileModel();
                var chkNMRDone = form.Get("chkNMRDone");
                var chkCrystallizationDone = form.Get("chkCrystallizationDone");
                if (formId != null && formId != "0")
                {
                    int fId = Convert.ToInt32(formId);
                    frmId = fId;
                    SZ_QuoteDetailForm objForm = db.SZ_QuoteDetailForm.Where(x => x.Id == fId).FirstOrDefault();
                    if (objForm != null)
                    {
                        if (Request.Files.Count > 0)
                        {
                            if (Request.Files["IRAttachment"] != null)
                            {
                                IRAttachment = SaveFileByName("IRAttachment", BatchCode);
                                objForm.IRAttachment = IRAttachment.AWSPath;
                            }
                            if (Request.Files["MassAttachment"] != null)
                            {
                                MassAttachment = SaveFileByName("MassAttachment", BatchCode);
                                objForm.MassAttachment = MassAttachment.AWSPath;
                            }
                            if (Request.Files["PLCAttachment"] != null)
                            {
                                PLCAttachment = SaveFileByName("PLCAttachment", BatchCode);
                                objForm.PLCAttachment = PLCAttachment.AWSPath;
                            }
                            if (Request.Files["NMRAttchment"] != null)
                            {
                                NMRAttchment = SaveFileByName("NMRAttchment", BatchCode);
                                objForm.NMRAttchment = NMRAttchment.AWSPath;
                            }
                            if (Request.Files["QNMRAttchment"] != null)
                            {
                                QNMRAttchment = SaveFileByName("QNMRAttchment", BatchCode);
                                objForm.QNMRAttchment = QNMRAttchment.AWSPath;
                            }
                            if (Request.Files["TGAAttachment"] != null)
                            {
                                TGAAttachment = SaveFileByName("TGAAttachment", BatchCode);
                                objForm.TGAAttachment = TGAAttachment.AWSPath;
                            }
                            if (Request.Files["CMRAttchment"] != null)
                            {
                                CMRAttchment = SaveFileByName("CMRAttchment", BatchCode);
                                objForm.CMRAttchment = CMRAttchment.AWSPath;
                            }
                            if (Request.Files["DEPTAttachment"] != null)
                            {
                                DEPTAttachment = SaveFileByName("DEPTAttachment", BatchCode);
                                objForm.DEPTAttachment = DEPTAttachment.AWSPath;
                            }
                            if (Request.Files["HRMSAttachment"] != null)
                            {
                                HRMSAttachment = SaveFileByName("HRMSAttachment", BatchCode);
                                objForm.HRMSAttachment = HRMSAttachment.AWSPath;
                            }
                            if (Request.Files["ROIAttachment"] != null)
                            {
                                ROIAttachment = SaveFileByName("ROIAttachment", BatchCode);
                                objForm.ROIAttachment = ROIAttachment.AWSPath;
                            }
                            if (Request.Files["ElementralAttachment"] != null)
                            {
                                ElementralAttachment = SaveFileByName("ElementralAttachment", BatchCode);
                                objForm.ElementralAttachment = ElementralAttachment.AWSPath;
                            }
                            if (Request.Files["SERAttachment"] != null)
                            {
                                SERAttachment = SaveFileByName("SERAttachment", BatchCode);
                                objForm.SERAttachment = SERAttachment.AWSPath;
                            }
                            if (Request.Files["GCAttachment"] != null)
                            {
                                GCAttachment = SaveFileByName("GCAttachment", BatchCode);
                                objForm.GCAttachment = GCAttachment.AWSPath;
                            }
                            if (Request.Files["ELSDAttachment"] != null)
                            {
                                ELSDAttachment = SaveFileByName("ELSDAttachment", BatchCode);
                                objForm.ELSDAttachment = ELSDAttachment.AWSPath;
                            }
                            if (Request.Files["ChiralAttachmenrt"] != null)
                            {
                                ChiralAttachmenrt = SaveFileByName("ChiralAttachmenrt", BatchCode);
                                objForm.ChiralAttachmenrt = ChiralAttachmenrt.AWSPath;
                            }
                        }

                        string oldBatchNo = objForm.BatchCode;

                        objForm.RbAdditionalAnalysis = radiorbAdditionalAnalysis;
                        db.Entry(objForm).State = EntityState.Modified;
                        db.SaveChanges();
                    }
                    else
                    {
                        return new JsonResult()
                        {
                            JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                            Data = new { success = false, message = "Sorry!!! No Data found for update." }
                        };
                    }
                }


                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { success = true, formId = frmId, message = "Form created Successfully." }
                };
            }
            catch (Exception ex)
            {
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { success = false, message = ex.Message.ToString() }
                };
            }
        }

        public ActionResult GetAttachmentByBatchNo(string batchNo)
        {
            if (batchNo.Contains("("))
            {
                int index = batchNo.IndexOf("(");
                batchNo = batchNo.Substring(0, index).Trim();
            }
            var attachment = db.SZ_QuoteDetailForm.AsNoTracking().Where(x => x.BatchCode == batchNo).Select(x => x.RbAdditionalAnalysis).FirstOrDefault();
            return Json(attachment, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult GenerateCataloguePDF(FormCollection form)
        {
            var HeaderAttachment = new FileModel();
            var FooterAttachment = new FileModel();
            List<string> fileArray = new List<string>();
            if (Request.Files.Count > 0)
            {
                if (Request.Files["Header"] != null)
                {
                    HeaderAttachment = SaveFileByName("Header");
                    fileArray.Add(HeaderAttachment.LocalPath);
                }
            }

            string returnFilePath = string.Empty;
            var products = new List<ExportCatalogueModel>();
            var productData = db.Products.Where(x => x.Deleted == false && x.Published == true).AsNoTracking().AsQueryable();
            string api = string.Empty;
            var apiIds = new List<int>();
            if (Request.Form["API"] != null)
            {
                api = Convert.ToString(Request.Form["API"]);

                var strapiIds = api.Split(',');
                if (strapiIds != null && strapiIds.Length > 0)
                {
                    foreach (var apiid in strapiIds)
                    {
                        if (!string.IsNullOrEmpty(apiid))
                        {
                            apiIds.Add(Convert.ToInt32(apiid));
                        }
                    }
                }
            }
            if (!string.IsNullOrEmpty(api))
            {
                productData = productData.Where(x => x.MainCatId.HasValue && apiIds.Contains(x.MainCatId.Value)).AsQueryable();
            }

            if (Request.Form["dlabelled"] == "true")
            {
                productData = productData.Where(x => x.Sku != null && x.Sku.Substring(3, (x.Sku.Length - 3)).ToLower().Contains("d")).AsQueryable();
            }
            if (Request.Form["Nitroso"] == "true")
            {
                productData = productData.Where(x => x.Name.Trim().ToLower().Contains("nitroso")).AsQueryable();
            }

            var pdatas = productData.AsEnumerable();

            var pItemData = productData.Where(x => x.Published == true && x.Deleted == false).AsEnumerable();
            if (pItemData != null && pItemData.Count() > 0)
            {
                pItemData.ForEach(pitem =>
                {
                    ExportCatalogueModel objModel = new ExportCatalogueModel();
                    objModel.CategoryName = pitem.MainCatName;
                    objModel.ProductName = pitem.Name;
                    objModel.InventoryStatus = pitem.ProductInstockStatus;
                    objModel.MolF = pitem.Gtin;
                    objModel.MolW = pitem.MolecularWeight;
                    objModel.Synonym = pitem.Synonym;
                    objModel.ImagePath = pitem.ImagePath;
                    objModel.CATNo = pitem.Sku;
                    objModel.CASNo = pitem.ManufacturerPartNumber;
                    products.Add(objModel);
                });

                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " / 27813 Pitemdara : " + pItemData.Count());

            }


            returnFilePath = CreateExportCataloguePDF(products);

            fileArray.Add(returnFilePath);
            if (Request.Files.Count > 0)
            {
                if (Request.Files["Footer"] != null)
                {
                    FooterAttachment = SaveFileByName("Footer");
                    fileArray.Add(FooterAttachment.LocalPath);
                }
            }
            if (fileArray != null && fileArray.Count == 1)
            {
                return Json(new { returnFilePath = returnFilePath });
            }

            string specdatafilename = filenameDateWise(Guid.NewGuid().ToString()) + ".pdf";
            string outputPdfPath = Server.MapPath("~/Content/NewProducts/" + specdatafilename);
            var output = new FileStream(outputPdfPath, FileMode.Create);
            PdfReader reader = null;
            Document sourceDocument = null;
            PdfCopy pdfCopyProvider = null;
            PdfImportedPage importedPage;
            sourceDocument = new Document();
            pdfCopyProvider = new PdfCopy(sourceDocument, output);
            //output file Open  
            sourceDocument.Open();
            foreach (var item in fileArray)
            {
                var fPath = Server.MapPath(item.Replace("..", "~"));
                int pages = Common.TotalPageCount(fPath);

                reader = new PdfReader(fPath);
                //Add pages in new file  
                for (int i = 1; i <= pages; i++)
                {
                    try
                    {
                        importedPage = pdfCopyProvider.GetImportedPage(reader, i);
                        pdfCopyProvider.AddPage(importedPage);
                    }
                    catch (Exception ex)
                    {
                        continue;
                    }
                }
                reader.Close();
            }
            sourceDocument.Close();
            return Json(new { returnFilePath = "../content/NewProducts/" + specdatafilename });
        }


        [HttpPost]
        [ValidateInput(false)]
        public ActionResult GenerateCatalogueExcel(FormCollection form)
        {
            var HeaderAttachment = new FileModel();
            var FooterAttachment = new FileModel();
            List<string> fileArray = new List<string>();
            if (Request.Files.Count > 0)
            {
                if (Request.Files["Header"] != null)
                {
                    HeaderAttachment = SaveFileByName("Header");
                    fileArray.Add(HeaderAttachment.LocalPath);
                }
            }

            string returnFilePath = string.Empty;
            var products = new List<ExportCatalogueExcelModel>();
            var productData = db.Products.Where(x => x.Deleted == false && x.Published == true).AsNoTracking().AsQueryable();
            string api = string.Empty;
            var apiIds = new List<int>();
            if (Request.Form["API"] != null)
            {
                api = Convert.ToString(Request.Form["API"]);

                var strapiIds = api.Split(',');
                if (strapiIds != null && strapiIds.Length > 0)
                {
                    foreach (var apiid in strapiIds)
                    {
                        if (!string.IsNullOrEmpty(apiid))
                        {
                            apiIds.Add(Convert.ToInt32(apiid));
                        }
                    }
                }
            }
            if (!string.IsNullOrEmpty(api))
            {
                productData = productData.Where(x => x.MainCatId.HasValue && apiIds.Contains(x.MainCatId.Value)).AsQueryable();
            }

            if (Request.Form["dlabelled"] == "true")
            {
                productData = productData.Where(x => x.Sku != null && x.Sku.Substring(3, (x.Sku.Length - 3)).ToLower().Contains("d")).AsQueryable();
            }
            if (Request.Form["Nitroso"] == "true")
            {
                productData = productData.Where(x => x.Name.Trim().ToLower().Contains("nitroso")).AsQueryable();
            }

            var pdatas = productData.AsEnumerable();

            var pItemData = productData.Where(x => x.Published == true && x.Deleted == false).AsEnumerable();
            if (pItemData != null && pItemData.Count() > 0)
            {
                pItemData.ForEach(pitem =>
                {
                    ExportCatalogueExcelModel objModel = new ExportCatalogueExcelModel();
                    objModel.CategoryName = pitem.MainCatName;
                    objModel.ProductName = pitem.Name;
                    objModel.InventoryStatus = pitem.ProductInstockStatus;
                    objModel.MolF = pitem.Gtin;
                    objModel.MolW = pitem.MolecularWeight;
                    objModel.Synonym = pitem.Synonym;
                    objModel.CATNo = pitem.Sku;
                    objModel.CASNo = pitem.ManufacturerPartNumber;
                    objModel.ImagePath = pitem.ImagePath;
                    products.Add(objModel);
                });

                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " / 27813 Pitemdara : " + pItemData.Count());

            }

            returnFilePath = CreateExportCatalogueExcel(products);

            fileArray.Add(returnFilePath);
            if (Request.Files.Count > 0)
            {
                if (Request.Files["Footer"] != null)
                {
                    FooterAttachment = SaveFileByName("Footer");
                    fileArray.Add(FooterAttachment.LocalPath);
                }
            }
            if (fileArray != null && fileArray.Count == 1)
            {
                return Json(new { returnFilePath = returnFilePath });
            }

            string specdatafilename = filenameDateWise(Guid.NewGuid().ToString()) + ".pdf";
            string outputPdfPath = Server.MapPath("~/Content/NewProducts/" + specdatafilename);
            var output = new FileStream(outputPdfPath, FileMode.Create);
            PdfReader reader = null;
            Document sourceDocument = null;
            PdfCopy pdfCopyProvider = null;
            PdfImportedPage importedPage;
            sourceDocument = new Document();
            pdfCopyProvider = new PdfCopy(sourceDocument, output);
            //output file Open  
            sourceDocument.Open();
            foreach (var item in fileArray)
            {
                var fPath = Server.MapPath(item.Replace("..", "~"));
                int pages = Common.TotalPageCount(fPath);

                reader = new PdfReader(fPath);
                //Add pages in new file  
                for (int i = 1; i <= pages; i++)
                {
                    try
                    {
                        importedPage = pdfCopyProvider.GetImportedPage(reader, i);
                        pdfCopyProvider.AddPage(importedPage);
                    }
                    catch (Exception ex)
                    {
                        continue;
                    }
                }
                reader.Close();
            }
            sourceDocument.Close();
            return Json(new { returnFilePath = "../content/NewProducts/" + specdatafilename });
        }
        private iTextSharp.text.Font fontTinyItalic = FontFactory.GetFont("Calibri", 7, iTextSharp.text.Font.NORMAL, BaseColor.BLACK);
        private iTextSharp.text.Font fontbold = FontFactory.GetFont("Calibri", 7, iTextSharp.text.Font.BOLD, BaseColor.BLACK);
        private iTextSharp.text.Font fontTinyItalicColor = FontFactory.GetFont("Calibri", 7, iTextSharp.text.Font.NORMAL, iTextSharp.text.html.WebColors.GetRGBColor("#125c88"));
        private iTextSharp.text.Font fontboldColor = FontFactory.GetFont("Calibri", 7, iTextSharp.text.Font.BOLD, iTextSharp.text.html.WebColors.GetRGBColor("#125c88"));

        private iTextSharp.text.Font fontTinyBold = FontFactory.GetFont("Calibri", 9, iTextSharp.text.Font.BOLD, BaseColor.BLACK);

        private string CreateExportCataloguePDF(List<ExportCatalogueModel> products)
        {
            string fileName = string.Empty;
            DateTime fileCreationDatetime = DateTime.Now;
            fileName = string.Format("{0}.pdf", "catalogue_" + fileCreationDatetime.ToString(@"yyyyMMdd") + "_" + fileCreationDatetime.ToString(@"HHmmss"));
            string pdfPath = Server.MapPath("~/Content/Quotation/") + fileName;
            string returnpath = "/Content/Quotation/" + fileName;
            using (FileStream msReport = new FileStream(pdfPath, FileMode.Create))
            {
                //step 1
                using (Document pdfDoc = new Document(PageSize.A4, 0f, 0f, 78f, 25f))
                {
                    try
                    {
                        // step 2

                        PdfWriter pdfWriter = PdfWriter.GetInstance(pdfDoc, msReport);
                        pdfWriter.PageEvent = new ITextEvents(products.Select(x => x.CategoryName).FirstOrDefault());

                        //open the stream 
                        pdfDoc.Open();
                        pdfDoc.SetMargins(0, 0, 78f, 25f);
                        int loop = 1;

                        System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " / 27900 ProductCount : " + products.Count);
                        if (products != null && products.Count > 0)
                        {
                            var categorynameList = products.Select(x => x.CategoryName).Distinct().OrderBy(x => x).ToList();
                            var categoryCount = categorynameList.Count;
                            var pageloopcount = 1;
                            var prevcategoryname = categorynameList.FirstOrDefault();

                            System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " / 27908 CategoryCount : " + categorynameList.Count + " / ProductCount : " + products.Count);
                            pageloopcount += 1;

                            PdfPTable table = new PdfPTable(5);
                            table.WidthPercentage = 96;
                            float[] widths = new float[] { 1f, 10f, 5f, 4f, 4f };
                            table.SetWidths(widths);
                            table.HorizontalAlignment = 1;

                            foreach (var item in products.OrderBy(x => x.CATNo))
                            {
                                PdfPCell cell6 = new PdfPCell();
                                cell6.HorizontalAlignment = Element.ALIGN_CENTER;
                                cell6.VerticalAlignment = Element.ALIGN_MIDDLE;
                                cell6.Phrase = new Phrase(loop.ToString(), fontTinyItalic);
                                table.AddCell(cell6);

                                Phrase protextphase = new Phrase();
                                protextphase.Add(new Chunk(item.ProductName, fontbold));
                                protextphase.Add(new Chunk("\n", fontTinyItalic));
                                if (!string.IsNullOrEmpty(item.Synonym))
                                {
                                    protextphase.Add(new Chunk("Synonym: ", fontbold));
                                    protextphase.Add(new Chunk(item.Synonym, fontTinyItalic));
                                    protextphase.Add(new Chunk("\n", fontTinyItalic));
                                }

                                protextphase.Add(new Chunk("Mol.F.: ", fontbold));
                                protextphase.Add(new Chunk(item.MolF, fontTinyItalic));
                                protextphase.Add(new Chunk(", Mol.Wt.: ", fontbold));
                                protextphase.Add(new Chunk(item.MolW, fontTinyItalic));
                                protextphase.Add(new Chunk("\n", fontTinyItalic));
                                protextphase.Add(new Chunk("Inventory Status: ", fontboldColor));
                                protextphase.Add(new Chunk(item.InventoryStatus, fontTinyItalicColor));

                                PdfPCell cellpro = new PdfPCell();
                                cellpro.HorizontalAlignment = Element.ALIGN_LEFT;
                                cellpro.SetLeading(1f, 2f);
                                cellpro.Phrase = protextphase;
                                table.AddCell(cellpro);

                                if (!string.IsNullOrEmpty(item.ImagePath))
                                {
                                    try
                                    {
                                        PdfPCell cellimage = new PdfPCell();
                                        //var ipath = item.ImagePath.Replace("https://www.synzeal.com/", "D:/Plesk/Vhosts/synzeal.com/httpdocs/");
                                        //   iTextSharp.text.Image jpg = iTextSharp.text.Image.GetInstance(ipath);
                                        iTextSharp.text.Image jpg = iTextSharp.text.pdf.codec.PngImage.GetImage(item.ImagePath);
                                        jpg.ScaleToFit(120f, 155.25f);

                                        //var byteimage = Common.ImageToByteArray(System.Drawing.Image.FromFile(ipath));
                                        //iTextSharp.text.Image jpg = iTextSharp.text.Image.GetInstance(byteimage);
                                        //jpg.ScaleToFit(120f, 155.25f);

                                        PdfPCell imageCell = new PdfPCell(jpg, true);
                                        imageCell.Colspan = 1; // either 1 if you need to insert one cell
                                        imageCell.HorizontalAlignment = Element.ALIGN_CENTER;
                                        imageCell.VerticalAlignment = Element.ALIGN_MIDDLE;
                                        imageCell.PaddingRight = 20f;
                                        table.AddCell(imageCell);

                                        //PdfPCell cellimage = new PdfPCell();
                                        //iTextSharp.text.Image jpg = iTextSharp.text.Image.GetInstance(new Uri(item.ImagePath));
                                        //jpg.ScaleToFit(120f, 155.25f);
                                        //PdfPCell imageCell = new PdfPCell(jpg);
                                        //imageCell.Colspan = 1; // either 1 if you need to insert one cell
                                        //imageCell.HorizontalAlignment = Element.ALIGN_CENTER;
                                        //imageCell.VerticalAlignment = Element.ALIGN_MIDDLE;
                                        //imageCell.PaddingRight = 20f;
                                        //table.AddCell(imageCell);
                                    }
                                    catch (Exception ex)
                                    {
                                        PdfPCell cell22 = new PdfPCell();
                                        cell22.HorizontalAlignment = Element.ALIGN_CENTER;
                                        cell22.VerticalAlignment = Element.ALIGN_MIDDLE;
                                        cell22.Phrase = new Phrase("", fontTinyItalic);
                                        table.AddCell(cell22);
                                    }
                                    finally
                                    {

                                    }
                                }
                                else
                                {
                                    table.AddCell(new PdfPCell());
                                }
                                PdfPCell cell7 = new PdfPCell();
                                cell7.HorizontalAlignment = Element.ALIGN_CENTER;
                                cell7.VerticalAlignment = Element.ALIGN_MIDDLE;
                                cell7.Phrase = new Phrase(item.CASNo, fontTinyItalic);
                                table.AddCell(cell7);

                                PdfPCell cell8 = new PdfPCell();
                                cell8.HorizontalAlignment = Element.ALIGN_CENTER;
                                cell8.VerticalAlignment = Element.ALIGN_MIDDLE;
                                cell8.Phrase = new Phrase(item.CATNo, fontTinyItalic);
                                table.AddCell(cell8);

                                loop += 1;
                            }
                            pdfDoc.Add(table);
                        }

                        pdfDoc.Close();
                    }
                    catch (Exception ex)
                    {
                        //handle exception
                        System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " / Error Export : " + ex.Message + " / Stack : " + ex.StackTrace);

                    }
                    finally
                    {
                    }
                }
            }

            return returnpath;
        }

        private string CreateExportCatalogueExcel(List<ExportCatalogueExcelModel> products)
        {
            System.Web.UI.WebControls.GridView gv = new System.Web.UI.WebControls.GridView();
            gv.DataSource = products;
            gv.DataBind();
            Response.ClearContent();
            Response.Buffer = true;
            Response.AddHeader("content-disposition", "attachment; filename=RecentAddition" + DateTime.Now.Year + DateTime.Now.ToString("MM") + DateTime.Now.ToString("dd") + ".xls");
            Response.ContentType = "application/ms-excel";
            Response.Charset = "";
            StringWriter sw = new StringWriter();
            HtmlTextWriter htw = new HtmlTextWriter(sw);
            gv.RenderControl(htw);
            string passstr = sw.ToString().Replace(" 00:00:00", "");
            string filePath = Server.MapPath("~/Content/ExportExcel/");
            string fileName = "ExportCatalogue_" + DateTime.Now.Year + DateTime.Now.ToString("MM") + DateTime.Now.ToString("dd") + ".xls";

            // Write the rendered content to a file.
            System.IO.File.WriteAllText(filePath + fileName, passstr);

            return "../Content/ExportExcel/" + fileName;
        }

        public ActionResult ExportAllProducts()
        {
            var products = db.Products.Where(x => x.Published == true && x.Deleted == false).OrderBy(x => x.Sku.Trim()).ToList();
            ExcelPackage ExcelPkg = new ExcelPackage();
            ExcelWorksheet wsSheet1 = ExcelPkg.Workbook.Worksheets.Add("Sheet1");
            wsSheet1.DefaultColWidth = 16;
            wsSheet1.Protection.IsProtected = false;
            wsSheet1.Protection.AllowSelectLockedCells = false;
            wsSheet1.Cells.AutoFitColumns(14, 40);
            wsSheet1.Column(3).Width = 40;
            wsSheet1.Column(3).Style.WrapText = true;

            int loopCount = 2;
            wsSheet1.Cells[loopCount, 1].Value = "Sr No";
            wsSheet1.Cells[loopCount, 2].Value = "Product Name";
            wsSheet1.Cells[loopCount, 3].Value = "CAT No";
            wsSheet1.Cells[loopCount, 4].Value = "CAS No";
            wsSheet1.Cells[loopCount, 5].Value = "Inventory Status";
            using (ExcelRange Rng = wsSheet1.Cells[loopCount, 1, loopCount, 5])
            {
                Rng.Style.Font.Bold = true;
                Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#7b7b7b");
                Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                Rng.Style.Font.Color.SetColor(Color.White);
                Rng.Style.WrapText = true;
            }

            loopCount = loopCount + 1;
            int srno = 1;
            foreach (var quote in products)
            {
                wsSheet1.Cells[loopCount, 1].Value = srno;
                wsSheet1.Cells[loopCount, 2].Value = quote.Name;
                wsSheet1.Cells[loopCount, 3].Value = quote.Sku;
                wsSheet1.Cells[loopCount, 4].Value = quote.ManufacturerPartNumber;
                wsSheet1.Cells[loopCount, 5].Value = quote.ProductInstockStatus;
                srno += 1;
                loopCount += 1;
            }
            string filePath = HostingEnvironment.MapPath("~/Content/Quotation/") + "AllProductReport-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xlsx";
            ExcelPkg.SaveAs(new FileInfo(filePath));
            return File(filePath, "application/excel", Server.UrlEncode("AllProductReport-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xls"));
        }

        //var model = (from i in products
        //                 select new ExportAllProductModel()
        //                 {
        //                     CASNo = i.ManufacturerPartNumber,
        //                     CATNo = i.Sku,
        //                     InventoryStatus = i.ProductInstockStatus,
        //                     ProductName = i.Name
        //                 }).OrderBy(x=>x.CATNo).ToList();

        //    var filePath = CreateExportAllProductExcel(model);
        //    filePath = HostingEnvironment.MapPath(filePath.Replace("..", "~"));

        //    return File(filePath, "application/excel", Server.UrlEncode("AllProducts-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xls"));
        //  }

        private string CreateExportAllProductExcel(List<ExportAllProductModel> products)
        {
            System.Web.UI.WebControls.GridView gv = new System.Web.UI.WebControls.GridView();
            gv.DataSource = products;
            gv.DataBind();
            Response.ClearContent();
            Response.Buffer = true;
            Response.AddHeader("content-disposition", "attachment; filename=RecentAddition" + DateTime.Now.Year + DateTime.Now.ToString("MM") + DateTime.Now.ToString("dd") + ".xls");
            Response.ContentType = "application/ms-excel";
            Response.Charset = "";
            StringWriter sw = new StringWriter();
            HtmlTextWriter htw = new HtmlTextWriter(sw);
            gv.RenderControl(htw);
            string passstr = sw.ToString().Replace(" 00:00:00", "");
            string filePath = Server.MapPath("~/Content/ExportExcel/");
            string fileName = "ExportCatalogue_" + DateTime.Now.Year + DateTime.Now.ToString("MM") + DateTime.Now.ToString("dd") + ".xls";

            // Write the rendered content to a file.
            System.IO.File.WriteAllText(filePath + fileName, passstr);

            return "../Content/ExportExcel/" + fileName;
        }


        public string GetProductImage(int productId)
        {
            string path = string.Empty;
            string uri = Domain + "/api/RestAPI/GetProductImage?productId=" + productId;
            using (HttpClient httpClient = new HttpClient())
            {
                Task<String> response = httpClient.GetStringAsync(uri);
                path = JsonConvert.DeserializeObject<string>(response.Result);
            }
            return path;
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult SubmitForm(FormCollection form, string radiorbTypeCompound)
        {
            try
            {
                //Email send to QC team
                MailMessage mail = new MailMessage();
                int frmId = 0;
                string formId = form.Get("QuotationDetailsFormId");
                string submissionDate = form.Get("SubmissionDate");
                string catelogueNo = form.Get("CatelogueNo");
                string projectName = form.Get("ProjectName");
                string CASNo = form.Get("CASNo");
                string productName = form.Get("ProductName");
                string NameOfScientist = form.Get("NameOfScientist");
                string BatchCode = form.Get("BatchCode");
                string NMRCodeStatus = form.Get("NMRCodeStatus");
                string JournalDate = form.Get("JournalDate");
                string DatePurity = form.Get("DatePurity");
                string MoleWeight = form.Get("MoleWeight");
                string CodeESIAPCI = form.Get("CodeESIAPCI");
                string MolecularFormula = form.Get("MolecularFormula");
                string AnalysisCode = form.Get("AnalysisCode");
                string rbTypeCompound = form.Get("radiorbTypeCompound") != "undefined" ? form.Get("radiorbTypeCompound") : null;
                string rbStateOfCompound = form.Get("radiorbStateOfCompound") != "undefined" ? form.Get("radiorbStateOfCompound") : null;
                string rbSaltMentionName = form.Get("radiorbSaltMentionName") != "undefined" ? form.Get("radiorbSaltMentionName") : null;
                string radiorbAdditionalAnalysis = form.Get("radiorbAdditionalAnalysis") != "undefined" ? form.Get("radiorbAdditionalAnalysis") : null;
                string SaltName = form.Get("SaltName");
                string DrawStructureHere = form.Get("DrawStructureHere");
                string QuantitySubmitted = form.Get("QuantitySubmitted");
                string AppearanceOtherRemarks = form.Get("AppearanceOtherRemarks");
                string NameSignofScientist = form.Get("NameSignofScientist");
                string NameSignofTeamLeader = form.Get("NameSignofTeamLeader");
                string SignofQualityAssuranceDept = form.Get("SignofQualityAssuranceDept");
                string NameSignOfReviewerwithDate = form.Get("NameSignOfReviewerwithDate");
                string SignofDocDepartment = form.Get("SignofDocDepartment");
                int QuotationDetailsId = Convert.ToInt32(form.Get("QuotationDetailsId"));
                string chkHygroscopic = form.Get("chkHygroscopic");
                string PurificationBy = form.Get("PurificationBy");
                string TLName = form.Get("TLName");
                string HPLCDate = form.Get("HPLCDate");
                string HPLCPurity = form.Get("HPLCPurity");
                string Error = form.Get("Error");
                string imagePath = form.Get("detFromDBImage");
                string molecularFormula = form.Get("MolecularFormula");
                string Chemist = form.Get("Chemist");
                string SolutionForm = form.Get("radioSolutionForm") != "undefined" ? form.Get("radioSolutionForm") : null;
                string SolidForm = form.Get("radioSolidForm") != "undefined" ? form.Get("radioSolidForm") : null;
                string State = form.Get("ddlState");
                string radioEarlierSynthesized = form.Get("radioEarlierSynthesized") != "undefined" ? form.Get("radioEarlierSynthesized") : null;
                string NoOfFinalStep = form.Get("NoOfFinalStep");
                string Photostability = form.Get("Photostability");
                string ELNReceiptNumber = form.Get("ELNReceiptNumber");
                var spectralDataAttachment = new FileModel();
                var IRAttachment = new FileModel();
                var MassAttachment = new FileModel();
                var PLCAttachment = new FileModel();
                var NMRAttchment = new FileModel();
                var QNMRAttchment = new FileModel();
                var TGAAttachment = new FileModel();
                var CMRAttchment = new FileModel();
                var DEPTAttachment = new FileModel();
                var HRMSAttachment = new FileModel();
                var ROIAttachment = new FileModel();
                var ElementralAttachment = new FileModel();
                var SERAttachment = new FileModel();
                var GCAttachment = new FileModel();
                var ELSDAttachment = new FileModel();
                var ChiralAttachmenrt = new FileModel();
                var UVSpectraAttachment = new FileModel();
                var OtherAnalysisAttachment = new FileModel();
                var N1NMRAttachment = new FileModel();
                var ChiralHPLCAttachment = new FileModel();
                var IsotropicpurityAttachment = new FileModel();
                var TwoDNMRAttachment = new FileModel();
                var LCMSAttachment = new FileModel();
                var COSYAttachment = new FileModel();
                var CHNSAttachment = new FileModel();
                var StabilitydataAttachment = new FileModel();
                bool IsNewProductMaster = false;
                if (!string.IsNullOrEmpty(form.Get("IsNewProductMaster")))
                {
                    IsNewProductMaster = true;
                }
                string chkNMRDone = form.Get("chkNMRDone");
                string chkCrystallizationDone = form.Get("chkCrystallizationDone");
                string LightSensitivity = form.Get("LightSensitivity");
                var ChemdrawFileAttachment = new FileModel();
                var APCIMassAttachment = new FileModel();
                var WeightingSlipAttachment = new FileModel();
                var NMRInterpretaionAttachment = new FileModel();
                string TempSensitive = form.Get("TempSensitive");
                string Lacrymatory = form.Get("Lacrymatory");
                string IsLight = form.Get("IsLight");
                bool submitedFormDispatch = Convert.ToBoolean(form.Get("submitedFormDispatch"));
                string specdatafilename = filenameDateWise(Guid.NewGuid().ToString()) + ".pdf";
                string outputPdfPath = Server.MapPath("~/Content/NewProducts/" + specdatafilename);
                var output = new FileStream(outputPdfPath, FileMode.Create);

                string Isboughtout = form.Get("Isboughtout");
                string Source = form.Get("Source");
                string Reviewer = form.Get("Reviewer");
                string Approver = form.Get("Approver");
                bool IsboughtoutBool = false;
                if (Isboughtout == "true")
                {
                    IsboughtoutBool = true;
                }

                List<string> fileArray = new List<string>();
                if (Request.Files.Count > 0)
                {
                    if (Request.Files["PLCAttachment"] != null)
                    {
                        PLCAttachment = SaveFileByName("PLCAttachment", BatchCode);
                        fileArray.Add(PLCAttachment.LocalPath);
                        //var path = "";
                        //if(!PLCAttachment.Contains("s3."))
                        //{
                        //    path = Server.MapPath("~/" + PLCAttachment.Replace("..", ""));
                        //}
                        //else
                        //{
                        //    path = PLCAttachment;
                        //}
                        System.Net.Mail.Attachment attachment = new System.Net.Mail.Attachment(Server.MapPath(PLCAttachment.LocalPath.Replace("..", "~")));
                        attachment.Name = Request.Files["PLCAttachment"].FileName;
                        mail.Attachments.Add(attachment);
                    }
                    if (Request.Files["MassAttachment"] != null)
                    {
                        MassAttachment = SaveFileByName("MassAttachment", BatchCode);
                        fileArray.Add(MassAttachment.LocalPath);
                        //var path = "";
                        //if (!MassAttachment.Contains("s3."))
                        //{
                        //    path = Server.MapPath("~/" + MassAttachment.Replace("..", ""));
                        //}
                        //else
                        //{
                        //    path = MassAttachment;
                        //}
                        System.Net.Mail.Attachment attachment = new System.Net.Mail.Attachment(Server.MapPath(MassAttachment.LocalPath.Replace("..", "~")));

                        attachment.Name = Request.Files["MassAttachment"].FileName;
                        mail.Attachments.Add(attachment);
                    }
                    if (Request.Files["NMRAttchment"] != null)
                    {
                        NMRAttchment = SaveFileByName("NMRAttchment", BatchCode);
                        fileArray.Add(NMRAttchment.LocalPath);
                        //var path = "";
                        //if (!NMRAttchment.Contains("s3."))
                        //{
                        //    path = Server.MapPath("~/" + NMRAttchment.Replace("..", ""));
                        //}
                        //else
                        //{
                        //    path = NMRAttchment;
                        //}
                        System.Net.Mail.Attachment attachment = new System.Net.Mail.Attachment(Server.MapPath(NMRAttchment.LocalPath.Replace("..", "~")));
                        attachment.Name = Request.Files["NMRAttchment"].FileName;
                        mail.Attachments.Add(attachment);
                    }
                    if (Request.Files["TGAAttachment"] != null)
                    {
                        TGAAttachment = SaveFileByName("TGAAttachment", BatchCode);
                        fileArray.Add(TGAAttachment.LocalPath);
                        //var path = "";
                        //if (!TGAAttachment.Contains("s3."))
                        //{
                        //    path = Server.MapPath("~/" + TGAAttachment.Replace("..", ""));
                        //}
                        //else
                        //{
                        //    path = TGAAttachment;
                        //}
                        System.Net.Mail.Attachment attachment = new System.Net.Mail.Attachment(Server.MapPath(TGAAttachment.LocalPath.Replace("..", "~")));

                        attachment.Name = Request.Files["TGAAttachment"].FileName;
                        mail.Attachments.Add(attachment);
                    }
                    if (Request.Files["IRAttachment"] != null)
                    {
                        IRAttachment = SaveFileByName("IRAttachment", BatchCode);
                        fileArray.Add(IRAttachment.LocalPath);

                        //var path = "";
                        //if (!IRAttachment.Contains("s3."))
                        //{
                        //    path = Server.MapPath("~/" + IRAttachment.Replace("..", ""));
                        //}
                        //else
                        //{
                        //    path = IRAttachment;
                        //}
                        System.Net.Mail.Attachment attachment = new System.Net.Mail.Attachment(Server.MapPath(IRAttachment.LocalPath.Replace("..", "~")));

                        attachment.Name = Request.Files["IRAttachment"].FileName;
                        mail.Attachments.Add(attachment);
                    }
                    if (Request.Files["UVSpectra"] != null)
                    {
                        UVSpectraAttachment = SaveFileByName("UVSpectra", BatchCode);
                        fileArray.Add(UVSpectraAttachment.LocalPath);
                        //var path = "";
                        //if (!UVSpectraAttachment.Contains("s3."))
                        //{
                        //    path = Server.MapPath("~/" + UVSpectraAttachment.Replace("..", ""));
                        //}
                        //else
                        //{
                        //    path = UVSpectraAttachment;
                        //}
                        System.Net.Mail.Attachment attachment = new System.Net.Mail.Attachment(Server.MapPath(UVSpectraAttachment.LocalPath.Replace("..", "~")));

                        attachment.Name = Request.Files["UVSpectra"].FileName;
                        mail.Attachments.Add(attachment);
                    }
                    if (Request.Files["CMRAttchment"] != null)
                    {
                        CMRAttchment = SaveFileByName("CMRAttchment", BatchCode);
                        fileArray.Add(CMRAttchment.LocalPath);
                        //var path = "";
                        //if (!CMRAttchment.Contains("s3."))
                        //{
                        //    path = Server.MapPath("~/" + CMRAttchment.Replace("..", ""));
                        //}
                        //else
                        //{
                        //    path = CMRAttchment;
                        //}
                        System.Net.Mail.Attachment attachment = new System.Net.Mail.Attachment(Server.MapPath(CMRAttchment.LocalPath.Replace("..", "~")));

                        attachment.Name = Request.Files["CMRAttchment"].FileName;
                        mail.Attachments.Add(attachment);
                    }
                    if (Request.Files["QNMRAttchment"] != null)
                    {
                        QNMRAttchment = SaveFileByName("QNMRAttchment", BatchCode);
                        fileArray.Add(QNMRAttchment.LocalPath);
                        //var path = "";
                        //if (!QNMRAttchment.Contains("s3."))
                        //{
                        //    path = Server.MapPath("~/" + QNMRAttchment.Replace("..", ""));
                        //}
                        //else
                        //{
                        //    path = QNMRAttchment;
                        //}
                        System.Net.Mail.Attachment attachment = new System.Net.Mail.Attachment(Server.MapPath(QNMRAttchment.LocalPath.Replace("..", "~")));

                        attachment.Name = Request.Files["QNMRAttchment"].FileName;
                        mail.Attachments.Add(attachment);
                    }
                    if (Request.Files["OtherAnalysisAttachment"] != null)
                    {
                        OtherAnalysisAttachment = SaveFileByName("OtherAnalysisAttachment", BatchCode);
                        fileArray.Add(OtherAnalysisAttachment.LocalPath);
                        //var path = "";
                        //if (!OtherAnalysisAttachment.Contains("s3."))
                        //{
                        //    path = Server.MapPath("~/" + OtherAnalysisAttachment.Replace("..", ""));
                        //}
                        //else
                        //{
                        //    path = OtherAnalysisAttachment;
                        //}
                        System.Net.Mail.Attachment attachment = new System.Net.Mail.Attachment(Server.MapPath(OtherAnalysisAttachment.LocalPath.Replace("..", "~")));

                        attachment.Name = Request.Files["OtherAnalysisAttachment"].FileName;
                        mail.Attachments.Add(attachment);
                    }
                    if (Request.Files["DEPTAttachment"] != null)
                    {
                        DEPTAttachment = SaveFileByName("DEPTAttachment", BatchCode);
                        fileArray.Add(DEPTAttachment.LocalPath);
                        //var path = "";
                        //if (!DEPTAttachment.Contains("s3."))
                        //{
                        //    path = Server.MapPath("~/" + DEPTAttachment.Replace("..", ""));
                        //}
                        //else
                        //{
                        //    path = DEPTAttachment;
                        //}
                        System.Net.Mail.Attachment attachment = new System.Net.Mail.Attachment(Server.MapPath(DEPTAttachment.LocalPath.Replace("..", "~")));

                        attachment.Name = Request.Files["DEPTAttachment"].FileName;
                        mail.Attachments.Add(attachment);
                    }
                    if (Request.Files["HRMSAttachment"] != null)
                    {
                        HRMSAttachment = SaveFileByName("HRMSAttachment", BatchCode);
                        fileArray.Add(HRMSAttachment.LocalPath);
                        //var path = "";
                        //if (!HRMSAttachment.Contains("s3."))
                        //{
                        //    path = Server.MapPath("~/" + HRMSAttachment.Replace("..", ""));
                        //}
                        //else
                        //{
                        //    path = HRMSAttachment;
                        //}
                        System.Net.Mail.Attachment attachment = new System.Net.Mail.Attachment(Server.MapPath(HRMSAttachment.LocalPath.Replace("..", "~")));

                        attachment.Name = Request.Files["HRMSAttachment"].FileName;
                        mail.Attachments.Add(attachment);
                    }
                    if (Request.Files["ROIAttachment"] != null)
                    {
                        ROIAttachment = SaveFileByName("ROIAttachment", BatchCode);
                        fileArray.Add(ROIAttachment.LocalPath);
                        //var path = "";
                        //if (!ROIAttachment.Contains("s3."))
                        //{
                        //    path = Server.MapPath("~/" + ROIAttachment.Replace("..", ""));
                        //}
                        //else
                        //{
                        //    path = ROIAttachment;
                        //}
                        System.Net.Mail.Attachment attachment = new System.Net.Mail.Attachment(Server.MapPath(ROIAttachment.LocalPath.Replace("..", "~")));

                        attachment.Name = Request.Files["ROIAttachment"].FileName;
                        mail.Attachments.Add(attachment);
                    }
                    if (Request.Files["ElementralAttachment"] != null)
                    {
                        ElementralAttachment = SaveFileByName("ElementralAttachment", BatchCode);
                        fileArray.Add(ElementralAttachment.LocalPath);
                        //var path = "";
                        //if (!ElementralAttachment.Contains("s3."))
                        //{
                        //    path = Server.MapPath("~/" + ElementralAttachment.Replace("..", ""));
                        //}
                        //else
                        //{
                        //    path = ElementralAttachment;
                        //}
                        System.Net.Mail.Attachment attachment = new System.Net.Mail.Attachment(Server.MapPath(ElementralAttachment.LocalPath.Replace("..", "~")));

                        attachment.Name = Request.Files["ElementralAttachment"].FileName;
                        mail.Attachments.Add(attachment);
                    }
                    if (Request.Files["SERAttachment"] != null)
                    {
                        SERAttachment = SaveFileByName("SERAttachment", BatchCode);
                        fileArray.Add(SERAttachment.LocalPath);
                        //var path = "";
                        //if (!SERAttachment.Contains("s3."))
                        //{
                        //    path = Server.MapPath("~/" + SERAttachment.Replace("..", ""));
                        //}
                        //else
                        //{
                        //    path = SERAttachment;
                        //}
                        System.Net.Mail.Attachment attachment = new System.Net.Mail.Attachment(Server.MapPath(SERAttachment.LocalPath.Replace("..", "~")));

                        attachment.Name = Request.Files["SERAttachment"].FileName;
                        mail.Attachments.Add(attachment);
                    }
                    if (Request.Files["GCAttachment"] != null)
                    {
                        GCAttachment = SaveFileByName("GCAttachment", BatchCode);
                        fileArray.Add(GCAttachment.LocalPath);
                        //var path = "";
                        //if (!GCAttachment.Contains("s3."))
                        //{
                        //    path = Server.MapPath("~/" + GCAttachment.Replace("..", ""));
                        //}
                        //else
                        //{
                        //    path = GCAttachment;
                        //}
                        System.Net.Mail.Attachment attachment = new System.Net.Mail.Attachment(Server.MapPath(GCAttachment.LocalPath.Replace("..", "~")));


                        attachment.Name = Request.Files["GCAttachment"].FileName;
                        mail.Attachments.Add(attachment);
                    }
                    if (Request.Files["ELSDAttachment"] != null)
                    {
                        ELSDAttachment = SaveFileByName("ELSDAttachment", BatchCode);
                        fileArray.Add(ELSDAttachment.LocalPath);
                        //var path = "";
                        //if (!ELSDAttachment.Contains("s3."))
                        //{
                        //    path = Server.MapPath("~/" + ELSDAttachment.Replace("..", ""));
                        //}
                        //else
                        //{
                        //    path = ELSDAttachment;
                        //}
                        System.Net.Mail.Attachment attachment = new System.Net.Mail.Attachment(Server.MapPath(ELSDAttachment.LocalPath.Replace("..", "~")));
                        attachment.Name = Request.Files["ELSDAttachment"].FileName;
                        mail.Attachments.Add(attachment);
                    }
                    if (Request.Files["ChiralAttachmenrt"] != null)
                    {
                        ChiralAttachmenrt = SaveFileByName("ChiralAttachmenrt", BatchCode);
                        fileArray.Add(ChiralAttachmenrt.LocalPath);

                        //var path = "";
                        //if (!ChiralAttachmenrt.Contains("s3."))
                        //{
                        //    path = Server.MapPath("~/" + ChiralAttachmenrt.Replace("..", ""));
                        //}
                        //else
                        //{
                        //    path = ChiralAttachmenrt;
                        //}
                        System.Net.Mail.Attachment attachment = new System.Net.Mail.Attachment(Server.MapPath(ChiralAttachmenrt.LocalPath.Replace("..", "~")));

                        attachment.Name = Request.Files["ChiralAttachmenrt"].FileName;
                        mail.Attachments.Add(attachment);
                    }
                    if (Request.Files["APCIMassAttachment"] != null)
                    {
                        APCIMassAttachment = SaveFileByName("APCIMassAttachment", BatchCode);
                        fileArray.Add(APCIMassAttachment.LocalPath);

                        //var path = "";
                        //if (!APCIMassAttachment.Contains("s3."))
                        //{
                        //    path = Server.MapPath("~/" + APCIMassAttachment.Replace("..", ""));
                        //}
                        //else
                        //{
                        //    path = APCIMassAttachment;
                        //}
                        System.Net.Mail.Attachment attachment = new System.Net.Mail.Attachment(Server.MapPath(APCIMassAttachment.LocalPath.Replace("..", "~")));

                        attachment.Name = Request.Files["APCIMassAttachment"].FileName;
                        mail.Attachments.Add(attachment);
                    }
                    if (Request.Files["ChemdrawFileAttachment"] != null)
                    {
                        ChemdrawFileAttachment = SaveFileByName("ChemdrawFileAttachment", BatchCode);
                        string startPath = Server.MapPath(ChemdrawFileAttachment.LocalPath.Replace("..", "~"));
                        //var startPath = "";
                        //if (!ChemdrawFileAttachment.Contains("s3."))
                        //{
                        //    startPath = Server.MapPath("~/" + ChemdrawFileAttachment.Replace("..", ""));
                        //}
                        //else
                        //{
                        //    startPath = ChemdrawFileAttachment;
                        //}

                        string zipPath = Server.MapPath("~/Content/NewProducts/" + Guid.NewGuid().ToString() + ".zip");
                        string[] Filenames = new string[] { startPath };
                        using (ZipFile zip = new ZipFile())
                        {
                            zip.AddFiles(Filenames, "Chemdraw File");//Zip file inside filename  
                            zip.Save(zipPath);//location and name for creating zip file  
                        }
                        System.Net.Mail.Attachment attachment = new System.Net.Mail.Attachment(zipPath);
                        attachment.Name = "Chemdraw.zip";
                        mail.Attachments.Add(attachment);
                    }
                    if (Request.Files["WeightingSlipAttachment"] != null)
                    {
                        WeightingSlipAttachment = SaveFileByName("WeightingSlipAttachment", BatchCode);
                        fileArray.Add(WeightingSlipAttachment.LocalPath);

                        //var path = "";
                        //if (!WeightingSlipAttachment.Contains("s3."))
                        //{
                        //    path = Server.MapPath("~/" + WeightingSlipAttachment.Replace("..", ""));
                        //}
                        //else
                        //{
                        //    path = WeightingSlipAttachment;
                        //}
                        System.Net.Mail.Attachment attachment = new System.Net.Mail.Attachment(Server.MapPath(WeightingSlipAttachment.LocalPath.Replace("..", "~")));

                        attachment.Name = Request.Files["WeightingSlipAttachment"].FileName;
                        mail.Attachments.Add(attachment);
                    }
                    if (Request.Files["NMRInterpretaionAttachment"] != null)
                    {
                        NMRInterpretaionAttachment = SaveFileByName("NMRInterpretaionAttachment", BatchCode);
                        fileArray.Add(NMRInterpretaionAttachment.LocalPath);

                        //var path = "";
                        //if (!NMRInterpretaionAttachment.Contains("s3."))
                        //{
                        //    path = Server.MapPath("~/" + NMRInterpretaionAttachment.Replace("..", ""));
                        //}
                        //else
                        //{
                        //    path = NMRInterpretaionAttachment;
                        //}
                        System.Net.Mail.Attachment attachment = new System.Net.Mail.Attachment(Server.MapPath(NMRInterpretaionAttachment.LocalPath.Replace("..", "~")));

                        attachment.Name = Request.Files["NMRInterpretaionAttachment"].FileName;
                        mail.Attachments.Add(attachment);
                    }

                    if (Request.Files["N1NMR"] != null)
                    {
                        N1NMRAttachment = SaveFileByName("N1NMR", BatchCode);
                        fileArray.Add(N1NMRAttachment.LocalPath);

                        //var path = "";
                        //if (!N1NMRAttachment.Contains("s3."))
                        //{
                        //    path = Server.MapPath("~/" + N1NMRAttachment.Replace("..", ""));
                        //}
                        //else
                        //{
                        //    path = N1NMRAttachment;
                        //}
                        System.Net.Mail.Attachment attachment = new System.Net.Mail.Attachment(Server.MapPath(N1NMRAttachment.LocalPath.Replace("..", "~")));

                        attachment.Name = Request.Files["N1NMR"].FileName;
                        mail.Attachments.Add(attachment);
                    }


                    if (Request.Files["ChiralHPLC"] != null)
                    {
                        ChiralHPLCAttachment = SaveFileByName("ChiralHPLC", BatchCode);
                        fileArray.Add(ChiralHPLCAttachment.LocalPath);

                        //var path = "";
                        //if (!ChiralHPLCAttachment.Contains("s3."))
                        //{
                        //    path = Server.MapPath("~/" + ChiralHPLCAttachment.Replace("..", ""));
                        //}
                        //else
                        //{
                        //    path = ChiralHPLCAttachment;
                        //}
                        System.Net.Mail.Attachment attachment = new System.Net.Mail.Attachment(Server.MapPath(ChiralHPLCAttachment.LocalPath.Replace("..", "~")));

                        attachment.Name = Request.Files["ChiralHPLC"].FileName;
                        mail.Attachments.Add(attachment);
                    }
                    if (Request.Files["Isotropicpurity"] != null)
                    {
                        IsotropicpurityAttachment = SaveFileByName("Isotropicpurity", BatchCode);
                        fileArray.Add(IsotropicpurityAttachment.LocalPath);

                        //var path = "";
                        //if (!IsotropicpurityAttachment.Contains("s3."))
                        //{
                        //    path = Server.MapPath("~/" + IsotropicpurityAttachment.Replace("..", ""));
                        //}
                        //else
                        //{
                        //    path = IsotropicpurityAttachment;
                        //}
                        System.Net.Mail.Attachment attachment = new System.Net.Mail.Attachment(Server.MapPath(IsotropicpurityAttachment.LocalPath.Replace("..", "~")));

                        attachment.Name = Request.Files["Isotropicpurity"].FileName;
                        mail.Attachments.Add(attachment);
                    }
                    if (Request.Files["2DNMR"] != null)
                    {
                        TwoDNMRAttachment = SaveFileByName("2DNMR", BatchCode);
                        fileArray.Add(TwoDNMRAttachment.LocalPath);

                        //var path = "";
                        //if (!TwoDNMRAttachment.Contains("s3."))
                        //{
                        //    path = Server.MapPath("~/" + TwoDNMRAttachment.Replace("..", ""));
                        //}
                        //else
                        //{
                        //    path = TwoDNMRAttachment;
                        //}
                        System.Net.Mail.Attachment attachment = new System.Net.Mail.Attachment(Server.MapPath(TwoDNMRAttachment.LocalPath.Replace("..", "~")));

                        attachment.Name = Request.Files["2DNMR"].FileName;
                        mail.Attachments.Add(attachment);
                    }
                    if (Request.Files["COSYAttachment"] != null)
                    {
                        COSYAttachment = SaveFileByName("COSYAttachment", BatchCode);
                        fileArray.Add(COSYAttachment.LocalPath);

                        //var path = "";
                        //if (!COSYAttachment.Contains("s3."))
                        //{
                        //    path = Server.MapPath("~/" + COSYAttachment.Replace("..", ""));
                        //}
                        //else
                        //{
                        //    path = COSYAttachment;
                        //}
                        System.Net.Mail.Attachment attachment = new System.Net.Mail.Attachment(Server.MapPath(COSYAttachment.LocalPath.Replace("..", "~")));

                        attachment.Name = Request.Files["COSYAttachment"].FileName;
                        mail.Attachments.Add(attachment);
                    }
                    if (Request.Files["CHNSAttachment"] != null)
                    {
                        CHNSAttachment = SaveFileByName("CHNSAttachment", BatchCode);
                        fileArray.Add(CHNSAttachment.LocalPath);

                        //var path = "";
                        //if (!CHNSAttachment.Contains("s3."))
                        //{
                        //    path = Server.MapPath("~/" + CHNSAttachment.Replace("..", ""));
                        //}
                        //else
                        //{
                        //    path = CHNSAttachment;
                        //}
                        System.Net.Mail.Attachment attachment = new System.Net.Mail.Attachment(Server.MapPath(CHNSAttachment.LocalPath.Replace("..", "~")));

                        attachment.Name = Request.Files["CHNSAttachment"].FileName;
                        mail.Attachments.Add(attachment);
                    }
                    if (Request.Files["StabilitydataAttachment"] != null)
                    {
                        StabilitydataAttachment = SaveFileByName("StabilitydataAttachment", BatchCode);
                        fileArray.Add(StabilitydataAttachment.LocalPath);

                        //var path = "";
                        //if (!StabilitydataAttachment.Contains("s3."))
                        //{
                        //    path = Server.MapPath("~/" + StabilitydataAttachment.Replace("..", ""));
                        //}
                        //else
                        //{
                        //    path = StabilitydataAttachment;
                        //}
                        System.Net.Mail.Attachment attachment = new System.Net.Mail.Attachment(Server.MapPath(StabilitydataAttachment.LocalPath.Replace("..", "~")));

                        attachment.Name = Request.Files["StabilitydataAttachment"].FileName;
                        mail.Attachments.Add(attachment);
                    }
                    if (Request.Files["LCMSAttachment"] != null)
                    {
                        LCMSAttachment = SaveFileByName("LCMSAttachment", BatchCode);
                        fileArray.Add(LCMSAttachment.LocalPath);

                        //var path = "";
                        //if (!LCMSAttachment.Contains("s3."))
                        //{
                        //    path = Server.MapPath("~/" + LCMSAttachment.Replace("..", ""));
                        //}
                        //else
                        //{
                        //    path = LCMSAttachment;
                        //}
                        System.Net.Mail.Attachment attachment = new System.Net.Mail.Attachment(Server.MapPath(LCMSAttachment.LocalPath.Replace("..", "~")));

                        attachment.Name = Request.Files["LCMSAttachment"].FileName;
                        mail.Attachments.Add(attachment);
                    }
                }

                if (formId != null && formId != "0")
                {
                    int fId = Convert.ToInt32(formId);
                    frmId = fId;
                    SZ_QuoteDetailForm objForm = db.SZ_QuoteDetailForm.Where(x => x.Id == fId).FirstOrDefault();
                    if (objForm != null)
                    {
                        string oldBatchNo = objForm.BatchCode;

                        objForm.Isboughtout = IsboughtoutBool;
                        objForm.Source = Source;
                        objForm.Reviewer = Reviewer;
                        objForm.Approver = Approver;

                        objForm.QuotationDetailsId = QuotationDetailsId;
                        objForm.CATNo = catelogueNo.Trim();
                        objForm.CASNo = CASNo;
                        objForm.Apearance = AppearanceOtherRemarks;
                        objForm.BatchCode = BatchCode;
                        //objForm.CreatedDate = System.DateTime.Now;
                        objForm.Error = Error;
                        objForm.HPCLCode = DatePurity;
                        objForm.ProductName = productName;
                        objForm.ProjectName = projectName;
                        objForm.JournalDate = Convert.ToDateTime(JournalDate);
                        objForm.MolFormula = MolecularFormula;
                        objForm.MolWeight = MoleWeight;
                        objForm.MSCode = CodeESIAPCI;
                        objForm.NMRCode = NMRCodeStatus;
                        objForm.OtherAnalysis = AnalysisCode;
                        objForm.Qty = QuantitySubmitted;
                        objForm.SaltName = SaltName;
                        objForm.ScientistName = NameOfScientist;
                        objForm.StateCompound = rbStateOfCompound;
                        objForm.StructurePath = imagePath;
                        objForm.SubmissionDate = Convert.ToDateTime(submissionDate);
                        objForm.TypeCompound = rbTypeCompound;
                        objForm.RbSaltMentionName = rbSaltMentionName;
                        objForm.UpdatedDate = DateTime.Now;
                        objForm.SubmittedBy = SessionCookieManagement.UserId;
                        objForm.MolecularFormula = molecularFormula;
                        objForm.TLName = TLName;
                        objForm.HPLCDate = HPLCDate;
                        objForm.HPLCPurity = HPLCPurity;
                        objForm.ChkHygroscopic = Convert.ToBoolean(chkHygroscopic);
                        objForm.RbAdditionalAnalysis = radiorbAdditionalAnalysis;
                        objForm.SolidForm = SolidForm;
                        objForm.SolutionForm = SolutionForm;
                        objForm.State = State;
                        if (fileArray.Count > 0)
                        {
                            objForm.SpectralDataAttachment = spectralDataAttachment.AWSPath;
                        }
                        if (!string.IsNullOrEmpty(IRAttachment.LocalPath))
                        {
                            objForm.IRAttachment = IRAttachment.LocalPath;
                        }
                        if (!string.IsNullOrEmpty(MassAttachment.LocalPath))
                        {
                            objForm.MassAttachment = MassAttachment.LocalPath;
                        }

                        if (!string.IsNullOrEmpty(PLCAttachment.LocalPath))
                        {
                            objForm.PLCAttachment = PLCAttachment.LocalPath;
                        }

                        if (!string.IsNullOrEmpty(NMRAttchment.LocalPath))
                        {
                            objForm.NMRAttchment = NMRAttchment.LocalPath;
                        }

                        if (!string.IsNullOrEmpty(QNMRAttchment.LocalPath))
                        {
                            objForm.QNMRAttchment = QNMRAttchment.LocalPath;
                        }

                        if (!string.IsNullOrEmpty(TGAAttachment.LocalPath))
                        {
                            objForm.TGAAttachment = TGAAttachment.LocalPath;
                        }

                        if (!string.IsNullOrEmpty(CMRAttchment.LocalPath))
                        {
                            objForm.CMRAttchment = CMRAttchment.LocalPath;
                        }

                        if (!string.IsNullOrEmpty(DEPTAttachment.LocalPath))
                        {
                            objForm.DEPTAttachment = DEPTAttachment.LocalPath;
                        }

                        if (!string.IsNullOrEmpty(HRMSAttachment.LocalPath))
                        {
                            objForm.HRMSAttachment = HRMSAttachment.LocalPath;
                        }

                        if (!string.IsNullOrEmpty(ROIAttachment.LocalPath))
                        {
                            objForm.ROIAttachment = ROIAttachment.LocalPath;
                        }

                        if (!string.IsNullOrEmpty(ElementralAttachment.LocalPath))
                        {
                            objForm.ElementralAttachment = ElementralAttachment.LocalPath;
                        }

                        if (!string.IsNullOrEmpty(SERAttachment.LocalPath))
                        {
                            objForm.SERAttachment = SERAttachment.LocalPath;
                        }

                        if (!string.IsNullOrEmpty(GCAttachment.LocalPath))
                        {
                            objForm.GCAttachment = GCAttachment.LocalPath;
                        }

                        if (!string.IsNullOrEmpty(ELSDAttachment.LocalPath))
                        {
                            objForm.ELSDAttachment = ELSDAttachment.LocalPath;
                        }

                        if (!string.IsNullOrEmpty(ChiralAttachmenrt.LocalPath))
                        {
                            objForm.ChiralAttachmenrt = ChiralAttachmenrt.LocalPath;
                        }

                        if (!string.IsNullOrEmpty(ChiralHPLCAttachment.LocalPath))
                        {
                            objForm.ChiralHPLCAttachment = ChiralHPLCAttachment.LocalPath;
                        }

                        if (!string.IsNullOrEmpty(IsotropicpurityAttachment.LocalPath))
                        {
                            objForm.IsotropicpurityAttachment = IsotropicpurityAttachment.LocalPath;
                        }
                        if (!string.IsNullOrEmpty(TwoDNMRAttachment.LocalPath))
                        {
                            objForm.TwoDNMRAttachment = TwoDNMRAttachment.LocalPath;
                        }
                        if (!string.IsNullOrEmpty(N1NMRAttachment.LocalPath))
                        {
                            objForm.N1NmrAttachment = N1NMRAttachment.LocalPath;
                        }

                        if (!string.IsNullOrEmpty(NMRInterpretaionAttachment.LocalPath))
                        {
                            objForm.NMRInterpretaionAttachment = NMRInterpretaionAttachment.LocalPath;
                        }

                        if (!string.IsNullOrEmpty(APCIMassAttachment.LocalPath))
                        {
                            objForm.APCIMassAttachment = APCIMassAttachment.LocalPath;
                        }

                        if (!string.IsNullOrEmpty(COSYAttachment.LocalPath))
                        {
                            objForm.COSYAttachment = COSYAttachment.LocalPath;
                        }
                        if (!string.IsNullOrEmpty(CHNSAttachment.LocalPath))
                        {
                            objForm.CHNSAttachment = CHNSAttachment.LocalPath;
                        }
                        if (!string.IsNullOrEmpty(StabilitydataAttachment.LocalPath))
                        {
                            objForm.StabilitydataAttachment = StabilitydataAttachment.LocalPath;
                        }
                        if (!string.IsNullOrEmpty(LCMSAttachment.LocalPath))
                        {
                            objForm.LCMSAttachment = LCMSAttachment.LocalPath;
                        }
                        objForm.EarlierSynthesized = radioEarlierSynthesized;
                        objForm.NoOfFinalStep = !string.IsNullOrEmpty(NoOfFinalStep) ? Convert.ToInt32(NoOfFinalStep) : 0;
                        objForm.PurificationBy = PurificationBy;
                        objForm.Chemist = Chemist;
                        objForm.chkCrystallizationDone = Convert.ToBoolean(chkCrystallizationDone);
                        objForm.chkNMRDone = Convert.ToBoolean(chkNMRDone);
                        objForm.TempSensitive = Convert.ToBoolean(TempSensitive);
                        objForm.Lacrymatory = Convert.ToBoolean(Lacrymatory);
                        objForm.LightSensitivity = Convert.ToBoolean(LightSensitivity);
                        objForm.IsLight = Convert.ToBoolean(IsLight);
                        objForm.APCIMassAttachment = APCIMassAttachment.AWSPath;
                        objForm.ChemdrawFileAttachment = ChemdrawFileAttachment.AWSPath;
                        objForm.WeightingSlipAttachment = WeightingSlipAttachment.AWSPath;
                        objForm.NMRInterpretaionAttachment = NMRInterpretaionAttachment.AWSPath;
                        objForm.IsDispatchedEntry = submitedFormDispatch;
                        objForm.Photostability = Convert.ToBoolean(Photostability);
                        objForm.UVSpectra = UVSpectraAttachment.AWSPath;
                        objForm.OtherAnalysisAttachment = OtherAnalysisAttachment.AWSPath;
                        objForm.ELNReceiptNumber = ELNReceiptNumber;
                        var productData = db.Products.Where(x => x.Sku.Trim().ToLower() == catelogueNo.Trim().ToLower() && x.Deleted == false && x.Published == true).FirstOrDefault();
                        if (productData != null)
                        {
                            SZ_Inventory objInv = db.SZ_Inventory.Where(x => x.BatchNo.Trim().ToLower() == oldBatchNo.Trim().ToLower()).FirstOrDefault();
                            if (objInv != null)
                            {
                                objInv.ProductId = productData.Id;
                                objInv.BatchNo = BatchCode;
                                if (!string.IsNullOrEmpty(QuantitySubmitted))
                                {
                                    objInv.Qty = Convert.ToDecimal(QuantitySubmitted);
                                }
                                objInv.IsApproved = false;
                                objInv.CreatedDate = DateTime.Now;
                                objInv.Remarks = State;
                                db.Entry(objInv).State = EntityState.Modified;
                                db.SaveChanges();
                            }
                            else
                            {
                                //objInv = new SZ_Inventory();
                                //objInv.ProductId = productData.Id;
                                //objInv.BatchNo = BatchCode;
                                //if (!string.IsNullOrEmpty(QuantitySubmitted))
                                //{
                                //    objInv.Qty = Convert.ToDecimal(QuantitySubmitted);
                                //}
                                //objInv.IsApproved = false;
                                //objInv.CreatedDate = DateTime.Now;
                                //objInv.Remarks = State;
                                //db.SZ_Inventory.Add(objInv);
                                //db.SaveChanges();

                                //var data = db.SZ_QuotationDetail.Where(x => x.Id == objForm.QuotationDetailsId).FirstOrDefault();
                                //if (data != null)
                                //{
                                //    if (data.ProjectType != Convert.ToString((int)EnumList.ProjectType.InHouse))
                                //    {
                                //        if (data.ProjectType != Convert.ToString((int)EnumList.ProjectType.InStock))
                                //        {
                                //            data.Instockdate = DateTime.Now;
                                //        }
                                //        data.ProjectStatus = (int)EnumList.ProjectStatus.MoveToInstock;
                                //        data.ProjectType = Convert.ToString((int)EnumList.ProjectType.InStock);
                                //    }
                                //    if (data.ProcessState <= (int)EnumList.ProcessState.MoveToInStock)
                                //    {
                                //        data.ProcessState = (int)EnumList.ProcessState.MoveToInStock;
                                //    }
                                //    db.Entry(data).State = EntityState.Modified;
                                //}
                            }
                            db.Entry(objForm).State = EntityState.Modified;
                            db.SaveChanges();
                        }
                        else
                        {
                            return new JsonResult()
                            {
                                JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                                Data = new { success = false, message = "Sorry!!! System can not find any products from this sku. Please try again later." }
                            };
                        }
                    }
                    else
                    {
                        return new JsonResult()
                        {
                            JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                            Data = new { success = false, message = "Sorry!!! No Data found for update." }
                        };
                    }
                }
                else
                {
                    var checkBatchData =
                    (from i in this.db.SZ_Inventory
                     where i.BatchNo.Trim().ToLower() == BatchCode.Trim().ToLower()
                     select i).FirstOrDefault();
                    if (checkBatchData != null && !IsNewProductMaster)
                    {
                        return new JsonResult()
                        {
                            JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                            Data = new { success = false, message = "Batch No already available in system." }
                        };
                    }

                    int refNo = 1;
                    string value = string.Empty;
                    string matchingstring = "SZSF-" + DateTime.Now.ToString("ddMMyy") + "-";
                    var SZ_QuotationFormdata = (from i in db.SZ_QuoteDetailForm
                                                where i.Ref.StartsWith(matchingstring)
                                                select i).ToList();
                    if (SZ_QuotationFormdata.Count > 0)
                    {
                        refNo = SZ_QuotationFormdata.Select(x => ExtractFormNumber(x.Ref)).Max(w => w);
                        int newbrokerrewf = Convert.ToInt32(refNo) + 1;

                        value = "SZSF-" + DateTime.Now.ToString("ddMMyy") + "-" + newbrokerrewf.ToString().PadLeft(2, '0');
                    }
                    else
                    {
                        value = "SZSF-" + DateTime.Now.ToString("ddMMyy") + "-01";
                    }

                    SZ_QuoteDetailForm objForm = new SZ_QuoteDetailForm();
                    objForm.Isboughtout = IsboughtoutBool;
                    objForm.Source = Source;
                    objForm.Reviewer = Reviewer;
                    objForm.Approver = Approver;
                    objForm.Ref = value;
                    objForm.QuotationDetailsId = QuotationDetailsId;
                    objForm.CATNo = catelogueNo.Trim();
                    objForm.CASNo = CASNo;
                    objForm.Apearance = AppearanceOtherRemarks;
                    objForm.BatchCode = BatchCode;
                    objForm.CreatedDate = System.DateTime.Now;
                    objForm.Error = Error;
                    objForm.HPCLCode = DatePurity;
                    objForm.ProductName = productName;
                    objForm.ProjectName = projectName;
                    objForm.JournalDate = Convert.ToDateTime(JournalDate);
                    objForm.MolFormula = MolecularFormula;
                    objForm.MolWeight = MoleWeight;
                    objForm.MSCode = CodeESIAPCI;
                    objForm.NMRCode = NMRCodeStatus;
                    objForm.OtherAnalysis = AnalysisCode;
                    objForm.Qty = QuantitySubmitted;
                    objForm.SaltName = SaltName;
                    objForm.ScientistName = NameOfScientist;
                    objForm.StateCompound = rbStateOfCompound;
                    objForm.StructurePath = imagePath;
                    objForm.SubmissionDate = Convert.ToDateTime(submissionDate);
                    objForm.TypeCompound = rbTypeCompound;
                    objForm.RbSaltMentionName = rbSaltMentionName;
                    objForm.UpdatedDate = DateTime.Now;
                    objForm.SubmittedBy = SessionCookieManagement.UserId;
                    objForm.MolecularFormula = molecularFormula;
                    objForm.TLName = TLName;
                    objForm.HPLCDate = HPLCDate;
                    objForm.HPLCPurity = HPLCPurity;
                    objForm.ChkHygroscopic = Convert.ToBoolean(chkHygroscopic);
                    objForm.RbAdditionalAnalysis = radiorbAdditionalAnalysis;
                    objForm.Chemist = Chemist;
                    objForm.SolidForm = SolidForm;
                    objForm.SolutionForm = SolutionForm;
                    objForm.State = State;
                    objForm.SpectralDataAttachment = spectralDataAttachment.AWSPath;
                    objForm.IRAttachment = IRAttachment.AWSPath;
                    objForm.MassAttachment = MassAttachment.AWSPath;
                    objForm.PLCAttachment = PLCAttachment.AWSPath;
                    objForm.NMRAttchment = NMRAttchment.AWSPath;
                    objForm.QNMRAttchment = QNMRAttchment.AWSPath;
                    objForm.TGAAttachment = TGAAttachment.AWSPath;
                    objForm.CMRAttchment = CMRAttchment.AWSPath;
                    objForm.DEPTAttachment = DEPTAttachment.AWSPath;
                    objForm.HRMSAttachment = HRMSAttachment.AWSPath;
                    objForm.ROIAttachment = ROIAttachment.AWSPath;
                    objForm.ElementralAttachment = ElementralAttachment.AWSPath;
                    objForm.SERAttachment = SERAttachment.AWSPath;
                    objForm.GCAttachment = GCAttachment.AWSPath;
                    objForm.ELSDAttachment = ELSDAttachment.AWSPath;
                    objForm.ChiralAttachmenrt = ChiralAttachmenrt.AWSPath;
                    objForm.UVSpectra = UVSpectraAttachment.AWSPath;
                    objForm.OtherAnalysisAttachment = OtherAnalysisAttachment.AWSPath;
                    objForm.N1NmrAttachment = N1NMRAttachment.AWSPath;
                    objForm.ChiralHPLCAttachment = ChiralHPLCAttachment.AWSPath;
                    objForm.IsotropicpurityAttachment = IsotropicpurityAttachment.AWSPath;
                    objForm.TwoDNMRAttachment = TwoDNMRAttachment.AWSPath;
                    objForm.COSYAttachment = COSYAttachment.AWSPath;
                    objForm.CHNSAttachment = CHNSAttachment.AWSPath;
                    objForm.StabilitydataAttachment = StabilitydataAttachment.AWSPath;
                    objForm.LCMSAttachment = LCMSAttachment.AWSPath;
                    objForm.EarlierSynthesized = radioEarlierSynthesized;
                    if (!IsNewProductMaster)
                    {
                        objForm.IsDraftEntry = true;
                    }
                    else
                    {
                        objForm.IsDraftEntry = false;
                    }
                    objForm.NoOfFinalStep = !string.IsNullOrEmpty(NoOfFinalStep) ? Convert.ToInt32(NoOfFinalStep) : 0;
                    objForm.PurificationBy = PurificationBy;
                    objForm.APCIMassAttachment = APCIMassAttachment.AWSPath;
                    objForm.ChemdrawFileAttachment = ChemdrawFileAttachment.AWSPath;
                    objForm.WeightingSlipAttachment = WeightingSlipAttachment.AWSPath;
                    objForm.NMRInterpretaionAttachment = NMRInterpretaionAttachment.AWSPath;
                    objForm.chkCrystallizationDone = Convert.ToBoolean(chkCrystallizationDone);
                    objForm.chkNMRDone = Convert.ToBoolean(chkNMRDone);
                    objForm.TempSensitive = Convert.ToBoolean(TempSensitive);
                    objForm.IsLight = Convert.ToBoolean(IsLight);
                    objForm.Lacrymatory = Convert.ToBoolean(Lacrymatory);
                    objForm.IsDispatchedEntry = submitedFormDispatch;
                    objForm.LightSensitivity = Convert.ToBoolean(LightSensitivity);
                    objForm.Photostability = Convert.ToBoolean(Photostability);
                    objForm.ApprovalStatus = Convert.ToString((int)EnumList.ApprovedStatus.QCApproval);
                    objForm.ELNReceiptNumber = ELNReceiptNumber;
                    var bodyStr = "<table width='100%' border='1'>";
                    bodyStr += "<thead> <tr><th>#</th><th>Product Name</th><th>CAS No</th><th>Cat No</th><th>Product Quantity (in mg)</th><th>Batch No</th><th>Physical State</th><th>Product Colour</th><th>Data Recorded</th></tr></thead>";
                    bodyStr += "<tbody><tr><td>1</td><td>" + objForm.ProductName + "</td><td>" + objForm.CASNo + "</td><td>" + objForm.CATNo + "</td><td>" + objForm.Qty + "</td><td>" + objForm.BatchCode + "</td><td>" + objForm.State + "</td><td>" + objForm.Apearance + "</td><td>" + objForm.RbAdditionalAnalysis + "</td></tr></tbody>";
                    bodyStr += "</table>";

                    db.SZ_QuoteDetailForm.Add(objForm);
                    db.SaveChanges();

                    if (!IsNewProductMaster)
                    {
                        var szquotedetailsdata = _operationRepository.GetQuoteDetailByID(objForm.QuotationDetailsId);
                        if (szquotedetailsdata != null)
                        {
                            szquotedetailsdata.ApprovalStatus = Convert.ToString((int)EnumList.ApprovedStatus.QCApproval);
                            szquotedetailsdata.DispatchStatus = Convert.ToString((int)EnumList.DispatchStatusDDl.QCApproval);
                            szquotedetailsdata.ProStatus = Convert.ToString((int)EnumList.ProStatusDDL.QCApproval);
                            szquotedetailsdata.OtherProStatus = Convert.ToString((int)EnumList.ProStatusDDL.QCApproval);
                            szquotedetailsdata.ExplainationSecond = "Batch data is under QC approval and we will submit the batch as per estimated completion date.";
                            db.Entry(szquotedetailsdata).State = EntityState.Modified;
                        }
                    }

                    SZ_QuoteDetails_Form objdetform = new SZ_QuoteDetails_Form();
                    objdetform.CreatedDate = DateTime.Now;
                    objdetform.FormId = objForm.Id;
                    objdetform.QuoteDetailsId = objForm.QuotationDetailsId;
                    db.SZ_QuoteDetails_Form.Add(objdetform);

                    db.SaveChanges();

                    if (Request.Files.Count > 0)
                    {
                        PdfReader reader = null;
                        Document sourceDocument = null;
                        PdfCopy pdfCopyProvider = null;
                        PdfImportedPage importedPage;
                        sourceDocument = new Document();
                        pdfCopyProvider = new PdfCopy(sourceDocument, output);
                        //output file Open  
                        sourceDocument.Open();

                        var htmlstring = PartialViewdata(this, "_PartialSubmittionFormPdf", objForm);
                        var path = printpdf(htmlstring, "testcoa-" + formId.ToString() + "_" + DateTime.Now.ToString().Replace(":", "_").Replace(" ", "_").Replace("/", "_"), true);
                        fileArray.Insert(0, ".." + path);
                        System.Net.Mail.Attachment attachmentform = new System.Net.Mail.Attachment(Server.MapPath("~/" + path.Replace("..", "")));
                        attachmentform.Name = "SubmissionForm.pdf";
                        mail.Attachments.Add(attachmentform);
                        foreach (var item in fileArray)
                        {
                            var fPath = item;
                            if (!item.Contains("s3."))
                            {
                                fPath = Server.MapPath(item.Replace("..", "~"));
                            }
                            int pages = Common.TotalPageCount(fPath);

                            reader = new PdfReader(fPath);
                            //Add pages in new file  
                            for (int i = 1; i <= pages; i++)
                            {
                                try
                                {
                                    importedPage = pdfCopyProvider.GetImportedPage(reader, i);
                                    pdfCopyProvider.AddPage(importedPage);
                                }
                                catch (Exception ex)
                                {
                                    continue;
                                }
                            }
                            reader.Close();
                        }
                        sourceDocument.Close();
                        var uploadspecdata = Aws.UploadFile(Server.MapPath("~/content/NewProducts/" + specdatafilename), "spectralData_" + BatchCode + ".pdf");

                        if (uploadspecdata == true)
                        {
                            spectralDataAttachment.AWSPath = "https://synzeal-quotation.s3.amazonaws.com/spectralData_" + BatchCode + ".pdf";
                        }
                        objForm.SpectralDataAttachment = spectralDataAttachment.AWSPath;
                        db.Entry(objForm).State = EntityState.Modified;
                        db.SaveChanges();

                    }

                    ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12 |
                                       SecurityProtocolType.Tls11 |
                                       SecurityProtocolType.Tls |
                                       SecurityProtocolType.Ssl3;

                    var isDevelopment = ConfigurationManager.AppSettings["IsDevelopment"];
                    if (isDevelopment.ToLower().Contains("true"))
                    {
                        mail.To.Add(ConfigurationManager.AppSettings["DevEmailAddress"].ToString());
                    }
                    else
                    {
                        mail.To.Add("qc@synzeal.com");
                        mail.To.Add("analytical.query@synzeal.com");
                        mail.To.Add("projects@synzeal.com");
                        mail.CC.Add("standards@synzeal.com");
                    }

                    if (!string.IsNullOrEmpty(spectralDataAttachment.LocalPath))
                    {
                        mail.Attachments.Add(new Attachment(Server.MapPath("~/" + spectralDataAttachment.LocalPath.Replace("..", ""))));
                    }
                    SmtpClient SmtpServer = new SmtpClient(ConfigurationManager.AppSettings["Email.Host"]);
                    mail.From = new MailAddress(ConfigurationManager.AppSettings["Email.SynthesisUsername"], "SynZeal Standards");
                    mail.Subject = objForm.ScientistName + " - " + objForm.ProductName + " - " + objForm.CASNo + " - " + objForm.CATNo; mail.IsBodyHtml = true;
                    SmtpServer.Port = Convert.ToInt32(ConfigurationManager.AppSettings["Port"]);
                    SmtpServer.Credentials = new System.Net.NetworkCredential(ConfigurationManager.AppSettings["Email.SynthesisUsername"], ConfigurationManager.AppSettings["Email.SynthesisPassword"]);
                    mail.Body = "Dear QC Team, <br> Following product is submitted for approval. Kindly check and let us know the update. <br><br><br>";
                    mail.Body += bodyStr;
                    mail.Body += "<br><br>Let me know if you have any comments/suggestions.<br><br> <br>Kind  Regards, <br> SynZeal Research PVT. LTD";
                    SmtpServer.EnableSsl = true;
                    SmtpServer.Send(mail);

                    //Logistic email mail send
                    MailMessage logmail = new MailMessage();
                    SmtpClient logSmtpServer = new SmtpClient(ConfigurationManager.AppSettings["Email.Host"]);
                    logmail.From = new MailAddress(ConfigurationManager.AppSettings["Email.SynthesisUsername"], "SynZeal Standards");
                    logmail.Subject = objForm.ScientistName + " - " + objForm.ProductName + " - " + objForm.CASNo + " - " + objForm.CATNo;
                    logmail.IsBodyHtml = true;
                    if (isDevelopment.ToLower().Contains("true"))
                    {
                        logmail.To.Add(ConfigurationManager.AppSettings["DevEmailAddress"].ToString());
                    }
                    else
                    {
                        logmail.To.Add("logistics@synzeal.com");
                    }

                    logSmtpServer.Port = Convert.ToInt32(ConfigurationManager.AppSettings["Port"]);
                    logSmtpServer.Credentials = new System.Net.NetworkCredential(ConfigurationManager.AppSettings["Email.SynthesisUsername"], ConfigurationManager.AppSettings["Email.SynthesisPassword"]);
                    logmail.Body = "Dear QC Team, <br> Following product is submitted for approval. Kindly check and let us know the update. <br><br><br>";
                    logmail.Body += bodyStr;
                    logmail.Body += "<br><br>Let me know if you have any comments/suggestions.<br><br> <br>Kind  Regards, <br> SynZeal Research PVT. LTD";
                    logSmtpServer.EnableSsl = true;
                    logSmtpServer.Send(logmail);

                    frmId = objForm.Id;
                }

                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { success = true, formId = frmId, message = "Form created Successfully." }
                };
            }
            catch (Exception ex)
            {
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { success = false, message = ex.LineNumber() + " " + ex.Message.ToString() }
                };
            }
        }


        public static void SearchAndReplace(string document, Dictionary<string, string> dict)
        {
            using (WordprocessingDocument wordDoc = WordprocessingDocument.Open(document, true))
            {
                string docText = null;
                using (StreamReader sr = new StreamReader(wordDoc.MainDocumentPart.GetStream()))
                {
                    docText = sr.ReadToEnd();
                }

                foreach (KeyValuePair<string, string> item in dict)
                {
                    Regex regexText = new Regex(item.Key);
                    docText = regexText.Replace(docText, item.Value);
                }

                using (StreamWriter sw = new StreamWriter(
                          wordDoc.MainDocumentPart.GetStream(FileMode.Create)))
                {
                    sw.Write(docText);
                }
            }
        }

        public ActionResult PrintForm(int id)
        {
            var model = db.SZ_QuoteDetailForm.Where(x => x.Id == id).FirstOrDefault();
            if (model == null)
            {
                return RedirectToAction("ScientistNewForm");
            }

            var formid = db.SZ_QuoteDetails_Form.Where(x => x.QuoteDetailsId == model.QuotationDetailsId).Select(x => x.FormId).FirstOrDefault();
            var formdata = db.SZ_QuoteDetailForm.Where(x => x.Id == formid).FirstOrDefault();
            var quotedetails = _operationRepository.GetQuoteDetailByID(model.QuotationDetailsId);
            if (quotedetails.ProductId.HasValue)
            {
                var productData = db.Products.Where(x => x.Sku.Trim().ToLower() == model.CATNo.Trim().ToLower().Replace("\t", "") && x.Deleted == false && x.Published == true).FirstOrDefault();
                SZ_Inventory objInv = db.SZ_Inventory.Where(x => x.BatchNo.Trim().ToLower() == model.BatchCode.Trim().ToLower()).FirstOrDefault();
                if (objInv == null)
                {
                    objInv = new SZ_Inventory();
                    objInv.ProductId = productData.Id;
                    objInv.BatchNo = model.BatchCode;
                    if (!string.IsNullOrEmpty(model.Qty))
                    {
                        objInv.Qty = Convert.ToDecimal(model.Qty);
                    }
                    objInv.RetentionQty = 15;
                    //if (objInv.Qty.HasValue)
                    //{
                    //    objInv.Qty -= objInv.RetentionQty;
                    //}
                    objInv.IsApproved = false;
                    objInv.CreatedDate = DateTime.Now;
                    objInv.Remarks = model.State;
                    db.SZ_Inventory.Add(objInv);

                    if (quotedetails.ProjectType != Convert.ToString((int)EnumList.ProjectType.InHouse))
                    {
                        if (quotedetails.ProjectType != Convert.ToString((int)EnumList.ProjectType.InStock))
                        {
                            quotedetails.Instockdate = DateTime.Now;
                        }
                        quotedetails.ProjectStatus = (int)EnumList.ProjectStatus.MoveToInstock;
                        quotedetails.ProjectType = Convert.ToString((int)EnumList.ProjectType.InStock);
                        quotedetails.IsPriority = false;
                    }
                    if (quotedetails.ProcessState <= (int)EnumList.ProcessState.MoveToInStock)
                    {
                        quotedetails.ProcessState = (int)EnumList.ProcessState.MoveToInStock;
                    }
                    if (formdata != null && formdata.ApprovalStatus == Convert.ToString((int)EnumList.ApprovedStatus.QCApproved))
                    {
                        quotedetails.AdditionalBatchNo = objInv.Id;
                        quotedetails.ProStatus = Convert.ToString((int)EnumList.ProStatusDDL.ReadyforDispatch);
                        quotedetails.OtherProStatus = Convert.ToString((int)EnumList.ProStatusDDL.ReadyforDispatch);
                        quotedetails.DispatchStatus = Convert.ToString((int)EnumList.ProStatusDDL.ReadyforDispatch);
                        quotedetails.ReviewSciStatus = Convert.ToString((int)EnumList.ProStatusDDL.ReadyforDispatch);
                        quotedetails.ExplainationSecond = "Product is available now and processed for dispatch.";
                        quotedetails.IsDispatchApprove = true;
                    }
                    db.Entry(quotedetails).State = EntityState.Modified;
                    db.SaveChanges();

                    MemoryCacheManager objCache = new MemoryCacheManager();
                    objCache.Remove("cache.inventoryData");
                }
            }
            return View(model);
        }

        public ActionResult DeleteSubmittedForm(int id)
        {
            var model = db.SZ_QuoteDetailForm.Where(x => x.Id == id).FirstOrDefault();
            if (model != null)
            {
                db.Entry(model).State = EntityState.Deleted;
                db.SaveChanges();
            }
            return Json("success", JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public ActionResult UpdateProductdetails(SZ_ProjectDetail model)
        {
            SZ_ProjectDetail data = db.SZ_ProjectDetail.FirstOrDefault(x => x.Id == model.Id);
            if (data != null)
            {
                data.Status = model.Status;
                data.CompletationDate = model.CompletationDate;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { type = "success", msg = "updated successfully." }
                };
            }
            else
            {
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { type = "error", msg = "There are some problem to add inventory." }
                };
            }
        }

        public ActionResult ManageProject(int id = 0)
        {
            if (!SessionCookieManagement.IsLogin)
            {
                return RedirectToAction("Index", "Home");
            }

            var model = db.SZ_Project.FirstOrDefault(x => x.Id == id);
            if (model == null)
            {
                model = new SZ_Project();
                model.Status = "In Progress";
            }

            return PartialView(model);
        }

        public ActionResult ManageProjectDetails(int id)
        {
            if (!SessionCookieManagement.IsLogin)
            {
                return RedirectToAction("Index", "Home");
            }
            var model = db.SZ_ProjectDetail.Where(x => x.Id == id).FirstOrDefault();
            if (model == null)
            {
                return RedirectToAction("Project");
            }

            string uri = Domain + "/api/RestAPI/ProductDetails?productId=" + model.ProductId;
            using (HttpClient httpClient = new HttpClient())
            {
                Task<String> response = httpClient.GetStringAsync(uri);
                string productModel = JsonConvert.DeserializeObject<string>(response.Result);
                ViewBag.ProductModel = JsonConvert.DeserializeObject<ProductDetailsModel>(productModel);

            }

            var BatchList = new List<SelectListItem>();
            var batchListmodel = db.SZ_Inventory.Where(x => x.ProductId == model.ProductId).ToList();
            BatchList.Add(new SelectListItem { Text = "--Select--", Value = "" });
            foreach (var item in batchListmodel)
            {
                BatchList.Add(new SelectListItem { Text = item.BatchNo, Value = item.Id.ToString() });
            }
            ViewBag.BatchList = BatchList;

            if (model.BatchId.HasValue && model.BatchId != 0)
            {
                ViewBag.batchQty = batchListmodel.Where(x => x.Id == model.BatchId).Select(x => x.Qty).FirstOrDefault();
            }

            return PartialView(model);
        }

        [HttpPost]
        public ActionResult ManageProjectDetails(SZ_ProjectDetail model, FormCollection form)
        {
            var batchdata = db.SZ_Inventory.FirstOrDefault(x => x.Id == model.BatchId);
            if (batchdata != null)
            {
                if (batchdata.Qty < model.Qty)
                {
                    return new JsonResult()
                    {
                        JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                        Data = new { type = "error", msg = "Qty is not available for this batch no." }
                    };
                }
            }
            SZ_ProjectDetail objdetails = db.SZ_ProjectDetail.FirstOrDefault(x => x.Id == model.Id);
            if (objdetails != null)
            {
                objdetails.BatchId = model.BatchId;
                objdetails.NoOfPack = model.NoOfPack;
                objdetails.Qty = model.Qty;
                objdetails.PackSize = model.PackSize;
                objdetails.LeadTime = model.LeadTime;
                objdetails.LabelRequirement = model.LabelRequirement;
                objdetails.DataRequired = model.DataRequired;
                objdetails.ScheduleDispatch = model.ScheduleDispatch;
                objdetails.Scientist = model.Scientist;
                objdetails.Othervalue = model.Othervalue;
                objdetails.Remark = model.Remark;
                objdetails.ProjectType = model.ProjectType;
                db.Entry(objdetails).State = EntityState.Modified;
                db.SaveChanges();
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { type = "success", msg = "Details updated successfully." }
                };
            }
            else
            {
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { type = "error", msg = "There are some problem to update Details." }
                };
            }
        }

        [HttpPost]
        public ActionResult ManageProject(SZModel model, FormCollection form)
        {
            model.Status = "In Progress";
            int noOfproduct = Convert.ToInt32(form.Get("Noofproduct"));
            List<Product> productList = new List<Product>();
            for (int i = 1; i <= noOfproduct; i++)
            {
                var sku = form.Get("pro_" + i);
                if (!string.IsNullOrEmpty(sku))
                {
                    var productData = db.Products.Where(x => x.Sku == sku && x.Deleted == false && x.Published == true).First();
                    if (productData == null)
                    {
                        var msg =
                            "Please enter proper catalog no. catalog no is not available in database. Issue in Catalog No : " +
                            sku;
                        return new JsonResult()
                        {
                            JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                            Data = new { type = "error", msg = msg }
                        };
                    }
                    else
                    {
                        productList.Add(productData);
                    }
                }
                else
                {
                    var msg = "Please enter catalog no.";
                    return new JsonResult()
                    {
                        JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                        Data = new { type = "error", msg = msg }
                    };
                }

            }

            if (model.Id == 0)
            {
                SZ_Project objszProject = new SZ_Project();
                objszProject.Status = model.Status;
                objszProject.PONo = model.PONo;
                objszProject.PODate = model.PODate;
                objszProject.Company = model.Company;
                objszProject.Revised1 = model.Revised1;
                objszProject.Revised2 = model.Revised2;
                objszProject.Revised3 = model.Revised3;
                objszProject.ActualDispatch = model.ActualDispatch;

                objszProject.CreatedDate = DateTime.Now;
                db.SZ_Project.Add(objszProject);
                db.SaveChanges();

                foreach (var product in productList)
                {
                    SZ_ProjectDetail objdetails = new SZ_ProjectDetail();
                    objdetails.ProjectId = objszProject.Id;
                    objdetails.ProductId = product.Id;
                    objdetails.Status = "In Progress";
                    db.SZ_ProjectDetail.Add(objdetails);
                    db.SaveChanges();
                }

                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { type = "success", msg = "Project added successfully." }
                };
            }
            else
            {
                var szproject = db.SZ_Project.FirstOrDefault(x => x.Id == model.Id);
                if (szproject != null)
                {
                    szproject.PONo = model.PONo;
                    szproject.PODate = model.PODate;
                    szproject.Company = model.Company;
                    szproject.Revised1 = model.Revised1;
                    szproject.Revised2 = model.Revised2;
                    szproject.Revised3 = model.Revised3;
                    szproject.ActualDispatch = model.ActualDispatch;

                    db.Entry(szproject).State = EntityState.Modified;
                    db.SaveChanges();

                    return new JsonResult()
                    {
                        JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                        Data = new { type = "success", msg = "Project updated successfully." }
                    };

                }
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { type = "error", msg = "There are some problem to update Project." }
                };
            }


        }

        public ActionResult CreateInventory(int id)
        {
            if (!SessionCookieManagement.IsLogin)
            {
                return RedirectToAction("Index", "Home");
            }
            SZ_Inventory model = new SZ_Inventory();
            model.ProductId = id;

            string uri = Domain + "/api/RestAPI/ProductDetails?productId=" + model.ProductId;
            using (HttpClient httpClient = new HttpClient())
            {
                Task<String> response = httpClient.GetStringAsync(uri);
                string productModel = JsonConvert.DeserializeObject<string>(response.Result);
                ViewBag.ProductModel = JsonConvert.DeserializeObject<ProductDetailsModel>(productModel);

            }
            model.ReTestDate = DateTime.Now.AddYears(3).Date;
            return PartialView(model);
        }

        [HttpPost]
        public ActionResult CreateInventory(SZ_Inventory model)
        {
            if (model.BatchNo != null)
            {
                if (Request.Files.Count > 0)
                {
                    var file = Request.Files["COA"];

                    if (file != null && file.ContentLength > 0)
                    {
                        var filename = Guid.NewGuid();
                        var fileext = Path.GetExtension(file.FileName);
                        var wholepath = "../Document/" + filename + "" + fileext;
                        var path = Path.Combine(Server.MapPath("~/Document/"), filename + "" + fileext);
                        file.SaveAs(path);
                        model.COAPath = wholepath;
                    }

                    var SDFfile = Request.Files["SDF"];

                    if (SDFfile != null && SDFfile.ContentLength > 0)
                    {
                        var filename = Guid.NewGuid();
                        var fileext = Path.GetExtension(SDFfile.FileName);
                        var wholepath = "../Document/" + filename + "" + fileext;
                        var path = Path.Combine(Server.MapPath("~/Document/"), filename + "" + fileext);
                        SDFfile.SaveAs(path);
                        model.StdDataPath = wholepath;
                    }

                    var ADDFilefile = Request.Files["ADDFile"];

                    if (ADDFilefile != null && ADDFilefile.ContentLength > 0)
                    {
                        var filename = Guid.NewGuid();
                        var fileext = Path.GetExtension(ADDFilefile.FileName);
                        var wholepath = "../Document/" + filename + "" + fileext;
                        var path = Path.Combine(Server.MapPath("~/Document/"), filename + "" + fileext);
                        ADDFilefile.SaveAs(path);
                        model.AddDataPath = wholepath;
                    }
                    model.CreatedDate = DateTime.Now;
                    db.SZ_Inventory.Add(model);
                    db.SaveChanges();
                    return new JsonResult()
                    {
                        JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                        Data = new { type = "success", msg = "Inventory add successfully." }
                    };
                }
                model.CreatedDate = DateTime.Now;
                db.SZ_Inventory.Add(model);
                db.SaveChanges();

                MemoryCacheManager objCache = new MemoryCacheManager();
                objCache.Remove("cache.inventoryData");
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { type = "success", msg = "Inventory add successfully." }
                };
            }
            else
            {
                TempData["Message"] = "There are some problem to update inventory.";
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { type = "error", msg = "There are some problem to add inventory." }
                };
            }
        }

        public ActionResult EditInventory(int id)
        {
            if (!SessionCookieManagement.IsLogin)
            {
                return RedirectToAction("Index", "Home");
            }
            SZ_Inventory model = db.SZ_Inventory.Where(x => x.Id == id).FirstOrDefault();
            if (model == null)
                return PartialView(model);

            string uri = Domain + "/api/RestAPI/ProductDetails?productId=" + model.ProductId;
            using (HttpClient httpClient = new HttpClient())
            {
                Task<String> response = httpClient.GetStringAsync(uri);
                string productModel = JsonConvert.DeserializeObject<string>(response.Result);
                ViewBag.ProductModel = JsonConvert.DeserializeObject<ProductDetailsModel>(productModel);

            }
            return PartialView(model);
        }

        [HttpPost]
        public ActionResult EditInventory(SZ_Inventory model)
        {
            var inv = db.SZ_Inventory.Where(x => x.Id == model.Id).FirstOrDefault();
            if (inv != null)
            {
                inv.Appearance = model.Appearance;
                inv.Remarks = model.Remarks;
                inv.Qty = model.Qty;
                inv.ReTestDate = model.ReTestDate;
                if (Request.Files.Count > 0)
                {
                    var file = Request.Files["COA"];

                    if (file != null && file.ContentLength > 0)
                    {
                        var filename = Guid.NewGuid();
                        var fileext = Path.GetExtension(file.FileName);
                        var wholepath = "../Document/" + filename + "" + fileext;
                        var path = Path.Combine(Server.MapPath("~/Document/"), filename + "" + fileext);
                        file.SaveAs(path);
                        inv.COAPath = wholepath;
                    }

                    var SDFfile = Request.Files["SDF"];

                    if (SDFfile != null && SDFfile.ContentLength > 0)
                    {
                        var filename = Guid.NewGuid();
                        var fileext = Path.GetExtension(SDFfile.FileName);
                        var wholepath = "../Document/" + filename + "" + fileext;
                        var path = Path.Combine(Server.MapPath("~/Document/"), filename + "" + fileext);
                        SDFfile.SaveAs(path);
                        inv.StdDataPath = wholepath;
                    }

                    var ADDFilefile = Request.Files["ADDFile"];

                    if (ADDFilefile != null && ADDFilefile.ContentLength > 0)
                    {
                        var filename = Guid.NewGuid();
                        var fileext = Path.GetExtension(ADDFilefile.FileName);
                        var wholepath = "../Document/" + filename + "" + fileext;
                        var path = Path.Combine(Server.MapPath("~/Document/"), filename + "" + fileext);
                        ADDFilefile.SaveAs(path);
                        inv.AddDataPath = wholepath;
                    }

                }
                db.Entry(inv).State = EntityState.Modified;
                db.SaveChanges();
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { type = "success", msg = "Inventory updated successfully." }
                };
            }
            else
            {
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { type = "error", msg = "There are some problem to update inventory." }
                };
            }
        }

        public string GetMainCatName(Product product)
        {
            string MainCatNamestr = "";
            var productCategories = GetProductCategoriesByProductId(product.Id);
            if (productCategories.Count > 0)
            {
                foreach (var catBr in productCategories)
                {
                    if (catBr.ParentCategoryId == 0)
                    {
                        MainCatNamestr = catBr.Name;
                    }
                    else
                    {
                        var category = db.Categories.Where(x => x.Id == catBr.ParentCategoryId).FirstOrDefault();
                        if (category != null)
                        {
                            if (category.ParentCategoryId == 0)
                            {
                                MainCatNamestr = category.Name;
                            }
                        }
                    }
                }
            }
            return MainCatNamestr;
        }

        public IList<Category> GetProductCategoriesByProductId(int productId)

        {
            var query = from pc in db.Product_Category_Mapping
                        join c in db.Categories on pc.CategoryId equals c.Id
                        where pc.ProductId == productId &&
                              !c.Deleted &&
                              c.Published
                        orderby pc.DisplayOrder
                        select pc;

            var allProductCategories = query.ToList();
            var result = new List<Category>();
            foreach (var pc in allProductCategories)
            {
                var category = pc.Category;
                result.Add(category);
            }

            return result;
        }

        public virtual IList<Picture> GetPicturesByProductId(int productId, int recordsToReturn = 0)
        {
            if (productId == 0)
                return new List<Picture>();


            var query = from p in db.Pictures
                        join pp in db.Product_Picture_Mapping on p.Id equals pp.PictureId
                        orderby pp.DisplayOrder
                        where pp.ProductId == productId
                        select p;

            if (recordsToReturn > 0)
                query = query.Take(recordsToReturn);

            var pics = query.ToList();
            return pics;
        }

        public JsonResult GetInventoryList(string sidx, string sord, int page, int rows, string searchString, string searchField)  //Gets the todo Lists.
        {
            int pageIndex = Convert.ToInt32(page) - 1;
            int pageSize = rows;

            string uri = Domain + "/api/RestAPI/GetInventoryList?sidx=" + sidx + "&sord=" + sord + "&page=" + page + "&rows=" + rows + "&searchString=" + searchString + "&searchField=" + searchField; //+ model.ProductId;
            try
            {
                using (HttpClient httpClient = new HttpClient())
                {
                    Task<String> response = httpClient.GetStringAsync(uri);
                    string productModel = JsonConvert.DeserializeObject<string>(response.Result);
                    var ProductModel = JsonConvert.DeserializeObject<InventoryOutput>(productModel);
                    var jsonData = new
                    {
                        total = ProductModel.total,
                        page = ProductModel.page,
                        records = ProductModel.records,
                        rows = ProductModel.rows
                    };

                    return Json(jsonData, JsonRequestBehavior.AllowGet);

                }
            }
            catch (Exception ex)
            {

            }

            return Json("", JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public ActionResult DeleteInventory(int id)
        {
            try
            {
                var inv = db.SZ_Inventory.Where(x => x.Id == id).FirstOrDefault();
                if (inv != null)
                {
                    var projectdetailsData = db.SZ_ProjectDetail.Where(x => x.BatchId == inv.Id).ToList();
                    foreach (var item in projectdetailsData)
                    {
                        db.Entry(item).State = EntityState.Deleted;
                        db.SaveChanges();
                    }
                    db.Entry(inv).State = EntityState.Deleted;
                    db.SaveChanges();
                }

                return Json(new { success = true }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new { success = false, message = ex.Message }, JsonRequestBehavior.AllowGet);

            }
        }

        [HttpPost]
        public ActionResult DeleteQuotation(int id)
        {
            try
            {
                var inv = _operationRepository.GetQuoteByID(id);
                if (inv != null)
                {
                    var detailsData = db.SZ_QuotationDetail.Where(x => x.QuoteId == inv.Id).ToList();
                    foreach (var item in detailsData)
                    {
                        db.Entry(item).State = EntityState.Deleted;
                        db.SaveChanges();
                    }
                    db.Entry(inv).State = EntityState.Deleted;
                    db.SaveChanges();
                }

                return Json(new { success = true }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new { success = false, message = ex.Message }, JsonRequestBehavior.AllowGet);

            }
        }

        [HttpPost]
        public ActionResult RemoveSynthesisLog(int id)
        {
            try
            {
                var inv = _operationRepository.GetQuoteDetailByID(id);
                if (inv != null)
                {
                    inv.IsSynthesisLog = false;
                    db.Entry(inv).State = EntityState.Modified;
                    db.SaveChanges();
                }

                return Json(new { success = true }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new { success = false, message = ex.Message }, JsonRequestBehavior.AllowGet);

            }
        }

        [HttpPost]
        public ActionResult DeleteNameMaster(int id)
        {
            try
            {
                var inv = db.SZ_NameMaster.Where(x => x.Id == id).FirstOrDefault();
                if (inv != null)
                {
                    db.Entry(inv).State = EntityState.Deleted;
                    db.SaveChanges();
                }
                return Json(new { success = true }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new { success = false, message = ex.Message }, JsonRequestBehavior.AllowGet);

            }
        }

        [HttpPost]
        public ActionResult DeleteScientistStatus(int id)
        {
            try
            {
                var inv = db.SZ_ScientistStatus.Where(x => x.Id == id).FirstOrDefault();
                if (inv != null)
                {
                    db.Entry(inv).State = EntityState.Deleted;
                    db.SaveChanges();
                }

                return Json(new { success = true }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new { success = false, message = ex.Message }, JsonRequestBehavior.AllowGet);

            }
        }

        [HttpPost]
        public ActionResult DeleteSampleReason(int id)
        {
            try
            {
                var inv = db.SZ_SampleReason.Where(x => x.Id == id).FirstOrDefault();
                if (inv != null)
                {
                    db.Entry(inv).State = EntityState.Deleted;
                    db.SaveChanges();
                }

                return Json(new { success = true }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new { success = false, message = ex.Message }, JsonRequestBehavior.AllowGet);

            }
        }


        [HttpPost]
        public ActionResult DeletePaymentTerms(int id)
        {
            try
            {
                var inv = db.PaymentTerms.Where(x => x.Id == id).FirstOrDefault();
                if (inv != null)
                {
                    db.Entry(inv).State = EntityState.Deleted;
                    db.SaveChanges();
                }

                return Json(new { success = true }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new { success = false, message = ex.Message }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        public ActionResult DeletePhysicalState(int id)
        {
            try
            {
                var inv = db.SZ_Physicalstate.Where(x => x.Id == id).FirstOrDefault();
                if (inv != null)
                {
                    db.Entry(inv).State = EntityState.Deleted;
                    db.SaveChanges();
                }

                return Json(new { success = true }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new { success = false, message = ex.Message }, JsonRequestBehavior.AllowGet);

            }
        }

        [HttpPost]
        public ActionResult DeleteTerms(int id)
        {
            try
            {
                var inv = db.SZ_Terms.Where(x => x.Id == id).FirstOrDefault();
                if (inv != null)
                {
                    db.Entry(inv).State = EntityState.Deleted;
                    db.SaveChanges();
                }

                return Json(new { success = true }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new { success = false, message = ex.Message }, JsonRequestBehavior.AllowGet);

            }
        }

        [HttpPost]
        public ActionResult ClosePRRequest(int id)
        {
            try
            {
                var prrequest = db.SZ_PRRequest.Where(x => x.Id == id).FirstOrDefault();
                if (prrequest != null)
                {
                    prrequest.IsRequestClosed = true;
                    prrequest.ClosedBy = SessionCookieManagement.UserName;
                    prrequest.ClosedDate = DateTime.Now;
                    db.Entry(prrequest).State = EntityState.Modified;
                    db.SaveChanges();
                }
                return Json(new { success = true }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                return Json(new { success = false, message = errortext + " / " + ex.Message }, JsonRequestBehavior.AllowGet);

            }
        }


        [HttpPost]
        public ActionResult DeletePRRequest(int id)
        {
            try
            {
                var prrequest = db.SZ_PRRequest.Where(x => x.Id == id).FirstOrDefault();
                if (prrequest != null)
                {
                    db.Entry(prrequest).State = EntityState.Deleted;
                    db.SaveChanges();
                }
                return Json(new { success = true }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                return Json(new { success = false, message = errortext + " / " + ex.Message }, JsonRequestBehavior.AllowGet);

            }
        }

        [HttpPost]
        public ActionResult DeleteSOP(int id)
        {
            try
            {
                var inv = db.SZ_SOP.Where(x => x.Id == id).FirstOrDefault();
                if (inv != null)
                {
                    db.Entry(inv).State = EntityState.Deleted;
                    db.SaveChanges();
                }

                return Json(new { success = true }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                return Json(new { success = false, message = errortext + " / " + ex.Message }, JsonRequestBehavior.AllowGet);

            }
        }

        [HttpPost]
        public ActionResult DeleteCompany(int id)
        {
            try
            {
                var inv = db.SZ_CompanyList.Where(x => x.Id == id).FirstOrDefault();
                if (inv != null)
                {
                    var detailsData = db.SZ_Quotation.Where(x => x.CompanyId == inv.Id).Count();
                    if (detailsData > 0)
                    {
                        return Json(new { success = false, multiple = true }, JsonRequestBehavior.AllowGet);
                    }

                    var companyAddressData = db.SZ_CompanyAddress.Where(x => x.CompanyId == inv.Id).ToList();
                    if (companyAddressData != null && companyAddressData.Count > 0)
                    {
                        foreach (var item in companyAddressData)
                        {
                            db.Entry(item).State = EntityState.Deleted;
                        }
                    }
                    db.Entry(inv).State = EntityState.Deleted;
                    db.SaveChanges();
                }
                return Json(new { success = true }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                return Json(new { success = false, message = errortext + " / " + ex.Message }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        public ActionResult DeleteQuickAdd(int id)
        {
            try
            {
                var inv = db.SZ_TempQuickAdd.Where(x => x.Id == id).FirstOrDefault();
                if (inv != null)
                {
                    db.Entry(inv).State = EntityState.Deleted;
                    db.SaveChanges();
                }

                return Json(new { success = true }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new { success = false, message = ex.Message }, JsonRequestBehavior.AllowGet);

            }
        }

        [HttpPost]
        public ActionResult DeleteMasterCOA(int id)
        {
            try
            {
                var inv = db.SZ_MasterCOA.Where(x => x.Id == id).FirstOrDefault();
                if (inv != null)
                {
                    var childata = db.SZ_ChildCOA.Where(x => x.MasterCOAID == inv.Id).ToList();
                    if (childata != null && childata.Count > 0)
                    {
                        foreach (var item in childata)
                        {
                            db.Entry(item).State = EntityState.Deleted;
                            db.SaveChanges();
                        }

                    }
                    db.Entry(inv).State = EntityState.Deleted;
                    db.SaveChanges();
                }

                return Json(new { success = true }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new { success = false, message = ex.Message }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        public ActionResult DeleteChildCOA(int id)
        {
            try
            {
                var inv = db.SZ_ChildCOA.Where(x => x.Id == id).FirstOrDefault();
                if (inv != null)
                {
                    db.Entry(inv).State = EntityState.Deleted;
                    db.SaveChanges();
                }

                return Json(new { success = true }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new { success = false, message = ex.Message }, JsonRequestBehavior.AllowGet);

            }
        }

        public ActionResult Expire()
        {
            Session["ShowPrice"] = "false";
            return RedirectToAction("Price");
        }

        [HttpPost]
        public ActionResult EnterPassword(string page, string password)
        {
            if (password == "Rv5VB1")
            {
                Session["ShowPrice"] = "true";
            }
            else
            {
                TempData["Message"] = "Enter Proper Password";
                Session["ShowPrice"] = "false";
            }
            return RedirectToAction("Price");
        }

        public JsonResult GetFollowUpOverview(string value)
        {
            var data = db.FollowupOverview(value).ToList();
            var jsonResult = Json(data, JsonRequestBehavior.AllowGet);
            jsonResult.MaxJsonLength = int.MaxValue;
            return jsonResult;
            //return Json(data, JsonRequestBehavior.AllowGet);
        }

        public ActionResult BDDashboard()
        {
            var model = new BDDashboardModel();
            model.AssignQuoteDetails = db.SZ_QuotationDetail.Where(x => x.SZ_Quotation.AssignTo == SessionCookieManagement.UserId).OrderByDescending(x => x.CreatedDate).AsEnumerable();
            model.ConversionData = db.SZ_QuoteDetail_Correctionlog.Where(x => x.IsClosed == false && x.QuoteBy == SessionCookieManagement.UserName).OrderByDescending(x => x.CreatedDate).AsEnumerable();
            model.RFQQuoteData = db.SZ_Quotation.Where(x => x.IsRFQManually == true).OrderBy(x => x.CompanyName).ToList();
            string synthesisProjectType = Convert.ToString((int)EnumList.ProjectType.Synthesis);
            string pursynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
            model.SynthesisCatNo = (from cp in db.SZ_QuotationDetail
                                    where (cp.ProjectType == synthesisProjectType || cp.ProjectType == pursynthesisProjectType)
                                    && (cp.MoveToDispatch == false || cp.MoveToDispatch == null)
                                    && (cp.SZ_Quotation.IsRFQManually == false || cp.SZ_Quotation.IsRFQManually == null)
                                    select cp.CATNo).Distinct().ToList();
            model.TodayQuotation = db.SZ_Quotation.Where(x => x.CreatedBy == SessionCookieManagement.UserName && x.CreatedDate == DateTime.Now).Count();
            model.UnderCorrection = db.SZ_Quotation.Where(x => x.AssignTo == SessionCookieManagement.UserId && x.IsUnderCorrection == true).ToList();
            model.TodayApproved = db.SZ_Quotation.Where(x => x.CreatedBy == SessionCookieManagement.UserName && x.CreatedDate == DateTime.Now && !string.IsNullOrEmpty(x.ApprovedBy)).Count();
            return View(model);
        }


        public JsonResult MainCategory(string id, bool isonlycategory = false)
        {
            if (id == "ALL")
            {
                var dataall = db.Categories.Where(x => x.ParentCategoryId == 0 && x.Deleted == false && x.Published == true).OrderBy(x => x.Name);
                var modelall = (from entity in dataall
                                select new CategoryModel
                                {
                                    Id = entity.Id,
                                    Name = entity.Name.Trim(),
                                }).OrderBy(x => x.Name).AsQueryable();

                var jsonallData = new
                {
                    records = modelall
                };
                return Json(jsonallData, JsonRequestBehavior.AllowGet);
            }
            var data = db.Categories.Where(x => x.Name.StartsWith(id) && x.ParentCategoryId == 0 && x.Deleted == false && x.Published == true);
            var model = (from entity in data
                         select new CategoryModel
                         {
                             Id = entity.Id,
                             Name = entity.Name,
                         }).OrderBy(x => x.Name).AsQueryable();
            if (isonlycategory)
            {
                var jsonDatas = new
                {
                    records = model
                };

                return Json(jsonDatas, JsonRequestBehavior.AllowGet);
            }


            var categoryIds = model.Select(x => x.Id).ToList();
            var productRecord = (from p in db.Products
                                 join pc in db.Product_Category_Mapping on p.Id equals pc.ProductId
                                 join c in db.Categories on pc.CategoryId equals c.Id
                                 join mc in db.Categories on c.ParentCategoryId equals mc.Id
                                 where categoryIds.Contains(c.ParentCategoryId) && !p.Deleted && p.Published
                                 && !mc.Deleted && mc.Published
                                 && !c.Deleted && c.Published
                                 group mc by mc.Name into pt1
                                 select new
                                 {
                                     CategoryName = pt1.Key,
                                     ProductCount = pt1.Count()
                                 }).ToList();

            var productids = db.SZ_PriceList.Select(x => x.ProductId).ToList();
            var pricelistRecordUSD = (
                                      //  from p in db.SZ_PriceList
                                      //join pc in db.Product_Category_Mapping on p.ProductId equals pc.ProductId
                                      from pc in db.Product_Category_Mapping
                                      join c in db.Categories on pc.CategoryId equals c.Id
                                      join mc in db.Categories on c.ParentCategoryId equals mc.Id
                                      where categoryIds.Contains(c.ParentCategoryId)
                                     && !c.Deleted && c.Published
                                     && !mc.Deleted && mc.Published
                                     && productids.Contains(pc.ProductId)
                                      group mc by mc.Name into pt1
                                      select new
                                      {
                                          CategoryName = pt1.Key,
                                          ProductCount = pt1.Count()
                                      }).ToList();
            var pricelistRecordINR = pricelistRecordUSD;
            //var pricelistRecordUSD = (from p in db.SZ_PriceList
            //                          join pc in db.Product_Category_Mapping on p.ProductId equals pc.ProductId
            //                          join c in db.Categories on pc.CategoryId equals c.Id
            //                          join mc in db.Categories on c.ParentCategoryId equals mc.Id
            //                          //where categoryIds.Contains(c.ParentCategoryId) && p.IsUsd == true
            //                          where categoryIds.Contains(c.ParentCategoryId)
            //                          && !mc.Deleted && mc.Published
            //                         && !c.Deleted && c.Published
            //                         && !string.IsNullOrEmpty(p.TenUSD)
            //                          group mc by mc.Name into pt1
            //                          select new
            //                          {
            //                              CategoryName = pt1.Key,
            //                              ProductCount = pt1.Count()
            //                          }).ToList();

            //var pricelistRecordINR = (from p in db.SZ_PriceList
            //                          join pc in db.Product_Category_Mapping on p.ProductId equals pc.ProductId
            //                          join c in db.Categories on pc.CategoryId equals c.Id
            //                          join mc in db.Categories on c.ParentCategoryId equals mc.Id
            //                          where categoryIds.Contains(c.ParentCategoryId)
            //                          && !mc.Deleted && mc.Published
            //                          && !c.Deleted && c.Published && !string.IsNullOrEmpty(p.TenPrice)
            //                          group mc by mc.Name into pt1
            //                          select new
            //                          {
            //                              CategoryName = pt1.Key,
            //                              ProductCount = pt1.Count()
            //                          }).ToList();

            var pricerecord = new List<PriceDashboardModel>();

            foreach (var item in productRecord)
            {
                var obj = new PriceDashboardModel();
                obj.CategoryName = item.CategoryName;
                obj.ProductCount = item.ProductCount;
                obj.PriceFilledUSDCount = pricelistRecordUSD.Where(x => x.CategoryName == item.CategoryName).Select(x => x.ProductCount).FirstOrDefault();
                obj.PricePendingUSDCount = item.ProductCount - obj.PriceFilledUSDCount;
                obj.PriceFilledINRCount = pricelistRecordINR.Where(x => x.CategoryName == item.CategoryName).Select(x => x.ProductCount).FirstOrDefault();
                obj.PricePendingINRCount = item.ProductCount - obj.PriceFilledINRCount;
                pricerecord.Add(obj);
            }


            var test = (from p in db.Products
                        join pc in db.Product_Category_Mapping on p.Id equals pc.ProductId
                        join c in db.Categories on pc.CategoryId equals c.Id
                        where categoryIds.Contains(c.ParentCategoryId)
                        select p).ToList();

            var jsonData = new
            {
                records = model,
                pricerecord = pricerecord
            };

            return Json(jsonData, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public ActionResult Upload(FormCollection formCollection)
        {
            if (Request != null)
            {
                HttpPostedFileBase file = Request.Files["UploadedFile"];
                if ((file != null) && (file.ContentLength > 0) && !string.IsNullOrEmpty(file.FileName))
                {
                    string fileName = file.FileName;
                    string fileContentType = file.ContentType;
                    byte[] fileBytes = new byte[file.ContentLength];
                    var data = file.InputStream.Read(fileBytes, 0, Convert.ToInt32(file.ContentLength));
                    using (var package = new ExcelPackage(file.InputStream))
                    {
                        var currentSheet = package.Workbook.Worksheets;
                        var workSheet = currentSheet.First();
                        var noOfCol = workSheet.Dimension.End.Column;
                        var noOfRow = workSheet.Dimension.End.Row;
                        for (int rowIterator = 2; rowIterator <= noOfRow; rowIterator++)
                        {
                            var user = new ExcelInventoryModel();
                            string catno = workSheet.Cells[rowIterator, 1].Value.ToString();
                            string batch = workSheet.Cells[rowIterator, 2].Value.ToString();
                            string Qty = workSheet.Cells[rowIterator, 3].Value.ToString();
                            string Appearance = workSheet.Cells[rowIterator, 4].Value != null ? workSheet.Cells[rowIterator, 4].Value.ToString() : "";
                            string COA = workSheet.Cells[rowIterator, 5].Value != null ? workSheet.Cells[rowIterator, 5].Value.ToString() : "";
                            string StandardData = workSheet.Cells[rowIterator, 6].Value != null ? workSheet.Cells[rowIterator, 6].Value.ToString() : "";
                            string AdditionalData = workSheet.Cells[rowIterator, 7].Value != null ? workSheet.Cells[rowIterator, 7].Value.ToString() : "";
                            string ReTestDate = workSheet.Cells[rowIterator, 8].Value != null ? workSheet.Cells[rowIterator, 8].Value.ToString() : "";
                            string Remarks = workSheet.Cells[rowIterator, 9].Value != null ? workSheet.Cells[rowIterator, 9].Value.ToString() : "";
                            string COAPath = "";
                            string StandardDataPath = "";
                            string AdditionalDataPath = "";
                            if (!string.IsNullOrEmpty(COA))
                            {
                                var filename = Guid.NewGuid();
                                var fileext = Path.GetExtension(COA);
                                COAPath = "../Document/" + filename + "" + fileext;
                                var targetpath = Path.Combine(Server.MapPath("~/Document/"), filename + "" + fileext);
                                var sourcepath = Server.MapPath(COA);
                                System.IO.File.Copy(sourcepath, targetpath, true);
                            }
                            if (!string.IsNullOrEmpty(StandardData))
                            {
                                var filename = Guid.NewGuid();
                                var fileext = Path.GetExtension(StandardData);
                                StandardDataPath = "../Document/" + filename + "" + fileext;
                                var targetpath = Path.Combine(Server.MapPath("~/Document/"), filename + "" + fileext);
                                var sourcepath = Server.MapPath(StandardData);
                                System.IO.File.Copy(sourcepath, targetpath, true);
                            }
                            if (!string.IsNullOrEmpty(AdditionalData))
                            {
                                var filename = Guid.NewGuid();
                                var fileext = Path.GetExtension(AdditionalData);
                                AdditionalDataPath = "../Document/" + filename + "" + fileext;
                                var targetpath = Path.Combine(Server.MapPath("~/Document/"), filename + "" + fileext);
                                var sourcepath = Server.MapPath(AdditionalData);
                                System.IO.File.Copy(sourcepath, targetpath, true);
                            }


                            var productdata = db.Products.Where(x => x.Sku == catno && x.Deleted == false && x.Published == true).FirstOrDefault();
                            if (productdata != null)
                            {
                                var inventorydata = db.SZ_Inventory.Where(x => x.ProductId == productdata.Id && x.BatchNo == batch).FirstOrDefault();
                                if (inventorydata != null)
                                {
                                    // update logic
                                    inventorydata.BatchNo = batch;
                                    inventorydata.Qty = Convert.ToDecimal(Qty);
                                    inventorydata.Appearance = Appearance;
                                    inventorydata.COAPath = COAPath;
                                    inventorydata.StdDataPath = StandardDataPath;
                                    inventorydata.AddDataPath = AdditionalDataPath;
                                    if (!string.IsNullOrEmpty(ReTestDate))
                                    {
                                        inventorydata.ReTestDate = Convert.ToDateTime(ReTestDate);
                                    }
                                    inventorydata.Remarks = Remarks;
                                    db.Entry(inventorydata).State = EntityState.Modified;
                                    db.SaveChanges();
                                }
                                else
                                {
                                    //insert logic
                                    SZ_Inventory objinv = new SZ_Inventory();
                                    objinv.BatchNo = batch;
                                    objinv.ProductId = productdata.Id;
                                    objinv.Qty = Convert.ToDecimal(Qty);
                                    objinv.Appearance = Appearance;
                                    objinv.COAPath = COAPath;
                                    objinv.StdDataPath = StandardDataPath;
                                    objinv.AddDataPath = AdditionalDataPath;
                                    if (!string.IsNullOrEmpty(ReTestDate))
                                    {
                                        objinv.ReTestDate = Convert.ToDateTime(ReTestDate);
                                    }
                                    objinv.Remarks = Remarks;
                                    objinv.CreatedDate = DateTime.Now;
                                    db.Entry(objinv).State = EntityState.Added;
                                    db.SaveChanges();
                                }
                            }
                        }
                    }
                }
            }
            return RedirectToAction("Inventory");
        }

        [HttpPost]
        public ActionResult UploadPrice(FormCollection formCollection)
        {
            if (Request != null)
            {
                HttpPostedFileBase file = Request.Files["UploadedFile"];
                if ((file != null) && (file.ContentLength > 0) && !string.IsNullOrEmpty(file.FileName))
                {
                    string fileName = file.FileName;
                    string fileContentType = file.ContentType;
                    byte[] fileBytes = new byte[file.ContentLength];
                    var data = file.InputStream.Read(fileBytes, 0, Convert.ToInt32(file.ContentLength));
                    using (var package = new ExcelPackage(file.InputStream))
                    {
                        var currentSheet = package.Workbook.Worksheets;
                        var workSheet = currentSheet.First();
                        var noOfCol = workSheet.Dimension.End.Column;
                        var noOfRow = workSheet.Dimension.End.Row;
                        for (int rowIterator = 2; rowIterator <= noOfRow; rowIterator++)
                        {
                            var user = new ExcelInventoryModel();
                            string catno = workSheet.Cells[rowIterator, 1].Value.ToString();
                            string category = workSheet.Cells[rowIterator, 2].Value != null ? workSheet.Cells[rowIterator, 2].Value.ToString().ToLower() : "";
                            string Permgprice = workSheet.Cells[rowIterator, 3].Value.ToString();
                            string Inrprice = workSheet.Cells[rowIterator, 4].Value != null ? workSheet.Cells[rowIterator, 4].Value.ToString() : "";
                            string RevisedPrice = workSheet.Cells[rowIterator, 5].Value != null ? workSheet.Cells[rowIterator, 5].Value.ToString() : "";
                            string Leadtime = workSheet.Cells[rowIterator, 6].Value != null ? workSheet.Cells[rowIterator, 6].Value.ToString() : "";
                            string Remark = workSheet.Cells[rowIterator, 7].Value != null ? workSheet.Cells[rowIterator, 7].Value.ToString() : "";

                            var productdata = db.Products.Where(x => x.Sku == catno && x.Deleted == false && x.Published == true).FirstOrDefault();
                            if (productdata != null)
                            {
                                //insert logic
                                SZ_Price objpri = new SZ_Price();
                                objpri.Price = !string.IsNullOrEmpty(Permgprice) ? Convert.ToDecimal(Permgprice) : 0;
                                objpri.ProductId = productdata.Id;
                                objpri.INRPrice = Inrprice;
                                objpri.USDPrice = RevisedPrice;
                                objpri.LeadTime = Leadtime;
                                objpri.Remark = Remark;
                                objpri.CreatedDate = DateTime.Now;

                                var catData = db.SZ_Category_Price.Where(x => x.Category.ToLower() == category).FirstOrDefault();
                                if (catData != null)
                                {
                                    objpri.CategoryPriceId = catData.Id;
                                }
                                db.Entry(objpri).State = EntityState.Added;
                                db.SaveChanges();
                            }
                        }
                    }
                }
            }
            return RedirectToAction("Price");
        }

        #region Price Section
        public ActionResult Price()
        {
            if (!SessionCookieManagement.IsPrice)
            {
                return RedirectToAction("Index", "Home");
            }
            return View();
        }

        public ActionResult ManagePrice(int id, int InvId)
        {
            var model = new InventoryModel();
            if (InvId == 0)
            {
                model = (from p in db.Products
                         join invv in db.SZ_Inventory on p.Id equals invv.ProductId
                         into invs
                         from inv in invs.DefaultIfEmpty()
                         join pr in db.SZ_Price on p.Id equals pr.ProductId
                         into ps
                         from pri in ps.DefaultIfEmpty()
                         join cp in db.SZ_Category_Price on pri.CategoryPriceId equals cp.Id
                         into cptb
                         from cpp in cptb.DefaultIfEmpty()
                         where p.Deleted != true && p.Published == true && p.Id == id
                         select new InventoryModel
                         {
                             ProductId = p.Id,
                             DrugApiCode = p.DrugApiCode,
                             Gtin = p.Gtin,
                             ManufacturerPartNumber = p.ManufacturerPartNumber,
                             MolecularWeight = p.MolecularWeight,
                             Name = p.Name,
                             Sku = p.Sku,
                             Smile = p.Smile,
                             Synonym = p.Synonym,
                             Product = p,
                             //  MainCatName = GetMainCatName(p),
                             BatchNo = inv.BatchNo,
                             Qty = inv.Qty,
                             COAPath = inv.COAPath,
                             StdDataPath = inv.StdDataPath,
                             AddDataPath = inv.AddDataPath,
                             Remarks = inv.Remarks,
                             Appearance = inv.Appearance,
                             InvId = inv.Id,
                             ReTestDate = inv.ReTestDate,
                             PriceId = pri.Id,
                             Price = pri.Price,
                             PriceRemark = pri.Remark,
                             Currancy = pri.Currancy,
                             INRPrice = cpp.Pricing,
                             USDPrice = pri.USDPrice,
                             LeadTime = pri.LeadTime,
                             MaxDiscount = pri.MaxDiscount,
                             CategoryPriceId = pri.CategoryPriceId != null ? (int)pri.CategoryPriceId : 0
                         }).FirstOrDefault();
            }
            else
            {
                model = (from p in db.Products
                         join invv in db.SZ_Inventory on p.Id equals invv.ProductId
                         into invs
                         from inv in invs.DefaultIfEmpty()
                         join pr in db.SZ_Price on p.Id equals pr.ProductId
                         into ps
                         from pri in ps.DefaultIfEmpty()
                         join cp in db.SZ_Category_Price on pri.CategoryPriceId equals cp.Id
                         into cptb
                         from cpp in cptb.DefaultIfEmpty()
                         where p.Deleted != true && p.Published == true && p.Id == id && inv.Id == InvId
                         select new InventoryModel
                         {
                             ProductId = p.Id,
                             DrugApiCode = p.DrugApiCode,
                             Gtin = p.Gtin,
                             ManufacturerPartNumber = p.ManufacturerPartNumber,
                             MolecularWeight = p.MolecularWeight,
                             Name = p.Name,
                             Sku = p.Sku,
                             Smile = p.Smile,
                             Synonym = p.Synonym,
                             Product = p,
                             //  MainCatName = GetMainCatName(p),
                             BatchNo = inv.BatchNo,
                             Qty = inv.Qty,
                             COAPath = inv.COAPath,
                             StdDataPath = inv.StdDataPath,
                             AddDataPath = inv.AddDataPath,
                             Remarks = inv.Remarks,
                             Appearance = inv.Appearance,
                             InvId = inv.Id,
                             ReTestDate = inv.ReTestDate,
                             PriceId = pri.Id,
                             Price = pri.Price,
                             PriceRemark = pri.Remark,
                             Currancy = pri.Currancy,
                             INRPrice = cpp.Pricing,
                             USDPrice = pri.USDPrice,
                             LeadTime = pri.LeadTime,
                             //  MaxDiscount = pri.MaxDiscount,
                             CategoryPriceId = pri.CategoryPriceId != null ? (int)pri.CategoryPriceId : 0
                         }).FirstOrDefault();
            }


            if (model == null)
                return RedirectToAction("Price");


            string uri = Domain + "/api/RestAPI/ProductDetails?productId=" + model.ProductId;
            using (HttpClient httpClient = new HttpClient())
            {
                Task<String> response = httpClient.GetStringAsync(uri);
                string productModel = JsonConvert.DeserializeObject<string>(response.Result);
                ViewBag.ProductModel = JsonConvert.DeserializeObject<ProductDetailsModel>(productModel);
            }
            model.CategoryPriceList.Add(new SelectListItem
            {
                Text = "Select",
                Value = "0"
            });

            var categoryPrice = db.SZ_Category_Price.ToList();
            foreach (var c in categoryPrice)
            {
                model.CategoryPriceList.Add(new SelectListItem
                {
                    Text = c.Category,
                    Value = c.Id.ToString()
                });
            }

            return View(model);
        }

        [HttpPost]
        public ActionResult ManagePrice(InventoryModel model)
        {
            if (model.PriceId > 0)
            {
                var pricedata = db.SZ_Price.Where(x => x.Id == model.PriceId).FirstOrDefault();
                if (pricedata != null)
                {
                    pricedata.Currancy = model.Currancy;
                    pricedata.Price = model.Price;
                    pricedata.Remark = model.PriceRemark;
                    pricedata.UpdatedDate = System.DateTime.Now;

                    pricedata.INRPrice = model.INRPrice;
                    pricedata.USDPrice = model.USDPrice;
                    pricedata.LeadTime = model.LeadTime;
                    pricedata.MaxDiscount = model.MaxDiscount;
                    pricedata.CategoryPriceId = model.CategoryPriceId;

                    db.Entry(pricedata).State = EntityState.Modified;
                    var categoryPrice = db.SZ_Category_Price.Where(x => x.Id == model.CategoryPriceId).FirstOrDefault();
                    if (categoryPrice != null)
                    {
                        categoryPrice.Pricing = model.INRPrice;
                        db.Entry(categoryPrice).State = EntityState.Modified;
                    }

                    db.SaveChanges();
                }
            }
            else
            {
                SZ_Price objprice = new SZ_Price();
                objprice.ProductId = model.ProductId;
                objprice.CreatedDate = System.DateTime.Now;
                objprice.Currancy = model.Currancy;
                objprice.Price = model.Price;
                objprice.Remark = model.PriceRemark;
                objprice.UpdatedDate = System.DateTime.Now;

                objprice.INRPrice = model.INRPrice;
                objprice.USDPrice = model.USDPrice;
                objprice.LeadTime = model.LeadTime;
                objprice.MaxDiscount = model.MaxDiscount;
                objprice.CategoryPriceId = model.CategoryPriceId;

                db.SZ_Price.Add(objprice);

                var categoryPrice = db.SZ_Category_Price.Where(x => x.Id == model.CategoryPriceId).FirstOrDefault();
                if (categoryPrice != null)
                {
                    categoryPrice.Pricing = model.INRPrice;
                    db.Entry(categoryPrice).State = EntityState.Modified;
                }

                db.SaveChanges();
            }
            return new JsonResult()
            {
                JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                Data = new { type = "success", msg = "Information saved successfully." }
            };


        }

        public JsonResult GetCategoryPriceById(int categoryId)
        {

            try
            {

                var data = db.SZ_Category_Price.Where(x => x.Id == categoryId).FirstOrDefault();
                if (data != null)
                {
                    var jsonData = new
                    {
                        Price = data.Pricing,
                        LeadTime = data.LeadTime
                    };
                    return Json(jsonData, JsonRequestBehavior.AllowGet);
                }
            }
            catch (Exception ex)
            {

            }

            return Json("", JsonRequestBehavior.AllowGet);
        }

        //delete price list
        [HttpPost]
        public ActionResult DeletePrice(int id)
        {
            try
            {
                var pri = db.SZ_Price.Where(x => x.Id == id).FirstOrDefault();
                if (pri != null)
                {
                    db.Entry(pri).State = EntityState.Deleted;
                    db.SaveChanges();
                }


                return Json(new { success = true, message = "Price deleted successfully." }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new { success = false, message = ex.Message }, JsonRequestBehavior.AllowGet);

            }
        }

        public JsonResult GetPriceList(string sidx, string sord, int page, int rows, string searchString, string searchField)
        {
            int pageIndex = Convert.ToInt32(page) - 1;
            int pageSize = rows;

            string uri = Domain + "/api/RestAPI/GetPriceList?sidx=" + sidx + "&sord=" + sord + "&page=" + page + "&rows=" + rows + "&searchString=" + searchString + "&searchField=" + searchField; //+ model.ProductId;
            try
            {
                using (HttpClient httpClient = new HttpClient())
                {
                    Task<String> response = httpClient.GetStringAsync(uri);
                    string productModel = JsonConvert.DeserializeObject<string>(response.Result);
                    var ProductModel = JsonConvert.DeserializeObject<InventoryOutput>(productModel);
                    var jsonData = new
                    {
                        total = ProductModel.total,
                        page = ProductModel.page,
                        records = ProductModel.records,
                        rows = ProductModel.rows
                    };

                    return Json(jsonData, JsonRequestBehavior.AllowGet);

                }
            }
            catch (Exception ex)
            {

            }

            return Json("", JsonRequestBehavior.AllowGet);
        }
        #endregion

        public JsonResult GetProjectListTest(string status)
        {
            string uri = Domain + "/api/RestAPI/GetProjectListTest?status=" + status;
            try
            {
                using (HttpClient httpClient = new HttpClient())
                {
                    Task<String> response = httpClient.GetStringAsync(uri);
                    string productModel = JsonConvert.DeserializeObject<string>(response.Result);
                    var ProductModel = JsonConvert.DeserializeObject<InventoryOutput>(productModel);
                    var jsonData = new
                    {
                        records = ProductModel.records,
                        rows = ProductModel.rows
                    };
                    return Json(jsonData, JsonRequestBehavior.AllowGet);
                }
            }
            catch (Exception ex)
            {

            }

            return Json("", JsonRequestBehavior.AllowGet);
        }

        public JsonResult GetProjectList(string sidx, string sord, int page, int rows, string searchString, string searchField)
        {
            int pageIndex = Convert.ToInt32(page) - 1;
            int pageSize = rows;

            string uri = Domain + "/api/RestAPI/GetProjectList?sidx=" + sidx + "&sord=" + sord + "&page=" + page + "&rows=" + rows + "&searchString=" + searchString + "&searchField=" + searchField; //+ model.ProductId;
            try
            {
                using (HttpClient httpClient = new HttpClient())
                {
                    Task<String> response = httpClient.GetStringAsync(uri);
                    string productModel = JsonConvert.DeserializeObject<string>(response.Result);
                    var ProductModel = JsonConvert.DeserializeObject<InventoryOutput>(productModel);
                    var jsonData = new
                    {
                        total = ProductModel.total,
                        page = ProductModel.page,
                        records = ProductModel.records,
                        rows = ProductModel.rows
                    };
                    return Json(jsonData, JsonRequestBehavior.AllowGet);
                }
            }
            catch (Exception ex)
            {

            }

            return Json("", JsonRequestBehavior.AllowGet);
        }

        public JsonResult GetInvoiceList(string sidx, string sord, int page, int rows, string searchString, string searchField)
        {
            int pageIndex = Convert.ToInt32(page) - 1;
            int pageSize = rows;

            string uri = Domain + "/api/RestAPI/GetInvoiceList?sidx=" + sidx + "&sord=" + sord + "&page=" + page + "&rows=" + rows + "&searchString=" + searchString + "&searchField=" + searchField; //+ model.ProductId;
            try
            {
                using (HttpClient httpClient = new HttpClient())
                {
                    Task<String> response = httpClient.GetStringAsync(uri);
                    string productModel = JsonConvert.DeserializeObject<string>(response.Result);
                    var ProductModel = JsonConvert.DeserializeObject<InventoryOutput>(productModel);
                    var jsonData = new
                    {
                        total = ProductModel.total,
                        page = ProductModel.page,
                        records = ProductModel.records,
                        rows = ProductModel.rows
                    };
                    return Json(jsonData, JsonRequestBehavior.AllowGet);
                }
            }
            catch (Exception ex)
            {

            }

            return Json("", JsonRequestBehavior.AllowGet);
        }

        public JsonResult GetDispatchList(string sidx, string sord, int page, int rows, string searchString, string searchField)
        {
            int pageIndex = Convert.ToInt32(page) - 1;
            int pageSize = rows;

            string uri = Domain + "/api/RestAPI/GetDispatchList?sidx=" + sidx + "&sord=" + sord + "&page=" + page + "&rows=" + rows + "&searchString=" + searchString + "&searchField=" + searchField; //+ model.ProductId;
            try
            {
                using (HttpClient httpClient = new HttpClient())
                {
                    Task<String> response = httpClient.GetStringAsync(uri);
                    string productModel = JsonConvert.DeserializeObject<string>(response.Result);
                    var ProductModel = JsonConvert.DeserializeObject<InventoryOutput>(productModel);
                    var jsonData = new
                    {
                        total = ProductModel.total,
                        page = ProductModel.page,
                        records = ProductModel.records,
                        rows = ProductModel.rows
                    };
                    return Json(jsonData, JsonRequestBehavior.AllowGet);
                }
            }
            catch (Exception ex)
            {

            }

            return Json("", JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public ActionResult PackedStatus(int id)
        {
            var projectdetailsdata = db.SZ_ProjectDetail.Where(x => x.Id == id).FirstOrDefault();
            if (projectdetailsdata != null)
            {
                var objSZInventory = db.SZ_Inventory.Where(x => x.Id == projectdetailsdata.BatchId).FirstOrDefault();
                if (objSZInventory == null)
                {
                    return Json(new { success = false, msg = "Please select batch number" }, JsonRequestBehavior.AllowGet);

                }
                if (objSZInventory.Qty < projectdetailsdata.Qty)
                {
                    return Json(new { success = false, msg = "Qty is not available for this batch no." }, JsonRequestBehavior.AllowGet);
                }

                objSZInventory.Qty = objSZInventory.Qty - projectdetailsdata.Qty;
                db.Entry(objSZInventory).State = EntityState.Modified;

                projectdetailsdata.Status = "Packed";
                db.Entry(projectdetailsdata).State = EntityState.Modified;

                db.SaveChanges();

                return Json(new { success = true, msg = "Product is packed." }, JsonRequestBehavior.AllowGet);
            }
            return Json(new { success = false, msg = "Invalid Product id" }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public ActionResult ReadyForDispatch(int id)
        {
            var projectdetailsdata = db.SZ_ProjectDetail.Where(x => x.Id == id).FirstOrDefault();
            if (projectdetailsdata != null)
            {
                var objSZInventory = db.SZ_Inventory.Where(x => x.Id == projectdetailsdata.BatchId).FirstOrDefault();
                if (objSZInventory == null)
                {
                    return Json(new { success = false, msg = "Please assign batch number for dispatch this product" }, JsonRequestBehavior.AllowGet);

                }
                projectdetailsdata.Status = "Ready for dispatch";
                db.Entry(projectdetailsdata).State = EntityState.Modified;
                db.SaveChanges();
                return Json(new { success = true, msg = "Product is ready for dispatch." }, JsonRequestBehavior.AllowGet);
            }
            return Json(new { success = false, msg = "Invalid Product id" }, JsonRequestBehavior.AllowGet);

        }
        [HttpPost]
        public ActionResult ReadyForInvoice(int id)
        {
            var projectdetailsdata = db.SZ_ProjectDetail.Where(x => x.Id == id).FirstOrDefault();
            if (projectdetailsdata != null)
            {
                projectdetailsdata.Status = "Ready For Invoice";
                db.Entry(projectdetailsdata).State = EntityState.Modified;
                db.SaveChanges();
                return Json(new { success = true, msg = "Product is ready for invoice." }, JsonRequestBehavior.AllowGet);
            }
            return Json(new { success = false, msg = "Invalid Product id" }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public ActionResult DeleteProductDetails(int ProjectId, int ProjectDetailId = 0)
        {

            if (ProjectDetailId == 0)
            {
                var projectdata = db.SZ_Project.Where(x => x.Id == ProjectId).FirstOrDefault();
                if (projectdata != null)
                {
                    db.Entry(projectdata).State = EntityState.Deleted;
                    db.SaveChanges();
                }
            }
            else
            {
                try
                {
                    var projectdetailsdata = db.SZ_ProjectDetail.Where(x => x.Id == ProjectDetailId).FirstOrDefault();
                    if (projectdetailsdata != null)
                    {
                        db.Entry(projectdetailsdata).State = EntityState.Deleted;
                        db.SaveChanges();
                    }
                    return Json(new { success = true }, JsonRequestBehavior.AllowGet);
                }
                catch (Exception ex)
                {
                    return Json(new
                    {
                        success = false,
                        message = ex.Message
                    }, JsonRequestBehavior.AllowGet);

                }
            }
            return Json(new { success = true }, JsonRequestBehavior.AllowGet);
        }
        public ActionResult RecentAddition()
        {
            return View();
        }

        public JsonResult RecentAdditionList(string sidx, string sord, int page, int rows)
        {
            int pageIndex = Convert.ToInt32(page) - 1;
            int pageSize = rows;

            string uri = Domain + "/api/RestAPI/RecentAdditionList?sidx=" + sidx + "&sord=" + sord + "&page=" + page + "&rows=" + rows;
            try
            {
                using (HttpClient httpClient = new HttpClient())
                {
                    Task<String> response = httpClient.GetStringAsync(uri);
                    string productModel = JsonConvert.DeserializeObject<string>(response.Result);
                    var ProductModel = JsonConvert.DeserializeObject<InventoryOutput>(productModel);
                    var jsonData = new
                    {
                        total = ProductModel.total,
                        page = ProductModel.page,
                        records = ProductModel.records,
                        rows = ProductModel.rows
                    };

                    return Json(jsonData, JsonRequestBehavior.AllowGet);

                }
            }
            catch (Exception ex)
            {

            }
            return Json("", JsonRequestBehavior.AllowGet);
        }
        public ActionResult ExportInventoryList()
        {
            string sidx = "";
            string sord = "";
            int page = 1;
            int rows = 0;

            string searchString = "";
            string searchField = "";
            int pageIndex = Convert.ToInt32(page) - 1;
            int pageSize = rows;
            System.Web.UI.WebControls.GridView gv = new System.Web.UI.WebControls.GridView();
            gv.DataSource = (
                   from c in db.Categories
                   join cp in db.Product_Category_Mapping on c.Id equals cp.CategoryId
                   join p in db.Products on cp.ProductId equals p.Id
                   join i in db.SZ_Inventory on p.Id equals i.ProductId into ps
                   from inv in ps.DefaultIfEmpty().AsEnumerable()
                   where p.Deleted != true && p.Published == true
                   select new
                   {
                       Name = p.Name,
                       Sku = p.Sku,
                       ManufacturerPartNumber = p.ManufacturerPartNumber,
                       MolecularWeight = p.MolecularWeight,
                       BatchNo = inv.BatchNo,
                       Qty = inv.Qty,
                       ReTestDate = inv.ReTestDate,
                       COAPath = inv.COAPath,
                       StdDataPath = inv.StdDataPath,
                       AddDataPath = inv.AddDataPath,
                       Remarks = inv.Remarks
                   }).ToList();
            gv.DataBind();
            Response.ClearContent();
            Response.Buffer = true;
            Response.AddHeader("content-disposition", "attachment; filename=inventory" + DateTime.Now.Year + DateTime.Now.ToString("MM") + DateTime.Now.ToString("dd") + ".xls");
            Response.ContentType = "application/ms-excel";
            Response.Charset = "";
            StringWriter sw = new StringWriter();
            HtmlTextWriter htw = new HtmlTextWriter(sw);
            gv.RenderControl(htw);

            string passstr = sw.ToString().Replace(" 00:00:00", "");

            Response.Output.Write(passstr);
            Response.Flush();
            Response.End();
            return RedirectToAction("Inventory");
        }

        public ActionResult ExportPriceList()
        {
            string sidx = "";
            string sord = "";
            int page = 1;
            int rows = 0;

            string searchString = "";
            string searchField = "";
            int pageIndex = Convert.ToInt32(page) - 1;
            int pageSize = rows;

            //change logic start
            System.Web.UI.WebControls.GridView gv = new System.Web.UI.WebControls.GridView();
            gv.DataSource = (
                from c in db.Categories
                join cp in db.Product_Category_Mapping on c.Id equals cp.CategoryId
                join p in db.Products on cp.ProductId equals p.Id
                join i in db.SZ_Inventory on p.Id equals i.ProductId into ps
                from inv in ps.DefaultIfEmpty().AsEnumerable()
                join pr in db.SZ_Price on p.Id equals pr.ProductId into pris
                from pri in pris.DefaultIfEmpty()
                join cpCat in db.SZ_Category_Price on pri.CategoryPriceId equals cpCat.Id
                 into cptb
                from cpp in cptb.DefaultIfEmpty()
                where p.Deleted != true && p.Published == true
                select new InventoryModel
                {
                    Name = p.Name,
                    Sku = p.Sku,
                    Qty = inv.Qty,
                    INRPrice = cpp.Pricing,
                    USDPrice = pri.USDPrice,
                    LeadTime = pri.LeadTime,
                    Category = cpp.Category
                }).ToList();
            gv.DataBind();
            Response.ClearContent();
            Response.Buffer = true;
            Response.AddHeader("content-disposition", "attachment; filename=price" + DateTime.Now.Year + DateTime.Now.ToString("MM") + DateTime.Now.ToString("dd") + ".xls");
            Response.ContentType = "application/ms-excel";
            Response.Charset = "";
            StringWriter sw = new StringWriter();
            HtmlTextWriter htw = new HtmlTextWriter(sw);
            gv.RenderControl(htw);

            string passstr = sw.ToString().Replace(" 00:00:00", "");

            Response.Output.Write(passstr);
            Response.Flush();
            Response.End();
            return RedirectToAction("Price");
        }

        public ActionResult ExportProjectLists()
        {
            if (SessionCookieManagement.UserEmail != "sagar@synzeal.com"
                && SessionCookieManagement.UserEmail != "rajen@synzeal.com")
            {
                return RedirectToAction("Project");
            }
            int page = 1;
            int rows = 0;
            int pageIndex = Convert.ToInt32(page) - 1;
            int pageSize = rows;
            string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.Purchase);
            string purSynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);

            string instockProjectType = Convert.ToString((int)EnumList.ProjectType.InStock);
            // Getting all Customer data  
            var model = _operationRepository.LoadProjectData();
            MemoryCacheManager objCache = new MemoryCacheManager();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });

            var scienList = objCache.Get("cache.GetScientistId", () =>
            {
                return db.GetScientistId().ToList();
            });

            var subscienList = objCache.Get("cache.subscienList", () =>
            {
                return db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();
            });

            var listItems = new List<SelectListItem>();

            scienList.ForEach(term =>
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                listItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.ToString()
                });
            });
            //change logic start
            System.Web.UI.WebControls.GridView gv = new System.Web.UI.WebControls.GridView();
            gv.DataSource = (from t2 in model
                             select new
                             {
                                 PONumber = t2.SZ_Quotation.PONo,
                                 CompanyName = t2.SZ_Quotation.CompanyName,
                                 ProductName = t2.ProductName,
                                 CASNo = t2.CASNo,
                                 CATNo = t2.CATNo,
                                 Qty = t2.RequiredQty,
                                 Activity = t2.ActivityStatus,
                                 DataRemark = t2.Remark,
                                 Reason = t2.Reason,
                                 OrderRemark = t2.OrderRemark
                             }).ToList();
            gv.DataBind();
            Response.ClearContent();
            Response.Buffer = true;
            Response.AddHeader("content-disposition", "attachment; filename=Domestic-Instock-" + DateTime.Now.Year + DateTime.Now.ToString("MM") + DateTime.Now.ToString("dd") + ".xls");
            Response.ContentType = "application/ms-excel";
            Response.Charset = "";
            StringWriter sw = new StringWriter();
            HtmlTextWriter htw = new HtmlTextWriter(sw);
            gv.RenderControl(htw);
            string passstr = sw.ToString().Replace(" 00:00:00", "");
            Response.Output.Write(passstr);
            Response.Flush();
            Response.End();
            return RedirectToAction("Project");
        }
        public ActionResult ExportProjectDomesticinstockList()
        {
            if (SessionCookieManagement.UserEmail != "sagar@synzeal.com"
                && SessionCookieManagement.UserEmail != "rajen@synzeal.com")
            {
                return RedirectToAction("Project");
            }
            int page = 1;
            int rows = 0;
            int pageIndex = Convert.ToInt32(page) - 1;
            int pageSize = rows;
            string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.Purchase);
            string purSynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);

            string instockProjectType = Convert.ToString((int)EnumList.ProjectType.InStock);

            // Getting all Customer data  
            var model = (from i in db.SZ_Quotation
                         join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                         where (t2.MoveToProject == true) && string.IsNullOrEmpty(t2.TrackingNo) && (t2.IsOnHold == false || t2.IsOnHold == null)
                         && (t2.ProjectType == instockProjectType)
                         && i.CountryTypeId == 1
                         orderby t2.MoveProjectDate descending
                         select t2).Distinct(); MemoryCacheManager objCache = new MemoryCacheManager();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });

            var scienList = objCache.Get("cache.GetScientistId", () =>
            {
                return db.GetScientistId().ToList();
            });

            var subscienList = objCache.Get("cache.subscienList", () =>
            {
                return db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();
            });

            var listItems = new List<SelectListItem>();

            scienList.ForEach(term =>
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                listItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.ToString()
                });
            });
            //change logic start
            System.Web.UI.WebControls.GridView gv = new System.Web.UI.WebControls.GridView();
            gv.DataSource = (from t2 in model
                             select new
                             {
                                 PONumber = t2.SZ_Quotation.PONo,
                                 CompanyName = t2.SZ_Quotation.CompanyName,
                                 ProductName = t2.ProductName,
                                 CASNo = t2.CASNo,
                                 CATNo = t2.CATNo,
                                 Qty = t2.RequiredQty,
                                 Activity = t2.ActivityStatus,
                                 DataRemark = t2.Remark,
                                 Reason = t2.Reason,
                                 OrderRemark = t2.OrderRemark
                             }).ToList();
            gv.DataBind();
            Response.ClearContent();
            Response.Buffer = true;
            Response.AddHeader("content-disposition", "attachment; filename=Domestic-Instock-" + DateTime.Now.Year + DateTime.Now.ToString("MM") + DateTime.Now.ToString("dd") + ".xls");
            Response.ContentType = "application/ms-excel";
            Response.Charset = "";
            StringWriter sw = new StringWriter();
            HtmlTextWriter htw = new HtmlTextWriter(sw);
            gv.RenderControl(htw);
            string passstr = sw.ToString().Replace(" 00:00:00", "");
            Response.Output.Write(passstr);
            Response.Flush();
            Response.End();
            return RedirectToAction("Project");
        }

        public ActionResult ExportProjectInvoiceExportList(string parameter, string fltactivity, string fltexportprostatusItem)
        {
            int page = 1;
            int rows = 0;
            int pageIndex = Convert.ToInt32(page) - 1;
            int pageSize = rows;
            string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.Purchase);
            string purSynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);

            var model = (from i in db.SZ_Quotation
                         join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                         where t2.MoveToProject == true
                         && string.IsNullOrEmpty(t2.TrackingNo)
                         && (t2.IsOnHold == false || t2.IsOnHold == null)
                         && (t2.ProjectType != inhouseProjectType || t2.ProjectType == null)
                         && i.CountryTypeId == 2
                         orderby t2.MoveProjectDate descending
                         select t2).Distinct();
            MemoryCacheManager objCache = new MemoryCacheManager();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });

            var scienList = objCache.Get("cache.GetScientistId", () =>
            {
                return db.GetScientistId().ToList();
            });

            var listItems = new List<SelectListItem>();

            scienList.ForEach(term =>
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                listItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.ToString()
                });
            });

            if (!string.IsNullOrEmpty(fltexportprostatusItem))
            {
                model = model.Where(x => x.ProStatus == fltexportprostatusItem).AsQueryable();
            }

            if (!string.IsNullOrEmpty(fltactivity))
            {
                model = model.Where(x => x.ActivityStatus == fltactivity).AsQueryable();
            }
            if (!string.IsNullOrEmpty(parameter))
            {
                parameter = parameter.ToLower().Trim();
                model = model.Where(m => (m.SZ_Quotation.CompanyName != null && m.SZ_Quotation.CompanyName.ToLower().Contains(parameter))).AsQueryable();
            }
            var dfatas = model.ToList();
            //change logic start
            System.Web.UI.WebControls.GridView gv = new System.Web.UI.WebControls.GridView();
            var listdata = (from t2 in dfatas
                            select new
                            {
                                DataApprovedCount = t2.SZ_Quotation.SZ_QuotationDetail.Where(x => x.MoveToProject == true && x.ActivityStatus == "Data Approved").Count(),
                                MovetoProjectCount = t2.SZ_Quotation.SZ_QuotationDetail.Where(x => x.MoveToProject == true).Count(),
                                PONo = t2.SZ_Quotation.PONo,
                                Date = t2.PurchaseDate.HasValue ? t2.PurchaseDate.Value.ToShortDateString() : "",
                                CompanyName = t2.SZ_Quotation.CompanyName,
                                PurchaseStatus = t2.PurchaseDDLStatus,
                                ScientistName = listItems.Where(x => x.Value == Convert.ToString(t2.ScientistCustomerId)).Select(x => x.Text).FirstOrDefault(),
                                ProductName = t2.ProductName,
                                CASNo = t2.CASNo,
                                CATNo = t2.CATNo,
                                Qty = t2.RequiredQty,
                                //DataRemark = t2.Remark,
                                ESTDate = t2.EstimateCompleteDate,
                                Summary = t2.PurchaseStatus,
                                PurchaseRemark = t2.PurchaseRemark,
                                Reason = t2.Reason
                            }).ToList();

            gv.DataSource = listdata.Where(x => x.DataApprovedCount == x.MovetoProjectCount).ToList();
            gv.DataBind();
            Response.ClearContent();
            Response.Buffer = true;
            Response.AddHeader("content-disposition", "attachment; filename=Purchase" + DateTime.Now.Year + DateTime.Now.ToString("MM") + DateTime.Now.ToString("dd") + ".xls");
            Response.ContentType = "application/ms-excel";
            Response.Charset = "";
            StringWriter sw = new StringWriter();
            HtmlTextWriter htw = new HtmlTextWriter(sw);
            gv.RenderControl(htw);
            string passstr = sw.ToString().Replace(" 00:00:00", "");
            Response.Output.Write(passstr);
            Response.Flush();
            Response.End();
            return RedirectToAction("Purchase");
        }


        public ActionResult ExportProjectExportList(string parameter, string fltactivity, string fltexportprostatusItem)
        {
            int page = 1;
            int rows = 0;
            int pageIndex = Convert.ToInt32(page) - 1;
            int pageSize = rows;
            string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.Purchase);
            string purSynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);

            var model = (from i in db.SZ_Quotation
                         join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                         where t2.MoveToProject == true
                         && string.IsNullOrEmpty(t2.TrackingNo)
                         && (t2.IsOnHold == false || t2.IsOnHold == null)
                         && (t2.ProjectType != inhouseProjectType || t2.ProjectType == null)
                         && i.CountryTypeId == 2
                         orderby t2.MoveProjectDate descending
                         select t2).Distinct();
            MemoryCacheManager objCache = new MemoryCacheManager();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });

            var scienList = objCache.Get("cache.GetScientistId", () =>
            {
                return db.GetScientistId().ToList();
            });

            var listItems = new List<SelectListItem>();

            scienList.ForEach(term =>
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                listItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.ToString()
                });
            });

            if (!string.IsNullOrEmpty(fltexportprostatusItem))
            {
                model = model.Where(x => x.ProStatus == fltexportprostatusItem).AsQueryable();
            }

            if (!string.IsNullOrEmpty(fltactivity))
            {
                model = model.Where(x => x.ActivityStatus == fltactivity).AsQueryable();
            }
            if (!string.IsNullOrEmpty(parameter))
            {
                parameter = parameter.ToLower().Trim();
                model = model.Where(m => (m.SZ_Quotation.CompanyName != null && m.SZ_Quotation.CompanyName.ToLower().Contains(parameter))).AsQueryable();
            }
            var dfatas = model.ToList();
            //change logic start
            System.Web.UI.WebControls.GridView gv = new System.Web.UI.WebControls.GridView();
            gv.DataSource = (from t2 in dfatas
                             select new
                             {
                                 PONo = t2.SZ_Quotation.PONo,
                                 Date = t2.PurchaseDate.HasValue ? t2.PurchaseDate.Value.ToShortDateString() : "",
                                 CompanyName = t2.SZ_Quotation.CompanyName,
                                 PurchaseStatus = t2.PurchaseDDLStatus,
                                 ScientistName = listItems.Where(x => x.Value == Convert.ToString(t2.ScientistCustomerId)).Select(x => x.Text).FirstOrDefault(),
                                 ProductName = t2.ProductName,
                                 CASNo = t2.CASNo,
                                 CATNo = t2.CATNo,
                                 Qty = t2.RequiredQty,
                                 //DataRemark = t2.Remark,
                                 ESTDate = t2.EstimateCompleteDate,
                                 Summary = t2.PurchaseStatus,
                                 PurchaseRemark = t2.PurchaseRemark,
                                 Reason = t2.Reason
                             }).ToList();
            gv.DataBind();
            Response.ClearContent();
            Response.Buffer = true;
            Response.AddHeader("content-disposition", "attachment; filename=Purchase" + DateTime.Now.Year + DateTime.Now.ToString("MM") + DateTime.Now.ToString("dd") + ".xls");
            Response.ContentType = "application/ms-excel";
            Response.Charset = "";
            StringWriter sw = new StringWriter();
            HtmlTextWriter htw = new HtmlTextWriter(sw);
            gv.RenderControl(htw);
            string passstr = sw.ToString().Replace(" 00:00:00", "");
            Response.Output.Write(passstr);
            Response.Flush();
            Response.End();
            return RedirectToAction("Purchase");
        }

        public ActionResult ExportProjectPurchaseList()
        {
            int page = 1;
            int rows = 0;
            int pageIndex = Convert.ToInt32(page) - 1;
            int pageSize = rows;
            string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.Purchase);
            string purSynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);

            var model = (from i in db.SZ_Quotation
                         join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                         where string.IsNullOrEmpty(t2.TrackingNo)
                         && (t2.ProjectType == inhouseProjectType || t2.ProjectType == purSynthesisProjectType)
                         && (t2.IsOnHold == false || t2.IsOnHold == null)
                         orderby t2.PurchaseDate descending
                         select t2).OrderByDescending(x => x.PurchaseDate).Distinct().ToList();
            MemoryCacheManager objCache = new MemoryCacheManager();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });

            var scienList = objCache.Get("cache.GetScientistId", () =>
            {
                return db.GetScientistId().ToList();
            });

            var listItems = new List<SelectListItem>();

            scienList.ForEach(term =>
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                listItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.ToString()
                });
            });
            //change logic start
            System.Web.UI.WebControls.GridView gv = new System.Web.UI.WebControls.GridView();
            gv.DataSource = (from t2 in model
                             select new
                             {
                                 Date = t2.PurchaseDate.HasValue ? t2.PurchaseDate.Value.ToShortDateString() : "",
                                 CompanyName = t2.SZ_Quotation.CompanyName,
                                 PurchaseStatus = t2.PurchaseDDLStatus,
                                 ScientistName = listItems.Where(x => x.Value == Convert.ToString(t2.ScientistCustomerId)).Select(x => x.Text).FirstOrDefault(),
                                 ProductName = t2.ProductName,
                                 CASNo = t2.CASNo,
                                 CATNo = t2.CATNo,
                                 Qty = t2.RequiredQty,
                                 //DataRemark = t2.Remark,
                                 ESTDate = t2.EstimateCompleteDate,
                                 Summary = t2.PurchaseStatus,
                                 PurchaseRemark = t2.PurchaseRemark,
                                 Reason = t2.Reason
                             }).ToList();
            gv.DataBind();
            Response.ClearContent();
            Response.Buffer = true;
            Response.AddHeader("content-disposition", "attachment; filename=Purchase" + DateTime.Now.Year + DateTime.Now.ToString("MM") + DateTime.Now.ToString("dd") + ".xls");
            Response.ContentType = "application/ms-excel";
            Response.Charset = "";
            StringWriter sw = new StringWriter();
            HtmlTextWriter htw = new HtmlTextWriter(sw);
            gv.RenderControl(htw);
            string passstr = sw.ToString().Replace(" 00:00:00", "");
            Response.Output.Write(passstr);
            Response.Flush();
            Response.End();
            return RedirectToAction("Purchase");
        }


        public ActionResult ExportProjectPurchaseRFQList()
        {
            int page = 1;
            int rows = 0;
            int pageIndex = Convert.ToInt32(page) - 1;
            int pageSize = rows;

            var model = (from i in db.SZ_PurchaseRFQ
                         orderby i.CreatedDate descending
                         select i).Distinct();

            //change logic start
            System.Web.UI.WebControls.GridView gv = new System.Web.UI.WebControls.GridView();
            gv.DataSource = (from t2 in model
                             select new
                             {
                                 PurchaseStatus = t2.PurchaseStatus,
                                 AssDate = t2.AssignedDate.HasValue ? t2.AssignedDate.Value.ToShortDateString() : "",
                                 ChemicalName = t2.ChemicalName,
                                 CASNo = t2.CASNo,
                                 CATNo = t2.CATNo,
                                 Comment = t2.Comment,
                                 Summary = t2.Summary,
                                 EstDate = t2.Estdate.HasValue ? t2.Estdate.Value.ToShortDateString() : "",
                                 PurchaseRemark = t2.PurchaseRemark
                             }).ToList();
            gv.DataBind();
            Response.ClearContent();
            Response.Buffer = true;
            Response.AddHeader("content-disposition", "attachment; filename=PurchaseRfq" + DateTime.Now.Year + DateTime.Now.ToString("MM") + DateTime.Now.ToString("dd") + ".xls");
            Response.ContentType = "application/ms-excel";
            Response.Charset = "";
            StringWriter sw = new StringWriter();
            HtmlTextWriter htw = new HtmlTextWriter(sw);
            gv.RenderControl(htw);
            string passstr = sw.ToString().Replace(" 00:00:00", "");
            Response.Output.Write(passstr);
            Response.Flush();
            Response.End();
            return RedirectToAction("Purchase");
        }

        public string GetPurchaseStatusDDLName(string status)
        {
            string str = string.Empty;
            foreach (EnumList.PurchaseStatusDDL r in Enum.GetValues(typeof(EnumList.PurchaseStatusDDL)))
            {
                var item = Enum.GetName(typeof(EnumList.PurchaseStatusDDL), r);
                var test = r.ToString();
                string text = SZ_Helper.GetEnumDescription((EnumList.PurchaseStatusDDL)(int)r);
                int val = (int)r;
                if (val.ToString() == status)
                {
                    str = text;
                }
            }

            return str;
        }

        public ActionResult ExportPurchaseList()
        {
            int page = 1;
            int rows = 0;
            int pageIndex = Convert.ToInt32(page) - 1;
            int pageSize = rows;
            string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.Purchase);
            string purSynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);

            var model = (from i in db.SZ_Quotation
                         join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                         where string.IsNullOrEmpty(t2.TrackingNo)
                         && (t2.ProjectType == inhouseProjectType || t2.ProjectType == purSynthesisProjectType)
                         && (t2.IsOnHold == false || t2.IsOnHold == null)
                         orderby t2.PurchaseDate descending
                         select t2).OrderByDescending(x => x.PurchaseDate).Distinct().ToList();

            //change logic start
            System.Web.UI.WebControls.GridView gv = new System.Web.UI.WebControls.GridView();
            gv.DataSource = (from t2 in model
                             select new
                             {
                                 Date = t2.PurchaseDate.HasValue ? t2.PurchaseDate.Value.ToShortDateString() : "",
                                 PurchaseStatus = GetPurchaseStatusDDLName(t2.PurchaseDDLStatus),
                                 PONo = t2.SZ_Quotation.PONo,
                                 ProductName = t2.ProductName,
                                 CASNo = t2.CASNo,
                                 CATNo = t2.CATNo,
                                 Qty = t2.RequiredQty,
                                 DataRemark = t2.Remark,
                                 ESTDate = t2.EstimateCompleteDate,
                                 Status = t2.PurchaseStatus,
                                 PurchaseRemark = t2.PurchaseRemark,
                                 Reason = t2.Reason
                             }).ToList();
            gv.DataBind();
            Response.ClearContent();
            Response.Buffer = true;
            Response.AddHeader("content-disposition", "attachment; filename=Purchase" + DateTime.Now.Year + DateTime.Now.ToString("MM") + DateTime.Now.ToString("dd") + ".xls");
            Response.ContentType = "application/ms-excel";
            Response.Charset = "";
            StringWriter sw = new StringWriter();
            HtmlTextWriter htw = new HtmlTextWriter(sw);
            gv.RenderControl(htw);
            string passstr = sw.ToString().Replace(" 00:00:00", "");
            Response.Output.Write(passstr);
            Response.Flush();
            Response.End();
            return RedirectToAction("Purchase");
        }

        public ActionResult ExportDispatchList()
        {
            int page = 1;
            int rows = 0;
            int pageIndex = Convert.ToInt32(page) - 1;
            int pageSize = rows;

            //change logic start
            System.Web.UI.WebControls.GridView gv = new System.Web.UI.WebControls.GridView();
            gv.DataSource = (from sp in db.SZ_Project
                             join spd in db.SZ_ProjectDetail on sp.Id equals spd.ProjectId into ps
                             from spdd in ps.DefaultIfEmpty()
                             join p in db.Products on spdd.ProductId equals p.Id into pss
                             from pd in pss.DefaultIfEmpty()
                             join i in db.SZ_Inventory on spdd.BatchId equals i.Id into inv
                             from invc in inv.DefaultIfEmpty()
                             where pd.Deleted != true && pd.Published == true && spdd.Status == "Ready for dispatch"
                             select new
                             {
                                 PONo = sp.PONo,
                                 ScheduleDispatch = spdd.ScheduleDispatch,
                                 Name = pd.Name,
                                 LabelRequirement = spdd.LabelRequirement,
                                 Sku = pd.Sku,
                                 BatchNo = invc.BatchNo,
                                 Scientist = spdd.Scientist,
                                 PackSize = spdd.PackSize,
                                 NoOfPack = spdd.NoOfPack,
                                 Qty = invc.Qty,
                                 Status = spdd.Status,
                                 DataRequired = spdd.DataRequired,
                                 Remarks = invc.Remarks
                             }).ToList();
            gv.DataBind();
            Response.ClearContent();
            Response.Buffer = true;
            Response.AddHeader("content-disposition", "attachment; filename=Dispatch" + DateTime.Now.Year + DateTime.Now.ToString("MM") + DateTime.Now.ToString("dd") + ".xls");
            Response.ContentType = "application/ms-excel";
            Response.Charset = "";
            StringWriter sw = new StringWriter();
            HtmlTextWriter htw = new HtmlTextWriter(sw);
            gv.RenderControl(htw);

            string passstr = sw.ToString().Replace(" 00:00:00", "");
            Response.Output.Write(passstr);
            Response.Flush();
            Response.End();
            return RedirectToAction("Dispatch");
        }

        public ActionResult ExportInvoiceList()
        {
            int page = 1;
            int rows = 0;
            int pageIndex = Convert.ToInt32(page) - 1;
            int pageSize = rows;
            //change logic start
            System.Web.UI.WebControls.GridView gv = new System.Web.UI.WebControls.GridView();
            gv.DataSource = (from sp in db.SZ_Project
                             join spd in db.SZ_ProjectDetail on sp.Id equals spd.ProjectId into ps
                             from spdd in ps.DefaultIfEmpty()
                             join p in db.Products on spdd.ProductId equals p.Id into pss
                             from pd in pss.DefaultIfEmpty()
                             join i in db.SZ_Inventory on spdd.BatchId equals i.Id into inv
                             from invc in inv.DefaultIfEmpty()
                             join invss in db.SZ_Invoice on spdd.Id equals invss.ProjectDetailsId into invcs
                             from invoice in invcs.DefaultIfEmpty()
                             where pd.Deleted != true && pd.Published == true && spdd.Status == "Ready For Invoice"
                             select new
                             {
                                 PODate = sp.PODate,
                                 PONo = sp.PONo,
                                 DispatchDate = invoice.DispatchDate,
                                 Company = sp.Company,
                                 Name = pd.Name,
                                 LabelRequirement = spdd.LabelRequirement,
                                 Sku = pd.Sku,
                                 PackSize = spdd.PackSize,
                                 NoOfPack = spdd.NoOfPack,
                                 Qty = invc.Qty,
                                 BasicValue = invoice.BasicValue,
                                 InvoiceNo = invoice.InvoiceNo,
                                 Remarks = invc.Remarks
                             }).ToList();
            gv.DataBind();
            Response.ClearContent();
            Response.Buffer = true;
            Response.AddHeader("content-disposition", "attachment; filename=Invoice" + DateTime.Now.Year + DateTime.Now.ToString("MM") + DateTime.Now.ToString("dd") + ".xls");
            Response.ContentType = "application/ms-excel";
            Response.Charset = "";
            StringWriter sw = new StringWriter();
            HtmlTextWriter htw = new HtmlTextWriter(sw);
            gv.RenderControl(htw);

            string passstr = sw.ToString().Replace(" 00:00:00", "");

            Response.Output.Write(passstr);
            Response.Flush();
            Response.End();
            return RedirectToAction("Invoice");
        }

        [HttpPost]
        public JsonResult ExportDispatchList(List<int> id)
        {
            System.Web.UI.WebControls.GridView gv = new System.Web.UI.WebControls.GridView();

            var data = (from i in db.SZ_Quotation
                        join p in db.SZ_QuotationDetail on i.Id equals p.QuoteId
                        where p.MoveToDispatch == true && (p.MoveToInvoice == false || p.MoveToInvoice == null)
                        && id.Contains(p.Id)
                        orderby p.MoveDispatchDate descending
                        select new
                        {
                            ProductId = p.ProductId,
                            Name = p.ProductName,
                            CatNo = p.CATNo,
                            CasNo = p.CASNo,
                            Qty = p.RequiredQty,
                            AdditionalBatchNo = p.AdditionalBatchNo,
                            BatchNo = "",
                            Barcode = "",
                            PONo = i.PONo
                        }).ToList();

            List<ExportDispatchModel> model = new List<ExportDispatchModel>();

            foreach (var item in data)
            {
                ExportDispatchModel obj = new ExportDispatchModel();
                obj.ProductName = item.Name;
                obj.Qty = item.Qty;
                obj.CASNo = item.CasNo;
                obj.CATNo = item.CatNo;
                var proData = db.Products.Where(x => x.Id == item.ProductId && x.Published == true && x.Deleted == false).Count();
                var proBatchData = db.SZ_Inventory.Where(x => x.ProductId == item.ProductId).ToList();
                if (proBatchData.Count > 0 && proData > 0)
                {

                    var compData = db.SZ_CompanyList.ToList();
                    foreach (var term in proBatchData)
                    {
                        if (item.AdditionalBatchNo == term.Id)
                        {
                            obj.BatchNo = term.BatchNo;
                        }
                    }
                }
                obj.Barcode = "https://www.synzeal.com/search?q=" + item.CatNo;
                obj.PONo = item.PONo;
                model.Add(obj);
            }

            gv.DataSource = model;
            gv.DataBind();
            Response.ClearContent();
            Response.Buffer = true;
            Response.AddHeader("content-disposition", "attachment; filename=RecentAddition" + DateTime.Now.Year + DateTime.Now.ToString("MM") + DateTime.Now.ToString("dd") + ".xls");
            Response.ContentType = "application/ms-excel";
            Response.Charset = "";
            StringWriter sw = new StringWriter();
            HtmlTextWriter htw = new HtmlTextWriter(sw);
            gv.RenderControl(htw);

            string passstr = sw.ToString().Replace(" 00:00:00", "");

            string filePath = Server.MapPath("~/Content/ExportExcel/");
            string fileName = "Dispatch_" + DateTime.Now.Year + DateTime.Now.ToString("MM") + DateTime.Now.ToString("dd") + ".xls";

            // Write the rendered content to a file.
            System.IO.File.WriteAllText(filePath + fileName, passstr);
            return Json("../Content/ExportExcel/" + fileName, JsonRequestBehavior.AllowGet);
        }

        public ActionResult ExportRecentAdditionList()
        {
            int page = 1;
            int rows = 0;
            int pageIndex = Convert.ToInt32(page) - 1;
            int pageSize = rows;
            //change logic start
            System.Web.UI.WebControls.GridView gv = new System.Web.UI.WebControls.GridView();
            gv.DataSource = (from c in db.Categories
                             join cp in db.Product_Category_Mapping on c.Id equals cp.CategoryId
                             join p in db.Products on cp.ProductId equals p.Id
                             join i in db.SZ_Inventory on p.Id equals i.ProductId
                             where p.Deleted != true && p.Published == true
                             select new
                             {
                                 Name = p.Name,
                                 Sku = p.Sku,
                                 ManufacturerPartNumber = p.ManufacturerPartNumber,
                                 MolecularWeight = p.MolecularWeight,
                                 BatchNo = i.BatchNo,
                                 Qty = i.Qty,
                                 ReTestDate = i.ReTestDate,
                                 Remarks = i.Remarks
                             }).ToList();
            gv.DataBind();
            Response.ClearContent();
            Response.Buffer = true;
            Response.AddHeader("content-disposition", "attachment; filename=RecentAddition" + DateTime.Now.Year + DateTime.Now.ToString("MM") + DateTime.Now.ToString("dd") + ".xls");
            Response.ContentType = "application/ms-excel";
            Response.Charset = "";
            StringWriter sw = new StringWriter();
            HtmlTextWriter htw = new HtmlTextWriter(sw);
            gv.RenderControl(htw);

            string passstr = sw.ToString().Replace(" 00:00:00", "");

            Response.Output.Write(passstr);
            Response.Flush();
            Response.End();
            return RedirectToAction("RecentAddition");
        }

        [HttpPost]
        public ActionResult UploadProject(FormCollection formCollection)
        {
            if (Request != null)
            {
                HttpPostedFileBase file = Request.Files["UploadedFile"];
                if ((file != null) && (file.ContentLength > 0) && !string.IsNullOrEmpty(file.FileName))
                {
                    string fileName = file.FileName;
                    string fileContentType = file.ContentType;
                    byte[] fileBytes = new byte[file.ContentLength];
                    var data = file.InputStream.Read(fileBytes, 0, Convert.ToInt32(file.ContentLength));
                    using (var package = new ExcelPackage(file.InputStream))
                    {
                        var currentSheet = package.Workbook.Worksheets;
                        var workSheet = currentSheet.First();
                        var noOfCol = workSheet.Dimension.End.Column;
                        var noOfRow = workSheet.Dimension.End.Row;
                        for (int rowIterator = 2; rowIterator <= noOfRow; rowIterator++)
                        {
                            if (workSheet.Cells[rowIterator, 1].Value == null)
                            {
                                break;
                            }
                            var user = new ExcelInventoryModel();
                            string pono = workSheet.Cells[rowIterator, 1].Value.ToString().Trim();
                            string company = workSheet.Cells[rowIterator, 2].Value.ToString();
                            string scheduleDispatch = Convert.ToString(workSheet.Cells[rowIterator, 3].Value);
                            string name = workSheet.Cells[rowIterator, 4].Value != null ? workSheet.Cells[rowIterator, 4].Value.ToString() : "";
                            string labelrequirement = workSheet.Cells[rowIterator, 5].Value != null ? workSheet.Cells[rowIterator, 5].Value.ToString() : "";
                            string sku = workSheet.Cells[rowIterator, 6].Value != null ? workSheet.Cells[rowIterator, 6].Value.ToString().Trim() : "";
                            string batchno = workSheet.Cells[rowIterator, 7].Value != null ? workSheet.Cells[rowIterator, 7].Value.ToString() : "";
                            string scientist = workSheet.Cells[rowIterator, 8].Value != null ? workSheet.Cells[rowIterator, 8].Value.ToString() : "";
                            string qty = workSheet.Cells[rowIterator, 9].Value != null ? workSheet.Cells[rowIterator, 9].Value.ToString() : "";
                            string status = workSheet.Cells[rowIterator, 10].Value != null ? workSheet.Cells[rowIterator, 10].Value.ToString() : "";
                            string remarks = workSheet.Cells[rowIterator, 11].Value != null ? workSheet.Cells[rowIterator, 11].Value.ToString() : "";

                            var project = db.SZ_Project.Where(x => x.PONo.Contains(pono)).FirstOrDefault();
                            if (project == null)
                            {
                                project = new SZ_Project();
                                project.PONo = pono;
                                project.Company = company;
                                project.Status = status;
                                project.CreatedDate = DateTime.Now;
                                db.SZ_Project.Add(project);
                                db.SaveChanges();

                                var product = db.Products.Where(x => x.Sku.Contains(sku) && x.Published == true && x.Deleted != true).FirstOrDefault();
                                if (product != null)
                                {
                                    var projectDetails = new SZ_ProjectDetail();
                                    projectDetails.ProjectId = project.Id;
                                    projectDetails.ProductId = product.Id;
                                    projectDetails.LabelRequirement = labelrequirement;
                                    projectDetails.Scientist = scientist;
                                    if (!string.IsNullOrEmpty(qty))
                                    {
                                        projectDetails.Qty = Convert.ToDecimal(qty);
                                    }
                                    projectDetails.Status = status;
                                    projectDetails.Remark = remarks;
                                    db.SZ_ProjectDetail.Add(projectDetails);
                                    db.SaveChanges();
                                }
                            }
                            else
                            {
                                project.Company = company;
                                project.Status = status;
                                db.Entry(project).State = EntityState.Modified;
                                db.SaveChanges();

                                var product = db.Products.Where(x => x.Sku == sku && x.Published == true && x.Deleted != true).FirstOrDefault();
                                if (product != null)
                                {
                                    var projectDetails = db.SZ_ProjectDetail.Where(x => x.ProjectId == project.Id && x.ProductId == product.Id).FirstOrDefault();
                                    if (projectDetails == null)
                                    {
                                        projectDetails = new SZ_ProjectDetail();
                                        projectDetails.ProjectId = project.Id;
                                        projectDetails.ProductId = product.Id;
                                        projectDetails.LabelRequirement = labelrequirement;
                                        projectDetails.Scientist = scientist;
                                        if (!string.IsNullOrEmpty(qty))
                                        {
                                            projectDetails.Qty = Convert.ToDecimal(qty);
                                        }
                                        projectDetails.Status = status;
                                        projectDetails.Remark = remarks;
                                        db.SZ_ProjectDetail.Add(projectDetails);
                                        db.SaveChanges();
                                    }
                                    else
                                    {
                                        projectDetails.LabelRequirement = labelrequirement;
                                        projectDetails.Scientist = scientist;
                                        if (!string.IsNullOrEmpty(qty))
                                        {
                                            projectDetails.Qty = Convert.ToDecimal(qty);
                                        }
                                        projectDetails.Status = status;
                                        projectDetails.Remark = remarks;
                                        db.Entry(projectDetails).State = EntityState.Modified;
                                        db.SaveChanges();
                                    }
                                }
                            }
                        }
                    }
                }
            }

            TempData["Message"] = "Excel import successfully.";
            return RedirectToAction("Project");
        }


        public byte[] PDFNopcomemrce(SZ_Quotation data)
        {
            byte[] bytes;
            using (var stream = new MemoryStream())
            {
                if (stream == null)
                    throw new ArgumentNullException("stream");

                var pageSize = PageSize.A4;
                var doc = new Document(pageSize);
                var pdfWriter = PdfWriter.GetInstance(doc, stream);
                doc.Open();

                //fonts

                var titleFont = FontFactory.GetFont("Tahoma");
                titleFont.SetStyle(iTextSharp.text.Font.BOLD);
                titleFont.Color = BaseColor.BLACK;
                titleFont.Size = 12;

                var font = FontFactory.GetFont("Tahoma");
                font.SetStyle(iTextSharp.text.Font.NORMAL);
                font.Color = BaseColor.BLACK;
                font.Size = 10;

                var boldfont = FontFactory.GetFont("Tahoma");
                boldfont.SetStyle(iTextSharp.text.Font.BOLD);
                boldfont.Color = BaseColor.BLACK;
                boldfont.Size = 11;

                #region Header
                //logo
                var logoPicture = Server.MapPath("~/img/logo.png");

                //header
                var headerTable = new PdfPTable(2);
                headerTable.RunDirection = PdfWriter.RUN_DIRECTION_LTR;
                headerTable.DefaultCell.Border = iTextSharp.text.Rectangle.NO_BORDER;

                //store info
                var storeUrl = "https://www.synzeal.com/";
                var anchor = new Anchor(storeUrl.Trim(new[] { '/' }), font);
                anchor.Reference = storeUrl;

                var cellHeader = new PdfPCell();
                cellHeader.ExtraParagraphSpace = 4;
                cellHeader.Phrase = new Phrase();
                cellHeader.Phrase.Add(new Phrase("SynZeal Research Private Ltd", titleFont));
                cellHeader.Phrase.Add(new Phrase(Environment.NewLine));
                cellHeader.Phrase.Add(new Phrase("Plot No. F, Shree Ganesh Industrial Estate,", font));
                cellHeader.Phrase.Add(new Phrase(Environment.NewLine));
                cellHeader.Phrase.Add(new Phrase("423/24/8, Mahagujarat Industrial Estate,", font));
                cellHeader.Phrase.Add(new Phrase(Environment.NewLine));
                cellHeader.Phrase.Add(new Phrase("Sarkhej-Bavla Road,Moraiya,Ahmedabad-382213", font));
                cellHeader.Phrase.Add(new Phrase(Environment.NewLine));
                cellHeader.Phrase.Add(new Phrase("Email:", boldfont));
                cellHeader.Phrase.Add(new Phrase("standards@synzeal.com", font));
                cellHeader.Phrase.Add(new Phrase(Environment.NewLine));
                cellHeader.Phrase.Add(new Phrase("Phone:", boldfont));
                cellHeader.Phrase.Add(new Phrase("+91-757-500-2050", font));
                cellHeader.Phrase.Add(new Phrase(Environment.NewLine));
                cellHeader.HorizontalAlignment = Element.ALIGN_LEFT;
                cellHeader.Border = iTextSharp.text.Rectangle.NO_BORDER;

                headerTable.AddCell(cellHeader);
                headerTable.SetWidths(new[] { 0.6f, 0.4f });
                headerTable.WidthPercentage = 100f;

                //logo               

                var logo = iTextSharp.text.Image.GetInstance(logoPicture);
                logo.Alignment = Element.ALIGN_LEFT;
                logo.ScaleToFit(200f, 200f);

                var cellLogo = new PdfPCell();
                cellLogo.Border = iTextSharp.text.Rectangle.NO_BORDER;
                cellLogo.AddElement(logo);
                headerTable.AddCell(cellLogo);

                doc.Add(headerTable);

                PdfPTable table = new PdfPTable(2);
                var cellHeaderBlank = new PdfPCell(new Phrase());
                cellHeaderBlank.Border = iTextSharp.text.Rectangle.NO_BORDER;
                cellHeaderBlank.Phrase.Add(new Phrase(Environment.NewLine));
                var color = new iTextSharp.text.BaseColor(System.Drawing.ColorTranslator.FromHtml("#A9A9A9"));
                DrawLine(pdfWriter, 20f, doc.Top - 92f, doc.PageSize.Width - 25f, doc.Top - 92f, color);
                table.AddCell(cellHeaderBlank);
                doc.Add(table);

                PdfPTable Firsttable = new PdfPTable(2);
                Firsttable.PaddingTop = 0;
                var cellQuote = new PdfPCell(new Phrase("Quote# : " + data.Ref, font));
                cellQuote.Border = iTextSharp.text.Rectangle.NO_BORDER;

                cellQuote.Phrase.Add(new Phrase(Environment.NewLine));
                cellQuote.Phrase.Add(new Phrase("Customer : " + data.SZ_CompanyList.Name, font));
                cellQuote.HorizontalAlignment = Element.ALIGN_LEFT;
                cellQuote.ExtraParagraphSpace = 4;
                Firsttable.AddCell(cellQuote);

                var celldate = new PdfPCell(new Phrase("Date : " + data.CreatedDate.Value.ToShortDateString(), font));
                celldate.ExtraParagraphSpace = 4;
                celldate.Border = iTextSharp.text.Rectangle.NO_BORDER;
                celldate.Phrase.Add(new Phrase(Environment.NewLine));
                celldate.HorizontalAlignment = Element.ALIGN_RIGHT;
                Firsttable.WidthPercentage = 100f;
                Firsttable.AddCell(celldate);
                doc.Add(Firsttable);

                PdfPTable secondlinetable = new PdfPTable(2);
                var celllineBlank = new PdfPCell(new Phrase());
                celllineBlank.Border = iTextSharp.text.Rectangle.NO_BORDER;
                celllineBlank.Phrase.Add(new Phrase(Environment.NewLine));
                var colorlimne = new iTextSharp.text.BaseColor(System.Drawing.ColorTranslator.FromHtml("#A9A9A9"));
                DrawLine(pdfWriter, 20f, doc.Top - 123f, doc.PageSize.Width - 25f, doc.Top - 123f, colorlimne);
                celllineBlank.Phrase.Add(new Phrase(Environment.NewLine));
                secondlinetable.AddCell(celllineBlank);
                doc.Add(secondlinetable);

                if (data.IsImageAttach)
                {
                    PdfPTable secondtable = new PdfPTable(3);
                    secondtable.PaddingTop = 0;
                    secondtable.WidthPercentage = 100f;
                    secondtable.SetWidths(new[] { 0.1f, 0.4f, 0.5f });
                    int srno = 1;
                    foreach (var item in data.SZ_QuotationDetail)
                    {
                        var cellinfo = new PdfPCell(new Phrase(srno.ToString(), font));
                        cellinfo.Border = iTextSharp.text.Rectangle.NO_BORDER;
                        cellinfo.HorizontalAlignment = Element.ALIGN_LEFT;
                        cellinfo.ExtraParagraphSpace = 4;
                        secondtable.AddCell(cellinfo);

                        if (item.ImagePath != null)
                        {
                            if (item.ImagePath.StartsWith("http"))
                            {
                                var proimage = iTextSharp.text.Image.GetInstance(new Uri(item.ImagePath));
                                proimage.Alignment = Element.ALIGN_LEFT;
                                proimage.ScaleToFit(200f, 200f);

                                var ProLogo = new PdfPCell();
                                ProLogo.Border = iTextSharp.text.Rectangle.NO_BORDER;
                                ProLogo.AddElement(proimage);
                                secondtable.AddCell(ProLogo);
                            }
                            else
                            {
                                var proimage = iTextSharp.text.Image.GetInstance(item.ImagePath);
                                proimage.Alignment = Element.ALIGN_LEFT;
                                proimage.ScaleToFit(200f, 200f);

                                var ProLogo = new PdfPCell();
                                ProLogo.Border = iTextSharp.text.Rectangle.NO_BORDER;
                                ProLogo.AddElement(proimage);
                                secondtable.AddCell(ProLogo);
                            }
                        }
                        else
                        {
                            var ProLogo = new PdfPCell();
                            ProLogo.Border = iTextSharp.text.Rectangle.NO_BORDER;
                            secondtable.AddCell(ProLogo);
                        }
                        var proinfo = new PdfPCell(new Phrase("Name : " + item.ProductName, font));
                        proinfo.Border = iTextSharp.text.Rectangle.NO_BORDER;
                        proinfo.Phrase.Add(new Phrase(Environment.NewLine));
                        proinfo.Phrase.Add(new Phrase("CAS# : " + item.CASNo, font));
                        proinfo.Phrase.Add(new Phrase(Environment.NewLine));
                        proinfo.Phrase.Add(new Phrase("Price : " + item.Price, font));
                        proinfo.Phrase.Add(new Phrase(Environment.NewLine));
                        proinfo.Phrase.Add(new Phrase("Lead Time : " + item.LeadTime, font));
                        proinfo.HorizontalAlignment = Element.ALIGN_LEFT;
                        proinfo.ExtraParagraphSpace = 4;
                        secondtable.AddCell(proinfo);
                        srno += 1;
                    }
                    doc.Add(secondtable);
                }
                else
                {
                    PdfPTable secondtable = new PdfPTable(5);
                    secondtable.PaddingTop = 0;
                    secondtable.WidthPercentage = 100f;
                    secondtable.SetWidths(new[] { 0.1f, 0.4f, 0.2f, 0.2f, 0.1f });
                    int srno = 1;
                    foreach (var item in data.SZ_QuotationDetail)
                    {
                        var cellinfo = new PdfPCell(new Phrase(srno.ToString(), font));
                        cellinfo.Border = iTextSharp.text.Rectangle.NO_BORDER;
                        cellinfo.HorizontalAlignment = Element.ALIGN_LEFT;
                        cellinfo.ExtraParagraphSpace = 4;
                        secondtable.AddCell(cellinfo);

                        var cellfirstinfo = new PdfPCell(new Phrase(item.ProductName, font));
                        cellfirstinfo.Border = iTextSharp.text.Rectangle.NO_BORDER;
                        cellfirstinfo.HorizontalAlignment = Element.ALIGN_LEFT;
                        cellfirstinfo.ExtraParagraphSpace = 4;
                        secondtable.AddCell(cellfirstinfo);

                        var cellsecondinfo = new PdfPCell(new Phrase(item.CASNo, font));
                        cellsecondinfo.Border = iTextSharp.text.Rectangle.NO_BORDER;
                        cellsecondinfo.HorizontalAlignment = Element.ALIGN_LEFT;
                        cellsecondinfo.ExtraParagraphSpace = 4;
                        secondtable.AddCell(cellsecondinfo);


                        var cellthirdinfo = new PdfPCell(new Phrase(item.Price, font));
                        cellthirdinfo.Border = iTextSharp.text.Rectangle.NO_BORDER;
                        cellthirdinfo.HorizontalAlignment = Element.ALIGN_LEFT;
                        cellthirdinfo.ExtraParagraphSpace = 4;
                        secondtable.AddCell(cellthirdinfo);

                        var cellforthinfo = new PdfPCell(new Phrase(item.LeadTime, font));
                        cellforthinfo.Border = iTextSharp.text.Rectangle.NO_BORDER;
                        cellforthinfo.HorizontalAlignment = Element.ALIGN_LEFT;
                        cellforthinfo.ExtraParagraphSpace = 4;
                        secondtable.AddCell(cellforthinfo);
                        srno += 1;
                    }
                    doc.Add(secondtable);
                }

                #region Terms

                var termsData = db.SZ_Terms.Where(x => x.Id == data.TermsId).FirstOrDefault();
                if (termsData != null)
                {
                    PdfPTable Termstable = new PdfPTable(1);
                    Termstable.WidthPercentage = 100f;

                    var TermstableBlank = new PdfPCell(new Phrase("Terms and Conditions", boldfont));
                    TermstableBlank.ExtraParagraphSpace = 4;
                    TermstableBlank.Border = iTextSharp.text.Rectangle.NO_BORDER;
                    Termstable.AddCell(TermstableBlank);
                    doc.Add(Termstable);




                    //make an arraylist ....with STRINGREADER since its no IO reading file...
                    var htmlarraylist = iTextSharp.text.html.simpleparser.HTMLWorker.ParseToList(new StringReader(termsData.Value), null);
                    //add the collection to the document
                    for (int k = 0; k < htmlarraylist.Count; k++)
                    {
                        if (htmlarraylist[k].Chunks.Count > 0)
                        {
                            foreach (var paragraphdetails in htmlarraylist[k].Chunks)
                            {
                                if (paragraphdetails != null)
                                {
                                    Paragraph mypara = new Paragraph(paragraphdetails.Content, paragraphdetails.Font.Size == 12 ? font : null);//make an emtphy paragraph as "holder"
                                    mypara.IndentationLeft = 0;
                                    doc.Add(mypara);
                                }
                            }
                        }
                    }
                }
                #endregion

                #endregion

                doc.Close();

                bytes = stream.ToArray();
            }
            return bytes;
        }

        public void DrawLine(PdfWriter writer, float x1, float y1, float x2, float y2, BaseColor color)
        {
            PdfContentByte contentByte = writer.DirectContent;
            contentByte.SetColorStroke(color);
            contentByte.MoveTo(x1, y1);
            contentByte.LineTo(x2, y2);
            contentByte.Stroke();
        }
        public string FixBrokenMarkup(string broken)
        {
            HtmlDocument h = new HtmlDocument()
            {
                OptionAutoCloseOnEnd = true,
                OptionFixNestedTags = true,
                OptionWriteEmptyNodes = true
            };
            h.LoadHtml(broken);

            // UPDATED to remove HtmlCommentNode
            var comments = h.DocumentNode.SelectNodes("//comment()");
            if (comments != null)
            {
                foreach (var node in comments) { node.Remove(); }
            }

            return h.DocumentNode.SelectNodes("child::*") != null
                //                            ^^^^^^^^^^
                // XPath above: string plain-text or contains markup/tags
                ? h.DocumentNode.WriteTo()
                : string.Format("<span>{0}</span>", broken);
        }
        public ReturnValue ConvertHtmlToPdfAsBytes(string HtmlData)
        {
            // variables  
            ReturnValue Result = new ReturnValue();

            // do some additional cleansing to handle some scenarios that are out of control with the html data  
            HtmlData = HtmlData.Replace("<br>", "<br />");

            // convert html to pdf  
            try
            {
                // create a stream that we can write to, in this case a MemoryStream  
                using (var stream = new MemoryStream())
                {
                    // create an iTextSharp Document which is an abstraction of a PDF but **NOT** a PDF  
                    using (var document = new Document())
                    {
                        // create a writer that's bound to our PDF abstraction and our stream  
                        using (var writer = PdfWriter.GetInstance(document, stream))
                        {
                            // open the document for writing  
                            document.Open();

                            string htmlcodestr = FixBrokenMarkup(HtmlData);
                            // read html data to StringReader  
                            using (var html = new StringReader(htmlcodestr))
                            {
                                XMLWorkerHelper.GetInstance().ParseXHtml(writer, document, html);
                            }

                            // close document  
                            document.Close();
                        }
                    }

                    // get bytes from stream  
                    Result.Data = stream.ToArray();

                    // success  
                    Result.Success = true;
                }
            }
            catch (Exception ex)
            {
                Result.Success = false;
                Result.Message = ex.Message;
            }

            // return  
            return Result;
        }
        public string ConvertHTMLToPDF(string HTMLCode, string refNo, bool waterark = false, bool isreturnfile = false, bool isLandscap = false)
        {
            refNo = refNo + "_" + DateTime.Now.ToString("yyyyMMddhhmmss");
            string WatermarkLocation = "https://www.synzeal.com/Themes/DefaultClean/Content/images/logo.png";

            //Render PlaceHolder to temporary stream
            System.IO.StringWriter stringWrite = new StringWriter();
            System.Web.UI.HtmlTextWriter htmlWrite = new HtmlTextWriter(stringWrite);

            /********************************************************************************/
            //Try adding source strings for each image in content
            string tempPostContent = HTMLCode;
            /*********************************************************************************/
            //string filePath = HostingEnvironment.MapPath("~/Content/Quotation/");
            string filePath = Server.MapPath("~/Content/Quotation/");

            try
            {
                StringReader html = new StringReader(HTMLCode);
                using (Document document = new Document())
                {
                    if (HTMLCode.Contains("logoattached"))
                    {
                        document.SetMargins(25f, 25f, 10f, 35f);
                    }
                    else
                    {
                        document.SetMargins(25f, 25f, 20f, 35f);
                        //document.SetMargins(25f, 25f, 48f, 35f);
                    }
                    if (isLandscap)
                    {
                        document.SetPageSize(iTextSharp.text.PageSize.A4.Rotate());
                    }
                    document.NewPage();
                    PdfWriter writer = PdfWriter.GetInstance(document, new FileStream(filePath + refNo + ".pdf", FileMode.Create));

                    document.Open();

                    var example_css = @"BODY{font: andalus !important}  h1{font: andalus !important}";
                    string fontFolderPath = Server.MapPath("~/fonts/");
                    int fontSize = 12;
                    BaseFont baseFont = BaseFont.CreateFont(fontFolderPath + "andlso.ttf", BaseFont.IDENTITY_H, BaseFont.NOT_EMBEDDED);
                    iTextSharp.text.Font font = new iTextSharp.text.Font(baseFont, 12, iTextSharp.text.Font.NORMAL, BaseColor.BLACK);

                    using (var msCss = new MemoryStream(System.Text.Encoding.UTF8.GetBytes(example_css)))
                    {
                        using (var msHtml = new MemoryStream(System.Text.Encoding.UTF8.GetBytes(HTMLCode)))
                        {

                            //Parse the HTML
                            iTextSharp.tool.xml.XMLWorkerHelper.GetInstance().ParseXHtml(writer, document, msHtml, msCss, new XMLWorkerFontProvider(Server.MapPath("~/fonts/")));
                        }
                    }
                    document.Close();

                    if (waterark)
                    {
                        string FileLocation = filePath + "\\" + refNo + ".pdf";
                        PdfReader pdfReader = new PdfReader(FileLocation);
                        PdfStamper stamp = new PdfStamper(pdfReader, new FileStream(FileLocation.Replace(".pdf", "[temp][file].pdf"), FileMode.Create));

                        iTextSharp.text.Image img = iTextSharp.text.Image.GetInstance(WatermarkLocation);
                        float w = img.ScaledWidth;
                        float h = img.ScaledHeight;

                        img.SetAbsolutePosition(125, 400);
                        // img.RotationDegrees = ((float)Math.PI / 2);

                        PdfContentByte waterMark;
                        iTextSharp.text.Rectangle pagesize;
                        float x, y;
                        for (int page = 1; page <= pdfReader.NumberOfPages; page++)
                        {
                            // get page size and position
                            pagesize = pdfReader.GetPageSizeWithRotation(page);
                            x = (pagesize.Left + pagesize.Right) / 2;
                            y = (pagesize.Top + pagesize.Bottom) / 2;
                            waterMark = stamp.GetOverContent(page);
                            waterMark.SaveState();

                            // set transparency
                            PdfGState state = new PdfGState();
                            state.FillOpacity = 0.2f;
                            waterMark.SetGState(state);
                            waterMark.AddImage(img);
                            waterMark.RestoreState();
                        }
                        stamp.FormFlattening = true;
                        stamp.Close();

                        return FileLocation.Replace(".pdf", "[temp][file].pdf");
                    }
                }
            }
            catch (Exception ex)
            {
                throw;
            }

            if (isreturnfile)
            {
                return "/Content/Quotation/" + refNo + ".pdf";
            }

            return filePath + "\\" + refNo + ".pdf";
        }

        public string getSrc(string input)
        {
            string pattern = "src=[\'|\"](.+?)[\'|\"]";
            System.Text.RegularExpressions.Regex reImg = new System.Text.RegularExpressions.Regex(pattern,
            System.Text.RegularExpressions.RegexOptions.IgnoreCase |

            System.Text.RegularExpressions.RegexOptions.Multiline);
            System.Text.RegularExpressions.Match mImg = reImg.Match(input);
            if (mImg.Success)
            {
                return mImg.Value.Replace("src=", "").Replace("\"", ""); ;
            }
            return string.Empty;
        }

        public ActionResult ClubQuote()
        {
            if (!SessionCookieManagement.IsAdmin)
            {
                return RedirectToAction("Index", "Home");
            }

            var model = (from i in db.SZ_ClubQuote
                         join t2 in db.SZ_QuotationDetail on i.QuotationDetailsId equals t2.Id
                         select t2).ToList();

            return View(model);
        }

        public ActionResult AddClubQuotation()
        {
            if (!SessionCookieManagement.IsAdmin)
            {
                return RedirectToAction("Index", "Home");
            }

            var listItems = new List<SelectListItem>();
            listItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var terms = db.SZ_Terms.ToList();
            foreach (var term in terms)
            {
                listItems.Add(new SelectListItem
                {
                    Text = term.Name,
                    Value = term.Id.ToString()
                });
            }

            ViewBag.termsList = listItems;


            var listCompItems = new List<SelectListItem>();
            listCompItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var compData = db.SZ_CompanyList.ToList();
            foreach (var term in compData)
            {
                listCompItems.Add(new SelectListItem
                {
                    Text = term.Name,
                    Value = term.Id.ToString()
                });
            }

            ViewBag.listCompItems = listCompItems;

            var model = new SZ_Quotation();
            return View(model);
        }

        public ActionResult MainDashboard()
        {
            if (!SessionCookieManagement.IsAdmin &&
                !SessionCookieManagement.IsInternational)
            {
                return RedirectToAction("Index", "Home");
            }

            var compmodel = new List<SZ_CompanyList>();
            if (SessionCookieManagement.IsInternational)
            {
                string internationcompanylist = db.SZ_UserManagement.Where(x => x.UserId == SessionCookieManagement.UserId).Select(x => x.CompanyIds).FirstOrDefault();
                if (!string.IsNullOrEmpty(internationcompanylist))
                {
                    List<int?> cidList = new List<int?>();
                    foreach (var item in internationcompanylist.Split(','))
                    {
                        if (!string.IsNullOrEmpty(item))
                        {
                            cidList.Add(Convert.ToInt32(item));
                        }
                    }
                    compmodel = db.SZ_CompanyList.Where(x => cidList.Contains(x.Id)).OrderBy(x => x.Name).ToList();
                }
            }
            else
            {
                compmodel = db.SZ_CompanyList.OrderBy(x => x.Name).ToList();
            }

            var listItems = new List<SelectListItem>();
            listItems.Add(new SelectListItem
            {
                Text = "All",
                Value = "0"
            });
            foreach (var term in compmodel)
            {
                listItems.Add(new SelectListItem
                {
                    Text = term.Name,
                    Value = term.Id.ToString()
                });
            }
            ViewBag.companyList = listItems;

            return View();
        }


        #region Project Screen
        public virtual List<SZ_QuotationProductModel> PrepareSZ_QuotationProductModel(Project_HoldTab_Result k, List<SZ_Inventory> inventoryData, IEnumerable<Product> productData, IEnumerable<SZ_ScientistStatus> scientistStatusData, IEnumerable<Customer> customerData, IEnumerable<GenericAttribute> genericData)
        {
            List<SZ_QuotationProductModel> obj = new List<SZ_QuotationProductModel>();
            SZ_QuotationProductModel objlist = new SZ_QuotationProductModel();
            objlist.QuoteDetailsId = k.QuoteDetailsId;
            objlist.CASNo = k.CASNo;
            objlist.CATNo = "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>";
            objlist.CreatedDate = k.CreatedDate;
            objlist.ImagePath = k.ImagePath;
            objlist.IsUploadServer = k.IsUploadServer;
            objlist.LeadTime = k.LeadTime;
            objlist.Price = k.Price;
            objlist.ProductId = k.ProductId;
            objlist.ProductName = k.ProductName;
            objlist.QuoteId = k.QuoteId;
            objlist.ProjectType = k.ProjectType;
            objlist.ScientistCustomerId = k.ScientistCustomerId;
            objlist.ScientistRemark = k.ScientistRemark;
            objlist.DifficultyLevel = k.DifficultyLevel;
            objlist.DifficultyLevelText = "";
            foreach (EnumList.DifficultyLevel r in Enum.GetValues(typeof(EnumList.DifficultyLevel)))
            {
                var item = Enum.GetName(typeof(EnumList.DifficultyLevel), r);
                var test = r.ToString();
                string text = SZ_Helper.GetEnumDescription((EnumList.DifficultyLevel)(int)r);
                int val = (int)r;
                if (Convert.ToString(val) == k.DifficultyLevel)
                {
                    objlist.DifficultyLevelText = text;
                }
            }
            if (k.ScientistCustomerId.HasValue)
            {
                string customerName = string.Empty;
                var customer = customerData.Where(x => x.Id == k.ScientistCustomerId && x.Deleted == false && x.Active == true).FirstOrDefault();
                if (customer != null)
                {
                    var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == customer.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                }
                objlist.ScientistName = customerName;
            }
            objlist.RequiredQty = k.RequiredQty;
            objlist.ProjectStatus = k.ProjectStatus;
            objlist.IsOnHold = k.IsOnHold;
            if (k.ProjectStatus != null)
            {
                objlist.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
            }
            objlist.ScientistStatus = k.ScientistStatus;
            objlist.EstimateCompleteDate = k.EstimateCompleteDate;
            objlist.BatchNo = k.BatchNo;
            objlist.AdditionalBatchNo = k.AdditionalBatchNo;
            if (k.AdditionalBatchNo.HasValue)
            {
                objlist.AdditionalBatchNoText = inventoryData.Where(x => x.Id == k.AdditionalBatchNo).Select(x => x.BatchNo).FirstOrDefault();
            }
            objlist.MoveToDispatch = k.MoveToDispatch;
            objlist.MoveToProject = k.MoveToProject;
            objlist.Remark = k.Remark;
            objlist.SrPo = k.SrPo;
            objlist.AdminScientistStatus = k.AdminScientistStatus;
            objlist.InvoiceNo = k.InvoiceNo;
            objlist.InvoiceRemark = k.InvoiceRemark;
            objlist.ReadyToDeliverScientistStatusId = scientistStatusData.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
            if (objlist.ProductId.HasValue)
            {
                objlist.ListBatchNo = new List<SelectListItem>();
                objlist.ListBatchNo.Add(new SelectListItem
                {
                    Text = "--Select--",
                    Value = ""
                });
                var proData = productData.Where(x => x.Id == objlist.ProductId && x.Published == true && x.Deleted == false).Count();
                var proBatchData = inventoryData.Where(x => x.ProductId == objlist.ProductId).ToList();
                if (proBatchData.Count > 0 && proData > 0)
                {
                    foreach (var term in proBatchData)
                    {
                        objlist.ListBatchNo.Add(new SelectListItem
                        {
                            Text = term.BatchNo + " (" + term.Qty + ")",
                            Value = term.Id.ToString(),
                            Selected = objlist.AdditionalBatchNo == term.Id ? true : false
                        });
                    }
                }
            }

            objlist.MoveProjectDate = k.MoveProjectDate;
            objlist.SubScientistName = k.SubScientistName;
            objlist.LastRaw = "<a href='javascript:void(0)' id='onhold_" + k.QuoteDetailsId + "' onclick='SetOnresume(\"" + k.QuoteDetailsId + "\")'>Resume</a>";
            objlist.CheckboxRaw = "<input type='checkbox' value='" + k.QuoteDetailsId + "' class='clsSaverow' />";
            if (k.EstimateCompleteDate.HasValue)
            {
                objlist.EstimateCompleteDateText = k.EstimateCompleteDate.Value.ToShortDateString();
            }
            if (k.MoveToScientistDate.HasValue)
            {
                objlist.MoveToScientistDateText = k.MoveToScientistDate.Value.ToShortDateString();
            }
            foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
            {
                var item = Enum.GetName(typeof(EnumList.ProjectType), r);
                var test = r.ToString();
                string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
                int val = (int)r;
                if (Convert.ToString(val) == k.ProjectType)
                {
                    objlist.ProjectType = text;
                }
            }
            objlist.Reason = k.Reason;
            obj.Add(objlist);
            return obj;
        }
        public ActionResult Project()
        {
            if (!SessionCookieManagement.IsAdmin && !SessionCookieManagement.IsProjectLogin
                && !SessionCookieManagement.IsInternational
                && !SessionCookieManagement.IsControlledSubstance
                && !SessionCookieManagement.IsGLP)
            {
                return RedirectToAction("Index", "Home");
            }

            MemoryCacheManager objCache = new MemoryCacheManager();
            var listItems = new List<SelectListItem>();
            var subscilistItems = new List<SelectListItem>();
            var prostatusItem = new List<SelectListItem>();
            var protypeItem = new List<SelectListItem>();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });
            var subscienList = objCache.Get("cache.subscienList", () =>
            {
                return db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();
            });
            var scienList = objCache.Get("cache.GetScientistId", () =>
            {
                return db.GetScientistId().ToList();
            });
            listItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            subscilistItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            prostatusItem.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            protypeItem.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            scienList.ForEach(term =>
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                listItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.ToString()
                });
                subscilistItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.ToString()
                });
            });

            ViewBag.ScientistListItem = listItems;

            foreach (var term in subscienList)
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == term.Id).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                subscilistItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.Id.ToString()
                });
            }
            ViewBag.SubScientistListItem = subscilistItems;

            prostatusItem.Add(new SelectListItem
            {
                Text = "Select Value",
                Value = "blank"
            });
            foreach (EnumList.ProStatusDDL r in Enum.GetValues(typeof(EnumList.ProStatusDDL)))
            {
                var item = Enum.GetName(typeof(EnumList.ProStatusDDL), r);
                var test = r.ToString();
                string text = SZ_Helper.GetEnumDescription((EnumList.ProStatusDDL)(int)r);
                int val = (int)r;
                prostatusItem.Add(new SelectListItem
                {
                    Text = text,
                    Value = val.ToString()
                });
            }
            ViewBag.fltprostatusItem = prostatusItem;

            foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
            {
                var item = Enum.GetName(typeof(EnumList.ProjectType), r);
                var test = r.ToString();
                string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
                int val = (int)r;
                protypeItem.Add(new SelectListItem
                {
                    Text = text,
                    Value = val.ToString()
                });
            }
            ViewBag.fltprotypeItem = protypeItem;

            string internationcompanylist = "";
            if (SessionCookieManagement.IsInternational)
            {
                internationcompanylist = db.SZ_UserManagement.Where(x => x.UserId == SessionCookieManagement.UserId).Select(x => x.CompanyIds).FirstOrDefault();
                if (!string.IsNullOrEmpty(internationcompanylist))
                {
                    List<int?> cidList = new List<int?>();
                    foreach (var item in internationcompanylist.Split(','))
                    {
                        if (!string.IsNullOrEmpty(item))
                        {
                            cidList.Add(Convert.ToInt32(item));
                        }
                    }

                    ViewBag.AllCount = (from i in db.SZ_Quotation
                                        join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                                        where t2.MoveToProject == true &&
                                              string.IsNullOrEmpty(t2.TrackingNo) &&
                                              (t2.IsOnHold == false || t2.IsOnHold == null) &&
                                              (t2.ProjectType != "5" || t2.ProjectType == null) &&
                                               cidList.Contains(i.CompanyId)
                                               && i.CreatedDate >= new DateTime(2022, 05, 01)
                                        select t2).Count();

                    ViewBag.InHouseCount = (from i in db.SZ_Quotation
                                            join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                                            where t2.MoveToProject == true &&
                                                  string.IsNullOrEmpty(t2.TrackingNo) &&
                                                  (t2.IsOnHold == false || t2.IsOnHold == null) &&
                                                  t2.ProjectType == "5" &&
                                                   cidList.Contains(i.CompanyId)
                                                   && i.CreatedDate >= new DateTime(2022, 05, 01)
                                            select t2).Count();

                    ViewBag.SynthesisCount = (from i in db.SZ_Quotation
                                              join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                                              where (t2.MoveToProject == true || t2.IsSynthesisLog == true) &&
                                                    string.IsNullOrEmpty(t2.TrackingNo) &&
                                                    (t2.IsOnHold == false || t2.IsOnHold == null) &&
                                                    (t2.ProjectType == "1" || t2.ProjectType == "2") &&
                                                    (t2.IsSynthesisLog == false || t2.IsSynthesisLog == null) &&
                                                     cidList.Contains(i.CompanyId)
                                                     && i.CreatedDate >= new DateTime(2022, 05, 01)
                                              select t2).Count();

                    ViewBag.DomesticCount = (from i in db.SZ_Quotation
                                             join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                                             where t2.MoveToProject == true &&
                                                   string.IsNullOrEmpty(t2.TrackingNo) &&
                                                   (t2.IsOnHold == false || t2.IsOnHold == null) &&
                                                   t2.ProjectType == "4" &&
                                                   i.CountryTypeId == 1 &&
                                                    cidList.Contains(i.CompanyId)
                                                    && i.CreatedDate >= new DateTime(2022, 05, 01)
                                             select t2).Count();

                    ViewBag.PurchaseCount = (from i in db.SZ_Quotation
                                             join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                                             where (t2.MoveToProject == true || t2.IsSynthesisLog == true) &&
                                                   string.IsNullOrEmpty(t2.TrackingNo) &&
                                                   (t2.IsOnHold == false || t2.IsOnHold == null) &&
                                                   (t2.ProjectType == "3" || t2.ProjectType == "2") &&
                                                    cidList.Contains(i.CompanyId)
                                                    && i.CreatedDate >= new DateTime(2022, 05, 01)
                                             select t2).Count();

                    ViewBag.NoActionCount = (from i in db.SZ_Quotation
                                             join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                                             where ((t2.MoveToProject == true &&
                                                   string.IsNullOrEmpty(t2.TrackingNo) &&
                                                   (t2.IsOnHold == false || t2.IsOnHold == null) &&
                                                   (string.IsNullOrEmpty(t2.ProjectType) || (t2.ProjectType == "1"
                                                        && t2.ScientistCustomerId == null))) ||
                                                   (string.IsNullOrEmpty(t2.RequiredQty) &&
                                                   t2.MoveToProject == true &&
                                                   string.IsNullOrEmpty(t2.TrackingNo) &&
                                                   (t2.IsOnHold == false || t2.IsOnHold == null))) &&
                                                    cidList.Contains(i.CompanyId)
                                                    && i.CreatedDate >= new DateTime(2022, 05, 01)
                                             select t2).Count();

                    ViewBag.InStockCount = (from i in db.SZ_Quotation
                                            join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                                            where t2.MoveToProject == true &&
                                                  string.IsNullOrEmpty(t2.TrackingNo) &&
                                                  (t2.IsOnHold == false || t2.IsOnHold == null) &&
                                                  t2.ProjectType == "4" &&
                                                   cidList.Contains(i.CompanyId)
                                                   && i.CreatedDate >= new DateTime(2022, 05, 01)
                                            select t2).Count();

                    ViewBag.ExportCount = (from i in db.SZ_Quotation
                                           join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                                           where t2.MoveToProject == true &&
                                                 string.IsNullOrEmpty(t2.TrackingNo) &&
                                                 (t2.IsOnHold == false || t2.IsOnHold == null) &&
                                                 (t2.ProjectType != "5" || string.IsNullOrEmpty(t2.ProjectType)) &&
                                                 i.CountryTypeId == 2 &&
                                                  cidList.Contains(i.CompanyId)
                                                  && i.CreatedDate >= new DateTime(2022, 05, 01)
                                           select t2).Count();

                    ViewBag.QueryCount = (from i in db.SZ_Quotation
                                          join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                                          where !string.IsNullOrEmpty(t2.QueryText) &&
                                                 cidList.Contains(i.CompanyId)
                                                 && i.CreatedDate >= new DateTime(2022, 05, 01)
                                          select t2).Count();

                    ViewBag.HoldCount = (from i in db.SZ_Quotation
                                         join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                                         where t2.MoveToProject == true &&
                                                 string.IsNullOrEmpty(t2.TrackingNo) &&
                                                 t2.IsOnHold == true &&
                                                cidList.Contains(i.CompanyId)
                                                && i.CreatedDate >= new DateTime(2022, 05, 01)
                                         select t2).Count();

                    ViewBag.SynthesisLogCount = (from i in db.SZ_Quotation
                                                 join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                                                 where (t2.MoveToProject == false || t2.MoveToProject == null) &&
                                                        t2.ScientistCustomerId != null &&
                                                        t2.IsSynthesisLog == true &&
                                                        cidList.Contains(i.CompanyId)
                                                        && i.CreatedDate >= new DateTime(2022, 05, 01)
                                                 select t2).Count();


                }
            }
            else
            {
                var dbb = new SynzealLiveEntities();
                using (var connection = dbb.Database.Connection)
                {

                    connection.Open();
                    var command = connection.CreateCommand();
                    command.CommandText = "EXEC [dbo].[Project_Count] @internationcompanylist";
                    SqlParameter allcompparam = new SqlParameter("@internationcompanylist", "'" + internationcompanylist + "'");
                    command.Parameters.Add(allcompparam);
                    using (var reader = command.ExecuteReader())
                    {
                        var AllCount = ((System.Data.Entity.Infrastructure.IObjectContextAdapter)dbb)
                                .ObjectContext
                                .Translate<int>(reader)
                                .ToList();
                        ViewBag.AllCount = AllCount[0];
                        reader.NextResult();

                        ViewBag.InHouseCount = ((System.Data.Entity.Infrastructure.IObjectContextAdapter)dbb)
                                .ObjectContext
                                .Translate<int>(reader)
                                .ToList()[0];

                        reader.NextResult();

                        ViewBag.SynthesisCount = ((System.Data.Entity.Infrastructure.IObjectContextAdapter)dbb)
                                .ObjectContext
                                .Translate<int>(reader)
                                .ToList()[0];

                        reader.NextResult();

                        ViewBag.DomesticCount = ((System.Data.Entity.Infrastructure.IObjectContextAdapter)dbb)
                                .ObjectContext
                                .Translate<int>(reader)
                                .ToList()[0];

                        reader.NextResult();

                        ViewBag.PurchaseCount = ((System.Data.Entity.Infrastructure.IObjectContextAdapter)dbb)
                                .ObjectContext
                                .Translate<int>(reader)
                                .ToList()[0];

                        reader.NextResult();
                        ViewBag.NoActionCount = ((System.Data.Entity.Infrastructure.IObjectContextAdapter)dbb)
                                .ObjectContext
                                .Translate<int>(reader)
                                .ToList()[0];

                        reader.NextResult();
                        ViewBag.InStockCount = ((System.Data.Entity.Infrastructure.IObjectContextAdapter)dbb)
                                .ObjectContext
                                .Translate<int>(reader)
                                .ToList()[0];

                        reader.NextResult();

                        ViewBag.ExportCount = ((System.Data.Entity.Infrastructure.IObjectContextAdapter)dbb)
                                .ObjectContext
                                .Translate<int>(reader)
                                .ToList()[0];

                        reader.NextResult();

                        ViewBag.QueryCount = ((System.Data.Entity.Infrastructure.IObjectContextAdapter)dbb)
                                .ObjectContext
                                .Translate<int>(reader)
                                .ToList()[0];

                        reader.NextResult();

                        ViewBag.HoldCount = ((System.Data.Entity.Infrastructure.IObjectContextAdapter)dbb)
                                .ObjectContext
                                .Translate<int>(reader)
                                .ToList()[0];

                        reader.NextResult();

                        ViewBag.SynthesisLogCount = ((System.Data.Entity.Infrastructure.IObjectContextAdapter)dbb)
                                .ObjectContext
                                .Translate<int>(reader)
                                .ToList()[0];
                    }
                }
            }

            ViewBag.WatchListCount = _operationRepository.LoadProjectWatchListDataCount();
            ViewBag.projectList = CommonOperation.GetCustomerRoleSelectedList("project");
            var GeographicalLocationList = new List<SelectListItem>();
            GeographicalLocationList.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var geographicalLocationData = objCache.Get("cache.geographicalLocationData", () =>
            {
                return db.SZ_Geographical.OrderBy(x => x.Id).ToList();
            });

            if (geographicalLocationData != null && geographicalLocationData.Count > 0)
            {
                geographicalLocationData.ForEach(item =>
                {
                    GeographicalLocationList.Add(new SelectListItem
                    {
                        Text = item.Name,
                        Value = item.Id.ToString()
                    });
                });
            }
            ViewBag.GeographicalLocationList = GeographicalLocationList;

            return View(new List<SZ_QuotationModel>());
        }

        [HttpPost]
        public ActionResult LoadProductHoldData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;
                var searchby = string.Empty;
                var searchbyvalue = string.Empty;
                if (Request.Form.GetValues("radiobuton") != null)
                {
                    searchby = Request.Form.GetValues("radiobuton")[0].ToString();
                }
                if (Request.Form.GetValues("searchbox") != null)
                {
                    searchbyvalue = Request.Form.GetValues("searchbox")[0].ToString().Trim();
                }
                MemoryCacheManager objCache = new MemoryCacheManager();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });
                var listItems = new List<SelectListItem>();
                var scienList = objCache.Get("cache.GetScientistId", () =>
                {
                    return db.GetScientistId().ToList();
                });
                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.ToString()
                    });
                });

                ViewBag.ScientistList = listItems;
                var productsData = objCache.Get("cache.productsdata", () =>
                {
                    return db.Products.Where(x => x.Published == true && x.Deleted == false).ToList();
                });
                var inventoryDatacache = objCache.Get("cache.inventoryData", () =>
                {
                    return db.SZ_Inventory.ToList();
                });
                var customerData = db.Customers.ToList();

                var holdData = db.Project_HoldTab().ToList();
                var pids = holdData.Select(x => x.ProductId).ToList();
                var inventoryData = inventoryDatacache.Where(x => pids.Contains(x.ProductId)).ToList();
                var productData = productsData.Where(x => pids.Contains(x.Id)).ToList();
                var scientistStatusData = db.SZ_ScientistStatus.ToList();

                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    holdData = holdData.Where(m => (m.CompanyName != null && m.CompanyName.ToLower().Contains(searchValue))
                                        || (m.PONumber != null && m.PONumber.ToLower().Contains(searchValue))
                                        || (m.Ref != null && m.Ref.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))).ToList();
                    //|| (m.ScientistName).FirstOrDefault() != null && m.SZ_QuotationProductModel.Select(x => x.ScientistName.ToLower()).Contains(searchValue))).ToList();
                }
                if (!string.IsNullOrEmpty(searchby) && !string.IsNullOrEmpty(searchbyvalue))
                {
                    searchbyvalue = searchbyvalue.ToLower();
                    if (searchby == "quoteid")
                    {
                        holdData = holdData.Where(x => x.Ref != null ? x.Ref.ToLower().Contains(searchbyvalue) : false).ToList();
                    }
                    if (searchby == "ponumber")
                    {
                        holdData = holdData.Where(x => x.PONumber != null ? (x.PONumber.ToLower().Contains(searchbyvalue)) : false).ToList();
                    }
                    if (searchby == "company")
                    {
                        holdData = holdData.Where(x => x.CompanyName != null ? x.CompanyName.ToLower().Contains(searchbyvalue) : false).ToList();
                    }
                    if (searchby == "productname")
                    {
                        holdData = holdData.Where(x => x.ProductName.ToLower().Contains(searchbyvalue)).ToList();
                    }
                    if (searchby == "cas")
                    {
                        holdData = holdData.Where(x => x.CASNo != null ? x.CASNo.ToLower().Contains(searchbyvalue) : false).ToList();
                    }
                    if (searchby == "cat")
                    {
                        holdData = holdData.Where(x => x.CATNo != null ? x.CATNo.ToLower().Contains(searchbyvalue) : false).ToList();
                    }
                    if (searchby == "batchno")
                    {
                        holdData = holdData.Where(x => x.BatchNo.ToLower().Contains(searchbyvalue)).ToList();
                    }
                }
                recordsTotal = holdData.Count();
                //Paging   
                holdData = holdData.Skip(skip).Take(pageSize).ToList();
                var list = new List<SZ_QuotationModel>();
                list = (from k in holdData
                        select new SZ_QuotationModel()
                        {
                            CompanyId = k.CompanyId,
                            CompanyName = k.CompanyName,
                            QuoteId = k.QuoteId,
                            IsImageAttach = k.IsImageAttach,
                            Email = k.Email,
                            PONumber = k.PONumber,
                            Ref = k.Ref,
                            Remark = k.Remark,
                            MoveProjectDate = k.MoveProjectDate,
                            SZ_QuotationProductModel = PrepareSZ_QuotationProductModel(k, inventoryData, productData, scientistStatusData, customerData, genericData)
                        }).ToList();
                string internationcompanylist = "";
                if (SessionCookieManagement.IsInternational)
                {
                    internationcompanylist = db.SZ_UserManagement.Where(x => x.UserId == SessionCookieManagement.UserId).Select(x => x.CompanyIds).FirstOrDefault();
                    if (!string.IsNullOrEmpty(internationcompanylist))
                    {
                        List<int?> cidList = new List<int?>();
                        foreach (var item in internationcompanylist.Split(','))
                        {
                            if (!string.IsNullOrEmpty(item))
                            {
                                cidList.Add(Convert.ToInt32(item));
                            }
                        }
                        list = list.Where(x => cidList.Contains(x.CompanyId) && x.PODate >= new DateTime(2022, 05, 01)).ToList();
                    }
                }
                //if (!string.IsNullOrEmpty(searchValue))
                //{
                //    searchValue = searchValue.ToLower().Trim();
                //    list = list.Where(m => (m.CompanyName != null && m.CompanyName.ToLower().Contains(searchValue))
                //                        || (m.PONumber != null && m.PONumber.ToLower().Contains(searchValue))
                //                        || (m.Ref != null && m.Ref.ToLower().Contains(searchValue))
                //                        || (m.SZ_QuotationProductModel.Select(x => x.CATNo).FirstOrDefault() != null && m.SZ_QuotationProductModel.Select(x => x.CATNo.ToLower()).Contains(searchValue))
                //                        || (m.SZ_QuotationProductModel.Select(x => x.CASNo).FirstOrDefault() != null && m.SZ_QuotationProductModel.Select(x => x.CASNo.ToLower()).Contains(searchValue))
                //                        || (m.SZ_QuotationProductModel.Select(x => x.ProductName).FirstOrDefault() != null && m.SZ_QuotationProductModel.Select(x => x.ProductName.ToLower()).Contains(searchValue))
                //                        || (m.SZ_QuotationProductModel.Select(x => x.ScientistName).FirstOrDefault() != null && m.SZ_QuotationProductModel.Select(x => x.ScientistName.ToLower()).Contains(searchValue))).ToList();
                //}
                //if (!string.IsNullOrEmpty(searchby) && !string.IsNullOrEmpty(searchbyvalue))
                //{
                //    searchbyvalue = searchbyvalue.ToLower();
                //    if (searchby == "quoteid")
                //    {
                //        list = list.Where(x => x.Ref != null ? x.Ref.ToLower().Contains(searchbyvalue) : false).ToList();
                //    }
                //    if (searchby == "ponumber")
                //    {
                //        list = list.Where(x => x.PONumber != null ? (x.PONumber.ToLower().Contains(searchbyvalue)) : false).ToList();
                //    }
                //    if (searchby == "company")
                //    {
                //        list = list.Where(x => x.CompanyName != null ? x.CompanyName.ToLower().Contains(searchbyvalue) : false).ToList();
                //    }
                //    if (searchby == "productname")
                //    {
                //        list = list.Where(x => x.SZ_QuotationProductModel.Select(z => z.ProductName).FirstOrDefault().ToLower().Contains(searchbyvalue)).ToList();
                //    }
                //    if (searchby == "cas")
                //    {
                //        list = list.Where(x => x.SZ_QuotationProductModel.Select(z => z.CASNo).FirstOrDefault() != null ? x.SZ_QuotationProductModel.Select(z => z.CASNo).FirstOrDefault().ToLower().Contains(searchbyvalue) : false).ToList();
                //    }
                //    if (searchby == "cat")
                //    {
                //        list = list.Where(x => x.SZ_QuotationProductModel.Select(z => z.CATNo).FirstOrDefault() != null ? x.SZ_QuotationProductModel.Select(z => z.CATNo).FirstOrDefault().ToLower().Contains(searchbyvalue) : false).ToList();
                //    }
                //    if (searchby == "batchno")
                //    {
                //        list = list.Where(x => x.SZ_QuotationProductModel.Select(z => z.BatchNo).FirstOrDefault().ToLower().Contains(searchbyvalue)).ToList();
                //    }
                //}
                //total number of rows count   
                //recordsTotal = list.Count();
                ////Paging   
                //var data = list.Skip(skip).Take(pageSize).ToList();
                var data = list;

                //Returning Json Data  
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                throw ex;
            }

        }
        #endregion

        public ActionResult QuoteDailyReport()
        {
            var listItems = new List<SelectListItem>();
            listItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var scienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("quote")).ToList();
            MemoryCacheManager objCache = new MemoryCacheManager();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });
            foreach (var term in scienList)
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                listItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.Id.ToString()
                });
            }

            ViewBag.listCompItems = listItems;
            return View();
        }

        public ActionResult POReport()
        {
            var listItems = new List<SelectListItem>();
            listItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var scienList = db.SZ_CompanyList.OrderBy(x => x.Name).ToList();
            foreach (var term in scienList)
            {
                listItems.Add(new SelectListItem
                {
                    Text = term.Name,
                    Value = term.Id.ToString()
                });
            }

            ViewBag.listCompItems = listItems;
            return View();
        }
        public ActionResult NewCompanyReport()
        {
            return View();
        }
        public ActionResult CompanyReport()
        {
            return View();
        }

        public ActionResult FollowupReport()
        {
            var listItems = new List<SelectListItem>();
            listItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var scienList = db.SZ_CompanyList.OrderBy(x => x.Name).ToList();
            foreach (var term in scienList)
            {
                listItems.Add(new SelectListItem
                {
                    Text = term.Name,
                    Value = term.Id.ToString()
                });
            }

            ViewBag.listCompItems = listItems;
            return View();
        }
        public SZ_QuotationModel PrepareQuotationModel(SZ_Quotation i)
        {
            var list = new SZ_QuotationModel();
            //foreach (var i in model)
            //{
            SZ_QuotationModel subList = new SZ_QuotationModel();
            subList.QuoteId = i.Id;
            subList.IsImageAttach = i.IsImageAttach;
            subList.CompanyName = i.SZ_CompanyList.Name;
            subList.Email = i.EmailAddress;
            subList.PONumber = i.PONo;
            subList.Ref = i.Ref;
            subList.Remark = i.Remark;
            subList.SZ_QuotationProductModel = new List<SZ_QuotationProductModel>();
            var proData = db.SZ_QuotationDetail.Where(x => x.QuoteId == i.Id).ToList();
            foreach (var k in proData)
            {
                SZ_QuotationProductModel objlist = new SZ_QuotationProductModel();
                objlist.QuoteDetailsId = k.Id;
                objlist.CASNo = k.CASNo;
                objlist.CATNo = k.CATNo;
                objlist.CreatedDate = k.CreatedDate;
                objlist.ImagePath = k.ImagePath;
                objlist.IsUploadServer = k.IsUploadServer;
                objlist.LeadTime = k.LeadTime;
                objlist.Price = k.Price;
                objlist.ProductId = k.ProductId;
                objlist.ProductName = k.ProductName;
                objlist.QuoteId = k.QuoteId;
                objlist.ProjectType = k.ProjectType;
                objlist.ScientistCustomerId = k.ScientistCustomerId;
                objlist.RequiredQty = k.RequiredQty;
                objlist.ProjectStatus = k.ProjectStatus;
                objlist.ScientistStatus = k.ScientistStatus;
                objlist.BatchCode1 = k.BatchCode1;
                objlist.BatchCode2 = k.BatchCode2;
                objlist.Qty1 = k.Qty1;
                objlist.Qty2 = k.Qty2;
                objlist.EstimateCompleteDate = k.EstimateCompleteDate;
                objlist.BatchNo = k.BatchNo;
                objlist.AdditionalBatchNo = k.AdditionalBatchNo;
                objlist.MoveToDispatch = k.MoveToDispatch;
                objlist.MoveToProject = k.MoveToProject;
                objlist.Remark = k.Remark;
                objlist.SrPo = k.SrPo;
                objlist.AdminScientistStatus = k.AdminScientistStatus;
                objlist.InvoiceNo = k.InvoiceNo;
                objlist.InvoiceRemark = k.InvoiceRemark;
                if (k.ProjectStatus != null)
                {
                    objlist.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
                }
                subList.SZ_QuotationProductModel.Add(objlist);
            }
            return list;
        }

        public SZ_QuotationDetail PrepareQuotationDetail(SZ_QuotationDetail i)
        {
            var list = new SZ_QuotationDetail();
            list.QuoteId = i.QuoteId;
            list.ProductId = i.ProductId;
            list.ProductName = i.ProductName;
            list.CASNo = i.CASNo;
            list.ImagePath = i.ImagePath;
            list.Price = i.Price;
            list.LeadTime = i.LeadTime;
            list.IsUploadServer = i.IsUploadServer;
            list.CreatedDate = i.CreatedDate;
            list.CATNo = i.CATNo;
            list.DisplayOrder = i.DisplayOrder;
            list.ProjectType = i.ProjectType;
            list.ScientistCustomerId = i.ScientistCustomerId;
            list.RequiredQty = i.RequiredQty;
            list.ProjectStatus = i.ProjectStatus;
            list.ScientistStatus = i.ScientistStatus;
            list.BatchCode1 = i.BatchCode1;
            list.Qty1 = i.Qty1;
            list.BatchCode2 = i.BatchCode2;
            list.Qty2 = i.Qty2;
            list.Courier = i.Courier;
            list.TrackingNo = i.TrackingNo;
            list.Location = i.Location;
            list.RefName = i.RefName;
            list.PurposeDispatch = i.PurposeDispatch;
            list.DeliveryDate = i.DeliveryDate;
            list.DispatchedStatus = i.DispatchedStatus;
            list.ProcessState = i.ProcessState;
            list.PackDate = i.PackDate;
            list.DeliveryStatus = i.DeliveryStatus;
            list.DataPending = i.DataPending;
            list.TrackingNoDate = i.TrackingNoDate;
            list.EstimateCompleteDate = i.EstimateCompleteDate;
            list.MoveToProject = i.MoveToProject;
            list.MoveToDispatch = i.MoveToDispatch;
            list.BatchNo = i.BatchNo;
            list.AdditionalBatchNo = i.AdditionalBatchNo;
            list.Remark = i.Remark;
            list.MoveToInvoice = i.MoveToInvoice;
            list.AdminScientistStatus = i.AdminScientistStatus;
            list.SrPo = i.SrPo;
            list.InvoiceRemark = i.InvoiceRemark;
            list.InvoiceNo = i.InvoiceNo;
            list.PaymentStatus = i.PaymentStatus;
            list.IsOnHold = i.IsOnHold;
            list.MoveProjectDate = i.MoveProjectDate;
            list.MoveDispatchDate = i.MoveDispatchDate;
            list.MoveToInvoiceDate = i.MoveToInvoiceDate;
            list.MoveToScientistDate = i.MoveToScientistDate;
            list.ProductRemark = i.ProductRemark;
            list.IsDataApproved = i.IsDataApproved;
            list.ScientistRemark = i.ScientistRemark;
            list.DataApprovedStatus = i.DataApprovedStatus;
            list.DataApprovalDate = i.DataApprovalDate;
            list.PurchaseDate = i.PurchaseDate;
            list.PurchaseStatus = i.PurchaseStatus;
            list.Instockdate = i.Instockdate;
            list.LastStatus = i.LastStatus;
            list.COAPath = i.COAPath;
            list.AnalyticalData = i.AnalyticalData;
            list.ClientRemark = i.ClientRemark;
            list.ClientAddress = i.ClientAddress;
            list.AttachedDataList = i.AttachedDataList;
            list.ClientStatus = i.ClientStatus;
            list.SubScientistName = i.SubScientistName;
            list.FollowUpRemark = i.FollowUpRemark;
            list.FollowUpRemarkSecond = i.FollowUpRemarkSecond;
            list.IsPayment = i.IsPayment;
            list.IsDispatchApprove = i.IsDispatchApprove;
            list.EstimateDispatchDate = i.EstimateDispatchDate;
            list.OrderRemark = i.OrderRemark;
            list.LastUploadDate = i.LastUploadDate;
            list.Reason = i.Reason;
            list.ResponseClientRemarkDate = i.ResponseClientRemarkDate;
            list.IsFirstTimeDataUpload = i.IsFirstTimeDataUpload;
            list.QueryText = i.QueryText;
            list.QueryDate = i.QueryDate;
            list.IsSynthesisLog = i.IsSynthesisLog;
            list.IsAssignScientistQuery = i.IsAssignScientistQuery;
            list.IsAssignProjectQuery = i.IsAssignProjectQuery;
            list.Explanation = i.Explanation;
            list.ReportInvoiceDate = i.ReportInvoiceDate;
            list.COAApprovedDate = i.COAApprovedDate;
            list.IsQueryResolved = i.IsQueryResolved;
            list.QueryResolvedDate = i.QueryResolvedDate;
            list.IsDispatchedLock = i.IsDispatchedLock;
            list.IsFollowUpAdminChange = i.IsFollowUpAdminChange;
            list.IsFollowupChange = i.IsFollowupChange;
            list.FollowupDescription = i.FollowupDescription;
            list.ContactDetail = i.ContactDetail;
            list.DifficultyLevel = i.DifficultyLevel;
            list.IsPriority = i.IsPriority;
            list.FinalPrice = i.FinalPrice;
            list.InvoiceBatchNo = i.InvoiceBatchNo;
            list.QueryType = i.QueryType;
            list.QuoteBatchNo = i.QuoteBatchNo;
            list.ActivityStatus = i.ActivityStatus;
            list.InvoicedDate = i.InvoicedDate;
            list.BranchLocation = i.BranchLocation;
            list.ParkReason = i.ParkReason;
            list.PurchaseDDLStatus = i.PurchaseDDLStatus;
            list.PurchaseRemark = i.PurchaseRemark;
            list.ProStatus = i.ProStatus;
            list.ExplainationSecond = i.ExplainationSecond;
            list.LastWeekUpdate = i.LastWeekUpdate;
            list.Discount = i.Discount;
            list.COAId = i.COAId;
            list.COARefNumber = i.COARefNumber;
            list.PreviousStatus = i.PreviousStatus;
            list.PreviousEstCompleteDate = i.PreviousEstCompleteDate;
            list.IsHoldManually = i.IsHoldManually;
            list.Chemist = i.Chemist;
            list.ReviewSciStatus = i.ReviewSciStatus;
            list.IsQC = i.IsQC;
            list.QCdate = i.QCdate;
            list.ApprovalStatus = i.ApprovalStatus;
            list.ApprovedAs = i.ApprovedAs;
            list.ApprovalComment = i.ApprovalComment;
            list.RecommendedPeriod = i.RecommendedPeriod;
            list.PrimaryStdOrdered = i.PrimaryStdOrdered;
            list.ColumnOrder = i.ColumnOrder;
            list.SystemSuitability = i.SystemSuitability;
            list.QCApprovedDate = i.QCApprovedDate;
            list.DispatchStatus = i.DispatchStatus;
            list.OtherProStatus = i.OtherProStatus;
            list.IsPurchase = i.IsPurchase;
            list.QuotePurchaseDate = i.QuotePurchaseDate;
            list.IsCancel = i.IsCancel;
            list.CancelDate = i.CancelDate;
            list.CancelledBy = i.CancelledBy;
            list.ApprovedForClient = i.ApprovedForClient;
            list.IsBackFromPurchase = i.IsBackFromPurchase;
            list.IsForceUpload = i.IsForceUpload;
            list.InhouseRemark = i.InhouseRemark;
            list.LastProStatus = i.LastProStatus;
            list.QcApprovalDate = i.QcApprovalDate;
            list.LastExplainationSecond = i.LastExplainationSecond;
            list.TracebilityCost = i.TracebilityCost;
            list.ColdShipCost = i.ColdShipCost;
            list.AddTestCost = i.AddTestCost;
            list.TracebilityCostRemark = i.TracebilityCostRemark;
            list.ColdShipCostRemark = i.ColdShipCostRemark;
            list.AddTestCostRemark = i.AddTestCostRemark;
            list.CountEstDate = i.CountEstDate;
            list.OnHoldDate = i.OnHoldDate;
            list.TechnicalEmail = i.TechnicalEmail;
            list.InternationStatus = i.InternationStatus;
            list.InternationFeedback = i.InternationFeedback;
            list.SAPSONo = i.SAPSONo;
            list.SAPSOLId = i.SAPSOLId;
            list.IsSuccessSAP = i.IsSuccessSAP;
            list.LicesenStatusId = i.LicesenStatusId;
            list.PermitRequired = i.PermitRequired;
            list.ImportPermit = i.ImportPermit;
            list.Declaration = i.Declaration;
            list.ApplicationDate = i.ApplicationDate;
            list.ExportPermitReceivedDate = i.ExportPermitReceivedDate;
            list.TechnicalWriteup = i.TechnicalWriteup;
            list.QuaterlyDataToSubmit = i.QuaterlyDataToSubmit;
            list.QuaterlyDataSubmited = i.QuaterlyDataSubmited;
            list.APIRequired = i.APIRequired;
            list.NextQuater = i.NextQuater;
            list.JourneyComment = i.JourneyComment;
            list.APIImpExport = i.APIImpExport;
            list.Category = i.Category;
            list.IsQuoteHide = i.IsQuoteHide;
            list.ImpExpo = i.ImpExpo;
            list.PurApprovedStatus = i.PurApprovedStatus;
            list.PurMangRemark = i.PurMangRemark;
            list.PurClientPODate = i.PurClientPODate;
            list.PurOurPODt = i.PurOurPODt;
            list.PurExpectedReceiptDt = i.PurExpectedReceiptDt;
            list.PurCurrentExpDt = i.PurCurrentExpDt;
            list.PurActualReceiptDt = i.PurActualReceiptDt;
            list.PurTargetDispatchDt = i.PurTargetDispatchDt;
            return list;
        }

        public List<SZ_QuotationModel> PrepareQuotationModel(List<SZ_Quotation> model)
        {
            var list = new List<SZ_QuotationModel>();
            var quoteIds = model.Select(x => x.Id).ToList();
            var quotedetailsData = db.SZ_QuotationDetail.Where(x => quoteIds.Contains(x.QuoteId)).ToList();
            model.ForEach(i =>
            {
                SZ_QuotationModel subList = new SZ_QuotationModel();
                subList.QuoteId = i.Id;
                subList.IsImageAttach = i.IsImageAttach;
                subList.CompanyName = i.SZ_CompanyList.Name;
                subList.Email = i.EmailAddress;
                subList.PONumber = i.PONo;
                subList.Ref = i.Ref;
                subList.Remark = i.Remark;
                subList.SZ_QuotationProductModel = new List<SZ_QuotationProductModel>();
                // var proData = db.SZ_QuotationDetail.Where(x => x.QuoteId == i.Id).ToList();
                var proData = quotedetailsData.Where(x => x.QuoteId == i.Id).ToList();
                proData.ForEach(k =>
                {
                    SZ_QuotationProductModel objlist = new SZ_QuotationProductModel();
                    objlist.QuoteDetailsId = k.Id;
                    objlist.CASNo = k.CASNo;
                    objlist.CATNo = k.CATNo;
                    objlist.CreatedDate = k.CreatedDate;
                    objlist.ImagePath = k.ImagePath;
                    objlist.IsUploadServer = k.IsUploadServer;
                    objlist.LeadTime = k.LeadTime;
                    objlist.Price = k.Price;
                    objlist.ProductId = k.ProductId;
                    objlist.ProductName = k.ProductName;
                    objlist.QuoteId = k.QuoteId;
                    objlist.ProjectType = k.ProjectType;
                    objlist.ScientistCustomerId = k.ScientistCustomerId;
                    objlist.RequiredQty = k.RequiredQty;
                    objlist.ProjectStatus = k.ProjectStatus;
                    objlist.ScientistStatus = k.ScientistStatus;
                    objlist.BatchCode1 = k.BatchCode1;
                    objlist.BatchCode2 = k.BatchCode2;
                    objlist.Qty1 = k.Qty1;
                    objlist.Qty2 = k.Qty2;
                    objlist.EstimateCompleteDate = k.EstimateCompleteDate;
                    objlist.BatchNo = k.BatchNo;
                    objlist.AdditionalBatchNo = k.AdditionalBatchNo;
                    objlist.MoveToDispatch = k.MoveToDispatch;
                    objlist.MoveToProject = k.MoveToProject;
                    objlist.Remark = k.Remark;
                    objlist.SrPo = k.SrPo;
                    objlist.AdminScientistStatus = k.AdminScientistStatus;
                    objlist.InvoiceNo = k.InvoiceNo;
                    objlist.InvoiceRemark = k.InvoiceRemark;
                    if (k.ProjectStatus != null)
                    {
                        objlist.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
                    }
                    subList.SZ_QuotationProductModel.Add(objlist);
                });
                list.Add(subList);
            });
            return list;
        }


        #region Scientist
        public ActionResult ScientistNewForm()
        {
            MemoryCacheManager objCache = new MemoryCacheManager();
            var listItems = new List<SelectListItem>();
            var subscientistlistItems = new List<SelectListItem>();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });
            var scienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("scientist")).ToList();
            scienList.ForEach(term =>
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                listItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.Id.ToString()
                });
                subscientistlistItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.Id.ToString()
                });
            });
            ViewBag.tlItems = listItems;
            var subscienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();
            subscienList.ForEach(term =>
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                subscientistlistItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.Id.ToString()
                });
            });

            ViewBag.scientistItems = subscientistlistItems;

            var activityStatusItems = new List<SelectListItem>();
            foreach (EnumList.ScientistReviewStatusDDL r in Enum.GetValues(typeof(EnumList.ScientistReviewStatusDDL)))
            {
                var item = Enum.GetName(typeof(EnumList.ScientistReviewStatusDDL), r);
                var test = r.ToString();
                string text = SZ_Helper.GetEnumDescription((EnumList.ScientistReviewStatusDDL)(int)r);
                int val = (int)r;
                string selected = "";
                activityStatusItems.Add(new SelectListItem
                {
                    Text = text,
                    Value = val.ToString()
                });
            }
            ViewBag.ActivityStatusItems = activityStatusItems;

            var dbb = new SynzealLiveEntities();
            using (var connection = dbb.Database.Connection)
            {
                connection.Open();
                var command = connection.CreateCommand();
                command.CommandText = "EXEC [dbo].[Scientist_Count] " + SessionCookieManagement.UserId + "," + Convert.ToString(SessionCookieManagement.UserId);

                using (var reader = command.ExecuteReader())
                {
                    var NoActionCount = ((System.Data.Entity.Infrastructure.IObjectContextAdapter)dbb)
                            .ObjectContext
                            .Translate<int>(reader)
                            .ToList();
                    ViewBag.NoActionCount = NoActionCount[0];
                    reader.NextResult();

                    ViewBag.All = ((System.Data.Entity.Infrastructure.IObjectContextAdapter)dbb)
                            .ObjectContext
                            .Translate<int>(reader)
                            .ToList()[0];
                    reader.NextResult();

                    ViewBag.Scaleup = ((System.Data.Entity.Infrastructure.IObjectContextAdapter)dbb)
                            .ObjectContext
                            .Translate<int>(reader)
                            .ToList()[0];
                    reader.NextResult();

                    ViewBag.Hold = ((System.Data.Entity.Infrastructure.IObjectContextAdapter)dbb)
                            .ObjectContext
                            .Translate<int>(reader)
                            .ToList()[0];
                    reader.NextResult();

                    ViewBag.Cancelled = ((System.Data.Entity.Infrastructure.IObjectContextAdapter)dbb)
                            .ObjectContext
                            .Translate<int>(reader)
                            .ToList()[0];

                    reader.NextResult();
                    ViewBag.SynthesisLog = ((System.Data.Entity.Infrastructure.IObjectContextAdapter)dbb)
                            .ObjectContext
                            .Translate<int>(reader)
                            .ToList()[0];

                    reader.NextResult();
                    ViewBag.Reprocess = ((System.Data.Entity.Infrastructure.IObjectContextAdapter)dbb)
                           .ObjectContext
                           .Translate<int>(reader)
                           .ToList()[0];
                    reader.NextResult();

                    ViewBag.AllRecord = ((System.Data.Entity.Infrastructure.IObjectContextAdapter)dbb)
                            .ObjectContext
                            .Translate<int>(reader)
                            .ToList()[0];
                }
            }

            var model = db.SZ_QueryModule.Where(x => x.Status != "Completed" && (x.TeamLeaderId == SessionCookieManagement.UserId || x.ScientistId == SessionCookieManagement.UserId)).ToList();
            return View(model);
        }

        [HttpPost]
        public ActionResult LoadNoActionScientistData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();

                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;

                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
                string pursynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
                var quotationDetailsdata = db.SZ_QuotationDetail.AsQueryable();
                // Getting all Customer data  
                string subscientistname = Convert.ToString(SessionCookieManagement.UserId);

                MemoryCacheManager objCache = new MemoryCacheManager();
                var ReadyToDeliverScientistStatusId = objCache.Get("cache.ReadyToDeliverScientistStatusId", () =>
                {
                    return db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                });
                var model = (from i in db.SZ_Quotation.AsNoTracking()
                             join t2 in db.SZ_QuotationDetail.AsNoTracking() on i.Id equals t2.QuoteId
                             where (t2.ScientistCustomerId == SessionCookieManagement.UserId
                             || t2.SubScientistName == subscientistname)
                             && string.IsNullOrEmpty(t2.SubScientistName)
                             && ReadyToDeliverScientistStatusId != t2.ScientistStatus
                             && t2.ProjectType != inhouseProjectType
                             && (t2.IsOnHold == false || t2.IsOnHold == null) && string.IsNullOrEmpty(t2.TrackingNo)
                             && t2.MoveToProject == true
                             orderby t2.MoveToScientistDate descending
                             select t2).AsQueryable();

                var quotedetailIds = model.Select(x => x.Id).ToList();

                var formIdList = db.SZ_QuoteDetails_Form.AsNoTracking().Where(x => quotedetailIds.Contains(x.QuoteDetailsId)).Select(x => x.FormId).ToArray();
                var quotedetailsformList = db.SZ_QuoteDetailForm.AsNoTracking().Where(x => formIdList.Contains(x.Id)).ToList();
                var scientistStatusList = db.SZ_ScientistStatus.AsNoTracking().ToList();
                var proIds = model.Select(x => x.ProductId).ToList();
                var productsData = objCache.Get("cache.productsdata", () =>
                {
                    return db.Products.Where(x => x.Published == true && x.Deleted == false).ToList();
                });
                var inventoryData = objCache.Get("cache.inventoryData", () =>
                {
                    return db.SZ_Inventory.ToList();
                });
                var szInventory = inventoryData.Where(x => proIds.Contains(x.ProductId)).ToList();
                var productdatas = productsData.Where(x => proIds.Contains(x.Id)).ToList();
                var listItems = new List<SelectListItem>();
                var subscientistlistItems = new List<SelectListItem>();
                var scienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("scientist")).ToList();

                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });
                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                    subscientistlistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                });
                ViewBag.tlItems = listItems;
                var subscienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();

                subscienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }

                    subscientistlistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                });

                ViewBag.scientistItems = subscientistlistItems;
                var listCompItems = new List<SelectListItem>();
                listCompItems.Add(new SelectListItem
                {
                    Text = "--Select--",
                    Value = ""
                });
                var compData = scientistStatusList;

                compData.ForEach(term =>
                {
                    listCompItems.Add(new SelectListItem
                    {
                        Text = term.Name,
                        Value = term.Id.ToString()
                    });
                });

                ViewBag.listScientistStatus = listCompItems;
                var loop = 0;
                var list = new List<ScientistDetailModel>();
                model.ForEach(k =>
                {
                    string cls = "";
                    if (k.EstimateCompleteDate.HasValue)
                    {
                        if (k.EstimateCompleteDate.Value.Date < DateTime.Now.Date)
                        {
                            cls = "redcls";
                        }
                    }
                    if (k.IsSynthesisLog.HasValue && k.IsSynthesisLog.Value)
                    {
                        if (string.IsNullOrEmpty(k.SZ_Quotation.PONo))
                        {
                            goto _continue;
                        }
                    }
                    loop += 1;
                    var objModel = new ScientistDetailModel();
                    objModel.IsPriority = k.IsPriority.HasValue ? k.IsPriority.Value : false;
                    objModel.FirstRow = "<input type='checkbox' class='clssaveall " + cls + "' value='" + k.Id + "'>";
                    objModel.SrNo = loop;
                    objModel.QuoteId = k.QuoteId;
                    objModel.QuoteDetailsId = k.Id;
                    objModel.ProStatus = k.ProStatus;
                    objModel.CASNo = k.CASNo;
                    objModel.CATNo = k.CATNo;
                    var proData = productdatas.Where(x => x.Id == k.ProductId.Value).FirstOrDefault();
                    if (proData != null && proData.SZ_ProductScheme != null && proData.SZ_ProductScheme.Count > 0)
                    {
                        objModel.UploadSchemeEye = "<i class='fa fa-eye' onclick='ViewProductScheme(" + k.ProductId + ")'></i>";
                    }

                    objModel.CATText = "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>";
                    objModel.ProductId = k.ProductId;
                    objModel.ProductName = k.ProductName;
                    objModel.SubScientistName = k.SubScientistName;
                    objModel.SubScientistNameText = "<select subscientistname='" + k.SubScientistName + "' id='subScientistName_" + k.Id + "' quotedetailsid='" + k.Id + "'  name='subScientistName_" + k.Id + "' class='scientist'><option value=''>--Select--</option>";
                    if (subscientistlistItems.Count > 0)
                    {
                        int probatchcount = 1;
                        subscientistlistItems.ForEach(r =>
                        {
                            string selected = "";
                            if (k.SubScientistName == r.Value)
                            {
                                selected = " selected ";
                            }
                            objModel.SubScientistNameText += "<option value='" + r.Value.ToString() + "' " + selected + ">" + r.Text + "</option>";
                            probatchcount += 1;
                        });
                    }
                    objModel.SubScientistNameText += "</select>";
                    objModel.Chemist = k.Chemist;
                    objModel.Qty = k.RequiredQty;
                    objModel.ChemistText = "<input id='chemist_" + k.Id + "' value='" + k.Chemist + "' type='text' style='width: 80px;' readonly='' value=''>";
                    objModel.LeadTime = k.LeadTime;
                    objModel.Status = k.ScientistStatus;
                    objModel.StatusText = "<select  id='scientistStatus_" + k.Id + "' quotedetailsid='" + k.Id + "'  name='scientistStatus_" + k.Id + "' class='form-control scientistStatusddl'><option value=''>--Select--</option>";
                    if (listCompItems.Count > 0)
                    {
                        int probatchcount = 1;
                        listCompItems.ForEach(r =>
                        {
                            string selected = "";
                            if (Convert.ToString(k.ScientistStatus) == Convert.ToString(r.Value))
                            {
                                selected = " selected ";
                            }
                            objModel.StatusText += "<option value='" + r.Value.ToString() + "' " + selected + ">" + r.Text + "</option>";
                            probatchcount += 1;
                        });
                    }
                    objModel.StatusText += "</select>";
                    objModel.Explaination = "<i class='fa fa-pencil' onclick='explainationGenerate(" + k.Id + ")' ></i>";
                    objModel.MoveToScientistDate = k.MoveToScientistDate;
                    objModel.Remark = k.Remark;
                    objModel.ProjectType = k.ProjectType;
                    if (k.MoveToScientistDate.HasValue)
                    {
                        objModel.AssignDate = k.MoveToScientistDate.Value.ToShortDateString();
                    }
                    if (k.EstimateCompleteDate.HasValue)
                    {
                        objModel.EstimateCompDate = "<input id='esticompleteDate_" + k.Id + "' type='text' data-value='" + k.EstimateCompleteDate.Value.ToShortDateString() + "' class='datepicker' style='width: 80px' > ";
                    }
                    else
                    {
                        objModel.EstimateCompDate = "<input id='esticompleteDate_" + k.Id + "' type='text' data-value='' class='datepicker' style='width: 80px' > ";
                    }
                    if (k.SynStartDate.HasValue)
                    {
                        objModel.SynStartDate = "<input id='SynStartDate_" + k.Id + "' type='text' data-value='" + k.SynStartDate.Value.ToShortDateString() + "' class='datepicker' style='width: 80px' > ";
                    }
                    else
                    {
                        objModel.SynStartDate = "<input id='SynStartDate_" + k.Id + "' type='text' data-value='' class='datepicker' style='width: 80px' > ";
                    }

                    if (k.ProductId.HasValue)
                    {
                        string selected = string.Empty;
                        objModel.AdditionalBatchNoText = "<select id='additionalBatch_" + k.ProductId + "' class='addbatch'><option value=''>--Select--</option>";
                        var proBatchData = szInventory.Where(x => x.ProductId == k.ProductId).OrderBy(x => x.Id).ToList();
                        if (proBatchData.Count > 0)
                        {
                            int probatchcount = 1;
                            proBatchData.ForEach(r =>
                            {
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }

                                if (k.AdditionalBatchNo.HasValue && k.AdditionalBatchNo.Value == r.Id)
                                {
                                    selected = " selected ";
                                }
                                objModel.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' data-value='" + r.BatchNo + "' " + selected + ">" + text + "</option>";
                                probatchcount += 1;
                            });
                        }
                        objModel.AdditionalBatchNoText += "</select>";
                        objModel.APIName = productdatas.Where(x => x.Id == k.ProductId.Value).Select(x => x.MainCatName).FirstOrDefault();
                    }
                    if (!string.IsNullOrEmpty(k.DifficultyLevel))
                    {
                        EnumList.DifficultyLevel oldfoo = (EnumList.DifficultyLevel)Enum.ToObject(typeof(EnumList.DifficultyLevel), Convert.ToInt32(k.DifficultyLevel));
                        objModel.DifficultyLevel = Common.GetDescription<EnumList.DifficultyLevel>(oldfoo);
                    }
                    list.Add(objModel);

                    _continue:;
                });
                list = list.OrderByDescending(x => x.MoveToScientistDate).ToList();

                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    list = list.Where(m => (m.SubScientistName != null && m.SubScientistName.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.Qty != null && m.Qty.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                                        || (m.ActivityStatus != null && m.ActivityStatus.ToLower().Contains(searchValue))
                                        || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))).ToList();
                }

                //total number of rows count   
                recordsTotal = list.Count();
                //Paging   
                var data = list.Skip(skip).Take(pageSize).ToList();
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }
        }


        [HttpPost]
        public ActionResult LoadAllRecordScientistData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                var sciname = Request.Form.GetValues("sciname").FirstOrDefault();
                var scistatus = Request.Form.GetValues("scistatus").FirstOrDefault();
                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;

                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
                string pursynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
                var quotationDetailsdata = db.SZ_QuotationDetail.AsQueryable();
                // Getting all Customer data  
                string subscientistname = Convert.ToString(SessionCookieManagement.UserId);
                var RePurificationstatus = Convert.ToString((int)EnumList.ProjectType.RePurification);
                var ReSynthesisstatus = Convert.ToString((int)EnumList.ProjectType.ReSynthesis);
                var Dryingstatus = Convert.ToString((int)EnumList.ProjectType.Drying);

                MemoryCacheManager objCache = new MemoryCacheManager();
                var ReadyToDeliverScientistStatusId = objCache.Get("cache.ReadyToDeliverScientistStatusId", () =>
                {
                    return db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                });
                var model = (from i in db.SZ_Quotation.AsNoTracking()
                             join t2 in db.SZ_QuotationDetail.AsNoTracking() on i.Id equals t2.QuoteId
                             where (t2.ScientistCustomerId == SessionCookieManagement.UserId
                             || t2.SubScientistName == subscientistname)
                             && !string.IsNullOrEmpty(t2.SubScientistName)
                             && (ReadyToDeliverScientistStatusId != t2.ScientistStatus || t2.ScientistStatus == null)
                             && t2.ProjectType != inhouseProjectType
                             && (t2.IsOnHold == false || t2.IsOnHold == null)
                             && (t2.IsHoldManually == false || t2.IsHoldManually == null)
                             && string.IsNullOrEmpty(t2.TrackingNo)
                             && t2.MoveToProject == true
                             orderby t2.MoveToScientistDate descending
                             select t2).AsQueryable();

                var proids = model.Select(x => x.ProductId).ToList();
                //var maincatnamelist = (from i in db.Products
                //                       where i.Published == true && i.Deleted == false
                //                       && proids.Contains(i.Id)
                //                       select new
                //                       {
                //                           Id = i.Id,
                //                           MainCatName = i.MainCatName
                //                       }).ToList();
                //var szSAPrawmaterial = (from i in db.SZ_SAPRawMaterial.ToList()
                //                        join t2 in maincatnamelist on i.Project equals t2.MainCatName
                //                        select t2.Id).ToList();

                var maincatnamelist = (from i in db.Products
                                       where i.Published == true && i.Deleted == false
                                       && proids.Contains(i.Id)
                                       select new
                                       {
                                           Id = i.Id,
                                           MainCatName = i.MainCatName,
                                           CASNo = i.ManufacturerPartNumber
                                       }).ToList();
                var szSAPrawmaterial = (from i in db.SZ_SAPProjectNameData.ToList()
                                        join t2 in maincatnamelist on i.ProjectName equals t2.MainCatName
                                        select t2.Id).ToList();

                if (!string.IsNullOrEmpty(sciname))
                {
                    model = model.Where(x => x.SubScientistName == sciname).AsQueryable();
                }
                if (!string.IsNullOrEmpty(scistatus))
                {
                    model = model.Where(x => x.ReviewSciStatus == scistatus).AsQueryable();
                }
                var quotedetailIds = model.Select(x => x.Id).ToList();
                var formIdList = db.SZ_QuoteDetails_Form.AsNoTracking().Where(x => quotedetailIds.Contains(x.QuoteDetailsId)).Select(x => x.FormId).ToArray();
                var quotedetailsformList = db.SZ_QuoteDetailForm.AsNoTracking().Where(x => formIdList.Contains(x.Id)).ToList();
                var scientistStatusList = db.SZ_ScientistStatus.AsNoTracking().ToList();
                var proIds = model.Select(x => x.ProductId).ToList();
                var szInventory = db.SZ_Inventory.AsNoTracking().Where(x => proIds.Contains(x.ProductId)).ToList();
                var productdatas = db.Products.AsNoTracking().Where(x => proIds.Contains(x.Id)).ToList();
                var listItems = new List<SelectListItem>();
                var subscientistlistItems = new List<SelectListItem>();
                var scienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("scientist")).ToList();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });
                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                    subscientistlistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                });
                ViewBag.tlItems = listItems;
                var subscienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();

                subscienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }

                    subscientistlistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                });

                ViewBag.scientistItems = subscientistlistItems;
                var listCompItems = new List<SelectListItem>();
                listCompItems.Add(new SelectListItem
                {
                    Text = "--Select--",
                    Value = ""
                });
                var compData = scientistStatusList;

                compData.ForEach(term =>
                {
                    listCompItems.Add(new SelectListItem
                    {
                        Text = term.Name,
                        Value = term.Id.ToString()
                    });
                });

                ViewBag.listScientistStatus = listCompItems;
                var loop = 0;
                var list = new List<ScientistDetailModel>();
                model.ForEach(k =>
                {
                    string cls = "";
                    if (k.EstimateCompleteDate.HasValue)
                    {
                        if (k.EstimateCompleteDate.Value.Date < DateTime.Now.Date)
                        {
                            cls = "redcls";
                        }
                    }
                    loop += 1;
                    var objModel = new ScientistDetailModel();

                    if (k.ProductId.HasValue && szSAPrawmaterial.Contains(k.ProductId.Value))
                    {
                        objModel.SAPRawMaterial = "<a href='javascript:void(0)' onclick='getrawmaterialdatabyproject(" + k.ProductId + ")'><i class='fa fa-flask'></i></a>";
                    }
                    objModel.UploadScheme = "<i class='fa fa-pencil' onclick='uploadSchemePage(" + k.ProductId + ")' ></i>";
                    objModel.IsPriority = k.IsPriority.HasValue ? k.IsPriority.Value : false;
                    objModel.FirstRow = "<input type='checkbox' class='clssaveall " + cls + "' value='" + k.Id + "'>";
                    objModel.SrNo = loop;
                    objModel.QuoteId = k.QuoteId;
                    objModel.QuoteDetailsId = k.Id;
                    objModel.CASNo = k.CASNo;
                    objModel.CATNo = k.CATNo;
                    objModel.ProStatus = k.ProStatus;
                    //objModel.UploadSchemeEye = "<i class='fa fa-eye' onclick='ViewProductScheme(" + k.ProductId + ")'></i>";
                    var proData = productdatas.Where(x => x.Id == k.ProductId.Value).FirstOrDefault();
                    if (proData != null && proData.SZ_ProductScheme != null && proData.SZ_ProductScheme.Count > 0)
                    {
                        objModel.UploadSchemeEye = "<i class='fa fa-eye' onclick='ViewProductScheme(" + k.ProductId + ")'></i>";
                    }
                    objModel.CATText = "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>";
                    objModel.ProductId = k.ProductId;
                    objModel.ProductName = k.ProductName;
                    objModel.SubScientistName = k.SubScientistName;
                    objModel.SubScientistNameText = "<select subscientistname='" + k.SubScientistName + "' id='subScientistName_" + k.Id + "' quotedetailsid='" + k.Id + "'  name='subScientistName_" + k.Id + "' class='scientist'><option value=''>--Select--</option>";
                    if (subscientistlistItems.Count > 0)
                    {
                        int probatchcount = 1;
                        subscientistlistItems.ForEach(r =>
                        {
                            string selected = "";
                            if (k.SubScientistName == r.Value)
                            {
                                selected = " selected ";
                            }
                            objModel.SubScientistNameText += "<option value='" + r.Value.ToString() + "' " + selected + ">" + r.Text + "</option>";
                            probatchcount += 1;
                        });
                    }
                    objModel.SubScientistNameText += "</select>";
                    objModel.Chemist = k.Chemist;
                    objModel.Qty = k.RequiredQty;
                    objModel.ChemistText = "<input id='chemist_" + k.Id + "' value='" + k.Chemist + "' type='text' style='width: 80px;' readonly='' value=''>";
                    objModel.LeadTime = k.LeadTime;
                    objModel.ActivityStatus = k.ReviewSciStatus;
                    objModel.ActivityStatusText = "<select  id='reviewscistatus_" + k.Id + "' data-value='" + k.ReviewSciStatus + "'  name='reviewscistatus_" + k.Id + "' class='clsreviewscistatus'><option value=''>--Select--</option>";

                    foreach (EnumList.ScientistReviewStatusDDL r in Enum.GetValues(typeof(EnumList.ScientistReviewStatusDDL)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ScientistReviewStatusDDL), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ScientistReviewStatusDDL)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (k.ReviewSciStatus == Convert.ToString(val))
                        {
                            selected = " selected ";
                        }
                        objModel.ActivityStatusText += "<option value='" + val.ToString() + "' " + selected + ">" + text + "</option>";
                    }
                    objModel.ActivityStatusText += "</select>";

                    objModel.Status = k.ScientistStatus;
                    objModel.StatusText = "<select  id='scientistStatus_" + k.Id + "' quotedetailsid='" + k.Id + "'  name='scientistStatus_" + k.Id + "' class='form-control scientistStatusddl'><option value=''>--Select--</option>";
                    if (listCompItems.Count > 0)
                    {
                        int probatchcount = 1;
                        listCompItems.ForEach(r =>
                        {
                            string selected = "";
                            if (Convert.ToString(k.ScientistStatus) == Convert.ToString(r.Value))
                            {
                                selected = " selected ";
                            }
                            objModel.StatusText += "<option value='" + r.Value.ToString() + "' " + selected + ">" + r.Text + "</option>";
                            probatchcount += 1;
                        });
                    }
                    objModel.StatusText += "</select>";
                    objModel.Explaination = "<i class='fa fa-pencil' onclick='explainationGenerate(" + k.Id + ")' ></i>";
                    objModel.MoveToScientistDate = k.MoveToScientistDate;
                    objModel.Remark = k.Remark;
                    objModel.ProjectType = k.ProjectType;
                    if (k.MoveToScientistDate.HasValue)
                    {
                        objModel.AssignDate = k.MoveToScientistDate.Value.ToShortDateString();
                    }
                    if (k.EstimateCompleteDate.HasValue)
                    {
                        objModel.EstimateCompDate = "<input id='esticompleteDate_" + k.Id + "' type='text' data-value='" + k.EstimateCompleteDate.Value.ToShortDateString() + "' class='datepicker' style='width: 80px' > ";
                    }
                    else
                    {
                        objModel.EstimateCompDate = "<input id='esticompleteDate_" + k.Id + "' type='text' data-value='' class='datepicker' style='width: 80px' > ";
                    }
                    if (k.SynStartDate.HasValue)
                    {
                        objModel.SynStartDate = "<input id='SynStartDate_" + k.Id + "' type='text' data-value='" + k.SynStartDate.Value.ToShortDateString() + "' class='datepicker' style='width: 80px' > ";
                    }
                    else
                    {
                        objModel.SynStartDate = "<input id='SynStartDate_" + k.Id + "' type='text' data-value='' class='datepicker' style='width: 80px' > ";
                    }
                    if (k.ProductId.HasValue)
                    {
                        string selected = string.Empty;
                        objModel.AdditionalBatchNoText = "<select id='additionalBatch_" + k.ProductId + "' class='addbatch'><option value=''>--Select--</option>";
                        var proBatchData = szInventory.Where(x => x.ProductId == k.ProductId).OrderBy(x => x.Id).ToList();
                        if (proBatchData.Count > 0)
                        {
                            int probatchcount = 1;
                            proBatchData.ForEach(r =>
                            {
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }

                                if (k.AdditionalBatchNo.HasValue && k.AdditionalBatchNo.Value == r.Id)
                                {
                                    selected = " selected ";
                                }
                                objModel.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' data-value='" + r.BatchNo + "' " + selected + ">" + text + "</option>";
                                probatchcount += 1;
                            });
                        }
                        objModel.AdditionalBatchNoText += "</select>";
                        objModel.APIName = productdatas.Where(x => x.Id == k.ProductId.Value).Select(x => x.MainCatName).FirstOrDefault();
                    }
                    if (!string.IsNullOrEmpty(k.DifficultyLevel))
                    {
                        EnumList.DifficultyLevel oldfoo = (EnumList.DifficultyLevel)Enum.ToObject(typeof(EnumList.DifficultyLevel), Convert.ToInt32(k.DifficultyLevel));
                        objModel.DifficultyLevel = Common.GetDescription<EnumList.DifficultyLevel>(oldfoo);
                    }
                    list.Add(objModel);

                });
                list = list.OrderByDescending(x => x.MoveToScientistDate).ToList();

                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    list = list.Where(m => (m.SubScientistName != null && m.SubScientistName.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.Qty != null && m.Qty.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                                        || (m.ActivityStatus != null && m.ActivityStatus.ToLower().Contains(searchValue))
                                        || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))).ToList();
                }

                //total number of rows count   
                recordsTotal = list.Count();
                //Paging   
                var data = list.Skip(skip).Take(pageSize).ToList();
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }
        }

        public ActionResult UploadProductScheme(int id = 0)
        {
            var model = db.Products.Where(x => x.Id == id).FirstOrDefault();
            if (model == null)
            {
                model = new Product();
            }
            return View(model);
        }

        [HttpPost]
        public ActionResult UploadProductScheme(FormCollection fc, HttpPostedFileBase file)
        {
            string productId = fc["productId"].ToString();
            var fileName = Path.GetFileName(file.FileName); //getting only file name(ex-ganesh.jpg)  
            var ext = Path.GetExtension(file.FileName); //getting the extension(ex-.jpg)  

            string name = Path.GetFileNameWithoutExtension(fileName); //getting file name without extension  
            string myfile = name + "_" + Guid.NewGuid().ToString() + ext; //appending the name with id  
                                                                          // store the file inside ~/project folder(Img)  
            var path = Path.Combine(Server.MapPath("~/Upload/productscheme"), myfile);
            file.SaveAs(path);

            SZ_ProductScheme objModel = new SZ_ProductScheme();
            objModel.ProductId = Convert.ToInt32(productId);
            objModel.CreatedBy = SessionCookieManagement.UserName;
            objModel.CreatedDate = DateTime.Now;
            objModel.Scheme = "../Upload/productscheme/" + myfile;
            db.SZ_ProductScheme.Add(objModel);
            db.SaveChanges();

            return RedirectToAction("UploadProductScheme", new { id = productId });
        }

        public ActionResult DeleteUploadProductScheme(int id)
        {
            int productId = 0;
            SZ_ProductScheme model = db.SZ_ProductScheme.Where(x => x.Id == id).FirstOrDefault();
            if (model != null)
            {
                productId = model.ProductId.Value;
                db.Entry(model).State = EntityState.Deleted;
                db.SaveChanges();
            }
            return RedirectToAction("UploadProductScheme", new { id = productId });
        }

        [HttpPost]
        public ActionResult LoadAllScientistData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                var sciname = Request.Form.GetValues("sciname").FirstOrDefault();

                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;

                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
                string pursynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
                var quotationDetailsdata = db.SZ_QuotationDetail.AsQueryable();
                // Getting all Customer data  
                string subscientistname = Convert.ToString(SessionCookieManagement.UserId);
                var RePurificationstatus = Convert.ToString((int)EnumList.ProjectType.RePurification);
                var ReSynthesisstatus = Convert.ToString((int)EnumList.ProjectType.ReSynthesis);
                var Dryingstatus = Convert.ToString((int)EnumList.ProjectType.Drying);

                MemoryCacheManager objCache = new MemoryCacheManager();
                var ReadyToDeliverScientistStatusId = objCache.Get("cache.ReadyToDeliverScientistStatusId", () =>
                {
                    return db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                });
                var model = (from i in db.SZ_Quotation.AsNoTracking()
                             join t2 in db.SZ_QuotationDetail.AsNoTracking() on i.Id equals t2.QuoteId
                             where (t2.ScientistCustomerId == SessionCookieManagement.UserId
                             || t2.SubScientistName == subscientistname)
                             && !string.IsNullOrEmpty(t2.SubScientistName)
                             && (ReadyToDeliverScientistStatusId != t2.ScientistStatus || t2.ScientistStatus == null)
                             && t2.ProjectType != inhouseProjectType
                                && t2.ProjectType != RePurificationstatus
                                && t2.ProjectType != ReSynthesisstatus
                                && t2.ProjectType != Dryingstatus
                             && (t2.IsOnHold == false || t2.IsOnHold == null)
                             && (t2.IsHoldManually == false || t2.IsHoldManually == null)
                             && string.IsNullOrEmpty(t2.TrackingNo)
                             && t2.MoveToProject == true
                             orderby t2.MoveToScientistDate descending
                             select t2).AsQueryable();

                if (!string.IsNullOrEmpty(sciname))
                {
                    model = model.Where(x => x.SubScientistName == sciname).AsQueryable();
                }

                var quotedetailIds = model.Select(x => x.Id).ToList();
                var formIdList = db.SZ_QuoteDetails_Form.AsNoTracking().Where(x => quotedetailIds.Contains(x.QuoteDetailsId)).Select(x => x.FormId).ToArray();
                var quotedetailsformList = db.SZ_QuoteDetailForm.AsNoTracking().Where(x => formIdList.Contains(x.Id)).ToList();
                var scientistStatusList = db.SZ_ScientistStatus.AsNoTracking().ToList();
                var proIds = model.Select(x => x.ProductId).ToList();
                var szInventory = db.SZ_Inventory.AsNoTracking().Where(x => proIds.Contains(x.ProductId)).ToList();
                var productdatas = db.Products.AsNoTracking().Where(x => proIds.Contains(x.Id)).ToList();
                var listItems = new List<SelectListItem>();
                var subscientistlistItems = new List<SelectListItem>();
                var scienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("scientist")).ToList();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });
                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                    subscientistlistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                });
                ViewBag.tlItems = listItems;
                var subscienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();

                subscienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }

                    subscientistlistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                });

                ViewBag.scientistItems = subscientistlistItems;
                var listCompItems = new List<SelectListItem>();
                listCompItems.Add(new SelectListItem
                {
                    Text = "--Select--",
                    Value = ""
                });
                var compData = scientistStatusList;

                compData.ForEach(term =>
                {
                    listCompItems.Add(new SelectListItem
                    {
                        Text = term.Name,
                        Value = term.Id.ToString()
                    });
                });

                ViewBag.listScientistStatus = listCompItems;
                var loop = 0;
                var list = new List<ScientistDetailModel>();
                model.ForEach(k =>
                {
                    string cls = "";
                    if (k.EstimateCompleteDate.HasValue)
                    {
                        if (k.EstimateCompleteDate.Value.Date < DateTime.Now.Date)
                        {
                            cls = "redcls";
                        }
                    }
                    loop += 1;
                    var objModel = new ScientistDetailModel();
                    //objModel.UploadSchemeEye = "<i class='fa fa-eye' onclick='ViewProductScheme(" + k.ProductId + ")'></i>";
                    var proData = productdatas.Where(x => x.Id == k.ProductId.Value).FirstOrDefault();
                    if (proData != null && proData.SZ_ProductScheme != null && proData.SZ_ProductScheme.Count > 0)
                    {
                        objModel.UploadSchemeEye = "<i class='fa fa-eye' onclick='ViewProductScheme(" + k.ProductId + ")'></i>";
                    }
                    objModel.IsPriority = k.IsPriority.HasValue ? k.IsPriority.Value : false;
                    objModel.FirstRow = "<input type='checkbox' class='clssaveall " + cls + "' value='" + k.Id + "'>";
                    objModel.SrNo = loop;
                    objModel.QuoteId = k.QuoteId;
                    objModel.QuoteDetailsId = k.Id;
                    objModel.CASNo = k.CASNo;
                    objModel.CATNo = k.CATNo;
                    objModel.ProStatus = k.ProStatus;
                    objModel.CATText = "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>";
                    objModel.ProductId = k.ProductId;
                    objModel.ProductName = k.ProductName;
                    objModel.SubScientistName = k.SubScientistName;
                    objModel.SubScientistNameText = "<select subscientistname='" + k.SubScientistName + "' id='subScientistName_" + k.Id + "' quotedetailsid='" + k.Id + "'  name='subScientistName_" + k.Id + "' class='scientist'><option value=''>--Select--</option>";
                    if (subscientistlistItems.Count > 0)
                    {
                        int probatchcount = 1;
                        subscientistlistItems.ForEach(r =>
                        {
                            string selected = "";
                            if (k.SubScientistName == r.Value)
                            {
                                selected = " selected ";
                            }
                            objModel.SubScientistNameText += "<option value='" + r.Value.ToString() + "' " + selected + ">" + r.Text + "</option>";
                            probatchcount += 1;
                        });
                    }
                    objModel.SubScientistNameText += "</select>";
                    objModel.Chemist = k.Chemist;
                    objModel.Qty = k.RequiredQty;
                    objModel.ChemistText = "<input id='chemist_" + k.Id + "' value='" + k.Chemist + "' type='text' style='width: 80px;' readonly='' value=''>";
                    objModel.LeadTime = k.LeadTime;
                    objModel.ActivityStatus = k.ReviewSciStatus;
                    objModel.ActivityStatusText = "<select  id='reviewscistatus_" + k.Id + "' data-value='" + k.ReviewSciStatus + "'  name='reviewscistatus_" + k.Id + "' class='clsreviewscistatus'><option value=''>--Select--</option>";

                    foreach (EnumList.ScientistReviewStatusDDL r in Enum.GetValues(typeof(EnumList.ScientistReviewStatusDDL)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ScientistReviewStatusDDL), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ScientistReviewStatusDDL)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (k.ReviewSciStatus == Convert.ToString(val))
                        {
                            selected = " selected ";
                        }
                        objModel.ActivityStatusText += "<option value='" + val.ToString() + "' " + selected + ">" + text + "</option>";
                    }
                    objModel.ActivityStatusText += "</select>";

                    objModel.Status = k.ScientistStatus;
                    objModel.StatusText = "<select  id='scientistStatus_" + k.Id + "' quotedetailsid='" + k.Id + "'  name='scientistStatus_" + k.Id + "' class='form-control scientistStatusddl'><option value=''>--Select--</option>";
                    if (listCompItems.Count > 0)
                    {
                        int probatchcount = 1;
                        listCompItems.ForEach(r =>
                        {
                            string selected = "";
                            if (Convert.ToString(k.ScientistStatus) == Convert.ToString(r.Value))
                            {
                                selected = " selected ";
                            }
                            objModel.StatusText += "<option value='" + r.Value.ToString() + "' " + selected + ">" + r.Text + "</option>";
                            probatchcount += 1;
                        });
                    }
                    objModel.StatusText += "</select>";
                    objModel.Explaination = "<i class='fa fa-pencil' onclick='explainationGenerate(" + k.Id + ")' ></i>";
                    objModel.MoveToScientistDate = k.MoveToScientistDate;
                    objModel.Remark = k.Remark;
                    objModel.ProjectType = k.ProjectType;
                    if (k.MoveToScientistDate.HasValue)
                    {
                        objModel.AssignDate = k.MoveToScientistDate.Value.ToShortDateString();
                    }
                    if (k.EstimateCompleteDate.HasValue)
                    {
                        objModel.EstimateCompDate = "<input id='esticompleteDate_" + k.Id + "' type='text' data-value='" + k.EstimateCompleteDate.Value.ToShortDateString() + "' class='datepicker' style='width: 80px' > ";
                    }
                    else
                    {
                        objModel.EstimateCompDate = "<input id='esticompleteDate_" + k.Id + "' type='text' data-value='' class='datepicker' style='width: 80px' > ";
                    }
                    if (k.SynStartDate.HasValue)
                    {
                        objModel.SynStartDate = "<input id='SynStartDate_" + k.Id + "' type='text' data-value='" + k.SynStartDate.Value.ToShortDateString() + "' class='datepicker' style='width: 80px' > ";
                    }
                    else
                    {
                        objModel.SynStartDate = "<input id='SynStartDate_" + k.Id + "' type='text' data-value='' class='datepicker' style='width: 80px' > ";
                    }

                    if (k.ProductId.HasValue)
                    {
                        string selected = string.Empty;
                        objModel.AdditionalBatchNoText = "<select id='additionalBatch_" + k.ProductId + "' class='addbatch'><option value=''>--Select--</option>";
                        var proBatchData = szInventory.Where(x => x.ProductId == k.ProductId).OrderBy(x => x.Id).ToList();
                        if (proBatchData.Count > 0)
                        {
                            int probatchcount = 1;
                            proBatchData.ForEach(r =>
                            {
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }

                                if (k.AdditionalBatchNo.HasValue && k.AdditionalBatchNo.Value == r.Id)
                                {
                                    selected = " selected ";
                                }
                                objModel.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' data-value='" + r.BatchNo + "' " + selected + ">" + text + "</option>";
                                probatchcount += 1;
                            });
                        }
                        objModel.AdditionalBatchNoText += "</select>";
                        objModel.APIName = productdatas.Where(x => x.Id == k.ProductId.Value).Select(x => x.MainCatName).FirstOrDefault();
                    }
                    if (!string.IsNullOrEmpty(k.DifficultyLevel))
                    {
                        EnumList.DifficultyLevel oldfoo = (EnumList.DifficultyLevel)Enum.ToObject(typeof(EnumList.DifficultyLevel), Convert.ToInt32(k.DifficultyLevel));
                        objModel.DifficultyLevel = Common.GetDescription<EnumList.DifficultyLevel>(oldfoo);
                    }
                    list.Add(objModel);

                });
                list = list.OrderByDescending(x => x.MoveToScientistDate).ToList();

                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    list = list.Where(m => (m.SubScientistName != null && m.SubScientistName.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.Qty != null && m.Qty.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                                        || (m.ActivityStatus != null && m.ActivityStatus.ToLower().Contains(searchValue))
                                        || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))).ToList();
                }

                //total number of rows count   
                recordsTotal = list.Count();
                //Paging   
                var data = list.Skip(skip).Take(pageSize).ToList();
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }
        }

        public ActionResult ReturnbackfromQCApproval(int id)
        {
            var data = db.SZ_QuotationDetail.Where(x => x.Id == id).FirstOrDefault();
            if (data != null)
            {
                if (!string.IsNullOrEmpty(data.TrackingNo))
                {
                    return Json(new { success = false, message = "Can not return product because already dispatched." }, JsonRequestBehavior.AllowGet);
                }
                data.ScientistStatus = null;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }

            return Json(new { success = true }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public ActionResult LoadQCApprovalScientistData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();

                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;

                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
                string pursynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
                var quotationDetailsdata = db.SZ_QuotationDetail.AsQueryable();
                // Getting all Customer data  
                string subscientistname = Convert.ToString(SessionCookieManagement.UserId);

                MemoryCacheManager objCache = new MemoryCacheManager();
                var ReadyToDeliverScientistStatusId = objCache.Get("cache.ReadyToDeliverScientistStatusId", () =>
                {
                    return db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                });
                var model = (from i in db.SZ_Quotation
                             join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                             where (t2.ScientistCustomerId == SessionCookieManagement.UserId
                             || t2.SubScientistName == subscientistname)
                             && (ReadyToDeliverScientistStatusId == t2.ScientistStatus)
                             && (t2.IsOnHold == false || t2.IsOnHold == null)
                             && t2.MoveToProject == true
                             orderby t2.MoveToScientistDate descending
                             select t2).AsQueryable();

                var quotedetailIds = model.Select(x => x.Id).ToList();
                var formIdList = db.SZ_QuoteDetails_Form.Where(x => quotedetailIds.Contains(x.QuoteDetailsId)).Select(x => x.FormId).ToArray();
                var quotedetailsformList = db.SZ_QuoteDetailForm.Where(x => formIdList.Contains(x.Id)).ToList();
                var scientistStatusList = db.SZ_ScientistStatus.ToList();
                var proIds = model.Select(x => x.ProductId).ToList();
                var szInventory = db.SZ_Inventory.Where(x => proIds.Contains(x.ProductId)).ToList();
                var productdatas = db.Products.Where(x => proIds.Contains(x.Id)).ToList();
                var listItems = new List<SelectListItem>();
                var subscientistlistItems = new List<SelectListItem>();
                var scienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("scientist")).ToList();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });
                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                    subscientistlistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                });
                ViewBag.tlItems = listItems;
                var subscienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();

                subscienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }

                    subscientistlistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                });

                ViewBag.scientistItems = subscientistlistItems;
                var listCompItems = new List<SelectListItem>();
                listCompItems.Add(new SelectListItem
                {
                    Text = "--Select--",
                    Value = ""
                });
                var compData = scientistStatusList;

                compData.ForEach(term =>
                {
                    listCompItems.Add(new SelectListItem
                    {
                        Text = term.Name,
                        Value = term.Id.ToString()
                    });
                });

                ViewBag.listScientistStatus = listCompItems;
                var loop = 0;

                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.SubScientistName != null && m.SubScientistName.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.RequiredQty != null && m.RequiredQty.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                                        || (m.ActivityStatus != null && m.ActivityStatus.ToLower().Contains(searchValue))
                                        || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))).AsQueryable();
                }

                var list = new List<ScientistDetailModel>();
                model.ForEach(k =>
                {
                    var formid = db.SZ_QuoteDetails_Form.Where(x => x.QuoteDetailsId == k.Id).Select(x => x.FormId).FirstOrDefault();
                    var formdata = db.SZ_QuoteDetailForm.Where(x => x.Id == formid).OrderByDescending(x => x.Id).FirstOrDefault();
                    var classname = "";
                    var statusstr = "";
                    if (formdata != null)
                    {
                        string ApprovalStatus = "";
                        ApprovalStatus = formdata.ApprovalStatus;
                        if (formdata.ApprovalStatus == Convert.ToString((int)Synzeal_Inventory.Models.EnumList.ApprovedStatus.QCCorrection))
                        {
                            classname = "yellow";
                            statusstr = "QC Correction";
                        }
                        if (formdata.ApprovalStatus == Convert.ToString((int)Synzeal_Inventory.Models.EnumList.ApprovedStatus.QCApproved))
                        {
                            goto _continue;
                        }
                        if (string.IsNullOrEmpty(formdata.ApprovalStatus))
                        {
                            classname = "skyblue";
                            statusstr = "QC Appoval";
                        }
                    }
                    else
                    {
                        statusstr = "QC Appoval";
                    }
                    loop += 1;
                    var objModel = new ScientistDetailModel();
                    objModel.FirstRow = "<input type='checkbox' class='clssaveall " + classname + "' value='" + k.Id + "'>";
                    objModel.SrNo = loop;
                    objModel.QuoteId = k.QuoteId;
                    objModel.QuoteDetailsId = k.Id;
                    objModel.CASNo = k.CASNo;
                    objModel.CATNo = k.CATNo;
                    objModel.ProStatus = k.ProStatus;
                    objModel.CATText = "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>";
                    objModel.ProductId = k.ProductId;
                    objModel.ProductName = k.ProductName;
                    objModel.SubScientistName = k.SubScientistName;
                    if (subscientistlistItems.Count > 0)
                    {
                        int probatchcount = 1;
                        subscientistlistItems.ForEach(r =>
                        {
                            string selected = "";
                            if (k.SubScientistName == r.Value)
                            {
                                selected = " selected ";
                                objModel.SubScientistNameText = r.Text;
                            }
                            probatchcount += 1;
                        });
                    }
                    objModel.Chemist = k.Chemist;
                    objModel.Qty = k.RequiredQty;
                    objModel.ChemistText = "<input id='chemist_" + k.Id + "' value='" + k.Chemist + "' type='text' style='width: 80px;' readonly='' value=''>";
                    objModel.LeadTime = k.LeadTime;

                    objModel.ActivityStatus = k.ReviewSciStatus;

                    foreach (EnumList.ScientistReviewStatusDDL r in Enum.GetValues(typeof(EnumList.ScientistReviewStatusDDL)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ScientistReviewStatusDDL), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ScientistReviewStatusDDL)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (k.ReviewSciStatus == Convert.ToString(val))
                        {
                            selected = " selected ";
                            objModel.ActivityStatusText = text;
                        }
                    }

                    objModel.Status = k.ScientistStatus;
                    objModel.MoveToScientistDate = k.MoveToScientistDate;
                    objModel.Remark = k.Remark;
                    objModel.ProjectType = k.ProjectType;
                    if (k.MoveToScientistDate.HasValue)
                    {
                        objModel.AssignDate = k.MoveToScientistDate.Value.ToShortDateString();
                    }
                    if (k.EstimateCompleteDate.HasValue)
                    {
                        objModel.EstimateCompDate = k.EstimateCompleteDate.Value.ToShortDateString();
                    }
                    if (k.SynStartDate.HasValue)
                    {
                        objModel.SynStartDate = "<input id='SynStartDate_" + k.Id + "' type='text' data-value='" + k.SynStartDate.Value.ToShortDateString() + "' class='datepicker' style='width: 80px' > ";
                    }
                    else
                    {
                        objModel.SynStartDate = "<input id='SynStartDate_" + k.Id + "' type='text' data-value='' class='datepicker' style='width: 80px' > ";
                    }

                    objModel.Qty1 = k.Qty1;
                    if (k.ProductId.HasValue)
                    {
                        string selected = string.Empty;
                        objModel.AdditionalBatchNoText = "<select id='additionalBatch_" + k.ProductId + "' class='addbatch'><option value=''>--Select--</option>";
                        var proBatchData = szInventory.Where(x => x.ProductId == k.ProductId).OrderBy(x => x.Id).ToList();
                        if (proBatchData.Count > 0)
                        {
                            int probatchcount = 1;
                            proBatchData.ForEach(r =>
                            {
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }

                                if (k.AdditionalBatchNo.HasValue && k.AdditionalBatchNo.Value == r.Id)
                                {
                                    objModel.BatchNo = text;
                                    selected = " selected ";
                                }
                                objModel.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' data-value='" + r.BatchNo + "' " + selected + ">" + text + "</option>";
                                probatchcount += 1;
                            });
                        }
                        objModel.AdditionalBatchNoText += "</select>";
                        objModel.APIName = productdatas.Where(x => x.Id == k.ProductId.Value).Select(x => x.MainCatName).FirstOrDefault();
                    }
                    if (!string.IsNullOrEmpty(k.DifficultyLevel))
                    {
                        EnumList.DifficultyLevel oldfoo = (EnumList.DifficultyLevel)Enum.ToObject(typeof(EnumList.DifficultyLevel), Convert.ToInt32(k.DifficultyLevel));
                        objModel.DifficultyLevel = Common.GetDescription<EnumList.DifficultyLevel>(oldfoo);
                    }
                    objModel.IsPriority = k.IsPriority.HasValue ? k.IsPriority.Value : false;
                    objModel.ActionRow = "";
                    if (ReadyToDeliverScientistStatusId == k.ScientistStatus)
                    {
                        objModel.ActionRow += "<span class='clsLast'>|</span> <a href='/Form/SubmitForm/" + k.Id + "?isnewform=true'>Make Form</a>";
                        objModel.ActionRow += "<span>|</span><a href='/Form/ViewForm/" + k.Id + "'> View Form</a>";
                        objModel.ActionRow += "<span>|</span><a href='javascript: void(0)' onclick='LinkWithQuotedetails(" + k.Id + ")'> Link Form</a>";
                        objModel.ActionRow += "<span>|</span><a href='javascript: void(0)' onclick='Returnbackfromqcapproval(" + k.Id + ")'> Return Back</a>";
                    }
                    //            < a class="clsLast" href="javascript:void(0)" id="save_@k.QuoteDetailsId" onclick="secSaveScientistProductDetails('@k.QuoteDetailsId')"> Save</a>
                    //                                                 @if(k.ReadyToDeliverScientistStatusId == k.ScientistStatus)
                    //{
                    //                                                    <span class="clsLast">|</span> <a href = "/Form/SubmitForm/@k.QuoteDetailsId?isnewform=true" > Make Form</a>
                    //                                                    <span>|</span><a href = "/Form/ViewForm/@k.QuoteDetailsId" > View Form</a>
                    //                                                    <span>|</span><a href = "javascript:void(0)" onclick="LinkWithQuotedetails(@k.QuoteDetailsId)"> Link Form</a>
                    //                                                }
                    list.Add(objModel);


                    _continue:;

                });
                list = list.OrderByDescending(x => x.MoveToScientistDate).ToList();

                ////Search
                //if (!string.IsNullOrEmpty(searchValue))
                //{
                //    searchValue = searchValue.ToLower().Trim();
                //    list = list.Where(m => (m.SubScientistName != null && m.SubScientistName.ToLower().Contains(searchValue))
                //                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                //                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                //                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                //                        || (m.Qty != null && m.Qty.ToLower().Contains(searchValue))
                //                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                //                        || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                //                        || (m.ActivityStatus != null && m.ActivityStatus.ToLower().Contains(searchValue))
                //                        || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))).ToList();
                //}

                //total number of rows count   
                recordsTotal = list.Count();
                //Paging   
                var data = list.Skip(skip).Take(pageSize).ToList();
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);
                throw ex;
            }
        }


        [HttpPost]
        public ActionResult LoadReProcessScientistData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                var sciname = Request.Form.GetValues("sciname").FirstOrDefault();

                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;

                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
                string pursynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
                var quotationDetailsdata = db.SZ_QuotationDetail.AsQueryable();
                // Getting all Customer data  
                string subscientistname = Convert.ToString(SessionCookieManagement.UserId);

                MemoryCacheManager objCache = new MemoryCacheManager();
                var ReadyToDeliverScientistStatusId = objCache.Get("cache.ReadyToDeliverScientistStatusId", () =>
                {
                    return db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                });

                var RePurificationstatus = Convert.ToString((int)EnumList.ProjectType.RePurification);
                var ReSynthesisstatus = Convert.ToString((int)EnumList.ProjectType.ReSynthesis);
                var Dryingstatus = Convert.ToString((int)EnumList.ProjectType.Drying);

                var QCApproval = Convert.ToString((int)EnumList.ProStatusDDL.QCApproval);
                var QCApproved = Convert.ToString((int)EnumList.ProStatusDDL.QCApproved);
                var QCCorrection = Convert.ToString((int)EnumList.ProStatusDDL.QCCorrection);
                var QCRejected = Convert.ToString((int)EnumList.ProStatusDDL.QCRejected);

                var model = (from i in db.SZ_Quotation
                             join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                             where (t2.ScientistCustomerId == SessionCookieManagement.UserId
                             || t2.SubScientistName == subscientistname)
                             //where t2.SubScientistName == subscientistname
                             && (t2.ProjectType == RePurificationstatus
                                || t2.ProjectType == ReSynthesisstatus
                                || t2.ProjectType == Dryingstatus)
                             && (t2.ApprovalStatus != QCApproval)
                             && (t2.ApprovalStatus != QCApproved)
                             && (t2.ApprovalStatus != QCCorrection)
                             && (t2.ApprovalStatus != QCRejected)
                             && (t2.IsOnHold == false || t2.IsOnHold == null)
                             && t2.MoveToProject == true
                             orderby t2.MoveToScientistDate descending
                             select t2).AsQueryable();
                if (!string.IsNullOrEmpty(sciname))
                {
                    model = model.Where(x => x.SubScientistName == sciname).AsQueryable();
                }

                var quotedetailIds = model.Select(x => x.Id).ToList();
                var formIdList = db.SZ_QuoteDetails_Form.Where(x => quotedetailIds.Contains(x.QuoteDetailsId)).Select(x => x.FormId).ToArray();
                var quotedetailsformList = db.SZ_QuoteDetailForm.Where(x => formIdList.Contains(x.Id)).ToList();
                var scientistStatusList = db.SZ_ScientistStatus.ToList();
                var proIds = model.Select(x => x.ProductId).ToList();
                var szInventory = db.SZ_Inventory.Where(x => proIds.Contains(x.ProductId)).ToList();
                var productdatas = db.Products.Where(x => proIds.Contains(x.Id)).ToList();
                var listItems = new List<SelectListItem>();
                var subscientistlistItems = new List<SelectListItem>();
                var scienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("scientist")).ToList();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });
                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                    subscientistlistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                });
                ViewBag.tlItems = listItems;
                var subscienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();

                subscienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }

                    subscientistlistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                });

                ViewBag.scientistItems = subscientistlistItems;
                var listCompItems = new List<SelectListItem>();
                listCompItems.Add(new SelectListItem
                {
                    Text = "--Select--",
                    Value = ""
                });
                var compData = scientistStatusList;

                compData.ForEach(term =>
                {
                    listCompItems.Add(new SelectListItem
                    {
                        Text = term.Name,
                        Value = term.Id.ToString()
                    });
                });

                ViewBag.listScientistStatus = listCompItems;
                var loop = 0;
                var list = new List<ScientistDetailModel>();
                model.ForEach(k =>
                {
                    var formid = db.SZ_QuoteDetails_Form.Where(x => x.QuoteDetailsId == k.Id).Select(x => x.FormId).FirstOrDefault();
                    var formdata = db.SZ_QuoteDetailForm.Where(x => x.Id == formid).OrderByDescending(x => x.Id).FirstOrDefault();
                    var classname = "";
                    var statusstr = "";
                    if (formdata != null)
                    {
                        string ApprovalStatus = "";
                        ApprovalStatus = formdata.ApprovalStatus;
                        if (formdata.ApprovalStatus == Convert.ToString((int)Synzeal_Inventory.Models.EnumList.ApprovedStatus.QCCorrection))
                        {
                            classname = "yellow";
                            statusstr = "QC Correction";
                        }
                        if (formdata.ApprovalStatus == Convert.ToString((int)Synzeal_Inventory.Models.EnumList.ApprovedStatus.QCApproved))
                        {
                            goto _continue;
                        }
                        if (string.IsNullOrEmpty(formdata.ApprovalStatus))
                        {
                            classname = "skyblue";
                            statusstr = "QC Appoval";
                        }
                    }
                    else
                    {
                        statusstr = "QC Appoval";
                    }
                    loop += 1;

                    var objModel = new ScientistDetailModel();
                    objModel.FirstRow = "<input type='checkbox' class='clssaveall " + classname + "' value='" + k.Id + "'>";
                    objModel.SrNo = loop;
                    objModel.QuoteId = k.QuoteId;
                    objModel.QuoteDetailsId = k.Id;
                    objModel.CASNo = k.CASNo;
                    objModel.CATNo = k.CATNo;
                    objModel.ProStatus = k.ProStatus;
                    objModel.CATText = "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>";
                    objModel.ProductId = k.ProductId;
                    objModel.ProductName = k.ProductName;
                    objModel.SubScientistName = k.SubScientistName;
                    var proData = productdatas.Where(x => x.Id == k.ProductId.Value).FirstOrDefault();
                    if (proData != null && proData.SZ_ProductScheme != null && proData.SZ_ProductScheme.Count > 0)
                    {
                        objModel.UploadSchemeEye = "<i class='fa fa-eye' onclick='ViewProductScheme(" + k.ProductId + ")'></i>";
                    }
                    //objModel.UploadSchemeEye = "<i class='fa fa-eye' onclick='ViewProductScheme(" + k.ProductId + ")'></i>";
                    objModel.SubScientistNameText = "<select subscientistname='" + k.SubScientistName + "' id='subScientistName_" + k.Id + "' quotedetailsid='" + k.Id + "'  name='subScientistName_" + k.Id + "' class='scientist'><option value=''>--Select--</option>";
                    if (subscientistlistItems.Count > 0)
                    {
                        int probatchcount = 1;
                        subscientistlistItems.ForEach(r =>
                        {
                            string selected = "";
                            if (k.SubScientistName == r.Value)
                            {
                                selected = " selected ";
                            }
                            objModel.SubScientistNameText += "<option value='" + r.Value.ToString() + "' " + selected + ">" + r.Text + "</option>";
                            probatchcount += 1;
                        });
                    }
                    objModel.SubScientistNameText += "</select>";
                    objModel.Chemist = k.Chemist;
                    objModel.Qty = k.RequiredQty;
                    objModel.ChemistText = "<input id='chemist_" + k.Id + "' value='" + k.Chemist + "' type='text' style='width: 80px;' readonly='' value=''>";
                    objModel.LeadTime = k.LeadTime;
                    objModel.ActivityStatus = k.ReviewSciStatus;
                    objModel.ActivityStatusText = "<select  id='reviewscistatus_" + k.Id + "' data-value='" + k.ReviewSciStatus + "'  name='reviewscistatus_" + k.Id + "' class='clsreviewscistatus'><option value=''>--Select--</option>";

                    foreach (EnumList.ScientistReviewStatusDDL r in Enum.GetValues(typeof(EnumList.ScientistReviewStatusDDL)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ScientistReviewStatusDDL), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ScientistReviewStatusDDL)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (k.ReviewSciStatus == Convert.ToString(val))
                        {
                            selected = " selected ";
                        }
                        objModel.ActivityStatusText += "<option value='" + val.ToString() + "' " + selected + ">" + text + "</option>";
                    }
                    objModel.ActivityStatusText += "</select>";

                    objModel.Status = k.ScientistStatus;
                    objModel.StatusText = "<select  id='scientistStatus_" + k.Id + "' quotedetailsid='" + k.Id + "'  name='scientistStatus_" + k.Id + "' class='form-control scientistStatusddl'><option value=''>--Select--</option>";
                    if (listCompItems.Count > 0)
                    {
                        int probatchcount = 1;
                        listCompItems.ForEach(r =>
                        {
                            string selected = "";
                            if (Convert.ToString(k.ScientistStatus) == Convert.ToString(r.Value))
                            {
                                selected = " selected ";
                            }
                            objModel.StatusText += "<option value='" + r.Value.ToString() + "' " + selected + ">" + r.Text + "</option>";
                            probatchcount += 1;
                        });
                    }
                    objModel.StatusText += "</select>";
                    objModel.Explaination = "<i class='fa fa-pencil' onclick='explainationGenerate(" + k.Id + ")' ></i>";
                    objModel.MoveToScientistDate = k.MoveToScientistDate;
                    objModel.Remark = k.Remark;
                    objModel.ProjectType = k.ProjectType;
                    if (k.MoveToScientistDate.HasValue)
                    {
                        objModel.AssignDate = k.MoveToScientistDate.Value.ToShortDateString();
                    }
                    if (k.EstimateCompleteDate.HasValue)
                    {
                        objModel.EstimateCompDate = "<input id='esticompleteDate_" + k.Id + "' type='text' data-value='" + k.EstimateCompleteDate.Value.ToShortDateString() + "' class='datepicker' style='width: 80px' > ";
                    }
                    else
                    {
                        objModel.EstimateCompDate = "<input id='esticompleteDate_" + k.Id + "' type='text' data-value='' class='datepicker' style='width: 80px' > ";
                    }
                    if (k.SynStartDate.HasValue)
                    {
                        objModel.SynStartDate = "<input id='SynStartDate_" + k.Id + "' type='text' data-value='" + k.SynStartDate.Value.ToShortDateString() + "' class='datepicker' style='width: 80px' > ";
                    }
                    else
                    {
                        objModel.SynStartDate = "<input id='SynStartDate_" + k.Id + "' type='text' data-value='' class='datepicker' style='width: 80px' > ";
                    }
                    if (k.ProductId.HasValue)
                    {
                        string selected = string.Empty;
                        objModel.AdditionalBatchNoText = "<select id='additionalBatch_" + k.ProductId + "' class='addbatch'><option value=''>--Select--</option>";
                        var proBatchData = szInventory.Where(x => x.ProductId == k.ProductId).OrderBy(x => x.Id).ToList();
                        if (proBatchData.Count > 0)
                        {
                            int probatchcount = 1;
                            proBatchData.ForEach(r =>
                            {
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }

                                if (k.AdditionalBatchNo.HasValue && k.AdditionalBatchNo.Value == r.Id)
                                {
                                    selected = " selected ";
                                }
                                objModel.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' data-value='" + r.BatchNo + "' " + selected + ">" + text + "</option>";
                                probatchcount += 1;
                            });
                        }
                        objModel.AdditionalBatchNoText += "</select>";
                        objModel.APIName = productdatas.Where(x => x.Id == k.ProductId.Value).Select(x => x.MainCatName).FirstOrDefault();
                    }
                    if (!string.IsNullOrEmpty(k.DifficultyLevel))
                    {
                        EnumList.DifficultyLevel oldfoo = (EnumList.DifficultyLevel)Enum.ToObject(typeof(EnumList.DifficultyLevel), Convert.ToInt32(k.DifficultyLevel));
                        objModel.DifficultyLevel = Common.GetDescription<EnumList.DifficultyLevel>(oldfoo);
                    }
                    objModel.IsPriority = k.IsPriority.HasValue ? k.IsPriority.Value : false;
                    objModel.ActionRow = "";
                    if (ReadyToDeliverScientistStatusId == k.ScientistStatus)
                    {
                        //https://spms.synzeal.com/Form/SubmitForm/99662?formid=8082
                        if (Dryingstatus == k.ProStatus)
                        {
                            int formId = db.SZ_QuoteDetails_Form.Where(x => x.QuoteDetailsId == k.Id).Select(x => x.FormId).FirstOrDefault();
                            objModel.ActionRow += "<a href='/Form/SubmitForm/" + k.Id + "?formid=" + formId + "'>Edit Form</a>";
                        }
                        else
                        {
                            objModel.ActionRow += "<a href='/Form/SubmitForm/" + k.Id + "?isnewform=true'>Make Form</a>";
                        }
                    }
                    else
                    {
                        objModel.ActionRow += "<a href='/Form/SubmitForm/" + k.Id + "?isnewform=true'>Make Form</a>";
                    }
                    list.Add(objModel);

                    _continue:;
                });
                list = list.OrderByDescending(x => x.MoveToScientistDate).ToList();

                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    list = list.Where(m => (m.SubScientistName != null && m.SubScientistName.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.Qty != null && m.Qty.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                                        || (m.ActivityStatus != null && m.ActivityStatus.ToLower().Contains(searchValue))
                                        || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))).ToList();
                }

                //total number of rows count   
                recordsTotal = list.Count();
                //Paging   
                var data = list.Skip(skip).Take(pageSize).ToList();
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }
        }

        [HttpPost]
        public ActionResult LoadCompletedScientistData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;

                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
                string pursynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
                var quotationDetailsdata = db.SZ_QuotationDetail.AsQueryable();
                // Getting all Customer data  
                string subscientistname = Convert.ToString(SessionCookieManagement.UserId);

                MemoryCacheManager objCache = new MemoryCacheManager();
                var ReadyToDeliverScientistStatusId = objCache.Get("cache.ReadyToDeliverScientistStatusId", () =>
                {
                    return db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                });
                var qcApproved = Convert.ToString((int)Synzeal_Inventory.Models.EnumList.ApprovedStatus.QCApproved);
                var model = (from i in db.SZ_Quotation.AsNoTracking()
                             join t2 in db.SZ_QuotationDetail.AsNoTracking() on i.Id equals t2.QuoteId
                             where (t2.ScientistCustomerId == SessionCookieManagement.UserId
                             || t2.SubScientistName == subscientistname)
                             && (ReadyToDeliverScientistStatusId == t2.ScientistStatus)
                             && (t2.IsOnHold == false || t2.IsOnHold == null)
                             && t2.MoveToProject == true
                             orderby t2.MoveToScientistDate descending
                             select t2).AsQueryable();

                var quotedetailIds = model.Select(x => x.Id).ToList();
                var formIdList = db.SZ_QuoteDetails_Form.Where(x => quotedetailIds.Contains(x.QuoteDetailsId)).Select(x => x.FormId).ToArray();
                var quotedetailsformList = db.SZ_QuoteDetailForm.Where(x => formIdList.Contains(x.Id)).ToList();
                var scientistStatusList = db.SZ_ScientistStatus.ToList();
                var proIds = model.Select(x => x.ProductId).ToList();
                var szInventory = db.SZ_Inventory.Where(x => proIds.Contains(x.ProductId)).ToList();
                var productdatas = db.Products.Where(x => proIds.Contains(x.Id)).ToList();
                var listItems = new List<SelectListItem>();
                var subscientistlistItems = new List<SelectListItem>();
                var scienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("scientist")).ToList();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });
                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                    subscientistlistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                });
                ViewBag.tlItems = listItems;
                var subscienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();

                subscienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }

                    subscientistlistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                });

                ViewBag.scientistItems = subscientistlistItems;
                var listCompItems = new List<SelectListItem>();
                listCompItems.Add(new SelectListItem
                {
                    Text = "--Select--",
                    Value = ""
                });
                var compData = scientistStatusList;

                compData.ForEach(term =>
                {
                    listCompItems.Add(new SelectListItem
                    {
                        Text = term.Name,
                        Value = term.Id.ToString()
                    });
                });

                ViewBag.listScientistStatus = listCompItems;
                var loop = 0;
                var list = new List<ScientistDetailModel>();

                var quotedetailsformData = db.SZ_QuoteDetails_Form.Where(x => quotedetailIds.Contains(x.QuoteDetailsId)).ToList();
                var formIds = quotedetailsformData.Select(x => x.FormId).ToList();
                var mainformdata = db.SZ_QuoteDetailForm.Where(x => formIds.Contains(x.Id)).ToList();

                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.SubScientistName != null && m.SubScientistName.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.RequiredQty != null && m.RequiredQty.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                                        || (m.ActivityStatus != null && m.ActivityStatus.ToLower().Contains(searchValue))
                                        || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))).AsQueryable();
                }

                //total number of rows count   
                recordsTotal = model.Count();
                //Paging   
                var datalist = model.Skip(skip).Take(pageSize).OrderByDescending(x => x.MoveToScientistDate).ToList();

                datalist.ForEach(k =>
                {
                    var formid = quotedetailsformData.Where(x => x.QuoteDetailsId == k.Id).OrderByDescending(x => x.Id).Select(x => x.FormId).FirstOrDefault();
                    var formdata = mainformdata.Where(x => x.Id == formid).OrderByDescending(x => x.Id).FirstOrDefault();
                    var classname = "";
                    if (formdata != null && formdata.ApprovalStatus == Convert.ToString((int)Synzeal_Inventory.Models.EnumList.ApprovedStatus.QCApproved))
                    {
                        classname = "green";
                    }
                    else
                    {
                        goto _continue;
                    }
                    loop += 1;
                    var objModel = new ScientistDetailModel();
                    objModel.FirstRow = "<input type='checkbox' class='clssaveall " + classname + "' value='" + k.Id + "'>";
                    objModel.SrNo = loop;
                    objModel.QuoteId = k.QuoteId;
                    objModel.QuoteDetailsId = k.Id;
                    objModel.CASNo = k.CASNo;
                    objModel.CATNo = k.CATNo;
                    objModel.ProStatus = k.ProStatus;
                    objModel.CATText = "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>";
                    objModel.ProductId = k.ProductId;
                    objModel.ProductName = k.ProductName;
                    objModel.SubScientistName = k.SubScientistName;
                    if (subscientistlistItems.Count > 0)
                    {
                        int probatchcount = 1;
                        subscientistlistItems.ForEach(r =>
                        {
                            string selected = "";
                            if (k.SubScientistName == r.Value)
                            {
                                selected = " selected ";
                                objModel.SubScientistNameText = r.Text;
                            }
                            probatchcount += 1;
                        });
                    }
                    objModel.Chemist = k.Chemist;
                    objModel.Qty = k.RequiredQty;
                    objModel.ChemistText = "<input id='chemist_" + k.Id + "' value='" + k.Chemist + "' type='text' style='width: 80px;' readonly='' value=''>";
                    objModel.LeadTime = k.LeadTime;
                    objModel.ActivityStatus = k.ReviewSciStatus;
                    foreach (EnumList.ScientistReviewStatusDDL r in Enum.GetValues(typeof(EnumList.ScientistReviewStatusDDL)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ScientistReviewStatusDDL), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ScientistReviewStatusDDL)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (k.ReviewSciStatus == Convert.ToString(val))
                        {
                            selected = " selected ";
                            objModel.ActivityStatusText = text;
                        }
                    }

                    objModel.Status = k.ScientistStatus;
                    objModel.MoveToScientistDate = k.MoveToScientistDate;
                    objModel.Remark = k.Remark;
                    objModel.ProjectType = k.ProjectType;
                    if (k.MoveToScientistDate.HasValue)
                    {
                        objModel.AssignDate = k.MoveToScientistDate.Value.ToShortDateString();
                    }
                    if (k.EstimateCompleteDate.HasValue)
                    {
                        objModel.EstimateCompDate = k.EstimateCompleteDate.Value.ToShortDateString();
                    }
                    if (k.SynStartDate.HasValue)
                    {
                        objModel.SynStartDate = "<input id='SynStartDate_" + k.Id + "' type='text' data-value='" + k.SynStartDate.Value.ToShortDateString() + "' class='datepicker' style='width: 80px' > ";
                    }
                    else
                    {
                        objModel.SynStartDate = "<input id='SynStartDate_" + k.Id + "' type='text' data-value='' class='datepicker' style='width: 80px' > ";
                    }

                    if (k.QCApprovedDate.HasValue)
                    {
                        objModel.QCApprovedDate = k.QCApprovedDate.Value.ToShortDateString();
                    }
                    else
                    {
                        if (formdata != null && formdata.QCApprovedDate.HasValue)
                        {
                            objModel.QCApprovedDate = formdata.QCApprovedDate.Value.ToShortDateString();
                        }
                    }
                    objModel.Qty1 = k.Qty1;
                    if (k.ProductId.HasValue)
                    {
                        string selected = string.Empty;
                        objModel.AdditionalBatchNoText = "<select id='additionalBatch_" + k.ProductId + "' class='addbatch'><option value=''>--Select--</option>";
                        var proBatchData = szInventory.Where(x => x.ProductId == k.ProductId).OrderBy(x => x.Id).ToList();
                        if (proBatchData.Count > 0)
                        {
                            int probatchcount = 1;
                            proBatchData.ForEach(r =>
                            {
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }

                                if (k.AdditionalBatchNo.HasValue && k.AdditionalBatchNo.Value == r.Id)
                                {
                                    objModel.BatchNo = text;
                                    selected = " selected ";
                                }
                                objModel.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' data-value='" + r.BatchNo + "' " + selected + ">" + text + "</option>";
                                probatchcount += 1;
                            });
                        }
                        objModel.AdditionalBatchNoText += "</select>";
                        objModel.APIName = productdatas.Where(x => x.Id == k.ProductId.Value).Select(x => x.MainCatName).FirstOrDefault();
                    }
                    if (!string.IsNullOrEmpty(k.DifficultyLevel))
                    {
                        EnumList.DifficultyLevel oldfoo = (EnumList.DifficultyLevel)Enum.ToObject(typeof(EnumList.DifficultyLevel), Convert.ToInt32(k.DifficultyLevel));
                        objModel.DifficultyLevel = Common.GetDescription<EnumList.DifficultyLevel>(oldfoo);
                    }
                    if (ReadyToDeliverScientistStatusId == k.ScientistStatus)
                    {
                        objModel.ActionRow = "<a href='/Form/ViewForm/" + k.Id + "'> View Form</a>";
                    }
                    objModel.IsPriority = k.IsPriority.HasValue ? k.IsPriority.Value : false;
                    list.Add(objModel);

                    _continue:;
                });


                ////Search
                //if (!string.IsNullOrEmpty(searchValue))
                //{
                //    searchValue = searchValue.ToLower().Trim();
                //    list = list.Where(m => (m.SubScientistName != null && m.SubScientistName.ToLower().Contains(searchValue))
                //                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                //                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                //                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                //                        || (m.Qty != null && m.Qty.ToLower().Contains(searchValue))
                //                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                //                        || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                //                        || (m.ActivityStatus != null && m.ActivityStatus.ToLower().Contains(searchValue))
                //                        || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))).ToList();
                //}

                ////total number of rows count   
                //recordsTotal = list.Count();
                ////Paging   
                //var data = list.Skip(skip).Take(pageSize).ToList();

                var data = list;
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);
                throw ex;
            }
        }

        [HttpPost]
        public ActionResult LoadScaleuploadScientistData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();

                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;

                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
                string pursynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
                var quotationDetailsdata = db.SZ_QuotationDetail.AsQueryable();
                // Getting all Customer data  
                string subscientistname = Convert.ToString(SessionCookieManagement.UserId);

                MemoryCacheManager objCache = new MemoryCacheManager();
                var ReadyToDeliverScientistStatusId = objCache.Get("cache.ReadyToDeliverScientistStatusId", () =>
                {
                    return db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                });

                var datelimit = new DateTime(2024, 1, 1);
                var model = (from i in db.SZ_Quotation
                             join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                             where (t2.ScientistCustomerId == SessionCookieManagement.UserId
                             || t2.SubScientistName == subscientistname)
                             && (ReadyToDeliverScientistStatusId != t2.ScientistStatus || t2.ScientistStatus == null)
                             && (t2.IsOnHold == false || t2.IsOnHold == null)
                             && t2.ProjectType == inhouseProjectType
                             && t2.MoveToProject == true
                             && i.CreatedDate >= datelimit
                             orderby t2.MoveToScientistDate descending
                             select t2).AsQueryable();

                var quotedetailIds = model.Select(x => x.Id).ToList();
                var formIdList = db.SZ_QuoteDetails_Form.Where(x => quotedetailIds.Contains(x.QuoteDetailsId)).Select(x => x.FormId).ToArray();
                var quotedetailsformList = db.SZ_QuoteDetailForm.Where(x => formIdList.Contains(x.Id)).ToList();
                var scientistStatusList = db.SZ_ScientistStatus.ToList();
                var proIds = model.Select(x => x.ProductId).ToList();
                var szInventory = db.SZ_Inventory.Where(x => proIds.Contains(x.ProductId)).ToList();
                var productdatas = db.Products.Where(x => proIds.Contains(x.Id)).ToList();
                var listItems = new List<SelectListItem>();
                var subscientistlistItems = new List<SelectListItem>();
                var scienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("scientist")).ToList();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });
                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                    subscientistlistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                });
                ViewBag.tlItems = listItems;
                var subscienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();

                subscienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }

                    subscientistlistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                });

                ViewBag.scientistItems = subscientistlistItems;
                var listCompItems = new List<SelectListItem>();
                listCompItems.Add(new SelectListItem
                {
                    Text = "--Select--",
                    Value = ""
                });
                var compData = scientistStatusList;

                compData.ForEach(term =>
                {
                    listCompItems.Add(new SelectListItem
                    {
                        Text = term.Name,
                        Value = term.Id.ToString()
                    });
                });

                ViewBag.listScientistStatus = listCompItems;
                var loop = 0;
                var list = new List<ScientistDetailModel>();
                model.ForEach(k =>
                {
                    loop += 1;
                    var objModel = new ScientistDetailModel();
                    objModel.IsPriority = k.IsPriority.HasValue ? k.IsPriority.Value : false;
                    objModel.FirstRow = "<input type='checkbox' class='clssaveall' value='" + k.Id + "'>";
                    objModel.SrNo = loop;
                    objModel.QuoteId = k.QuoteId;
                    objModel.QuoteDetailsId = k.Id;
                    objModel.CASNo = k.CASNo;
                    objModel.CATNo = k.CATNo;
                    objModel.ProStatus = k.ProStatus;
                    objModel.CATText = "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>";
                    objModel.ProductId = k.ProductId;
                    objModel.ProductName = k.ProductName;
                    objModel.SubScientistName = k.SubScientistName;
                    objModel.SubScientistNameText = "<select subscientistname='" + k.SubScientistName + "' id='subScientistName_" + k.Id + "' quotedetailsid='" + k.Id + "'  name='subScientistName_" + k.Id + "' class='scientist'><option value=''>--Select--</option>";
                    if (subscientistlistItems.Count > 0)
                    {
                        int probatchcount = 1;
                        subscientistlistItems.ForEach(r =>
                        {
                            string selected = "";
                            if (k.SubScientistName == r.Value)
                            {
                                selected = " selected ";
                            }
                            objModel.SubScientistNameText += "<option value='" + r.Value.ToString() + "' " + selected + ">" + r.Text + "</option>";
                            probatchcount += 1;
                        });
                    }
                    objModel.SubScientistNameText += "</select>";
                    objModel.Chemist = k.Chemist;
                    objModel.Qty = k.RequiredQty;
                    objModel.ChemistText = "<input id='chemist_" + k.Id + "' value='" + k.Chemist + "' type='text' style='width: 80px;' readonly='' value=''>";
                    objModel.LeadTime = k.LeadTime;

                    objModel.ActivityStatus = k.ReviewSciStatus;
                    objModel.ActivityStatusText = "<select  id='reviewscistatus_" + k.Id + "' data-value='" + k.ReviewSciStatus + "'  name='reviewscistatus_" + k.Id + "' class='clsreviewscistatus'><option value=''>--Select--</option>";

                    foreach (EnumList.ScientistReviewStatusDDL r in Enum.GetValues(typeof(EnumList.ScientistReviewStatusDDL)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ScientistReviewStatusDDL), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ScientistReviewStatusDDL)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (k.ReviewSciStatus == Convert.ToString(val))
                        {
                            selected = " selected ";
                        }
                        objModel.ActivityStatusText += "<option value='" + val.ToString() + "' " + selected + ">" + text + "</option>";
                    }
                    objModel.ActivityStatusText += "</select>";

                    objModel.Status = k.ScientistStatus;
                    objModel.StatusText = "<select  id='scientistStatus_" + k.Id + "' quotedetailsid='" + k.Id + "'  name='scientistStatus_" + k.Id + "' class='form-control scientistStatusddl'><option value=''>--Select--</option>";
                    if (listCompItems.Count > 0)
                    {
                        int probatchcount = 1;
                        listCompItems.ForEach(r =>
                        {
                            string selected = "";
                            if (Convert.ToString(k.ScientistStatus) == Convert.ToString(r.Value))
                            {
                                selected = " selected ";
                            }
                            objModel.StatusText += "<option value='" + r.Value.ToString() + "' " + selected + ">" + r.Text + "</option>";
                            probatchcount += 1;
                        });
                    }
                    objModel.StatusText += "</select>";
                    objModel.MoveToScientistDate = k.MoveToScientistDate;
                    objModel.Remark = "<input id='remark_" + k.Id + "' type='text' value='" + k.Remark + "' style='width: 100px' > ";
                    objModel.ProjectType = k.ProjectType;
                    if (k.MoveToScientistDate.HasValue)
                    {
                        objModel.AssignDate = k.MoveToScientistDate.Value.ToShortDateString();
                    }
                    if (k.EstimateCompleteDate.HasValue)
                    {
                        objModel.EstimateCompDate = "<input id='esticompleteDate_" + k.Id + "' type='text' data-value='" + k.EstimateCompleteDate.Value.ToShortDateString() + "' class='datepicker' style='width: 80px' > ";
                    }
                    else
                    {
                        objModel.EstimateCompDate = "<input id='esticompleteDate_" + k.Id + "' type='text' data-value='' class='datepicker' style='width: 80px' > ";
                    }

                    if (k.SynStartDate.HasValue)
                    {
                        objModel.SynStartDate = "<input id='SynStartDate_" + k.Id + "' type='text' data-value='" + k.SynStartDate.Value.ToShortDateString() + "' class='datepicker' style='width: 80px' > ";
                    }
                    else
                    {
                        objModel.SynStartDate = "<input id='SynStartDate_" + k.Id + "' type='text' data-value='' class='datepicker' style='width: 80px' > ";
                    }
                    objModel.Qty1 = "<input id='qty1_" + k.Id + "' type='text' value='" + k.Qty1 + "' style='width: 50px' > ";
                    if (k.ProductId.HasValue)
                    {
                        string selected = string.Empty;
                        objModel.AdditionalBatchNoText = "<select id='additionalBatch_" + k.ProductId + "' class='addbatch'><option value=''>--Select--</option>";
                        var proBatchData = szInventory.Where(x => x.ProductId == k.ProductId).OrderBy(x => x.Id).ToList();
                        if (proBatchData.Count > 0)
                        {
                            int probatchcount = 1;
                            proBatchData.ForEach(r =>
                            {
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }

                                if (k.AdditionalBatchNo.HasValue && k.AdditionalBatchNo.Value == r.Id)
                                {
                                    objModel.BatchNo = text;
                                    selected = " selected ";
                                }
                                objModel.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' data-value='" + r.BatchNo + "' " + selected + ">" + text + "</option>";
                                probatchcount += 1;
                            });
                        }
                        objModel.AdditionalBatchNoText += "</select>";
                        objModel.APIName = productdatas.Where(x => x.Id == k.ProductId.Value).Select(x => x.MainCatName).FirstOrDefault();
                    }
                    if (!string.IsNullOrEmpty(k.DifficultyLevel))
                    {
                        EnumList.DifficultyLevel oldfoo = (EnumList.DifficultyLevel)Enum.ToObject(typeof(EnumList.DifficultyLevel), Convert.ToInt32(k.DifficultyLevel));
                        objModel.DifficultyLevel = Common.GetDescription<EnumList.DifficultyLevel>(oldfoo);
                    }

                    objModel.ActionRow = "<a class='clsLast' href='javascript:void(0)' id='save_" + k.Id + "' onclick='secSaveScientistProductDetails(" + k.Id + ")'>Save</a>";
                    if (ReadyToDeliverScientistStatusId == k.ScientistStatus)
                    {
                        objModel.ActionRow += "<span class='clsLast'>|</span> <a href='/Form/SubmitForm/" + k.Id + "?isnewform=true'>Make Form</a>";
                        objModel.ActionRow += "<span>|</span><a href='/Form/ViewForm/" + k.Id + "'> View Form</a>";
                        objModel.ActionRow += "<span>|</span><a href='javascript: void(0)' onclick='LinkWithQuotedetails(" + k.Id + ")'> Link Form</a>";
                    }
                    //            < a class="clsLast" href="javascript:void(0)" id="save_@k.QuoteDetailsId" onclick="secSaveScientistProductDetails('@k.QuoteDetailsId')"> Save</a>
                    //                                                 @if(k.ReadyToDeliverScientistStatusId == k.ScientistStatus)
                    //{
                    //                                                    <span class="clsLast">|</span> <a href = "/Form/SubmitForm/@k.QuoteDetailsId?isnewform=true" > Make Form</a>
                    //                                                    <span>|</span><a href = "/Form/ViewForm/@k.QuoteDetailsId" > View Form</a>
                    //                                                    <span>|</span><a href = "javascript:void(0)" onclick="LinkWithQuotedetails(@k.QuoteDetailsId)"> Link Form</a>
                    //                                                }
                    list.Add(objModel);

                });
                list = list.OrderByDescending(x => x.MoveToScientistDate).ToList();

                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    list = list.Where(m => (m.SubScientistName != null && m.SubScientistName.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.Qty != null && m.Qty.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                                        || (m.ActivityStatus != null && m.ActivityStatus.ToLower().Contains(searchValue))
                                        || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))).ToList();
                }

                //total number of rows count   
                recordsTotal = list.Count();
                //Paging   
                var data = list.Skip(skip).Take(pageSize).ToList();
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }
        }

        [HttpPost]
        public ActionResult LoadHoldScientistData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();

                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;

                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
                string pursynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
                var quotationDetailsdata = db.SZ_QuotationDetail.AsQueryable();
                // Getting all Customer data  
                string subscientistname = Convert.ToString(SessionCookieManagement.UserId);

                MemoryCacheManager objCache = new MemoryCacheManager();
                var ReadyToDeliverScientistStatusId = objCache.Get("cache.ReadyToDeliverScientistStatusId", () =>
                {
                    return db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                });
                var qcApproved = Convert.ToString((int)Synzeal_Inventory.Models.EnumList.ApprovedStatus.QCApproved);
                var model = (from i in db.SZ_Quotation
                             join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                             where (t2.ScientistCustomerId == SessionCookieManagement.UserId
                             || t2.SubScientistName == subscientistname)
                             && t2.IsHoldManually == true
                             && t2.MoveToProject == true
                             orderby t2.MoveToScientistDate descending
                             select t2).AsQueryable();

                var quotedetailIds = model.Select(x => x.Id).ToList();
                var formIdList = db.SZ_QuoteDetails_Form.Where(x => quotedetailIds.Contains(x.QuoteDetailsId)).Select(x => x.FormId).ToArray();
                var quotedetailsformList = db.SZ_QuoteDetailForm.Where(x => formIdList.Contains(x.Id)).ToList();
                var scientistStatusList = db.SZ_ScientistStatus.ToList();
                var proIds = model.Select(x => x.ProductId).ToList();
                var szInventory = db.SZ_Inventory.Where(x => proIds.Contains(x.ProductId)).ToList();
                var productdatas = db.Products.Where(x => proIds.Contains(x.Id)).ToList();
                var listItems = new List<SelectListItem>();
                var subscientistlistItems = new List<SelectListItem>();
                var scienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("scientist")).ToList();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });
                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                    subscientistlistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                });
                ViewBag.tlItems = listItems;
                var subscienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();

                subscienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }

                    subscientistlistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                });

                ViewBag.scientistItems = subscientistlistItems;
                var listCompItems = new List<SelectListItem>();
                listCompItems.Add(new SelectListItem
                {
                    Text = "--Select--",
                    Value = ""
                });
                var compData = scientistStatusList;

                compData.ForEach(term =>
                {
                    listCompItems.Add(new SelectListItem
                    {
                        Text = term.Name,
                        Value = term.Id.ToString()
                    });
                });

                ViewBag.listScientistStatus = listCompItems;
                var loop = 0;
                var list = new List<ScientistDetailModel>();
                model.ForEach(k =>
                {
                    loop += 1;
                    var objModel = new ScientistDetailModel();
                    objModel.IsPriority = k.IsPriority.HasValue ? k.IsPriority.Value : false;
                    objModel.FirstRow = "<input type='checkbox' class='clssaveall' value='" + k.Id + "'>";
                    objModel.SrNo = loop;
                    objModel.QuoteId = k.QuoteId;
                    objModel.QuoteDetailsId = k.Id;
                    objModel.CASNo = k.CASNo;
                    objModel.CATNo = k.CATNo;
                    objModel.ProStatus = k.ProStatus;
                    objModel.CATText = "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>";
                    objModel.ProductId = k.ProductId;
                    objModel.ProductName = k.ProductName;
                    objModel.SubScientistName = k.SubScientistName;
                    if (subscientistlistItems.Count > 0)
                    {
                        int probatchcount = 1;
                        subscientistlistItems.ForEach(r =>
                        {
                            string selected = "";
                            if (k.SubScientistName == r.Value)
                            {
                                selected = " selected ";
                                objModel.SubScientistNameText = r.Text;
                            }
                            probatchcount += 1;
                        });
                    }
                    objModel.Chemist = k.Chemist;
                    objModel.Qty = k.RequiredQty;
                    objModel.ChemistText = "<input id='chemist_" + k.Id + "' value='" + k.Chemist + "' type='text' style='width: 80px;' readonly='' value=''>";
                    objModel.LeadTime = k.LeadTime;

                    objModel.ActivityStatus = k.ReviewSciStatus;

                    foreach (EnumList.ScientistReviewStatusDDL r in Enum.GetValues(typeof(EnumList.ScientistReviewStatusDDL)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ScientistReviewStatusDDL), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ScientistReviewStatusDDL)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (k.ReviewSciStatus == Convert.ToString(val))
                        {
                            selected = " selected ";
                            objModel.ActivityStatusText = text;
                        }
                    }

                    objModel.Status = k.ScientistStatus;
                    objModel.MoveToScientistDate = k.MoveToScientistDate;
                    objModel.Remark = k.Remark;
                    objModel.ProjectType = k.ProjectType;
                    objModel.BatchCode = k.BatchCode1;
                    if (k.MoveToScientistDate.HasValue)
                    {
                        objModel.AssignDate = k.MoveToScientistDate.Value.ToShortDateString();
                    }
                    if (k.EstimateCompleteDate.HasValue)
                    {
                        objModel.EstimateCompDate = k.EstimateCompleteDate.Value.ToShortDateString();
                    }
                    if (k.SynStartDate.HasValue)
                    {
                        objModel.SynStartDate = "<input id='SynStartDate_" + k.Id + "' type='text' data-value='" + k.SynStartDate.Value.ToShortDateString() + "' class='datepicker' style='width: 80px' > ";
                    }
                    else
                    {
                        objModel.SynStartDate = "<input id='SynStartDate_" + k.Id + "' type='text' data-value='' class='datepicker' style='width: 80px' > ";
                    }

                    objModel.Qty1 = k.Qty1;
                    if (k.ProductId.HasValue)
                    {
                        string selected = string.Empty;
                        objModel.AdditionalBatchNoText = "<select id='additionalBatch_" + k.ProductId + "' class='addbatch'><option value=''>--Select--</option>";
                        var proBatchData = szInventory.Where(x => x.ProductId == k.ProductId).OrderBy(x => x.Id).ToList();
                        if (proBatchData.Count > 0)
                        {
                            int probatchcount = 1;
                            proBatchData.ForEach(r =>
                            {
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }

                                if (k.AdditionalBatchNo.HasValue && k.AdditionalBatchNo.Value == r.Id)
                                {
                                    objModel.BatchNo = text;
                                    selected = " selected ";
                                }
                                objModel.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' data-value='" + r.BatchNo + "' " + selected + ">" + text + "</option>";
                                probatchcount += 1;
                            });
                        }
                        objModel.AdditionalBatchNoText += "</select>";
                        objModel.APIName = productdatas.Where(x => x.Id == k.ProductId.Value).Select(x => x.MainCatName).FirstOrDefault();
                    }
                    if (!string.IsNullOrEmpty(k.DifficultyLevel))
                    {
                        EnumList.DifficultyLevel oldfoo = (EnumList.DifficultyLevel)Enum.ToObject(typeof(EnumList.DifficultyLevel), Convert.ToInt32(k.DifficultyLevel));
                        objModel.DifficultyLevel = Common.GetDescription<EnumList.DifficultyLevel>(oldfoo);
                    }

                    objModel.ActionRow = "<a href='/Form/RemoveHoldManually/" + k.Id + "'> Resume</a>";

                    list.Add(objModel);

                });
                list = list.OrderByDescending(x => x.MoveToScientistDate).ToList();

                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    list = list.Where(m => (m.SubScientistName != null && m.SubScientistName.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.Qty != null && m.Qty.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                                        || (m.ActivityStatus != null && m.ActivityStatus.ToLower().Contains(searchValue))
                                        || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))).ToList();
                }

                //total number of rows count   
                recordsTotal = list.Count();
                //Paging   
                var data = list.Skip(skip).Take(pageSize).ToList();
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }
        }

        [HttpPost]
        public ActionResult LoadCancelledScientistData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();

                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;

                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
                string pursynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
                var quotationDetailsdata = db.SZ_QuotationDetail.AsQueryable();
                // Getting all Customer data  
                string subscientistname = Convert.ToString(SessionCookieManagement.UserId);

                MemoryCacheManager objCache = new MemoryCacheManager();
                var ReadyToDeliverScientistStatusId = objCache.Get("cache.ReadyToDeliverScientistStatusId", () =>
                {
                    return db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                });
                var qcApproved = Convert.ToString((int)Synzeal_Inventory.Models.EnumList.ApprovedStatus.QCApproved);
                var model = (from i in db.SZ_Quotation
                             join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                             where (t2.ScientistCustomerId == SessionCookieManagement.UserId
                             || t2.SubScientistName == subscientistname)
                             && t2.IsOnHold == true
                             && t2.MoveToProject == true
                             orderby t2.OnHoldDate descending
                             select t2).AsQueryable();

                var quotedetailIds = model.Select(x => x.Id).ToList();
                var formIdList = db.SZ_QuoteDetails_Form.Where(x => quotedetailIds.Contains(x.QuoteDetailsId)).Select(x => x.FormId).ToArray();
                var quotedetailsformList = db.SZ_QuoteDetailForm.Where(x => formIdList.Contains(x.Id)).ToList();
                var scientistStatusList = db.SZ_ScientistStatus.ToList();
                var proIds = model.Select(x => x.ProductId).ToList();
                var szInventory = db.SZ_Inventory.Where(x => proIds.Contains(x.ProductId)).ToList();
                var productdatas = db.Products.Where(x => proIds.Contains(x.Id)).ToList();
                var listItems = new List<SelectListItem>();
                var subscientistlistItems = new List<SelectListItem>();
                var scienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("scientist")).ToList();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });
                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                    subscientistlistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                });
                ViewBag.tlItems = listItems;
                var subscienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();

                subscienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }

                    subscientistlistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                });

                ViewBag.scientistItems = subscientistlistItems;
                var listCompItems = new List<SelectListItem>();
                listCompItems.Add(new SelectListItem
                {
                    Text = "--Select--",
                    Value = ""
                });
                var compData = scientistStatusList;

                compData.ForEach(term =>
                {
                    listCompItems.Add(new SelectListItem
                    {
                        Text = term.Name,
                        Value = term.Id.ToString()
                    });
                });

                ViewBag.listScientistStatus = listCompItems;
                var loop = 0;
                var list = new List<ScientistDetailModel>();
                model.ForEach(k =>
                {
                    loop += 1;
                    var objModel = new ScientistDetailModel();
                    objModel.IsPriority = k.IsPriority.HasValue ? k.IsPriority.Value : false;
                    objModel.FirstRow = "<input type='checkbox' class='clssaveall' value='" + k.Id + "'>";
                    objModel.SrNo = loop;
                    objModel.QuoteId = k.QuoteId;
                    objModel.QuoteDetailsId = k.Id;
                    objModel.CASNo = k.CASNo;
                    objModel.CATNo = k.CATNo;
                    objModel.ProStatus = k.ProStatus;
                    objModel.CATText = "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>";
                    objModel.ProductId = k.ProductId;
                    objModel.ProductName = k.ProductName;
                    objModel.SubScientistName = k.SubScientistName;
                    if (subscientistlistItems.Count > 0)
                    {
                        int probatchcount = 1;
                        subscientistlistItems.ForEach(r =>
                        {
                            string selected = "";
                            if (k.SubScientistName == r.Value)
                            {
                                selected = " selected ";
                                objModel.SubScientistNameText = r.Text;
                            }
                            probatchcount += 1;
                        });
                    }
                    objModel.Chemist = k.Chemist;
                    objModel.Qty = k.RequiredQty;
                    objModel.ChemistText = "<input id='chemist_" + k.Id + "' value='" + k.Chemist + "' type='text' style='width: 80px;' readonly='' value=''>";
                    objModel.LeadTime = k.LeadTime;

                    objModel.ActivityStatus = k.ReviewSciStatus;

                    foreach (EnumList.ScientistReviewStatusDDL r in Enum.GetValues(typeof(EnumList.ScientistReviewStatusDDL)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ScientistReviewStatusDDL), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ScientistReviewStatusDDL)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (k.ReviewSciStatus == Convert.ToString(val))
                        {
                            selected = " selected ";
                            objModel.ActivityStatusText = text;
                        }
                    }

                    objModel.Status = k.ScientistStatus;
                    objModel.MoveToScientistDate = k.MoveToScientistDate;
                    objModel.Remark = k.Remark;
                    objModel.ProjectType = k.ProjectType;
                    if (k.MoveToScientistDate.HasValue)
                    {
                        objModel.AssignDate = k.MoveToScientistDate.Value.ToShortDateString();
                    }
                    if (k.EstimateCompleteDate.HasValue)
                    {
                        objModel.EstimateCompDate = k.EstimateCompleteDate.Value.ToShortDateString();
                    }

                    if (k.SynStartDate.HasValue)
                    {
                        objModel.SynStartDate = "<input id='SynStartDate_" + k.Id + "' type='text' data-value='" + k.SynStartDate.Value.ToShortDateString() + "' class='datepicker' style='width: 80px' > ";
                    }
                    else
                    {
                        objModel.SynStartDate = "<input id='SynStartDate_" + k.Id + "' type='text' data-value='' class='datepicker' style='width: 80px' > ";
                    }
                    objModel.Qty1 = k.Qty1;
                    if (k.ProductId.HasValue)
                    {
                        string selected = string.Empty;
                        objModel.AdditionalBatchNoText = "<select id='additionalBatch_" + k.ProductId + "' class='addbatch'><option value=''>--Select--</option>";
                        var proBatchData = szInventory.Where(x => x.ProductId == k.ProductId).OrderBy(x => x.Id).ToList();
                        if (proBatchData.Count > 0)
                        {
                            int probatchcount = 1;
                            proBatchData.ForEach(r =>
                            {
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }

                                if (k.AdditionalBatchNo.HasValue && k.AdditionalBatchNo.Value == r.Id)
                                {
                                    objModel.BatchNo = text;
                                    selected = " selected ";
                                }
                                objModel.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' data-value='" + r.BatchNo + "' " + selected + ">" + text + "</option>";
                                probatchcount += 1;
                            });
                        }
                        objModel.AdditionalBatchNoText += "</select>";
                        objModel.APIName = productdatas.Where(x => x.Id == k.ProductId.Value).Select(x => x.MainCatName).FirstOrDefault();
                    }
                    objModel.BatchCode = k.BatchCode1;
                    if (!string.IsNullOrEmpty(k.DifficultyLevel))
                    {
                        EnumList.DifficultyLevel oldfoo = (EnumList.DifficultyLevel)Enum.ToObject(typeof(EnumList.DifficultyLevel), Convert.ToInt32(k.DifficultyLevel));
                        objModel.DifficultyLevel = Common.GetDescription<EnumList.DifficultyLevel>(oldfoo);
                    }
                    if (ReadyToDeliverScientistStatusId == k.ScientistStatus)
                    {
                        objModel.ActionRow = "<a href='/Form/ViewForm/" + k.Id + "'> View Form</a>";
                    }

                    objModel.OnHoldDate = k.OnHoldDate;
                    if (k.OnHoldDate.HasValue)
                    {
                        objModel.OnHoldDateText = k.OnHoldDate.Value.ToShortDateString();
                    }
                    list.Add(objModel);
                });
                list = list.OrderByDescending(x => x.MoveToScientistDate).ToList();

                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    list = list.Where(m => (m.SubScientistName != null && m.SubScientistName.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.Qty != null && m.Qty.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                                        || (m.ActivityStatus != null && m.ActivityStatus.ToLower().Contains(searchValue))
                                        || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))).ToList();
                }

                //total number of rows count   
                recordsTotal = list.Count();
                //Paging   
                var data = list.Skip(skip).Take(pageSize).ToList();
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }
        }

        [HttpPost]
        public ActionResult LoadSynthesislogScientistData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();

                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;

                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
                string pursynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
                var quotationDetailsdata = db.SZ_QuotationDetail.AsQueryable();
                // Getting all Customer data  
                string subscientistname = Convert.ToString(SessionCookieManagement.UserId);

                MemoryCacheManager objCache = new MemoryCacheManager();
                var ReadyToDeliverScientistStatusId = objCache.Get("cache.ReadyToDeliverScientistStatusId", () =>
                {
                    return db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                });
                var qcApproved = Convert.ToString((int)Synzeal_Inventory.Models.EnumList.ApprovedStatus.QCApproved);
                var model = (from i in db.SZ_Quotation
                             join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                             where (t2.ScientistCustomerId == SessionCookieManagement.UserId
                             || t2.SubScientistName == subscientistname)
                             && t2.IsSynthesisLog == true && string.IsNullOrEmpty(i.PONo)
                             && t2.MoveToProject == true
                             orderby t2.MoveToScientistDate descending
                             select t2).AsQueryable();

                var quotedetailIds = model.Select(x => x.Id).ToList();
                var formIdList = db.SZ_QuoteDetails_Form.Where(x => quotedetailIds.Contains(x.QuoteDetailsId)).Select(x => x.FormId).ToArray();
                var quotedetailsformList = db.SZ_QuoteDetailForm.Where(x => formIdList.Contains(x.Id)).ToList();
                var scientistStatusList = db.SZ_ScientistStatus.ToList();
                var proIds = model.Select(x => x.ProductId).ToList();
                var szInventory = db.SZ_Inventory.Where(x => proIds.Contains(x.ProductId)).ToList();
                var productdatas = db.Products.Where(x => proIds.Contains(x.Id)).ToList();
                var listItems = new List<SelectListItem>();
                var subscientistlistItems = new List<SelectListItem>();
                var scienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("scientist")).ToList();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });
                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                    subscientistlistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                });
                ViewBag.tlItems = listItems;
                var subscienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();

                subscienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }

                    subscientistlistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                });

                ViewBag.scientistItems = subscientistlistItems;
                var listCompItems = new List<SelectListItem>();
                listCompItems.Add(new SelectListItem
                {
                    Text = "--Select--",
                    Value = ""
                });
                var compData = scientistStatusList;

                compData.ForEach(term =>
                {
                    listCompItems.Add(new SelectListItem
                    {
                        Text = term.Name,
                        Value = term.Id.ToString()
                    });
                });

                ViewBag.listScientistStatus = listCompItems;
                var loop = 0;
                var list = new List<ScientistDetailModel>();
                model.ForEach(k =>
                {
                    loop += 1;
                    var objModel = new ScientistDetailModel();
                    objModel.IsPriority = k.IsPriority.HasValue ? k.IsPriority.Value : false;
                    objModel.FirstRow = "<input type='checkbox' class='clssaveall' value='" + k.Id + "'>";
                    objModel.SrNo = loop;
                    objModel.QuoteId = k.QuoteId;
                    objModel.QuoteDetailsId = k.Id;
                    objModel.CASNo = k.CASNo;
                    objModel.CATNo = k.CATNo;
                    objModel.ProStatus = k.ProStatus;
                    objModel.CATText = "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>";
                    objModel.ProductId = k.ProductId;
                    objModel.ProductName = k.ProductName;
                    objModel.SubScientistName = k.SubScientistName;
                    if (subscientistlistItems.Count > 0)
                    {
                        int probatchcount = 1;
                        subscientistlistItems.ForEach(r =>
                        {
                            string selected = "";
                            if (k.SubScientistName == r.Value)
                            {
                                selected = " selected ";
                                objModel.SubScientistNameText = r.Text;
                            }
                            probatchcount += 1;
                        });
                    }
                    objModel.Chemist = k.Chemist;
                    objModel.Qty = k.RequiredQty;
                    objModel.ChemistText = "<input id='chemist_" + k.Id + "' value='" + k.Chemist + "' type='text' style='width: 80px;' readonly='' value=''>";
                    objModel.LeadTime = k.LeadTime;

                    objModel.ActivityStatus = k.ReviewSciStatus;

                    foreach (EnumList.ScientistReviewStatusDDL r in Enum.GetValues(typeof(EnumList.ScientistReviewStatusDDL)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ScientistReviewStatusDDL), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ScientistReviewStatusDDL)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (k.ReviewSciStatus == Convert.ToString(val))
                        {
                            selected = " selected ";
                            objModel.ActivityStatusText = text;
                        }
                    }

                    objModel.Status = k.ScientistStatus;
                    objModel.MoveToScientistDate = k.MoveToScientistDate;
                    objModel.Remark = k.Remark;
                    objModel.ProjectType = k.ProjectType;
                    if (k.MoveToScientistDate.HasValue)
                    {
                        objModel.AssignDate = k.MoveToScientistDate.Value.ToShortDateString();
                    }
                    if (k.EstimateCompleteDate.HasValue)
                    {
                        objModel.EstimateCompDate = k.EstimateCompleteDate.Value.ToShortDateString();
                    }
                    if (k.SynStartDate.HasValue)
                    {
                        objModel.SynStartDate = "<input id='SynStartDate_" + k.Id + "' type='text' data-value='" + k.SynStartDate.Value.ToShortDateString() + "' class='datepicker' style='width: 80px' > ";
                    }
                    else
                    {
                        objModel.SynStartDate = "<input id='SynStartDate_" + k.Id + "' type='text' data-value='' class='datepicker' style='width: 80px' > ";
                    }
                    objModel.Qty1 = k.Qty1;
                    if (k.ProductId.HasValue)
                    {
                        string selected = string.Empty;
                        objModel.AdditionalBatchNoText = "<select id='additionalBatch_" + k.ProductId + "' class='addbatch'><option value=''>--Select--</option>";
                        var proBatchData = szInventory.Where(x => x.ProductId == k.ProductId).OrderBy(x => x.Id).ToList();
                        if (proBatchData.Count > 0)
                        {
                            int probatchcount = 1;
                            proBatchData.ForEach(r =>
                            {
                                string qty = CommonOperation.SettleQtyForSPMS(r);
                                string text = r.BatchNo + " (" + qty + ")";
                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }

                                if (k.AdditionalBatchNo.HasValue && k.AdditionalBatchNo.Value == r.Id)
                                {
                                    objModel.BatchNo = text;
                                    selected = " selected ";
                                }
                                objModel.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' data-value='" + r.BatchNo + "' " + selected + ">" + text + "</option>";
                                probatchcount += 1;
                            });
                        }
                        objModel.AdditionalBatchNoText += "</select>";
                        objModel.APIName = productdatas.Where(x => x.Id == k.ProductId.Value).Select(x => x.MainCatName).FirstOrDefault();
                    }
                    objModel.BatchCode = k.BatchCode1;
                    if (!string.IsNullOrEmpty(k.DifficultyLevel))
                    {
                        EnumList.DifficultyLevel oldfoo = (EnumList.DifficultyLevel)Enum.ToObject(typeof(EnumList.DifficultyLevel), Convert.ToInt32(k.DifficultyLevel));
                        objModel.DifficultyLevel = Common.GetDescription<EnumList.DifficultyLevel>(oldfoo);
                    }
                    if (ReadyToDeliverScientistStatusId == k.ScientistStatus)
                    {
                        objModel.ActionRow = "<a href='/Form/ViewForm/" + k.Id + "'> View Form</a>";
                    }
                    list.Add(objModel);

                });
                list = list.OrderByDescending(x => x.MoveToScientistDate).ToList();

                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    list = list.Where(m => (m.SubScientistName != null && m.SubScientistName.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.Qty != null && m.Qty.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                                        || (m.ActivityStatus != null && m.ActivityStatus.ToLower().Contains(searchValue))
                                        || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))).ToList();
                }

                //total number of rows count   
                recordsTotal = list.Count();
                //Paging   
                var data = list.Skip(skip).Take(pageSize).ToList();
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }
        }

        [HttpPost]
        public ActionResult LoadLessQtyScientistData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();

                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;

                string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
                string pursynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
                var quotationDetailsdata = db.SZ_QuotationDetail.AsQueryable();
                // Getting all Customer data  
                string subscientistname = Convert.ToString(SessionCookieManagement.UserId);

                MemoryCacheManager objCache = new MemoryCacheManager();
                var ReadyToDeliverScientistStatusId = objCache.Get("cache.ReadyToDeliverScientistStatusId", () =>
                {
                    return db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                });
                var qcApproved = Convert.ToString((int)Synzeal_Inventory.Models.EnumList.ApprovedStatus.QCApproved);
                var model = (from i in db.SZ_Quotation
                             join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                             join f in db.SZ_QuoteDetails_Form on t2.Id equals f.QuoteDetailsId
                             join qdf in db.SZ_QuoteDetailForm on f.FormId equals qdf.Id
                             where (t2.ScientistCustomerId == SessionCookieManagement.UserId
                             || t2.SubScientistName == subscientistname)
                                     && t2.ScientistStatus == ReadyToDeliverScientistStatusId
                                    && (t2.IsOnHold == false || t2.IsOnHold == null)
                                    && qdf.ApprovalStatus == qcApproved
                                    && t2.MoveToProject == true
                             orderby t2.MoveToScientistDate descending
                             select t2).AsQueryable();


                var quotedetailIds = model.Select(x => x.Id).ToList();
                var formIdList = db.SZ_QuoteDetails_Form.Where(x => quotedetailIds.Contains(x.QuoteDetailsId)).Select(x => x.FormId).ToArray();
                var quotedetailsformList = db.SZ_QuoteDetailForm.Where(x => formIdList.Contains(x.Id)).ToList();
                var scientistStatusList = db.SZ_ScientistStatus.ToList();
                var proIds = model.Select(x => x.ProductId).ToList();
                var szInventory = db.SZ_Inventory.Where(x => proIds.Contains(x.ProductId)).ToList();
                var productdatas = db.Products.Where(x => proIds.Contains(x.Id)).ToList();
                var listItems = new List<SelectListItem>();
                var subscientistlistItems = new List<SelectListItem>();
                var scienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("scientist")).ToList();
                var genericData = objCache.Get("cache.genericData", () =>
                {
                    return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
                });
                scienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                    subscientistlistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                });
                ViewBag.tlItems = listItems;
                var subscienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();

                subscienList.ForEach(term =>
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }

                    subscientistlistItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                });

                ViewBag.scientistItems = subscientistlistItems;
                var listCompItems = new List<SelectListItem>();
                listCompItems.Add(new SelectListItem
                {
                    Text = "--Select--",
                    Value = ""
                });
                var compData = scientistStatusList;

                compData.ForEach(term =>
                {
                    listCompItems.Add(new SelectListItem
                    {
                        Text = term.Name,
                        Value = term.Id.ToString()
                    });
                });

                ViewBag.listScientistStatus = listCompItems;
                var loop = 0;
                var list = new List<ScientistDetailModel>();

                var formdata = db.SZ_QuoteDetailForm.Where(x => quotedetailIds.Contains(x.QuotationDetailsId)).ToList();

                model.ForEach(k =>
                {
                    loop += 1;
                    var objModel = new ScientistDetailModel();
                    objModel.IsPriority = k.IsPriority.HasValue ? k.IsPriority.Value : false;
                    objModel.FirstRow = "<input type='checkbox' class='clssaveall' value='" + k.Id + "'>";
                    objModel.SrNo = loop;
                    objModel.QuoteId = k.QuoteId;
                    objModel.QuoteDetailsId = k.Id;
                    objModel.CASNo = k.CASNo;
                    objModel.CATNo = k.CATNo;
                    objModel.ProStatus = k.ProStatus;
                    objModel.CATText = "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>";
                    objModel.ProductId = k.ProductId;
                    objModel.ProductName = k.ProductName;
                    objModel.SubScientistName = k.SubScientistName;
                    if (subscientistlistItems.Count > 0)
                    {
                        int probatchcount = 1;
                        subscientistlistItems.ForEach(r =>
                        {
                            string selected = "";
                            if (k.SubScientistName == r.Value)
                            {
                                selected = " selected ";
                                objModel.SubScientistNameText = r.Text;
                            }
                            probatchcount += 1;
                        });
                    }
                    objModel.Chemist = k.Chemist;
                    objModel.Qty = k.RequiredQty;
                    objModel.ChemistText = "<input id='chemist_" + k.Id + "' value='" + k.Chemist + "' type='text' style='width: 80px;' readonly='' value=''>";
                    objModel.LeadTime = k.LeadTime;
                    objModel.ActivityStatus = k.ReviewSciStatus;

                    foreach (EnumList.ScientistReviewStatusDDL r in Enum.GetValues(typeof(EnumList.ScientistReviewStatusDDL)))
                    {
                        var item = Enum.GetName(typeof(EnumList.ScientistReviewStatusDDL), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ScientistReviewStatusDDL)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (k.ReviewSciStatus == Convert.ToString(val))
                        {
                            selected = " selected ";
                            objModel.ActivityStatusText = text;
                        }
                    }

                    objModel.Status = k.ScientistStatus;
                    objModel.MoveToScientistDate = k.MoveToScientistDate;
                    objModel.Remark = k.Remark;
                    objModel.ProjectType = k.ProjectType;
                    if (k.MoveToScientistDate.HasValue)
                    {
                        objModel.AssignDate = k.MoveToScientistDate.Value.ToShortDateString();
                    }
                    if (k.EstimateCompleteDate.HasValue)
                    {
                        objModel.EstimateCompDate = k.EstimateCompleteDate.Value.ToShortDateString();
                    }
                    if (k.SynStartDate.HasValue)
                    {
                        objModel.SynStartDate = "<input id='SynStartDate_" + k.Id + "' type='text' data-value='" + k.SynStartDate.Value.ToShortDateString() + "' class='datepicker' style='width: 80px' > ";
                    }
                    else
                    {
                        objModel.SynStartDate = "<input id='SynStartDate_" + k.Id + "' type='text' data-value='' class='datepicker' style='width: 80px' > ";
                    }
                    objModel.Qty1 = k.Qty1;
                    objModel.IsLessQty = false;
                    objModel.BatchCode = k.BatchCode1;
                    if (k.ProductId.HasValue)
                    {
                        string selected = string.Empty;
                        objModel.AdditionalBatchNoText = "<select id='additionalBatch_" + k.ProductId + "' class='addbatch'><option value=''>--Select--</option>";
                        var proBatchData = szInventory.Where(x => x.ProductId == k.ProductId).OrderBy(x => x.Id).ToList();
                        if (proBatchData.Count > 0)
                        {
                            int probatchcount = 1;
                            var qtytotal = 0;
                            proBatchData.ForEach(r =>
                            {
                                var qty = formdata.Where(x => x.BatchCode == r.BatchNo).Select(x => x.Qty).FirstOrDefault();
                                if (qty == null)
                                {
                                    qty = Convert.ToString(r.Qty);
                                }
                                string text = r.BatchNo + " (" + qty + ")";

                                if (!string.IsNullOrEmpty(qty))
                                {
                                    try
                                    {
                                        objModel.IntRequiredQty = Decimal.ToInt32(Convert.ToDecimal(qty));
                                        qtytotal += Decimal.ToInt32(Convert.ToDecimal(qty));
                                    }
                                    catch (Exception)
                                    {
                                        objModel.IntRequiredQty = 0;
                                        qtytotal += 0;
                                    }

                                    //if (objModel.IntRequiredQty <= 150)
                                    //{
                                    //    objModel.BatchCode = text;
                                    //    objModel.IsLessQty = true;
                                    //}
                                }

                                if (r.IsApproved == false)
                                {
                                    text = "*" + text;
                                }

                                if (k.AdditionalBatchNo.HasValue && k.AdditionalBatchNo.Value == r.Id)
                                {
                                    //objModel.BatchNo = text;
                                    selected = " selected ";
                                }
                                objModel.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' data-value='" + r.BatchNo + "' " + selected + ">" + text + "</option>";
                                probatchcount += 1;
                            });

                            if (qtytotal <= 150)
                            {
                                objModel.IsLessQty = true;
                            }
                        }
                        objModel.AdditionalBatchNoText += "</select>";
                        objModel.APIName = productdatas.Where(x => x.Id == k.ProductId.Value).Select(x => x.MainCatName).FirstOrDefault();
                    }
                    if (!string.IsNullOrEmpty(k.DifficultyLevel))
                    {
                        EnumList.DifficultyLevel oldfoo = (EnumList.DifficultyLevel)Enum.ToObject(typeof(EnumList.DifficultyLevel), Convert.ToInt32(k.DifficultyLevel));
                        objModel.DifficultyLevel = Common.GetDescription<EnumList.DifficultyLevel>(oldfoo);
                    }
                    if (ReadyToDeliverScientistStatusId == k.ScientistStatus)
                    {
                        objModel.ActionRow = "<a href='/Form/ViewForm/" + k.Id + "'> View Form</a>";
                    }
                    objModel.IntRequiredQty = 0;
                    if (!string.IsNullOrEmpty(k.RequiredQty))
                    {
                        try
                        {
                            objModel.IntRequiredQty = Convert.ToInt32(k.RequiredQty);
                        }
                        catch (Exception)
                        {
                            objModel.IntRequiredQty = 0;
                        }
                    }
                    list.Add(objModel);

                });
                //list = list.Where(x => x.IntRequiredQty <= 100).OrderByDescending(x => x.MoveToScientistDate).ToList();
                list = list.Where(x => x.IsLessQty == true).OrderByDescending(x => x.MoveToScientistDate).ToList();

                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    list = list.Where(m => (m.SubScientistName != null && m.SubScientistName.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.Qty != null && m.Qty.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        || (m.Remark != null && m.Remark.ToLower().Contains(searchValue))
                                        || (m.ActivityStatus != null && m.ActivityStatus.ToLower().Contains(searchValue))
                                        || (m.LeadTime != null && m.LeadTime.ToLower().Contains(searchValue))).ToList();
                }

                //total number of rows count   
                recordsTotal = list.Count();
                //Paging   
                var data = list.Skip(skip).Take(pageSize).ToList();
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }
        }

        public ActionResult ScientistForm()
        {
            if (!SessionCookieManagement.IsScientist && !SessionCookieManagement.IsSubScientist)
            {
                return RedirectToAction("Index", "Home");
            }

            MemoryCacheManager objCache = new MemoryCacheManager();

            var categoryData = objCache.Get("cache.categoryData", () =>
            {
                return db.Categories.ToList();
            });
            var productCategoryData = objCache.Get("cache.productCategoryData", () =>
            {
                return db.Product_Category_Mapping.ToList();
            });
            //var categoryData = db.Categories.ToList();
            //var productCategoryData = db.Product_Category_Mapping.ToList();
            string subscientistname = Convert.ToString(SessionCookieManagement.UserId);
            var model = (from i in db.SZ_Quotation
                         join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                         where (t2.ScientistCustomerId == SessionCookieManagement.UserId
                         || t2.SubScientistName == subscientistname) && t2.MoveToProject == true
                         //&& (t2.IsOnHold == false || t2.IsOnHold == null)
                         orderby t2.MoveToScientistDate descending
                         select t2).AsQueryable();

            var quotedetailIds = model.Select(x => x.Id).ToList();

            var formIdList = db.SZ_QuoteDetails_Form.Where(x => quotedetailIds.Contains(x.QuoteDetailsId)).Select(x => x.FormId).ToArray();
            var quotedetailsformList = db.SZ_QuoteDetailForm.Where(x => formIdList.Contains(x.Id)).ToList();
            var scientistStatusList = db.SZ_ScientistStatus.ToList();
            var ReadyToDeliverScientistStatusId = scientistStatusList.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
            var proIds = model.Select(x => x.ProductId).ToList();
            var szInventory = db.SZ_Inventory.Where(x => proIds.Contains(x.ProductId)).ToList();
            var productdatas = db.Products.Where(x => proIds.Contains(x.Id)).ToList();
            var listItems = new List<SelectListItem>();
            var subscientistlistItems = new List<SelectListItem>();
            var scienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("scientist")).ToList();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });
            scienList.ForEach(term =>
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                listItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.Id.ToString()
                });
                subscientistlistItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.Id.ToString()
                });
            });
            //}
            ViewBag.tlItems = listItems;
            var subscienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();

            subscienList.ForEach(term =>
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }

                subscientistlistItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.Id.ToString()
                });
            });
            //}

            ViewBag.scientistItems = subscientistlistItems;

            var list = new List<SZ_QuotationModel>();
            model.ForEach(k =>
            {
                //foreach (var k in model)
                //{
                SZ_QuotationModel subList = new SZ_QuotationModel();
                subList.QuoteId = k.QuoteId;
                subList.IsImageAttach = k.SZ_Quotation.IsImageAttach;
                subList.CompanyName = k.SZ_Quotation.CompanyName;
                subList.Email = k.SZ_Quotation.EmailAddress;
                subList.PONumber = k.SZ_Quotation.PONo;
                subList.Ref = k.SZ_Quotation.Ref;
                subList.Remark = k.SZ_Quotation.Remark;
                subList.MoveToScientistDate = k.MoveToScientistDate;
                subList.SZ_QuotationProductModel = new List<SZ_QuotationProductModel>();

                SZ_QuotationProductModel objlist = new SZ_QuotationProductModel();
                objlist.ReadyToDeliverScientistStatusId = ReadyToDeliverScientistStatusId;
                objlist.ScientistFormCount = quotedetailsformList.Where(x => x.QuotationDetailsId == k.Id).Count();
                objlist.QuoteDetailsId = k.Id;
                objlist.IsHoldManually = k.IsHoldManually;
                objlist.CASNo = k.CASNo;
                objlist.CATNo = k.CATNo;
                objlist.CATText = "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>";
                objlist.MoveToScientistDate = k.MoveToScientistDate;
                objlist.CreatedDate = k.CreatedDate;
                objlist.ImagePath = k.ImagePath;
                objlist.IsUploadServer = k.IsUploadServer;
                objlist.LeadTime = k.LeadTime;
                objlist.Price = k.Price;
                objlist.ProductId = k.ProductId;
                objlist.ProductName = k.ProductName;
                objlist.QuoteId = k.QuoteId;
                objlist.ProjectType = k.ProjectType;
                objlist.ScientistCustomerId = k.ScientistCustomerId;
                objlist.RequiredQty = k.RequiredQty;
                objlist.IntRequiredQty = 0;
                if (!string.IsNullOrEmpty(k.RequiredQty))
                {
                    try
                    {
                        objlist.IntRequiredQty = Convert.ToInt32(k.RequiredQty);
                    }
                    catch (Exception)
                    {
                        objlist.IntRequiredQty = 0;
                    }
                }
                objlist.ProjectStatus = k.ProjectStatus;
                objlist.ScientistStatus = k.ScientistStatus;
                objlist.BatchCode1 = k.BatchCode1;
                objlist.BatchCode2 = k.BatchCode2;
                objlist.Qty1 = k.Qty1;
                objlist.Qty2 = k.Qty2;
                objlist.BatchNo = k.BatchNo;
                objlist.AdditionalBatchNo = k.AdditionalBatchNo;
                objlist.MoveToDispatch = k.MoveToDispatch;
                objlist.MoveToProject = k.MoveToProject;
                objlist.Remark = k.Remark;
                objlist.IsSynthesisLog = k.IsSynthesisLog;
                objlist.EstimateCompleteDate = k.EstimateCompleteDate;
                if (k.ProjectStatus != null)
                {
                    objlist.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
                }
                objlist.ScientistStatustext = scientistStatusList.Where(x => x.Id == k.ScientistStatus).Select(x => x.Name).FirstOrDefault();
                objlist.SubScientistName = k.SubScientistName;
                if (k.ProductId.HasValue)
                {
                    string selected = string.Empty;
                    objlist.AdditionalBatchNoText = "<select id='additionalBatch_" + k.ProductId + "' class='addbatch'><option value=''>--Select--</option>";
                    var proBatchData = szInventory.Where(x => x.ProductId == k.ProductId).OrderBy(x => x.Id).ToList();
                    if (proBatchData.Count > 0)
                    {
                        int probatchcount = 1;
                        proBatchData.ForEach(r =>
                        {
                            //foreach (var r in proBatchData)
                            //{
                            string qty = CommonOperation.SettleQtyForSPMS(r);
                            string text = r.BatchNo + " (" + qty + ")";
                            if (r.IsApproved == false)
                            {
                                text = "*" + text;
                            }

                            if (k.AdditionalBatchNo.HasValue && k.AdditionalBatchNo.Value == r.Id)
                            {
                                selected = " selected ";
                            }
                            objlist.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' data-value='" + r.BatchNo + "' " + selected + ">" + text + "</option>";
                            probatchcount += 1;
                            //}
                        });
                    }
                    objlist.AdditionalBatchNoText += "</select>";
                    objlist.APIName = productdatas.Where(x => x.Id == k.ProductId.Value).Select(x => x.MainCatName).FirstOrDefault();
                    //objlist.APIName = GetApiNameOfProduct(k.ProductId.Value, categoryData, productCategoryData);
                }
                objlist.Reason = k.Reason;
                objlist.IsOnHold = k.IsOnHold;
                objlist.TrackingNo = k.TrackingNo;
                objlist.QueryText = k.QueryText;
                objlist.QueryDate = k.QueryDate;
                objlist.IsAssignProjectQuery = k.IsAssignProjectQuery;
                objlist.IsAssignScientistQuery = k.IsAssignScientistQuery;
                objlist.IsQueryResolved = k.IsQueryResolved;
                objlist.IsPriority = k.IsPriority;
                objlist.Chemist = k.Chemist;

                objlist.ReviewSciStatus = k.ReviewSciStatus;
                if (!string.IsNullOrEmpty(k.DifficultyLevel))
                {
                    EnumList.DifficultyLevel oldfoo = (EnumList.DifficultyLevel)Enum.ToObject(typeof(EnumList.DifficultyLevel), Convert.ToInt32(k.DifficultyLevel));
                    objlist.DifficultyLevel = Common.GetDescription<EnumList.DifficultyLevel>(oldfoo);
                }
                subList.SZ_QuotationProductModel.Add(objlist);
                list.Add(subList);
                //}
            });

            var listCompItems = new List<SelectListItem>();
            listCompItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var compData = scientistStatusList;

            compData.ForEach(term =>
            {
                //foreach (var term in compData)
                //{
                listCompItems.Add(new SelectListItem
                {
                    Text = term.Name,
                    Value = term.Id.ToString()
                });
                //}
            });

            ViewBag.listScientistStatus = listCompItems;
            //string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
            //ViewBag.NoActionCount = list.
            //    Select(z => z.SZ_QuotationProductModel.Where(x => string.IsNullOrEmpty(x.SubScientistName)
            //    && x.ReadyToDeliverScientistStatusId != x.ScientistStatus
            //    && x.ProjectType != inhouseProjectType && (x.IsOnHold == false || x.IsOnHold == null)
            //    && string.IsNullOrEmpty(x.TrackingNo)).Count()).Sum(x => x);

            //ViewBag.All = list.
            //    Select(z => z.SZ_QuotationProductModel.Where(x => !string.IsNullOrEmpty(x.SubScientistName) && x.ReadyToDeliverScientistStatusId != x.ScientistStatus && x.ProjectType != inhouseProjectType && (x.IsOnHold == false || x.IsOnHold == null) && (x.IsHoldManually == false || x.IsHoldManually == null) && string.IsNullOrEmpty(x.TrackingNo)).Count()).Sum(x => x);

            ////QcApproval
            ////ViewBag.Completed = list.
            ////    Select(z => z.SZ_QuotationProductModel.Where(x => x.ScientistStatus == x.ReadyToDeliverScientistStatusId && (x.IsOnHold == false || x.IsOnHold == null)).Count()).Sum(x => x);

            //ViewBag.Scaleup = list.
            //    Select(z => z.SZ_QuotationProductModel.Where(x => x.ReadyToDeliverScientistStatusId != x.ScientistStatus && x.ProjectType == inhouseProjectType && (x.IsOnHold == false || x.IsOnHold == null)).Count()).Sum(x => x);

            //ViewBag.Hold = list.
            //    Select(z => z.SZ_QuotationProductModel.Where(x => x.IsHoldManually == true).Count()).Sum(x => x);

            //ViewBag.Cancelled = list.
            //    Select(z => z.SZ_QuotationProductModel.Where(x => x.IsOnHold == true).Count()).Sum(x => x);

            //ViewBag.Query = list.
            //    Select(z => z.SZ_QuotationProductModel.Where(x => !string.IsNullOrEmpty(x.QueryText)).Count()).Sum(x => x);

            //ViewBag.SynthesisLog = list.
            //    Select(z => z.SZ_QuotationProductModel.Where(x => x.IsSynthesisLog == true && string.IsNullOrEmpty(z.PONumber)).Count()).Sum(x => x);


            var dbb = new SynzealLiveEntities();
            using (var connection = dbb.Database.Connection)
            {
                connection.Open();
                var command = connection.CreateCommand();
                command.CommandText = "EXEC [dbo].[Scientist_Count] " + SessionCookieManagement.UserId + "," + Convert.ToString(SessionCookieManagement.UserId);

                using (var reader = command.ExecuteReader())
                {
                    var NoActionCount = ((System.Data.Entity.Infrastructure.IObjectContextAdapter)dbb)
                            .ObjectContext
                            .Translate<int>(reader)
                            .ToList();
                    ViewBag.NoActionCount = NoActionCount[0];
                    reader.NextResult();

                    ViewBag.All = ((System.Data.Entity.Infrastructure.IObjectContextAdapter)dbb)
                            .ObjectContext
                            .Translate<int>(reader)
                            .ToList()[0];

                    reader.NextResult();

                    ViewBag.All = ((System.Data.Entity.Infrastructure.IObjectContextAdapter)dbb)
                            .ObjectContext
                            .Translate<int>(reader)
                            .ToList()[0];

                    reader.NextResult();

                    ViewBag.All = ((System.Data.Entity.Infrastructure.IObjectContextAdapter)dbb)
                            .ObjectContext
                            .Translate<int>(reader)
                            .ToList()[0];

                    reader.NextResult();

                    ViewBag.Cancelled = ((System.Data.Entity.Infrastructure.IObjectContextAdapter)dbb)
                            .ObjectContext
                            .Translate<int>(reader)
                            .ToList()[0];

                    reader.NextResult();
                    ViewBag.SynthesisLog = ((System.Data.Entity.Infrastructure.IObjectContextAdapter)dbb)
                            .ObjectContext
                            .Translate<int>(reader)
                            .ToList()[0];
                }
            }

            return View(list.OrderByDescending(x => x.MoveToScientistDate).ToList());
        }
        #endregion

        #region HSNCode
        public ActionResult HSNCodeList()
        {
            if (!SessionCookieManagement.IsAdmin && !SessionCookieManagement.IsMiniAdmin && !SessionCookieManagement.IsQuote)
            {
                return RedirectToAction("Index", "Home");
            }
            var model = db.SZ_HSNCode.ToList();
            return View(model);
        }

        public ActionResult AddHSNCode(int id = 0)
        {
            var model = db.SZ_HSNCode.Where(x => x.Id == id).FirstOrDefault();
            if (model == null)
                model = new SZ_HSNCode();

            return View(model);
        }
        [HttpPost]
        public JsonResult AddHSNCodeData(string name, int id)
        {
            try
            {
                if (id == 0)
                {
                    SZ_HSNCode objComp = new SZ_HSNCode();
                    objComp.Name = name;
                    db.SZ_HSNCode.Add(objComp);
                    db.SaveChanges();
                }
                else
                {
                    var comp = db.SZ_HSNCode.Where(x => x.Id == id).FirstOrDefault();
                    if (comp != null)
                    {
                        comp.Name = name;
                        db.Entry(comp).State = EntityState.Modified;
                        db.SaveChanges();
                    }
                }

                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = ""
                }, JsonRequestBehavior.AllowGet);
            }
        }
        #endregion

        #region GeographicalList
        public ActionResult GeographicalList()
        {
            if (!SessionCookieManagement.IsAdmin && !SessionCookieManagement.IsMiniAdmin && !SessionCookieManagement.IsQuote)
            {
                return RedirectToAction("Index", "Home");
            }
            var model = db.SZ_Geographical.ToList();
            return View(model);
        }

        public ActionResult AddGeographical(int id = 0)
        {
            var model = db.SZ_Geographical.Where(x => x.Id == id).FirstOrDefault();
            if (model == null)
                model = new SZ_Geographical();

            return View(model);
        }
        [HttpPost]
        public JsonResult AddGeographicalData(string name, int id)
        {
            try
            {
                if (id == 0)
                {
                    SZ_Geographical objComp = new SZ_Geographical();
                    objComp.Name = name;
                    objComp.CreatedDate = DateTime.Now;
                    objComp.UpdatedDate = DateTime.Now;
                    objComp.CreatedBy = SessionCookieManagement.UserName;
                    objComp.UpdatedBy = SessionCookieManagement.UserName;
                    db.SZ_Geographical.Add(objComp);
                    db.SaveChanges();
                }
                else
                {
                    var comp = db.SZ_Geographical.Where(x => x.Id == id).FirstOrDefault();
                    if (comp != null)
                    {
                        comp.Name = name;
                        comp.UpdatedDate = DateTime.Now;
                        comp.UpdatedBy = SessionCookieManagement.UserName;
                        db.Entry(comp).State = EntityState.Modified;
                        db.SaveChanges();
                    }
                }

                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = ""
                }, JsonRequestBehavior.AllowGet);
            }
        }
        #endregion

        #region Company & Courier

        public ActionResult CourierList()
        {
            if (!SessionCookieManagement.IsAdmin && !SessionCookieManagement.IsMiniAdmin)
            {
                return RedirectToAction("Index", "Home");
            }
            var model = db.SZ_Courier.ToList();
            return View(model);
        }

        public ActionResult AdditionalTestList()
        {
            if (!SessionCookieManagement.IsAdmin && !SessionCookieManagement.IsMiniAdmin)
            {
                return RedirectToAction("Index", "Home");
            }
            var model = db.SZ_AdditionalTest.OrderBy(x => x.DisplayOrder).ToList();
            return View(model);

        }
        
        public ActionResult UnfreezQty(int id)
        {
            var data = db.SZ_ReservedQty.Where(x => x.Id == id).FirstOrDefault();
            if (data != null)
            {
                db.Entry(data).State = EntityState.Deleted;
                db.SaveChanges();
            }
            return Json(true, JsonRequestBehavior.AllowGet);
        }

        public ActionResult AddReservedQty(int id = 0, string refData = "")
        {
            var szquotedetail = db.SZ_QuotationDetail.Where(x => x.Id == id).FirstOrDefault();
            ViewBag.CATNo = szquotedetail.CATNo;
            if (refData == "quote")
            {
                ViewBag.RefData = szquotedetail.SZ_Quotation.Ref;
            }
            else
            {
                ViewBag.RefData = szquotedetail.SZ_Quotation.PONo;
            }

            var htmlstring = PartialViewdata(this, "AddReservedQty", null);
            return Json(htmlstring, JsonRequestBehavior.AllowGet);
        }

        public ActionResult AddCourier(int id = 0)
        {
            var model = db.SZ_Courier.Where(x => x.Id == id).FirstOrDefault();
            if (model == null)
                model = new SZ_Courier();

            return View(model);
        }

        public ActionResult AddAdditionalTest(int id = 0)
        {
            var model = db.SZ_AdditionalTest.Where(x => x.Id == id).FirstOrDefault();
            if (model == null)
                model = new SZ_AdditionalTest();

            return View(model);
        }
        [HttpPost]
        public JsonResult AddResearvedQtyData(int batchid, int qty, string reason, string refdata)
        {
            try
            {
                var inventory = db.SZ_Inventory.Where(x => x.Id == batchid).FirstOrDefault();
                var product = db.Products.Where(x => x.Id == inventory.ProductId).FirstOrDefault();
                SZ_ReservedQty objComp = new SZ_ReservedQty();
                objComp.BatchId = batchid;
                objComp.ProductId = product.Id;
                objComp.CATNo = product.Sku;
                objComp.BatchId = batchid;
                objComp.BatchNo = inventory.BatchNo;
                objComp.CreatedBy = SessionCookieManagement.UserId;
                objComp.CreatedByName = SessionCookieManagement.UserName;
                objComp.Qty = qty;
                objComp.Reason = reason;
                objComp.Ref = refdata;
                objComp.CreatedDate = DateTime.Now;
                db.SZ_ReservedQty.Add(objComp);
                db.SaveChanges();

                MemoryCacheManager objCache = new MemoryCacheManager();
                objCache.Remove("cache.resQtyList");
                objCache.Remove("cache.resQtyList");

                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = ""
                }, JsonRequestBehavior.AllowGet);
            }
        }
        [HttpPost]
        public JsonResult AddCourierData(string name, int id)
        {
            try
            {
                if (id == 0)
                {
                    SZ_Courier objComp = new SZ_Courier();
                    objComp.Name = name;
                    db.SZ_Courier.Add(objComp);
                    db.SaveChanges();
                }
                else
                {
                    var comp = db.SZ_Courier.Where(x => x.Id == id).FirstOrDefault();
                    if (comp != null)
                    {
                        comp.Name = name;
                        db.Entry(comp).State = EntityState.Modified;
                        db.SaveChanges();
                    }
                }

                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = ""
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        public JsonResult AddAdditionalTestdata(SZ_AdditionalTest model)
        {
            try
            {
                if (model.Id == 0)
                {
                    SZ_AdditionalTest objComp = new SZ_AdditionalTest();
                    objComp.Test = model.Test;
                    objComp.INR = model.INR;
                    objComp.USD = model.USD;
                    objComp.GBP = model.GBP;
                    objComp.EURO = model.EURO;
                    objComp.DisplayOrder = model.DisplayOrder;
                    objComp.MakeDefault = model.MakeDefault;
                    db.SZ_AdditionalTest.Add(objComp);
                    db.SaveChanges();
                }
                else
                {
                    var comp = db.SZ_AdditionalTest.Where(x => x.Id == model.Id).FirstOrDefault();
                    if (comp != null)
                    {
                        comp.Test = model.Test;
                        comp.INR = model.INR;
                        comp.USD = model.USD;
                        comp.GBP = model.GBP;
                        comp.EURO = model.EURO;
                        comp.DisplayOrder = model.DisplayOrder;
                        comp.MakeDefault = model.MakeDefault;
                        db.Entry(comp).State = EntityState.Modified;
                        db.SaveChanges();
                    }
                }
                MemoryCacheManager objCache = new MemoryCacheManager();
                objCache.Remove("cache.AdditionalTestData");
                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = ""
                }, JsonRequestBehavior.AllowGet);
            }
        }

        public ActionResult ScientistStatusList()
        {
            if (!SessionCookieManagement.IsAdmin)
            {
                return RedirectToAction("Index", "Home");
            }
            var model = db.SZ_ScientistStatus.ToList();
            return View(model);
        }

        public ActionResult AddScientistStatus(int id = 0)
        {
            var model = db.SZ_ScientistStatus.Where(x => x.Id == id).FirstOrDefault();
            if (model == null)
                model = new SZ_ScientistStatus();

            return View(model);
        }
        [HttpPost]
        public JsonResult ScientistStatusListData(string name, int id)
        {
            try
            {
                if (id == 0)
                {
                    SZ_ScientistStatus objComp = new SZ_ScientistStatus();
                    objComp.Name = name;
                    db.SZ_ScientistStatus.Add(objComp);
                    db.SaveChanges();
                }
                else
                {
                    var comp = db.SZ_ScientistStatus.Where(x => x.Id == id).FirstOrDefault();
                    if (comp != null)
                    {
                        comp.Name = name;
                        db.Entry(comp).State = EntityState.Modified;
                        db.SaveChanges();
                    }
                }

                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = ""
                }, JsonRequestBehavior.AllowGet);
            }
        }
        public ActionResult UserManagement()
        {
            if (!SessionCookieManagement.IsAdmin)
            {
                return RedirectToAction("Index", "Home");
            }
            MemoryCacheManager objCache = new MemoryCacheManager();

            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });
            var companyData = db.SZ_CompanyList.ToList();
            var model = db.SZ_UserManagement.ToList();
            var resultModel = new List<UserManagementModel>();
            if (model != null && model.Count > 0)
            {
                var customerIds = model.Select(x => x.UserId).ToList();
                var customerData = db.Customers.Where(x => customerIds.Contains(x.Id)).ToList();
                model.ForEach(item =>
                {
                    string emailAddress = customerData.Where(x => x.Id == item.UserId).Select(x => x.Email).FirstOrDefault();
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == item.UserId).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    string companyName = string.Empty;
                    var compids = new List<int>();
                    if (!string.IsNullOrEmpty(item.CompanyIds))
                    {
                        var cids = item.CompanyIds.Split(',');
                        cids.ForEach(i =>
                        {
                            if (!string.IsNullOrEmpty(i))
                            {
                                compids.Add(Convert.ToInt32(i));
                            }
                        });

                        if (compids != null && compids.Count > 0)
                        {
                            var companyNameList = db.SZ_CompanyList.Where(x => compids.Contains(x.Id)).Select(x => x.Name).ToList();
                            companyName = string.Join(",", companyNameList);
                        }
                    }
                    UserManagementModel objModel = new UserManagementModel();
                    objModel.Id = item.Id;
                    objModel.Username = customerName;
                    objModel.EmailAddress = emailAddress;
                    objModel.CompanyNames = companyName;
                    objModel.isNewsLetter = item.isNewsLetter;
                    objModel.IsNotification = item.IsNotification;
                    objModel.IsPaymentShow = item.IsPaymentShow;
                    resultModel.Add(objModel);
                });
            }

            return View(resultModel);
        }

        public ActionResult SampleReasonList()
        {
            if (!SessionCookieManagement.IsAdmin && !SessionCookieManagement.IsDispatch)
            {
                return RedirectToAction("Index", "Home");
            }
            var model = db.SZ_SampleReason.ToList();
            return View(model);
        }

        public ActionResult AddUserManagement(int id = 0)
        {
            MemoryCacheManager objCache = new MemoryCacheManager();

            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });

            var model = db.SZ_UserManagement.Where(x => x.Id == id).FirstOrDefault();
            if (model == null)
                model = new SZ_UserManagement();


            var customerlist = db.Customers.Where(x => x.Deleted == false).OrderBy(x => x.Email).ToList();
            var companyList = db.SZ_CompanyList.OrderBy(x => x.Name).ToList();
            var languageList = db.Languages.OrderBy(x => x.Name).ToList();
            var listItems = new List<SelectListItem>();
            listItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            foreach (var term in companyList)
            {
                listItems.Add(new SelectListItem
                {
                    Text = term.Name + " (" + term.Country + ")",
                    Value = term.Id.ToString()
                });
            }
            ViewBag.compList = listItems;

            var listlangItems = new List<SelectListItem>();
            listlangItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            foreach (var term in languageList)
            {
                listlangItems.Add(new SelectListItem
                {
                    Text = term.Name,
                    Value = term.Id.ToString()
                });
            }
            ViewBag.langList = listlangItems;

            var userlistItems = new List<SelectListItem>();
            userlistItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            foreach (var term in customerlist)
            {
                if (string.IsNullOrEmpty(term.Email))
                {
                    continue;
                }
                //string customerName = string.Empty;
                //var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                //if (genericAttr.Count > 0)
                //{
                //    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                //}
                userlistItems.Add(new SelectListItem
                {
                    Text = term.Email,
                    Value = term.Id.ToString()
                });
            }
            ViewBag.userList = userlistItems;

            return View(model);
        }


        public ActionResult AddSampleReason(int id = 0)
        {
            var model = db.SZ_SampleReason.Where(x => x.Id == id).FirstOrDefault();
            if (model == null)
                model = new SZ_SampleReason();

            return View(model);
        }

        public ActionResult StabilityDocument(int id)
        {
            var childCoaData = db.SZ_ChildCOA.Where(x => x.MasterCOAID == id).ToList();

            string batchNo = string.Empty;
            if (childCoaData != null && childCoaData.Count > 0)
            {
                batchNo = childCoaData.Select(x => x.BatchNo).FirstOrDefault();
            }
            ViewBag.BatchNo = batchNo;
            var htmlstring = PartialViewdata(this, "_PartialStabilityDocument", childCoaData).Replace("\r\n", "");
            htmlstring = "<html><head></head><body style='font-family:Tahoma, Verdana, Segoe, sans-serif;font-size:11px;'>" + htmlstring + "</body></html>";
            //string path = printpdf(htmlstring, "Invoice_SynZeal_Order_Confirmation", true);
            string path = ConvertHTMLToPDF(htmlstring, "StabilityDocument", false);
            return File(path, "application/pdf", Server.UrlEncode("StabilityDocument-" + DateTime.Now.ToString("HHmm") + "-" + DateTime.Now.ToString("yy") + "-" + DateTime.Now.ToString("ddMM") + ".pdf"));
        }


        public ActionResult StabilityDocumentWord(int id)
        {
            string imageurl = string.Empty;
            string savedocumenturl = string.Empty;
            if (Request.Url.Authority.Contains("localhost"))
            {
                imageurl = @"E:\Image.jpg";
                savedocumenturl = @"E:\";
            }
            else
            {
                savedocumenturl = @"D:\Plesk\Vhosts\synzeal.com\spms.synzeal.com\Content\Quotation\";
                imageurl = @"D:\Plesk\Vhosts\synzeal.com\spms.synzeal.com\images\Image.jpg";
            }

            var childCoaData = db.SZ_ChildCOA.Where(x => x.MasterCOAID == id).ToList();
            string batchNo = string.Empty;
            if (childCoaData != null && childCoaData.Count > 0)
            {
                batchNo = childCoaData.Select(x => x.BatchNo).FirstOrDefault();
            }
            int numberofRows = childCoaData.Count + 1;
            try
            {
                //Create an instance for word app  
                Microsoft.Office.Interop.Word.Application winword = new Microsoft.Office.Interop.Word.Application();

                //Set animation status for word application  
                winword.ShowAnimation = false;

                //Set status for word application is to be visible or not.  
                winword.Visible = false;

                //Create a missing variable for missing value  
                object missing = System.Reflection.Missing.Value;

                //Create a new document  
                Microsoft.Office.Interop.Word.Document document = winword.Documents.Add(ref missing, ref missing, ref missing, ref missing);
                object oEndOfDoc = "\\endofdoc";
                Microsoft.Office.Interop.Word.Range range = document.Bookmarks.get_Item(ref oEndOfDoc).Range;
                range.Application.ActiveDocument.InlineShapes.AddPicture(imageurl);

                //Add header into the document  
                foreach (Microsoft.Office.Interop.Word.Section section in document.Sections)
                {
                    //Get the header range and add the header details.  
                    Microsoft.Office.Interop.Word.Range headerRange = section.Headers[Microsoft.Office.Interop.Word.WdHeaderFooterIndex.wdHeaderFooterPrimary].Range;
                    headerRange.Fields.Add(headerRange, Microsoft.Office.Interop.Word.WdFieldType.wdFieldPage);
                    headerRange.ParagraphFormat.Alignment = Microsoft.Office.Interop.Word.WdParagraphAlignment.wdAlignParagraphLeft;
                    //headerRange.Font.ColorIndex = Microsoft.Office.Interop.Word.WdColorIndex.wdBlue;
                    headerRange.Font.Size = 10;
                    //headerRange.Text = "Date: " + DateTime.Now.ToShortDateString();
                    //headerRange.Application.ActiveDocument.InlineShapes.AddPicture(@"E:\Image.jpg");
                    //Microsoft.Office.Interop.Word.Range rng = document.Tables[1].Cell(1, 3).Range;
                    var shape = headerRange.InlineShapes.AddPicture(imageurl, ref missing, ref missing, ref missing);
                    shape.ScaleHeight = 25;
                    shape.ScaleWidth = 26;
                    winword.Visible = true;

                }

                //Add the footers into the document  
                foreach (Microsoft.Office.Interop.Word.Section wordSection in document.Sections)
                {
                    //Get the footer range and add the footer details.  
                    Microsoft.Office.Interop.Word.Range footerRange = wordSection.Footers[Microsoft.Office.Interop.Word.WdHeaderFooterIndex.wdHeaderFooterPrimary].Range;
                    footerRange.Font.ColorIndex = Microsoft.Office.Interop.Word.WdColorIndex.wdDarkBlue;
                    footerRange.Font.Size = 10;
                    footerRange.ParagraphFormat.Alignment = Microsoft.Office.Interop.Word.WdParagraphAlignment.wdAlignParagraphCenter;
                    footerRange.Text = "www.synzeal.com";
                }

                //adding text to document  
                document.Content.SetRange(0, 0);
                document.Content.Text = Environment.NewLine + "Date: " + DateTime.Now.ToShortDateString() + "" + Environment.NewLine;

                //Add paragraph with Heading 1 style  
                //Microsoft.Office.Interop.Word.Paragraph para1 = document.Content.Paragraphs.Add(ref missing);
                //object styleHeading1 = "Heading 1";
                //para1.Range.set_Style(ref styleHeading1);
                //para1.Range.Text = "Para 1 text";
                //para1.Range.InsertParagraphAfter();

                //Add paragraph with Heading 2 style  
                Microsoft.Office.Interop.Word.Paragraph para2 = document.Content.Paragraphs.Add(ref missing);
                //object styleHeading2 = "Heading 2";
                //para2.Range.set_Style(ref styleHeading2);
                para2.Range.Text = Environment.NewLine + "Stability Statement for the Batch No " + batchNo + "" + Environment.NewLine;
                para2.Range.ParagraphFormat.Alignment = Microsoft.Office.Interop.Word.WdParagraphAlignment.wdAlignParagraphCenter;
                para2.Range.Font.Bold = 1;
                para2.Range.Font.ColorIndex = Microsoft.Office.Interop.Word.WdColorIndex.wdBlack;
                para2.Range.InsertParagraphAfter();


                Microsoft.Office.Interop.Word.Paragraph para3 = document.Content.Paragraphs.Add(ref missing);
                //object styleHeading3 = "Heading 3";
                //para3.Range.set_Style(ref styleHeading3);
                para3.Range.Text = "Following is the summary of the analysis done for batch No " + batchNo;
                para3.Range.ParagraphFormat.Alignment = Microsoft.Office.Interop.Word.WdParagraphAlignment.wdAlignParagraphCenter;
                para3.Range.Font.ColorIndex = Microsoft.Office.Interop.Word.WdColorIndex.wdBlack;
                para3.Range.InsertParagraphAfter();

                //Create a 5X5 table and insert some dummy record  
                Microsoft.Office.Interop.Word.Paragraph para1 = document.Content.Paragraphs.Add(ref missing);
                para1.SpaceBefore = 0.0f;
                para1.SpaceAfter = 0.0f;
                Microsoft.Office.Interop.Word.Table firstTable = document.Tables.Add(para1.Range, numberofRows, 5);
                firstTable.Range.ParagraphFormat.SpaceAfter = 0.0f;

                firstTable.Borders.OutsideLineStyle = Microsoft.Office.Interop.Word.WdLineStyle.wdLineStyleSingle;
                firstTable.Borders.InsideLineStyle = Microsoft.Office.Interop.Word.WdLineStyle.wdLineStyleSingle;

                foreach (Microsoft.Office.Interop.Word.Row row in firstTable.Rows)
                {
                    foreach (Microsoft.Office.Interop.Word.Cell cell in row.Cells)
                    {

                        //Header row  
                        if (cell.RowIndex == 1)
                        {
                            if (cell.ColumnIndex == 1)
                            {
                                cell.Range.Text = "Sr. No.";
                            }
                            if (cell.ColumnIndex == 2)
                            {
                                cell.Range.Text = "Batch No";
                            }
                            if (cell.ColumnIndex == 3)
                            {
                                cell.Range.Text = "HPLC Purity";
                            }
                            if (cell.ColumnIndex == 4)
                            {
                                cell.Range.Text = "Analysis Date";
                            }
                            if (cell.ColumnIndex == 5)
                            {
                                cell.Range.Text = "Certificate No";
                            }

                            //cell.Range.Text = "Column " + cell.ColumnIndex.ToString();
                            //other format properties goes here  
                            //cell.Range.Font.Name = "verdana";
                            cell.Range.Font.Size = 10;

                            //cell.Range.Font.ColorIndex = WdColorIndex.wdGray25;                              
                            cell.Shading.BackgroundPatternColor = Microsoft.Office.Interop.Word.WdColor.wdColorGray25;
                            //Center alignment for the Header cells  
                            cell.VerticalAlignment = Microsoft.Office.Interop.Word.WdCellVerticalAlignment.wdCellAlignVerticalBottom;
                            cell.Range.ParagraphFormat.Alignment = Microsoft.Office.Interop.Word.WdParagraphAlignment.wdAlignParagraphCenter;

                        }
                        //Data row  
                        else
                        {
                            cell.Range.Font.Size = 9;
                            cell.Range.Font.Bold = 0;
                            var coaresult = childCoaData[cell.RowIndex - 2];
                            if (cell.ColumnIndex == 1)
                            {
                                cell.Range.Text = (cell.RowIndex - 1).ToString();
                            }
                            if (cell.ColumnIndex == 2)
                            {
                                cell.Range.Text = coaresult.BatchNo;
                            }
                            if (cell.ColumnIndex == 3)
                            {
                                cell.Range.Text = coaresult.HPLCGCELSD + "%";
                            }
                            if (cell.ColumnIndex == 4)
                            {
                                cell.Range.Text = coaresult.AnalysisDate.HasValue ? coaresult.AnalysisDate.Value.ToShortDateString() : "";
                            }
                            if (cell.ColumnIndex == 5)
                            {
                                cell.Range.Text = coaresult.RefNo;
                            }
                            //cell.Range.Text = (cell.RowIndex - 2 + cell.ColumnIndex).ToString();
                        }
                    }
                }

                Microsoft.Office.Interop.Word.Paragraph para4 = document.Content.Paragraphs.Add(ref missing);
                //object styleHeading4 = "Heading 4";
                //para4.Range.set_Style(ref styleHeading4);
                para4.Range.Font.Bold = 0;
                para4.Range.Font.Size = 9;
                para4.Range.Text = Environment.NewLine + "Based on the above analysis at different intervals product is stable at storage conditions mentioned in the COA. The validity of the COA can be extended up to two years from the latest purity test.";
                para4.Range.ParagraphFormat.Alignment = Microsoft.Office.Interop.Word.WdParagraphAlignment.wdAlignParagraphLeft;
                para4.Range.InsertParagraphAfter();


                Microsoft.Office.Interop.Word.Paragraph para5 = document.Content.Paragraphs.Add(ref missing);
                //object styleHeading5 = "Heading 5";
                //para5.Range.set_Style(ref styleHeading5);
                para5.Range.Font.Bold = 0;
                para5.Range.Font.Size = 9;
                para5.Range.Text = "Note # Purity test performed using our in-house method of analysis. There are chances of variations in purity by +/ -1 - 2 %." + Environment.NewLine + Environment.NewLine + "Authorized Signatory," + Environment.NewLine + "SynZeal Research Pvt Ltd.";
                para5.Range.ParagraphFormat.Alignment = Microsoft.Office.Interop.Word.WdParagraphAlignment.wdAlignParagraphLeft;
                para5.Range.InsertParagraphAfter();


                string file = Guid.NewGuid().ToString();
                //Save the document  
                object filename = savedocumenturl + "" + file + ".docx";
                string filepath = savedocumenturl + "" + file + ".docx";
                document.SaveAs2(ref filename);
                document.Close(ref missing, ref missing, ref missing);
                document = null;
                winword.Quit(ref missing, ref missing, ref missing);
                winword = null;
                return File(filepath, "application/document", Server.UrlEncode("StabilityDocument-" + DateTime.Now.ToString("HHmm") + "-" + DateTime.Now.ToString("yy") + "-" + DateTime.Now.ToString("ddMM") + ".docx"));
            }
            catch (Exception ex)
            {
                return Content("Error: " + ex.Message + " / " + ex.StackTrace);
            }
            return Content("success");
        }

        public JsonResult GetUserManagementDataByCompanyIds(string companyIds)
        {
            var compids = new List<string>();
            if (!string.IsNullOrEmpty(companyIds))
            {
                var compstrids = companyIds.Split(',');
                foreach (var item in compstrids)
                {
                    if (!string.IsNullOrEmpty(item))
                    {
                        compids.Add(item);
                    }
                }
            }
            MemoryCacheManager objCache = new MemoryCacheManager();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });
            var resultModel = new List<UserManagementModel>();
            var model = db.SZ_UserManagement.Where(x => compids.Any(z => x.CompanyIds.Contains(z))).ToList();
            var customerIds = model.Select(x => x.UserId).Distinct().ToList();
            var customerData = db.Customers.Where(x => customerIds.Contains(x.Id)).ToList();
            model.ForEach(item =>
            {
                string emailAddress = customerData.Where(x => x.Id == item.UserId).Select(x => x.Email).FirstOrDefault();
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == item.UserId).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }

                UserManagementModel objModel = new UserManagementModel();
                objModel.Username = customerName;
                objModel.EmailAddress = emailAddress;
                resultModel.Add(objModel);
            });

            return Json(resultModel, JsonRequestBehavior.AllowGet);
        }


        [HttpPost]
        public JsonResult UserManagementData(UserManagementModel model)
        {
            try
            {
                if (model.Id == 0)
                {
                    SZ_UserManagement objComp = new SZ_UserManagement();
                    objComp.DefaultCurrencyId = model.DefaultCurrencyId;
                    objComp.UserId = model.UserId;
                    objComp.CompanyIds = model.CompanyIds;
                    objComp.IsNotification = model.IsNotification;
                    objComp.IsPaymentShow = model.IsPaymentShow;
                    objComp.isNewsLetter = model.isNewsLetter;
                    objComp.CreatedDate = DateTime.Now;
                    objComp.CreatedBy = SessionCookieManagement.UserName;
                    db.SZ_UserManagement.Add(objComp);
                    db.SaveChanges();
                }
                else
                {
                    var comp = db.SZ_UserManagement.Where(x => x.Id == model.Id).FirstOrDefault();
                    if (comp != null)
                    {
                        comp.DefaultCurrencyId = model.DefaultCurrencyId;
                        comp.UserId = model.UserId;
                        comp.CompanyIds = model.CompanyIds;
                        comp.IsNotification = model.IsNotification;
                        comp.IsPaymentShow = model.IsPaymentShow;
                        comp.isNewsLetter = model.isNewsLetter;
                        db.Entry(comp).State = EntityState.Modified;
                        db.SaveChanges();
                    }
                }

                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = ""
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        public JsonResult SampleReasonListData(string name, int id)
        {
            try
            {
                if (id == 0)
                {
                    SZ_SampleReason objComp = new SZ_SampleReason();
                    objComp.Name = name;
                    db.SZ_SampleReason.Add(objComp);
                    db.SaveChanges();
                }
                else
                {
                    var comp = db.SZ_SampleReason.Where(x => x.Id == id).FirstOrDefault();
                    if (comp != null)
                    {
                        comp.Name = name;
                        db.Entry(comp).State = EntityState.Modified;
                        db.SaveChanges();
                    }
                }

                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = ""
                }, JsonRequestBehavior.AllowGet);
            }
        }

        public ActionResult PhysicalStateList()
        {
            if (!SessionCookieManagement.IsAdmin)
            {
                return RedirectToAction("Index", "Home");
            }
            var model = db.SZ_Physicalstate.ToList();
            return View(model);
        }

        public ActionResult PhysicalState(int id = 0)
        {
            var model = db.SZ_Physicalstate.Where(x => x.Id == id).FirstOrDefault();
            if (model == null)
                model = new SZ_Physicalstate();

            return View(model);
        }

        [HttpPost]
        public JsonResult PhysicalStateData(string name, int id)
        {
            try
            {
                if (id == 0)
                {
                    SZ_Physicalstate objComp = new SZ_Physicalstate();
                    objComp.Name = name;
                    db.SZ_Physicalstate.Add(objComp);
                    db.SaveChanges();
                }
                else
                {
                    var comp = db.SZ_Physicalstate.Where(x => x.Id == id).FirstOrDefault();
                    if (comp != null)
                    {
                        comp.Name = name;
                        db.Entry(comp).State = EntityState.Modified;
                        db.SaveChanges();
                    }
                }

                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = ""
                }, JsonRequestBehavior.AllowGet);
            }
        }

        public ActionResult CompanyList()
        {
            if (!SessionCookieManagement.IsAdmin && !SessionCookieManagement.IsFollowUp && !SessionCookieManagement.IsProjectLogin)
            {
                return RedirectToAction("Index", "Home");
            }

            return View();
        }

        public ActionResult TransferCompany(int id = 0)
        {
            var model = db.SZ_CompanyList.Where(x => x.Id == id).OrderBy(x => x.Name).FirstOrDefault();
            if (model == null)
                model = new SZ_CompanyList();

            var listItems = new List<SelectListItem>();
            listItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var terms = db.SZ_CompanyList.Where(x => x.Id != id).OrderBy(x => x.Name).ToList();
            foreach (var term in terms)
            {
                listItems.Add(new SelectListItem
                {
                    Text = term.Name,
                    Value = term.Id.ToString()
                });
            }
            ViewBag.compList = listItems;
            return View(model);
        }

        public ActionResult AddCompany(int id = 0)
        {
            var model = db.SZ_CompanyList.Where(x => x.Id == id).FirstOrDefault();
            if (model == null)
                model = new SZ_CompanyList();

            var listItems = new List<SelectListItem>();
            listItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var terms = db.SZ_Terms.ToList();
            foreach (var term in terms)
            {
                listItems.Add(new SelectListItem
                {
                    Text = term.Name,
                    Value = term.Id.ToString()
                });
            }

            ViewBag.termsList = listItems;

            var listBDItems = new List<SelectListItem>();
            listBDItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var listProjectItems = new List<SelectListItem>();
            listProjectItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });

            ViewBag.bdList = CommonOperation.GetCustomerRoleSelectedList("quote");
            ViewBag.projectList = CommonOperation.GetCustomerRoleSelectedList("project");

            var listPaymentTermsItems = new List<SelectListItem>();
            listPaymentTermsItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var paymentTermData = db.PaymentTerms.OrderBy(x => x.Id).ToList();
            foreach (var term in paymentTermData)
            {
                listPaymentTermsItems.Add(new SelectListItem
                {
                    Text = term.Name,
                    Value = term.Name.ToString()
                });
            }

            ViewBag.listPaymentTermsItems = listPaymentTermsItems;

            var listCountryItems = new List<SelectListItem>();
            listCountryItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var countries = db.Countries.OrderBy(x => x.name).ToList();
            foreach (var term in countries)
            {
                listCountryItems.Add(new SelectListItem
                {
                    Text = term.name,
                    Value = term.name
                });
            }

            ViewBag.CountryList = listCountryItems;

            var GeographicalLocationList = new List<SelectListItem>();
            GeographicalLocationList.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });

            MemoryCacheManager objCache = new MemoryCacheManager();
            var geographicalLocationData = objCache.Get("cache.geographicalLocationData", () =>
            {
                return db.SZ_Geographical.OrderBy(x => x.Id).ToList();
            });

            if (geographicalLocationData != null && geographicalLocationData.Count > 0)
            {
                geographicalLocationData.ForEach(item =>
                {
                    GeographicalLocationList.Add(new SelectListItem
                    {
                        Text = item.Name,
                        Value = item.Id.ToString()
                    });
                });
            }
            ViewBag.GeographicalLocationList = GeographicalLocationList;

            return View(model);
        }


        public ActionResult MSDS(int id = 0)
        {
            var model = db.SZ_ChildCOA.Where(x => x.Id == id).FirstOrDefault();
            if (model != null)
            {
                ViewBag.productname = model.ProductName;
                ViewBag.childcoaid = id;
                ViewBag.casno = model.CASNo;
                ViewBag.chemicalname = model.Chemicalname;
                ViewBag.Synonyms = model.Synonym;
                ViewBag.molweight = model.MolecularWeight;
                ViewBag.molformula = model.MolFormula;
                ViewBag.Appearance = model.AppearanceProduct;
                ViewBag.Physicalstate = model.PhysicalState;
            }
            return View();
        }

        [HttpPost]
        public JsonResult AddMSDSData(FormCollection form)
        {
            int coaid = Convert.ToInt32(form.Get("childcoaid"));
            TempData["productname"] = form.Get("productname");
            TempData["casno"] = form.Get("casno");
            TempData["chemicalname"] = form.Get("chemicalname");
            TempData["Synonyms"] = form.Get("Synonyms");
            TempData["molweight"] = form.Get("molweight");
            TempData["molformula"] = form.Get("molformula");
            TempData["Appearance"] = form.Get("Appearance");
            TempData["Physicalstate"] = form.Get("Physicalstate");

            return Json(new { success = true }, JsonRequestBehavior.AllowGet);
        }
        public ActionResult DownloadMSDS()
        {
            var htmlstring = string.Empty;
            ViewBag.productname = TempData["productname"];
            ViewBag.casno = TempData["casno"];
            ViewBag.chemicalname = TempData["chemicalname"];
            ViewBag.Synonyms = TempData["Synonyms"];
            ViewBag.molweight = TempData["molweight"];
            ViewBag.molformula = TempData["molformula"];
            ViewBag.Appearance = TempData["Appearance"];
            ViewBag.Physicalstate = TempData["Physicalstate"];
            htmlstring = System.IO.File.ReadAllText(Server.MapPath("~/Mail/MSDS.html"));

            htmlstring = htmlstring.Replace("~physicalState", ViewBag.Physicalstate);
            htmlstring = htmlstring.Replace("~appearance", ViewBag.Appearance);
            htmlstring = htmlstring.Replace("~productname", ViewBag.productname);
            htmlstring = htmlstring.Replace("~casno", ViewBag.casno);
            htmlstring = htmlstring.Replace("~chemicalname", ViewBag.chemicalname);
            htmlstring = htmlstring.Replace("~synonum", ViewBag.Synonyms);
            htmlstring = htmlstring.Replace("~molweight", ViewBag.molweight);
            htmlstring = htmlstring.Replace("~molformula", ViewBag.molformula);

            string path = ConvertHTMLToPDF(htmlstring, "testmsds-" + DateTime.Now.ToShortDateString().Replace("/", "_"), true);
            return File(path, "application/pdf", Server.UrlEncode("MSDS-" + DateTime.Now.ToString("HHmm") + "-" + DateTime.Now.ToString("yy") + "-" + DateTime.Now.ToString("ddMM") + ".pdf"));
        }

        public ActionResult GenerateInvoicePdf(int id)
        {
            var obj = db.SZ_InvoiceDetailsData.Where(x => x.QuoteDetailsId == id).FirstOrDefault();
            var htmlstring = PartialViewdata(this, "_PartialInvoicePDF", obj.SZ_InvoiceData);
            htmlstring = "<html><head></head><body style='font-family:Tahoma, Verdana, Segoe, sans-serif;font-size:11px;'>" + htmlstring + "</body></html>";
            //string path = printpdf(htmlstring, "Invoice_SynZeal_Order_Confirmation", true);
            string path = ConvertHTMLToPDF(htmlstring, "Invoice_SynZeal_Order_Confirmation", false);
            return File(path, "application/pdf", Server.UrlEncode("Invoice-" + DateTime.Now.ToString("HHmm") + "-" + DateTime.Now.ToString("yy") + "-" + DateTime.Now.ToString("ddMM") + ".pdf"));
        }
        public ActionResult DownloadInvoice(int id)
        {
            var obj = db.SZ_InvoiceData.Where(x => x.Id == id).FirstOrDefault();
            var htmlstring = PartialViewdata(this, "_PartialInvoicePDF", obj).Replace("\r\n", "");
            htmlstring = "<html><head></head><body style='font-family:Tahoma, Verdana, Segoe, sans-serif;font-size:11px;'>" + htmlstring + "</body></html>";
            //string path = printpdf(htmlstring, "Invoice_SynZeal_Order_Confirmation", true);
            string path = ConvertHTMLToPDF(htmlstring, "Invoice_SynZeal_Order_Confirmation", false);
            return File(path, "application/pdf", Server.UrlEncode(filenameDateWise("Invoice") + ".pdf"));
        }


        public ActionResult DailyProjectReport(string startdate, string enddate)
        {
            string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
            var sDate = Convert.ToDateTime(startdate);
            var eDate = Convert.ToDateTime(enddate);
            var list = (from i in db.SZ_Quotation
                        join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                        where t2.MoveToProject == true
                        && string.IsNullOrEmpty(t2.TrackingNo)
                        && (t2.IsOnHold == false || t2.IsOnHold == null)
                        && (t2.ProjectType != inhouseProjectType || t2.ProjectType == null)
                        orderby t2.MoveProjectDate descending
                        select t2).Distinct().AsQueryable();

            ViewBag.AllProductCount = list.Count();

            var data = (from i in db.SZ_Quotation
                        join qd in db.SZ_QuotationDetail on i.Id equals qd.QuoteId
                        where sDate <= qd.MoveProjectDate && qd.MoveProjectDate <= eDate
                        select qd).ToList();

            var instock = Convert.ToString((int)EnumList.ProjectType.InStock);
            var synthesis = Convert.ToString((int)EnumList.ProjectType.Synthesis);
            var purchase = Convert.ToString((int)EnumList.ProjectType.Purchase);
            var pursynthesis = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
            var datapending = Convert.ToString((int)EnumList.ProStatusDDL.DataPending);
            var qcapproval = Convert.ToString((int)EnumList.ProStatusDDL.QCApproval);
            var readyfordispatch = Convert.ToString((int)EnumList.ProStatusDDL.ReadyforDispatch);
            ViewBag.Date = sDate.ToShortDateString() + " - " + eDate.ToShortDateString();
            ViewBag.POCount = data.Select(x => x.SZ_Quotation.PONo).Distinct().Count();

            ViewBag.DomesticPOCount = data.Where(x => (x.SZ_Quotation.CountryTypeId == 1 || x.SZ_Quotation.CountryType == null)).Select(x => x.SZ_Quotation.PONo).Distinct().Count();
            ViewBag.ExportPOCount = data.Where(x => x.SZ_Quotation.CountryTypeId == 2).Select(x => x.SZ_Quotation.PONo).Distinct().Count();

            ViewBag.POProductCount = data.Select(x => x.Id).Distinct().Count();

            ViewBag.DomesticPOProductCount = data.Where(x => (x.SZ_Quotation.CountryTypeId == 1 || x.SZ_Quotation.CountryType == null)).Select(x => x.Id).Distinct().Count();
            ViewBag.ExportPOProductCount = data.Where(x => x.SZ_Quotation.CountryTypeId == 2).Select(x => x.Id).Distinct().Count();

            ViewBag.DomesticInStock = data.Where(x => x.ProjectType == instock
                                        && x.SZ_Quotation.CountryTypeId == 1).Count();

            ViewBag.TodaysDispatch = (from i in db.SZ_Quotation
                                      join qd in db.SZ_QuotationDetail on i.Id equals qd.QuoteId
                                      where sDate <= qd.TrackingNoDate && qd.TrackingNoDate <= eDate
                                      && !string.IsNullOrEmpty(qd.TrackingNo)
                                      select qd).Count();

            ViewBag.DomesticTodaysDispatch = (from i in db.SZ_Quotation
                                              join qd in db.SZ_QuotationDetail on i.Id equals qd.QuoteId
                                              where sDate <= qd.TrackingNoDate && qd.TrackingNoDate <= eDate
                                              && !string.IsNullOrEmpty(qd.TrackingNo)
                                              && (i.CountryTypeId == 1 || i.CountryType == null)
                                              select qd).Count();

            ViewBag.ExportTodaysDispatch = (from i in db.SZ_Quotation
                                            join qd in db.SZ_QuotationDetail on i.Id equals qd.QuoteId
                                            where sDate <= qd.TrackingNoDate && qd.TrackingNoDate <= eDate
                                            && !string.IsNullOrEmpty(qd.TrackingNo)
                                            && (i.CountryTypeId == 2)
                                            select qd).Count();

            ViewBag.ExportInStock = data.Where(x => x.ProjectType == instock
                                        && x.SZ_Quotation.CountryTypeId == 2).Count();

            ViewBag.DomesticSynthesis = data.Where(x => x.ProjectType == synthesis
                                        && x.SZ_Quotation.CountryTypeId == 1).Count();

            ViewBag.ExportSynthesis = data.Where(x => x.ProjectType == synthesis
                                        && x.SZ_Quotation.CountryTypeId == 2).Count();

            ViewBag.DomesticPurchase = data.Where(x => x.ProjectType == purchase
                                        && x.SZ_Quotation.CountryTypeId == 1).Count();

            ViewBag.ExportPurchase = data.Where(x => x.ProjectType == purchase
                                        && x.SZ_Quotation.CountryTypeId == 2).Count();

            ViewBag.DomesticPurSynthesis = data.Where(x => x.ProjectType == pursynthesis
                                        && x.SZ_Quotation.CountryTypeId == 1).Count();

            ViewBag.ExportPurSynthesis = data.Where(x => x.ProjectType == pursynthesis
                                        && x.SZ_Quotation.CountryTypeId == 2).Count();

            ViewBag.DomesticNoAction = data.Where(x => (x.ScientistCustomerId == 0 || x.ScientistCustomerId == null)
                                        && x.ProjectType == instock
                                        && (x.ProStatus == datapending || string.IsNullOrEmpty(x.ProStatus))
                                        && x.SZ_Quotation.CountryTypeId == 1).Count();

            ViewBag.ExportNoAction = data.Where(x => (x.ScientistCustomerId == 0 || x.ScientistCustomerId == null)
                                        && x.ProjectType == instock
                                        && (x.ProStatus == datapending || string.IsNullOrEmpty(x.ProStatus))
                                        && x.SZ_Quotation.CountryTypeId == 2).Count();

            ViewBag.DomesticQC = data.Where(x => (x.ScientistCustomerId == 0 || x.ScientistCustomerId == null)
                                        && x.ProjectType == instock
                                        && (x.ProStatus == qcapproval)
                                        && x.SZ_Quotation.CountryTypeId == 1).Count();

            ViewBag.ExportQC = data.Where(x => (x.ScientistCustomerId == 0 || x.ScientistCustomerId == null)
                                        && x.ProjectType == instock
                                        && (x.ProStatus == qcapproval)
                                        && x.SZ_Quotation.CountryTypeId == 2).Count();

            ViewBag.DomesticReady = data.Where(x => (x.ScientistCustomerId == 0 || x.ScientistCustomerId == null)
                                        && x.ProjectType == instock
                                        && (x.ProStatus == readyfordispatch)
                                        && x.SZ_Quotation.CountryTypeId == 1).Count();

            ViewBag.ExportReady = data.Where(x => (x.ScientistCustomerId == 0 || x.ScientistCustomerId == null)
                                        && x.ProjectType == instock
                                        && (x.ProStatus == readyfordispatch)
                                        && x.SZ_Quotation.CountryTypeId == 2).Count();

            //---------------------------------------------------------------------------------------------
            ViewBag.TotalDomesticInStock = list.Where(x => x.ProjectType == instock
                                        && x.SZ_Quotation.CountryTypeId == 1).Count();

            ViewBag.TotalExportInStock = list.Where(x => x.ProjectType == instock
                                        && x.SZ_Quotation.CountryTypeId == 2).Count();

            ViewBag.TotalDomesticSynthesis = list.Where(x => x.ProjectType == synthesis
                                        && x.SZ_Quotation.CountryTypeId == 1).Count();

            ViewBag.TotalExportSynthesis = list.Where(x => x.ProjectType == synthesis
                                        && x.SZ_Quotation.CountryTypeId == 2).Count();

            ViewBag.TotalDomesticSynthesis = Convert.ToInt32(ViewBag.TotalDomesticSynthesis) + Convert.ToInt32(ViewBag.TotalExportSynthesis);

            ViewBag.TotalDomesticPurchase = list.Where(x => x.ProjectType == purchase
                                        && x.SZ_Quotation.CountryTypeId == 1).Count();

            ViewBag.TotalExportPurchase = list.Where(x => x.ProjectType == purchase
                                        && x.SZ_Quotation.CountryTypeId == 2).Count();

            ViewBag.TotalDomesticPurchase = Convert.ToInt32(ViewBag.TotalDomesticPurchase) + Convert.ToInt32(ViewBag.TotalExportPurchase);

            ViewBag.TotalPurchaseSubmitted = list.Where(x => x.ProjectType == purchase
                                        && x.PurchaseDDLStatus == "28").Count();

            ViewBag.TotalDomesticPurSynthesis = list.Where(x => x.ProjectType == pursynthesis
                                        && x.SZ_Quotation.CountryTypeId == 1).Count();

            ViewBag.TotalExportPurSynthesis = list.Where(x => x.ProjectType == pursynthesis
                                        && x.SZ_Quotation.CountryTypeId == 2).Count();
            ViewBag.TotalDomesticPurSynthesis = Convert.ToInt32(ViewBag.TotalDomesticPurSynthesis) + Convert.ToInt32(ViewBag.TotalExportPurSynthesis);

            ViewBag.TotalDomesticNoAction = list.Where(x => (x.ScientistCustomerId == 0 || x.ScientistCustomerId == null)
                                        && x.ProjectType == instock
                                        && (x.ProStatus == datapending
                                            || string.IsNullOrEmpty(x.ProStatus)
                                            || x.ProStatus == "Approval First"
                                            || x.ProStatus == "Immediate Dispatch"
                                            || x.ProStatus == "Short Qty Dispatch"
                                            || x.ProStatus == "Short Qty Dispatched"
                                            || x.ProStatus == "Repeat Order")
                                        && (x.MoveToDispatch == null || x.MoveToDispatch == false)
                                        && x.SZ_Quotation.CountryTypeId == 1).Count();

            ViewBag.TotalExportNoAction = list.Where(x => (x.ScientistCustomerId == 0 || x.ScientistCustomerId == null)
                                        && x.ProjectType == instock
                                        && (x.ProStatus == datapending
                                            || string.IsNullOrEmpty(x.ProStatus)
                                            || x.ProStatus == "Approval First"
                                            || x.ProStatus == "Immediate Dispatch"
                                            || x.ProStatus == "Short Qty Dispatch"
                                            || x.ProStatus == "Short Qty Dispatched"
                                            || x.ProStatus == "Repeat Order")
                                        && (x.MoveToDispatch == null || x.MoveToDispatch == false)
                                        && x.SZ_Quotation.CountryTypeId == 2).Count();

            ViewBag.TotalDomesticQC = list.Where(x => (x.ScientistCustomerId == 0 || x.ScientistCustomerId == null)
                                        && x.ProjectType == instock
                                        && (x.ProStatus == qcapproval)
                                        && x.SZ_Quotation.CountryTypeId == 1).Count();

            ViewBag.TotalExportQC = list.Where(x => (x.ScientistCustomerId == 0 || x.ScientistCustomerId == null)
                                        && x.ProjectType == instock
                                        && (x.ProStatus == qcapproval)
                                        && x.SZ_Quotation.CountryTypeId == 2).Count();

            ViewBag.TotalDomesticReady = list.Where(x => x.ProjectType == instock
                                        && (x.ProStatus == readyfordispatch || x.ActivityStatus == "Data Approved")
                                        && x.SZ_Quotation.CountryTypeId == 1).Count();

            ViewBag.TotalExportReady = list.Where(x => x.ProjectType == instock
                                        && (x.ProStatus == readyfordispatch || x.ActivityStatus == "Data Approved")
                                        && x.SZ_Quotation.CountryTypeId == 2).Count();

            ViewBag.TotalDomesticDataPending = list.Where(x => x.ProjectType == instock
                                        && (x.ActivityStatus == "Approval First")
                                        && (x.ProStatus == readyfordispatch)
                                        && x.SZ_Quotation.CountryTypeId == 1).Count();

            ViewBag.TotalExportDataPending = list.Where(x => x.ProjectType == instock
                                        && (x.ActivityStatus == "Approval First")
                                        && (x.ProStatus == readyfordispatch)
                                        && x.SZ_Quotation.CountryTypeId == 2).Count();

            ViewBag.TotalDomesticDataSend = list.Where(x => x.ProjectType == instock
                                        && (x.ActivityStatus == "Data Sent")
                                        && x.SZ_Quotation.CountryTypeId == 1).Count();

            ViewBag.TotalExportDataSend = list.Where(x => x.ProjectType == instock
                                        && (x.ActivityStatus == "Data Sent")
                                        && x.SZ_Quotation.CountryTypeId == 2).Count();

            ViewBag.TotalDomesticDataApproval = list.Where(x => x.ProjectType == instock
                                        && (x.ActivityStatus == "Data Approved")
                                        && x.SZ_Quotation.CountryTypeId == 1).Count();

            ViewBag.TotalExportDataApproval = list.Where(x => x.ProjectType == instock
                                        && (x.ActivityStatus == "Data Approved")
                                        && x.SZ_Quotation.CountryTypeId == 2).Count();

            int sortQTY = (int)EnumList.DispatchStatus.SortQty;
            int unpackedQty = (int)EnumList.DispatchStatus.Unpacked;
            int packedQty = (int)EnumList.DispatchStatus.Packed;

            ViewBag.TotalDomesticDataApprovalunPacked = (from i in db.SZ_Quotation
                                                         join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                                                         where t2.MoveToDispatch == true
                                                         && (t2.MoveToInvoice == false || t2.MoveToInvoice == null)
                                                         && (t2.IsOnHold == false || t2.IsOnHold == null)
                                                         && (i.CountryTypeId == 1 || string.IsNullOrEmpty(i.CountryType))
                                                         && (t2.DispatchedStatus == unpackedQty || t2.DispatchedStatus == null)
                                                         orderby t2.MoveDispatchDate descending
                                                         select t2).Count();

            ViewBag.TotalDomesticDataApprovalPacked = (from i in db.SZ_Quotation
                                                       join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                                                       where t2.MoveToDispatch == true
                                                       && (t2.MoveToInvoice == false || t2.MoveToInvoice == null)
                                                       && (t2.IsOnHold == false || t2.IsOnHold == null)
                                                       && (i.CountryTypeId == 1 || string.IsNullOrEmpty(i.CountryType))
                                                       && (t2.DispatchedStatus == packedQty)
                                                       orderby t2.MoveDispatchDate descending
                                                       select t2).Count();

            ViewBag.TotalExportDataApprovalunPacked = (from i in db.SZ_Quotation
                                                       join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                                                       where t2.MoveToDispatch == true
                                                       && (t2.MoveToInvoice == false || t2.MoveToInvoice == null)
                                                       && (t2.IsOnHold == false || t2.IsOnHold == null)
                                                       && i.CountryTypeId == 2
                                                       && (t2.DispatchedStatus == unpackedQty || t2.DispatchedStatus == null)
                                                       orderby t2.MoveDispatchDate descending
                                                       select t2).Count();

            ViewBag.TotalExportDataApprovalPacked = (from i in db.SZ_Quotation
                                                     join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                                                     where t2.MoveToDispatch == true
                                                     && (t2.MoveToInvoice == false || t2.MoveToInvoice == null)
                                                     && (t2.IsOnHold == false || t2.IsOnHold == null)
                                                     && i.CountryTypeId == 2
                                                     && (t2.DispatchedStatus == packedQty)
                                                     orderby t2.MoveDispatchDate descending
                                                     select t2).Count();

            var htmlstring = PartialViewdata(this, "_PartialDailyProjectReport", null);
            // string path = ConvertHTMLToPDF(htmlstring, "Project_PDF", false);
            string path = printpdf(htmlstring, "Project_PDF", true, isLandscap: true);
            return File(path, "application/pdf", Server.UrlEncode("Project_PDF-" + DateTime.Now.ToString("HHmm") + "-" + DateTime.Now.ToString("yy") + "-" + DateTime.Now.ToString("ddMM") + ".pdf"));
        }

        [HttpPost]
        public JsonResult AddNameMasterData(string sku, string ep, string usp, string other, string chemDraw, int id,
            string epchemicalname, string uspchemicalname, string OtherNameOne,
            string OtherNameSecond, string OtherNameThird, string OtherNameFour,
            string OtherNameFive, string OtherNameSix, string OtherNameSeven)
        {
            try
            {
                if (id == 0)
                {
                    SZ_NameMaster objComp = new SZ_NameMaster();
                    objComp.Sku = sku;
                    objComp.EP = ep;
                    objComp.USP = usp;
                    objComp.Other = other;
                    objComp.ChemDraw = chemDraw;
                    objComp.CreatedDate = DateTime.Now;
                    objComp.EPChemicalName = epchemicalname;
                    objComp.USPChemicalName = uspchemicalname;
                    objComp.OtherNameOne = OtherNameOne;
                    objComp.OtherNameSecond = OtherNameSecond;
                    objComp.OtherNameThird = OtherNameThird;
                    objComp.OtherNameFour = OtherNameFour;
                    objComp.OtherNameFive = OtherNameFive;
                    objComp.OtherNameSix = OtherNameSix;
                    objComp.OtherNameSeven = OtherNameSeven;
                    db.SZ_NameMaster.Add(objComp);
                    db.SaveChanges();
                }
                else
                {
                    var objComp = db.SZ_NameMaster.Where(x => x.Id == id).FirstOrDefault();
                    if (objComp != null)
                    {
                        objComp.Sku = sku;
                        objComp.EP = ep;
                        objComp.USP = usp;
                        objComp.Other = other;
                        objComp.ChemDraw = chemDraw;
                        objComp.EPChemicalName = epchemicalname;
                        objComp.USPChemicalName = uspchemicalname;
                        objComp.OtherNameOne = OtherNameOne;
                        objComp.OtherNameSecond = OtherNameSecond;
                        objComp.OtherNameThird = OtherNameThird;
                        objComp.OtherNameFour = OtherNameFour;
                        objComp.OtherNameFive = OtherNameFive;
                        objComp.OtherNameSix = OtherNameSix;
                        objComp.OtherNameSeven = OtherNameSeven;
                        objComp.UpdatedDate = DateTime.Now;
                        db.Entry(objComp).State = EntityState.Modified;
                        db.SaveChanges();
                    }
                }

                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = ""
                }, JsonRequestBehavior.AllowGet);
            }
        }

        public ActionResult NameMasterList()
        {
            if (!SessionCookieManagement.IsAdmin && !SessionCookieManagement.IsDispatch)
            {
                return RedirectToAction("Index", "Home");
            }
            var model = db.SZ_NameMaster.ToList();
            return View(model);
        }

        public ActionResult AddNameMasterCompany(int id = 0)
        {
            var model = db.SZ_NameMaster.Where(x => x.Id == id).FirstOrDefault();
            if (model == null)
                model = new SZ_NameMaster();

            return View(model);
        }

        public JsonResult GetCompanyInformationByCompanyId(int id)
        {
            CompanyModel model = new CompanyModel();
            var comp = db.SZ_CompanyList.Where(x => x.Id == id).FirstOrDefault();
            if (comp != null)
            {
                model.id = comp.Id;
                model.CountryType = comp.CountryType;
                model.masteremail = comp.MasterEmail;
                model.UserDistType = comp.UserDistType;
                model.TermsId = comp.TermsId.HasValue ? comp.TermsId.Value.ToString() : "";
                model.PaymentTerms = comp.PaymentTerms;
                model.IsBlockCompany = comp.IsBlockCompany;
                model.InccoTerm = comp.InccoTerm;
            }

            return Json(model, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public JsonResult TransferCompanyData(int id, int transferCompanyId, bool isDelete)
        {
            try
            {
                try
                {
                    var companyData = db.SZ_CompanyList.Where(x => x.Id == id).FirstOrDefault();
                    var transferedData = db.SZ_CompanyList.Where(x => x.Id == transferCompanyId).FirstOrDefault();

                    if (companyData != null && transferedData != null)
                    {
                        var allQuotes = db.SZ_Quotation.Where(x => x.CompanyId == companyData.Id).ToList();
                        allQuotes.ForEach(x =>
                        {
                            x.CompanyName = transferedData.Name;
                            x.CompanyId = transferedData.Id;
                        });
                        db.SaveChanges();

                        var allemailsuggestions = db.SZ_EmailSuggestion.Where(x => x.CompanyID == companyData.Id).ToList();
                        allemailsuggestions.ForEach(x =>
                        {
                            x.CompanyID = transferedData.Id;
                        });
                        db.SaveChanges();

                        if (isDelete)
                        {
                            var companyAddressData = db.SZ_CompanyAddress.Where(x => x.CompanyId == companyData.Id).ToList();
                            if (companyAddressData != null && companyAddressData.Count > 0)
                            {
                                foreach (var item in companyAddressData)
                                {
                                    db.Entry(item).State = EntityState.Deleted;
                                }
                            }
                            db.Entry(companyData).State = EntityState.Deleted;
                            db.SaveChanges();
                        }
                    }
                }
                catch (Exception ex)
                {
                    return Json(new
                    {
                        success = false,
                        message = ex.Message
                    }, JsonRequestBehavior.AllowGet);
                }


                return Json(new
                {
                    success = true,
                    message = "Company transfered successfully."
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = ex.Message
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        public JsonResult AddCompanyData(CompanyModel model, FormCollection form)
        {
            try
            {
                if (model.id == 0)
                {
                    var checkcompanyavailable = db.SZ_CompanyList.Where(x => x.Name.ToLower() == model.name.ToLower()).FirstOrDefault();
                    if (checkcompanyavailable == null)
                    {
                        SZ_CompanyList objComp = new SZ_CompanyList();
                        objComp.Name = model.name;
                        objComp.Address = model.address;
                        objComp.Location = model.Location;
                        objComp.MasterEmail = model.masteremail;
                        objComp.CountryType = model.CountryType;
                        objComp.UserDistType = model.UserDistType;
                        objComp.TermsId = model.TermsId != null ? Convert.ToInt32(model.TermsId) : 0;
                        objComp.PaymentTerms = model.PaymentTerms;
                        objComp.FollowupTime = model.FollowupTime;
                        objComp.Contact = model.Contact;
                        objComp.Country = model.Country;
                        objComp.IsPaymentPending = model.IsPaymentPending;
                        objComp.Branch = model.Branch;
                        objComp.CreatedDate = DateTime.Now;
                        objComp.UpdatedDate = DateTime.Now;
                        objComp.IsBlockCompany = model.IsBlockCompany;
                        objComp.CreatedBy = SessionCookieManagement.UserName;
                        objComp.UpdatedBy = SessionCookieManagement.UserName;
                        objComp.Add1 = model.Add1;
                        objComp.Add2 = model.Add2;
                        objComp.City = model.City;
                        objComp.State = model.State;
                        objComp.PostCode = model.PostCode;
                        objComp.ShipAdd1 = model.ShipAdd1;
                        objComp.ShipAdd2 = model.ShipAdd2;
                        objComp.ShipCity = model.ShipCity;
                        objComp.ShipState = model.ShipState;
                        objComp.ShipCountry = model.ShipCountry;
                        objComp.Telno = model.Telno;
                        objComp.ShipTelno = model.ShipTelno;
                        objComp.ShipPostCode = model.ShipPostCode;
                        objComp.IsConversionReport = model.IsConversionReport;
                        objComp.BDTeam = model.BDTeam;
                        objComp.ProjectTeam = model.ProjectTeam;
                        objComp.SAPCode = model.SAPCode;
                        objComp.ClientSuggestedComment = model.ClientSuggestedComment;
                        objComp.AnalyticalData = model.AnalyticalData;
                        objComp.GeographicalLocation = model.GeographicalLocation;
                        objComp.IsQuoteHide = model.IsQuoteHide;
                        objComp.IsApprovedFirst = model.IsApprovedFirst;
                        db.SZ_CompanyList.Add(objComp);
                        db.SaveChanges();

                        ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12 |
                                       SecurityProtocolType.Tls11 |
                                       SecurityProtocolType.Tls |
                                       SecurityProtocolType.Ssl3;
                        MailMessage mail = new MailMessage();
                        SmtpClient SmtpServer = new SmtpClient(ConfigurationManager.AppSettings["Email.Host"]);
                        mail.From = new MailAddress(ConfigurationManager.AppSettings["Email.Username"], "SynZeal Standards");
                        var isDevelopment = ConfigurationManager.AppSettings["IsDevelopment"];
                        if (isDevelopment.ToLower().Contains("true"))
                        {
                            mail.To.Add(ConfigurationManager.AppSettings["DevEmailAddress"].ToString());
                        }
                        else
                        {
                            mail.To.Add("support@synzeal.com");
                        }
                        mail.Subject = "SynZeal Research PVT LTD New Company Added (" + model.name + ") :: Dated : " + System.DateTime.Now.ToShortDateString();
                        mail.IsBodyHtml = true;
                        SmtpServer.Port = Convert.ToInt32(ConfigurationManager.AppSettings["Port"]);
                        SmtpServer.Credentials = new System.Net.NetworkCredential(ConfigurationManager.AppSettings["Email.Username"], ConfigurationManager.AppSettings["Email.Password"]);
                        mail.Body = "Hello, <br> New company added by " + SessionCookieManagement.UserEmail + "<br> Thanks";
                        SmtpServer.EnableSsl = true;
                        SmtpServer.Send(mail);
                    }
                    else
                    {
                        return Json(new
                        {
                            success = false,
                            message = "Company already available."
                        }, JsonRequestBehavior.AllowGet);
                    }
                }
                else
                {
                    var checkcompanyavailable = db.SZ_CompanyList.Where(x => x.Name.ToLower() == model.name.ToLower() && x.Id != model.id).FirstOrDefault();
                    if (checkcompanyavailable != null)
                    {
                        return Json(new
                        {
                            success = false,
                            message = "Company already available."
                        }, JsonRequestBehavior.AllowGet);
                    }
                    var comp = db.SZ_CompanyList.Where(x => x.Id == model.id).FirstOrDefault();
                    if (comp != null)
                    {
                        string previousName = comp.Name;
                        comp.Name = model.name;
                        comp.Address = model.address;
                        comp.Location = model.Location;
                        comp.MasterEmail = model.masteremail;
                        comp.CountryType = model.CountryType;
                        comp.UserDistType = model.UserDistType;
                        comp.TermsId = model.TermsId != null && model.TermsId != "null" ? Convert.ToInt32(model.TermsId) : 0;
                        comp.FollowupTime = model.FollowupTime;
                        comp.Contact = model.Contact;
                        comp.Country = model.Country;
                        comp.IsPaymentPending = model.IsPaymentPending;
                        comp.IsBlockCompany = model.IsBlockCompany;
                        comp.Branch = model.Branch;
                        comp.UpdatedDate = DateTime.Now;
                        comp.UpdatedBy = SessionCookieManagement.UserName;
                        comp.PaymentTerms = model.PaymentTerms;
                        comp.Add1 = model.Add1;
                        comp.Add2 = model.Add2;
                        comp.City = model.City;
                        comp.State = model.State;
                        comp.PostCode = model.PostCode;
                        comp.ShipAdd1 = model.ShipAdd1;
                        comp.ShipAdd2 = model.ShipAdd2;
                        comp.ShipCity = model.ShipCity;
                        comp.ShipState = model.ShipState;
                        comp.ShipCountry = model.ShipCountry;
                        comp.Telno = model.Telno;
                        comp.ShipTelno = model.ShipTelno;
                        comp.ShipPostCode = model.ShipPostCode;
                        comp.IsConversionReport = model.IsConversionReport;
                        comp.BDTeam = model.BDTeam;
                        comp.ProjectTeam = model.ProjectTeam;
                        comp.SAPCode = model.SAPCode;
                        comp.AnalyticalData = model.AnalyticalData;
                        comp.ClientSuggestedComment = model.ClientSuggestedComment;
                        comp.GeographicalLocation = model.GeographicalLocation;
                        comp.IsQuoteHide = model.IsQuoteHide;
                        comp.IsApprovedFirst = model.IsApprovedFirst;
                        db.Entry(comp).State = EntityState.Modified;
                        db.SaveChanges();
                        if (comp.Name != previousName)
                        {
                            var allQuotes = db.SZ_Quotation.Where(x => x.CompanyId == comp.Id).ToList();
                            allQuotes.ForEach(x => x.CompanyName = comp.Name);
                            db.SaveChanges();
                        }
                    }
                }

                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = ""
                }, JsonRequestBehavior.AllowGet);
            }
        }

        public ActionResult AddNewCOARepresentative()
        {
            ViewBag.representativecoa = true;
            return View("_RightSideCOAInformation", new MasterCOAModel());
            //return View("AddMasterCOARepresentative", new SZ_ChildCOA());
        }

        public ActionResult ExportCatalouge()
        {
            var listCompItems = new List<SelectListItem>();
            //listCompItems.Add(new SelectListItem
            //{
            //    Text = "--Select--",
            //    Value = ""
            //});
            var compData = db.Categories.Where(x => x.ParentCategoryId == 0 && x.Deleted == false && x.Published == true).OrderBy(x => x.Name).ToList();
            listCompItems.Add(new SelectListItem
            {
                Text = "All",
                Value = ""
            });
            foreach (var term in compData)
            {
                listCompItems.Add(new SelectListItem
                {
                    Text = term.Name,
                    Value = term.Id.ToString()
                });
            }

            ViewBag.listAPIs = listCompItems;

            return View();
        }

        [ValidateInput(false)]
        [HttpPost]
        public JsonResult AddNewCOARepresentative(TermsModel passdata, FormCollection form)
        {
            try
            {
                string uniqueId = Request.Form.Get("uniqueId");
                string imagePath = string.Empty;
                if (TempData["ImagePath"] != null)
                {
                    imagePath = Convert.ToString(TempData["ImagePath"]);
                }
                else
                {
                    imagePath = form.Get("form[imgsynzealsrcproduct]");
                }
                string catnumber = form.Get("form[catno]");
                var masterrecord = new SZ_ChildCOA();
                masterrecord.ImagePath = imagePath;
                masterrecord.RefNo = form.Get("form[sku]") + "-" + DateTime.Now.ToString("HHmm");
                masterrecord.ProductName = form.Get("form[productname]");
                masterrecord.CATNo = form.Get("form[sku]");
                masterrecord.ProductId = Convert.ToInt32(form.Get("form[ProductId]"));
                masterrecord.IsRepresentative = false;
                masterrecord.CASNo = form.Get("form[casno]");
                masterrecord.MolFormula = form.Get("form[molecularformula]");
                masterrecord.MolecularWeight = form.Get("form[molecularweight]");
                masterrecord.AdditionalInfor = form.Get("form[AdditionalInfor]");
                masterrecord.IsEquation = form.Get("form[IsEquation]") == "on" ? true : false;
                masterrecord.Dept = form.Get("form[Dept]");
                masterrecord.TGALoss = form.Get("form[TGALoss]");
                masterrecord.Attachment = form.Get("form[Attachment]");
                masterrecord.Chemicalname = form.Get("form[Chemicalname]");
                masterrecord.HPLCGCELSD = form.Get("form[HPLCGCELSD]");
                masterrecord.Purity = form.Get("form[Purity]");
                masterrecord.IR = form.Get("form[IR]");
                masterrecord.Mass = form.Get("form[Mass]");
                masterrecord.Potency = form.Get("form[Potency]");
                masterrecord.BatchNo = form.Get("form[batchno]");
                masterrecord.ResidueOnIgnition = form.Get("form[ResidueOnIgnition]");
                masterrecord.CMR = form.Get("form[CMR]");
                masterrecord.NMR = form.Get("form[NMR]");
                masterrecord.StorageCon = form.Get("form[StorageCon]");
                masterrecord.AppearanceProduct = form.Get("form[AppearanceProduct]");
                masterrecord.SOLUBILITY = form.Get("form[SOLUBILITY]");
                masterrecord.BatchNo = form.Get("form[batchno]");
                masterrecord.Synonym = form.Get("form[synonym]");
                //masterrecord.MolecularWeight = form.Get("form[molecularweight]");
                //masterrecord.MolFormula = form.Get("form[molecularformula]");
                masterrecord.CreatedDate = DateTime.Now;
                masterrecord.UpdatedDate = DateTime.Now;
                masterrecord.EquationType = form.Get("form[EquationType]");
                if (!string.IsNullOrEmpty(form.Get("form[AnalysisDate]")))
                {
                    masterrecord.AnalysisDate = Convert.ToDateTime(form.Get("form[AnalysisDate]"));
                }
                else
                {
                    masterrecord.AnalysisDate = null;
                }
                if (!string.IsNullOrEmpty(form.Get("form[ReTestDate]")))
                {
                    masterrecord.ReTestDate = Convert.ToDateTime(form.Get("form[ReTestDate]"));
                }
                else
                {
                    masterrecord.ReTestDate = null;
                }
                masterrecord.IsLogoAttached = form.Get("form[IsLogoAttached]") == "on" ? true : false;
                masterrecord.IsManufacture = form.Get("form[IsManufacture]") == "on" ? true : false;
                if (!string.IsNullOrEmpty(form.Get("form[ManufactureDate]")))
                {
                    masterrecord.ManufactureDate = Convert.ToDateTime(form.Get("form[ManufactureDate]"));
                }
                else
                {
                    masterrecord.ManufactureDate = null;
                }
                masterrecord.OtherValue = form.Get("form[OtherValue]");
                masterrecord.IsShipping = form.Get("form[IsShipping]") == "on" ? true : false;

                masterrecord.UpdatedBy = SessionCookieManagement.UserName;
                masterrecord.CTheroretical = form.Get("form[CTheroretical]");
                masterrecord.HTheroretical = form.Get("form[HTheroretical]");
                masterrecord.NTheroretical = form.Get("form[NTheroretical]");
                masterrecord.STheroretical = form.Get("form[STheroretical]");
                masterrecord.CPractical = form.Get("form[CPractical]");
                masterrecord.HPractical = form.Get("form[HPractical]");
                masterrecord.NPractical = form.Get("form[NPractical]");
                masterrecord.SPractical = form.Get("form[SPractical]");
                masterrecord.WegithLossBy = form.Get("form[WegithLossBy]");
                string htmlstring = PartialViewdata(this, "_PartialSampleRepresentativeCOAPdf", masterrecord);
                string path = ConvertHTMLToPDF(htmlstring, filenameDateWise("SamplerepresentativeCOA"));

                return Json(new
                {
                    success = true,
                    path = path
                }, JsonRequestBehavior.AllowGet);
            }
            catch (DbEntityValidationException dbEx)
            {
                string str = string.Empty;
                foreach (var validationErrors in dbEx.EntityValidationErrors)
                {
                    foreach (var validationError in validationErrors.ValidationErrors)
                    {
                        str += "Property: " + validationError.PropertyName + " Error: " + validationError.ErrorMessage + " /     ";
                    }
                }


                return Json(new
                {
                    success = false,
                    message = str
                }, JsonRequestBehavior.AllowGet);
            }
        }

        public ActionResult DownloadFile(string path)
        {
            return File(path, "application/pdf", Server.UrlEncode("sampleRepresentative_COA.pdf"));
        }

        public ActionResult AddMasterCOARepresentative(int id = 0)
        {
            var childrecord = db.SZ_ChildCOA.Where(x => x.Id == id).FirstOrDefault();
            var batchlist = db.SZ_Inventory.Where(x => x.Id == childrecord.SZ_MasterCOA.BatchId).FirstOrDefault();
            var model = childrecord;
            string uri = Domain + "/api/RestAPI/ProductDetails?productId=" + batchlist.ProductId;
            using (HttpClient httpClient = new HttpClient())
            {
                Task<String> response = httpClient.GetStringAsync(uri);
                string productModel = JsonConvert.DeserializeObject<string>(response.Result);
                var product = JsonConvert.DeserializeObject<ProductDetailsModel>(productModel);

                if (childrecord.IsImageUpload.HasValue && childrecord.IsImageUpload.Value)
                {
                    ViewBag.ImagePath = childrecord.ImagePath.Replace("~", "..");
                }
                else
                {
                    ViewBag.ImagePath = product.DefaultPictureModel.ImageUrl;
                }
                ViewBag.CATNo = product.Sku;
                ViewBag.CASNo = product.ManufacturerPartNumber;
                ViewBag.MolecularWeight = product.MolecularWeight;
                ViewBag.MolFormula = product.Gtin;
                var nameMaster = db.SZ_NameMaster.Where(x => x.Sku.ToLower().Trim() == product.Sku.ToLower().Trim()).FirstOrDefault();

                model.BatchNo = Convert.ToString(id);
                if (string.IsNullOrEmpty(childrecord.ProductName))
                {
                    model.ProductName = product.Name;
                }
                else
                {
                    model.ProductName = childrecord.ProductName;
                }

                if (!string.IsNullOrEmpty(model.CASNo))
                {
                    ViewBag.CASNo = model.CASNo;
                }
                if (!string.IsNullOrEmpty(model.MolecularWeight))
                {
                    ViewBag.MolecularWeight = model.MolecularWeight;
                }
                if (!string.IsNullOrEmpty(model.MolFormula))
                {
                    ViewBag.MolFormula = model.MolFormula;
                }
                if (!childrecord.IsRepresentative)
                {
                    if (nameMaster != null)
                    {
                        model.EP = nameMaster.EP;
                        model.USP = nameMaster.USP;
                        model.IUPAC = nameMaster.ChemDraw;
                        model.EPChemicalName = nameMaster.EPChemicalName;
                        model.USPChemicalName = nameMaster.USPChemicalName;
                        model.OtherNameOne = nameMaster.OtherNameOne;
                        model.OtherNameSecond = nameMaster.OtherNameSecond;
                        model.OtherNameThird = nameMaster.OtherNameThird;

                        model.ChemEP = nameMaster.EP;
                        model.ChemUSP = nameMaster.USP;
                        model.ChemIUPAC = nameMaster.ChemDraw;
                        model.ChemEPChemicalName = nameMaster.EPChemicalName;
                        model.ChemUSPChemicalName = nameMaster.USPChemicalName;
                        model.ChemOtherNameOne = nameMaster.OtherNameOne;
                        model.ChemOtherNameSecond = nameMaster.OtherNameSecond;
                        model.ChemOtherNameThird = nameMaster.OtherNameThird;

                        model.SynEP = nameMaster.EP;
                        model.SynUSP = nameMaster.USP;
                        model.SynIUPAC = nameMaster.ChemDraw;
                        model.SynEPChemicalName = nameMaster.EPChemicalName;
                        model.SynUSPChemicalName = nameMaster.USPChemicalName;
                        model.SynOtherNameOne = nameMaster.OtherNameOne;
                        model.SynOtherNameSecond = nameMaster.OtherNameSecond;
                        model.SynOtherNameThird = nameMaster.OtherNameThird;
                    }
                }
            }
            return View(model);
        }

        [HttpPost]
        public ActionResult UploadRepresentativeCOAImage()
        {
            string ImagePath = string.Empty;
            string uniqueId = Request.Form.Get("uniqueId");

            for (int i = 0; i < Request.Files.Count; i++)
            {
                var file = Request.Files[i];

                var fileName = Path.GetFileName(file.FileName);
                var extension = Path.GetExtension(file.FileName);
                string newfileName = uniqueId + "" + extension;
                var path = Path.Combine(Server.MapPath("~/Content/COAProducts/"), newfileName);
                file.SaveAs(path);

                TempData["ImagePath"] = "~/Content/COAProducts/" + newfileName;

            }

            return Json(new
            {
                success = true,
                data = uniqueId
            }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public ActionResult ChildCOAFileUpload()
        {
            int childId = Convert.ToInt32(Request.Form.Get("childId"));
            var childrecord = db.SZ_ChildCOA.Where(x => x.Id == childId).FirstOrDefault();

            for (int i = 0; i < Request.Files.Count; i++)
            {
                var file = Request.Files[i];

                var fileName = Path.GetFileName(file.FileName);
                var extension = Path.GetExtension(file.FileName);
                string newfileName = Guid.NewGuid().ToString() + "" + extension;
                var path = Path.Combine(Server.MapPath("~/Content/COAProducts/"), newfileName);
                file.SaveAs(path);

                childrecord.ImagePath = "~/Content/COAProducts/" + newfileName;
                childrecord.IsImageUpload = true;
                db.Entry<SZ_ChildCOA>(childrecord).State = EntityState.Modified;
                db.SaveChanges();
            }

            return Json(new
            {
                success = true,
                data = childrecord.Id
            }, JsonRequestBehavior.AllowGet);
        }

        [ValidateInput(false)]
        [HttpPost]
        public JsonResult SaveNewMasterRecord(FormCollection form)
        {
            try
            {
                //passdata[Message]

                int bId = Convert.ToInt32(form.Get("form[BatchId]"));
                var batchRecord = db.SZ_Inventory.Where(x => x.Id == bId).FirstOrDefault();
                string catnumber = form.Get("form[sku]");
                int masterRecordId = Convert.ToInt32(form.Get("form[COAId]"));
                var masterrecord = db.SZ_MasterCOA.Where(x => x.Id == masterRecordId).FirstOrDefault();
                if (masterrecord == null)
                {
                    //Insert new Master and child
                    masterrecord = new SZ_MasterCOA();
                    masterrecord.RefNo = form.Get("form[sku]") + "-" + DateTime.Now.ToString("HHmm");
                    masterrecord.ProductName = form.Get("form[productname]");
                    masterrecord.CATNo = form.Get("form[sku]");
                    masterrecord.ProductId = Convert.ToInt32(form.Get("form[ProductId]"));
                    masterrecord.IsRepresentative = false;
                    masterrecord.CASNo = form.Get("form[casno]");
                    masterrecord.MolFormula = form.Get("form[molecularformula]");
                    masterrecord.MolecularWeight = form.Get("form[molecularweight]");
                    masterrecord.AdditionalInfor = form.Get("form[AdditionalInfor]");
                    masterrecord.IsEquation = form.Get("form[IsEquation]") == "on" ? true : false;
                    masterrecord.Dept = form.Get("form[Dept]");
                    masterrecord.TGALoss = form.Get("form[TGALoss]");
                    masterrecord.Attachment = form.Get("form[Attachment]");
                    masterrecord.Chemicalname = form.Get("form[Chemicalname]");
                    masterrecord.HPLCGCELSD = form.Get("form[HPLCGCELSD]");
                    masterrecord.Purity = form.Get("form[Purity]");
                    masterrecord.IR = form.Get("form[IR]");
                    masterrecord.Mass = form.Get("form[Mass]");
                    masterrecord.Potency = form.Get("form[Potency]");
                    masterrecord.BatchId = batchRecord.Id;
                    masterrecord.BatchNo = batchRecord.BatchNo;
                    masterrecord.ResidueOnIgnition = form.Get("form[ResidueOnIgnition]");
                    masterrecord.CMR = form.Get("form[CMR]");
                    masterrecord.NMR = form.Get("form[NMR]");
                    masterrecord.StorageCon = form.Get("form[StorageCon]");
                    masterrecord.AppearanceProduct = form.Get("form[AppearanceProduct]");
                    masterrecord.SOLUBILITY = form.Get("form[SOLUBILITY]");
                    masterrecord.BatchNo = form.Get("form[batchno]");
                    masterrecord.Synonym = form.Get("form[synonym]");
                    //masterrecord.MolecularWeight = form.Get("form[molecularweight]");
                    //masterrecord.MolFormula = form.Get("form[molecularformula]");
                    masterrecord.CreatedDate = DateTime.Now;
                    masterrecord.UpdatedDate = DateTime.Now;
                    masterrecord.QuantityAvailable = Convert.ToString(batchRecord.Qty);
                    masterrecord.EquationType = form.Get("form[EquationType]");
                    if (!string.IsNullOrEmpty(form.Get("form[AnalysisDate]")))
                    {
                        masterrecord.AnalysisDate = Convert.ToDateTime(form.Get("form[AnalysisDate]"));
                    }
                    else
                    {
                        masterrecord.AnalysisDate = null;
                    }
                    if (!string.IsNullOrEmpty(form.Get("form[ReTestDate]")))
                    {
                        masterrecord.ReTestDate = Convert.ToDateTime(form.Get("form[ReTestDate]"));
                    }
                    else
                    {
                        masterrecord.ReTestDate = null;
                    }
                    masterrecord.IsLogoAttached = form.Get("form[IsLogoAttached]") == "on" ? true : false;
                    masterrecord.IsManufacture = form.Get("form[IsManufacture]") == "on" ? true : false;
                    if (!string.IsNullOrEmpty(form.Get("form[ManufactureDate]")))
                    {
                        masterrecord.ManufactureDate = Convert.ToDateTime(form.Get("form[ManufactureDate]"));
                    }
                    else
                    {
                        masterrecord.ManufactureDate = null;
                    }
                    masterrecord.OtherValue = form.Get("form[OtherValue]");
                    masterrecord.IsShipping = form.Get("form[IsShipping]") == "on" ? true : false;

                    masterrecord.UpdatedBy = SessionCookieManagement.UserName;
                    masterrecord.CTheroretical = form.Get("form[CTheroretical]");
                    masterrecord.HTheroretical = form.Get("form[HTheroretical]");
                    masterrecord.NTheroretical = form.Get("form[NTheroretical]");
                    masterrecord.STheroretical = form.Get("form[STheroretical]");
                    masterrecord.CPractical = form.Get("form[CPractical]");
                    masterrecord.HPractical = form.Get("form[HPractical]");
                    masterrecord.NPractical = form.Get("form[NPractical]");
                    masterrecord.SPractical = form.Get("form[SPractical]");
                    masterrecord.WegithLossBy = form.Get("form[WegithLossBy]");
                    masterrecord.MeltingPoint = form.Get("form[MeltingPoint]");
                    masterrecord.qNMR = form.Get("form[qNMR]");
                    masterrecord.CNMRText = form.Get("form[CNMRText]");
                    db.SZ_MasterCOA.Add(masterrecord);
                    db.SaveChanges();
                }
                else
                {
                    var oldModel = LogManagement.PrepareMasterCOAEntity(masterrecord);
                    //Update Master
                    masterrecord.ProductName = form.Get("form[productname]");
                    masterrecord.CATNo = form.Get("form[sku]");
                    masterrecord.ProductId = Convert.ToInt32(form.Get("form[ProductId]"));
                    masterrecord.CASNo = form.Get("form[casno]");
                    masterrecord.MolFormula = form.Get("form[molecularformula]");
                    masterrecord.MolecularWeight = form.Get("form[molecularweight]");
                    masterrecord.AdditionalInfor = form.Get("form[AdditionalInfor]");
                    masterrecord.IsEquation = form.Get("form[IsEquation]") == "on" ? true : false;
                    masterrecord.Dept = form.Get("form[Dept]");
                    masterrecord.TGALoss = form.Get("form[TGALoss]");
                    masterrecord.Attachment = form.Get("form[Attachment]").ToString();
                    masterrecord.Chemicalname = form.Get("form[Chemicalname]");
                    masterrecord.HPLCGCELSD = form.Get("form[HPLCGCELSD]");
                    masterrecord.Purity = form.Get("form[Purity]");
                    masterrecord.IR = form.Get("form[IR]");
                    masterrecord.Mass = form.Get("form[Mass]");
                    masterrecord.Potency = form.Get("form[Potency]");
                    masterrecord.BatchId = batchRecord.Id;
                    masterrecord.BatchNo = batchRecord.BatchNo;
                    masterrecord.ResidueOnIgnition = form.Get("form[ResidueOnIgnition]");
                    masterrecord.CMR = form.Get("form[CMR]");
                    masterrecord.NMR = form.Get("form[NMR]");
                    masterrecord.StorageCon = form.Get("form[StorageCon]");
                    masterrecord.AppearanceProduct = form.Get("form[AppearanceProduct]");
                    masterrecord.SOLUBILITY = form.Get("form[SOLUBILITY]");
                    masterrecord.BatchNo = form.Get("form[batchno]");
                    masterrecord.Synonym = form.Get("form[synonym]");
                    masterrecord.EquationType = form.Get("form[EquationType]");
                    masterrecord.UpdatedDate = DateTime.Now;
                    if (!string.IsNullOrEmpty(form.Get("form[AnalysisDate]")))
                    {
                        masterrecord.AnalysisDate = Convert.ToDateTime(form.Get("form[AnalysisDate]"));
                    }
                    else
                    {
                        masterrecord.AnalysisDate = null;
                    }
                    if (!string.IsNullOrEmpty(form.Get("form[ReTestDate]")))
                    {
                        masterrecord.ReTestDate = Convert.ToDateTime(form.Get("form[ReTestDate]"));
                    }
                    else
                    {
                        masterrecord.ReTestDate = null;
                    }
                    masterrecord.IsLogoAttached = form.Get("form[IsLogoAttached]") == "on" ? true : false;

                    masterrecord.IsManufacture = form.Get("form[IsManufacture]") == "on" ? true : false;
                    if (!string.IsNullOrEmpty(form.Get("form[ManufactureDate]")))
                    {
                        masterrecord.ManufactureDate = Convert.ToDateTime(form.Get("form[ManufactureDate]"));
                    }
                    else
                    {
                        masterrecord.ManufactureDate = null;
                    }
                    masterrecord.OtherValue = form.Get("form[OtherValue]");
                    masterrecord.IsShipping = form.Get("form[IsShipping]") == "on" ? true : false;

                    masterrecord.CreatedBy = SessionCookieManagement.UserName;
                    masterrecord.UpdatedBy = SessionCookieManagement.UserName;
                    masterrecord.CTheroretical = form.Get("form[CTheroretical]");
                    masterrecord.HTheroretical = form.Get("form[HTheroretical]");
                    masterrecord.NTheroretical = form.Get("form[NTheroretical]");
                    masterrecord.STheroretical = form.Get("form[STheroretical]");
                    masterrecord.CPractical = form.Get("form[CPractical]");
                    masterrecord.HPractical = form.Get("form[HPractical]");
                    masterrecord.NPractical = form.Get("form[NPractical]");
                    masterrecord.SPractical = form.Get("form[SPractical]");
                    masterrecord.WegithLossBy = form.Get("form[WegithLossBy]");
                    masterrecord.MeltingPoint = form.Get("form[MeltingPoint]");
                    masterrecord.qNMR = form.Get("form[qNMR]");
                    masterrecord.CNMRText = form.Get("form[CNMRText]");
                    db.Entry<SZ_MasterCOA>(masterrecord).State = EntityState.Modified;
                    db.SaveChanges();

                    //LogManagement.AddMasterCOALog(masterrecord, oldModel);
                }

                MemoryCacheManager objCache = new MemoryCacheManager();
                objCache.Remove("cache.mastercoadata");
                objCache.Remove("cache.childcoadata");
                //var masterCOAData = objCache.Get("cache.mastercoadata", () =>
                //{
                //    return db.SZ_MasterCOA.ToList();
                //});
                //var childcoadata = objCache.Get("cache.childcoadata", () =>
                //{
                //    return db.SZ_ChildCOA.ToList();
                //});

                return Json(new
                {
                    success = true,
                    message = "COA updated successfully."
                }, JsonRequestBehavior.AllowGet);
            }
            catch (DbEntityValidationException dbEx)
            {
                string str = string.Empty;
                foreach (var validationErrors in dbEx.EntityValidationErrors)
                {
                    foreach (var validationError in validationErrors.ValidationErrors)
                    {
                        str += "Property: " + validationError.PropertyName + " Error: " + validationError.ErrorMessage + " /     ";
                    }
                }
                return Json(new
                {
                    success = false,
                    message = str
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [ValidateInput(false)]
        [HttpPost]
        public JsonResult SaveNewChildRecord(FormCollection form)
        {
            try
            {
                int bId = Convert.ToInt32(form.Get("form[BatchId]"));
                var batchRecord = db.SZ_Inventory.Where(x => x.Id == bId).FirstOrDefault();
                string catnumber = form.Get("form[sku]");
                int masterRecordId = Convert.ToInt32(form.Get("form[COAId]"));
                int id = Convert.ToInt32(form.Get("form[Id]"));
                var masterrecord = db.SZ_MasterCOA.Where(x => x.Id == masterRecordId).FirstOrDefault();
                var childRecord = db.SZ_ChildCOA.Where(x => x.Id == id).FirstOrDefault();
                if (childRecord != null)
                {
                    var oldModel = LogManagement.PrepareChildCOAEntity(childRecord);

                    childRecord.ProductName = form.Get("form[productname]");
                    childRecord.CATNo = form.Get("form[sku]");
                    childRecord.ProductId = Convert.ToInt32(form.Get("form[ProductId]"));
                    childRecord.IsRepresentative = false;
                    childRecord.CASNo = form.Get("form[casno]");
                    childRecord.MolFormula = form.Get("form[molecularformula]");
                    childRecord.MolecularWeight = form.Get("form[molecularweight]");
                    childRecord.AdditionalInfor = form.Get("form[AdditionalInfor]");
                    childRecord.IsEquation = form.Get("form[IsEquation]") == "on" ? true : false;
                    childRecord.IsLogoAttached = form.Get("form[IsLogoAttached]") == "on" ? true : false;
                    childRecord.Dept = form.Get("form[Dept]");
                    childRecord.TGALoss = form.Get("form[TGALoss]");
                    childRecord.Attachment = form.Get("form[Attachment]");
                    childRecord.Chemicalname = form.Get("form[Chemicalname]");
                    childRecord.HPLCGCELSD = form.Get("form[HPLCGCELSD]");
                    childRecord.Purity = form.Get("form[Purity]");
                    childRecord.IR = form.Get("form[IR]");
                    childRecord.Mass = form.Get("form[Mass]");
                    childRecord.Potency = form.Get("form[Potency]");
                    childRecord.BatchNo = batchRecord.BatchNo;
                    childRecord.ResidueOnIgnition = form.Get("form[ResidueOnIgnition]");
                    childRecord.CMR = form.Get("form[CMR]");
                    childRecord.NMR = form.Get("form[NMR]");
                    childRecord.StorageCon = form.Get("form[StorageCon]");
                    childRecord.AppearanceProduct = form.Get("form[AppearanceProduct]");
                    childRecord.SOLUBILITY = form.Get("form[SOLUBILITY]");
                    childRecord.BatchNo = form.Get("form[batchno]");
                    childRecord.Synonym = form.Get("form[synonym]");
                    childRecord.EquationType = form.Get("form[EquationType]");

                    childRecord.CTheroretical = form.Get("form[CTheroretical]");
                    childRecord.HTheroretical = form.Get("form[HTheroretical]");
                    childRecord.NTheroretical = form.Get("form[NTheroretical]");
                    childRecord.STheroretical = form.Get("form[STheroretical]");
                    childRecord.CPractical = form.Get("form[CPractical]");
                    childRecord.HPractical = form.Get("form[HPractical]");
                    childRecord.NPractical = form.Get("form[NPractical]");
                    childRecord.SPractical = form.Get("form[SPractical]");
                    childRecord.UpdatedDate = DateTime.Now;
                    if (!string.IsNullOrEmpty(form.Get("form[AnalysisDate]")))
                    {
                        childRecord.AnalysisDate = Convert.ToDateTime(form.Get("form[AnalysisDate]"));
                    }
                    else
                    {
                        childRecord.AnalysisDate = null;
                    }
                    if (!string.IsNullOrEmpty(form.Get("form[ReTestDate]")))
                    {
                        childRecord.ReTestDate = Convert.ToDateTime(form.Get("form[ReTestDate]"));
                    }
                    else
                    {
                        childRecord.ReTestDate = null;
                    }
                    childRecord.IsManufacture = form.Get("form[IsManufacture]") == "on" ? true : false;
                    if (!string.IsNullOrEmpty(form.Get("form[ManufactureDate]")))
                    {
                        childRecord.ManufactureDate = Convert.ToDateTime(form.Get("form[ManufactureDate]"));
                    }
                    else
                    {
                        childRecord.ManufactureDate = null;
                    }
                    childRecord.OtherValue = form.Get("form[OtherValue]");
                    childRecord.IsShipping = form.Get("form[IsShipping]") == "on" ? true : false;
                    childRecord.UpdatedBy = SessionCookieManagement.UserName;
                    childRecord.WegithLossBy = form.Get("form[WegithLossBy]");
                    childRecord.MeltingPoint = form.Get("form[MeltingPoint]");
                    childRecord.qNMR = form.Get("form[qNMR]");
                    childRecord.CNMRText = form.Get("form[CNMRText]");
                    db.Entry<SZ_ChildCOA>(childRecord).State = EntityState.Modified;
                    db.SaveChanges();

                    //LogManagement.AddChildCOALog(childRecord, oldModel);
                }
                else
                {
                    var cnt = db.SZ_ChildCOA.Where(x => x.MasterCOAID == masterrecord.Id).Count();
                    childRecord = new SZ_ChildCOA();
                    childRecord.RefNo = masterrecord.RefNo + "-" + (cnt + 1);
                    childRecord.MasterCOAID = masterrecord.Id;
                    childRecord.ProductName = form.Get("form[productname]");
                    childRecord.CATNo = form.Get("form[sku]");
                    childRecord.ProductId = Convert.ToInt32(form.Get("form[ProductId]"));
                    childRecord.IsRepresentative = false;
                    childRecord.CASNo = form.Get("form[casno]");
                    childRecord.MolFormula = form.Get("form[molecularformula]");
                    childRecord.MolecularWeight = form.Get("form[molecularweight]");
                    childRecord.AdditionalInfor = form.Get("form[AdditionalInfor]");
                    childRecord.IsEquation = form.Get("form[IsEquation]") == "on" ? true : false;
                    childRecord.Dept = form.Get("form[Dept]");
                    childRecord.TGALoss = form.Get("form[TGALoss]");
                    childRecord.Attachment = form.Get("form[Attachment]");
                    childRecord.Chemicalname = form.Get("form[Chemicalname]");
                    childRecord.HPLCGCELSD = form.Get("form[HPLCGCELSD]");
                    childRecord.Purity = form.Get("form[Purity]");
                    childRecord.IR = form.Get("form[IR]");
                    childRecord.Mass = form.Get("form[Mass]");
                    childRecord.Potency = form.Get("form[Potency]");
                    childRecord.BatchNo = batchRecord.BatchNo;
                    childRecord.ResidueOnIgnition = form.Get("form[ResidueOnIgnition]");
                    childRecord.CMR = form.Get("form[CMR]");
                    childRecord.NMR = form.Get("form[NMR]");
                    childRecord.StorageCon = form.Get("form[StorageCon]");
                    childRecord.AppearanceProduct = form.Get("form[AppearanceProduct]");
                    childRecord.SOLUBILITY = form.Get("form[SOLUBILITY]");
                    childRecord.BatchNo = form.Get("form[batchno]");
                    childRecord.Synonym = form.Get("form[synonym]");
                    childRecord.EquationType = form.Get("form[EquationType]");
                    childRecord.CreatedDate = DateTime.Now;
                    childRecord.UpdatedDate = DateTime.Now;
                    childRecord.OtherValue = form.Get("form[OtherValue]");
                    if (!string.IsNullOrEmpty(form.Get("form[AnalysisDate]")))
                    {
                        childRecord.AnalysisDate = Convert.ToDateTime(form.Get("form[AnalysisDate]"));
                    }
                    else
                    {
                        childRecord.AnalysisDate = null;
                    }
                    if (!string.IsNullOrEmpty(form.Get("form[ReTestDate]")))
                    {
                        childRecord.ReTestDate = Convert.ToDateTime(form.Get("form[ReTestDate]"));
                    }
                    else
                    {
                        childRecord.ReTestDate = null;
                    }
                    childRecord.IsLogoAttached = form.Get("form[IsLogoAttached]") == "on" ? true : false;
                    childRecord.IsManufacture = form.Get("form[IsManufacture]") == "on" ? true : false;
                    if (!string.IsNullOrEmpty(form.Get("form[ManufactureDate]")))
                    {
                        childRecord.ManufactureDate = Convert.ToDateTime(form.Get("form[ManufactureDate]"));
                    }
                    else
                    {
                        childRecord.ManufactureDate = null;
                    }
                    childRecord.IsShipping = form.Get("form[IsShipping]") == "on" ? true : false;
                    childRecord.CreatedBy = SessionCookieManagement.UserName;
                    childRecord.UpdatedBy = SessionCookieManagement.UserName;
                    childRecord.CTheroretical = form.Get("form[CTheroretical]");
                    childRecord.HTheroretical = form.Get("form[HTheroretical]");
                    childRecord.NTheroretical = form.Get("form[NTheroretical]");
                    childRecord.STheroretical = form.Get("form[STheroretical]");
                    childRecord.CPractical = form.Get("form[CPractical]");
                    childRecord.HPractical = form.Get("form[HPractical]");
                    childRecord.NPractical = form.Get("form[NPractical]");
                    childRecord.SPractical = form.Get("form[SPractical]");
                    childRecord.WegithLossBy = form.Get("form[WegithLossBy]");
                    childRecord.MeltingPoint = form.Get("form[MeltingPoint]");
                    childRecord.qNMR = form.Get("form[qNMR]");
                    childRecord.CNMRText = form.Get("form[CNMRText]");
                    db.SZ_ChildCOA.Add(childRecord);
                    db.SaveChanges();
                    id = childRecord.Id;
                }

                ///Update Master Record
                //var updatedChildRecord = db.SZ_ChildCOA.Where(x => x.Id == id).FirstOrDefault();
                //if (updatedChildRecord != null)
                //{
                //    masterrecord.ReTestDate = updatedChildRecord.ReTestDate;
                //    masterrecord.AnalysisDate = updatedChildRecord.AnalysisDate;
                //    masterrecord.UpdatedBy = SessionCookieManagement.UserName;
                //    db.Entry<SZ_MasterCOA>(masterrecord).State = EntityState.Modified;
                //    db.SaveChanges();
                //}
                MemoryCacheManager objCache = new MemoryCacheManager();
                objCache.Remove("cache.mastercoadata");
                objCache.Remove("cache.childcoadata");
                //var masterCOAData = objCache.Get("cache.mastercoadata", () =>
                //{
                //    return db.SZ_MasterCOA.ToList();
                //});
                //var childcoadata = objCache.Get("cache.childcoadata", () =>
                //{
                //    return db.SZ_ChildCOA.ToList();
                //});
                return Json(new
                {
                    success = true,
                    message = "COA updated successfully.",
                    data = id,
                    batchId = bId,
                    masterCoaId = masterrecord.Id
                }, JsonRequestBehavior.AllowGet);
            }
            catch (DbEntityValidationException dbEx)
            {
                string str = string.Empty;
                foreach (var validationErrors in dbEx.EntityValidationErrors)
                {
                    foreach (var validationError in validationErrors.ValidationErrors)
                    {
                        str += "Property: " + validationError.PropertyName + " Error: " + validationError.ErrorMessage + " /     ";
                    }
                }


                return Json(new
                {
                    success = false,
                    message = str
                }, JsonRequestBehavior.AllowGet);
            }
        }


        [ValidateInput(false)]
        [HttpPost]
        public JsonResult AddMasterCOARepresentativeData(TermsModel passdata, FormCollection form)
        {
            try
            {
                //passdata[Message]
                string catnumber = form.Get("form[sku]");
                int childRecordId = Convert.ToInt32(form.Get("form[Id]"));
                var objchild = db.SZ_ChildCOA.Where(x => x.Id == childRecordId).FirstOrDefault();
                if (objchild == null)
                {
                    return Json(new
                    {
                        success = false,
                        message = "Data not found"
                    }, JsonRequestBehavior.AllowGet);
                }

                objchild.ProductName = form.Get("form[productname]");
                objchild.RefNo = "SZ-" + DateTime.Now.ToString("HHmm") + "-" + DateTime.Now.ToString("yy") + "-" + DateTime.Now.ToString("ddMM");
                objchild.IsRepresentative = true;

                objchild.CASNo = form.Get("form[casno]");
                objchild.MolFormula = form.Get("form[molecularformula]");
                objchild.MolecularWeight = form.Get("form[molecularweight]");

                objchild.EP = form.Get("form[EP]");
                objchild.USP = form.Get("form[USP]");
                objchild.EPChemicalName = form.Get("form[EPChemicalName]");
                objchild.USPChemicalName = form.Get("form[USPChemicalName]");
                objchild.IUPAC = form.Get("form[IUPAC]");
                objchild.OtherNameOne = form.Get("form[OtherNameOne]");
                objchild.OtherNameSecond = form.Get("form[OtherNameSecond]");
                objchild.OtherNameThird = form.Get("form[OtherNameThird]");

                objchild.ChemEP = form.Get("form[ChemEP]");
                objchild.ChemUSP = form.Get("form[ChemUSP]");
                objchild.ChemEPChemicalName = form.Get("form[ChemEPChemicalName]");
                objchild.ChemUSPChemicalName = form.Get("form[ChemUSPChemicalName]");
                objchild.ChemIUPAC = form.Get("form[ChemIUPAC]");
                objchild.ChemOtherNameOne = form.Get("form[ChemOtherNameOne]");
                objchild.ChemOtherNameSecond = form.Get("form[ChemOtherNameSecond]");
                objchild.ChemOtherNameThird = form.Get("form[ChemOtherNameThird]");

                objchild.SynEP = form.Get("form[SynEP]");
                objchild.SynUSP = form.Get("form[SynUSP]");
                objchild.SynEPChemicalName = form.Get("form[SynEPChemicalName]");
                objchild.SynUSPChemicalName = form.Get("form[SynUSPChemicalName]");
                objchild.SynIUPAC = form.Get("form[SynIUPAC]");
                objchild.SynOtherNameOne = form.Get("form[OtherNameOne]");
                objchild.SynOtherNameSecond = form.Get("form[SynOtherNameSecond]");
                objchild.SynOtherNameThird = form.Get("form[SynOtherNameThird]");

                objchild.PreparedBy = form.Get("form[preparedby]");
                objchild.ReviewdBy = form.Get("form[reviewedby]");
                objchild.ApprovedBy = form.Get("form[approvedby]");

                objchild.EPChk = false;
                objchild.USPChk = false;
                objchild.IUPACChk = false;
                objchild.ChkEPChemicalName = false;
                objchild.ChkUSPChemicalName = false;
                objchild.ChkOtherNameOne = false;
                objchild.ChkOtherNameSecond = false;
                objchild.ChkOtherNameThird = false;

                if (form.Get("form[EPchk]") == "on")
                {
                    objchild.EPChk = true;
                }
                if (form.Get("form[USPchk]") == "on")
                {
                    objchild.USPChk = true;
                }
                if (form.Get("form[ChkEPChemicalName]") == "on")
                {
                    objchild.ChkEPChemicalName = true;
                }
                if (form.Get("form[ChkUSPChemicalName]") == "on")
                {
                    objchild.ChkUSPChemicalName = true;
                }
                if (form.Get("form[IUPACchk]") == "on")
                {
                    objchild.IUPACChk = true;
                }
                if (form.Get("form[ChkOtherNameOne]") == "on")
                {
                    objchild.ChkOtherNameOne = true;
                }
                if (form.Get("form[ChkOtherNameSecond]") == "on")
                {
                    objchild.ChkOtherNameSecond = true;
                }
                if (form.Get("form[ChkOtherNameThird]") == "on")
                {
                    objchild.ChkOtherNameThird = true;
                }


                objchild.ChkChemEP = false;
                objchild.ChkChemUSP = false;
                objchild.ChkChemIUPAC = false;
                objchild.ChemChkEPChemicalName = false;
                objchild.ChemChkUSPChemicalName = false;
                objchild.ChemChkOtherNameOne = false;
                objchild.ChemChkOtherNameSecond = false;
                objchild.ChemChkOtherNameThird = false;

                if (form.Get("form[ChkChemEP]") == "on")
                {
                    objchild.ChkChemEP = true;
                }
                if (form.Get("form[ChkChemUSP]") == "on")
                {
                    objchild.ChkChemUSP = true;
                }
                if (form.Get("form[ChkChemIUPAC]") == "on")
                {
                    objchild.ChkChemIUPAC = true;
                }
                if (form.Get("form[ChemChkEPChemicalName]") == "on")
                {
                    objchild.ChemChkEPChemicalName = true;
                }
                if (form.Get("form[ChemChkUSPChemicalName]") == "on")
                {
                    objchild.ChemChkUSPChemicalName = true;
                }
                if (form.Get("form[ChemChkOtherNameOne]") == "on")
                {
                    objchild.ChemChkOtherNameOne = true;
                }
                if (form.Get("form[ChemChkOtherNameSecond]") == "on")
                {
                    objchild.ChemChkOtherNameSecond = true;
                }
                if (form.Get("form[ChemChkOtherNameThird]") == "on")
                {
                    objchild.ChemChkOtherNameThird = true;
                }

                objchild.ChkSynEP = false;
                objchild.ChkSynUSP = false;
                objchild.ChkSynIUPAC = false;
                objchild.SynChkEPChemicalName = false;
                objchild.SynChkUSPChemicalName = false;
                objchild.SynChkOtherNameOne = false;
                objchild.SynChkOtherNameSecond = false;
                objchild.SynChkOtherNameThird = false;

                if (form.Get("form[ChkSynEP]") == "on")
                {
                    objchild.ChkSynEP = true;
                }
                if (form.Get("form[ChkSynUSP]") == "on")
                {
                    objchild.ChkSynUSP = true;
                }
                if (form.Get("form[ChkSynIUPAC]") == "on")
                {
                    objchild.ChkSynIUPAC = true;
                }
                if (form.Get("form[SynChkEPChemicalName]") == "on")
                {
                    objchild.SynChkEPChemicalName = true;
                }
                if (form.Get("form[SynChkUSPChemicalName]") == "on")
                {
                    objchild.SynChkUSPChemicalName = true;
                }
                if (form.Get("form[SynChkOtherNameOne]") == "on")
                {
                    objchild.SynChkOtherNameOne = true;
                }
                if (form.Get("form[SynChkOtherNameSecond]") == "on")
                {
                    objchild.SynChkOtherNameSecond = true;
                }
                if (form.Get("form[SynChkOtherNameThird]") == "on")
                {
                    objchild.SynChkOtherNameThird = true;
                }
                //objchild.OtherSynonum = form.Get("OtherSynonum");
                objchild.AdditionalInfor = form.Get("passdata[Message]");
                objchild.IsEquation = form.Get("form[IsEquation]") == "on" ? true : false;
                objchild.IsLogoAttached = form.Get("form[IsLogoAttached]") == "on" ? true : false;
                objchild.MeltingPoint = form.Get("form[MeltingPoint]");
                objchild.qNMR = form.Get("form[qNMR]");
                db.Entry<SZ_ChildCOA>(objchild).State = EntityState.Modified;
                db.SaveChanges();
                //db.SZ_ChildCOA.Add(objchild);
                //db.SaveChanges();

                var checkRecord = db.SZ_NameMaster.Where(x => x.Sku.Trim().ToLower() == catnumber.Trim().ToLower()).FirstOrDefault();
                if (checkRecord == null)
                {
                    SZ_NameMaster objnamemaster = new SZ_NameMaster();
                    objnamemaster.Sku = catnumber;
                    objnamemaster.Other = form.Get("OtherSynonum");
                    objnamemaster.CreatedDate = DateTime.Now;
                    objnamemaster.ChemDraw = form.Get("IUPAC");
                    objnamemaster.EP = form.Get("EP");
                    objnamemaster.USP = form.Get("USP");
                    objnamemaster.EPChemicalName = form.Get("EPChemicalName");
                    objnamemaster.USPChemicalName = form.Get("USPChemicalName");
                    objnamemaster.OtherNameOne = form.Get("OtherNameOne");
                    objnamemaster.OtherNameSecond = form.Get("OtherNameSecond");
                    objnamemaster.OtherNameThird = form.Get("OtherNameThird");
                    db.SZ_NameMaster.Add(objnamemaster);
                    db.SaveChanges();
                }
                return Json(new
                {
                    success = true,
                    data = objchild.Id
                }, JsonRequestBehavior.AllowGet);
            }
            catch (DbEntityValidationException dbEx)
            {
                string str = string.Empty;
                foreach (var validationErrors in dbEx.EntityValidationErrors)
                {
                    foreach (var validationError in validationErrors.ValidationErrors)
                    {
                        str += "Property: " + validationError.PropertyName + " Error: " + validationError.ErrorMessage + " /     ";
                    }
                }


                return Json(new
                {
                    success = false,
                    message = str
                }, JsonRequestBehavior.AllowGet);
            }
        }


        #endregion


        public ActionResult Report()
        {
            var listCompItems = new List<SelectListItem>();
            listCompItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var compData = db.SZ_CompanyList.OrderBy(x => x.Name).ToList();
            foreach (var term in compData)
            {
                listCompItems.Add(new SelectListItem
                {
                    Text = term.Name,
                    Value = term.Id.ToString()
                });
            }

            ViewBag.listCompItems = listCompItems;
            return View();
        }

        public ActionResult GetInfo()
        {
            ViewBag.GetCompIp = GetComputer_LanIP();
            ViewBag.GetCompInternetIp = GetComputer_InternetIP();
            ViewBag.GetMACAddress = GetMacAddress().ToString();
            return View();
        }
        private string GetComputer_LanIP()
        {
            string strHostName = System.Net.Dns.GetHostName();
            IPHostEntry ipEntry = System.Net.Dns.GetHostEntry(strHostName);
            foreach (IPAddress ipAddress in ipEntry.AddressList)
            {
                if (ipAddress.AddressFamily.ToString() == "InterNetwork")
                {
                    return ipAddress.ToString();
                }
            }
            return "-";
        }

        private string GetComputer_InternetIP()
        {
            // check IP using DynDNS's service
            WebRequest request = WebRequest.Create("http://checkip.dyndns.org");
            WebResponse response = request.GetResponse();
            StreamReader stream = new StreamReader(response.GetResponseStream());

            // IMPORTANT: set Proxy to null, to drastically INCREASE the speed of request
            // request.Proxy = null;

            // read complete response
            string ipAddress = stream.ReadToEnd();

            // replace everything and keep only IP
            return ipAddress.
                Replace("<html><head><title>Current IP Check</title></head><body>Current IP Address: ", string.Empty).
                Replace("</body></html>", string.Empty);
        }
        public static PhysicalAddress GetMacAddress()
        {
            foreach (NetworkInterface nic in NetworkInterface.GetAllNetworkInterfaces())
            {
                // Only consider Ethernet network interfaces
                if (nic.NetworkInterfaceType == NetworkInterfaceType.Ethernet &&
                    nic.OperationalStatus == OperationalStatus.Up)
                {
                    return nic.GetPhysicalAddress();
                }
            }
            return null;
        }

        public ActionResult InsertData(string name)
        {
            db.Database.ExecuteSqlCommand(TransactionalBehavior.DoNotEnsureTransaction, @"EXEC [dbo].[BackUpDatabase] @address = N'" + name + "'");

            //db.BackUpDatabase(name);
            string zipPath = Server.MapPath("~/Content/NewProducts/" + Guid.NewGuid().ToString() + ".zip");
            string[] Filenames = new string[] { @"C:\MyDatabase\" + name + ".bak"/*, Server.MapPath("~/Content/Structure")*/ };
            using (ZipFile zip = new ZipFile())
            {
                zip.AddFiles(Filenames, "data");
                //zip.AddFiles(Filenames, "Str");
                zip.Save(zipPath);
            }
            return File(zipPath, "application/zip", Server.UrlEncode("newpro-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".zip"));

        }

        [HttpPost]
        public JsonResult TakeBackupDatabase(string name)
        {
            try
            {
                if (string.IsNullOrEmpty(name))
                {
                    name = Guid.NewGuid().ToString();
                }

                // read connectionstring from config file
                var connectionString = ConfigurationManager.ConnectionStrings["MyConnString"].ConnectionString;

                // read backup folder from config file ("C:/temp/")
                //var backupFolder = ConfigurationManager.AppSettings["BackupFolder"];
                var backupFolder = "C:/MyDatabase/";

                var sqlConStrBuilder = new SqlConnectionStringBuilder(connectionString);

                // set backupfilename (you will get something like: "C:/temp/MyDatabase-2013-12-07.bak")
                var backupFileName = String.Format("{0}{1}{2}{3}.bak",
                    backupFolder, sqlConStrBuilder.InitialCatalog,
                    name, Guid.NewGuid().ToString());

                var path = backupFileName;

                db.BackUpDatabase(name);

                //using (var connection = new SqlConnection(sqlConStrBuilder.ConnectionString))
                //{
                //    var query = String.Format("BACKUP DATABASE {0} TO DISK='{1}'",
                //        sqlConStrBuilder.InitialCatalog, backupFileName);

                //    using (var command = new SqlCommand(query, connection))
                //    {
                //        connection.Open();
                //        command.ExecuteNonQuery();
                //    }
                //}
                Sz_DatabaseBackup obj = new Sz_DatabaseBackup();
                obj.Name = name;
                obj.Path = path;
                obj.CreatedDate = DateTime.Now;
                db.Sz_DatabaseBackup.Add(obj);
                db.SaveChanges();

                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = ex.Message
                }, JsonRequestBehavior.AllowGet);
            }
        }

        public ActionResult BackupDatabase()
        {
            var model = db.Sz_DatabaseBackup.OrderByDescending(x => x.CreatedDate).ToList();
            return View(model);
        }

        public ActionResult COA()
        {
            if (!SessionCookieManagement.IsAdmin
                && !SessionCookieManagement.IsDispatch
                && !SessionCookieManagement.IsProjectLogin
                && !SessionCookieManagement.IsQC)
            {
                return RedirectToAction("Index", "Home");
            }

            DateTime futureDate = DateTime.Now.AddDays(7);
            var previouseCOA = db.SZ_MasterCOA.Where(x => x.ReTestDate != null && (x.ReTestDate >= DateTime.Now && x.ReTestDate <= futureDate)).OrderBy(x => x.ReTestDate).ToList();
            ViewBag.PreviouseCOA = previouseCOA;
            return this.View();
        }

        public ActionResult DownloadMasterCOAFromQuoteDetailsId(int id)
        {
            var quoteDetails = _operationRepository.GetQuoteDetailByID(id);
            if (quoteDetails != null)
            {
                string batchNo = quoteDetails.QuoteBatchNo;
                var mastercoa = db.SZ_MasterCOA.Where(x => x.BatchNo == batchNo).OrderByDescending(x => x.Id).FirstOrDefault();
                if (mastercoa != null)
                {
                    var path = MasterCOAPath(mastercoa, false);
                    return File(path, "application/pdf", Server.UrlEncode(quoteDetails.ProductName.Replace(" ", "_") + "_" + quoteDetails.CATNo + "_" + batchNo + "_COA.pdf"));
                }
            }

            return Json(0, JsonRequestBehavior.AllowGet);
        }



        public ActionResult DownloadMasterCOA(int id, bool isScanCopy = false, bool iswebsite = false, bool isQACoa = false)
        {
            var data = db.SZ_MasterCOA.Where(x => x.Id == id).FirstOrDefault();
            ViewBag.isQACoa = isQACoa;
            var path = MasterCOAPath(data, isScanCopy, iswebsite, false);
            string batchNo = "";
            string catno = "";
            string productName = "";

            if (data != null)
            {
                batchNo = data.BatchNo;
                catno = data.CATNo;
                productName = data.ProductName;
            }
            if (iswebsite)
            {
                return Json(path, JsonRequestBehavior.AllowGet);
            }
            return File(path, "application/pdf", Server.UrlEncode(productName.Replace(" ", "_") + "_" + catno + "_" + batchNo + "_COA.pdf"));
        }


        public ActionResult DownloadMasterCOAAndAnylyticalData(int id, bool isScanCopy = false, bool iswebsite = false)
        {
            string batchNo = "";
            string catno = "";
            string productName = "";
            var data = db.SZ_MasterCOA.Where(x => x.Id == id).FirstOrDefault();
            if (data != null)
            {
                batchNo = data.BatchNo;
                catno = data.CATNo;
                productName = data.ProductName;
            }
            var path = GetMasterCOAAndAnylyticalDataPath(data, isScanCopy, iswebsite, true);
            return File(path, "application/pdf", Server.UrlEncode(productName.Replace(" ", "_") + "_" + catno + "_" + batchNo + "_COA.pdf"));

            //var path = MasterCOAPath(id, isScanCopy, iswebsite, true);
            //string batchNo = "";
            //string catno = "";
            //string productName = "";
            //var data = db.SZ_MasterCOA.Where(x => x.Id == id).FirstOrDefault();
            //if (data != null)
            //{
            //    batchNo = data.BatchNo;
            //    catno = data.CATNo;
            //    productName = data.ProductName;
            //}
            //string specdatafilename = Guid.NewGuid().ToString() + ".pdf";
            //string outputPdfPath = Server.MapPath("~/Content/NewProducts/" + specdatafilename);
            //List<string> fileArray = new List<string>();
            //if (!string.IsNullOrEmpty(path))
            //{
            //    fileArray.Add(".." + path);
            //}
            //if (!string.IsNullOrEmpty(batchNo))
            //{
            //    var itemObj = db.SZ_QuoteDetailForm.Where(x => x.BatchCode == batchNo).OrderByDescending(x => x.Id).FirstOrDefault();
            //    if (itemObj != null)
            //    {
            //        if (!string.IsNullOrEmpty(itemObj.RbAdditionalAnalysis))
            //        {
            //            string PLCAttachment = itemObj.PLCAttachment != null ? itemObj.PLCAttachment.ReplaceForFilepath() : "";
            //            string MassAttachment = itemObj.MassAttachment != null ? itemObj.MassAttachment.ReplaceForFilepath() : "";
            //            string TGAAttachment = itemObj.TGAAttachment != null ? itemObj.TGAAttachment.ReplaceForFilepath() : "";
            //            string IRAttachment = itemObj.IRAttachment != null ? itemObj.IRAttachment.ReplaceForFilepath() : "";
            //            string CMRAttachment = itemObj.CMRAttchment != null ? itemObj.CMRAttchment.ReplaceForFilepath() : "";

            //            if (!string.IsNullOrEmpty(PLCAttachment))
            //            {
            //                fileArray.Add(PLCAttachment);
            //            }
            //            if (!string.IsNullOrEmpty(MassAttachment))
            //            {
            //                fileArray.Add(MassAttachment);
            //            }
            //            if (!string.IsNullOrEmpty(itemObj.NMRAttchment))
            //            {
            //                fileArray.Add(itemObj.NMRAttchment.ReplaceForFilepath());
            //            }
            //            if (!string.IsNullOrEmpty(TGAAttachment))
            //            {
            //                fileArray.Add(TGAAttachment);
            //            }
            //            if (!string.IsNullOrEmpty(IRAttachment))
            //            {
            //                fileArray.Add(IRAttachment);
            //            }
            //            if (!string.IsNullOrEmpty(itemObj.UVSpectra))
            //            {
            //                fileArray.Add(itemObj.UVSpectra.ReplaceForFilepath());
            //            }
            //            if (!string.IsNullOrEmpty(CMRAttachment))
            //            {
            //                fileArray.Add(CMRAttachment);
            //            }
            //            if (!string.IsNullOrEmpty(itemObj.QNMRAttchment))
            //            {
            //                fileArray.Add(itemObj.QNMRAttchment.ReplaceForFilepath());
            //            }
            //            if (!string.IsNullOrEmpty(itemObj.OtherAnalysisAttachment))
            //            {
            //                fileArray.Add(itemObj.OtherAnalysisAttachment.ReplaceForFilepath());
            //            }
            //            if (!string.IsNullOrEmpty(itemObj.DEPTAttachment))
            //            {
            //                fileArray.Add(itemObj.DEPTAttachment.ReplaceForFilepath());
            //            }
            //            if (!string.IsNullOrEmpty(itemObj.HRMSAttachment))
            //            {
            //                fileArray.Add(itemObj.HRMSAttachment.ReplaceForFilepath());
            //            }
            //            if (!string.IsNullOrEmpty(itemObj.ROIAttachment))
            //            {
            //                fileArray.Add(itemObj.ROIAttachment.ReplaceForFilepath());
            //            }
            //            if (!string.IsNullOrEmpty(itemObj.ElementralAttachment))
            //            {
            //                fileArray.Add(itemObj.ElementralAttachment.ReplaceForFilepath());
            //            }
            //            if (!string.IsNullOrEmpty(itemObj.SERAttachment))
            //            {
            //                fileArray.Add(itemObj.SERAttachment.ReplaceForFilepath());
            //            }
            //            if (!string.IsNullOrEmpty(itemObj.GCAttachment))
            //            {
            //                fileArray.Add(itemObj.GCAttachment.ReplaceForFilepath());
            //            }
            //            if (!string.IsNullOrEmpty(itemObj.ELSDAttachment))
            //            {
            //                fileArray.Add(itemObj.ELSDAttachment.ReplaceForFilepath());
            //            }
            //            if (!string.IsNullOrEmpty(itemObj.ChiralAttachmenrt))
            //            {
            //                fileArray.Add(itemObj.ChiralAttachmenrt.ReplaceForFilepath());
            //            }
            //            if (!string.IsNullOrEmpty(itemObj.APCIMassAttachment))
            //            {
            //                fileArray.Add(itemObj.APCIMassAttachment.ReplaceForFilepath());
            //            }
            //            if (!string.IsNullOrEmpty(itemObj.NMRInterpretaionAttachment))
            //            {
            //                fileArray.Add(itemObj.NMRInterpretaionAttachment.ReplaceForFilepath());
            //            }
            //            if (!string.IsNullOrEmpty(itemObj.N1NmrAttachment))
            //            {
            //                fileArray.Add(itemObj.N1NmrAttachment.ReplaceForFilepath());
            //            }
            //            if (!string.IsNullOrEmpty(itemObj.ChiralHPLCAttachment))
            //            {
            //                fileArray.Add(itemObj.ChiralHPLCAttachment.ReplaceForFilepath());
            //            }
            //            if (!string.IsNullOrEmpty(itemObj.IsotropicpurityAttachment))
            //            {
            //                fileArray.Add(itemObj.IsotropicpurityAttachment.ReplaceForFilepath());
            //            }
            //            if (!string.IsNullOrEmpty(itemObj.COSYAttachment))
            //            {
            //                fileArray.Add(itemObj.COSYAttachment.ReplaceForFilepath());
            //            }
            //            if (!string.IsNullOrEmpty(itemObj.CHNSAttachment))
            //            {
            //                fileArray.Add(itemObj.CHNSAttachment.ReplaceForFilepath());
            //            }
            //            if (!string.IsNullOrEmpty(itemObj.StabilitydataAttachment))
            //            {
            //                fileArray.Add(itemObj.StabilitydataAttachment.ReplaceForFilepath());
            //            }
            //            if (!string.IsNullOrEmpty(itemObj.LCMSAttachment))
            //            {
            //                fileArray.Add(itemObj.LCMSAttachment.ReplaceForFilepath());
            //            }

            //            List<string> passFileArray = new List<string>();
            //            foreach (var item in fileArray)
            //            {
            //                passFileArray.Add(Server.MapPath(item.Replace("..", "~")));
            //            }
            //            Common.MargeMultiplePDF(passFileArray, outputPdfPath);
            //        }
            //        else
            //        {
            //            return File(Server.MapPath("~" + path), "application/pdf", Server.UrlEncode(productName.Replace(" ", "_") + "_" + catno + "_" + batchNo + "_COA.pdf"));
            //        }

            //        return File(outputPdfPath, "application/pdf", Server.UrlEncode(productName.Replace(" ", "_") + "_" + catno + "_" + batchNo + "_COA_AND_AnalyticalData.pdf"));
            //    }
            //}

            //return File(path, "application/pdf", Server.UrlEncode(productName.Replace(" ", "_") + "_" + catno + "_" + batchNo + "_COA.pdf"));
        }

        public string GetMasterCOAAndAnylyticalDataPath(SZ_MasterCOA masterCoaData, bool isScanCopy = false, bool iswebsite = false, bool isReturnFile = false)
        {
            //int id
            string batchNo = "";
            string catno = "";
            string productName = "";

            //var data = db.SZ_MasterCOA.Where(x => x.Id == id).FirstOrDefault();
            var data = masterCoaData;
            if (data != null)
            {
                batchNo = data.BatchNo;
                catno = data.CATNo;
                productName = data.ProductName;
            }
            else
            {
                return "";
            }
            var path = MasterCOAPath(data, isScanCopy, iswebsite, true);

            string specdatafilename = filenameDateWise("Merge_" + Guid.NewGuid().ToString()) + ".pdf";
            string outputPdfPath = Server.MapPath("~/Content/NewProducts/" + specdatafilename);
            List<string> fileArray = new List<string>();
            if (!string.IsNullOrEmpty(path))
            {
                fileArray.Add(".." + path);
            }
            if (!string.IsNullOrEmpty(batchNo))
            {
                var itemObj = db.SZ_QuoteDetailForm.Where(x => x.BatchCode == batchNo).OrderByDescending(x => x.Id).FirstOrDefault();
                if (itemObj != null)
                {
                    if (!string.IsNullOrEmpty(itemObj.RbAdditionalAnalysis))
                    {
                        string PLCAttachment = itemObj.PLCAttachment != null ? itemObj.PLCAttachment.ReplaceForFilepath() : "";
                        string MassAttachment = itemObj.MassAttachment != null ? itemObj.MassAttachment.ReplaceForFilepath() : "";
                        string TGAAttachment = itemObj.TGAAttachment != null ? itemObj.TGAAttachment.ReplaceForFilepath() : "";
                        string IRAttachment = itemObj.IRAttachment != null ? itemObj.IRAttachment.ReplaceForFilepath() : "";
                        string CMRAttachment = itemObj.CMRAttchment != null ? itemObj.CMRAttchment.ReplaceForFilepath() : "";

                        if (!string.IsNullOrEmpty(PLCAttachment))
                        {
                            fileArray.Add(PLCAttachment);
                        }
                        if (!string.IsNullOrEmpty(MassAttachment))
                        {
                            fileArray.Add(MassAttachment);
                        }
                        if (!string.IsNullOrEmpty(itemObj.NMRAttchment))
                        {
                            fileArray.Add(itemObj.NMRAttchment.ReplaceForFilepath());
                        }
                        if (!string.IsNullOrEmpty(TGAAttachment))
                        {
                            fileArray.Add(TGAAttachment);
                        }
                        if (!string.IsNullOrEmpty(IRAttachment))
                        {
                            fileArray.Add(IRAttachment);
                        }
                        if (!string.IsNullOrEmpty(itemObj.UVSpectra))
                        {
                            fileArray.Add(itemObj.UVSpectra.ReplaceForFilepath());
                        }
                        if (!string.IsNullOrEmpty(CMRAttachment))
                        {
                            fileArray.Add(CMRAttachment);
                        }
                        if (!string.IsNullOrEmpty(itemObj.QNMRAttchment))
                        {
                            fileArray.Add(itemObj.QNMRAttchment.ReplaceForFilepath());
                        }
                        if (!string.IsNullOrEmpty(itemObj.OtherAnalysisAttachment))
                        {
                            fileArray.Add(itemObj.OtherAnalysisAttachment.ReplaceForFilepath());
                        }
                        if (!string.IsNullOrEmpty(itemObj.DEPTAttachment))
                        {
                            fileArray.Add(itemObj.DEPTAttachment.ReplaceForFilepath());
                        }
                        if (!string.IsNullOrEmpty(itemObj.HRMSAttachment))
                        {
                            fileArray.Add(itemObj.HRMSAttachment.ReplaceForFilepath());
                        }
                        if (!string.IsNullOrEmpty(itemObj.ROIAttachment))
                        {
                            fileArray.Add(itemObj.ROIAttachment.ReplaceForFilepath());
                        }
                        if (!string.IsNullOrEmpty(itemObj.ElementralAttachment))
                        {
                            fileArray.Add(itemObj.ElementralAttachment.ReplaceForFilepath());
                        }
                        if (!string.IsNullOrEmpty(itemObj.SERAttachment))
                        {
                            fileArray.Add(itemObj.SERAttachment.ReplaceForFilepath());
                        }
                        if (!string.IsNullOrEmpty(itemObj.GCAttachment))
                        {
                            fileArray.Add(itemObj.GCAttachment.ReplaceForFilepath());
                        }
                        if (!string.IsNullOrEmpty(itemObj.ELSDAttachment))
                        {
                            fileArray.Add(itemObj.ELSDAttachment.ReplaceForFilepath());
                        }
                        if (!string.IsNullOrEmpty(itemObj.ChiralAttachmenrt))
                        {
                            fileArray.Add(itemObj.ChiralAttachmenrt.ReplaceForFilepath());
                        }
                        if (!string.IsNullOrEmpty(itemObj.APCIMassAttachment))
                        {
                            fileArray.Add(itemObj.APCIMassAttachment.ReplaceForFilepath());
                        }
                        if (!string.IsNullOrEmpty(itemObj.NMRInterpretaionAttachment))
                        {
                            fileArray.Add(itemObj.NMRInterpretaionAttachment.ReplaceForFilepath());
                        }
                        if (!string.IsNullOrEmpty(itemObj.N1NmrAttachment))
                        {
                            fileArray.Add(itemObj.N1NmrAttachment.ReplaceForFilepath());
                        }
                        if (!string.IsNullOrEmpty(itemObj.ChiralHPLCAttachment))
                        {
                            fileArray.Add(itemObj.ChiralHPLCAttachment.ReplaceForFilepath());
                        }
                        if (!string.IsNullOrEmpty(itemObj.IsotropicpurityAttachment))
                        {
                            fileArray.Add(itemObj.IsotropicpurityAttachment.ReplaceForFilepath());
                        }
                        if (!string.IsNullOrEmpty(itemObj.COSYAttachment))
                        {
                            fileArray.Add(itemObj.COSYAttachment.ReplaceForFilepath());
                        }
                        if (!string.IsNullOrEmpty(itemObj.CHNSAttachment))
                        {
                            fileArray.Add(itemObj.CHNSAttachment.ReplaceForFilepath());
                        }
                        if (!string.IsNullOrEmpty(itemObj.StabilitydataAttachment))
                        {
                            fileArray.Add(itemObj.StabilitydataAttachment.ReplaceForFilepath());
                        }
                        if (!string.IsNullOrEmpty(itemObj.LCMSAttachment))
                        {
                            fileArray.Add(itemObj.LCMSAttachment.ReplaceForFilepath());
                        }

                        List<string> passFileArray = new List<string>();
                        foreach (var item in fileArray)
                        {
                            if (item.Contains("s3"))
                            {
                                passFileArray.Add(item);
                            }
                            else
                            {
                                passFileArray.Add(Server.MapPath(item.Replace("..", "~")));
                            }
                        }
                        Common.MargeMultiplePDF(passFileArray, outputPdfPath);
                    }
                    else
                    {
                        return Server.MapPath("~" + path);
                    }

                    return outputPdfPath;
                }
            }

            return Server.MapPath("~" + path);
        }


        public string MasterCOAPath(SZ_MasterCOA mastercoadata, bool isScanCopy = false, bool iswebsite = false, bool isReturnFile = false)
        {
            ViewBag.isScanCopy = isScanCopy;
            var htmlstring = string.Empty;
            //var data = db.SZ_MasterCOA.Where(x => x.Id == id).FirstOrDefault();
            var data = mastercoadata;
            if (data != null)
            {
                if (isScanCopy)
                {
                    data.IsLogoAttached = true;
                }
                if (iswebsite)
                {
                    data.IsLogoAttached = true;
                }
                var batchdata = db.SZ_Inventory.Where(x => x.Id == data.BatchId).FirstOrDefault();
                if (batchdata != null)
                {
                    string uri = Domain + "/api/RestAPI/ProductDetails?productId=" + batchdata.ProductId;
                    using (HttpClient httpClient = new HttpClient())
                    {
                        Task<String> response = httpClient.GetStringAsync(uri);
                        string productModel = JsonConvert.DeserializeObject<string>(response.Result);
                        ViewBag.Products = JsonConvert.DeserializeObject<ProductDetailsModel>(productModel);
                    }
                    htmlstring = PartialViewdata(this, "_PartialRepresentativeMasterCOAPdf", data);
                }
            }

            //string path = ConvertHTMLToPDF(htmlstring, "mastercoa-" + + DateTime.Now.ToString().Replace(" ", "_").Replace(":", "_").Replace("/", "_"));
            string path = ConvertHTMLToPDF(htmlstring, filenameDateWise("mastercoa-" + Guid.NewGuid()), false, isReturnFile);
            return path;
        }

        public ActionResult DownloadChildCOA(int id)
        {
            var htmlstring = string.Empty;
            var data = db.SZ_ChildCOA.Where(x => x.Id == id).FirstOrDefault();
            if (data != null)
            {
                var batchdata = db.SZ_Inventory.Where(x => x.Id == id).FirstOrDefault();
                string uri = Domain + "/api/RestAPI/ProductDetails?productId=" + batchdata.ProductId;
                using (HttpClient httpClient = new HttpClient())
                {
                    Task<String> response = httpClient.GetStringAsync(uri);
                    string productModel = JsonConvert.DeserializeObject<string>(response.Result);
                    ViewBag.Products = JsonConvert.DeserializeObject<ProductDetailsModel>(productModel);
                }
                htmlstring = PartialViewdata(this, "_PartialRepresentativeCOAPdf", data);
            }

            string path = printpdf(htmlstring, "testcoa-" + DateTime.Now.ToShortDateString().Replace("/", "_"));
            return File(path, "application/pdf", Server.UrlEncode(data.RefNo + "-" + DateTime.Now.ToString("HHmm") + "-" + DateTime.Now.ToString("yy") + "-" + DateTime.Now.ToString("ddMM") + ".pdf"));
        }


        public ActionResult DownloadRepresentativeCOA(int id, bool isScanCopy = false, bool isQACoa = false)
        {
            ViewBag.isQACoa = isQACoa;
            ViewBag.isScanCopy = isScanCopy;
            var htmlstring = string.Empty;
            var data = db.SZ_ChildCOA.Where(x => x.Id == id).FirstOrDefault();
            if (data != null)
            {
                if (isScanCopy)
                {
                    data.IsLogoAttached = true;
                }

                var batchdata = db.SZ_Inventory.Where(x => x.Id == data.SZ_MasterCOA.BatchId).FirstOrDefault();
                string uri = Domain + "/api/RestAPI/ProductDetails?productId=" + batchdata.ProductId;
                using (HttpClient httpClient = new HttpClient())
                {
                    Task<String> response = httpClient.GetStringAsync(uri);
                    string productModel = JsonConvert.DeserializeObject<string>(response.Result);
                    ViewBag.Products = JsonConvert.DeserializeObject<ProductDetailsModel>(productModel);
                }

                if (string.IsNullOrEmpty(data.WegithLossBy))
                {
                    data.WegithLossBy = "TGA";
                }
                htmlstring = PartialViewdata(this, "_PartialRepresentativeCOAPdf", data);
            }

            string path = ConvertHTMLToPDF(htmlstring, filenameDateWise("testcoa"));
            return File(path, "application/pdf", Server.UrlEncode(data.ProductName.Replace(" ", "_") + "_" + data.CATNo + "_" + data.BatchNo + "_COA.pdf"));
        }

        public ActionResult RefStock()
        {
            return View();
        }

        public ActionResult ResQty()
        {
            var model = db.SZ_ReservedQty.OrderByDescending(x => x.CreatedDate).ToList();
            return View(model);
        }
        public ActionResult Purchase()
        {
            var fltPurchaseStatus = new List<SelectListItem>();

            foreach (EnumList.PurchaseStatusDDL r in Enum.GetValues(typeof(EnumList.PurchaseStatusDDL)))
            {
                var item = Enum.GetName(typeof(EnumList.PurchaseStatusDDL), r);
                var test = r.ToString();
                string text = SZ_Helper.GetEnumDescription((EnumList.PurchaseStatusDDL)(int)r);
                int val = (int)r;
                fltPurchaseStatus.Add(new SelectListItem
                {
                    Text = text,
                    Value = val.ToString()
                });
            }
            ViewBag.fltPurchaseStatus = fltPurchaseStatus;
            var list = new List<SZ_QuotationModel>();

            string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.Purchase);
            string purSynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
            ViewBag.AllCount = (from i in db.SZ_Quotation
                                join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                                where ((string.IsNullOrEmpty(t2.TrackingNo)
                                && (t2.ProjectType == inhouseProjectType || t2.ProjectType == purSynthesisProjectType)
                                && (t2.IsOnHold == false || t2.IsOnHold == null)
                                && (t2.IsCancel == false || t2.IsCancel == null)
                                && (t2.IsSynthesisLog == false || t2.IsSynthesisLog == null))
                                || t2.IsPurchase == true) && t2.PurchaseDate.HasValue
                                orderby t2.PurchaseDate descending
                                select t2).Distinct().Count();


            ViewBag.RFQCount = (from i in db.SZ_Quotation
                                join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                                where ((string.IsNullOrEmpty(t2.TrackingNo)
                                && (t2.ProjectType == inhouseProjectType || t2.ProjectType == purSynthesisProjectType)
                                && (t2.IsOnHold == false || t2.IsOnHold == null)
                                && (t2.IsCancel == false || t2.IsCancel == null)
                                && (t2.IsSynthesisLog == false || t2.IsSynthesisLog == null))
                                || t2.IsPurchase == true) && t2.PurchaseDate.HasValue
                                && t2.PurchaseDDLStatus == "20"
                                orderby t2.PurchaseDate descending
                                select t2).Distinct().Count();

            ViewBag.SubmittedCount = (from i in db.SZ_QuotationDetail
                                      where i.PurchaseDDLStatus == "28"
                                      orderby i.PurchaseDate descending
                                      select i).Distinct().Count();

            ViewBag.OrderedCount = (from i in db.SZ_Quotation
                                    join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                                    where ((string.IsNullOrEmpty(t2.TrackingNo)
                                    && (t2.ProjectType == inhouseProjectType || t2.ProjectType == purSynthesisProjectType)
                                    && (t2.IsOnHold == false || t2.IsOnHold == null)
                                    && (t2.IsCancel == false || t2.IsCancel == null)
                                    && (t2.IsSynthesisLog == false || t2.IsSynthesisLog == null))
                                    || t2.IsPurchase == true) && t2.PurchaseDate.HasValue
                                    && t2.PurchaseDDLStatus == "24"
                                    orderby t2.PurchaseDate descending
                                    select t2).Distinct().Count();
            ViewBag.DispatchedCount = (from i in db.SZ_Quotation
                                       join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                                       where ((string.IsNullOrEmpty(t2.TrackingNo)
                                       && (t2.ProjectType == inhouseProjectType || t2.ProjectType == purSynthesisProjectType)
                                       && (t2.IsOnHold == false || t2.IsOnHold == null)
                                       && (t2.IsCancel == false || t2.IsCancel == null)
                                       && (t2.IsSynthesisLog == false || t2.IsSynthesisLog == null))
                                       || t2.IsPurchase == true) && t2.PurchaseDate.HasValue
                                       && t2.PurchaseDDLStatus == "25"
                                       orderby t2.PurchaseDate descending
                                       select t2).Distinct().Count();
            ViewBag.QuoteApprovalCount = (from i in db.SZ_Quotation
                                          join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                                          where ((string.IsNullOrEmpty(t2.TrackingNo)
                                          && (t2.ProjectType == inhouseProjectType || t2.ProjectType == purSynthesisProjectType)
                                          && (t2.IsOnHold == false || t2.IsOnHold == null)
                                          && (t2.IsCancel == false || t2.IsCancel == null)
                                          && (t2.IsSynthesisLog == false || t2.IsSynthesisLog == null))
                                          || t2.IsPurchase == true) && t2.PurchaseDate.HasValue
                                          && t2.PurchaseDDLStatus == "22"
                                          orderby t2.PurchaseDate descending
                                          select t2).Distinct().Count();
            ViewBag.TRANSITCount = (from i in db.SZ_Quotation
                                    join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                                    where ((string.IsNullOrEmpty(t2.TrackingNo)
                                    && (t2.ProjectType == inhouseProjectType || t2.ProjectType == purSynthesisProjectType)
                                    && (t2.IsOnHold == false || t2.IsOnHold == null)
                                    && (t2.IsCancel == false || t2.IsCancel == null)
                                    && (t2.IsSynthesisLog == false || t2.IsSynthesisLog == null))
                                    || t2.IsPurchase == true) && t2.PurchaseDate.HasValue
                                    && t2.PurchaseDDLStatus == "26"
                                    orderby t2.PurchaseDate descending
                                    select t2).Distinct().Count();
            ViewBag.ENQUIRYCount = (from x in db.SZ_PurchaseRFQ
                                    where x.PurchaseStatus != "28" && x.PurchaseStatus != "16"
                                    orderby x.CreatedDate descending
                                    select x).Distinct().Count();

            //string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.Purchase);
            //string purSynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);

            //var model = (from i in db.SZ_Quotation
            //             join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
            //             where ((string.IsNullOrEmpty(t2.TrackingNo)
            //             && (t2.ProjectType == inhouseProjectType || t2.ProjectType == purSynthesisProjectType)
            //             && (t2.IsOnHold == false || t2.IsOnHold == null)
            //             && (t2.IsCancel == false || t2.IsCancel == null)
            //             && (t2.IsSynthesisLog == false || t2.IsSynthesisLog == null))
            //             || t2.IsPurchase == true) && t2.PurchaseDate.HasValue
            //             orderby t2.PurchaseDate descending
            //             select t2).Distinct();

            //var inventory = db.SZ_Inventory.ToList();
            //
            //var ReadyToDeliverScientistStatusId = db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
            //var scistatusdata = db.SZ_ScientistStatus.ToList();
            //var qdids = model.Select(x => x.Id).ToList();
            //var quoteformdata = db.SZ_QuoteDetails_Form.Where(x => qdids.Contains(x.QuoteDetailsId)).ToList();
            //foreach (var k in model.OrderByDescending(x => x.PurchaseDate).ThenByDescending(x => x.CreatedDate).ToList())
            //{
            //    SZ_QuotationModel subList = new SZ_QuotationModel();
            //    subList.QuoteId = k.QuoteId;
            //    subList.IsImageAttach = k.SZ_Quotation.IsImageAttach;
            //    subList.CompanyName = k.SZ_Quotation.CompanyName;
            //    subList.Email = k.SZ_Quotation.EmailAddress;
            //    subList.PONumber = k.SZ_Quotation.PONo;
            //    subList.Ref = k.SZ_Quotation.Ref;
            //    subList.Remark = k.SZ_Quotation.Remark;
            //    subList.MoveToScientistDate = k.MoveToScientistDate;
            //    subList.SZ_QuotationProductModel = new List<SZ_QuotationProductModel>();

            //    SZ_QuotationProductModel objlist = new SZ_QuotationProductModel();
            //    objlist.ReadyToDeliverScientistStatusId = ReadyToDeliverScientistStatusId;
            //    objlist.ScientistFormCount = quoteformdata.Where(x => x.QuoteDetailsId == k.Id).Count();
            //    objlist.QuoteDetailsId = k.Id;
            //    objlist.CASNo = k.CASNo;
            //    objlist.CATNo = k.CATNo;
            //    objlist.CreatedDate = k.CreatedDate;
            //    objlist.ImagePath = k.ImagePath;
            //    objlist.IsUploadServer = k.IsUploadServer;
            //    objlist.LeadTime = k.LeadTime;
            //    objlist.Price = k.Price;
            //    objlist.ProductId = k.ProductId;
            //    objlist.ProductName = k.ProductName;
            //    objlist.QuoteId = k.QuoteId;
            //    objlist.RequiredQty = k.RequiredQty;
            //    objlist.BatchNo = inventory.Where(x => x.Id == k.AdditionalBatchNo).Select(x => x.BatchNo).FirstOrDefault();
            //    objlist.AdditionalBatchNo = k.AdditionalBatchNo;
            //    objlist.MoveToDispatch = k.MoveToDispatch;
            //    objlist.MoveToProject = k.MoveToProject;
            //    objlist.MoveProjectDate = k.MoveProjectDate;
            //    objlist.Remark = k.Remark;
            //    objlist.PurchaseStatus = k.PurchaseStatus;
            //    objlist.PurchaseDate = k.PurchaseDate;
            //    objlist.EstimateCompleteDate = k.EstimateCompleteDate;
            //    objlist.PurchaseDDLStatus = k.PurchaseDDLStatus;
            //    objlist.PurchaseRemark = k.PurchaseRemark;
            //    objlist.Reason = k.Reason;
            //    if (k.ProjectStatus != null)
            //    {
            //        objlist.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
            //    }
            //    objlist.ScientistStatustext = scistatusdata.Where(x => x.Id == k.ScientistStatus).Select(x => x.Name).FirstOrDefault();
            //    objlist.IsSynthesisLog = k.IsSynthesisLog;
            //    objlist.PurApprovedStatus = k.PurApprovedStatus;
            //    objlist.PurMangRemark = k.PurMangRemark;
            //    objlist.PurClientPODate = k.PurClientPODate;
            //    objlist.PurOurPODt = k.PurOurPODt;
            //    objlist.PurExpectedReceiptDt = k.PurExpectedReceiptDt;
            //    objlist.PurCurrentExpDt = k.PurCurrentExpDt;
            //    objlist.PurActualReceiptDt = k.PurActualReceiptDt;
            //    objlist.PurTargetDispatchDt = k.PurTargetDispatchDt;
            //    subList.SZ_QuotationProductModel.Add(objlist);
            //    list.Add(subList);
            //}
            return View(list);
        }

        [HttpPost]
        public ActionResult LoadPurchaseAllData(int status = 0)
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                var purchasestatusddl = "";
                if (Request.Form.GetValues("purchasestatusddl") != null)
                {
                    purchasestatusddl = Request.Form.GetValues("purchasestatusddl").FirstOrDefault();
                }

                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;
                string purchaseProjectType = Convert.ToString((int)EnumList.ProjectType.Purchase);
                string purSynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
                var model = (from i in db.SZ_Quotation
                             join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                             where ((string.IsNullOrEmpty(t2.TrackingNo)
                             && (t2.ProjectType == purchaseProjectType || t2.ProjectType == purSynthesisProjectType)
                             && (t2.IsOnHold == false || t2.IsOnHold == null)
                             && (t2.IsCancel == false || t2.IsCancel == null)
                             )
                             || t2.IsPurchase == true) && t2.PurchaseDate.HasValue
                             && !i.CompanyName.Contains("synzeal")
                             orderby t2.PurchaseDate descending
                             select t2).Distinct();

                if (status > 0)
                {
                    string stat = Convert.ToString(status);
                    model = model.Where(x => x.PurchaseDDLStatus == stat);
                }
                if (!string.IsNullOrEmpty(purchasestatusddl))
                {
                    model = model.Where(x => x.PurchaseDDLStatus == purchasestatusddl);
                }

                DateTime sevendays = DateTime.Now.AddDays(-7);

                var catnolist = model.Where(x => x.MoveProjectDate < sevendays && x.PurchaseDDLStatus != "24"
                                                    && x.PurchaseDDLStatus != "25"
                                                    && x.PurchaseDDLStatus != "26"
                                                    && x.PurchaseDDLStatus != "28").Select(x => x.CATNo).ToList();
                var inventory = db.SZ_Inventory.ToList();
                var list = new List<PurchaseModel>();
                var ReadyToDeliverScientistStatusId = db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                var scistatusdata = db.SZ_ScientistStatus.ToList();
                var qdids = model.Select(x => x.Id).ToList();
                var quoteformdata = db.SZ_QuoteDetails_Form.Where(x => qdids.Contains(x.QuoteDetailsId)).ToList();
                foreach (var k in model.OrderByDescending(x => x.PurchaseDate).ThenByDescending(x => x.CreatedDate).ToList())
                {
                    PurchaseModel objlist = new PurchaseModel();
                    objlist.ChkRow = "<input type=\"checkbox\" class=\"chkrow\" value='" + k.Id + "' />";
                    if (k.PurchaseDate.HasValue)
                    {
                        objlist.StrPurchaseDate = k.PurchaseDate.Value.ToShortDateString();
                    }

                    var str = "<select id='purchaseddlstatus_" + k.Id + "' class='allpurstat form-control' data-value='" + k.PurchaseDDLStatus + "'><option value=''>--Select--</option>";
                    foreach (EnumList.PurchaseStatusDDL r in Enum.GetValues(typeof(EnumList.PurchaseStatusDDL)))
                    {
                        var item = Enum.GetName(typeof(EnumList.PurchaseStatusDDL), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.PurchaseStatusDDL)(int)r);
                        int val = (int)r;
                        string selecteds = "";
                        if (Convert.ToString(val) == k.PurchaseDDLStatus)
                        {
                            selecteds = "selected ";
                        }
                        str += "<option value='" + val + "' " + selecteds + ">" + text + "</option>";
                    }
                    str += "</select>";
                    objlist.StrPurchaseDDLStatus = str;
                    objlist.PurchaseDDLStatus = k.PurchaseDDLStatus;
                    objlist.PONumber = k.SZ_Quotation.PONo;
                    objlist.CASNo = k.CASNo;
                    objlist.CATNo = "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>";
                    if (catnolist.Where(x => x == k.CATNo).Count() > 1)
                    {
                        objlist.CATNo = "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a> <i style='color:red' class='fa fa-exclamation-triangle'></i>";
                    }


                    objlist.ProductId = k.ProductId;
                    objlist.ProductName = k.ProductName;
                    objlist.RequiredQty = k.RequiredQty;
                    //objlist.BatchNo = inventory.Where(x => x.Id == k.AdditionalBatchNo).Select(x => x.BatchNo).FirstOrDefault();
                    objlist.StrEstimateCompleteDate = "<input type=\"text\" id='estDate_" + k.Id + "' class=\"datepicker\" style=\"width:100px;\" data-value='" + @k.EstimateCompleteDate + "' />";
                    objlist.PurchaseStatus = "<input type=\"text\" id='purchasestatus_" + k.Id + "' value='" + k.PurchaseStatus + "' title='" + k.PurchaseStatus + "'/>  <i class='fa fa-pencil' onclick='PurchasesummaryGenerate(" + k.Id + ",&#39;&#39;)' ></i>";
                    objlist.PurchaseRemark = "<input type=\"text\" id='purchaseremark_" + k.Id + "' value='" + k.PurchaseRemark + "' title='" + k.PurchaseRemark + "' />  <i class='fa fa-pencil' onclick='PurchaseremarkGenerate(" + k.Id + ")' ></i>";
                    objlist.Reason = "<input type=\"text\" id='reason_" + k.Id + "' value='" + k.Reason + "' />";
                    objlist.StrPurClientPODate = "<input type=\"text\" id='ClientPODate_" + k.Id + "' class=\"datepicker\" style=\"width:100px;\" data-value='" + k.PurClientPODate + "' />";
                    objlist.StrPurOurPODt = "<input type=\"text\" id='OurPODt_" + k.Id + "' class=\"datepicker\" style=\"width:100px;\" data-value='" + k.PurOurPODt + "' />";
                    objlist.StrPurExpectedReceiptDt = "<input type=\"text\" id='ExpectedReceiptDt_" + k.Id + "' class=\"datepicker\" style=\"width:100px;\" data-value='" + k.PurExpectedReceiptDt + "' />";
                    objlist.StrPurCurrentExpDt = "<input type=\"text\" id='CurrentExpDt_" + k.Id + "' class=\"datepicker\" style=\"width:100px;\" data-value='" + k.PurCurrentExpDt + "' />";
                    objlist.StrPurActualReceiptDt = "<input type=\"text\" id='ActualReceiptDt_" + k.Id + "' class=\"datepicker\" style=\"width:100px;\" data-value='" + k.PurActualReceiptDt + "' />";
                    objlist.StrPurTargetDispatchDt = "<input type=\"text\" id='TargetDispatchDt_" + k.Id + "' class=\"datepicker\" style=\"width:100px;\" data-value='" + k.PurTargetDispatchDt + "' />";
                    objlist.PurPrice = "<input type=\"text\" id='PurPrice_" + k.Id + "' style=\"width:100px;\" data-value='" + k.PurPrice + "' />";
                    objlist.PurSZPONo = "<input type=\"text\" id='PurSZPONo_" + k.Id + "' style=\"width:100px;\" data-value='" + k.PurSZPONo + "' />";
                    objlist.PurApprovedStatus = "<select id='purapprovedstatus_" + k.Id + "' class=\"clspurapprovedstatus\" data-value='" + k.PurApprovedStatus + "'><option value=\"\">--Select--</option><option value=\"Pending\">Pending</option><option value=\"Approved\">Approved</option><option value=\"Need Action\">Need Action</option></select>";
                    objlist.PurMangRemark = "<input type=\"text\" id='purmangremark_" + k.Id + "' value='" + k.PurMangRemark + "' title='" + k.PurMangRemark + "'  />   <i class='fa fa-pencil' onclick='PurchaseManagementremarkGenerate(" + k.Id + ")' ></i>";
                    objlist.QuoteId = k.QuoteId;
                    string selected = string.Empty;
                    objlist.BatchNo = "<select id='additionalBatch_" + k.ProductId + "' class='addbatch'><option value=''>--Select--</option>";
                    var proBatchData = inventory.Where(x => x.ProductId == k.ProductId).OrderBy(x => x.Id).ToList();
                    if (proBatchData.Count > 0)
                    {
                        int probatchcount = 1;
                        foreach (var r in proBatchData)
                        {
                            string qty = CommonOperation.SettleQtyForSPMS(r);
                            string text = r.BatchNo + " (" + qty + ")";
                            if (r.IsApproved == false)
                            {
                                text = "*" + text;
                            }
                            if (k.AdditionalBatchNo.HasValue && k.AdditionalBatchNo.Value == r.Id)
                            {
                                selected = " selected ";
                            }
                            objlist.BatchNo += "<option value='" + r.Id.ToString() + "' data-value='" + r.BatchNo + "' " + selected + ">" + text + "</option>";
                            probatchcount += 1;
                        }
                    }
                    objlist.BatchNo += "</select>";

                    if (SessionCookieManagement.IsAdmin)
                    {
                        objlist.Price = k.Price;
                    }

                    objlist.LeadTime = k.LeadTime;
                    list.Add(objlist);
                }

                recordsTotal = list.Count();
                var outlist = list.Skip(skip).Take(pageSize).ToList();

                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    outlist = outlist.Where(m => (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.RequiredQty != null && m.RequiredQty.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))).ToList();
                }

                //recordsTotal = model.Count();
                //var data = model.Skip(skip).Take(pageSize).ToList();
                var data = outlist;

                var jsonResult = Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
                jsonResult.MaxJsonLength = int.MaxValue;
                return jsonResult;

            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }
        }

        
             [HttpPost]
        public ActionResult LoadPurchaseInhouseData()
        {
            try
            {   
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                var purchasestatusddl = "";
                if (Request.Form.GetValues("purchasestatusddl") != null)
                {
                    purchasestatusddl = Request.Form.GetValues("purchasestatusddl").FirstOrDefault();
                }

                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;
                string purchaseProjectType = Convert.ToString((int)EnumList.ProjectType.Purchase);
                string purSynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
                var model = (from i in db.SZ_Quotation
                             join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                             where ((string.IsNullOrEmpty(t2.TrackingNo)
                             && (t2.ProjectType == purchaseProjectType || t2.ProjectType == purSynthesisProjectType)
                             && (t2.IsOnHold == false || t2.IsOnHold == null)
                             && (t2.IsCancel == false || t2.IsCancel == null)
                             )
                             || t2.IsPurchase == true) && t2.PurchaseDate.HasValue
                             && i.CompanyName.Contains("synzeal")
                             orderby t2.PurchaseDate descending
                             select t2).Distinct();

                if (!string.IsNullOrEmpty(purchasestatusddl))
                {
                    model = model.Where(x => x.PurchaseDDLStatus == purchasestatusddl);
                }

                DateTime sevendays = DateTime.Now.AddDays(-7);

                var catnolist = model.Where(x => x.MoveProjectDate < sevendays && x.PurchaseDDLStatus != "24"
                                                    && x.PurchaseDDLStatus != "25"
                                                    && x.PurchaseDDLStatus != "26"
                                                    && x.PurchaseDDLStatus != "28").Select(x => x.CATNo).ToList();
                var inventory = db.SZ_Inventory.ToList();
                var list = new List<PurchaseModel>();
                var ReadyToDeliverScientistStatusId = db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
                var scistatusdata = db.SZ_ScientistStatus.ToList();
                var qdids = model.Select(x => x.Id).ToList();
                var quoteformdata = db.SZ_QuoteDetails_Form.Where(x => qdids.Contains(x.QuoteDetailsId)).ToList();
                foreach (var k in model.OrderByDescending(x => x.PurchaseDate).ThenByDescending(x => x.CreatedDate).ToList())
                {
                    PurchaseModel objlist = new PurchaseModel();
                    objlist.ChkRow = "<input type=\"checkbox\" class=\"chkrow\" value='" + k.Id + "' />";
                    if (k.PurchaseDate.HasValue)
                    {
                        objlist.StrPurchaseDate = k.PurchaseDate.Value.ToShortDateString();
                    }

                    var str = "<select id='purchaseddlstatus_" + k.Id + "' class='allpurstat form-control' data-value='" + k.PurchaseDDLStatus + "'><option value=''>--Select--</option>";
                    foreach (EnumList.PurchaseStatusDDL r in Enum.GetValues(typeof(EnumList.PurchaseStatusDDL)))
                    {
                        var item = Enum.GetName(typeof(EnumList.PurchaseStatusDDL), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.PurchaseStatusDDL)(int)r);
                        int val = (int)r;
                        string selecteds = "";
                        if (Convert.ToString(val) == k.PurchaseDDLStatus)
                        {
                            selecteds = "selected ";
                        }
                        str += "<option value='" + val + "' " + selecteds + ">" + text + "</option>";
                    }
                    str += "</select>";
                    objlist.StrPurchaseDDLStatus = str;
                    objlist.PurchaseDDLStatus = k.PurchaseDDLStatus;
                    objlist.PONumber = k.SZ_Quotation.PONo;
                    objlist.CASNo = k.CASNo;
                    objlist.CATNo = "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a>";
                    if (catnolist.Where(x => x == k.CATNo).Count() > 1)
                    {
                        objlist.CATNo = "<a href='https://www.synzeal.com/search?q=" + k.CATNo + "' target='_blank'>" + k.CATNo + "</a> <i style='color:red' class='fa fa-exclamation-triangle'></i>";
                    }


                    objlist.ProductId = k.ProductId;
                    objlist.ProductName = k.ProductName;
                    objlist.RequiredQty = k.RequiredQty;
                    //objlist.BatchNo = inventory.Where(x => x.Id == k.AdditionalBatchNo).Select(x => x.BatchNo).FirstOrDefault();
                    objlist.StrEstimateCompleteDate = "<input type=\"text\" id='estDate_" + k.Id + "' class=\"datepicker\" style=\"width:100px;\" data-value='" + @k.EstimateCompleteDate + "' />";
                    objlist.PurchaseStatus = "<input type=\"text\" id='purchasestatus_" + k.Id + "' value='" + k.PurchaseStatus + "' title='" + k.PurchaseStatus + "'/>  <i class='fa fa-pencil' onclick='PurchasesummaryGenerate(" + k.Id + ",&#39;&#39;)' ></i>";
                    objlist.PurchaseRemark = "<input type=\"text\" id='purchaseremark_" + k.Id + "' value='" + k.PurchaseRemark + "' title='" + k.PurchaseRemark + "' />  <i class='fa fa-pencil' onclick='PurchaseremarkGenerate(" + k.Id + ")' ></i>";
                    objlist.Reason = "<input type=\"text\" id='reason_" + k.Id + "' value='" + k.Reason + "' />";
                    objlist.StrPurClientPODate = "<input type=\"text\" id='ClientPODate_" + k.Id + "' class=\"datepicker\" style=\"width:100px;\" data-value='" + k.PurClientPODate + "' />";
                    objlist.StrPurOurPODt = "<input type=\"text\" id='OurPODt_" + k.Id + "' class=\"datepicker\" style=\"width:100px;\" data-value='" + k.PurOurPODt + "' />";
                    objlist.StrPurExpectedReceiptDt = "<input type=\"text\" id='ExpectedReceiptDt_" + k.Id + "' class=\"datepicker\" style=\"width:100px;\" data-value='" + k.PurExpectedReceiptDt + "' />";
                    objlist.StrPurCurrentExpDt = "<input type=\"text\" id='CurrentExpDt_" + k.Id + "' class=\"datepicker\" style=\"width:100px;\" data-value='" + k.PurCurrentExpDt + "' />";
                    objlist.StrPurActualReceiptDt = "<input type=\"text\" id='ActualReceiptDt_" + k.Id + "' class=\"datepicker\" style=\"width:100px;\" data-value='" + k.PurActualReceiptDt + "' />";
                    objlist.StrPurTargetDispatchDt = "<input type=\"text\" id='TargetDispatchDt_" + k.Id + "' class=\"datepicker\" style=\"width:100px;\" data-value='" + k.PurTargetDispatchDt + "' />";
                    objlist.PurPrice = "<input type=\"text\" id='PurPrice_" + k.Id + "' style=\"width:100px;\" data-value='" + k.PurPrice + "' />";
                    objlist.PurSZPONo = "<input type=\"text\" id='PurSZPONo_" + k.Id + "' style=\"width:100px;\" data-value='" + k.PurSZPONo + "' />";
                    objlist.PurApprovedStatus = "<select id='purapprovedstatus_" + k.Id + "' class=\"clspurapprovedstatus\" data-value='" + k.PurApprovedStatus + "'><option value=\"\">--Select--</option><option value=\"Pending\">Pending</option><option value=\"Approved\">Approved</option><option value=\"Need Action\">Need Action</option></select>";
                    objlist.PurMangRemark = "<input type=\"text\" id='purmangremark_" + k.Id + "' value='" + k.PurMangRemark + "' title='" + k.PurMangRemark + "'  />   <i class='fa fa-pencil' onclick='PurchaseManagementremarkGenerate(" + k.Id + ")' ></i>";
                    objlist.QuoteId = k.QuoteId;
                    string selected = string.Empty;
                    objlist.BatchNo = "<select id='additionalBatch_" + k.ProductId + "' class='addbatch'><option value=''>--Select--</option>";
                    var proBatchData = inventory.Where(x => x.ProductId == k.ProductId).OrderBy(x => x.Id).ToList();
                    if (proBatchData.Count > 0)
                    {
                        int probatchcount = 1;
                        foreach (var r in proBatchData)
                        {
                            string qty = CommonOperation.SettleQtyForSPMS(r);
                            string text = r.BatchNo + " (" + qty + ")";
                            if (r.IsApproved == false)
                            {
                                text = "*" + text;
                            }
                            if (k.AdditionalBatchNo.HasValue && k.AdditionalBatchNo.Value == r.Id)
                            {
                                selected = " selected ";
                            }
                            objlist.BatchNo += "<option value='" + r.Id.ToString() + "' data-value='" + r.BatchNo + "' " + selected + ">" + text + "</option>";
                            probatchcount += 1;
                        }
                    }
                    objlist.BatchNo += "</select>";

                    if (SessionCookieManagement.IsAdmin)
                    {
                        objlist.Price = k.Price;
                    }

                    objlist.LeadTime = k.LeadTime;
                    list.Add(objlist);
                }

                recordsTotal = list.Count();
                var outlist = list.Skip(skip).Take(pageSize).ToList();

                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    outlist = outlist.Where(m => (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.RequiredQty != null && m.RequiredQty.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))).ToList();
                }

                //recordsTotal = model.Count();
                //var data = model.Skip(skip).Take(pageSize).ToList();
                var data = outlist;

                var jsonResult = Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
                jsonResult.MaxJsonLength = int.MaxValue;
                return jsonResult;

            }
            catch (Exception ex)
            {
                string errortext = "Line: " + ex.LineNumber();
                System.IO.File.WriteAllText(Server.MapPath("~/img/Errorlog.txt"), System.DateTime.Now + " /Error : " + errortext + " / stacktrace:" + ex.StackTrace);

                throw ex;
            }
        }

        public ActionResult PriceList()
        {
            if (!SessionCookieManagement.IsPrice && !SessionCookieManagement.IsAdmin)
            {
                return RedirectToAction("Index", "Home");
            }

            var categorymasterlist = db.SZ_CategoryMaster.OrderBy(x => x.Name).ToList();
            var listcategorymaster = new List<SelectListItem>();
            listcategorymaster.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });

            foreach (var item in categorymasterlist)
            {
                listcategorymaster.Add(new SelectListItem
                {
                    Text = item.Name,
                    Value = item.Id.ToString()
                });
            }
            ViewBag.categorymasterlist = listcategorymaster;
            return View();
        }

        public ActionResult ProductMaster()
        {
            return View();
        }
        public ActionResult PurchaseProductMaster()
        {
            return View();
        }

        public ActionResult CategoryMasterList()
        {
            var model = db.SZ_CategoryMaster.ToList();
            return View(model);
        }

        public ActionResult AddCategoryMaster(int id = 0)
        {
            var model = db.SZ_CategoryMaster.Where(x => x.Id == id).FirstOrDefault();
            if (model == null)
                model = new SZ_CategoryMaster();

            return View(model);
        }

        public ActionResult AddCategoryMasterRange()
        {
            var model = db.SZ_CategoryMasterRange.FirstOrDefault();
            if (model == null)
                model = new SZ_CategoryMasterRange();

            return View(model);
        }

        [HttpPost]
        public JsonResult AddCategoryMasterRangeData(SZ_CategoryMasterRange model, FormCollection form)
        {
            var data = db.SZ_CategoryMasterRange.FirstOrDefault();
            if (data != null)
            {
                data.TenStartRange = model.TenStartRange;
                data.TenEndRange = model.TenEndRange;
                data.TwentyfiveStartRange = model.TwentyfiveStartRange;
                data.TwentyfiveEndRange = model.TwentyfiveEndRange;
                data.FiftyStartRange = model.FiftyStartRange;
                data.FiftyEndRange = model.FiftyEndRange;
                data.OnehundredStartRange = model.OnehundredStartRange;
                data.OnehundredEndRange = model.OnehundredEndRange;
                data.TwohundredFiftyStartRange = model.TwohundredFiftyStartRange;
                data.TwohundredFiftyEndRange = model.TwohundredFiftyEndRange;
                data.FivehundredStartRange = model.FivehundredStartRange;
                data.FivehundredEndRange = model.FivehundredEndRange;
                data.OneThousandStartRange = model.OneThousandStartRange;
                data.OneThousandEndRange = model.OneThousandEndRange;
                data.UpdatedDate = DateTime.Now;
                data.UpdatedBy = SessionCookieManagement.UserName;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }
            else
            {
                data = new SZ_CategoryMasterRange();
                data.TenStartRange = model.TenStartRange;
                data.TenEndRange = model.TenEndRange;
                data.TwentyfiveStartRange = model.TwentyfiveStartRange;
                data.TwentyfiveEndRange = model.TwentyfiveEndRange;
                data.FiftyStartRange = model.FiftyStartRange;
                data.FiftyEndRange = model.FiftyEndRange;
                data.OnehundredStartRange = model.OnehundredStartRange;
                data.OnehundredEndRange = model.OnehundredEndRange;
                data.TwohundredFiftyStartRange = model.TwohundredFiftyStartRange;
                data.TwohundredFiftyEndRange = model.TwohundredFiftyEndRange;
                data.FivehundredStartRange = model.FivehundredStartRange;
                data.FivehundredEndRange = model.FivehundredEndRange;
                data.OneThousandStartRange = model.OneThousandStartRange;
                data.OneThousandEndRange = model.OneThousandEndRange;
                data.UpdatedDate = DateTime.Now;
                data.UpdatedBy = SessionCookieManagement.UserName;
                db.SZ_CategoryMasterRange.Add(data);
                db.SaveChanges();
            }
            return Json(new
            {
                success = true
            }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public JsonResult AddCategoryMasterData(SZ_CategoryMaster model, FormCollection form)
        {
            try
            {
                if (model.Id == 0)
                {
                    var checkcompanyavailable = db.SZ_CategoryMaster.Where(x => x.Name.ToLower() == model.Name.ToLower()).FirstOrDefault();
                    if (checkcompanyavailable == null)
                    {
                        SZ_CategoryMaster objComp = new SZ_CategoryMaster();
                        objComp.Name = model.Name;
                        objComp.Rating = model.Rating;
                        objComp.Ten = model.Ten;
                        objComp.Twentyfive = model.Twentyfive;
                        objComp.Fifty = model.Fifty;
                        objComp.Onehundred = model.Onehundred;
                        objComp.TwohundredFifty = model.TwohundredFifty;
                        objComp.Fivehundred = model.Fivehundred;
                        objComp.OneThousand = model.OneThousand;
                        objComp.TenUSD = model.TenUSD;
                        objComp.TwentyfiveUSD = model.TwentyfiveUSD;
                        objComp.FiftyUSD = model.FiftyUSD;
                        objComp.OnehundredUSD = model.OnehundredUSD;
                        objComp.TwohundredFiftyUSD = model.TwohundredFiftyUSD;
                        objComp.FivehundredUSD = model.FivehundredUSD;
                        objComp.OneThousandUSD = model.OneThousandUSD;

                        objComp.CreatedDate = DateTime.Now;
                        objComp.Updateddate = DateTime.Now;
                        objComp.CreatedBy = SessionCookieManagement.UserName;
                        objComp.UpdatedBy = SessionCookieManagement.UserName;
                        db.SZ_CategoryMaster.Add(objComp);
                        db.SaveChanges();

                    }
                    else
                    {
                        return Json(new
                        {
                            success = false,
                            message = "Category master already available."
                        }, JsonRequestBehavior.AllowGet);
                    }
                }
                else
                {
                    var checkcompanyavailable = db.SZ_CategoryMaster.Where(x => x.Name.ToLower() == model.Name.ToLower() && x.Id != model.Id).FirstOrDefault();
                    if (checkcompanyavailable != null)
                    {
                        return Json(new
                        {
                            success = false,
                            message = "Category master already available."
                        }, JsonRequestBehavior.AllowGet);
                    }
                    var comp = db.SZ_CategoryMaster.Where(x => x.Id == model.Id).FirstOrDefault();
                    if (comp != null)
                    {
                        comp.Name = model.Name;
                        comp.Rating = model.Rating;
                        comp.Updateddate = DateTime.Now;
                        comp.UpdatedBy = SessionCookieManagement.UserName;
                        comp.Ten = model.Ten;
                        comp.Twentyfive = model.Twentyfive;
                        comp.Fifty = model.Fifty;
                        comp.Onehundred = model.Onehundred;
                        comp.TwohundredFifty = model.TwohundredFifty;
                        comp.Fivehundred = model.Fivehundred;
                        comp.OneThousand = model.OneThousand;
                        comp.TenUSD = model.TenUSD;
                        comp.TwentyfiveUSD = model.TwentyfiveUSD;
                        comp.FiftyUSD = model.FiftyUSD;
                        comp.OnehundredUSD = model.OnehundredUSD;
                        comp.TwohundredFiftyUSD = model.TwohundredFiftyUSD;
                        comp.FivehundredUSD = model.FivehundredUSD;
                        comp.OneThousandUSD = model.OneThousandUSD;
                        db.Entry(comp).State = EntityState.Modified;
                        db.SaveChanges();
                    }
                }

                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = ""
                }, JsonRequestBehavior.AllowGet);
            }
        }

        public ActionResult UploadDocumentAndData(int id)
        {
            if (!SessionCookieManagement.IsDispatch && !SessionCookieManagement.IsAdmin)
            {
                return RedirectToAction("Index", "Home");
            }

            var model = _operationRepository.GetQuoteDetailByID(id);
            return PartialView("_UploadDocumentAndData", model);
        }
        public ActionResult uploadglpfiles(int id)
        {
            var model = _operationRepository.GetQuoteDetailByID(id);
            return PartialView("_uploadglpfiles", model);
        }
        public ActionResult UploadControlledSubstanceDocument(int id)

        {
            if (!SessionCookieManagement.IsControlledSubstance && !SessionCookieManagement.IsAdmin && !SessionCookieManagement.IsProject)
            {
                return RedirectToAction("Index", "Home");
            }

            var model = _operationRepository.GetQuoteDetailByID(id);
            return PartialView("_UploadControlledSubstanceDocument", model);
        }

        [HttpPost]
        public ActionResult UploadControlledsubstanceDocumentQuotedetails(FormCollection form)
        {
            int id = Convert.ToInt32(Request.Form.Get("Id"));
            string attacheddata = Request.Form.Get("attachedData");
            var quotationrecord = _operationRepository.GetQuoteDetailByID(id);
            quotationrecord.AttachedDataList = attacheddata;
            var file = Request.Files["document"];
            if (file != null)
            {
                var fileName = Path.GetFileName(file.FileName);
                var extension = Path.GetExtension(file.FileName);
                string newfileName = filenameDateWise(Guid.NewGuid().ToString()) + "" + extension;
                //var path = Path.Combine(Server.MapPath("~/Content/UploadDocument/"), newfileName);
                //file.SaveAs(path);

                Aws.Upload(newfileName, file.InputStream);
                string sspath = "https://synzeal-quotation.s3.amazonaws.com/" + newfileName;

                SZ_QuoteDetailsControlSubstance objconsub = new SZ_QuoteDetailsControlSubstance();
                objconsub.Filename = fileName;
                objconsub.Path = sspath;
                objconsub.QuoteDetailId = id;
                objconsub.CreatedDate = DateTime.Now;
                objconsub.CreatedBy = SessionCookieManagement.UserName;
                db.Entry<SZ_QuoteDetailsControlSubstance>(objconsub).State = EntityState.Added;
                db.SaveChanges();
            }


            return Json("Success", JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public ActionResult UploadGLPDataQuotedetails(FormCollection form)
        {
            int id = Convert.ToInt32(Request.Form.Get("Id"));
            var quotationrecord = _operationRepository.GetQuoteDetailByID(id);
            //quotationrecord.AttachedDataList = attacheddata;
            var file = Request.Files["GLPStabilityPath"];
            if (file != null)
            {
                var fileName = Path.GetFileNameWithoutExtension(file.FileName);
                var extension = Path.GetExtension(file.FileName);
                string format = "Mddyyyyhhmmss";
                string date = DateTime.Now.ToString(format);

                string path = fileName + "_" + date + "" + extension;
                Aws.Upload(path, file.InputStream);
                path = "https://synzeal-quotation.s3.amazonaws.com/" + path;

                //var path = Path.Combine(Server.MapPath("~/Content/UploadDocument/"), newfileName);
                //file.SaveAs(path);

                //quotationrecord.COAPath = "../Content/UploadDocument/" + newfileName;
                quotationrecord.GLPStabilityPath = path;
            }
            var analyticaldata = Request.Files["GLPAMVPath"];
            if (analyticaldata != null)
            {
                var fileAnalyticalName = Path.GetFileNameWithoutExtension(analyticaldata.FileName);
                var analyticalextension = Path.GetExtension(analyticaldata.FileName);
                string newanalyticalfileName = Guid.NewGuid().ToString() + "" + analyticalextension;
                //var analyticalpath = Path.Combine(Server.MapPath("~/Content/UploadDocument/"), newanalyticalfileName);
                //analyticaldata.SaveAs(analyticalpath);
                //quotationrecord.AnalyticalData = "../Content/UploadDocument/" + newanalyticalfileName;

                string format = "Mddyyyyhhmmss";
                string date = DateTime.Now.ToString(format);
                string analyticalpath = fileAnalyticalName + "_" + date + "" + analyticalextension;
                Aws.Upload(analyticalpath, analyticaldata.InputStream);
                analyticalpath = "https://synzeal-quotation.s3.amazonaws.com/" + analyticalpath;
                quotationrecord.GLPAMVPath = analyticalpath;

            }

            //if (form.Get("delcoa") == "true")
            //{
            //    quotationrecord.COAPath = string.Empty;
            //}
            //if (form.Get("deldata") == "true")
            //{
            //    quotationrecord.AnalyticalData = string.Empty;
            //}
            db.Entry<SZ_QuotationDetail>(quotationrecord).State = EntityState.Modified;
            db.SaveChanges();
            return Json("Success", JsonRequestBehavior.AllowGet);
        }


        [HttpPost]
        public ActionResult UploadDocumentQuotedetails(FormCollection form)
        {
            int id = Convert.ToInt32(Request.Form.Get("Id"));
            string attacheddata = Request.Form.Get("attachedData");
            var quotationrecord = _operationRepository.GetQuoteDetailByID(id);
            quotationrecord.AttachedDataList = attacheddata;
            var file = Request.Files["coadocument"];
            if (file != null)
            {
                var fileName = Path.GetFileNameWithoutExtension(file.FileName);
                var extension = Path.GetExtension(file.FileName);
                string format = "Mddyyyyhhmmss";
                string date = DateTime.Now.ToString(format);

                string path = fileName + "_" + date + "" + extension;
                Aws.Upload(path, file.InputStream);
                path = "https://synzeal-quotation.s3.amazonaws.com/" + path;

                //var path = Path.Combine(Server.MapPath("~/Content/UploadDocument/"), newfileName);
                //file.SaveAs(path);

                //quotationrecord.COAPath = "../Content/UploadDocument/" + newfileName;
                quotationrecord.COAPath = path;
                quotationrecord.AdminScientistStatus = "COA/Data Sent";
                quotationrecord.ClientStatus = "COA/Data Sent";
                if (!quotationrecord.LastUploadDate.HasValue)
                {
                    quotationrecord.IsFirstTimeDataUpload = true;
                }
                else
                {
                    quotationrecord.IsFirstTimeDataUpload = false;
                }
                quotationrecord.LastUploadDate = DateTime.Now;
            }
            var analyticaldata = Request.Files["analyticaldata"];
            if (analyticaldata != null)
            {
                var fileAnalyticalName = Path.GetFileNameWithoutExtension(analyticaldata.FileName);
                var analyticalextension = Path.GetExtension(analyticaldata.FileName);
                string newanalyticalfileName = Guid.NewGuid().ToString() + "" + analyticalextension;
                //var analyticalpath = Path.Combine(Server.MapPath("~/Content/UploadDocument/"), newanalyticalfileName);
                //analyticaldata.SaveAs(analyticalpath);
                //quotationrecord.AnalyticalData = "../Content/UploadDocument/" + newanalyticalfileName;

                string format = "Mddyyyyhhmmss";
                string date = DateTime.Now.ToString(format);
                string analyticalpath = fileAnalyticalName + "_" + date + "" + analyticalextension;
                Aws.Upload(analyticalpath, analyticaldata.InputStream);
                analyticalpath = "https://synzeal-quotation.s3.amazonaws.com/" + analyticalpath;
                quotationrecord.AnalyticalData = analyticalpath;
                quotationrecord.AdminScientistStatus = "COA/Data Sent";
                quotationrecord.ClientStatus = "COA/Data Sent";
                if (!quotationrecord.LastUploadDate.HasValue)
                {
                    quotationrecord.IsFirstTimeDataUpload = true;
                }
                else
                {
                    quotationrecord.IsFirstTimeDataUpload = false;
                }
                quotationrecord.LastUploadDate = DateTime.Now;
            }

            if (form.Get("delcoa") == "true")
            {
                quotationrecord.COAPath = string.Empty;
            }
            if (form.Get("deldata") == "true")
            {
                quotationrecord.AnalyticalData = string.Empty;
            }
            db.Entry<SZ_QuotationDetail>(quotationrecord).State = EntityState.Modified;
            db.SaveChanges();
            return Json("Success", JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public ActionResult UploadInvoiceDocument(FormCollection form)
        {
            int id = Convert.ToInt32(Request.Form.Get("Id"));
            int CompanyId = Convert.ToInt32(Request.Form.Get("CompanyId"));
            string invoiceno = Convert.ToString(Request.Form.Get("InvoiceNo"));
            var invoicedata = db.SZ_InvoiceDocument.Where(x => x.Id == id).FirstOrDefault();
            if (Request.Files != null && Request.Files.Count > 0)
            {
                foreach (string fileNames in Request.Files)
                {
                    HttpPostedFileBase file = Request.Files[fileNames];
                    var extension = Path.GetExtension(file.FileName);
                    //string newfileName = Guid.NewGuid().ToString() + "" + extension;
                    //var path = Path.Combine(Server.MapPath("~/Content/UploadDocument/"), newfileName);
                    //file.SaveAs(path);

                    string format = "Mddyyyyhhmmss";
                    string date = DateTime.Now.ToString(format);
                    string path = file.FileName + "_" + date + "" + extension;
                    Aws.Upload(path, file.InputStream);
                    path = "https://synzeal-quotation.s3.amazonaws.com/" + path;
                    var obj = new SZ_InvoiceDocument();
                    obj.CompanyId = CompanyId;
                    //obj.Path = "../Content/UploadDocument/" + newfileName;
                    obj.Path = path;
                    obj.CreatedDate = DateTime.Now;
                    obj.InvoiceId = db.SZ_InvoiceData.Where(x => x.InvoiceNo == invoiceno).Select(x => x.Id).FirstOrDefault();
                    obj.InvoiceNo = invoiceno;
                    obj.CreatedBy = SessionCookieManagement.UserName;
                    db.Entry<SZ_InvoiceDocument>(obj).State = EntityState.Added;
                    db.SaveChanges();
                }
            }

            return Json("Success", JsonRequestBehavior.AllowGet);
        }

        public ActionResult ClientAdmin(int id)
        {
            if (!SessionCookieManagement.IsAdmin)
            {
                return RedirectToAction("Index", "Home");
            }
            ViewBag.CompanyId = id;
            return View();
        }

        public ActionResult Client()
        {
            if (!SessionCookieManagement.IsClient)
            {
                return RedirectToAction("Index", "Home");
            }
            if (string.IsNullOrEmpty(SessionCookieManagement.LoginCompanyName))
            {
                return RedirectToAction("Index", "Home");
            }

            string logCompName = Request.Cookies["LoginCompanyName"].Value;
            var id = db.SZ_CompanyList.Where(x => x.Name.ToLower() == logCompName).Select(x => x.Id).FirstOrDefault();
            ViewBag.CompanyId = id;
            return View();
        }

        public ActionResult RecentProductSubmit()
        {
            if (!SessionCookieManagement.IsAdmin)
            {
                return RedirectToAction("Index", "Home");
            }
            return View();
        }

        public ActionResult ShortQtyData()
        {
            if (!SessionCookieManagement.IsAdmin)
            {
                return RedirectToAction("Index", "Home");
            }
            return View();
        }

        [HttpPost]
        public ActionResult LoadRecentProductData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();

                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;

                var list = (from p in db.Products
                            join si in db.SZ_Inventory on p.Id equals si.ProductId
                            where p.Published == true && p.Deleted == false
                            orderby si.CreatedDate descending
                            select new
                            {
                                product = p,
                                createdDate = si.CreatedDate
                            }).Distinct().ToList();

                if (!string.IsNullOrEmpty(searchValue) && searchValue.ToLower().StartsWith("last week"))
                {
                    int weekNo = Convert.ToInt32(searchValue.ToLower().Replace("last week ", ""));
                    int days = 7 * weekNo;
                    DateTime startdate = DateTime.Now.AddDays(-days);
                    DateTime endDate = DateTime.Now;

                    list = (from i in list
                            where i.createdDate.Date <= endDate.Date && i.createdDate.Date >= startdate.Date
                            select i).ToList();
                }

                var inventoryList = db.SZ_Inventory.ToList();
                var quotationDetailsForm = db.SZ_QuoteDetailForm.ToList();
                var quotationDetail = db.SZ_QuotationDetail.ToList();

                var model = new List<ProjectListModel>();
                int count = 1;

                list.ForEach(k =>
                {
                    ProjectListModel subList = new ProjectListModel();

                    subList.CreatedDate = k.createdDate;
                    subList.ProductId = k.product.Id;
                    subList.ProductName = k.product.Name;
                    subList.CASNo = k.product.ManufacturerPartNumber;
                    subList.CATNo = k.product.Sku;

                    subList.ScientistName = "<span id='scname_" + k.product.Id + "'></span>";
                    subList.MoveProjectDateText = "<span id='dtsubmisstion_" + k.product.Id + "'></span>";
                    subList.RequiredQty = "<span id='reqqty_" + k.product.Id + "'></span>";
                    subList.AdditionalBatchNoText = "<select id='additionalBatch_" + k.product.Id + "' class='addbatch'><option value=''>--Select--</option>";
                    int additionalselectedbatchno = 0;
                    var proBatchData = inventoryList.Where(x => x.ProductId == subList.ProductId).OrderBy(x => x.Id).ToList();
                    if (proBatchData.Count > 0)
                    {
                        int probatchcount = 1;
                        foreach (var r in proBatchData)
                        {
                            string qty = CommonOperation.SettleQtyForSPMS(r);
                            string text = r.BatchNo + " (" + qty + ")";
                            if (r.IsApproved == false)
                            {
                                text = "*" + text;
                            }
                            string selected = string.Empty;
                            if (probatchcount == proBatchData.Count())
                            {
                                selected = "selected ";
                                subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";


                                var datass = quotationDetailsForm.Where(x => x.BatchCode == r.BatchNo).Select(x => new
                                {
                                    ID = x.Id,
                                    CreatedDate = x.CreatedDate,
                                    ScientistName = x.ScientistName,
                                    ProductId = x.SZ_QuotationDetail.ProductId,
                                    ReqQty = x.SZ_QuotationDetail.RequiredQty
                                }).OrderByDescending(x => x.CreatedDate).FirstOrDefault();

                                if (datass != null)
                                {
                                    subList.ScientistName = "<span id='scname_" + k.product.Id + "'>" + datass.ScientistName + "</span>";
                                    subList.MoveProjectDateText = "<span id='dtsubmisstion_" + k.product.Id + "'>" + datass.CreatedDate.ToShortDateString() + "</span>";
                                    subList.RequiredQty = "<span id='reqqty_" + k.product.Id + "'>" + datass.ReqQty + "</span>";
                                }
                                else
                                {
                                    selected = "";
                                }
                            }
                            subList.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' " + selected + " data-value='" + r.BatchNo + "'>" + text + "</option>";
                            probatchcount += 1;
                        }
                    }
                    subList.AdditionalBatchNoText += "</select>";
                    subList.SrPo = count;


                    var quotedata = quotationDetail.Where(x => x.ProductId == subList.ProductId && x.MoveToProject == true && string.IsNullOrEmpty(subList.TrackingNo)).FirstOrDefault();
                    if (quotedata != null)
                    {
                        subList.MoveToInvoice = true;
                    }

                    count += 1;
                    model.Add(subList);
                });

                model = model.OrderByDescending(x => x.CreatedDate).ToList();

                //Search
                if (!string.IsNullOrEmpty(searchValue) && !searchValue.ToLower().StartsWith("last week"))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.SelectedScientistName != null && m.SelectedScientistName.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.RequiredQty != null && m.RequiredQty.ToLower().Contains(searchValue))
                                        || (m.SelectedAdditionalBatchNo != null && m.SelectedAdditionalBatchNo.ToLower().Contains(searchValue))
                                        || (m.EstimateCompleteDateText != null && m.EstimateCompleteDateText.ToString().ToLower().Contains(searchValue))
                                        || (m.AdminScientistStatus != null && m.AdminScientistStatus.ToLower().Contains(searchValue))
                                        || (m.ProjectStatustext != null && m.ProjectStatustext.ToLower().Contains(searchValue))).ToList();
                }

                //total number of rows count   
                recordsTotal = model.Count();
                //Paging   
                var data = model.Skip(skip).Take(pageSize).ToList();

                //var finalData = PrepareQuotationListModel(data);
                //Returning Json Data  
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                throw ex;
            }

        }

        [HttpPost]
        public ActionResult LoadShortqtyData()
        {
            try
            {
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                var length = Request.Form.GetValues("length").FirstOrDefault();
                //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
                //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();

                //Paging Size (10,20,50,100)
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int recordsTotal = 0;

                var list = (from p in db.Products
                            join si in db.SZ_Inventory on p.Id equals si.ProductId
                            //  where p.Published == true && p.Deleted == false
                            orderby si.CreatedDate descending
                            group si by new { p, si.CreatedDate, si.Qty } into g
                            select new
                            {
                                product = g.Key.p,
                                CreatedDate = g.Key.CreatedDate,
                                Amount = g.Sum(t3 => t3.Qty)
                            })
                            .Where(x => x.Amount < 100)
                            .ToList();

                var model = new List<ProjectListModel>();
                int count = 1;
                var proids = list.Select(x => x.product.Id).ToList();
                var inventorydata = db.SZ_Inventory.Where(x => proids.Contains(x.ProductId)).ToList();
                var quoteformdata = db.SZ_QuoteDetailForm.ToList();
                var quotedetailsData = db.SZ_QuotationDetail.Where(x => proids.Contains(x.ProductId.Value) && x.MoveToProject == true && string.IsNullOrEmpty(x.TrackingNo)).ToList();
                foreach (var k in list)
                {
                    bool isvalidEntry = true;
                    ProjectListModel subList = new ProjectListModel();
                    subList.ChkFirstRow = "<input type='checkbox' value='" + k.product.Id + "' class='clsSaverow' />";
                    subList.CreatedDate = k.CreatedDate;
                    subList.ProductId = k.product.Id;
                    subList.ProductName = k.product.Name;
                    subList.CASNo = k.product.ManufacturerPartNumber;
                    subList.CATNo = k.product.Sku;
                    subList.ScientistName = "<span id='scname_" + k.product.Id + "'></span>";
                    subList.MoveProjectDateText = "<span id='dtsubmisstion_" + k.product.Id + "'></span>";
                    subList.RequiredQty = "<span id='reqqty_" + k.product.Id + "'></span>";
                    subList.AdditionalBatchNoText = "<select id='additionalBatch_" + k.product.Id + "' class='addbatch'><option value=''>--Select--</option>";
                    if (k.product.Sku == "SZ-A009038")
                    {
                    }
                    decimal? amountcount = 0;
                    var proBatchData = inventorydata.Where(x => x.ProductId == subList.ProductId).ToList();
                    if (proBatchData.Count > 0)
                    {
                        int probatchcount = 1;
                        foreach (var r in proBatchData)
                        {
                            string qty = CommonOperation.SettleQtyForSPMS(r);
                            string text = r.BatchNo + " (" + qty + ")";
                            if (r.IsApproved == false)
                            {
                                text = "*" + text;
                            }
                            string selected = string.Empty;
                            if (probatchcount == proBatchData.Count())
                            {
                                selected = "selected ";
                                subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + qty + ")";


                                var datass = quoteformdata.Where(x => x.BatchCode == r.BatchNo).Select(x => new
                                {
                                    ID = x.Id,
                                    CreatedDate = x.CreatedDate,
                                    ScientistName = x.ScientistName,
                                    ProductId = x.SZ_QuotationDetail.ProductId,
                                    ReqQty = x.SZ_QuotationDetail.RequiredQty
                                }).OrderByDescending(x => x.CreatedDate).FirstOrDefault();

                                if (datass != null)
                                {
                                    subList.ScientistName = "<span id='scname_" + k.product.Id + "'>" + datass.ScientistName + "</span>";
                                    subList.MoveProjectDateText = "<span id='dtsubmisstion_" + k.product.Id + "'>" + datass.CreatedDate.ToShortDateString() + "</span>";
                                    subList.RequiredQty = "<span id='reqqty_" + k.product.Id + "'>" + datass.ReqQty + "</span>";
                                }
                                else
                                {
                                    selected = "";
                                }
                            }
                            subList.AdditionalBatchNoText += "<option value='" + r.Id.ToString() + "' " + selected + " data-value='" + r.BatchNo + "'>" + text + "</option>";
                            probatchcount += 1;

                            amountcount += Convert.ToInt32(r.Qty);
                        }
                    }

                    if (amountcount > 100)
                    {
                        isvalidEntry = false;
                        continue;
                    }
                    subList.AdditionalBatchNoText += "</select>";
                    subList.SrPo = count;

                    var quotedata = quotedetailsData.Where(x => x.ProductId == subList.ProductId && x.MoveToProject == true && string.IsNullOrEmpty(subList.TrackingNo)).FirstOrDefault();
                    if (quotedata != null)
                    {
                        subList.MoveToInvoice = true;
                    }
                    if (isvalidEntry)
                    {
                        count += 1;
                        model.Add(subList);
                    }
                }

                model = model.OrderByDescending(x => x.CreatedDate).ToList();

                //Search
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = searchValue.ToLower().Trim();
                    model = model.Where(m => (m.SelectedScientistName != null && m.SelectedScientistName.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.RequiredQty != null && m.RequiredQty.ToLower().Contains(searchValue))
                                        || (m.SelectedAdditionalBatchNo != null && m.SelectedAdditionalBatchNo.ToLower().Contains(searchValue))
                                        || (m.EstimateCompleteDateText != null && m.EstimateCompleteDateText.ToString().ToLower().Contains(searchValue))
                                        || (m.AdminScientistStatus != null && m.AdminScientistStatus.ToLower().Contains(searchValue))
                                        || (m.ProjectStatustext != null && m.ProjectStatustext.ToLower().Contains(searchValue))).ToList();
                }

                //total number of rows count   
                recordsTotal = model.Count();
                //Paging   
                var data = model.Skip(skip).Take(pageSize).ToList();

                //var finalData = PrepareQuotationListModel(data);
                //Returning Json Data  
                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });
            }
            catch (Exception ex)
            {
                throw ex;
            }

        }

        [HttpGet]
        public ActionResult GetInfoByBatchNo(string batchno)
        {
            var data = db.SZ_QuoteDetailForm.Where(x => x.BatchCode == batchno).Select(x => new
            {
                ID = x.Id,
                CreatedDate = x.CreatedDate,
                ScientistName = x.ScientistName,
                ProductId = x.SZ_QuotationDetail.ProductId,
                ReqQty = x.SZ_QuotationDetail.RequiredQty
            }).OrderByDescending(x => x.CreatedDate).FirstOrDefault();

            if (data == null)
                return Json(new SZ_QuoteDetailForm(), JsonRequestBehavior.AllowGet);

            return Json(data, JsonRequestBehavior.AllowGet);
        }

        [HttpGet]
        public ActionResult GetChildCOAByBatchId(int batchId)
        {
            var masterCOA = db.SZ_MasterCOA.Where(x => x.BatchId == batchId).FirstOrDefault();
            if (masterCOA != null)
            {
                var childCOA = db.SZ_ChildCOA.Where(x => x.MasterCOAID == masterCOA.Id).OrderBy(x => x.Id).ToList();
                if (childCOA != null && childCOA.Count > 0)
                {
                    return Json(childCOA, JsonRequestBehavior.AllowGet);
                }
            }
            return Json(null, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult MovetoQuotationGenerate(List<int> id)
        {
            try
            {
                int refNo = 1;
                string value = string.Empty;
                string matchingstring = "SZ-" + DateTime.Now.ToString("ddMMyy") + "-";
                var SZ_Quotationdata = (from i in db.SZ_Quotation
                                        where i.Ref.StartsWith(matchingstring)
                                        select i).ToList();
                if (SZ_Quotationdata.Count > 0)
                {
                    refNo = SZ_Quotationdata.Select(x => ExtractQuoreRefNumber(x.Ref)).Max(w => w);
                    int newbrokerrewf = Convert.ToInt32(refNo) + 1;

                    value = "SZ-" + DateTime.Now.ToString("ddMMyy") + "-" + newbrokerrewf.ToString().PadLeft(2, '0');
                }
                else
                {
                    value = "SZ-" + DateTime.Now.ToString("ddMMyy") + "-01";
                }
                // string value = "SZ-" + DateTime.Now.ToString("HHmm") + "-" + DateTime.Now.ToString("yy") + "-" + DateTime.Now.ToString("ddMM");


                SZ_Quotation objquote = new SZ_Quotation();
                objquote.Ref = value;
                objquote.CompanyId = db.SZ_CompanyList.Where(x => x.Name.ToLower().Contains("synzeal")).Select(x => x.Id).FirstOrDefault();
                objquote.CompanyName = db.SZ_CompanyList.Where(x => x.Name.ToLower().Contains("synzeal")).Select(x => x.Name).FirstOrDefault();
                objquote.EmailAddress = "standards@synzeal.com";
                objquote.IsImageAttach = true;
                objquote.PONo = "";
                objquote.Remark = "";
                objquote.TermsId = null;
                objquote.CountryType = "";

                objquote.CreatedDate = DateTime.Now;
                //TODO: Stoped PO Update Date
                //if (!string.IsNullOrEmpty(objquote.PONo))
                //{
                //    objquote.PODate = DateTime.Now;
                //}
                objquote.CreatedBy = SessionCookieManagement.UserName;

                if (objquote.CountryType == "Export")
                {
                    objquote.IsAnalyticalData = true;
                    objquote.CountryTypeId = 2;
                    objquote.CountryType = "Export";
                }
                else
                {
                    objquote.CountryTypeId = 1;
                    objquote.CountryType = "Domestic";
                }
                db.SZ_Quotation.Add(objquote);
                db.SaveChanges();

                int QuoteId = objquote.Id;

                var productData = db.Products.Where(x => id.Contains(x.Id)).ToList();

                int displayOrder = 0;
                foreach (var i in productData)
                {
                    SZ_QuotationDetail objdetails = new SZ_QuotationDetail();
                    objdetails.IsUploadServer = true;
                    objdetails.CASNo = i.ManufacturerPartNumber;
                    objdetails.CATNo = i.Sku;
                    objdetails.CreatedDate = DateTime.Now;
                    objdetails.ImagePath = string.Empty;
                    objdetails.LeadTime = string.Empty;
                    objdetails.Price = string.Empty;
                    objdetails.ProductId = i.Id;
                    objdetails.ProductName = i.Name;
                    objdetails.QuoteId = objquote.Id;
                    objdetails.DisplayOrder = displayOrder;
                    objdetails.ProductRemark = string.Empty;
                    objdetails.ProcessState = (int)EnumList.ProcessState.MoveToProject;
                    objdetails.ProjectStatus = (int)EnumList.ProjectStatus.NoAction;
                    objdetails.MoveProjectDate = DateTime.Now;
                    objdetails.MoveToProject = true;
                    objdetails.ProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
                    objdetails.SrPo = (displayOrder + 1);
                    db.SZ_QuotationDetail.Add(objdetails);
                    db.SaveChanges();
                    displayOrder += 1;
                }
                return Json(new
                {
                    success = true,
                    message = "Quotation generated successfully.Please check Project > Inhouse section."
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = ex.Message
                }, JsonRequestBehavior.AllowGet);
            }
        }


        public ActionResult QuickAdd()
        {
            var listProjectTypeItems = new List<SelectListItem>();

            if (!SessionCookieManagement.IsDispatch && !SessionCookieManagement.IsScientist && !SessionCookieManagement.IsSubScientist)
            {
                listProjectTypeItems.Add(new SelectListItem
                {
                    Text = "--Select--",
                    Value = ""
                });
            }
            foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
            {
                var item = Enum.GetName(typeof(EnumList.ProjectType), r);
                var test = r.ToString();
                string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
                int val = (int)r;
                if (SessionCookieManagement.IsScientist && !SessionCookieManagement.IsSubScientist)
                {
                    if (text == "In-House")
                    {
                        listProjectTypeItems.Add(new SelectListItem
                        {
                            Text = text,
                            Value = val.ToString(),
                            Selected = true
                        });
                    }
                }
                else
                {
                    if (text == "Purchase" || text == "In-House")
                    {
                        listProjectTypeItems.Add(new SelectListItem
                        {
                            Text = text,
                            Value = val.ToString()
                        });
                    }
                }
            }
            ViewBag.listProjectTypeItems = listProjectTypeItems;
            return View();
        }

        [HttpGet]
        public ActionResult addTempQuick(string search)
        {
            try
            {
                search = search.Trim();
                var product = db.Products.Where(x => x.Sku.Contains(search) && x.Deleted == false && x.Published == true).FirstOrDefault();
                if (product != null)
                {
                    SZ_TempQuickAdd objmodel = new SZ_TempQuickAdd();
                    objmodel.CatNo = product.Sku;
                    objmodel.CasNo = product.ManufacturerPartNumber;
                    objmodel.CreatedDate = DateTime.Now;
                    objmodel.ProductId = product.Id;
                    objmodel.ProductName = product.Name;
                    objmodel.Qty = "0";
                    db.SZ_TempQuickAdd.Add(objmodel);
                    db.SaveChanges();

                    return Json(new
                    {
                        success = true,
                        data = "Product added successfully."
                    }, JsonRequestBehavior.AllowGet);
                }
                else
                {
                    return Json(new
                    {
                        success = false,
                        data = "Product not found"
                    }, JsonRequestBehavior.AllowGet);
                }

            }
            catch (Exception ex)
            {

                return Json(new
                {
                    success = false,
                    data = ex.Message
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpGet]
        public ActionResult GetTempQuickData()
        {
            var listItems = new List<SelectListItem>();
            var scienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("scientist")).ToList();
            MemoryCacheManager objCache = new MemoryCacheManager();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });
            if (SessionCookieManagement.IsScientist && !SessionCookieManagement.IsSubScientist)
            {
                foreach (var term in scienList)
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    if (customerName == SessionCookieManagement.UserName)
                    {
                        listItems.Add(new SelectListItem
                        {
                            Text = customerName,
                            Value = term.Id.ToString()
                        });
                    }
                }
            }
            else
            {
                listItems.Add(new SelectListItem
                {
                    Text = "--Select--",
                    Value = ""
                });
                foreach (var term in scienList)
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    listItems.Add(new SelectListItem
                    {
                        Text = customerName,
                        Value = term.Id.ToString()
                    });
                }
            }
            ViewBag.listScientist = listItems;


            var data = db.SZ_TempQuickAdd.ToList();

            return Json(new
            {
                html = PartialViewdata(this, "_PartialTempQuickAdd", data)
            }, JsonRequestBehavior.AllowGet);
        }


        [HttpPost]
        public ActionResult SaveQuickAddDataQuotation(FormCollection form)
        {
            var projType = Convert.ToInt32(form.Get("listProjectTypeItems"));
            int refNo = 1;
            string value = string.Empty;
            string matchingstring = "SZ-" + DateTime.Now.ToString("ddMMyy") + "-";
            var SZ_Quotationdata = (from i in db.SZ_Quotation
                                    where i.Ref.StartsWith(matchingstring)
                                    select i).ToList();
            if (SZ_Quotationdata.Count > 0)
            {
                refNo = SZ_Quotationdata.Select(x => ExtractQuoreRefNumber(x.Ref)).Max(w => w);
                int newbrokerrewf = Convert.ToInt32(refNo) + 1;

                value = "SZ-" + DateTime.Now.ToString("ddMMyy") + "-" + newbrokerrewf.ToString().PadLeft(2, '0');
            }
            else
            {
                value = "SZ-" + DateTime.Now.ToString("ddMMyy") + "-01";
            }
            int QuoteId = 0;
            //new value 
            //value = "SZ-" + DateTime.Now.ToString("HHmm") + "-" + DateTime.Now.ToString("yy") + "-" + DateTime.Now.ToString("ddMM");

            SZ_Quotation objquote = new SZ_Quotation();
            objquote.Ref = value;
            objquote.PONo = value;
            //TODO: Stoped PO Update Date
            //objquote.PODate = DateTime.Now;
            objquote.CompanyId = db.SZ_CompanyList.Where(x => x.Name.ToLower().Contains("synzeal")).Select(x => x.Id).FirstOrDefault();
            objquote.CompanyName = db.SZ_CompanyList.Where(x => x.Name.ToLower().Contains("synzeal")).Select(x => x.Name).FirstOrDefault();
            objquote.EmailAddress = "standards@synzeal.com";
            objquote.IsImageAttach = false;
            objquote.Remark = string.Empty;
            objquote.TermsId = null;
            objquote.CountryType = string.Empty;
            objquote.IsToBe = false;
            objquote.CreatedDate = DateTime.Now;
            objquote.CreatedBy = SessionCookieManagement.UserName;

            if (objquote.CountryType == "Export")
            {
                objquote.IsAnalyticalData = true;
                objquote.CountryType = "Export";
                objquote.CountryTypeId = 2;
            }
            else
            {
                objquote.CountryType = "Domestic";
                objquote.CountryTypeId = 1;
            }
            db.SZ_Quotation.Add(objquote);
            db.SaveChanges();

            QuoteId = objquote.Id;

            int displayOrder = 0;
            var productData = db.SZ_TempQuickAdd.ToList();
            foreach (var i in productData)
            {
                SZ_QuotationDetail objdetails = new SZ_QuotationDetail();
                objdetails.IsUploadServer = true;
                objdetails.CASNo = i.CasNo;
                objdetails.CATNo = i.CatNo;
                objdetails.CreatedDate = DateTime.Now;
                objdetails.ProductId = i.ProductId;
                objdetails.ProductName = i.ProductName;
                objdetails.QuoteId = objquote.Id;
                objdetails.DisplayOrder = displayOrder;
                objdetails.ScientistCustomerId = Convert.ToInt32(form.Get("scientistid_" + i.Id));
                objdetails.RequiredQty = Convert.ToString(form.Get("qty_" + i.Id));
                objdetails.ProjectType = Convert.ToString(projType);
                if (projType == (int)EnumList.ProjectType.Purchase || projType == (int)EnumList.ProjectType.PurSynthesis)
                {
                    objdetails.ProjectStatus = (int)EnumList.ProjectStatus.MoveToPurchase;
                    //objdetails.ProcessState = (int)EnumList.ProcessState.MoveToPurchase;
                    objdetails.PurchaseDate = DateTime.Now;

                    if (objdetails.ProcessState <= (int)EnumList.ProcessState.MoveToPurchase)
                    {
                        objdetails.ProcessState = (int)EnumList.ProcessState.MoveToPurchase;
                    }
                }
                else
                {
                    objdetails.ProcessState = (int)EnumList.ProcessState.MoveToProject;
                    objdetails.ProjectStatus = (int)EnumList.ProjectStatus.NoAction;
                }
                var quotedetailsPO = db.SZ_QuotationDetail.Where(x => x.QuoteId == objdetails.QuoteId).Max(x => x.SrPo);
                int srPo = 0;
                if (quotedetailsPO != null && quotedetailsPO != 0 && quotedetailsPO.HasValue)
                {
                    srPo = quotedetailsPO.Value + 1;
                }
                else
                {
                    srPo = 1;
                }
                objdetails.SrPo = srPo;
                objdetails.MoveToProject = true;
                objdetails.MoveProjectDate = DateTime.Now;
                objdetails.EstimateCompleteDate = DateTime.Now;

                db.SZ_QuotationDetail.Add(objdetails);
                db.SaveChanges();
                displayOrder += 1;
            }

            foreach (var k in productData)
            {
                db.Entry(k).State = EntityState.Deleted;
                db.SaveChanges();
            }

            return Json(new
            {
                success = true,
                data = ""
            }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult Followup()
        {
            if (!SessionCookieManagement.IsFollowUp)
            {
                return RedirectToAction("Index", "Home");
            }
            return View();
        }


        [HttpPost]
        public ActionResult UploadFiles()
        {
            // Checking no of files injected in Request object  
            if (Request.Files.Count > 0)
            {
                try
                {
                    //  Get all files from Request object  
                    string uploadfilename = string.Empty;
                    HttpFileCollectionBase files = Request.Files;
                    for (int i = 0; i < files.Count; i++)
                    {
                        //string path = AppDomain.CurrentDomain.BaseDirectory + "Uploads/";  
                        //string filename = Path.GetFileName(Request.Files[i].FileName);  

                        HttpPostedFileBase file = files[i];
                        string fname;

                        // Checking for Internet Explorer  
                        if (Request.Browser.Browser.ToUpper() == "IE" || Request.Browser.Browser.ToUpper() == "INTERNETEXPLORER")
                        {
                            string[] testfiles = file.FileName.Split(new char[] { '\\' });
                            fname = testfiles[testfiles.Length - 1];
                        }
                        else
                        {
                            fname = file.FileName;
                        }

                        string extension = Path.GetExtension(fname);
                        uploadfilename = filenameDateWise(Guid.NewGuid().ToString()) + "" + extension;
                        fname = Path.Combine(Server.MapPath("~/Content/Attachment/"), uploadfilename);
                        file.SaveAs(fname);

                        var filename = Path.GetFileNameWithoutExtension(uploadfilename);
                        var fileextension = Path.GetExtension(uploadfilename);
                        var isUploadDone = Aws.UploadFile(fname, uploadfilename);
                        if (isUploadDone)
                        {
                            uploadfilename = "https://synzeal-quotation.s3.amazonaws.com/" + uploadfilename;
                        }
                    }
                    // Returns message that successfully uploaded  
                    return Json(uploadfilename, JsonRequestBehavior.AllowGet);
                }
                catch (Exception ex)
                {
                    return Json("Error occurred. Error details: " + ex.Message, JsonRequestBehavior.AllowGet);
                }
            }
            else
            {
                return Json("No files selected.", JsonRequestBehavior.AllowGet);
            }
        }

        [HttpGet]
        public ActionResult ChangePaymentStatus(int id, bool status)
        {
            var data = _operationRepository.GetQuoteDetailByID(id);
            if (data != null)
            {
                var quotedata = _operationRepository.GetQuoteByID(data.QuoteId);
                if (quotedata != null)
                {
                    quotedata.IsPayment = status;
                    db.Entry(quotedata).State = EntityState.Modified;
                    db.SaveChanges();
                }
            }
            return Json("Done", JsonRequestBehavior.AllowGet);
        }

        public ActionResult AttachmentRecord(int id)
        {
            var data = _operationRepository.GetQuoteByID(id);
            if (data != null)
            {
                ViewBag.Attachment = data.Attachment;
                ViewBag.SuggChemName = data.SuggChemName;
            }
            return PartialView();
        }

        public ActionResult SendDailyPurchaseEmail()
        {
            try
            {
                string purchaseType = Convert.ToString((int)EnumList.ProjectType.Purchase);
                string purSynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
                var ReadyToDeliverScientistStatusId = db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();

                var model = (from i in db.SZ_Quotation
                             join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                             where (string.IsNullOrEmpty(t2.TrackingNo)
                             && (t2.ProjectType == purchaseType || t2.ProjectType == purSynthesisProjectType)
                             && (t2.IsOnHold == false || t2.IsOnHold == null))
                             || t2.IsPurchase == true
                             orderby t2.PurchaseDate descending
                             select t2).Distinct().AsQueryable();

                var passmodel = model.Where(x => (x.IsSynthesisLog == null || x.IsSynthesisLog == false)
                            && ReadyToDeliverScientistStatusId != x.ScientistStatus).OrderByDescending(x => x.PurchaseDate).ToList();

                if (passmodel != null && passmodel.Count > 0)
                {
                    passmodel = passmodel.Where(x => !string.IsNullOrEmpty(x.PurchaseStatus) && x.PurchaseDDLStatus == "20" || x.PurchaseDDLStatus == null || x.PurchaseDDLStatus == "").OrderByDescending(x => x.PurchaseDate).ToList();
                }
                try
                {
                    var htmlstring = PartialViewdata(this, "_PartialDailyUpdatePurchaseEmail", passmodel);
                    MailMessage mail = new MailMessage();
                    ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12 |
                                       SecurityProtocolType.Tls11 |
                                       SecurityProtocolType.Tls |
                                       SecurityProtocolType.Ssl3;
                    SmtpClient SmtpServer = new SmtpClient(ConfigurationManager.AppSettings["Email.Host"]);
                    mail.From = new MailAddress(ConfigurationManager.AppSettings["Email.Username"], "SynZeal Standards");

                    var isDevelopment = ConfigurationManager.AppSettings["IsDevelopment"];
                    if (isDevelopment.ToLower().Contains("true"))
                    {
                        mail.To.Add(ConfigurationManager.AppSettings["DevEmailAddress"].ToString());
                    }
                    else
                    {
                        mail.To.Add("standards@synzeal.com");
                        mail.To.Add("scm@synzeal.com");
                        mail.CC.Add("purchase@synzeal.com");
                        mail.ReplyToList.Add("scm@synzeal.com");
                    }

                    mail.Subject = "SynZeal Research : SPMS Update as on " + DateTime.Now.ToShortDateString() + "," + DateTime.Now.ToShortTimeString();

                    mail.Body = htmlstring;
                    mail.IsBodyHtml = true;

                    SmtpServer.Port = Convert.ToInt32(ConfigurationManager.AppSettings["Port"]);
                    SmtpServer.Credentials = new System.Net.NetworkCredential(ConfigurationManager.AppSettings["Email.Username"], ConfigurationManager.AppSettings["Email.Password"]);
                    SmtpServer.EnableSsl = true;
                    SmtpServer.Send(mail);
                }
                catch (Exception ex)
                {
                    sendErrorMail(ex.LineNumber() + " " + "Error Text : " + ex.Message + " / Stack Trace : " + ex.StackTrace);
                }

                return Json("success", JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json("Error Text : " + ex.Message + " / Stack Trace : " + ex.StackTrace, JsonRequestBehavior.AllowGet);
            }
        }

        public ActionResult SendDailyClientUpdateEmail()
        {
            try
            {
                var data = db.SZ_QuotationDetail.ToList();
                var finaldata = data.Where(x => (x.ResponseClientRemarkDate.HasValue ? (x.ResponseClientRemarkDate.Value.Date == DateTime.Now.Date) : false) || (x.LastUploadDate.HasValue ? x.LastUploadDate.Value.Date == DateTime.Now.Date : false && x.IsFirstTimeDataUpload == true) || (x.LastUploadDate.HasValue ? (x.LastUploadDate.Value.Date == DateTime.Now.Date) : false)).ToList();
                if (finaldata != null && finaldata.Count > 0)
                {
                    List<int> CompanyIds = new List<int>();
                    var model = new List<ProjectListModel>();
                    var proids = finaldata.Select(x => x.ProductId).ToList();
                    var productdata = db.Products.Where(x => proids.Contains(x.Id) && x.Published == true && x.Deleted == false).ToList();
                    var inventorydata = db.SZ_Inventory.Where(x => proids.Contains(x.ProductId)).ToList();

                    foreach (var i in finaldata)
                    {
                        ProjectListModel objModel = new ProjectListModel();
                        objModel.PONumber = i.SZ_Quotation.PONo;
                        objModel.ProductName = i.ProductName;
                        objModel.CASNo = i.CASNo;
                        objModel.CompanyId = i.SZ_Quotation.CompanyId;
                        objModel.CATNo = i.CATNo;
                        objModel.PODate = i.SZ_Quotation.PODate;
                        objModel.RequiredQty = i.RequiredQty;
                        objModel.EstimateCompleteDate = i.EstimateCompleteDate;
                        if (i.ProductId.HasValue)
                        {
                            var proData = productdata.Where(x => x.Id == i.ProductId && x.Published == true && x.Deleted == false).Count();
                            var proBatchData = inventorydata.Where(x => x.ProductId == i.ProductId).ToList();
                            if (proBatchData.Count > 0 && proData > 0)
                            {
                                foreach (var r in proBatchData)
                                {
                                    if (r.Id == i.AdditionalBatchNo)
                                    {
                                        objModel.SelectedAdditionalBatchNo = r.BatchNo;
                                    }
                                }
                            }
                        }

                        string status = "";
                        if (i.IsFirstTimeDataUpload.HasValue && i.IsFirstTimeDataUpload.Value)
                        {
                            status = "COA/Data Uploaded";
                        }
                        else
                        {
                            if (i.ResponseClientRemarkDate.HasValue && i.ResponseClientRemarkDate.Value.Date == DateTime.Now.Date)
                            {
                                status = "Remarks Update";
                            }
                            if (i.LastUploadDate.HasValue && i.LastUploadDate.Value.Date == DateTime.Now.Date)
                            {
                                status = "COA/Data Update";
                            }
                        }
                        objModel.LastStatus = status;
                        model.Add(objModel);

                        if (!CompanyIds.Contains(objModel.CompanyId.Value))
                        {
                            CompanyIds.Add(objModel.CompanyId.Value);
                        }
                    }

                    var compdata = db.SZ_CompanyList.Where(x => CompanyIds.Contains(x.Id)).ToList();
                    foreach (var id in CompanyIds)
                    {
                        try
                        {
                            var passmodel = model.Where(x => x.CompanyId == id).ToList();
                            var companyData = compdata.Where(x => x.Id == id).FirstOrDefault();
                            ViewBag.CompanyName = companyData.Name;

                            var masterEmail = companyData.MasterEmail;

                            var htmlstring = PartialViewdata(this, "_PartialDailyUpdateEmail", passmodel);

                            MailMessage mail = new MailMessage();
                            ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12 |
                                       SecurityProtocolType.Tls11 |
                                       SecurityProtocolType.Tls |
                                       SecurityProtocolType.Ssl3;
                            SmtpClient SmtpServer = new SmtpClient(ConfigurationManager.AppSettings["Email.Host"]);
                            mail.From = new MailAddress(ConfigurationManager.AppSettings["Email.Username"], "SynZeal Standards");

                            var isDevelopment = ConfigurationManager.AppSettings["IsDevelopment"];
                            if (isDevelopment.ToLower().Contains("true"))
                            {
                                mail.To.Add(ConfigurationManager.AppSettings["DevEmailAddress"].ToString());
                            }
                            else
                            {
                                if (!string.IsNullOrEmpty(masterEmail))
                                {
                                    string[] masterEmailStr = masterEmail.Split(';');
                                    foreach (var i in masterEmailStr)
                                    {
                                        if (!string.IsNullOrEmpty(i))
                                        {
                                            mail.To.Add(i);
                                        }
                                    }
                                }
                                //mail.To.Add("standards@synzeal.com");
                                mail.Bcc.Add("standards@synzeal.com");
                                mail.Bcc.Add("noreply.synzeal@gmail.com");
                                mail.ReplyToList.Add("standards@synzeal.com");
                            }

                            mail.Subject = "SynZeal Research : SharePoint Update as on " + DateTime.Now.ToShortDateString() + "," + DateTime.Now.ToShortTimeString();

                            mail.Body = htmlstring;
                            mail.IsBodyHtml = true;

                            SmtpServer.Port = Convert.ToInt32(ConfigurationManager.AppSettings["Port"]);
                            SmtpServer.Credentials = new System.Net.NetworkCredential(ConfigurationManager.AppSettings["Email.Username"], ConfigurationManager.AppSettings["Email.Password"]);
                            SmtpServer.EnableSsl = true;
                            SmtpServer.Send(mail);
                        }
                        catch (Exception ex)
                        {
                            sendErrorMail(ex.LineNumber() + " " + "Error Text : " + ex.Message + " / Stack Trace : " + ex.StackTrace);
                        }
                    }
                }
                return Json("success", JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json("false", JsonRequestBehavior.AllowGet);
            }
        }

        public string stringProjectStatus(int? projectStatus)
        {
            string str = "";
            foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectStatus)))
            {
                var item = Enum.GetName(typeof(EnumList.ProjectStatus), r);
                var test = r.ToString();
                string text = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)r);
                int val = (int)r;
                if (val == projectStatus)
                {
                    str = text;
                }
            }
            return str;
        }

        [HttpGet]
        public ActionResult CheckProductUsingBatchNo(int szdetailsid, int batchId)
        {
            string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);

            var prodId = db.SZ_Inventory.Where(x => x.Id == batchId).Select(x => x.ProductId).FirstOrDefault();
            if (prodId != 0)
            {
                var data = (from t2 in db.SZ_QuotationDetail
                            where t2.MoveToProject == true && string.IsNullOrEmpty(t2.TrackingNo) && (t2.IsOnHold == false || t2.IsOnHold == null)
                                  && (t2.ProjectType != inhouseProjectType || t2.ProjectType == null)
                                  && (t2.MoveToDispatch == null || t2.MoveToDispatch == false)
                                  && t2.Id != szdetailsid && t2.ProductId == prodId
                            select new QuotationListModel
                            {
                                PODate = t2.SZ_Quotation.PODate,
                                //PODateText = t2.SZ_Quotation.PODate.HasValue ? t2.SZ_Quotation.PODate.Value.ToShortDateString() : "",
                                ProjectType = t2.ProjectType,
                                PONumberText = t2.SZ_Quotation.PONo,
                                CompanyName = t2.SZ_Quotation.CompanyName,
                                ProductNameText = t2.ProductName,
                                CASNoText = t2.CASNo,
                                CATNoText = t2.CATNo,
                                RequiredQty = !string.IsNullOrEmpty(t2.RequiredQty) ? t2.RequiredQty : "",
                                ScientistCustomerId = t2.ScientistCustomerId,
                                ScientistName = "",
                                StrProjectStatus = "",
                                ProjectStatus = t2.ProjectStatus,
                                AdditionalBatchNo = t2.AdditionalBatchNo,
                                AdditionalBatchNoText = "",
                                DispatchedStatus = t2.DispatchedStatus,
                                MoveToDispatch = t2.MoveToDispatch,
                                MoveToInvoice = t2.MoveToInvoice,
                                AdminScientistStatus = !string.IsNullOrEmpty(t2.AdminScientistStatus) ? t2.AdminScientistStatus : "",
                                EstimateDispatchDate = t2.EstimateDispatchDate,
                                Reason = !string.IsNullOrEmpty(t2.Reason) ? t2.Reason : "",
                                DataRemark = !string.IsNullOrEmpty(t2.Remark) ? t2.Remark : "",
                                OrderRemark = !string.IsNullOrEmpty(t2.OrderRemark) ? t2.OrderRemark : "",
                                ActivityStatusText = t2.ActivityStatus
                            }).ToList();

                var scicustid = data.Select(x => x.ScientistCustomerId).ToList();
                var GenericAttributesData = db.GenericAttributes.Where(x => x.KeyGroup == "Customer" && scicustid.Contains(x.EntityId)).ToList();
                foreach (var item in data)
                {
                    foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
                    {
                        var items = Enum.GetName(typeof(EnumList.ProjectType), r);
                        var test = r.ToString();
                        string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
                        int val = (int)r;
                        string selected = "";
                        if (Convert.ToString(val) == item.ProjectType)
                        {
                            item.ProjectTypeText = text;
                        }
                    }

                    string customerName = "";
                    var genericAttr = GenericAttributesData.Where(x => x.KeyGroup == "Customer" && x.EntityId == item.ScientistCustomerId).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    item.ScientistName = customerName;
                    item.StrProjectStatus = stringProjectStatus(item.ProjectStatus);
                    item.EstimateDispatchDateStr = item.EstimateDispatchDate.HasValue ? item.EstimateDispatchDate.Value.ToString() : "";
                    item.AdditionalBatchNoText = db.SZ_Inventory.Where(x => x.Id == item.AdditionalBatchNo && item.AdditionalBatchNo != null).Select(x => x.BatchNo).FirstOrDefault();
                    item.AdditionalBatchNoText = !string.IsNullOrEmpty(item.AdditionalBatchNoText) ? item.AdditionalBatchNoText : "";
                    item.PODateText = item.PODate.HasValue ? item.PODate.Value.ToShortDateString() : "";
                }

                if (data.Count() > 0)
                {
                    return Json(new
                    {
                        Data = "Yes",
                        Record = data
                    }, JsonRequestBehavior.AllowGet);
                }
                else
                {
                    return Json(new
                    {
                        Data = "No"
                    }, JsonRequestBehavior.AllowGet);
                }
            }
            else
            {
                return Json(new
                {
                    Data = "No"
                }, JsonRequestBehavior.AllowGet);
            }
        }

        public ActionResult GetQuoteDetailsId(int id, int formid = 0, bool newprodumastr = false)
        {
            var data = db.SZ_QuotationDetail.Where(x => x.ProductId == id).FirstOrDefault();
            if (data == null)
            {
                return RedirectToAction("ProductMaster");
            }
            return RedirectToAction("SubmitForm", new { id = data.Id, formid = formid, isprint = false, isdispatch = false, isnewform = false, newprodumastr = newprodumastr });
        }

        [HttpGet]
        public ActionResult GetBatch(int productId)
        {
            var inventoryData = (from i in db.SZ_Inventory
                                 join f in db.SZ_QuoteDetailForm on i.BatchNo equals f.BatchCode
                                 into ps
                                 from p in ps.DefaultIfEmpty()
                                 where i.ProductId == productId
                                 select new
                                 {
                                     BatchNo = i.BatchNo,
                                     BatchId = i.Id,
                                     QuoteDetailsId = p != null ? p.QuotationDetailsId : 0,
                                     FormId = p != null ? p.Id : 0,
                                     ProductId = productId,
                                 }).ToList();
            if (inventoryData.Count != 0)
            {

                return Json(new
                {
                    Data = "Yes",
                    Record = inventoryData
                }, JsonRequestBehavior.AllowGet);
            }
            else
            {
                return Json(new
                {
                    Data = "No"
                }, JsonRequestBehavior.AllowGet);
            }
        }

        public ActionResult SynthesisLog()
        {
            if (!SessionCookieManagement.IsAdmin)
            {
                return RedirectToAction("Index", "Home");
            }
            return View();
        }

        public ActionResult ExportAllProductdata()
        {
            var result = (from i in db.SZ_Quotation
                          select i).ToList();

            var szInventory = (from i in db.SZ_Inventory
                               select i).ToList();

            var categorylist = (from i in db.Categories
                                where i.ParentCategoryId == 0 && i.Deleted == false && i.Published == true
                                select i).ToList();

            ExcelPackage ExcelPkg = new ExcelPackage();
            ExcelWorksheet wsSheet1 = ExcelPkg.Workbook.Worksheets.Add("Sheet1");
            wsSheet1.DefaultColWidth = 16;
            wsSheet1.Protection.IsProtected = false;
            wsSheet1.Protection.AllowSelectLockedCells = false;
            wsSheet1.Cells.AutoFitColumns(14, 40);
            wsSheet1.Column(3).Width = 40;
            wsSheet1.Column(3).Style.WrapText = true;

            int loopCount = 2;
            wsSheet1.Cells[loopCount, 1].Value = "Sr No";
            wsSheet1.Cells[loopCount, 2].Value = "Quotation Id";
            wsSheet1.Cells[loopCount, 3].Value = "Company Name";
            wsSheet1.Cells[loopCount, 4].Value = "Product Name";
            wsSheet1.Cells[loopCount, 5].Value = "Price";
            wsSheet1.Cells[loopCount, 6].Value = "Quotation date";
            wsSheet1.Cells[loopCount, 7].Value = "PO No";
            wsSheet1.Cells[loopCount, 8].Value = "PO Date";
            wsSheet1.Cells[loopCount, 9].Value = "Domestic/Export";
            wsSheet1.Cells[loopCount, 10].Value = "Batch Available";
            wsSheet1.Cells[loopCount, 11].Value = "API Name";
            wsSheet1.Cells[loopCount, 12].Value = "Dispatch date";
            wsSheet1.Cells[loopCount, 13].Value = "CAS No";
            wsSheet1.Cells[loopCount, 14].Value = "CAT No";
            wsSheet1.Cells[loopCount, 15].Value = "Qty";
            wsSheet1.Cells[loopCount, 16].Value = "Move to Project";
            using (ExcelRange Rng = wsSheet1.Cells[loopCount, 1, loopCount, 16])
            {
                Rng.Style.Font.Bold = true;
                Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#7b7b7b");
                Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                Rng.Style.Font.Color.SetColor(Color.White);
                Rng.Style.WrapText = true;
            }

            loopCount = loopCount + 1;
            int srno = 1;
            foreach (var quote in result)
            {
                foreach (var item in quote.SZ_QuotationDetail.ToList())
                {
                    wsSheet1.Cells[loopCount, 1].Value = srno;
                    wsSheet1.Cells[loopCount, 2].Value = quote.Ref;
                    wsSheet1.Cells[loopCount, 3].Value = quote.CompanyName;
                    wsSheet1.Cells[loopCount, 4].Value = item.ProductName;
                    wsSheet1.Cells[loopCount, 5].Value = item.Price;
                    wsSheet1.Cells[loopCount, 6].Value = quote.CreatedDate.HasValue ? quote.CreatedDate.Value.ToShortDateString() : "";
                    wsSheet1.Cells[loopCount, 7].Value = quote.PONo;
                    wsSheet1.Cells[loopCount, 8].Value = quote.PODate;
                    wsSheet1.Cells[loopCount, 9].Value = quote.CountryType;
                    wsSheet1.Cells[loopCount, 10].Value = string.Join(", ", szInventory.Where(x => x.ProductId == item.ProductId).Select(x => x.BatchNo).ToList());
                    wsSheet1.Cells[loopCount, 11].Value = item.ProductId.HasValue ? GetProductParentCategoryName(item.ProductId.Value) : "";
                    wsSheet1.Cells[loopCount, 12].Value = item.EstimateCompleteDate.HasValue ? item.EstimateCompleteDate.Value.ToShortDateString() : "";
                    wsSheet1.Cells[loopCount, 13].Value = item.CASNo;
                    wsSheet1.Cells[loopCount, 14].Value = item.CATNo;
                    wsSheet1.Cells[loopCount, 15].Value = item.RequiredQty;
                    wsSheet1.Cells[loopCount, 16].Value = item.MoveToProject.HasValue ? item.MoveToProject.Value : false;
                    srno += 1;
                    loopCount += 1;
                }
            }
            string filePath = HostingEnvironment.MapPath("~/Content/Quotation/") + "AllReport-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xlsx";
            ExcelPkg.SaveAs(new FileInfo(filePath));
            return File(filePath, "application/excel", Server.UrlEncode("AllReport-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xls"));
        }

        public ActionResult ExportFromSynthesisLog()
        {
            MemoryCacheManager objCache = new MemoryCacheManager();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });
            //var categoryData = db.Categories.ToList();
            //var productCategoryData = db.Product_Category_Mapping.ToList();
            var productsData = objCache.Get("cache.productsdata", () =>
            {
                return db.Products.Where(x => x.Published == true && x.Deleted == false).ToList();
            });
            var model = db.SynthesisLog("", 1, Int32.MaxValue).ToList();
            int? recordsTotal = 0;
            if (model != null)
            {
                recordsTotal = model.Select(x => x.TotalRecord).FirstOrDefault();
            }
            var szInventory = db.SZ_Inventory.ToList();
            ExcelPackage ExcelPkg = new ExcelPackage();
            ExcelWorksheet wsSheet1 = ExcelPkg.Workbook.Worksheets.Add("Sheet1");
            wsSheet1.DefaultColWidth = 16;
            wsSheet1.Protection.IsProtected = false;
            wsSheet1.Protection.AllowSelectLockedCells = false;
            wsSheet1.Cells.AutoFitColumns(14, 40);
            wsSheet1.Column(3).Width = 40;
            wsSheet1.Column(3).Style.WrapText = true;

            int loopCount = 2;
            wsSheet1.Cells[loopCount, 1].Value = "Sr No";
            wsSheet1.Cells[loopCount, 2].Value = "Product Name";
            wsSheet1.Cells[loopCount, 3].Value = "CAS No";
            wsSheet1.Cells[loopCount, 4].Value = "CAT No";
            wsSheet1.Cells[loopCount, 5].Value = "Batch No";
            wsSheet1.Cells[loopCount, 6].Value = "Submitted Name";
            wsSheet1.Cells[loopCount, 7].Value = "API Name";
            using (ExcelRange Rng = wsSheet1.Cells[loopCount, 1, loopCount, 16])
            {
                Rng.Style.Font.Bold = true;
                Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#7b7b7b");
                Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                Rng.Style.Font.Color.SetColor(Color.White);
                Rng.Style.WrapText = true;
            }
            loopCount = loopCount + 1;
            int srno = 1;
            foreach (var quote in model)
            {
                var submitedbyname = db.SZ_QuoteDetailForm.Where(x => x.ProductName == quote.ProductName).Select(x => x.SubmittedBy).OrderByDescending(x => x).FirstOrDefault();
                var scientistCustomerId = Convert.ToInt32(submitedbyname);
                string customerName = "";
                var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == scientistCustomerId).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                wsSheet1.Cells[loopCount, 1].Value = srno;
                wsSheet1.Cells[loopCount, 2].Value = quote.ProductName;
                wsSheet1.Cells[loopCount, 3].Value = quote.CASNo;
                wsSheet1.Cells[loopCount, 4].Value = quote.CATNo;
                wsSheet1.Cells[loopCount, 5].Value = string.Join(", ", szInventory.Where(x => x.ProductId == quote.ProductId).Select(x => x.BatchNo).ToList());
                wsSheet1.Cells[loopCount, 6].Value = customerName;
                wsSheet1.Cells[loopCount, 7].Value = quote.ProductId.HasValue ? GetApiNameOfProduct(quote.ProductId.Value, productsData) : "";
                srno += 1;
                loopCount += 1;
            }
            string filePath = HostingEnvironment.MapPath("~/Content/Quotation/") + "SynthesislogReport-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xlsx";
            ExcelPkg.SaveAs(new FileInfo(filePath));
            return File(filePath, "application/excel", Server.UrlEncode("SynthesislogReport-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xls"));
        }

        public ActionResult w(string parameter, string ScientistListItem, string SubScientistListItem
            , string fltactivity, string fltprostatusItem)
        {
            string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
            string pursynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);

            List<string> orderbydetails = new List<String> {
                "Dispatching",
                "Invoiced",
                "Data Approved",
                "Client Confirmation",
                "Data Sent",
                "Data Recording",
                "RM Ordered",
                "In progress",
                "In progress - Delay",
                "Purification",
                "Prep HPLC",
                "Troubleshoot",
                "Clarification",
                "Attention",
                "Not Working",
                "On Hold" };

            var quotationDetailsdata = db.SZ_QuotationDetail.AsNoTracking().AsEnumerable();
            var list = (from i in db.SZ_Quotation.AsNoTracking()
                        join t2 in quotationDetailsdata on i.Id equals t2.QuoteId
                        where t2.MoveToProject == true
                        && string.IsNullOrEmpty(t2.TrackingNo)
                        && (t2.IsOnHold == false || t2.IsOnHold == null)
                        && (t2.ProjectType != inhouseProjectType || t2.ProjectType == null)
                        orderby t2.MoveProjectDate descending
                        select t2).Distinct();

            list = list.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo);
            var proIds = list.Select(x => x.ProductId).Distinct().ToList();
            var productsData = db.Products.Where(x => proIds.Contains(x.Id) && x.Published == true && x.Deleted == false).ToList();
            var subscilistItems = new List<SelectListItem>();
            var listItems = new List<SelectListItem>();
            MemoryCacheManager objCache = new MemoryCacheManager();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });
            var scienList = objCache.Get("cache.GetScientistId", () =>
            {
                return db.GetScientistId().ToList();
            });
            var inventorydata = db.SZ_Inventory.Where(x => proIds.Contains(x.ProductId)).ToList();
            scienList.ForEach(term =>
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                listItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.ToString()
                });
                subscilistItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.ToString()
                });
            });

            var subscienList = objCache.Get("cache.subscienList", () =>
            {
                return db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();
            });
            foreach (var term in subscienList)
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == term.Id).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }

                subscilistItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.Id.ToString()
                });

            }
            var ReadyToDeliverScientistStatusId = db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
            var model = new List<ProjectListModel>();
            foreach (var k in list)
            {
                ProjectListModel subList = new ProjectListModel();
                subList.ReadyToDeliverScientistStatusId = ReadyToDeliverScientistStatusId;
                subList.AdditionalBatchNo = k.AdditionalBatchNo;
                subList.ProjectType = k.ProjectType;
                subList.PODate = k.SZ_Quotation.PODate;
                subList.IsPaymentPending = k.SZ_Quotation.SZ_CompanyList.IsPaymentPending;
                subList.ActivityStatus = k.ActivityStatus;
                subList.ProductId = k.ProductId;
                listItems.ForEach(r =>
                {
                    if (r.Value == Convert.ToString(k.ScientistCustomerId))
                    {
                        subList.SelectedScientistName = r.Text;
                    }
                });
                if (subList.ProductId.HasValue)
                {
                    var proData = productsData.Where(x => x.Id == subList.ProductId).Count();
                    var proBatchData = inventorydata.Where(x => x.ProductId == subList.ProductId).ToList();
                    if (proBatchData.Count > 0 && proData > 0)
                    {
                        proBatchData.ForEach(r =>
                        {
                            if (r.Id == subList.AdditionalBatchNo)
                            {
                                subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + Convert.ToInt32(r.Qty) + ")";
                            }
                        });
                    }
                }
                subList.MoveProjectDateText = k.MoveProjectDate.HasValue ? k.MoveProjectDate.Value.ToString("dd/MM/yyyy hh:mm tt") : "";
                subList.AdditionalBatchNo = k.AdditionalBatchNo;
                subList.QuoteId = k.SZ_Quotation.Id;
                subList.ProductId = k.ProductId;
                subList.ProductName = k.ProductName;
                subList.ExplainationSecond = k.ExplainationSecond;
                subList.IsImageAttach = k.SZ_Quotation.IsImageAttach;
                subList.CompanyName = k.SZ_Quotation.SZ_CompanyList.Name;
                subList.Email = k.SZ_Quotation.EmailAddress;
                subList.PONumber = k.SZ_Quotation.PONo;
                subList.Ref = k.SZ_Quotation.Ref;
                subList.Remark = k.SZ_Quotation.Remark;
                subList.MoveProjectDate = k.MoveProjectDate;
                subList.QuoteDetailsId = k.Id;
                subList.CASNo = k.CASNo;
                subList.CATNo = k.CATNo;
                subList.CreatedDate = k.CreatedDate;
                subList.ImagePath = k.ImagePath;
                subList.IsUploadServer = k.IsUploadServer;
                subList.LeadTime = k.LeadTime;
                subList.Price = k.Price;
                subList.QuoteId = k.QuoteId;
                subList.ProjectType = k.ProjectType;
                subList.ScientistCustomerId = k.ScientistCustomerId;

                subList.RequiredQty = k.RequiredQty;
                subList.ProjectStatus = k.ProjectStatus;
                subList.IsOnHold = k.IsOnHold;
                if (k.ProjectStatus != null)
                {
                    subList.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
                }
                subList.ScientistStatus = k.ScientistStatus;
                subList.BatchCode1 = k.BatchCode1;
                subList.BatchCode2 = k.BatchCode2;
                subList.Qty1 = k.Qty1;
                subList.Qty2 = k.Qty2;
                subList.EstimateCompleteDate = k.EstimateCompleteDate;
                subList.PreviousEstCompleteDate = k.PreviousEstCompleteDate;
                subList.MoveToDispatch = k.MoveToDispatch;
                subList.MoveToProject = k.MoveToProject;
                subList.Remark = k.Remark;
                subList.SrPo = k.SrPo;
                subList.AdminScientistStatus = k.AdminScientistStatus;
                subList.InvoiceNo = k.InvoiceNo;
                subList.InvoiceRemark = k.InvoiceRemark;

                subList.MoveProjectDate = k.MoveProjectDate;
                subList.SubScientistName = k.SubScientistName;
                subList.DispatchedStatus = k.DispatchedStatus;
                subList.MoveToDispatch = k.MoveToDispatch;
                subList.MoveToInvoice = k.MoveToInvoice;
                subList.IsDispatchApprove = k.IsDispatchApprove;

                subList.IsPayment = k.SZ_Quotation.IsPayment;

                subList.OrderRemark = k.OrderRemark;

                subList.Reason = k.Reason;
                if (k.MoveToScientistDate.HasValue)
                {
                    subList.MoveToScientistDateStr = k.MoveToScientistDate.Value.ToShortDateString();
                }
                subList.DifficultyLevel = k.DifficultyLevel;
                subList.IsCancel = k.IsCancel;
                subList.IsPriority = k.IsPriority;
                subList.LastWeekUpdate = k.LastWeekUpdate;
                subList.ProStatus = k.ProStatus;
                subList.PreviousStatus = k.PreviousStatus;
                foreach (EnumList.DifficultyLevel r in Enum.GetValues(typeof(EnumList.DifficultyLevel)))
                {
                    var item = Enum.GetName(typeof(EnumList.DifficultyLevel), r);
                    var test = r.ToString();
                    string text = SZ_Helper.GetEnumDescription((EnumList.DifficultyLevel)(int)r);
                    int val = (int)r;
                    string selected = "";
                    if (Convert.ToString(val) == k.DifficultyLevel)
                    {
                        subList.DifficultyLevelText = text;
                    }
                }
                foreach (EnumList.ProStatusDDL r in Enum.GetValues(typeof(EnumList.ProStatusDDL)))
                {
                    int val = (int)r;
                    string text = SZ_Helper.GetEnumDescription((EnumList.ProStatusDDL)(int)r);
                    if (Convert.ToString(val) == k.ProStatus)
                    {
                        subList.SelectedProStatus = text;
                    }
                }
                foreach (EnumList.ProStatusDDL r in Enum.GetValues(typeof(EnumList.ProStatusDDL)))
                {
                    int val = (int)r;
                    string text = SZ_Helper.GetEnumDescription((EnumList.ProStatusDDL)(int)r);
                    if (Convert.ToString(val) == k.PreviousStatus)
                    {
                        subList.PreviousStatusText = text;
                    }
                }
                subscilistItems.ForEach(r =>
                {
                    string selected = string.Empty;
                    if (r.Value == Convert.ToString(k.SubScientistName))
                    {
                        subList.SelectedSubScientistName = r.Text;
                    }
                });
                foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
                {
                    var item = Enum.GetName(typeof(EnumList.ProjectType), r);
                    var test = r.ToString();
                    string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
                    int val = (int)r;
                    string selected = "";
                    if (Convert.ToString(val) == k.ProjectType)
                    {
                        subList.SelectedProjectType = text;
                    }
                }
                model.Add(subList);
            }

            model = model.OrderByDescending(item => Enumerable.Reverse(orderbydetails).ToList().IndexOf(item.ProStatus)).ToList();
            if (!string.IsNullOrEmpty(ScientistListItem))
            {
                int sciid = Convert.ToInt32(ScientistListItem);
                model = model.Where(x => x.ScientistCustomerId == sciid).ToList();
            }
            if (!string.IsNullOrEmpty(SubScientistListItem))
            {
                int subsciid = Convert.ToInt32(SubScientistListItem);
                model = model.Where(x => x.SubScientistCustomerId == subsciid).ToList();
            }
            if (!string.IsNullOrEmpty(fltprostatusItem))
            {
                model = model.Where(x => x.ProStatus == fltprostatusItem).ToList();
            }

            if (!string.IsNullOrEmpty(fltactivity))
            {
                model = model.Where(x => x.ActivityStatus == fltactivity).ToList();
            }
            //Search
            if (!string.IsNullOrEmpty(parameter))
            {
                parameter = parameter.ToLower().Trim();
                model = model.Where(m => (m.CompanyName != null && m.CompanyName.ToLower().Contains(parameter))).ToList();
            }
            ExcelPackage ExcelPkg = new ExcelPackage();
            ExcelWorksheet wsSheet1 = ExcelPkg.Workbook.Worksheets.Add("Sheet1");
            wsSheet1.DefaultColWidth = 16;
            wsSheet1.Protection.IsProtected = false;
            wsSheet1.Protection.AllowSelectLockedCells = false;
            wsSheet1.Cells.AutoFitColumns(14, 40);
            wsSheet1.Column(3).Width = 40;
            wsSheet1.Column(3).Style.WrapText = true;

            int loopCount = 3;
            int totalColumn = 19;
            if (SessionCookieManagement.UserEmail == "parthsuthar2010@gmail.com")
            {
                totalColumn = 20;
            }
            using (ExcelRange Rng = wsSheet1.Cells[1, 1, 1, totalColumn])
            {
                Rng.Value = "Company Wise Report";
                Rng.Merge = true;
                Rng.Style.Font.Bold = true;
                Rng.Style.Font.Size = 22;
                Rng.Style.Font.Color.SetColor(Color.White);
                Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#3c8dbc");
                Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
            }

            wsSheet1.Cells[loopCount, 1].Value = "Sr No";
            var columnCnt = 2;
            if (SessionCookieManagement.UserEmail == "parthsuthar2010@gmail.com")
            {
                wsSheet1.Cells[loopCount, columnCnt].Value = "Company Name";
                columnCnt++;
            }
            wsSheet1.Cells[loopCount, columnCnt].Value = "PO No";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "Product Detail";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "CAS No";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "CAT No";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "QTY";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "Batch No";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "PO Date";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "Lead Time";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "Scientist";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "Sub-Scientist";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "Diff";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "Activity";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "Status";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "Current Status";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "Estimated Dispatched Date";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "Prev. Status";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "Prev. Current Status";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "Prev. Estimated Dispatched Date";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "Project Type";
            using (ExcelRange Rng = wsSheet1.Cells[loopCount, 1, loopCount, columnCnt])
            {
                Rng.Style.Font.Bold = true;
                Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#7b7b7b");
                Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                Rng.Style.Font.Color.SetColor(Color.White);
                Rng.Style.WrapText = true;
            }

            loopCount = loopCount + 1;
            int srno = 1;
            foreach (var quote in model)
            {
                columnCnt = 2;
                wsSheet1.Cells[loopCount, 1].Value = srno;
                if (SessionCookieManagement.UserEmail == "parthsuthar2010@gmail.com")
                {
                    wsSheet1.Cells[loopCount, columnCnt].Value = quote.CompanyName;
                    columnCnt++;
                }
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.PONumber;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.ProductName;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.CASNo;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.CATNo;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.RequiredQty;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.SelectedAdditionalBatchNo;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.PODate.HasValue ? quote.PODate.Value.ToShortDateString() : "";
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.LeadTime;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.SelectedScientistName;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.SelectedSubScientistName;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.DifficultyLevelText;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.ActivityStatus;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.SelectedProStatus;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.ExplainationSecond;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.EstimateCompleteDate.HasValue ? quote.EstimateCompleteDate.Value.ToShortDateString() : "";
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.PreviousStatusText;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.LastWeekUpdate;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.PreviousEstCompleteDate.HasValue ? quote.PreviousEstCompleteDate.Value.ToShortDateString() : "";
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.SelectedProjectType;

                if (quote.IsCancel.HasValue && quote.IsCancel.Value)
                {
                    using (ExcelRange Rng = wsSheet1.Cells[loopCount, 1, loopCount, columnCnt])
                    {
                        Rng.Style.Font.Color.SetColor(Color.White);
                        Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                        Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#ff3300");
                        Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                    }
                }

                srno += 1;
                loopCount += 1;
            }
            string filePath = HostingEnvironment.MapPath("~/Content/Quotation/") + "ExportReport-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xlsx";
            ExcelPkg.SaveAs(new FileInfo(filePath));
            return File(filePath, "application/excel", Server.UrlEncode("ExportReport-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xls"));
        }


        public ActionResult ExportProjectcontrolledsubstance()
        {


            List<string> orderbydetails = new List<String> {
                "Dispatching",
                "Invoiced",
                "Data Approved",
                "Client Confirmation",
                "Data Sent",
                "Data Recording",
                "RM Ordered",
                "In progress",
                "In progress - Delay",
                "Purification",
                "Prep HPLC",
                "Troubleshoot",
                "Clarification",
                "Attention",
                "Not Working",
                "On Hold" };

            string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);
            string pursynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);
            var queryData = db.SZ_QueryModule.AsQueryable();
            //var quotationDetailsdata = db.SZ_QuotationDetail.AsQueryable();
            var substanceproductIds = db.Products.Where(x => x.IsControlledSubstance == true
                                    || x.IsManuallyControlledSubstance == true).Select(x => x.Id).ToList();

            // Getting all Customer data  
            var list = (from i in db.SZ_Quotation.AsNoTracking()
                        join t2 in db.SZ_QuotationDetail.AsNoTracking() on i.Id equals t2.QuoteId
                        where t2.MoveToProject == true
                        //&& string.IsNullOrEmpty(t2.TrackingNo)
                        && (t2.IsOnHold == false || t2.IsOnHold == null)
                        && (t2.ProjectType != inhouseProjectType || t2.ProjectType == null)
                        && i.CompanyId != 208
                        && t2.ProductId.HasValue
                        && substanceproductIds.Contains(t2.ProductId.Value)
                        orderby t2.MoveProjectDate descending
                        select t2).Distinct().OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo).AsQueryable();

            list = list.Where(x => (x.MoveToInvoice == false || x.MoveToInvoice == null)
                                //&& (x.MoveToDispatch == false || x.MoveToDispatch == null)
                                && (x.LicesenStatusId == null || (x.LicesenStatusId.HasValue && x.LicesenStatusId.Value != 2))).AsQueryable();


            list = list.OrderByDescending(x => x.MoveProjectDate).ThenBy(x => x.SrPo);
            var proIds = list.Select(x => x.ProductId).Distinct().ToList();
            var productsData = db.Products.Where(x => proIds.Contains(x.Id) && x.Published == true && x.Deleted == false).ToList();
            var subscilistItems = new List<SelectListItem>();
            var listItems = new List<SelectListItem>();
            MemoryCacheManager objCache = new MemoryCacheManager();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });
            var scienList = objCache.Get("cache.GetScientistId", () =>
            {
                return db.GetScientistId().ToList();
            });
            var inventorydata = db.SZ_Inventory.Where(x => proIds.Contains(x.ProductId)).ToList();
            scienList.ForEach(term =>
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                listItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.ToString()
                });
                subscilistItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.ToString()
                });
            });

            var subscienList = objCache.Get("cache.subscienList", () =>
            {
                return db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();
            });
            foreach (var term in subscienList)
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == term.Id).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }

                subscilistItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.Id.ToString()
                });

            }
            var ReadyToDeliverScientistStatusId = db.SZ_ScientistStatus.Where(x => x.Name.ToLower().Contains("ready for dispatch")).Select(x => x.Id).FirstOrDefault();
            var model = new List<ProjectListModel>();
            foreach (var k in list)
            {
                ProjectListModel subList = new ProjectListModel();
                subList.ReadyToDeliverScientistStatusId = ReadyToDeliverScientistStatusId;
                subList.AdditionalBatchNo = k.AdditionalBatchNo;
                subList.ProjectType = k.ProjectType;
                subList.PODate = k.SZ_Quotation.PODate;
                subList.IsPaymentPending = k.SZ_Quotation.SZ_CompanyList.IsPaymentPending;
                subList.ActivityStatus = k.ActivityStatus;
                subList.ProductId = k.ProductId;
                listItems.ForEach(r =>
                {
                    if (r.Value == Convert.ToString(k.ScientistCustomerId))
                    {
                        subList.SelectedScientistName = r.Text;
                    }
                });
                if (subList.ProductId.HasValue)
                {
                    var proData = productsData.Where(x => x.Id == subList.ProductId).Count();
                    var proBatchData = inventorydata.Where(x => x.ProductId == subList.ProductId).ToList();
                    if (proBatchData.Count > 0 && proData > 0)
                    {
                        proBatchData.ForEach(r =>
                        {
                            if (r.Id == subList.AdditionalBatchNo)
                            {
                                subList.SelectedAdditionalBatchNo = r.BatchNo + " (" + Convert.ToInt32(r.Qty) + ")";
                            }
                        });
                    }
                }
                subList.MoveProjectDateText = k.MoveProjectDate.HasValue ? k.MoveProjectDate.Value.ToString("dd/MM/yyyy hh:mm tt") : "";
                subList.AdditionalBatchNo = k.AdditionalBatchNo;
                subList.QuoteId = k.SZ_Quotation.Id;
                subList.ProductId = k.ProductId;
                subList.ProductName = k.ProductName;
                subList.ExplainationSecond = k.ExplainationSecond;
                subList.IsImageAttach = k.SZ_Quotation.IsImageAttach;
                subList.CompanyName = k.SZ_Quotation.SZ_CompanyList.Name;
                subList.Email = k.SZ_Quotation.EmailAddress;
                subList.PONumber = k.SZ_Quotation.PONo;
                subList.Ref = k.SZ_Quotation.Ref;
                subList.Remark = k.SZ_Quotation.Remark;
                subList.MoveProjectDate = k.MoveProjectDate;
                subList.QuoteDetailsId = k.Id;
                subList.CASNo = k.CASNo;
                subList.CATNo = k.CATNo;
                subList.CreatedDate = k.CreatedDate;
                subList.ImagePath = k.ImagePath;
                subList.IsUploadServer = k.IsUploadServer;
                subList.LeadTime = k.LeadTime;
                subList.Price = k.Price;
                subList.QuoteId = k.QuoteId;
                subList.ProjectType = k.ProjectType;
                subList.ScientistCustomerId = k.ScientistCustomerId;

                subList.RequiredQty = k.RequiredQty;
                subList.ProjectStatus = k.ProjectStatus;
                subList.IsOnHold = k.IsOnHold;
                if (k.ProjectStatus != null)
                {
                    subList.ProjectStatustext = SZ_Helper.GetEnumDescription((EnumList.ProjectStatus)(int)k.ProjectStatus);
                }
                subList.ScientistStatus = k.ScientistStatus;
                subList.BatchCode1 = k.BatchCode1;
                subList.BatchCode2 = k.BatchCode2;
                subList.Qty1 = k.Qty1;
                subList.Qty2 = k.Qty2;
                subList.EstimateCompleteDate = k.EstimateCompleteDate;
                subList.PreviousEstCompleteDate = k.PreviousEstCompleteDate;
                subList.MoveToDispatch = k.MoveToDispatch;
                subList.MoveToProject = k.MoveToProject;
                subList.Remark = k.Remark;
                subList.SrPo = k.SrPo;
                subList.AdminScientistStatus = k.AdminScientistStatus;
                subList.InvoiceNo = k.InvoiceNo;
                subList.InvoiceRemark = k.InvoiceRemark;

                subList.MoveProjectDate = k.MoveProjectDate;
                subList.SubScientistName = k.SubScientistName;
                subList.DispatchedStatus = k.DispatchedStatus;
                subList.MoveToDispatch = k.MoveToDispatch;
                subList.MoveToInvoice = k.MoveToInvoice;
                subList.IsDispatchApprove = k.IsDispatchApprove;

                subList.IsPayment = k.SZ_Quotation.IsPayment;

                subList.OrderRemark = k.OrderRemark;

                subList.Reason = k.Reason;
                if (k.MoveToScientistDate.HasValue)
                {
                    subList.MoveToScientistDateStr = k.MoveToScientistDate.Value.ToShortDateString();
                }
                subList.DifficultyLevel = k.DifficultyLevel;
                subList.IsCancel = k.IsCancel;
                subList.IsPriority = k.IsPriority;
                subList.LastWeekUpdate = k.LastWeekUpdate;
                subList.ProStatus = k.ProStatus;
                subList.PreviousStatus = k.PreviousStatus;
                foreach (EnumList.DifficultyLevel r in Enum.GetValues(typeof(EnumList.DifficultyLevel)))
                {
                    var item = Enum.GetName(typeof(EnumList.DifficultyLevel), r);
                    var test = r.ToString();
                    string text = SZ_Helper.GetEnumDescription((EnumList.DifficultyLevel)(int)r);
                    int val = (int)r;
                    string selected = "";
                    if (Convert.ToString(val) == k.DifficultyLevel)
                    {
                        subList.DifficultyLevelText = text;
                    }
                }
                foreach (EnumList.ProStatusDDL r in Enum.GetValues(typeof(EnumList.ProStatusDDL)))
                {
                    int val = (int)r;
                    string text = SZ_Helper.GetEnumDescription((EnumList.ProStatusDDL)(int)r);
                    if (Convert.ToString(val) == k.ProStatus)
                    {
                        subList.SelectedProStatus = text;
                    }
                }
                foreach (EnumList.ProStatusDDL r in Enum.GetValues(typeof(EnumList.ProStatusDDL)))
                {
                    int val = (int)r;
                    string text = SZ_Helper.GetEnumDescription((EnumList.ProStatusDDL)(int)r);
                    if (Convert.ToString(val) == k.PreviousStatus)
                    {
                        subList.PreviousStatusText = text;
                    }
                }
                subscilistItems.ForEach(r =>
                {
                    string selected = string.Empty;
                    if (r.Value == Convert.ToString(k.SubScientistName))
                    {
                        subList.SelectedSubScientistName = r.Text;
                    }
                });
                foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
                {
                    var item = Enum.GetName(typeof(EnumList.ProjectType), r);
                    var test = r.ToString();
                    string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
                    int val = (int)r;
                    string selected = "";
                    if (Convert.ToString(val) == k.ProjectType)
                    {
                        subList.SelectedProjectType = text;
                    }
                }



                if (k.LicesenStatusId == 1)
                {
                    subList.LicesenStatusText = "In Progress";
                }
                if (k.LicesenStatusId == 2)
                {
                    subList.LicesenStatusText = "Completed";
                }
                if (k.LicesenStatusId == 3)
                {
                    subList.LicesenStatusText = "On Hold";
                }
                if (k.LicesenStatusId == 4)
                {
                    subList.LicesenStatusText = "Query";
                }
                if (k.LicesenStatusId == 5)
                {
                    subList.LicesenStatusText = "To Be Initiated";
                }

                subList.ImpExpo = k.ImpExpo;
                subList.Category = k.Category;
                subList.JourneyComment = k.JourneyComment;
                subList.PermitRequired = k.PermitRequired;
                subList.ImportPermit = k.ImportPermit;
                subList.Declaration = k.Declaration;
                subList.ApplicationDate = k.ApplicationDate;
                subList.ExportPermitReceivedDate = k.ExportPermitReceivedDate;
                subList.TechnicalWriteup = k.TechnicalWriteup;

                subList.QuaterlyDataToSubmit = k.QuaterlyDataToSubmit;

                subList.QuaterlyDataSubmited = k.QuaterlyDataSubmited;


                var startYear = DateTime.Now.Year;
                var endYear = DateTime.Now.AddYears(1).Year;
                subList.NextQuater = k.NextQuater;
                subList.APIRequired = k.APIRequired;

                subList.APIImpExport = k.APIImpExport;

                model.Add(subList);
            }

            model = model.OrderByDescending(item => Enumerable.Reverse(orderbydetails).ToList().IndexOf(item.ProStatus)).ToList();

            ExcelPackage ExcelPkg = new ExcelPackage();
            ExcelWorksheet wsSheet1 = ExcelPkg.Workbook.Worksheets.Add("Sheet1");
            wsSheet1.DefaultColWidth = 16;
            wsSheet1.Protection.IsProtected = false;
            wsSheet1.Protection.AllowSelectLockedCells = false;
            wsSheet1.Cells.AutoFitColumns(14, 40);
            wsSheet1.Column(3).Width = 40;
            wsSheet1.Column(3).Style.WrapText = true;

            int loopCount = 3;
            int totalColumn = 24;

            using (ExcelRange Rng = wsSheet1.Cells[1, 1, 1, totalColumn])
            {
                Rng.Value = "CONTROLLED SUBSTANCE REPORT";
                Rng.Merge = true;
                Rng.Style.Font.Bold = true;
                Rng.Style.Font.Size = 22;
                Rng.Style.Font.Color.SetColor(Color.White);
                Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#3c8dbc");
                Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
            }

            wsSheet1.Cells[loopCount, 1].Value = "Sr No";
            var columnCnt = 2;

            wsSheet1.Cells[loopCount, columnCnt].Value = "Company Name";
            columnCnt++;

            wsSheet1.Cells[loopCount, columnCnt].Value = "PO No";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "Product Detail";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "CAS No";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "CAT No";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "QTY";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "Batch No";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "PO Date";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "Journey Comments";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "Category";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "Import / Export";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "License Status";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "Export NOC/Permit Required?";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "Import Permit";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "Declaration";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "Application Date";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "Export Permit Received Date";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "Technical Writeup";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "Quaterly Data to submit?";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "Quaterly Data Submitted?";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "Next Quarter";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "API Required";
            columnCnt++;
            wsSheet1.Cells[loopCount, columnCnt].Value = "API Import/Domestic";

            using (ExcelRange Rng = wsSheet1.Cells[loopCount, 1, loopCount, columnCnt])
            {
                Rng.Style.Font.Bold = true;
                Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#7b7b7b");
                Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                Rng.Style.Font.Color.SetColor(Color.White);
                Rng.Style.WrapText = true;
            }

            loopCount = loopCount + 1;
            int srno = 1;
            foreach (var quote in model)
            {
                columnCnt = 2;
                wsSheet1.Cells[loopCount, 1].Value = srno;

                wsSheet1.Cells[loopCount, columnCnt].Value = quote.CompanyName;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.PONumber;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.ProductName;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.CASNo;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.CATNo;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.RequiredQty;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.SelectedAdditionalBatchNo;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.PODate.HasValue ? quote.PODate.Value.ToShortDateString() : "";
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.JourneyComment;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.Category;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.ImpExpo;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.LicesenStatusId;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.PermitRequired;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.ImportPermit;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.Declaration;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.ApplicationDate.HasValue ? quote.ApplicationDate.Value.ToShortDateString() : "";
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.ExportPermitReceivedDate.HasValue ? quote.ExportPermitReceivedDate.Value.ToShortDateString() : "";
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.TechnicalWriteup;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.QuaterlyDataToSubmit;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.QuaterlyDataSubmited;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.NextQuater;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.APIRequired;
                columnCnt++;
                wsSheet1.Cells[loopCount, columnCnt].Value = quote.APIImpExport;


                if (quote.IsCancel.HasValue && quote.IsCancel.Value)
                {
                    using (ExcelRange Rng = wsSheet1.Cells[loopCount, 1, loopCount, columnCnt])
                    {
                        Rng.Style.Font.Color.SetColor(Color.White);
                        Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                        Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#ff3300");
                        Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                    }
                }

                srno += 1;
                loopCount += 1;
            }
            string filePath = HostingEnvironment.MapPath("~/Content/Quotation/") + "ExportReport-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xlsx";
            ExcelPkg.SaveAs(new FileInfo(filePath));
            return File(filePath, "application/excel", Server.UrlEncode("ExportReport-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xls"));
        }
        public ActionResult ExportAllCompanydata()
        {
            MemoryCacheManager objCache = new MemoryCacheManager();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });
            var geolocationList = objCache.Get("cache.geographicalLocationData", () =>
            {
                return db.SZ_Geographical.OrderBy(x => x.Id).ToList();
            });
            var result = (from i in db.SZ_CompanyList
                          select i).ToList();

            ExcelPackage ExcelPkg = new ExcelPackage();
            ExcelWorksheet wsSheet1 = ExcelPkg.Workbook.Worksheets.Add("Sheet1");
            wsSheet1.DefaultColWidth = 16;
            wsSheet1.Protection.IsProtected = false;
            wsSheet1.Protection.AllowSelectLockedCells = false;
            wsSheet1.Cells.AutoFitColumns(14, 40);
            wsSheet1.Column(3).Width = 40;
            wsSheet1.Column(3).Style.WrapText = true;

            int loopCount = 2;
            wsSheet1.Cells[loopCount, 1].Value = "Sr No";
            wsSheet1.Cells[loopCount, 2].Value = "Name";
            wsSheet1.Cells[loopCount, 3].Value = "Master Email";
            wsSheet1.Cells[loopCount, 4].Value = "Country Type";
            wsSheet1.Cells[loopCount, 5].Value = "User Dist Type";
            wsSheet1.Cells[loopCount, 6].Value = "Address";
            wsSheet1.Cells[loopCount, 7].Value = "Location";
            wsSheet1.Cells[loopCount, 8].Value = "Country";
            wsSheet1.Cells[loopCount, 9].Value = "Contact";
            wsSheet1.Cells[loopCount, 10].Value = "Followup Time";
            wsSheet1.Cells[loopCount, 11].Value = "Payment Terms";
            wsSheet1.Cells[loopCount, 12].Value = "Inco Terms";
            wsSheet1.Cells[loopCount, 13].Value = "Geography";
            wsSheet1.Cells[loopCount, 14].Value = "Project Person";
            wsSheet1.Cells[loopCount, 15].Value = "SAP Code";
            using (ExcelRange Rng = wsSheet1.Cells[loopCount, 1, loopCount, 15])
            {
                Rng.Style.Font.Bold = true;
                Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#7b7b7b");
                Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                Rng.Style.Font.Color.SetColor(Color.White);
                Rng.Style.WrapText = true;
            }
            loopCount += 1;
            int srno = 1;
            foreach (var quote in result)
            {
                wsSheet1.Cells[loopCount, 1].Value = srno;
                wsSheet1.Cells[loopCount, 2].Value = quote.Name;
                wsSheet1.Cells[loopCount, 3].Value = quote.MasterEmail;
                wsSheet1.Cells[loopCount, 4].Value = quote.CountryType;
                wsSheet1.Cells[loopCount, 5].Value = quote.UserDistType;
                wsSheet1.Cells[loopCount, 6].Value = quote.Address;
                wsSheet1.Cells[loopCount, 7].Value = quote.Location;
                wsSheet1.Cells[loopCount, 8].Value = quote.Country;
                wsSheet1.Cells[loopCount, 9].Value = quote.Contact;
                wsSheet1.Cells[loopCount, 10].Value = quote.FollowupTime;
                wsSheet1.Cells[loopCount, 11].Value = quote.PaymentTerms;

                wsSheet1.Cells[loopCount, 12].Value = quote.InccoTerm;
                if (quote.GeographicalLocation.HasValue)
                {
                    wsSheet1.Cells[loopCount, 13].Value = geolocationList.Where(x => x.Id == quote.GeographicalLocation.Value).Select(x => x.Id).FirstOrDefault();
                }
                else
                {
                    wsSheet1.Cells[loopCount, 13].Value = "";
                }
                if (quote.ProjectTeam.HasValue)
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == quote.ProjectTeam.Value).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    wsSheet1.Cells[loopCount, 14].Value = customerName;
                }
                else
                {
                    wsSheet1.Cells[loopCount, 14].Value = "";
                }

                wsSheet1.Cells[loopCount, 15].Value = quote.SAPCode;
                srno += 1;
                loopCount += 1;
            }
            string filePath = HostingEnvironment.MapPath("~/Content/Quotation/") + "ExportCompanyList-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xlsx";
            ExcelPkg.SaveAs(new FileInfo(filePath));
            return File(filePath, "application/excel", Server.UrlEncode("ExportCompanyList-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xls"));
        }

        public string GetProductParentCategoryName(int productid)
        {
            string categoryName = "";
            var categoryList = (from i in db.Product_Category_Mapping
                                join t2 in db.Categories on i.CategoryId equals t2.Id
                                where i.ProductId == productid && t2.Deleted == false && t2.Published == true
                                select t2).ToList();

            if (categoryList != null && categoryList.Count > 0)
            {
                foreach (var item in categoryList)
                {
                    if (item.ParentCategoryId == 0)
                    {
                        return item.Name;
                    }
                    else
                    {
                        return GetParentCatNameByCategoryId(item.ParentCategoryId);
                    }
                }
            }

            return categoryName;
        }

        public string GetParentCatNameByCategoryId(int parentcategoryId)
        {
            string categoryName = "";
            var categoryList = (from i in db.Categories
                                where i.Id == parentcategoryId && i.Deleted == false && i.Published == true
                                select i).ToList();
            if (categoryList != null && categoryList.Count > 0)
            {
                foreach (var item in categoryList)
                {
                    if (item.ParentCategoryId == 0)
                    {
                        return item.Name;
                    }
                    else
                    {
                        return GetParentCatNameByCategoryId(item.ParentCategoryId);
                    }
                }
            }
            return categoryName;
        }


        [HttpPost]
        public ActionResult GenerateRFQQuote(int id, string rfqid)
        {
            var company = db.SZ_CompanyList.Where(x => x.Id == id).FirstOrDefault();
            int QuoteId = 0;
            if (company.IsBlockCompany.HasValue && company.IsBlockCompany.Value)
            {
                return Json(new
                {
                    success = false,
                    quoteId = QuoteId,
                    message = "Selected company is blocked by admin. You can not generate quote."
                }, JsonRequestBehavior.AllowGet);
            }

            int refNo = 1;
            string value = string.Empty;
            string matchingstring = "SZ-" + DateTime.Now.ToString("ddMMyy") + "-";
            var SZ_Quotationdata = (from i in db.SZ_Quotation
                                    where i.Ref.StartsWith(matchingstring)
                                    select i).ToList();
            if (SZ_Quotationdata.Count > 0)
            {
                refNo = SZ_Quotationdata.Select(x => ExtractQuoreRefNumber(x.Ref)).Max(w => w);
                int newbrokerrewf = Convert.ToInt32(refNo) + 1;

                value = "SZ-" + DateTime.Now.ToString("ddMMyy") + "-" + newbrokerrewf.ToString().PadLeft(2, '0');
            }
            else
            {
                value = "SZ-" + DateTime.Now.ToString("ddMMyy") + "-01";
            }

            List<int> rfqIds = new List<int>();
            string[] ids = rfqid.Split(',');
            foreach (var item in ids)
            {
                rfqIds.Add(Convert.ToInt32(item));
            }

            int firstRFQId = rfqIds[0];
            var rfqdata = db.SZ_Query.Where(x => x.Id == firstRFQId).FirstOrDefault();

            SZ_Quotation objquote = new SZ_Quotation();
            objquote.IsCOA = true;
            objquote.Ref = value;
            objquote.ClientRef = rfqdata.RFQNo;
            objquote.CompanyId = company.Id;
            objquote.CompanyName = company.Name;
            objquote.EmailAddress = rfqdata.Email;
            objquote.ClientRef = string.Empty;
            objquote.IsImageAttach = false;
            objquote.PONo = string.Empty;
            objquote.Remark = string.Empty;
            objquote.TermsId = company.TermsId;
            objquote.CountryType = company.CountryType;
            objquote.UserDistType = company.UserDistType;
            objquote.IsToBe = false;
            objquote.IsQuoteApproved = false;
            objquote.Auction = false;
            //TODO: Stoped PO Update Date
            //objquote.PODate = DateTime.Now;
            objquote.SuggChemName = string.Empty;
            objquote.Attachment = string.Empty;
            objquote.CreatedDate = DateTime.Now;
            objquote.EmailCC = string.Empty;
            objquote.IsRFQ = true;
            if (company.CountryType == "Export")
            {
                objquote.IsAnalyticalData = true;
                objquote.Currency = "USD";
                objquote.CountryType = "Export";
                objquote.CountryTypeId = 2;
            }
            else
            {
                objquote.Currency = "INR";
                objquote.CountryType = "Domestic";
                objquote.CountryTypeId = 1;
            }
            objquote.CreatedBy = SessionCookieManagement.UserName;
            db.SZ_Quotation.Add(objquote);
            db.SaveChanges();

            QuoteId = objquote.Id;

            var companyName = "";
            var email = "";
            int displayOrder = 0;
            foreach (var i in rfqIds)
            {
                var rfqAlldata = db.SZ_Query.Where(x => x.Id == i).FirstOrDefault();
                if (rfqAlldata != null)
                {
                    email = rfqAlldata.Email;
                    companyName = rfqAlldata.CompanyName;

                    SZ_QuotationDetail objdetails = new SZ_QuotationDetail();
                    objdetails.IsUploadServer = true;
                    objdetails.CASNo = rfqAlldata.CASNo;
                    objdetails.CATNo = rfqAlldata.CATNo;
                    objdetails.CreatedDate = DateTime.Now;
                    objdetails.ImagePath = string.Empty;
                    objdetails.LeadTime = string.Empty;
                    objdetails.EstimateDispatchDate = null;
                    objdetails.Price = rfqAlldata.Package.Replace(" - ", "@").Replace("@ ", "@").Replace(",", objquote.CountryType == "Export" ? " USD," : " INR,").Trim();
                    objdetails.ProductId = rfqAlldata.ProductId;
                    objdetails.ProductName = rfqAlldata.ProductName;
                    objdetails.QuoteId = objquote.Id;
                    objdetails.DisplayOrder = displayOrder;
                    objdetails.RequiredQty = rfqAlldata.Package.Replace("KG", "").Replace("MG", "").Replace("G", "").Trim();
                    objdetails.ProductRemark = rfqAlldata.AdditionalComment;
                    objdetails.ProcessState = (int)EnumList.ProcessState.InProgress;
                    objdetails.ProjectStatus = (int)EnumList.ProjectStatus.NoAction;
                    objdetails.IsSynthesisLog = false;
                    objdetails.ProductRemark += " " + db.Products.Where(x => x.Id == rfqAlldata.ProductId).Select(x => x.ProductRemark).FirstOrDefault();

                    db.SZ_QuotationDetail.Add(objdetails);
                    db.SaveChanges();
                    displayOrder += 1;

                    db.Entry(rfqAlldata).State = EntityState.Deleted;
                    db.SaveChanges();
                }
            }

            var customerInfo = db.Customers.Where(x => x.Email == email).FirstOrDefault();
            if (customerInfo != null)
            {
                var genAttr = db.GenericAttributes.Where(x => x.EntityId == customerInfo.Id && x.KeyGroup == "Customer" && x.Key == "Company").FirstOrDefault();
                if (genAttr != null)
                {
                    db.Entry(genAttr).State = EntityState.Modified;
                    db.SaveChanges();
                }
            }

            return Json(new
            {
                success = true,
                quoteId = QuoteId
            }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult Messanger()
        {
            ViewBag.Customer = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.Email.ToLower().Contains("@synzeal.com")).OrderBy(x => x.Email).ToList();
            return View();
        }

        public ActionResult RetestCOA()
        {
            if (!SessionCookieManagement.IsDispatch && !SessionCookieManagement.IsAdmin
                && !SessionCookieManagement.IsDocumentation)
            {
                return RedirectToAction("Index", "Home");
            }

            ViewBag.IsDispatchLogin = false;
            if (SessionCookieManagement.IsDispatch && !SessionCookieManagement.IsAdmin)
            {
                ViewBag.IsDispatchLogin = true;
            }
            return View();
        }
        public ActionResult MarkInstock(int id)
        {
            var data = _operationRepository.GetQuoteDetailByID(id);
            if (data != null)
            {
                data.ProjectType = Convert.ToString((int)EnumList.ProjectType.InStock);
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json("done", JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult LinkedFormData(int Id, int formid)
        {
            var product = db.SZ_QuoteDetails_Form.Where(x => x.FormId == formid && x.QuoteDetailsId == Id).FirstOrDefault();
            if (product == null)
            {
                SZ_QuoteDetails_Form objdetform = new SZ_QuoteDetails_Form();
                objdetform.CreatedDate = DateTime.Now;
                objdetform.FormId = formid;
                objdetform.QuoteDetailsId = Id;
                db.SZ_QuoteDetails_Form.Add(objdetform);
                db.SaveChanges();
            }
            return Json("done", JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult addRetestData(int Id, List<int> Inventoryid)
        {
            var product = db.Products.Where(x => x.Id == Id).FirstOrDefault();

            foreach (var item in Inventoryid)
            {
                SZ_Retest objCOA = new SZ_Retest();
                objCOA.CatNo = product.Sku;
                objCOA.InventoryId = item;
                objCOA.Createddate = DateTime.Now;
                objCOA.ProductId = Id;
                objCOA.IsApproved = false;
                objCOA.IsRetestLater = false;
                objCOA.CreatedBy = SessionCookieManagement.UserName;
                db.Entry(objCOA).State = EntityState.Added;
                db.SaveChanges();
            }
            return Json("done", JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult updateBatchnoInQuotation(int batchId, int quotationdetailId)
        {
            var quotedetailsData = _operationRepository.GetQuoteDetailByID(quotationdetailId);

            if (quotedetailsData != null)
            {
                quotedetailsData.AdditionalBatchNo = batchId;
                db.Entry(quotedetailsData).State = EntityState.Modified;
                db.SaveChanges();

                InsertLog("Quotation details", SessionCookieManagement.UserName + " has updated " + quotedetailsData.AdditionalBatchNo + " from dispatch tab in Retest COA module.");
            }
            return Json("done", JsonRequestBehavior.AllowGet);
        }


        public JsonResult LoadRetestData(string tabname)
        {
            try
            {

                var from_Date = string.Empty;
                var to_Date = string.Empty;
                var ApiName = string.Empty;
                var CasProductName = string.Empty;
                if (Request.Form.GetValues("from_Date") != null)
                {
                    from_Date = Request.Form.GetValues("from_Date")[0].ToString(); ;
                }
                if (Request.Form.GetValues("to_Date") != null)
                {
                    to_Date = Request.Form.GetValues("to_Date")[0].ToString(); ;
                }
                if (Request.Form.GetValues("ApiName") != null)
                {
                    ApiName = Request.Form.GetValues("ApiName")[0].ToString(); ;
                }
                if (Request.Form.GetValues("CasProductName") != null)
                {
                    CasProductName = Request.Form.GetValues("CasProductName")[0].ToString(); ;
                }
                bool setDefaultdate = false;
                DateTime startDate = DateTime.MinValue;
                DateTime endDate = DateTime.MinValue;
                if (!string.IsNullOrEmpty(from_Date))
                {
                    startDate = Convert.ToDateTime(from_Date);
                }
                if (!string.IsNullOrEmpty(to_Date))
                {
                    endDate = Convert.ToDateTime(to_Date);
                }
                if (tabname == "previous")
                {
                    startDate = Convert.ToDateTime(DateTime.Now.AddYears(-10));
                    endDate = Convert.ToDateTime(DateTime.Now.AddDays(-1));
                }
                var length = Request.Form.GetValues("length").FirstOrDefault();
                var draw = Request.Form.GetValues("draw").FirstOrDefault();
                var start = Request.Form.GetValues("start").FirstOrDefault();
                int numberOfObjectsPerPage = Convert.ToInt32(Request.Form["length"]);
                var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
                int pageSize = length != null ? Convert.ToInt32(length) : 0;
                int skip = start != null ? Convert.ToInt32(start) : 0;
                int pageNo = 1;
                if (skip > 0)
                {
                    pageNo = (skip / numberOfObjectsPerPage) + 1;
                }
                TempData["tabname"] = tabname;
                string instock = Convert.ToString((int)EnumList.ProjectType.InStock);
                var categoryData = (from i in db.Categories
                                    join t2 in db.Product_Category_Mapping on i.Id equals t2.CategoryId
                                    join t3 in db.Categories on i.ParentCategoryId equals t3.Id
                                    select new
                                    {
                                        categoryName = t3.Name,
                                        ProductId = t2.ProductId
                                    });

                List<ReTestModel> model = new List<ReTestModel>();
                var deletedRetest = db.SZ_DeleteRetest.Select(x => x.BatchId).ToList();

                if (tabname == "all")
                {
                    var allproductsData = (from i in db.Products
                                           join t2 in db.SZ_Inventory on i.Id equals t2.ProductId into ps
                                           //join i in db.SZ_Inventory on p.Id equals i.ProductId into ps
                                           from inv in ps.DefaultIfEmpty()
                                           join t3 in db.SZ_MasterCOA on inv.Id equals t3.BatchId into psb
                                           from invb in psb.DefaultIfEmpty()
                                           where !i.Deleted && i.Published && !db.SZ_DeleteRetest.Any(x => x.BatchId == inv.Id)
                                           orderby i.Sku.Replace("SZ-", "")
                                           select new ReTestModel
                                           {
                                               RetestId = i.Id,
                                               BatchId = inv != null ? inv.Id : 0,
                                               BatchNo = inv != null ? inv.BatchNo : "",
                                               CASNo = i.ManufacturerPartNumber,
                                               CATNo = i.Sku,
                                               COAId = invb != null ? invb.Id : 0,
                                               ProductId = i.Id,
                                               ProductName = i.Name,
                                               QTY = inv != null ? inv.Qty : 0,
                                               ReTestdate = invb != null ? invb.ReTestDate : null,
                                               AnalysisDate = invb != null ? invb.AnalysisDate : null,
                                               RetestRemark = inv != null ? inv.ReTestRemark : "",
                                               HPLC = invb != null ? invb.HPLCGCELSD : "",
                                               TGA = invb != null ? invb.TGALoss : "",
                                           }).ToList();
                    allproductsData = allproductsData.Where(x => x.BatchId != null && x.BatchId != 0).ToList();

                    model = (from i in allproductsData
                             orderby i.ProductName
                             select new ReTestModel
                             {
                                 HPLC = i.HPLC,
                                 TGA = i.TGA,
                                 FirstRow = "<input type='checkbox' value='" + i.BatchId + "'  data-batchid'" + i.BatchId + "'  data-productid='" + i.ProductId + "' class='clsRetest' />",
                                 RetestId = i.RetestId,
                                 BatchId = i.BatchId,
                                 BatchNo = i.BatchNo,
                                 CASNo = i.CASNo,
                                 CATNo = i.CATNo,
                                 COAId = i.COAId,
                                 ProductId = i.ProductId,
                                 ProductName = i.ProductName,
                                 QTY = i.QTY,
                                 ReTestdate = i.ReTestdate,
                                 AnalysisDate = i.AnalysisDate,
                                 AnalysisDateText = i.AnalysisDate.HasValue ? i.AnalysisDate.Value.ToShortDateString() : null,
                                 ReTestDateText = i.ReTestdate.HasValue ? i.ReTestdate.Value.ToShortDateString() : null,
                                 APIName = categoryData.Where(x => x.ProductId == i.ProductId).Select(x => x.categoryName).FirstOrDefault(),
                                 RetestRemark = i.RetestRemark,
                                 RetestRemarkText = "<input type='text' style='width:100%' id='remark_" + i.BatchId + "' value='" + i.RetestRemark + "'/>",
                                 Diffmonth = Common.GetMonthsBetween(i.AnalysisDate, i.ReTestdate),
                                 LastRow = "<i class='fa fa-times' onclick='deletebatchretest(" + i.BatchId + ")'></i>"
                             }).ToList();
                }
                else if (tabname == "upcomming")
                {

                    if (startDate == DateTime.MinValue)
                    {
                        setDefaultdate = true;
                        startDate = DateTime.Now.Date;
                    }
                    if (endDate == DateTime.MinValue)
                    {
                        setDefaultdate = true;
                        endDate = DateTime.Now.AddDays(14).Date;
                    }

                    var catNos = (from t2 in db.SZ_Inventory
                                  join t3 in db.SZ_MasterCOA on t2.Id equals t3.BatchId
                                  where t3.ReTestDate != null && t3.ReTestDate >= startDate && t3.ReTestDate <= endDate
                                  select t3.CATNo).Distinct().ToList();

                    var datas = (from i in db.Products
                                 join t2 in db.SZ_Inventory on i.Id equals t2.ProductId into ps
                                 //join i in db.SZ_Inventory on p.Id equals i.ProductId into ps
                                 from inv in ps.DefaultIfEmpty()
                                 join t3 in db.SZ_MasterCOA on inv.Id equals t3.BatchId into psb
                                 from invb in psb.DefaultIfEmpty()
                                 where catNos.Contains(i.Sku) && !i.Deleted && i.Published
                                 orderby i.Sku.Replace("SZ-", "")
                                 //(from t2 in db.SZ_Inventory
                                 //                   join t3 in db.SZ_MasterCOA on t2.Id equals t3.BatchId
                                 //                   where t3.ReTestDate != null && t3.ReTestDate >= startDate && t3.ReTestDate <= endDate
                                 select new ReTestModel
                                 {
                                     BatchId = inv != null ? inv.Id : 0,
                                     BatchNo = inv != null ? inv.BatchNo : "",
                                     CASNo = i.ManufacturerPartNumber,
                                     CATNo = i.Sku,
                                     COAId = invb != null ? invb.Id : 0,
                                     ProductId = inv != null ? inv.ProductId : 0,
                                     ProductName = i.Name,
                                     QTY = inv != null ? inv.Qty : 0,
                                     ReTestdate = invb != null ? invb.ReTestDate : null,
                                     RetestRemark = inv != null ? inv.ReTestRemark : "",
                                     AnalysisDate = invb != null ? invb.AnalysisDate : null,
                                     APIName = inv != null ? categoryData.Where(x => x.ProductId == inv.ProductId).Select(x => x.categoryName).FirstOrDefault() : "",
                                     HPLC = invb != null ? invb.HPLCGCELSD : "",
                                     TGA = invb != null ? invb.TGALoss : "",
                                 }).ToList();

                    datas = datas.Where(x => !deletedRetest.Any(y => y == x.BatchId)).ToList();

                    var ActuallRetestData = (from t2 in datas
                                                 //where t2.ReTestdate.Value.Date >= startDate && t2.ReTestdate.Value.Date <= endDate
                                             select new ReTestModel
                                             {
                                                 FirstRow = "<input type='checkbox' value='" + t2.BatchId + "' data-productid='" + t2.ProductId + "' class='clsRetest' />",
                                                 BatchId = t2.BatchId,
                                                 BatchNo = t2.BatchNo,
                                                 CASNo = t2.CASNo,
                                                 CATNo = t2.CATNo,
                                                 COAId = t2.COAId,
                                                 ProductId = t2.ProductId,
                                                 ProductName = t2.ProductName,
                                                 QTY = t2.QTY,
                                                 ReTestdate = t2.ReTestdate,
                                                 ReTestDateText = t2.ReTestdate.HasValue ? t2.ReTestdate.Value.ToShortDateString() : null,
                                                 AnalysisDate = t2.AnalysisDate,
                                                 AnalysisDateText = t2.AnalysisDate.HasValue ? t2.AnalysisDate.Value.ToShortDateString() : null,
                                                 APIName = t2.APIName,
                                                 RetestRemark = t2.RetestRemark,
                                                 RetestRemarkText = "<input type='text'  style='width:100%' id='remark_" + t2.BatchId + "'  data-batchid='" + t2.BatchId + "' value='" + t2.RetestRemark + "'/>",
                                                 HPLC = t2.HPLC,
                                                 TGA = t2.TGA,
                                                 Diffmonth = Common.GetMonthsBetween(t2.AnalysisDate, t2.ReTestdate),
                                                 LastRow = "<i class='fa fa-times' onclick='deletebatchretest(" + t2.BatchId + ")'></i>"
                                             }).ToList();

                    model = ActuallRetestData;
                }
                else if (tabname == "dispatch")
                {

                    var datas = (from i in db.SZ_QuotationDetail
                                 join inv in db.SZ_Inventory on i.ProductId equals inv.ProductId
                                 //into ps
                                 //from inv in ps.DefaultIfEmpty()
                                 join t3 in db.SZ_MasterCOA on inv.Id equals t3.BatchId into psb
                                 from invb in psb.DefaultIfEmpty()
                                 where i.ProjectType == instock && (i.MoveToDispatch == false || i.MoveToDispatch == null) && (i.IsOnHold == false || i.IsOnHold == null) && i.ProductId != 0 && i.ProductId != null

                                 orderby i.CATNo.Replace("SZ-", "")
                                 //(from t2 in db.SZ_Inventory
                                 //                   join t3 in db.SZ_MasterCOA on t2.Id equals t3.BatchId
                                 //                   where t3.ReTestDate != null && t3.ReTestDate >= startDate && t3.ReTestDate <= endDate
                                 select new ReTestModel
                                 {
                                     QuoteDetailId = i.Id,
                                     QuoteId = i.QuoteId,
                                     BatchId = inv != null ? inv.Id : 0,
                                     BatchNo = inv != null ? inv.BatchNo : "",
                                     CASNo = i.CASNo,
                                     CATNo = i.CATNo,
                                     COAId = invb != null ? invb.Id : 0,
                                     ProductId = inv != null ? inv.ProductId : 0,
                                     ProductName = i.ProductName,
                                     QTY = inv != null ? inv.Qty : 0,
                                     ReTestdate = invb != null ? invb.ReTestDate : null,
                                     RetestRemark = inv != null ? inv.ReTestRemark : "",
                                     AnalysisDate = invb != null ? invb.AnalysisDate : null,
                                     APIName = inv != null ? categoryData.Where(x => x.ProductId == inv.ProductId).Select(x => x.categoryName).FirstOrDefault() : "",
                                     HPLC = invb != null ? invb.HPLCGCELSD : "",
                                     TGA = invb != null ? invb.TGALoss : "",
                                     QuotationCreateddate = i.CreatedDate,
                                     QuotationRef = i.SZ_Quotation.Ref,
                                     CompanyName = i.SZ_Quotation.CompanyName,
                                     PONumber = i.SZ_Quotation.PONo,
                                     PONumberDate = i.SZ_Quotation.PODate,
                                     ISBatchSelected = inv != null ? (i.AdditionalBatchNo == inv.Id ? true : false) : false
                                 }).ToList();
                    datas = datas.Where(x => !deletedRetest.Any(y => y == x.BatchId)).ToList();
                    var ActuallRetestData = (from t2 in datas
                                                 //where t2.ReTestdate.Value.Date >= startDate && t2.ReTestdate.Value.Date <= endDate
                                             select new ReTestModel
                                             {
                                                 QuoteDetailId = t2.QuoteDetailId,
                                                 QuoteId = t2.QuoteId,
                                                 FirstRow = "<input type='checkbox' value='" + t2.BatchId + "' data-productid='" + t2.ProductId + "' class='clsRetest' />",
                                                 BatchId = t2.BatchId,
                                                 BatchNo = t2.BatchNo,
                                                 CASNo = t2.CASNo,
                                                 CATNo = t2.CATNo,
                                                 COAId = t2.COAId,
                                                 ProductId = t2.ProductId,
                                                 ProductName = t2.ProductName,
                                                 QTY = t2.QTY,
                                                 ReTestdate = t2.ReTestdate,
                                                 ReTestDateText = t2.ReTestdate.HasValue ? t2.ReTestdate.Value.ToShortDateString() : null,
                                                 AnalysisDate = t2.AnalysisDate,
                                                 AnalysisDateText = t2.AnalysisDate.HasValue ? t2.AnalysisDate.Value.ToShortDateString() : null,
                                                 APIName = t2.APIName,
                                                 RetestRemark = t2.RetestRemark,
                                                 RetestRemarkText = "<input type='text'  style='width:100%' id='remark_" + t2.BatchId + "'  data-batchid='" + t2.BatchId + "' value='" + t2.RetestRemark + "'/>",
                                                 HPLC = t2.HPLC,
                                                 TGA = t2.TGA,
                                                 QuotationCreateddate = t2.QuotationCreateddate,
                                                 QuotationRef = t2.QuotationRef,
                                                 CompanyName = t2.CompanyName,
                                                 CreatedDateText = t2.QuotationCreateddate.HasValue ? t2.QuotationCreateddate.Value.ToShortDateString() : "",
                                                 PONumber = t2.PONumber,
                                                 PONumberDate = t2.PONumberDate,
                                                 PONumberDateText = t2.PONumberDate.HasValue ? t2.PONumberDate.Value.ToShortDateString() : "",
                                                 ISBatchSelected = t2.ISBatchSelected,
                                                 Diffmonth = Common.GetMonthsBetween(t2.AnalysisDate, t2.ReTestdate),
                                                 LastRow = "<i class='fa fa-times' onclick='deletebatchretest(" + t2.BatchId + ")'></i>",
                                                 ChangeBatch = "<i class='fa fa-clone' title='Change Batch No' onclick='GetAllBatchNo(" + t2.ProductId + "," + t2.QuoteDetailId + ")' ></i>"
                                             }).ToList();

                    model = ActuallRetestData;
                }

                else if (tabname == "quote")
                {
                    if (startDate == DateTime.MinValue)
                    {
                        setDefaultdate = true;
                        startDate = DateTime.Now.AddDays(-7).Date;
                    }
                    if (endDate == DateTime.MinValue)
                    {
                        setDefaultdate = true;
                        endDate = DateTime.Now.Date;
                        TimeSpan ts = new TimeSpan(23, 59, 0);
                        endDate = endDate.Date + ts;
                    }

                    var allproductsData = (from i in db.SZ_QuotationDetail
                                           join inv in db.SZ_Inventory on i.ProductId equals inv.ProductId
                                           //into ps
                                           //from inv in ps.DefaultIfEmpty()
                                           join t3 in db.SZ_MasterCOA on inv.Id equals t3.BatchId into psb
                                           from invb in psb.DefaultIfEmpty()
                                           where (i.CATNo != null || i.CATNo != "" || i.CATNo.Trim() != "" || i.CATNo.Trim().ToLower().StartsWith("sz-")) && i.CreatedDate >= startDate && i.CreatedDate <= endDate
                                           orderby i.CreatedDate descending
                                           select new ReTestModel
                                           {
                                               HPLC = invb != null ? invb.HPLCGCELSD : "",
                                               TGA = invb != null ? invb.TGALoss : "",
                                               QuoteId = i.QuoteId,
                                               RetestId = i.Id,
                                               BatchId = inv != null ? inv.Id : 0,
                                               BatchNo = inv != null ? inv.BatchNo : "",
                                               CASNo = i.CASNo,
                                               CATNo = i.CATNo,
                                               COAId = invb != null ? invb.Id : 0,
                                               ProductId = i.Id,
                                               ProductName = i.ProductName,
                                               QTY = inv != null ? inv.Qty : 0,
                                               ReTestdate = invb != null ? invb.ReTestDate : null,
                                               AnalysisDate = invb != null ? invb.AnalysisDate : null,
                                               RetestRemark = inv != null ? inv.ReTestRemark : "",
                                               QuotationRef = i.SZ_Quotation.Ref,
                                               CompanyName = i.SZ_Quotation.CompanyName,
                                               QuotationCreateddate = i.SZ_Quotation.CreatedDate
                                           }).ToList();


                    allproductsData = allproductsData.Where(i => (i.CATNo != null || i.CATNo != "") && i.QuotationCreateddate.HasValue ? (i.QuotationCreateddate.Value.Date >= startDate && i.QuotationCreateddate.Value.Date <= endDate) : false).ToList();
                    allproductsData = allproductsData.Where(x => !deletedRetest.Any(y => y == x.BatchId)).ToList();
                    model = (from i in allproductsData
                             orderby i.ProductName
                             select new ReTestModel
                             {
                                 HPLC = i.HPLC,
                                 TGA = i.TGA,
                                 QuoteId = i.QuoteId,
                                 FirstRow = "<input type='checkbox' value='" + i.BatchId + "' data-batchid'" + i.BatchId + "'   data-productid='" + i.ProductId + "' class='clsRetest' />",
                                 RetestId = i.RetestId,
                                 BatchId = i.BatchId,
                                 BatchNo = i.BatchNo,
                                 CASNo = i.CASNo,
                                 CATNo = i.CATNo,
                                 COAId = i.COAId,
                                 ProductId = i.ProductId,
                                 ProductName = i.ProductName,
                                 QTY = i.QTY,
                                 ReTestdate = i.ReTestdate,
                                 ReTestDateText = i.ReTestdate.HasValue ? i.ReTestdate.Value.ToShortDateString() : null,
                                 AnalysisDate = i.AnalysisDate,
                                 AnalysisDateText = i.AnalysisDate.HasValue ? i.AnalysisDate.Value.ToShortDateString() : null,
                                 APIName = categoryData.Where(x => x.ProductId == i.ProductId).Select(x => x.categoryName).FirstOrDefault(),
                                 RetestRemark = i.RetestRemark,
                                 QuotationRef = i.QuotationRef,
                                 CompanyName = i.CompanyName,
                                 QuotationCreateddate = i.QuotationCreateddate,
                                 CreatedDateText = i.QuotationCreateddate.HasValue ? i.QuotationCreateddate.Value.ToShortDateString() : "",
                                 RetestRemarkText = "<input type='text' style='width:100%'  id='remark_" + i.BatchId + "' value='" + i.RetestRemark + "'/>",
                                 Diffmonth = Common.GetMonthsBetween(i.AnalysisDate, i.ReTestdate),
                                 LastRow = "<i class='fa fa-times' onclick='deletebatchretest(" + i.BatchId + ")'></i>"
                             }).ToList();
                }

                else if (tabname == "retestlater")
                {


                    var RetestDatas = (from i in db.SZ_Retest
                                       join t2 in db.SZ_Inventory on i.InventoryId equals t2.Id
                                       join t3 in db.SZ_MasterCOA on t2.Id equals t3.BatchId
                                       where i.IsApproved == false && i.IsRetestLater == true && (i.IsCompleted == false || i.IsCompleted == null)
                                       select new ReTestModel
                                       {
                                           RetestId = i.Id,
                                           BatchId = t2.Id,
                                           BatchNo = t2.BatchNo,
                                           CASNo = t3 != null ? t3.CASNo : "",
                                           CATNo = t3 != null ? t3.CATNo : "",
                                           COAId = t3 != null ? t3.Id : 0,
                                           ProductId = t3 != null ? t3.ProductId : 0,
                                           ProductName = t3 != null ? t3.ProductName : "",
                                           QTY = t2.Qty,
                                           ReTestdate = t3 != null ? t3.ReTestDate : null,
                                           AnalysisDate = t3 != null ? t3.AnalysisDate : null,
                                           RetestRemark = t2.ReTestRemark,
                                           APIName = categoryData.Where(x => x.ProductId == (t3 != null ? t3.ProductId : 0)).Select(x => x.categoryName).FirstOrDefault(),
                                           HPLC = t3 != null ? t3.HPLCGCELSD : "",
                                           TGA = t3 != null ? t3.TGALoss : "",
                                       }).ToList();

                    var RetestData = (from t3 in RetestDatas
                                      select new ReTestModel
                                      {
                                          RetestId = t3.RetestId,
                                          BatchId = t3.BatchId,
                                          BatchNo = t3.BatchNo,
                                          CASNo = t3.CASNo,
                                          CATNo = t3.CATNo,
                                          COAId = t3.COAId,
                                          ProductId = t3.ProductId,
                                          ProductName = t3.ProductName,
                                          QTY = t3.QTY,
                                          ReTestdate = t3.ReTestdate,
                                          AnalysisDate = t3.AnalysisDate,
                                          AnalysisDateText = t3.AnalysisDate.HasValue ? t3.AnalysisDate.Value.ToShortDateString() : null,
                                          ReTestDateText = t3.ReTestdate.HasValue ? t3.ReTestdate.Value.ToShortDateString() : null,
                                          APIName = categoryData.Where(x => x.ProductId == t3.ProductId).Select(x => x.categoryName).FirstOrDefault(),
                                          RetestRemark = t3.RetestRemark,
                                          RetestRemarkText = "<input type='text' style='width:100%' id='remark_" + t3.RetestId + "'  data-batchid='" + t3.BatchId + "' value='" + t3.RetestRemark + "'/>",
                                          HPLC = t3.HPLC,
                                          TGA = t3.TGA,
                                          Diffmonth = Common.GetMonthsBetween(t3.AnalysisDate, t3.ReTestdate),
                                          LastRow = "<i class='fa fa-times' onclick='deletebatchretest(" + t3.BatchId + ")'></i>"
                                      }).ToList();

                    var datas = (from t2 in db.SZ_Inventory
                                 join t3 in db.SZ_MasterCOA on t2.Id equals t3.BatchId
                                 where t3.ReTestDate != null
                                 select new ReTestModel
                                 {
                                     BatchId = t2.Id,
                                     BatchNo = t2.BatchNo,
                                     CASNo = t3.CASNo,
                                     CATNo = t3.CATNo,
                                     COAId = t3.Id,
                                     ProductId = t3.ProductId,
                                     ProductName = t3.ProductName,
                                     QTY = t2.Qty,
                                     ReTestdate = t3.ReTestDate,
                                     RetestRemark = t2.ReTestRemark,
                                     APIName = categoryData.Where(x => x.ProductId == t3.ProductId).Select(x => x.categoryName).FirstOrDefault(),
                                     HPLC = t3 != null ? t3.HPLCGCELSD : "",
                                     TGA = t3 != null ? t3.TGALoss : "",
                                     AnalysisDate = t3 != null ? t3.AnalysisDate : null,
                                 }).ToList();

                    var ActuallRetestData = (from t2 in datas
                                             where t2.ReTestdate.Value.Date >= startDate && t2.ReTestdate.Value.Date <= endDate
                                             select new ReTestModel
                                             {
                                                 BatchId = t2.BatchId,
                                                 BatchNo = t2.BatchNo,
                                                 CASNo = t2.CASNo,
                                                 CATNo = t2.CATNo,
                                                 COAId = t2.COAId,
                                                 ProductId = t2.ProductId,
                                                 ProductName = t2.ProductName,
                                                 QTY = t2.QTY,
                                                 ReTestdate = t2.ReTestdate,
                                                 AnalysisDate = t2.AnalysisDate,
                                                 AnalysisDateText = t2.AnalysisDate.HasValue ? t2.AnalysisDate.Value.ToShortDateString() : null,
                                                 ReTestDateText = t2.ReTestdate.HasValue ? t2.ReTestdate.Value.ToShortDateString() : null,
                                                 APIName = t2.APIName,
                                                 RetestRemark = t2.RetestRemark,
                                                 RetestRemarkText = "<input type='text' style='width:100%' id='remark_" + t2.BatchId + "'  data-batchid='" + t2.BatchId + "' value='" + t2.RetestRemark + "'/>",
                                                 HPLC = t2.HPLC,
                                                 TGA = t2.TGA,
                                                 Diffmonth = Common.GetMonthsBetween(t2.AnalysisDate, t2.ReTestdate),
                                                 LastRow = "<i class='fa fa-times' onclick='deletebatchretest(" + t2.BatchId + ")'></i>"
                                             }).ToList();

                    if (tabname == "previous")
                    {
                        foreach (var item in ActuallRetestData)
                        {
                            if (!model.Select(x => x.BatchId).Contains(item.BatchId))
                            {
                                item.FirstRow = "<input type='checkbox' value='" + item.BatchId + "' data-productid='" + item.ProductId + "' class='clsRetest' />";
                                model.Add(item);
                            }
                        }
                    }
                    else if (tabname == "retest")
                    {
                        foreach (var item in RetestData)
                        {
                            if (!model.Select(x => x.BatchId).Contains(item.BatchId))
                            {
                                item.FirstRow = "<input type='checkbox' value='" + item.RetestId + "' data-productid='" + item.ProductId + "' class='clsRetest' />";
                                model.Add(item);
                            }
                        }
                    }
                    else if (tabname == "retestlater")
                    {
                        foreach (var item in RetestData)
                        {
                            if (!model.Select(x => x.BatchId).Contains(item.BatchId))
                            {
                                item.FirstRow = "<input type='checkbox' value='" + item.RetestId + "' data-productid='" + item.ProductId + "' class='clsRetest' />";
                                model.Add(item);
                            }
                        }
                    }

                    else
                    {
                        //Upcomming records

                        foreach (var item in ActuallRetestData)
                        {
                            if (!model.Select(x => x.BatchId).Contains(item.BatchId))
                            {
                                item.FirstRow = "<input type='checkbox' value='" + item.BatchId + "' data-productid='" + item.ProductId + "' class='clsRetest' />";
                                model.Add(item);
                            }
                        }

                        if (!string.IsNullOrEmpty(ApiName) && ApiName != "0")
                        {
                            model = model.Where(x => x.APIName.Trim() == ApiName.Trim()).ToList();
                        }
                    }
                }

                else if (tabname == "previous")
                {

                    if (startDate == DateTime.MinValue)
                    {
                        setDefaultdate = true;
                        startDate = DateTime.Now.AddYears(5).Date;
                    }
                    if (endDate == DateTime.MinValue)
                    {
                        setDefaultdate = true;
                        endDate = DateTime.Now.AddDays(-1).Date;
                    }

                    var catNos = (from t2 in db.SZ_Inventory
                                  join t3 in db.SZ_MasterCOA on t2.Id equals t3.BatchId
                                  where t3.ReTestDate != null && t3.ReTestDate >= startDate && t3.ReTestDate <= endDate
                                  select t3.CATNo).Distinct().ToList();

                    var datas = (from i in db.Products
                                 join t2 in db.SZ_Inventory on i.Id equals t2.ProductId into ps
                                 //join i in db.SZ_Inventory on p.Id equals i.ProductId into ps
                                 from inv in ps.DefaultIfEmpty()
                                 join t3 in db.SZ_MasterCOA on inv.Id equals t3.BatchId into psb
                                 from invb in psb.DefaultIfEmpty()
                                 where catNos.Contains(i.Sku) && !i.Deleted && i.Published
                                 orderby i.Sku.Replace("SZ-", "")

                                 select new ReTestModel
                                 {
                                     BatchId = inv != null ? inv.Id : 0,
                                     BatchNo = inv != null ? inv.BatchNo : "",
                                     CASNo = i.ManufacturerPartNumber,
                                     CATNo = i.Sku,
                                     COAId = invb != null ? invb.Id : 0,
                                     ProductId = inv != null ? inv.ProductId : 0,
                                     ProductName = i.Name,
                                     QTY = inv != null ? inv.Qty : 0,
                                     ReTestdate = invb != null ? invb.ReTestDate : null,
                                     AnalysisDate = invb != null ? invb.AnalysisDate : null,
                                     RetestRemark = inv != null ? inv.ReTestRemark : "",
                                     APIName = inv != null ? categoryData.Where(x => x.ProductId == inv.ProductId).Select(x => x.categoryName).FirstOrDefault() : "",
                                     HPLC = invb != null ? invb.HPLCGCELSD : "",
                                     TGA = invb != null ? invb.TGALoss : "",
                                 }).ToList();
                    datas = datas.Where(x => !deletedRetest.Any(y => y == x.BatchId)).ToList();
                    var ActuallRetestData = (from t2 in datas
                                                 //where t2.ReTestdate.Value.Date >= startDate && t2.ReTestdate.Value.Date <= endDate
                                             select new ReTestModel
                                             {
                                                 FirstRow = "<input type='checkbox' value='" + t2.BatchId + "' data-productid='" + t2.ProductId + "' class='clsRetest' />",
                                                 BatchId = t2.BatchId,
                                                 BatchNo = t2.BatchNo,
                                                 CASNo = t2.CASNo,
                                                 CATNo = t2.CATNo,
                                                 COAId = t2.COAId,
                                                 ProductId = t2.ProductId,
                                                 ProductName = t2.ProductName,
                                                 QTY = t2.QTY,
                                                 ReTestdate = t2.ReTestdate,
                                                 AnalysisDate = t2.AnalysisDate,
                                                 AnalysisDateText = t2.AnalysisDate.HasValue ? t2.AnalysisDate.Value.ToShortDateString() : null,
                                                 ReTestDateText = t2.ReTestdate.HasValue ? t2.ReTestdate.Value.ToShortDateString() : null,
                                                 APIName = t2.APIName,
                                                 RetestRemark = t2.RetestRemark,
                                                 RetestRemarkText = "<input type='text'  style='width:100%' id='remark_" + t2.BatchId + "'  data-batchid='" + t2.BatchId + "' value='" + t2.RetestRemark + "'/>",
                                                 HPLC = t2.HPLC,
                                                 TGA = t2.TGA,
                                                 Diffmonth = Common.GetMonthsBetween(t2.AnalysisDate, t2.ReTestdate),
                                                 LastRow = "<i class='fa fa-times' onclick='deletebatchretest(" + t2.BatchId + ")'></i>"
                                             }).ToList();

                    model = ActuallRetestData;
                }

                else if (tabname == "completed")
                {
                    var RetestDatas = (from i in db.SZ_Retest
                                       join t2 in db.SZ_Inventory on i.InventoryId equals t2.Id
                                       join t3 in db.SZ_MasterCOA on t2.Id equals t3.BatchId
                                       where i.IsApproved == true && (i.IsCompleted == false || i.IsCompleted == null)
                                       select new ReTestModel
                                       {
                                           RetestId = i.Id,
                                           BatchId = t2.Id,
                                           BatchNo = t2.BatchNo,
                                           CASNo = t3 != null ? t3.CASNo : "",
                                           CATNo = t3 != null ? t3.CATNo : "",
                                           COAId = t3 != null ? t3.Id : 0,
                                           ProductId = t3 != null ? t3.ProductId : 0,
                                           ProductName = t3 != null ? t3.ProductName : "",
                                           QTY = t2.Qty,
                                           ReTestdate = t3 != null ? t3.ReTestDate : null,
                                           AnalysisDate = t3 != null ? t3.AnalysisDate : null,
                                           RetestRemark = t2.ReTestRemark,
                                           HPLC = t3 != null ? t3.HPLCGCELSD : "",
                                           TGA = t3 != null ? t3.TGALoss : "",
                                           APIName = categoryData.Where(x => x.ProductId == (t3 != null ? t3.ProductId : 0)).Select(x => x.categoryName).FirstOrDefault()
                                       }).ToList();

                    var RetestData = (from t3 in RetestDatas
                                      select new ReTestModel
                                      {
                                          RetestId = t3.RetestId,
                                          BatchId = t3.BatchId,
                                          BatchNo = t3.BatchNo,
                                          CASNo = t3.CASNo,
                                          CATNo = t3.CATNo,
                                          COAId = t3.COAId,
                                          ProductId = t3.ProductId,
                                          ProductName = t3.ProductName,
                                          QTY = t3.QTY,
                                          ReTestdate = t3.ReTestdate,
                                          ReTestDateText = t3.ReTestdate.HasValue ? t3.ReTestdate.Value.ToShortDateString() : null,
                                          AnalysisDate = t3.AnalysisDate,
                                          AnalysisDateText = t3.AnalysisDate.HasValue ? t3.AnalysisDate.Value.ToShortDateString() : null,
                                          Diffmonth = Common.GetMonthsBetween(t3.AnalysisDate, t3.ReTestdate),
                                          APIName = categoryData.Where(x => x.ProductId == t3.ProductId).Select(x => x.categoryName).FirstOrDefault(),
                                          RetestRemark = t3.RetestRemark,
                                          HPLC = t3.HPLC,
                                          TGA = t3.TGA,
                                          RetestRemarkText = "<input type='text'  style='width:100%' id='remark_" + t3.RetestId + "' data-batchid='" + t3.BatchId + "' value='" + t3.RetestRemark + "'/>",
                                      }).ToList();

                    var datas = (from t2 in db.SZ_Inventory
                                 join t3 in db.SZ_MasterCOA on t2.Id equals t3.BatchId
                                 where t3.ReTestDate != null
                                 select new ReTestModel
                                 {
                                     BatchId = t2.Id,
                                     BatchNo = t2.BatchNo,
                                     CASNo = t3.CASNo,
                                     CATNo = t3.CATNo,
                                     COAId = t3.Id,
                                     ProductId = t3.ProductId,
                                     ProductName = t3.ProductName,
                                     QTY = t2.Qty,
                                     ReTestdate = t3.ReTestDate,
                                     AnalysisDate = t3.AnalysisDate,
                                     APIName = categoryData.Where(x => x.ProductId == t3.ProductId).Select(x => x.categoryName).FirstOrDefault(),
                                     RetestRemark = t2.ReTestRemark,
                                     HPLC = t3 != null ? t3.HPLCGCELSD : "",
                                     TGA = t3 != null ? t3.TGALoss : "",
                                 }).ToList();

                    var ActuallRetestData = (from t2 in datas
                                             where t2.ReTestdate.Value.Date >= startDate && t2.ReTestdate.Value.Date <= endDate
                                             select new ReTestModel
                                             {
                                                 BatchId = t2.BatchId,
                                                 BatchNo = t2.BatchNo,
                                                 CASNo = t2.CASNo,
                                                 CATNo = t2.CATNo,
                                                 COAId = t2.COAId,
                                                 ProductId = t2.ProductId,
                                                 ProductName = t2.ProductName,
                                                 QTY = t2.QTY,
                                                 ReTestdate = t2.ReTestdate,
                                                 ReTestDateText = t2.ReTestdate.HasValue ? t2.ReTestdate.Value.ToShortDateString() : null,
                                                 AnalysisDate = t2.AnalysisDate,
                                                 AnalysisDateText = t2.AnalysisDate.HasValue ? t2.AnalysisDate.Value.ToShortDateString() : null,
                                                 APIName = t2.APIName,
                                                 RetestRemark = t2.RetestRemark,
                                                 RetestRemarkText = "<input type='text'  style='width:100%' id='remark_" + t2.BatchId + "' data-batchid='" + t2.BatchId + "' value='" + t2.RetestRemark + "'/>",
                                                 HPLC = t2.HPLC,
                                                 TGA = t2.TGA,
                                                 Diffmonth = Common.GetMonthsBetween(t2.AnalysisDate, t2.ReTestdate)
                                             }).ToList();

                    if (tabname == "previous")
                    {
                        foreach (var item in ActuallRetestData)
                        {
                            if (!model.Select(x => x.BatchId).Contains(item.BatchId))
                            {
                                item.FirstRow = "<input type='checkbox' value='" + item.BatchId + "' data-batchid'" + item.BatchId + "' data-productid='" + item.ProductId + "' class='clsRetest' />";
                                model.Add(item);
                            }
                        }
                    }
                    else if (tabname == "retest")
                    {
                        foreach (var item in RetestData)
                        {
                            if (!model.Select(x => x.BatchId).Contains(item.BatchId))
                            {
                                item.FirstRow = "<input type='checkbox' value='" + item.RetestId + "' data-batchid'" + item.BatchId + "'   data-productid='" + item.ProductId + "' class='clsRetest' />";
                                model.Add(item);
                            }
                        }
                    }
                    else if (tabname == "completed")
                    {
                        foreach (var item in RetestData)
                        {
                            if (!model.Select(x => x.BatchId).Contains(item.BatchId))
                            {
                                item.FirstRow = "<input type='checkbox' value='" + item.RetestId + "' data-batchid'" + item.BatchId + "'   data-productid='" + item.ProductId + "' class='clsRetest' />";
                                model.Add(item);
                            }
                        }
                    }
                    else if (tabname == "retestlater")
                    {
                        foreach (var item in RetestData)
                        {
                            if (!model.Select(x => x.BatchId).Contains(item.BatchId))
                            {
                                item.FirstRow = "<input type='checkbox' value='" + item.RetestId + "' data-batchid'" + item.BatchId + "'   data-productid='" + item.ProductId + "' class='clsRetest' />";
                                model.Add(item);
                            }
                        }
                    }

                    else
                    {
                        //Upcomming records

                        foreach (var item in ActuallRetestData)
                        {
                            if (!model.Select(x => x.BatchId).Contains(item.BatchId))
                            {
                                item.FirstRow = "<input type='checkbox' value='" + item.BatchId + "' data-batchid'" + item.BatchId + "'   data-productid='" + item.ProductId + "' class='clsRetest' />";
                                model.Add(item);
                            }
                        }
                    }
                }

                else if (tabname == "deleted")
                {
                    var RetestDatas = (from i in db.SZ_DeleteRetest
                                       join t2 in db.SZ_Inventory on i.BatchId equals t2.Id
                                       join t3 in db.SZ_MasterCOA on t2.Id equals t3.BatchId
                                       select new ReTestModel
                                       {
                                           RetestId = i.Id,
                                           BatchId = t2.Id,
                                           BatchNo = t2.BatchNo,
                                           CASNo = t3 != null ? t3.CASNo : "",
                                           CATNo = t3 != null ? t3.CATNo : "",
                                           COAId = t3 != null ? t3.Id : 0,
                                           ProductId = t3 != null ? t3.ProductId : 0,
                                           ProductName = t3 != null ? t3.ProductName : "",
                                           QTY = t2.Qty,
                                           ReTestdate = t3 != null ? t3.ReTestDate : null,
                                           AnalysisDate = t3 != null ? t3.AnalysisDate : null,
                                           RetestRemark = t2.ReTestRemark,
                                           HPLC = t3 != null ? t3.HPLCGCELSD : "",
                                           TGA = t3 != null ? t3.TGALoss : "",
                                           APIName = categoryData.Where(x => x.ProductId == (t3 != null ? t3.ProductId : 0)).Select(x => x.categoryName).FirstOrDefault()
                                       }).ToList();

                    var RetestData = (from t3 in RetestDatas
                                      select new ReTestModel
                                      {
                                          RetestId = t3.RetestId,
                                          BatchId = t3.BatchId,
                                          BatchNo = t3.BatchNo,
                                          CASNo = t3.CASNo,
                                          CATNo = t3.CATNo,
                                          COAId = t3.COAId,
                                          ProductId = t3.ProductId,
                                          ProductName = t3.ProductName,
                                          QTY = t3.QTY,
                                          ReTestdate = t3.ReTestdate,
                                          ReTestDateText = t3.ReTestdate.HasValue ? t3.ReTestdate.Value.ToShortDateString() : null,
                                          AnalysisDate = t3.AnalysisDate,
                                          AnalysisDateText = t3.AnalysisDate.HasValue ? t3.AnalysisDate.Value.ToShortDateString() : null,
                                          Diffmonth = Common.GetMonthsBetween(t3.AnalysisDate, t3.ReTestdate),
                                          APIName = categoryData.Where(x => x.ProductId == t3.ProductId).Select(x => x.categoryName).FirstOrDefault(),
                                          RetestRemark = t3.RetestRemark,
                                          HPLC = t3.HPLC,
                                          TGA = t3.TGA,
                                          LastRow = "<a href='javascript:void(0)' onclick='resumedeleted(" + t3.BatchId + ")'>Resume</a>",
                                          RetestRemarkText = "<input type='text'  style='width:100%' id='remark_" + t3.BatchId + "' data-batchid='" + t3.BatchId + "' value='" + t3.RetestRemark + "'/>",
                                      }).ToList();

                    foreach (var item in RetestData)
                    {
                        if (!model.Select(x => x.BatchId).Contains(item.BatchId))
                        {
                            item.FirstRow = "<input type='checkbox' value='" + item.BatchId + "' data-batchid'" + item.BatchId + "'   data-productid='" + item.ProductId + "' class='clsRetest' />";
                            model.Add(item);
                        }
                    }
                }

                else
                {


                    var RetestDatas = (from i in db.SZ_Retest
                                       join t2 in db.SZ_Inventory on i.InventoryId equals t2.Id
                                       join t3 in db.SZ_MasterCOA on t2.Id equals t3.BatchId
                                       where i.IsApproved == false && i.IsRetestLater == false && (i.IsCompleted == false || i.IsCompleted == null)
                                       select new ReTestModel
                                       {
                                           RetestId = i.Id,
                                           BatchId = t2.Id,
                                           BatchNo = t2.BatchNo,
                                           CASNo = t3 != null ? t3.CASNo : "",
                                           CATNo = t3 != null ? t3.CATNo : "",
                                           COAId = t3 != null ? t3.Id : 0,
                                           ProductId = t3 != null ? t3.ProductId : 0,
                                           ProductName = t3 != null ? t3.ProductName : "",
                                           QTY = t2.Qty,
                                           ReTestdate = t3 != null ? t3.ReTestDate : null,
                                           AnalysisDate = t3 != null ? t3.AnalysisDate : null,
                                           RetestRemark = t2.ReTestRemark,
                                           HPLC = t3 != null ? t3.HPLCGCELSD : "",
                                           TGA = t3 != null ? t3.TGALoss : "",
                                           APIName = categoryData.Where(x => x.ProductId == (t3 != null ? t3.ProductId : 0)).Select(x => x.categoryName).FirstOrDefault()
                                       }).ToList();

                    var RetestData = (from t3 in RetestDatas
                                      select new ReTestModel
                                      {
                                          RetestId = t3.RetestId,
                                          BatchId = t3.BatchId,
                                          BatchNo = t3.BatchNo,
                                          CASNo = t3.CASNo,
                                          CATNo = t3.CATNo,
                                          COAId = t3.COAId,
                                          ProductId = t3.ProductId,
                                          ProductName = t3.ProductName,
                                          QTY = t3.QTY,
                                          ReTestdate = t3.ReTestdate,
                                          ReTestDateText = t3.ReTestdate.HasValue ? t3.ReTestdate.Value.ToShortDateString() : null,
                                          AnalysisDate = t3.AnalysisDate,
                                          AnalysisDateText = t3.AnalysisDate.HasValue ? t3.AnalysisDate.Value.ToShortDateString() : null,
                                          Diffmonth = Common.GetMonthsBetween(t3.AnalysisDate, t3.ReTestdate),
                                          APIName = categoryData.Where(x => x.ProductId == t3.ProductId).Select(x => x.categoryName).FirstOrDefault(),
                                          RetestRemark = t3.RetestRemark,
                                          HPLC = t3.HPLC,
                                          TGA = t3.TGA,
                                          RetestRemarkText = "<input type='text'  style='width:100%' id='remark_" + t3.RetestId + "' data-batchid='" + t3.BatchId + "' value='" + t3.RetestRemark + "'/>",
                                      }).ToList();

                    var datas = (from t2 in db.SZ_Inventory
                                 join t3 in db.SZ_MasterCOA on t2.Id equals t3.BatchId
                                 where t3.ReTestDate != null
                                 select new ReTestModel
                                 {
                                     BatchId = t2.Id,
                                     BatchNo = t2.BatchNo,
                                     CASNo = t3.CASNo,
                                     CATNo = t3.CATNo,
                                     COAId = t3.Id,
                                     ProductId = t3.ProductId,
                                     ProductName = t3.ProductName,
                                     QTY = t2.Qty,
                                     ReTestdate = t3.ReTestDate,
                                     AnalysisDate = t3.AnalysisDate,
                                     APIName = categoryData.Where(x => x.ProductId == t3.ProductId).Select(x => x.categoryName).FirstOrDefault(),
                                     RetestRemark = t2.ReTestRemark,
                                     HPLC = t3 != null ? t3.HPLCGCELSD : "",
                                     TGA = t3 != null ? t3.TGALoss : "",
                                 }).ToList();

                    var ActuallRetestData = (from t2 in datas
                                             where t2.ReTestdate.Value.Date >= startDate && t2.ReTestdate.Value.Date <= endDate
                                             select new ReTestModel
                                             {
                                                 BatchId = t2.BatchId,
                                                 BatchNo = t2.BatchNo,
                                                 CASNo = t2.CASNo,
                                                 CATNo = t2.CATNo,
                                                 COAId = t2.COAId,
                                                 ProductId = t2.ProductId,
                                                 ProductName = t2.ProductName,
                                                 QTY = t2.QTY,
                                                 ReTestdate = t2.ReTestdate,
                                                 ReTestDateText = t2.ReTestdate.HasValue ? t2.ReTestdate.Value.ToShortDateString() : null,
                                                 AnalysisDate = t2.AnalysisDate,
                                                 AnalysisDateText = t2.AnalysisDate.HasValue ? t2.AnalysisDate.Value.ToShortDateString() : null,
                                                 APIName = t2.APIName,
                                                 RetestRemark = t2.RetestRemark,
                                                 RetestRemarkText = "<input type='text'  style='width:100%' id='remark_" + t2.BatchId + "' data-batchid='" + t2.BatchId + "' value='" + t2.RetestRemark + "'/>",
                                                 HPLC = t2.HPLC,
                                                 TGA = t2.TGA,
                                                 Diffmonth = Common.GetMonthsBetween(t2.AnalysisDate, t2.ReTestdate)
                                             }).ToList();

                    if (tabname == "previous")
                    {
                        foreach (var item in ActuallRetestData)
                        {
                            if (!model.Select(x => x.BatchId).Contains(item.BatchId))
                            {
                                item.FirstRow = "<input type='checkbox' value='" + item.BatchId + "' data-batchid'" + item.BatchId + "' data-productid='" + item.ProductId + "' class='clsRetest' />";
                                model.Add(item);
                            }
                        }
                    }
                    else if (tabname == "retest")
                    {
                        foreach (var item in RetestData)
                        {
                            if (!model.Select(x => x.BatchId).Contains(item.BatchId))
                            {
                                item.FirstRow = "<input type='checkbox' value='" + item.RetestId + "' data-batchid'" + item.BatchId + "'   data-productid='" + item.ProductId + "' class='clsRetest' />";
                                model.Add(item);
                            }
                        }
                    }
                    else if (tabname == "retestlater")
                    {
                        foreach (var item in RetestData)
                        {
                            if (!model.Select(x => x.BatchId).Contains(item.BatchId))
                            {
                                item.FirstRow = "<input type='checkbox' value='" + item.RetestId + "' data-batchid'" + item.BatchId + "'   data-productid='" + item.ProductId + "' class='clsRetest' />";
                                model.Add(item);
                            }
                        }
                    }

                    else
                    {
                        //Upcomming records

                        foreach (var item in ActuallRetestData)
                        {
                            if (!model.Select(x => x.BatchId).Contains(item.BatchId))
                            {
                                item.FirstRow = "<input type='checkbox' value='" + item.BatchId + "' data-batchid'" + item.BatchId + "'   data-productid='" + item.ProductId + "' class='clsRetest' />";
                                model.Add(item);
                            }
                        }
                    }
                }

                if (!string.IsNullOrEmpty(ApiName) && ApiName != "0")
                {
                    model = model.Where(x => x.APIName.Trim() == ApiName.Trim()).ToList();
                }

                if (!string.IsNullOrEmpty(searchValue))
                {

                    searchValue = searchValue.ToLower();

                    model = model.Where(m => (m.APIName != null && m.APIName.ToLower().Contains(searchValue))
                                        || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                        || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                        || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                        || (m.QuotationRef != null && m.QuotationRef.ToLower().Contains(searchValue))
                                        || (m.CompanyName != null && m.CompanyName.ToLower().Contains(searchValue))
                                        || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                        || (m.ReTestDateText != null && m.ReTestDateText.ToLower().Contains(searchValue))
                                        || (m.AnalysisDateText != null && m.AnalysisDateText.ToLower().Contains(searchValue))).ToList();
                }

                if (setDefaultdate)
                {
                    startDate = DateTime.MinValue;
                    endDate = DateTime.MinValue;
                }
                if (startDate != null && startDate != DateTime.MinValue)
                {
                    model = model.Where(t2 => t2.ReTestdate.HasValue ? (t2.ReTestdate.Value.Date >= startDate) : false).ToList();
                }
                if (endDate != null && endDate != DateTime.MinValue)
                {
                    model = model.Where(t2 => t2.ReTestdate.HasValue ? (t2.ReTestdate.Value.Date <= endDate) : false).ToList();
                }

                //remove 0 qty
                model = model.Where(x => x.QTY != null && x.QTY.Value != 0).ToList();

                int? recordsTotal = model.Count;
                if (tabname == "all" || tabname == "upcomming")
                {
                    model = model.OrderBy(x => x.CATNo.Trim().Replace("SZ-", "")).ToList();
                    model = model.Skip(skip).Take(pageSize).ToList();
                }
                else if (tabname == "quote")
                {
                    model = model.OrderByDescending(x => x.QuotationCreateddate).ToList();
                    model = model.Skip(skip).Take(pageSize).ToList();
                }
                else if (tabname == "dispatch")
                {
                    model = model.OrderByDescending(x => x.PONumberDate).ToList();
                    model = model.Skip(skip).Take(pageSize).ToList();
                }
                else
                {
                    model = model.Skip(skip).Take(pageSize).OrderBy(x => x.ReTestdate).ToList();
                }

                return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = model });
            }
            catch (Exception ex)
            {
                throw ex;
            }

        }


        [HttpPost]
        [ValidateInput(false)]
        public ActionResult MovetoRetestData(List<int> id)
        {
            try
            {
                List<QuotationListModel> model = new List<QuotationListModel>();
                foreach (var item in id)
                {
                    var inventory = db.SZ_Inventory.Where(x => x.Id == item).FirstOrDefault();
                    var product = db.Products.Where(x => x.Id == inventory.ProductId).FirstOrDefault();
                    var checkdata = db.SZ_Retest.Where(x => x.InventoryId == item && x.IsApproved == false).FirstOrDefault();
                    if (checkdata == null)
                    {
                        SZ_Retest objCOA = new SZ_Retest();
                        objCOA.CatNo = product.Sku;
                        objCOA.InventoryId = item;
                        objCOA.Createddate = DateTime.Now;
                        objCOA.ProductId = product.Id;
                        objCOA.IsApproved = false;
                        objCOA.IsRetestLater = false;
                        objCOA.IsCompleted = false;
                        objCOA.CreatedBy = SessionCookieManagement.UserName;
                        db.Entry(objCOA).State = EntityState.Added;
                        db.SaveChanges();

                        if (inventory != null)
                        {
                            InsertLog("Move to retest", SessionCookieManagement.UserName + " has moved " + inventory.BatchNo + " in retest tab.");
                        }
                    }
                }

                return Json(new
                {
                    success = true,
                    message = "Re-test added successfully."
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {

                return Json(new
                {
                    success = false,
                    message = ex.Message + " / " + ex.StackTrace
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult MovetoRetestLaterData(List<int> id)
        {
            try
            {
                List<QuotationListModel> model = new List<QuotationListModel>();


                foreach (var item in id)
                {

                    var inventory = db.SZ_Inventory.Where(x => x.Id == item).FirstOrDefault();
                    var product = db.Products.Where(x => x.Id == inventory.ProductId).FirstOrDefault();
                    var checkdata = db.SZ_Retest.Where(x => x.InventoryId == item && x.IsApproved == false).FirstOrDefault();
                    if (checkdata == null)
                    {
                        SZ_Retest objCOA = new SZ_Retest();
                        objCOA.CatNo = product.Sku;
                        objCOA.InventoryId = item;
                        objCOA.Createddate = DateTime.Now;
                        objCOA.ProductId = product.Id;
                        objCOA.IsApproved = false;
                        objCOA.IsRetestLater = true;
                        objCOA.CreatedBy = SessionCookieManagement.UserName;
                        db.Entry(objCOA).State = EntityState.Added;
                        db.SaveChanges();

                        if (inventory != null)
                        {
                            InsertLog("Move to retest later", SessionCookieManagement.UserName + " has moved " + inventory.BatchNo + " in retest later tab.");
                        }
                    }
                }

                return Json(new
                {
                    success = true,
                    message = "Re-test added successfully."
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {

                return Json(new
                {
                    success = false,
                    message = ex.Message + " / " + ex.StackTrace
                }, JsonRequestBehavior.AllowGet);
            }
        }


        [HttpPost]
        [ValidateInput(false)]
        public ActionResult MovetoRetestApproved(List<int> id)
        {
            try
            {
                List<QuotationListModel> model = new List<QuotationListModel>();


                foreach (var item in id)
                {
                    var retestData = db.SZ_Retest.Where(x => x.Id == item).FirstOrDefault();

                    if (retestData != null)
                    {
                        retestData.IsApproved = true;
                        retestData.ApprovedDate = DateTime.Now;
                        db.Entry(retestData).State = EntityState.Modified;
                        db.SaveChanges();

                        var inv = db.SZ_Inventory.Where(x => x.Id == retestData.InventoryId).FirstOrDefault();
                        if (inv != null)
                        {
                            InsertLog("Move to retest approved", SessionCookieManagement.UserName + " has approved " + inv.BatchNo + " batch nos.");
                        }
                    }
                }

                return Json(new
                {
                    success = true,
                    message = "Re-test approved successfully."
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {

                return Json(new
                {
                    success = false,
                    message = ex.Message + " / " + ex.StackTrace
                }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult MovetoComplete(List<int> id)
        {
            try
            {
                List<QuotationListModel> model = new List<QuotationListModel>();


                foreach (var item in id)
                {
                    var retestData = db.SZ_Retest.Where(x => x.Id == item).FirstOrDefault();

                    if (retestData != null)
                    {
                        retestData.IsCompleted = true;
                        retestData.CompletedDate = DateTime.Now;
                        db.Entry(retestData).State = EntityState.Modified;
                        db.SaveChanges();

                        var inv = db.SZ_Inventory.Where(x => x.Id == retestData.InventoryId).FirstOrDefault();
                        if (inv != null)
                        {
                            InsertLog("Move to retest completed", SessionCookieManagement.UserName + " has completed coa of " + inv.BatchNo + " batch no.");
                        }
                    }
                }

                return Json(new
                {
                    success = true,
                    message = "Re-test completed successfully."
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {

                return Json(new
                {
                    success = false,
                    message = ex.Message + " / " + ex.StackTrace
                }, JsonRequestBehavior.AllowGet);
            }
        }


        [HttpPost]
        [ValidateInput(false)]
        public ActionResult MovetoRetestFromLater(List<int> id)
        {
            try
            {
                List<QuotationListModel> model = new List<QuotationListModel>();


                foreach (var item in id)
                {
                    var retestData = db.SZ_Retest.Where(x => x.Id == item).FirstOrDefault();

                    if (retestData != null)
                    {
                        retestData.IsRetestLater = false;
                        db.Entry(retestData).State = EntityState.Modified;
                        db.SaveChanges();

                        var inv = db.SZ_Inventory.Where(x => x.Id == retestData.InventoryId).FirstOrDefault();
                        if (inv != null)
                        {
                            InsertLog("Move to retest", SessionCookieManagement.UserName + " has moved " + inv.BatchNo + " batch no to retest from retest later tab.");
                        }
                    }
                }

                return Json(new
                {
                    success = true,
                    message = "Re-test approved successfully."
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {

                return Json(new
                {
                    success = false,
                    message = ex.Message + " / " + ex.StackTrace
                }, JsonRequestBehavior.AllowGet);
            }
        }


        [HttpPost]
        [ValidateInput(false)]
        public ActionResult MovetoRetestLaterFromRetest(List<int> id)
        {
            try
            {
                List<QuotationListModel> model = new List<QuotationListModel>();


                foreach (var item in id)
                {
                    var retestData = db.SZ_Retest.Where(x => x.Id == item).FirstOrDefault();

                    if (retestData != null)
                    {
                        retestData.IsRetestLater = true;
                        db.Entry(retestData).State = EntityState.Modified;
                        db.SaveChanges();

                        var inv = db.SZ_Inventory.Where(x => x.Id == retestData.InventoryId).FirstOrDefault();
                        if (inv != null)
                        {
                            InsertLog("Move to retest later", SessionCookieManagement.UserName + " has moved " + inv.BatchNo + " batch no to retest later from retest tab.");
                        }
                    }
                }

                return Json(new
                {
                    success = true,
                    message = "Re-test approved successfully."
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {

                return Json(new
                {
                    success = false,
                    message = ex.Message + " / " + ex.StackTrace
                }, JsonRequestBehavior.AllowGet);
            }
        }


        [HttpPost]
        [ValidateInput(false)]
        public ActionResult ReTestSave(List<ReTestModel> paramdata)
        {
            try
            {
                List<QuotationListModel> model = new List<QuotationListModel>();


                foreach (var item in paramdata)
                {
                    var inventoryData = db.SZ_Inventory.Where(x => x.Id == item.BatchId).FirstOrDefault();

                    if (inventoryData != null)
                    {
                        inventoryData.ReTestRemark = item.RetestRemark;
                        db.Entry(inventoryData).State = EntityState.Modified;
                        db.SaveChanges();

                        InsertLog("Retest remark updated", SessionCookieManagement.UserName + " has updated remark of " + inventoryData.BatchNo + " batch no.");
                    }
                }

                return Json(new
                {
                    success = true,
                    message = "Re-test remark added successfully."
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {

                return Json(new
                {
                    success = false,
                    message = ex.Message + " / " + ex.StackTrace
                }, JsonRequestBehavior.AllowGet);
            }
        }

        public void InsertLog(string Action, string Message)
        {
            SZ_Log objLog = new SZ_Log();
            objLog.Id = Guid.NewGuid();
            objLog.Action = Action;
            objLog.CreatedDate = DateTime.Now;
            objLog.Message = Message;
            objLog.UserId = SessionCookieManagement.UserId;
            db.SZ_Log.Add(objLog);
            db.SaveChanges();
        }

        public ActionResult Deleteretest(int id)
        {
            SZ_DeleteRetest objretest = new SZ_DeleteRetest();
            objretest.Createddate = DateTime.Now;
            objretest.BatchId = id;
            db.SZ_DeleteRetest.Add(objretest);
            db.SaveChanges();

            var inventoryData = db.SZ_Inventory.Where(x => x.Id == id).FirstOrDefault();
            if (inventoryData != null)
            {
                InsertLog("Retest Delete", SessionCookieManagement.UserName + " has deleted " + inventoryData.BatchNo + " batch no from retest module.");
            }
            return Json(new
            {
                success = true
            }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult resumedeletedretest(int id)
        {
            SZ_DeleteRetest objretest = db.SZ_DeleteRetest.Where(x => x.BatchId == id).FirstOrDefault();
            if (objretest != null)
            {
                db.Entry(objretest).State = EntityState.Deleted;
                db.SaveChanges();
            }

            var inventoryData = db.SZ_Inventory.Where(x => x.Id == id).FirstOrDefault();
            if (inventoryData != null)
            {
                InsertLog("Retest Resume", SessionCookieManagement.UserName + " has resumed " + inventoryData.BatchNo + " batch no from retest module.");
            }
            return Json(new
            {
                success = true
            }, JsonRequestBehavior.AllowGet);
        }

        [HttpGet]
        public ActionResult SaveReadyToSendQuoteDetails(int id)
        {
            var quote = _operationRepository.GetQuoteByID(id);
            if (quote != null)
            {
                quote.IsToBe = false;
                quote.IsQuoteApproved = false;
                quote.IsInstock = false;
                quote.IsCustomSynthesis = false;
                quote.IsCOA = false;
                quote.IsAnalyticalData = false;
                db.Entry(quote).State = EntityState.Modified;
                db.SaveChanges();
            }

            return Json(new
            {
                success = true
            }, JsonRequestBehavior.AllowGet);
        }

        public void PrepareQuoteLog(SZ_Quotation Newdatamodel, SZ_Quotation Olddatamodel)
        {
            MemoryCacheManager objCache = new MemoryCacheManager();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });
            foreach (var prop in Newdatamodel.GetType().GetProperties())
            {
                string name = prop.Name;
                object value = prop.GetValue(Newdatamodel, null);

                foreach (var oldprop in Olddatamodel.GetType().GetProperties())
                {
                    string oldname = oldprop.Name;
                    object oldvalue = oldprop.GetValue(Olddatamodel, null);
                    if (oldname == name)
                    {
                        if (Convert.ToString(value) != Convert.ToString(oldvalue))
                        {
                            string fieldname = findfieldname(name);
                            if (!string.IsNullOrEmpty(fieldname))
                            {
                                if (fieldname == "Scientist")
                                {
                                    int oldscid = !string.IsNullOrEmpty(Convert.ToString(oldvalue)) ? Convert.ToInt32(oldvalue) : 0;
                                    int newscid = !string.IsNullOrEmpty(Convert.ToString(value)) ? Convert.ToInt32(value) : 0;
                                    var scienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("scientist")).ToList();
                                    var oldscdata = scienList.Where(x => x.Id == oldscid).FirstOrDefault();
                                    var newscdata = scienList.Where(x => x.Id == newscid).FirstOrDefault();
                                    if (oldscdata != null)
                                    {
                                        var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == oldscdata.Id).ToList();
                                        if (genericAttr.Count > 0)
                                        {
                                            oldvalue = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                                        }
                                    }
                                    if (newscdata != null)
                                    {
                                        var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == newscdata.Id).ToList();
                                        if (genericAttr.Count > 0)
                                        {
                                            value = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                                        }
                                    }
                                }

                                if (fieldname == "Project Status")
                                {
                                    EnumList.ProjectStatus oldfoo = (EnumList.ProjectStatus)Enum.ToObject(typeof(EnumList.ProjectStatus), oldvalue);
                                    oldvalue = Common.GetDescription<EnumList.ProjectStatus>(oldfoo);

                                    EnumList.ProjectStatus newfoo = (EnumList.ProjectStatus)Enum.ToObject(typeof(EnumList.ProjectStatus), value);
                                    value = Common.GetDescription<EnumList.ProjectStatus>(newfoo);
                                }

                                if (fieldname == "Project Type")
                                {
                                    int ov = Convert.ToInt32(oldvalue);
                                    int nv = Convert.ToInt32(value);
                                    EnumList.ProjectType oldfoo = (EnumList.ProjectType)Enum.ToObject(typeof(EnumList.ProjectType), ov);
                                    oldvalue = Common.GetDescription<EnumList.ProjectType>(oldfoo);

                                    EnumList.ProjectType newfoo = (EnumList.ProjectType)Enum.ToObject(typeof(EnumList.ProjectType), nv);
                                    value = Common.GetDescription<EnumList.ProjectType>(newfoo);
                                }

                                SZ_QuotationDetailLog objhis = new SZ_QuotationDetailLog();
                                objhis.QuoteId = Olddatamodel.Id;
                                objhis.QuoteDetailsId = 0;
                                objhis.QuoteRef = Newdatamodel.Ref;
                                objhis.Username = SessionCookieManagement.UserName;
                                objhis.Datetime = System.DateTime.Now;
                                objhis.PropertyName = name;
                                objhis.FieldName = fieldname; // need to change
                                objhis.Before = Convert.ToString(oldvalue);
                                objhis.After = Convert.ToString(value);
                                objhis.UserId = SessionCookieManagement.UserId;
                                db.SZ_QuotationDetailLog.Add(objhis);

                            }
                        }
                    }
                }
            }
            db.SaveChanges();
        }
        public void PrepareProjectLog(SZ_QuotationDetail Newdatamodel, SZ_QuotationDetail Olddatamodel, string tabname)
        {

            var allarray = new List<string>
            {
                "COARefNumber",
                "ScientistStatus",
                "Remark",
                "ScientistCustomerId",
                "ProjectType",
                //"ProcessState",
                //"LastStatus",
                "AdminScientistStatus",
                //"PreviousEstCompleteDate",
                "EstimateCompleteDate",
                "Reason",
                "OrderRemark",
                "SubScientistName",
                "DifficultyLevel",
                //"PreviousStatus",
                //"LastProStatus",
                "ProStatus",
                //"OtherProStatus",
                //"DispatchStatus",
                //"ReviewSciStatus",
                //"LastWeekUpdate",
                "ExplainationSecond",
                "ActivityStatus"
            };

            MemoryCacheManager objCache = new MemoryCacheManager();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });
            var listItems = new List<SelectListItem>();
            var scienList = objCache.Get("cache.GetScientistId", () =>
            {
                return db.GetScientistId().ToList();
            });

            scienList.ForEach(term =>
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                listItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.ToString()
                });
            });
            foreach (var prop in Newdatamodel.GetType().GetProperties())
            {
                string name = prop.Name;
                object value = prop.GetValue(Newdatamodel, null);

                foreach (var oldprop in Olddatamodel.GetType().GetProperties())
                {
                    string oldname = oldprop.Name;
                    object oldvalue = oldprop.GetValue(Olddatamodel, null);
                    if (oldname == name)
                    {
                        if (Convert.ToString(value) != Convert.ToString(oldvalue))
                        {
                            if (allarray.Contains(name))
                            {
                                if (name == "LastProStatus" ||
                                    name == "ProStatus" ||
                                    name == "OtherProStatus" ||
                                    name == "DispatchStatus" ||
                                    name == "ReviewSciStatus" ||
                                    name == "PreviousStatus")
                                {
                                    oldvalue = Common.GetProStatus(Convert.ToString(oldvalue));
                                    value = Common.GetProStatus(Convert.ToString(value));
                                }
                                if (name == "ProjectStatus")
                                {
                                    EnumList.ProjectStatus oldfoo = (EnumList.ProjectStatus)Enum.ToObject(typeof(EnumList.ProjectStatus), oldvalue);
                                    oldvalue = Common.GetDescription<EnumList.ProjectStatus>(oldfoo);

                                    EnumList.ProjectStatus newfoo = (EnumList.ProjectStatus)Enum.ToObject(typeof(EnumList.ProjectStatus), value);
                                    value = Common.GetDescription<EnumList.ProjectStatus>(newfoo);
                                }
                                if (name == "ProjectStatus")
                                {
                                    EnumList.ProjectStatus oldfoo = (EnumList.ProjectStatus)Enum.ToObject(typeof(EnumList.ProjectStatus), oldvalue);
                                    oldvalue = Common.GetDescription<EnumList.ProjectStatus>(oldfoo);

                                    EnumList.ProjectStatus newfoo = (EnumList.ProjectStatus)Enum.ToObject(typeof(EnumList.ProjectStatus), value);
                                    value = Common.GetDescription<EnumList.ProjectStatus>(newfoo);
                                }
                                if (name == "ProcessState")
                                {
                                    int ov = Convert.ToInt32(oldvalue);
                                    int nv = Convert.ToInt32(value);
                                    EnumList.ProcessState oldfoo = (EnumList.ProcessState)Enum.ToObject(typeof(EnumList.ProcessState), ov);
                                    oldvalue = Common.GetDescription<EnumList.ProcessState>(oldfoo);

                                    EnumList.ProcessState newfoo = (EnumList.ProcessState)Enum.ToObject(typeof(EnumList.ProcessState), nv);
                                    value = Common.GetDescription<EnumList.ProcessState>(newfoo);
                                }

                                if (name == "ProjectType")
                                {
                                    name = "Project Type";
                                }
                                if (name == "ProStatus")
                                {
                                    name = "Status";
                                }
                                if (name == "ExplainationSecond")
                                {
                                    name = "Sec. Explaination";
                                }
                                if (name == "Remark")
                                {
                                    name = "Data Remark";
                                }
                                if (name == "OrderRemark")
                                {
                                    name = "Order Remark";
                                }
                                if (name == "ScientistCustomerId")
                                {
                                    foreach (var r in listItems)
                                    {
                                        string selected = string.Empty;
                                        if (r.Value == Convert.ToString(oldvalue))
                                        {
                                            oldvalue = r.Text;
                                        }
                                        if (r.Value == Convert.ToString(value))
                                        {
                                            value = r.Text;
                                        }
                                    }
                                    name = "Scientist";
                                }
                                if (name == "SubScientistName")
                                {
                                    foreach (var r in listItems)
                                    {
                                        string selected = string.Empty;
                                        if (r.Value == Convert.ToString(oldvalue))
                                        {
                                            oldvalue = r.Text;
                                        }
                                        if (r.Value == Convert.ToString(value))
                                        {
                                            value = r.Text;
                                        }
                                    }
                                    name = "Sub Scientist";
                                }
                                SZ_QuotationDetailLog objhis = new SZ_QuotationDetailLog();
                                objhis.QuoteId = Olddatamodel.QuoteId;
                                objhis.QuoteDetailsId = Newdatamodel.Id;
                                objhis.QuoteRef = Newdatamodel.SZ_Quotation.Ref;
                                objhis.Username = SessionCookieManagement.UserName;
                                objhis.Datetime = System.DateTime.Now;
                                objhis.PropertyName = name;
                                objhis.FieldName = name; // need to change
                                objhis.Before = Convert.ToString(oldvalue);
                                objhis.After = Convert.ToString(value);
                                objhis.UserId = SessionCookieManagement.UserId;
                                db.SZ_QuotationDetailLog.Add(objhis);

                            }
                        }
                    }
                }
            }

            db.SaveChanges();
        }

        public void PrepareQuoteDetailsLog(SZ_QuotationDetail Newdatamodel, SZ_QuotationDetail Olddatamodel)
        {
            MemoryCacheManager objCache = new MemoryCacheManager();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });
            foreach (var prop in Newdatamodel.GetType().GetProperties())
            {
                string name = prop.Name;
                object value = prop.GetValue(Newdatamodel, null);

                foreach (var oldprop in Olddatamodel.GetType().GetProperties())
                {
                    string oldname = oldprop.Name;
                    object oldvalue = oldprop.GetValue(Olddatamodel, null);
                    if (oldname == name)
                    {
                        if (Convert.ToString(value) != Convert.ToString(oldvalue))
                        {
                            string fieldname = findfieldname(name);
                            if (!string.IsNullOrEmpty(fieldname))
                            {
                                if (fieldname == "Scientist")
                                {
                                    int oldscid = !string.IsNullOrEmpty(Convert.ToString(oldvalue)) ? Convert.ToInt32(oldvalue) : 0;
                                    int newscid = !string.IsNullOrEmpty(Convert.ToString(value)) ? Convert.ToInt32(value) : 0;
                                    var scienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("scientist")).ToList();
                                    var oldscdata = scienList.Where(x => x.Id == oldscid).FirstOrDefault();
                                    var newscdata = scienList.Where(x => x.Id == newscid).FirstOrDefault();
                                    if (oldscdata != null)
                                    {
                                        var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == oldscdata.Id).ToList();
                                        if (genericAttr.Count > 0)
                                        {
                                            oldvalue = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                                        }
                                    }
                                    if (newscdata != null)
                                    {
                                        var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == newscdata.Id).ToList();
                                        if (genericAttr.Count > 0)
                                        {
                                            value = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                                        }
                                    }
                                }

                                if (fieldname == "Project Status")
                                {
                                    EnumList.ProjectStatus oldfoo = (EnumList.ProjectStatus)Enum.ToObject(typeof(EnumList.ProjectStatus), oldvalue);
                                    oldvalue = Common.GetDescription<EnumList.ProjectStatus>(oldfoo);

                                    EnumList.ProjectStatus newfoo = (EnumList.ProjectStatus)Enum.ToObject(typeof(EnumList.ProjectStatus), value);
                                    value = Common.GetDescription<EnumList.ProjectStatus>(newfoo);
                                }

                                if (fieldname == "Project Type")
                                {
                                    int ov = Convert.ToInt32(oldvalue);
                                    int nv = Convert.ToInt32(value);
                                    EnumList.ProjectType oldfoo = (EnumList.ProjectType)Enum.ToObject(typeof(EnumList.ProjectType), ov);
                                    oldvalue = Common.GetDescription<EnumList.ProjectType>(oldfoo);

                                    EnumList.ProjectType newfoo = (EnumList.ProjectType)Enum.ToObject(typeof(EnumList.ProjectType), nv);
                                    value = Common.GetDescription<EnumList.ProjectType>(newfoo);
                                }

                                SZ_QuotationDetailLog objhis = new SZ_QuotationDetailLog();
                                objhis.QuoteId = Olddatamodel.QuoteId;
                                objhis.QuoteDetailsId = Newdatamodel.Id;
                                objhis.QuoteRef = Newdatamodel.SZ_Quotation.Ref;
                                objhis.Username = SessionCookieManagement.UserName;
                                objhis.Datetime = System.DateTime.Now;
                                objhis.PropertyName = name;
                                objhis.FieldName = fieldname; // need to change
                                objhis.Before = Convert.ToString(oldvalue);
                                objhis.After = Convert.ToString(value);
                                objhis.UserId = SessionCookieManagement.UserId;
                                db.SZ_QuotationDetailLog.Add(objhis);

                            }
                        }
                    }
                }
            }
            db.SaveChanges();
        }

        public string findfieldname(string propname)
        {
            string fieldname = "";
            if (propname == "ProductName")
            {
                fieldname = "Product Name";
            }
            if (propname == "CASNo")
            {
                fieldname = "CAS No";
            }
            if (propname == "FinalPrice")
            {
                fieldname = "Final Price";
            }
            if (propname == "Price")
            {
                fieldname = "Price";
            }
            if (propname == "LeadTime")
            {
                fieldname = "Lead Time";
            }
            if (propname == "CATNo")
            {
                fieldname = "CAT No";
            }
            if (propname == "RequiredQty")
            {
                fieldname = "Qty";
            }
            if (propname == "ProjectType")
            {
                fieldname = "Project Type";
            }
            if (propname == "ScientistCustomerId")
            {
                fieldname = "Scientist";
            }
            if (propname == "ProjectStatus")
            {
                fieldname = "Project Status";
            }
            if (propname == "Courier")
            {
                fieldname = "Courier";
            }

            if (propname == "TrackingNo")
            {
                fieldname = "Tracking No";
            }
            if (propname == "Location")
            {
                fieldname = "Location";
            }
            if (propname == "RefName")
            {
                fieldname = "Ref Name";
            }
            if (propname == "PurposeDispatch")
            {
                fieldname = "Purpose Dispatch";
            }

            #region Step 3
            if (propname == "DeliveryDate")
            {
                fieldname = "Delivery Date";
            }
            if (propname == "AdditionalBatchNo")
            {
                fieldname = "Additional BatchNo";
            }
            if (propname == "Remark")
            {
                fieldname = "Data Remark";
            }
            if (propname == "EstimateDispatchDate")
            {
                fieldname = "Estimate Dispatch Date";
            }
            if (propname == "ContactDetail")
            {
                fieldname = "Contact Detail";
            }
            if (propname == "IsSynthesisLog")
            {
                fieldname = "Is Synthesis Log";
            }
            if (propname == "EstimateCompleteDate")
            {
                fieldname = "Estimate Complete Date";
            }


            #endregion

            #region Step 4
            if (propname == "AdminScientistStatus")
            {
                fieldname = "Admin Scientist Status";
            }
            if (propname == "InvoiceRemark")
            {
                fieldname = "Invoice Remark";
            }
            if (propname == "InvoiceNo")
            {
                fieldname = "Invoice No";
            }
            if (propname == "PaymentStatus")
            {
                fieldname = "Payment Status";
            }
            if (propname == "IsOnHold")
            {
                fieldname = "Is On Hold";
            }
            if (propname == "ProductRemark")
            {
                fieldname = "Product Remark";
            }
            if (propname == "ScientistRemark")
            {
                fieldname = "Scientist Remark";
            }
            if (propname == "PurchaseStatus")
            {
                fieldname = "Purchase Status";
            }
            if (propname == "DifficultyLevel")
            {
                fieldname = "Difficulty Level";
            }
            if (propname == "QueryText")
            {
                fieldname = "Query Text";
            }
            if (propname == "OrderRemark")
            {
                fieldname = "Order Remark";
            }
            if (propname == "Reason")
            {
                fieldname = "Reason";
            }
            #endregion
            return fieldname;
        }

        [HttpGet]
        public ActionResult GetAllCompanydata()
        {
            var listCompItems = new List<SelectListItem>();
            listCompItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            var compData = db.SZ_CompanyList.OrderBy(x => x.Name.Trim()).ToList();
            foreach (var term in compData)
            {
                listCompItems.Add(new SelectListItem
                {
                    Text = term.Name,
                    Value = term.Id.ToString()
                });
            }

            return Json(listCompItems, JsonRequestBehavior.AllowGet);
        }

        [HttpGet]
        public ActionResult WebsiteDeployNotification()
        {
            var settingdata = db.Settings.ToList();
            var isDeploy = settingdata.Where(x => x.Name == "isDeploy").Select(x => x.Value).FirstOrDefault();
            var date = DateTime.MinValue;
            if (isDeploy == "true")
            {
                var dateofdeploy = settingdata.Where(x => x.Name == "DeployDate").Select(x => x.Value).FirstOrDefault();
                date = Convert.ToDateTime(dateofdeploy).AddMinutes(10);
            }
            return Json(new { isDeploy = isDeploy, date = date }, JsonRequestBehavior.AllowGet);
        }


        public ActionResult QueryModule()
        {
            if (!SessionCookieManagement.IsLogin && !SessionCookieManagement.IsInternational)
            {
                return RedirectToAction("Index", "Home");
            }
            return View();
        }

        public ActionResult ScientistQueryModule()
        {
            if (!SessionCookieManagement.IsScientist && !SessionCookieManagement.IsSubScientist && !SessionCookieManagement.IsAnalytical)
            {
                return RedirectToAction("Index", "Home");
            }
            if (SessionCookieManagement.IsAnalytical)
            {
                var models = db.SZ_QueryModule.Where(x => x.Status != "Completed" && (x.IsAnalytical == true)).ToList();
                return View(models);
            }

            var model = db.SZ_QueryModule.Where(x => x.Status != "Completed" && (x.TeamLeaderId == SessionCookieManagement.UserId || x.ScientistId == SessionCookieManagement.UserId)).ToList();
            return View(model);
        }

        public ActionResult QuerySolution(int id, string page = "")
        {
            ViewBag.pagename = page;
            if (!SessionCookieManagement.IsLogin)
            {
                return RedirectToAction("Index", "Home");
            }

            var model = db.SZ_QueryModule.Where(x => x.Id == id).FirstOrDefault();
            var quotedetails = _operationRepository.GetQuoteDetailByID(model.QuoteDetailsId.Value);
            if (model.CASNo != "NA" && model.CASNo != "NA")
            {
                ViewBag.Solution = db.SZ_SolutionModule.Where(x => (x.CASNo == model.CASNo || x.CATNo == model.CATNo) && model.CASNo != "NA" && model.CASNo != "NA").ToList();
            }
            else
            {
                ViewBag.Solution = db.SZ_SolutionModule.Where(x => (x.CATNo == model.CATNo)).ToList();
            }
            ViewBag.SolutionData = db.SZ_SolutionModule.Where(x => x.Id == model.SolutionId).FirstOrDefault();

            string uri = Domain + "/api/RestAPI/ProductDetails?productId=" + quotedetails.ProductId;
            using (HttpClient httpClient = new HttpClient())
            {
                Task<String> response = httpClient.GetStringAsync(uri);
                string productModel = JsonConvert.DeserializeObject<string>(response.Result);
                var productmodel = JsonConvert.DeserializeObject<ProductDetailsModel>(productModel);
                if (productmodel != null)
                {
                    if (productmodel.DefaultPictureModel != null)
                    {
                        ViewBag.imageURL = productmodel.DefaultPictureModel.FullSizeImageUrl;
                    }
                    ViewBag.Synonym = productmodel.Synonym;
                }
            }
            MemoryCacheManager objCache = new MemoryCacheManager();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });
            var listItems = new List<SelectListItem>();
            var subscilistItems = new List<SelectListItem>();
            var scienList = objCache.Get("cache.GetScientistId", () =>
            {
                return db.GetScientistId().ToList();
            });
            scienList.ForEach(term =>
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                listItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.ToString()
                });
                subscilistItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.ToString()
                });
            });

            var subscienList = objCache.Get("cache.subscienList", () =>
            {
                return db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();
            });
            foreach (var term in subscienList)
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == term.Id).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }

                subscilistItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.Id.ToString()
                });

            }
            ViewBag.ScientistList = listItems;
            ViewBag.TeamLeaderList = listItems;
            return View(model);
        }

        public ActionResult ViewQueryModule(int id, string page = null)
        {
            ViewBag.pagename = page;
            var list = db.SZ_QueryModule.Where(x => x.Id == id).FirstOrDefault();
            var quotedetails = _operationRepository.GetQuoteDetailByID(list.QuoteDetailsId.Value);
            string uri = Domain + "/api/RestAPI/ProductDetails?productId=" + quotedetails.ProductId;
            using (HttpClient httpClient = new HttpClient())
            {
                Task<String> response = httpClient.GetStringAsync(uri);
                string productModel = JsonConvert.DeserializeObject<string>(response.Result);
                var productmodel = JsonConvert.DeserializeObject<ProductDetailsModel>(productModel);
                if (productmodel != null)
                {
                    if (productmodel.DefaultPictureModel != null)
                    {
                        ViewBag.imageURL = productmodel.DefaultPictureModel.FullSizeImageUrl;
                    }
                    ViewBag.Synonym = productmodel.Synonym;
                }
            }
            MemoryCacheManager objCache = new MemoryCacheManager();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });

            var scienList = objCache.Get("cache.GetScientistId", () =>
            {
                return db.GetScientistId().ToList();
            });
            ViewBag.SolutionData = db.SZ_SolutionModule.Where(x => x.Id == list.SolutionId).FirstOrDefault();
            var listItems = new List<SelectListItem>();
            var subscilistItems = new List<SelectListItem>();

            scienList.ForEach(term =>
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                listItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.ToString()
                });
            });
            var subscienList = objCache.Get("cache.subscienList", () =>
            {
                return db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();
            });
            foreach (var term in subscienList)
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == term.Id).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }

                listItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.Id.ToString()
                });
            }
            if (list.TeamLeaderId.HasValue)
            {
                string tlname = Convert.ToString(list.TeamLeaderId);
                ViewBag.teamLeaderName = listItems.Where(x => x.Value == tlname).Select(x => x.Text).FirstOrDefault();
            }
            if (!string.IsNullOrEmpty(list.SubScientistName))
            {
                ViewBag.subscientistname = listItems.Where(x => x.Value == list.SubScientistName).Select(x => x.Text).FirstOrDefault();
            }
            return View(list);
        }

        public ActionResult QueryDetails(int id)
        {
            var list = db.SZ_QueryModule.Where(x => x.Id == id).FirstOrDefault();
            if (list == null)
            {

            }
            MemoryCacheManager objCache = new MemoryCacheManager();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });
            var listItems = new List<SelectListItem>();
            var DispatchItems = new List<SelectListItem>();
            var AnalyticalItems = new List<SelectListItem>();
            var dispatchList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("dispatch")).ToList();
            foreach (var term in dispatchList)
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                DispatchItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.Id.ToString()
                });
            }
            var AnalyticalList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("analytical")).ToList();
            foreach (var term in AnalyticalList)
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                AnalyticalItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.Id.ToString()
                });
            }
            var scienList = objCache.Get("cache.GetScientistId", () =>
            {
                return db.GetScientistId().ToList();
            });
            scienList.ForEach(term =>
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                listItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.ToString()
                });
            });

            ViewBag.ScientistList = listItems;
            ViewBag.TeamLeaderList = listItems;
            ViewBag.DispatchList = DispatchItems;
            ViewBag.AnalyticalList = AnalyticalItems;
            ViewBag.subscientistname = "";
            ViewBag.teamLeaderName = "";
            if (list.TeamLeaderId.HasValue)
            {
                string tlname = Convert.ToString(list.TeamLeaderId);
                ViewBag.teamLeaderName = listItems.Where(x => x.Value == tlname).Select(x => x.Text).FirstOrDefault();
            }
            if (!string.IsNullOrEmpty(list.SubScientistName))
            {
                ViewBag.subscientistname = listItems.Where(x => x.Value == list.SubScientistName).Select(x => x.Text).FirstOrDefault();
            }
            return View(list);
        }

        //[HttpGet]
        //public JsonResult GetQueryModuleCountData(string status)
        //{
        //    var data = db.SZ_QueryModule.Where(x => x.Status == status).GroupBy(x => x.Email, (key, g) => new { Email = key, Count = g.Count() }).ToList();
        //    return Json(data, JsonRequestBehavior.AllowGet);
        //}

        [HttpGet]
        public JsonResult GetQueryModuleCountData(string status)
        {
            ViewBag.Status = status;
            var list = db.SZ_QueryModule.Where(x => x.Status == status).OrderByDescending(x => x.CreatedDate).ToList();
            string html = PartialViewdata(this, "_PartialQueryModuleData", list);
            return Json(html, JsonRequestBehavior.AllowGet);
        }

        public JsonResult GetCountOfQueryModule()
        {
            MemoryCacheManager objCache = new MemoryCacheManager();

            var data = objCache.Get("cache.queryData", () =>
            {
                return db.SZ_QueryModule.AsNoTracking().ToList();
            });
            if (SessionCookieManagement.IsInternational)
            {
                List<int?> quotedetailsids = data.Select(x => x.QuoteDetailsId).ToList();
                var quotedetailsList = db.SZ_QuotationDetail.Where(x => quotedetailsids.Contains(x.Id)).ToList();

                var model = (from i in data
                             select new QueryModuleModel()
                             {
                                 Id = i.Id,
                                 CompanyId = quotedetailsList.Where(x => x.Id == i.QuoteDetailsId).Select(x => x.SZ_Quotation.CompanyId).FirstOrDefault(),
                             }).ToList();

                string internationcompanylist = "";
                if (SessionCookieManagement.IsInternational)
                {
                    internationcompanylist = db.SZ_UserManagement.Where(x => x.UserId == SessionCookieManagement.UserId).Select(x => x.CompanyIds).FirstOrDefault();
                    if (!string.IsNullOrEmpty(internationcompanylist))
                    {
                        List<int?> cidList = new List<int?>();
                        foreach (var item in internationcompanylist.Split(','))
                        {
                            if (!string.IsNullOrEmpty(item))
                            {
                                cidList.Add(Convert.ToInt32(item));
                            }
                        }
                        model = model.Where(x => cidList.Contains(x.CompanyId) && x.CreatedDate >= new DateTime(2022, 05, 01)).ToList();
                    }
                }
                var queryListIds = model.Select(x => x.Id).ToList();
                data = data.Where(x => queryListIds.Contains(x.Id)).ToList();
            }

            var openCount = data.Where(x => x.Status == "Open").Count();
            var inprocessCount = data.Where(x => x.Status == "In Process").Count();
            var completeCount = data.Where(x => x.Status == "Completed").Count();
            var solveCount = data.Where(x => x.Status == "Solved").Count();
            return Json(new { openCount, inprocessCount, completeCount, solveCount }, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public JsonResult LoadOpenQueryModuledata()
        {
            var draw = Request.Form.GetValues("draw").FirstOrDefault();
            var start = Request.Form.GetValues("start").FirstOrDefault();
            var length = Request.Form.GetValues("length").FirstOrDefault();
            //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
            //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
            var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();

            //Paging Size (10,20,50,100)
            int pageSize = length != null ? Convert.ToInt32(length) : 0;
            int skip = start != null ? Convert.ToInt32(start) : 0;
            int recordsTotal = 0;
            var list = db.SZ_QueryModule.Where(x => x.Status == "Open").OrderByDescending(x => x.CreatedDate).ToList();

            List<int?> quotedetailsids = list.Select(x => x.QuoteDetailsId).ToList();
            var quotedetailsList = db.SZ_QuotationDetail.Where(x => quotedetailsids.Contains(x.Id)).ToList();

            var model = (from i in list
                         select new QueryModuleModel()
                         {
                             FirstRow = "<input type='checkbox' class='clsrow' value='" + i.Id + "' />",
                             Id = i.Id,
                             CompanyName = !SessionCookieManagement.IsDispatch ? (quotedetailsList.Where(x => x.Id == i.QuoteDetailsId).Select(x => x.SZ_Quotation.CompanyName).FirstOrDefault()) : "",
                             CompanyId = quotedetailsList.Where(x => x.Id == i.QuoteDetailsId).Select(x => x.SZ_Quotation.CompanyId).FirstOrDefault(),
                             Email = i.Email,
                             QueryType = i.QueryType,
                             QuoteDetailsId = i.QuoteDetailsId,
                             Origin = i.Origin,
                             SubStatus = i.SubStatus,
                             Status = i.Status,
                             ProblemType = i.ProblemType,
                             ProblemSubType = i.ProblemSubType,
                             TeamLeaderId = i.TeamLeaderId,
                             TeamLeader = i.TeamLeader,
                             ScientistId = i.ScientistId,
                             Scientist = i.Scientist,
                             Priority = i.Priority,
                             ClosingOn = i.ClosingOn,
                             CreatedDate = i.CreatedDate,
                             QueryDate = i.CreatedDate.Value.ToShortDateString(),
                             ClosingDate = i.ClosingDate,
                             ClientRemark = i.ClientRemark,
                             PrimaryEmail = i.PrimaryEmail,
                             CCEmail = i.CCEmail,
                             Attachment = i.Attachment,
                             PoDate = i.PoDate,
                             PoDateText = i.PoDate.HasValue ? i.PoDate.Value.ToShortDateString() : "",
                             PONo = i.PONo,
                             ProductName = i.ProductName,
                             CASNo = i.CASNo,
                             CATNo = i.CATNo,
                             BatchNo = i.BatchNo,
                             Qty = i.Qty,
                             SynzealRemark = i.SynzealRemark,
                             SynzealRemarkText = GetSynzealRemarkText(i),
                             CompletedDate = i.CompletedDate,
                             SolutionType = i.SolutionType,
                             SolutionId = i.SolutionId,
                             SolutionText = i.SolutionText,
                             QueryNo = i.QueryNo,
                             QuerySubject = i.QuerySubject,
                             ActionRow = GetQueryModuleActionRow(i, "open")
                         }).ToList();

            string internationcompanylist = "";
            if (SessionCookieManagement.IsInternational)
            {
                internationcompanylist = db.SZ_UserManagement.Where(x => x.UserId == SessionCookieManagement.UserId).Select(x => x.CompanyIds).FirstOrDefault();
                if (!string.IsNullOrEmpty(internationcompanylist))
                {
                    List<int?> cidList = new List<int?>();
                    foreach (var item in internationcompanylist.Split(','))
                    {
                        if (!string.IsNullOrEmpty(item))
                        {
                            cidList.Add(Convert.ToInt32(item));
                        }
                    }
                    model = model.Where(x => cidList.Contains(x.CompanyId)).ToList();
                }
            }
            recordsTotal = model.Count();
            //Search
            if (!string.IsNullOrEmpty(searchValue))
            {
                searchValue = searchValue.ToLower().Trim();
                model = model.Where(m => (m.QueryNo != null && m.QueryNo.ToLower().Contains(searchValue))
                                    || (m.CompanyName != null && m.CompanyName.ToLower().Contains(searchValue))
                                    || (m.Status != null && m.Status.ToLower().Contains(searchValue))
                                    || (m.SubScientistName != null && m.SubScientistName.ToLower().Contains(searchValue))
                                    || (m.SubStatus != null && m.SubStatus.ToLower().Contains(searchValue))
                                    || (m.PONo != null && m.PONo.ToLower().Contains(searchValue))
                                    || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                    || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                    || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                    || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                    || (m.Qty != null && m.Qty.ToLower().Contains(searchValue))
                                    || (m.QuerySubject != null && m.QuerySubject.ToLower().Contains(searchValue))).ToList();
            }
            //Paging   
            var data = model.Skip(skip).Take(pageSize).ToList();
            return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });

        }

        public ActionResult ExportQueryModuleOpenTab()
        {
            int page = 1;
            int rows = 0;
            int pageIndex = Convert.ToInt32(page) - 1;
            int pageSize = rows;
            string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.Purchase);
            string purSynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);

            var model = db.SZ_QueryModule.Where(x => x.Status == "Open").OrderByDescending(x => x.CreatedDate).ToList();
            List<int?> quotedetailsids = model.Select(x => x.QuoteDetailsId).ToList();
            var quotedetailsList = db.SZ_QuotationDetail.Where(x => quotedetailsids.Contains(x.Id)).ToList();
            MemoryCacheManager objCache = new MemoryCacheManager();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });

            //var listItems = new List<SelectListItem>();
            //var scienList = db.GetScientistId().ToList();
            //scienList.ForEach(term =>
            //{
            //    string customerName = string.Empty;
            //    var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
            //    if (genericAttr.Count > 0)
            //    {
            //        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
            //    }
            //    listItems.Add(new SelectListItem
            //    {
            //        Text = customerName,
            //        Value = term.ToString()
            //    });
            //});
            //change logic start
            System.Web.UI.WebControls.GridView gv = new System.Web.UI.WebControls.GridView();
            gv.DataSource = (from t2 in model
                             select new
                             {
                                 QueryDate = t2.CreatedDate.HasValue ? t2.CreatedDate.Value.ToShortDateString() : "",
                                 QueryNo = t2.QueryNo,
                                 CompanyName = !SessionCookieManagement.IsDispatch ? (quotedetailsList.Where(x => x.Id == t2.QuoteDetailsId).Select(x => x.SZ_Quotation.CompanyName).FirstOrDefault()) : "",
                                 PoDate = t2.PoDate.HasValue ? t2.PoDate.Value.ToShortDateString() : "",
                                 PONo = t2.PONo,
                                 ProductName = t2.ProductName,
                                 CASNo = t2.CASNo,
                                 CATNo = t2.CATNo,
                                 Qty = t2.Qty,
                                 BatchNo = t2.BatchNo,
                                 QuerySubject = t2.QuerySubject,
                                 SynzealRemark = t2.SynzealRemark,
                             }).ToList();
            gv.DataBind();
            Response.ClearContent();
            Response.Buffer = true;
            Response.AddHeader("content-disposition", "attachment; filename=Query_Open_" + DateTime.Now.Year + DateTime.Now.ToString("MM") + DateTime.Now.ToString("dd") + ".xls");
            Response.ContentType = "application/ms-excel";
            Response.Charset = "";
            StringWriter sw = new StringWriter();
            HtmlTextWriter htw = new HtmlTextWriter(sw);
            gv.RenderControl(htw);
            string passstr = sw.ToString().Replace(" 00:00:00", "");
            Response.Output.Write(passstr);
            Response.Flush();
            Response.End();
            return RedirectToAction("QueryModule");
        }

        [HttpPost]
        public JsonResult LoadInProcessQueryModuledata()
        {
            var draw = Request.Form.GetValues("draw").FirstOrDefault();
            var start = Request.Form.GetValues("start").FirstOrDefault();
            var length = Request.Form.GetValues("length").FirstOrDefault();
            //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
            //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
            var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();

            //Paging Size (10,20,50,100)
            int pageSize = length != null ? Convert.ToInt32(length) : 0;
            int skip = start != null ? Convert.ToInt32(start) : 0;
            int recordsTotal = 0;
            var list = db.SZ_QueryModule.Where(x => x.Status == "In Process").OrderByDescending(x => x.InProcessDate).ToList();

            List<int?> quotedetailsids = list.Select(x => x.QuoteDetailsId).ToList();
            var quotedetailsList = db.SZ_QuotationDetail.Where(x => quotedetailsids.Contains(x.Id)).ToList();

            var model = (from i in list
                         select new QueryModuleModel()
                         {
                             FirstRow = "<input type='checkbox' class='clsrow' value='" + i.Id + "' />",

                             Id = i.Id,
                             CompanyName = !SessionCookieManagement.IsDispatch ? (quotedetailsList.Where(x => x.Id == i.QuoteDetailsId).Select(x => x.SZ_Quotation.CompanyName).FirstOrDefault()) : "",
                             CompanyId = quotedetailsList.Where(x => x.Id == i.QuoteDetailsId).Select(x => x.SZ_Quotation.CompanyId).FirstOrDefault(),
                             Email = i.Email,
                             QueryType = i.QueryType,
                             QuoteDetailsId = i.QuoteDetailsId,
                             Origin = i.Origin,
                             SubStatus = i.SubStatus,
                             Status = i.Status,
                             ProblemType = i.ProblemType,
                             ProblemSubType = i.ProblemSubType,
                             TeamLeaderId = i.TeamLeaderId,
                             TeamLeader = i.TeamLeader,
                             ScientistId = i.ScientistId,
                             Scientist = i.Scientist,
                             Priority = i.Priority,
                             ClosingOn = i.ClosingOn,
                             CreatedDate = i.CreatedDate,
                             QueryDate = i.CreatedDate.Value.ToShortDateString(),
                             ClosingDate = i.ClosingDate,
                             ClosingDateText = i.ClosingDate.HasValue ? i.ClosingDate.Value.ToShortDateString() : "",
                             ClientRemark = i.ClientRemark,
                             PrimaryEmail = i.PrimaryEmail,
                             CCEmail = i.CCEmail,
                             Attachment = i.Attachment,
                             PoDate = i.PoDate,
                             PoDateText = i.PoDate.HasValue ? i.PoDate.Value.ToShortDateString() : "",
                             PONo = i.PONo,
                             ProductName = i.ProductName,
                             CASNo = i.CASNo,
                             CATNo = i.CATNo,
                             BatchNo = i.BatchNo,
                             Qty = i.Qty,
                             SynzealRemark = i.SynzealRemark,
                             SynzealRemarkText = GetSynzealRemarkText(i),
                             CompletedDate = i.CompletedDate,
                             SolutionType = i.SolutionType,
                             SolutionId = i.SolutionId,
                             SolutionText = i.SolutionText,
                             QueryNo = i.QueryNo,
                             QuerySubject = i.QuerySubject,
                             ActionRow = GetQueryModuleActionRow(i, "inprocess")
                         }).ToList();
            //Search
            if (!string.IsNullOrEmpty(searchValue))
            {
                searchValue = searchValue.ToLower().Trim();
                model = model.Where(m => (m.QueryNo != null && m.QueryNo.ToLower().Contains(searchValue))
                || (m.CompanyName != null && m.CompanyName.ToLower().Contains(searchValue))
                                    || (m.Status != null && m.Status.ToLower().Contains(searchValue))
                                    || (m.SubScientistName != null && m.SubScientistName.ToLower().Contains(searchValue))
                                    || (m.SubStatus != null && m.SubStatus.ToLower().Contains(searchValue))
                                    || (m.PONo != null && m.PONo.ToLower().Contains(searchValue))
                                    || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                    || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                    || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                    || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                    || (m.Qty != null && m.Qty.ToLower().Contains(searchValue))
                                    || (m.QuerySubject != null && m.QuerySubject.ToLower().Contains(searchValue))).ToList();
            }

            string internationcompanylist = "";
            if (SessionCookieManagement.IsInternational)
            {
                internationcompanylist = db.SZ_UserManagement.Where(x => x.UserId == SessionCookieManagement.UserId).Select(x => x.CompanyIds).FirstOrDefault();
                if (!string.IsNullOrEmpty(internationcompanylist))
                {
                    List<int?> cidList = new List<int?>();
                    foreach (var item in internationcompanylist.Split(','))
                    {
                        if (!string.IsNullOrEmpty(item))
                        {
                            cidList.Add(Convert.ToInt32(item));
                        }
                    }
                    model = model.Where(x => cidList.Contains(x.CompanyId)).ToList();
                }
            }

            recordsTotal = model.Count();
            //Paging   
            var data = model.Skip(skip).Take(pageSize).ToList();
            return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });

        }

        public ActionResult ExportQueryModuleInProcessTab()
        {
            int page = 1;
            int rows = 0;
            int pageIndex = Convert.ToInt32(page) - 1;
            int pageSize = rows;
            string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.Purchase);
            string purSynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);

            var model = db.SZ_QueryModule.Where(x => x.Status == "In Process").OrderByDescending(x => x.InProcessDate).ToList();
            List<int?> quotedetailsids = model.Select(x => x.QuoteDetailsId).ToList();
            var quotedetailsList = db.SZ_QuotationDetail.Where(x => quotedetailsids.Contains(x.Id)).ToList();
            MemoryCacheManager objCache = new MemoryCacheManager();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });
            var solutionIds = model.Select(x => x.SolutionId).Distinct().ToList();
            var solutionData = db.SZ_SolutionModule.Where(x => solutionIds.Contains(x.Id)).ToList();


            //change logic start
            System.Web.UI.WebControls.GridView gv = new System.Web.UI.WebControls.GridView();
            gv.DataSource = (from t2 in model
                             select new
                             {
                                 QueryDate = t2.CreatedDate.HasValue ? t2.CreatedDate.Value.ToShortDateString() : "",
                                 QueryNo = t2.QueryNo,
                                 SubStatus = t2.SubStatus,
                                 CompanyName = !SessionCookieManagement.IsDispatch ? (quotedetailsList.Where(x => x.Id == t2.QuoteDetailsId).Select(x => x.SZ_Quotation.CompanyName).FirstOrDefault()) : "",
                                 PoDate = t2.PoDate.HasValue ? t2.PoDate.Value.ToShortDateString() : "",
                                 PONo = t2.PONo,
                                 ProductName = t2.ProductName,
                                 CASNo = t2.CASNo,
                                 CATNo = t2.CATNo,
                                 Qty = t2.Qty,
                                 BatchNo = t2.BatchNo,
                                 QuerySubject = t2.QuerySubject,
                                 SynzealRemark = t2.SynzealRemark,
                                 EstDate = t2.ClosingDate.HasValue ? t2.ClosingDate.Value.ToShortDateString() : "",
                                 QueryUnderstanding = solutionData.Where(x => x.Id == t2.SolutionId).Select(x => x.Cause).FirstOrDefault(),
                                 Analytical = solutionData.Where(x => x.Id == t2.SolutionId).Select(x => x.Cause).FirstOrDefault(),
                                 FinalSolution = solutionData.Where(x => x.Id == t2.SolutionId).Select(x => x.Cause).FirstOrDefault()
                             }).ToList();
            gv.DataBind();
            Response.ClearContent();
            Response.Buffer = true;
            Response.AddHeader("content-disposition", "attachment; filename=Query_Open_" + DateTime.Now.Year + DateTime.Now.ToString("MM") + DateTime.Now.ToString("dd") + ".xls");
            Response.ContentType = "application/ms-excel";
            Response.Charset = "";
            StringWriter sw = new StringWriter();
            HtmlTextWriter htw = new HtmlTextWriter(sw);
            gv.RenderControl(htw);
            string passstr = sw.ToString().Replace(" 00:00:00", "");
            Response.Output.Write(passstr);
            Response.Flush();
            Response.End();
            return RedirectToAction("QueryModule");
        }

        [HttpPost]
        public JsonResult LoadSolvedQueryModuledata()
        {
            var draw = Request.Form.GetValues("draw").FirstOrDefault();
            var start = Request.Form.GetValues("start").FirstOrDefault();
            var length = Request.Form.GetValues("length").FirstOrDefault();
            //var sortColumn = Request.Form.GetValues("columns[" + Request.Form.GetValues("order[0][column]").FirstOrDefault() + "][name]").FirstOrDefault();
            //var sortColumnDir = Request.Form.GetValues("order[0][dir]").FirstOrDefault();
            var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();

            //Paging Size (10,20,50,100)
            int pageSize = length != null ? Convert.ToInt32(length) : 0;
            int skip = start != null ? Convert.ToInt32(start) : 0;
            int recordsTotal = 0;
            var list = db.SZ_QueryModule.Where(x => x.Status == "Solved").OrderByDescending(x => x.SolvedDate).ToList();

            List<int?> quotedetailsids = list.Select(x => x.QuoteDetailsId).ToList();
            var quotedetailsList = db.SZ_QuotationDetail.Where(x => quotedetailsids.Contains(x.Id)).ToList();

            var model = (from i in list
                         select new QueryModuleModel()
                         {
                             FirstRow = "<input type='checkbox' class='clsrow' value='" + i.Id + "' />",
                             Id = i.Id,
                             CompanyName = !SessionCookieManagement.IsDispatch ? (quotedetailsList.Where(x => x.Id == i.QuoteDetailsId).Select(x => x.SZ_Quotation.CompanyName).FirstOrDefault()) : "",
                             CompanyId = quotedetailsList.Where(x => x.Id == i.QuoteDetailsId).Select(x => x.SZ_Quotation.CompanyId).FirstOrDefault(),
                             Email = i.Email,
                             QueryType = i.QueryType,
                             QuoteDetailsId = i.QuoteDetailsId,
                             Origin = i.Origin,
                             SubStatus = i.SubStatus,
                             Status = i.Status,
                             ProblemType = i.ProblemType,
                             ProblemSubType = i.ProblemSubType,
                             TeamLeaderId = i.TeamLeaderId,
                             TeamLeader = i.TeamLeader,
                             ScientistId = i.ScientistId,
                             Scientist = i.Scientist,
                             Priority = i.Priority,
                             ClosingOn = i.ClosingOn,
                             CreatedDate = i.CreatedDate,
                             QueryDate = i.CreatedDate.Value.ToShortDateString(),
                             ClosingDate = i.ClosingDate,
                             ClosingDateText = i.ClosingDate.HasValue ? i.ClosingDate.Value.ToShortDateString() : "",
                             ClientRemark = i.ClientRemark,
                             PrimaryEmail = i.PrimaryEmail,
                             CCEmail = i.CCEmail,
                             Attachment = i.Attachment,
                             PoDate = i.PoDate,
                             PoDateText = i.PoDate.HasValue ? i.PoDate.Value.ToShortDateString() : "",
                             PONo = i.PONo,
                             ProductName = i.ProductName,
                             CASNo = i.CASNo,
                             CATNo = i.CATNo,
                             BatchNo = i.BatchNo,
                             Qty = i.Qty,
                             SynzealRemark = i.SynzealRemark,
                             SynzealRemarkText = GetSynzealRemarkText(i),
                             CompletedDate = i.CompletedDate,
                             SolutionType = i.SolutionType,
                             SolutionId = i.SolutionId,
                             SolutionText = i.SolutionText,
                             QueryNo = i.QueryNo,
                             QuerySubject = i.QuerySubject,
                             ActionRow = GetQueryModuleActionRow(i, "solved")
                         }).ToList();
            //Search
            if (!string.IsNullOrEmpty(searchValue))
            {
                searchValue = searchValue.ToLower().Trim();
                model = model.Where(m => (m.QueryNo != null && m.QueryNo.ToLower().Contains(searchValue))
                || (m.CompanyName != null && m.CompanyName.ToLower().Contains(searchValue))
                                    || (m.Status != null && m.Status.ToLower().Contains(searchValue))
                                    || (m.SubScientistName != null && m.SubScientistName.ToLower().Contains(searchValue))
                                    || (m.SubStatus != null && m.SubStatus.ToLower().Contains(searchValue))
                                    || (m.PONo != null && m.PONo.ToLower().Contains(searchValue))
                                    || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                    || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                    || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                    || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                    || (m.Qty != null && m.Qty.ToLower().Contains(searchValue))
                                    || (m.QuerySubject != null && m.QuerySubject.ToLower().Contains(searchValue))).ToList();
            }


            string internationcompanylist = "";
            if (SessionCookieManagement.IsInternational)
            {
                internationcompanylist = db.SZ_UserManagement.Where(x => x.UserId == SessionCookieManagement.UserId).Select(x => x.CompanyIds).FirstOrDefault();
                if (!string.IsNullOrEmpty(internationcompanylist))
                {
                    List<int?> cidList = new List<int?>();
                    foreach (var item in internationcompanylist.Split(','))
                    {
                        if (!string.IsNullOrEmpty(item))
                        {
                            cidList.Add(Convert.ToInt32(item));
                        }
                    }
                    model = model.Where(x => cidList.Contains(x.CompanyId)).ToList();
                }
            }
            recordsTotal = model.Count();
            //Paging   
            var data = model.Skip(skip).Take(pageSize).ToList();
            return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });

        }

        public ActionResult ExportQueryModuleSolvedTab()
        {
            int page = 1;
            int rows = 0;
            int pageIndex = Convert.ToInt32(page) - 1;
            int pageSize = rows;
            string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.Purchase);
            string purSynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);

            var model = db.SZ_QueryModule.Where(x => x.Status == "Solved").OrderByDescending(x => x.SolvedDate).ToList();
            List<int?> quotedetailsids = model.Select(x => x.QuoteDetailsId).ToList();
            var quotedetailsList = db.SZ_QuotationDetail.Where(x => quotedetailsids.Contains(x.Id)).ToList();
            MemoryCacheManager objCache = new MemoryCacheManager();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });
            var solutionIds = model.Select(x => x.SolutionId).Distinct().ToList();
            var solutionData = db.SZ_SolutionModule.Where(x => solutionIds.Contains(x.Id)).ToList();
            //change logic start
            System.Web.UI.WebControls.GridView gv = new System.Web.UI.WebControls.GridView();
            gv.DataSource = (from t2 in model
                             select new
                             {
                                 QueryDate = t2.CreatedDate.HasValue ? t2.CreatedDate.Value.ToShortDateString() : "",
                                 QueryNo = t2.QueryNo,
                                 SubStatus = t2.SubStatus,
                                 CompanyName = !SessionCookieManagement.IsDispatch ? (quotedetailsList.Where(x => x.Id == t2.QuoteDetailsId).Select(x => x.SZ_Quotation.CompanyName).FirstOrDefault()) : "",
                                 PoDate = t2.PoDate.HasValue ? t2.PoDate.Value.ToShortDateString() : "",
                                 PONo = t2.PONo,
                                 ProductName = t2.ProductName,
                                 CASNo = t2.CASNo,
                                 CATNo = t2.CATNo,
                                 Qty = t2.Qty,
                                 BatchNo = t2.BatchNo,
                                 QuerySubject = t2.QuerySubject,
                                 SynzealRemark = t2.SynzealRemark,
                                 EstDate = t2.ClosingDate.HasValue ? t2.ClosingDate.Value.ToShortDateString() : "",
                                 QueryUnderstanding = solutionData.Where(x => x.Id == t2.SolutionId).Select(x => x.Cause).FirstOrDefault(),
                                 Analytical = solutionData.Where(x => x.Id == t2.SolutionId).Select(x => x.Cause).FirstOrDefault(),
                                 FinalSolution = solutionData.Where(x => x.Id == t2.SolutionId).Select(x => x.Cause).FirstOrDefault(),
                             }).ToList();
            gv.DataBind();
            Response.ClearContent();
            Response.Buffer = true;
            Response.AddHeader("content-disposition", "attachment; filename=Query_Open_" + DateTime.Now.Year + DateTime.Now.ToString("MM") + DateTime.Now.ToString("dd") + ".xls");
            Response.ContentType = "application/ms-excel";
            Response.Charset = "";
            StringWriter sw = new StringWriter();
            HtmlTextWriter htw = new HtmlTextWriter(sw);
            gv.RenderControl(htw);
            string passstr = sw.ToString().Replace(" 00:00:00", "");
            Response.Output.Write(passstr);
            Response.Flush();
            Response.End();
            return RedirectToAction("QueryModule");
        }
        [HttpPost]
        public JsonResult LoadCompletedQueryModuledata()
        {
            var draw = Request.Form.GetValues("draw").FirstOrDefault();
            var start = Request.Form.GetValues("start").FirstOrDefault();
            var length = Request.Form.GetValues("length").FirstOrDefault();
            var searchValue = Request.Form.GetValues("search[value]").FirstOrDefault();
            int pageSize = length != null ? Convert.ToInt32(length) : 0;
            int skip = start != null ? Convert.ToInt32(start) : 0;
            int recordsTotal = 0;
            var list = db.SZ_QueryModule.Where(x => x.Status == "Completed").OrderByDescending(x => x.CompletedDate).ToList();

            List<int?> quotedetailsids = list.Select(x => x.QuoteDetailsId).ToList();
            var quotedetailsList = db.SZ_QuotationDetail.Where(x => quotedetailsids.Contains(x.Id)).ToList();

            var model = (from i in list
                         select new QueryModuleModel()
                         {
                             Id = i.Id,
                             CompanyName = !SessionCookieManagement.IsDispatch ? (quotedetailsList.Where(x => x.Id == i.QuoteDetailsId).Select(x => x.SZ_Quotation.CompanyName).FirstOrDefault()) : "",
                             CompanyId = quotedetailsList.Where(x => x.Id == i.QuoteDetailsId).Select(x => x.SZ_Quotation.CompanyId).FirstOrDefault(),
                             Email = i.Email,
                             QueryType = i.QueryType,
                             QuoteDetailsId = i.QuoteDetailsId,
                             Origin = i.Origin,
                             SubStatus = i.SubStatus,
                             Status = i.Status,
                             ProblemType = i.ProblemType,
                             ProblemSubType = i.ProblemSubType,
                             TeamLeaderId = i.TeamLeaderId,
                             TeamLeader = i.TeamLeader,
                             ScientistId = i.ScientistId,
                             Scientist = i.Scientist,
                             Priority = i.Priority,
                             ClosingOn = i.ClosingOn,
                             CreatedDate = i.CreatedDate,
                             QueryDate = i.CreatedDate.Value.ToShortDateString(),
                             ClosingDate = i.ClosingDate,
                             ClosingDateText = i.ClosingDate.HasValue ? i.ClosingDate.Value.ToShortDateString() : "",
                             ClientRemark = i.ClientRemark,
                             PrimaryEmail = i.PrimaryEmail,
                             CCEmail = i.CCEmail,
                             Attachment = i.Attachment,
                             PoDate = i.PoDate,
                             PoDateText = i.PoDate.HasValue ? i.PoDate.Value.ToShortDateString() : "",
                             PONo = i.PONo,
                             ProductName = i.ProductName,
                             CASNo = i.CASNo,
                             CATNo = i.CATNo,
                             BatchNo = i.BatchNo,
                             Qty = i.Qty,
                             SynzealRemark = i.SynzealRemark,
                             SynzealRemarkText = GetSynzealRemarkText(i),
                             CompletedDate = i.CompletedDate,
                             SolutionType = i.SolutionType,
                             SolutionId = i.SolutionId,
                             SolutionText = i.SolutionText,
                             QueryNo = i.QueryNo,
                             QuerySubject = i.QuerySubject,
                             ActionRow = GetQueryModuleActionRow(i, "completed"),
                             FirstRow = "<input type='checkbox' class='clsrow clsreplacement' value='" + i.Id + "' />"
                         }).ToList();
            //Search
            if (!string.IsNullOrEmpty(searchValue))
            {
                searchValue = searchValue.ToLower().Trim();
                model = model.Where(m => (m.QueryNo != null && m.QueryNo.ToLower().Contains(searchValue))
                || (m.CompanyName != null && m.CompanyName.ToLower().Contains(searchValue))
                                    || (m.Status != null && m.Status.ToLower().Contains(searchValue))
                                    || (m.SubScientistName != null && m.SubScientistName.ToLower().Contains(searchValue))
                                    || (m.SubStatus != null && m.SubStatus.ToLower().Contains(searchValue))
                                    || (m.PONo != null && m.PONo.ToLower().Contains(searchValue))
                                    || (m.ProductName != null && m.ProductName.ToLower().Contains(searchValue))
                                    || (m.CASNo != null && m.CASNo.ToLower().Contains(searchValue))
                                    || (m.CATNo != null && m.CATNo.ToLower().Contains(searchValue))
                                    || (m.BatchNo != null && m.BatchNo.ToLower().Contains(searchValue))
                                    || (m.Qty != null && m.Qty.ToLower().Contains(searchValue))
                                    || (m.QuerySubject != null && m.QuerySubject.ToLower().Contains(searchValue))).ToList();
            }


            string internationcompanylist = "";
            if (SessionCookieManagement.IsInternational)
            {
                internationcompanylist = db.SZ_UserManagement.Where(x => x.UserId == SessionCookieManagement.UserId).Select(x => x.CompanyIds).FirstOrDefault();
                if (!string.IsNullOrEmpty(internationcompanylist))
                {
                    List<int?> cidList = new List<int?>();
                    foreach (var item in internationcompanylist.Split(','))
                    {
                        if (!string.IsNullOrEmpty(item))
                        {
                            cidList.Add(Convert.ToInt32(item));
                        }
                    }
                    model = model.Where(x => cidList.Contains(x.CompanyId)).ToList();
                }
            }
            recordsTotal = model.Count();
            //Paging   
            var data = model.Skip(skip).Take(pageSize).ToList();
            return Json(new { draw = draw, recordsFiltered = recordsTotal, recordsTotal = recordsTotal, data = data });

        }

        public ActionResult ExportQueryModuleCloseTab()
        {
            int page = 1;
            int rows = 0;
            int pageIndex = Convert.ToInt32(page) - 1;
            int pageSize = rows;
            string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.Purchase);
            string purSynthesisProjectType = Convert.ToString((int)EnumList.ProjectType.PurSynthesis);

            var model = db.SZ_QueryModule.Where(x => x.Status == "Completed").OrderByDescending(x => x.CompletedDate).ToList();
            List<int?> quotedetailsids = model.Select(x => x.QuoteDetailsId).ToList();
            var quotedetailsList = db.SZ_QuotationDetail.Where(x => quotedetailsids.Contains(x.Id)).ToList();
            MemoryCacheManager objCache = new MemoryCacheManager();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });
            var solutionIds = model.Select(x => x.SolutionId).Distinct().ToList();
            var solutionData = db.SZ_SolutionModule.Where(x => solutionIds.Contains(x.Id)).ToList();

            System.Web.UI.WebControls.GridView gv = new System.Web.UI.WebControls.GridView();
            gv.DataSource = (from t2 in model
                             select new
                             {
                                 QueryDate = t2.CreatedDate.HasValue ? t2.CreatedDate.Value.ToShortDateString() : "",
                                 QueryNo = t2.QueryNo,
                                 SubStatus = t2.SubStatus,
                                 CompanyName = !SessionCookieManagement.IsDispatch ? (quotedetailsList.Where(x => x.Id == t2.QuoteDetailsId).Select(x => x.SZ_Quotation.CompanyName).FirstOrDefault()) : "",
                                 PoDate = t2.PoDate.HasValue ? t2.PoDate.Value.ToShortDateString() : "",
                                 PONo = t2.PONo,
                                 ProductName = t2.ProductName,
                                 CASNo = t2.CASNo,
                                 CATNo = t2.CATNo,
                                 Qty = t2.Qty,
                                 BatchNo = t2.BatchNo,
                                 QuerySubject = t2.QuerySubject,
                                 SynzealRemark = t2.SynzealRemark,
                                 EstDate = t2.ClosingDate.HasValue ? t2.ClosingDate.Value.ToShortDateString() : "",
                                 QueryUnderstanding = solutionData.Where(x => x.Id == t2.SolutionId).Select(x => x.Cause).FirstOrDefault(),
                                 Analytical = solutionData.Where(x => x.Id == t2.SolutionId).Select(x => x.Cause).FirstOrDefault(),
                                 FinalSolution = solutionData.Where(x => x.Id == t2.SolutionId).Select(x => x.Cause).FirstOrDefault(),
                             }).ToList();
            gv.DataBind();
            Response.ClearContent();
            Response.Buffer = true;
            Response.AddHeader("content-disposition", "attachment; filename=Query_Open_" + DateTime.Now.Year + DateTime.Now.ToString("MM") + DateTime.Now.ToString("dd") + ".xls");
            Response.ContentType = "application/ms-excel";
            Response.Charset = "";
            StringWriter sw = new StringWriter();
            HtmlTextWriter htw = new HtmlTextWriter(sw);
            gv.RenderControl(htw);
            string passstr = sw.ToString().Replace(" 00:00:00", "");
            Response.Output.Write(passstr);
            Response.Flush();
            Response.End();
            return RedirectToAction("QueryModule");
        }
        public ActionResult DeleteQuery(int id)
        {
            var querySolution = db.SZ_QueryModule.Where(x => x.Id == id).FirstOrDefault();
            if (querySolution != null)
            {
                db.Entry(querySolution).State = EntityState.Deleted;
                db.SaveChanges();
            }
            return Json(new { success = true, message = "Query deleted successfully." });
        }
        public string GetQueryModuleActionRow(SZ_QueryModule i, string status)
        {
            if (status == "close" || status == "completed")
            {
                //| < a href = '/Form/ViewQueryModule/" + i.Id + "?page=close' > View </ a >
                return "<a href='/Form/QuerySolution/" + i.Id + "?page=close'>View</a> | <a href='javascript:void(0)' onclick='queryDelete(" + i.Id + ")' " + i.Id + "'>Delete</a>";
            }
            var str = "<a data-toggle='modal' href='/Form/QueryDetails/" + i.Id + "' data-target='#myModalQueryDetails'>Select</a>";
            if (status == "inprocess")
            {
                str += " | <a href='/Form/QuerySolution/" + i.Id + "?page=inprocess'>View</a>";
            }
            if (status == "solved")
            {
                str += " | <a href='/Form/QuerySolution/" + i.Id + "?page=Solved'>View</a> ";
            }
            if (status == "open")
            {
                str += " | <a href='/Form/QuerySolution/" + i.Id + "?page=open'>View</a>";
            }
            str += " | <a href='javascript:void(0)' onclick='queryDelete(" + i.Id + ")' " + i.Id + "'>Delete</a>";
            return str;
        }
        public string GetSynzealRemarkText(SZ_QueryModule i)
        {
            var str = "<i class='fa fa-pencil' onclick='synzealremarkpopup(" + i.Id + ")'></i>";
            if (!string.IsNullOrEmpty(i.SynzealRemark))
            {
                str += "<span> &nbsp; &nbsp;</span><i class='fa fa-info' title='" + i.SynzealRemark + "'></i>";
            }
            return str;
        }
        [HttpGet]
        public JsonResult getQueryModuleRecordByEmailandStatus(string email, string status)
        {

            ViewBag.Status = status;
            var list = db.SZ_QueryModule.Where(x => x.Status == status).OrderByDescending(x => x.CreatedDate).ToList();
            string html = PartialViewdata(this, "_PartialQueryModuleData", list);
            return Json(html, JsonRequestBehavior.AllowGet);
        }

        [HttpGet]
        public JsonResult GetQueryModuleByProductId(string catNo)
        {
            var list = db.SZ_QueryModule.Where(x => x.CATNo == catNo).OrderByDescending(x => x.CreatedDate).ToList();
            string html = PartialViewdata(this, "_PartialQueryModuleData", list);
            return Json(html, JsonRequestBehavior.AllowGet);
        }


        [HttpGet]
        public JsonResult saveSynzealRemark(int id, string Remark)
        {
            var list = db.SZ_QueryModule.Where(x => x.Id == id).FirstOrDefault();
            if (list != null)
            {
                list.SynzealRemark = Remark;
                db.Entry(list).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json("", JsonRequestBehavior.AllowGet);
        }

        [HttpGet]
        public JsonResult AddSynzealRemarkById(int id)
        {
            var list = db.SZ_QueryModule.Where(x => x.Id == id).FirstOrDefault();
            string html = PartialViewdata(this, "_PartialAddSynzealRemark", list);
            return Json(html, JsonRequestBehavior.AllowGet);
        }

        [HttpGet]
        public JsonResult getQueryModuleGeneralTabbyId(int id)
        {

            var list = db.SZ_QueryModule.Where(x => x.Id == id).FirstOrDefault();
            string html = PartialViewdata(this, "_PartialQuerygeneralTab", list);
            return Json(html, JsonRequestBehavior.AllowGet);
        }

        [HttpGet]
        public JsonResult AddSolution(int id, int solutionId = 0)
        {
            var list = db.SZ_QueryModule.Where(x => x.Id == id).FirstOrDefault();
            var quotedetails = _operationRepository.GetQuoteDetailByID(list.QuoteDetailsId.Value);
            if (quotedetails != null)
            {
                ViewBag.ProductId = quotedetails.ProductId;
            }
            var solutionData = db.SZ_SolutionModule.Where(x => x.Id == solutionId).FirstOrDefault();
            if (solutionData != null)
            {
                ViewBag.solutionData = solutionData;
            }
            else
            {
                ViewBag.solutionData = null;
            }
            var formid = db.SZ_QuoteDetails_Form.Where(x => x.QuoteDetailsId == list.QuoteDetailsId).Select(x => x.FormId).FirstOrDefault();

            ViewBag.QuoteDetailsForm = db.SZ_QuoteDetailForm.Where(x => x.Id == formid).ToList();
            string html = PartialViewdata(this, "_PartialAddSolution", list);
            return Json(html, JsonRequestBehavior.AllowGet);
        }

        [HttpGet]
        public JsonResult AssignSolutionText(int id, string text)
        {
            var list = db.SZ_QueryModule.Where(x => x.Id == id).FirstOrDefault();
            if (list != null)
            {
                list.Status = "Solved";
                list.SolutionType = "Verbal";
                list.IsScientistResolved = true;
                list.SolutionText = text;
                list.SolvedDate = DateTime.Now;
                db.Entry(list).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json("", JsonRequestBehavior.AllowGet);
        }

        [HttpGet]
        public JsonResult AssignSolution(int id, int SolutionId)
        {
            var list = db.SZ_QueryModule.Where(x => x.Id == id).FirstOrDefault();
            if (list != null)
            {
                list.Status = "Solved";
                list.SolutionType = "Technical";
                list.IsScientistResolved = true;
                list.SolutionId = SolutionId;
                list.SolvedDate = DateTime.Now;
                db.Entry(list).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json("", JsonRequestBehavior.AllowGet);
        }

        [HttpGet]
        public JsonResult SaveQueryData(int id, string SubStatus, string SubScientist, int? ClosingOn, int? TeamLeaderId)
        {
            var querymodule = db.SZ_QueryModule.Where(x => x.Id == id).FirstOrDefault();
            if (querymodule != null)
            {
                querymodule.SubStatus = SubStatus;
                querymodule.ClosingOn = ClosingOn;
                querymodule.SubScientistName = SubScientist;
                if (ClosingOn.HasValue)
                {
                    querymodule.ClosingDate = querymodule.CreatedDate.Value.AddDays(ClosingOn.Value);
                }
                querymodule.TeamLeaderId = TeamLeaderId;
                db.Entry(querymodule).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json("", JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public JsonResult SaveBugData(SZ_Bug model, int id)
        {
            int refNo = 1;
            string value = string.Empty;
            string matchingstring = "SZ-BUG-";
            var SZ_Quotationdata = (from i in db.SZ_Bug
                                    where i.BugNo.StartsWith(matchingstring)
                                    select i).ToList();
            if (SZ_Quotationdata.Count > 0)
            {
                refNo = SZ_Quotationdata.Select(x => ExtractQuoreRefNumber(x.BugNo)).Max(w => w);
                int newbrokerrewf = Convert.ToInt32(refNo) + 1;

                value = "SZ-BUG-" + newbrokerrewf.ToString().PadLeft(2, '0');
            }
            else
            {
                value = "SZ-BUG-" + "-01";
            }
            if (id != 0)
            {
                SZ_Bug objSolution = db.SZ_Bug.Where(x => x.Id == id).FirstOrDefault();
                objSolution.Description = model.Description;
                objSolution.URL = model.URL;
                objSolution.ContactUs = model.ContactUs;
                objSolution.UpdatedBy = SessionCookieManagement.UserName;
                objSolution.UpdatedDate = DateTime.Now;
                objSolution.ResolveDate = null;
                objSolution.Subject = model.Subject;

                if (SessionCookieManagement.UserEmail == "parthsuthar2010@gmail.com")
                {
                    objSolution.EstDate = model.EstDate;
                    objSolution.Status = model.Status;
                    if (objSolution.Status == "CLOSED")
                    {
                        objSolution.ResolveDate = DateTime.Now;
                    }
                }
                if (Request.Files.Count > 0)
                {
                    try
                    {
                        string attachment = "";
                        //  Get all files from Request object  
                        HttpFileCollectionBase files = Request.Files;
                        for (int i = 0; i < files.Count; i++)
                        {
                            HttpPostedFileBase file = files[i];
                            string fname;

                            string extension = System.IO.Path.GetExtension(file.FileName);
                            string filename = filenameDateWise(Guid.NewGuid().ToString()) + "" + extension;
                            fname = Path.Combine(Server.MapPath("~/Content/Attachment/"), filename);
                            file.SaveAs(fname);
                            attachment += "../Content/Attachment/" + filename + ",";
                        }
                        objSolution.Attachment = attachment;
                    }
                    catch (Exception ex)
                    {

                    }
                }

                db.Entry(objSolution).State = EntityState.Modified;
                db.SaveChanges();

            }
            else
            {
                SZ_Bug objSolution = new SZ_Bug();
                objSolution.Status = "OPEN";
                objSolution.CreatedBy = SessionCookieManagement.UserName;
                objSolution.CreatedUserId = SessionCookieManagement.UserId;
                objSolution.CreatedDate = DateTime.Now;
                objSolution.Description = model.Description;
                objSolution.URL = model.URL;
                objSolution.UpdatedBy = SessionCookieManagement.UserName;
                objSolution.UpdatedDate = DateTime.Now;
                objSolution.ResolveDate = null;
                objSolution.BugNo = value;
                objSolution.ContactUs = model.ContactUs;
                objSolution.Subject = model.Subject;
                if (SessionCookieManagement.UserEmail == "parthsuthar2010@gmail.com")
                {
                    objSolution.EstDate = model.EstDate;
                    objSolution.Status = model.Status;
                    if (objSolution.Status == "CLOSED")
                    {
                        objSolution.ResolveDate = DateTime.Now;
                    }
                }
                if (Request.Files.Count > 0)
                {
                    try
                    {
                        string attachment = "";
                        //  Get all files from Request object  
                        HttpFileCollectionBase files = Request.Files;
                        for (int i = 0; i < files.Count; i++)
                        {
                            HttpPostedFileBase file = files[i];
                            string fname;

                            string extension = System.IO.Path.GetExtension(file.FileName);
                            string filename = filenameDateWise(Guid.NewGuid().ToString()) + "" + extension;
                            // Get the complete folder path and store the file inside it.  
                            fname = Path.Combine(Server.MapPath("~/Content/Attachment/"), filename);
                            file.SaveAs(fname);
                            attachment += "../Content/Attachment/" + filename + ",";
                        }
                        objSolution.Attachment = attachment;
                    }
                    catch (Exception ex)
                    {

                    }
                }

                db.Entry(objSolution).State = EntityState.Added;
                db.SaveChanges();

                var htmlstring = "<h1>Bug # " + objSolution.BugNo + "</h1>";
                htmlstring = "<html><head></head><body style='font-family:Tahoma, Verdana, Segoe, sans-serif;font-size:11px;'>" + htmlstring + "</body></html>";

                ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12 |
                                       SecurityProtocolType.Tls11 |
                                       SecurityProtocolType.Tls |
                                       SecurityProtocolType.Ssl3;
                MailMessage mail = new MailMessage();
                SmtpClient SmtpServer = new SmtpClient(ConfigurationManager.AppSettings["Email.Host"]);
                mail.From = new MailAddress(ConfigurationManager.AppSettings["Email.Username"], "SynZeal Standards");

                mail.To.Add("parthsuthar2010@gmail.com");
                //mail.To. = adminemail;
                mail.Subject = "SPMS: New Bug Added by " + SessionCookieManagement.UserName + " on " + System.DateTime.Now;
                mail.Body = htmlstring;
                mail.IsBodyHtml = true;
                SmtpServer.Port = Convert.ToInt32(ConfigurationManager.AppSettings["Port"]);
                SmtpServer.Credentials = new System.Net.NetworkCredential(ConfigurationManager.AppSettings["Email.Username"], ConfigurationManager.AppSettings["Email.Password"]);
                SmtpServer.EnableSsl = true;
                SmtpServer.Send(mail);
            }

            return Json("", JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public JsonResult saveSolutionData(SZ_SolutionModule model, int id)
        {
            var querymodule = db.SZ_QueryModule.Where(x => x.Id == model.Id).FirstOrDefault();
            if (querymodule != null)
            {
                int solnumber = 1;
                var lastsolution = db.SZ_SolutionModule.OrderByDescending(x => x.Id).FirstOrDefault();
                if (lastsolution != null)
                {
                    solnumber += lastsolution.Id;
                }
                var solutionId = Request.Form["SolutionId"] != null ? Convert.ToInt32(Request.Form["SolutionId"].ToString()) : 0;
                if (solutionId != null && solutionId != 0)
                {
                    SZ_SolutionModule objSolution = db.SZ_SolutionModule.Where(x => x.Id == solutionId).FirstOrDefault();

                    objSolution.Status = Request.Form["Status"] != null ? Request.Form["Status"].ToString() : "";
                    objSolution.Solution = Request.Form["Solution"] != null ? Request.Form["Solution"].ToString() : "";
                    objSolution.Symptom = Request.Form["Symptom"] != null ? Request.Form["Symptom"].ToString() : "";
                    objSolution.Cause = Request.Form["Cause"] != null ? Request.Form["Cause"].ToString() : "";
                    objSolution.Remark = Request.Form["Remark"] != null ? Request.Form["Remark"].ToString() : "";
                    objSolution.ProductName = querymodule.ProductName;
                    objSolution.CASNo = querymodule.CASNo;
                    objSolution.CATNo = querymodule.CATNo;
                    objSolution.BatchNo = querymodule.BatchNo;
                    objSolution.CreatedBy = SessionCookieManagement.UserName;
                    if (objSolution.Solution == "undefined")
                    {
                        objSolution.Solution = string.Empty;
                    }
                    if (objSolution.Symptom == "undefined")
                    {
                        objSolution.Symptom = string.Empty;
                    }
                    if (objSolution.Cause == "undefined")
                    {
                        objSolution.Cause = string.Empty;
                    }
                    if (objSolution.Remark == "undefined")
                    {
                        objSolution.Remark = string.Empty;
                    }
                    if (Request.Files.Count > 0)
                    {
                        try
                        {
                            string attachment = "";
                            //  Get all files from Request object  
                            HttpFileCollectionBase files = Request.Files;
                            for (int i = 0; i < files.Count; i++)
                            {
                                HttpPostedFileBase file = files[i];
                                string fname;

                                string extension = System.IO.Path.GetExtension(file.FileName);
                                string filename = filenameDateWise(Guid.NewGuid().ToString()) + "" + extension;
                                // Get the complete folder path and store the file inside it.  
                                fname = Path.Combine(Server.MapPath("~/Content/Attachment/"), filename);
                                file.SaveAs(fname);
                                attachment += "../Content/Attachment/" + filename + ",";
                            }
                            objSolution.Attachment = attachment;
                        }
                        catch (Exception ex)
                        {

                        }
                    }

                    db.Entry(objSolution).State = EntityState.Modified;
                    db.SaveChanges();
                }
                else
                {
                    SZ_SolutionModule objSolution = new SZ_SolutionModule();
                    objSolution.Status = Request.Form["Status"] != null ? Request.Form["Status"].ToString() : "";
                    objSolution.SolutionNumber = solnumber;
                    objSolution.Solution = Request.Form["Solution"] != null ? Request.Form["Solution"].ToString() : "";
                    objSolution.Symptom = Request.Form["Symptom"] != null ? Request.Form["Symptom"].ToString() : "";
                    objSolution.Cause = Request.Form["Cause"] != null ? Request.Form["Cause"].ToString() : "";
                    objSolution.Remark = Request.Form["Remark"] != null ? Request.Form["Remark"].ToString() : "";
                    objSolution.ProductName = querymodule.ProductName;
                    objSolution.CASNo = querymodule.CASNo;
                    objSolution.CATNo = querymodule.CATNo;
                    objSolution.BatchNo = querymodule.BatchNo;
                    objSolution.CreatedDate = DateTime.Now;
                    objSolution.CreatedBy = SessionCookieManagement.UserName;
                    if (objSolution.Solution == "undefined")
                    {
                        objSolution.Solution = string.Empty;
                    }
                    if (objSolution.Symptom == "undefined")
                    {
                        objSolution.Symptom = string.Empty;
                    }
                    if (objSolution.Cause == "undefined")
                    {
                        objSolution.Cause = string.Empty;
                    }
                    if (objSolution.Remark == "undefined")
                    {
                        objSolution.Remark = string.Empty;
                    }
                    if (Request.Files.Count > 0)
                    {
                        try
                        {
                            string attachment = "";
                            //  Get all files from Request object  
                            HttpFileCollectionBase files = Request.Files;
                            for (int i = 0; i < files.Count; i++)
                            {
                                HttpPostedFileBase file = files[i];
                                string fname;

                                string extension = System.IO.Path.GetExtension(file.FileName);
                                string filename = filenameDateWise(Guid.NewGuid().ToString()) + "" + extension;
                                // Get the complete folder path and store the file inside it.  
                                fname = Path.Combine(Server.MapPath("~/Content/Attachment/"), filename);
                                file.SaveAs(fname);
                                attachment += "../Content/Attachment/" + filename + ",";
                            }
                            objSolution.Attachment = attachment;
                        }
                        catch (Exception ex)
                        {

                        }
                    }

                    db.Entry(objSolution).State = EntityState.Added;
                    db.SaveChanges();
                }
            }
            return Json("", JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public JsonResult saveQueryModuleData(SZ_QueryModule model)
        {
            var querymodule = db.SZ_QueryModule.Where(x => x.Id == model.Id).FirstOrDefault();
            if (querymodule != null)
            {
                querymodule.SubStatus = model.SubStatus;
                if (model.Status == "Completed" && querymodule.Status != "Completed")
                {
                    querymodule.CompletedDate = DateTime.Now;
                }
                if (model.Status == "In Process" && querymodule.Status != "In Process")
                {
                    querymodule.InProcessDate = DateTime.Now;
                }
                querymodule.Status = model.Status;
                querymodule.Priority = model.Priority;
                querymodule.TeamLeaderId = model.TeamLeaderId;
                querymodule.ScientistId = model.ScientistId;
                querymodule.PrimaryEmail = model.PrimaryEmail;
                querymodule.CCEmail = model.CCEmail;
                querymodule.ClosingOn = model.ClosingOn;
                querymodule.ClosingDate = model.ClosingDate;
                querymodule.ClientRemark = model.ClientRemark;
                querymodule.IsDispatched = model.IsDispatched;
                querymodule.IsAnalytical = model.IsAnalytical;
                querymodule.Scientist = model.Scientist;
                querymodule.TeamLeader = model.TeamLeader;
                db.Entry(querymodule).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json("", JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public ActionResult QueryModuleAttachment()
        {
            int Id = Convert.ToInt32(Request.Form["Id"].ToString());
            // Checking no of files injected in Request object  
            if (Request.Files.Count > 0)
            {
                try
                {
                    string attachment = "";
                    //  Get all files from Request object  
                    HttpFileCollectionBase files = Request.Files;
                    for (int i = 0; i < files.Count; i++)
                    {
                        HttpPostedFileBase file = files[i];
                        string fname;

                        string extension = System.IO.Path.GetExtension(file.FileName);
                        string filename = filenameDateWise(Guid.NewGuid().ToString()) + "" + extension;
                        // Get the complete folder path and store the file inside it.  
                        fname = Path.Combine(Server.MapPath("~/Content/Attachment/"), filename);
                        file.SaveAs(fname);
                        attachment += "../Content/Attachment/" + filename + ",";
                    }
                    var queryModule = db.SZ_QueryModule.Where(x => x.Id == Id).FirstOrDefault();
                    if (queryModule != null)
                    {
                        queryModule.Attachment += attachment;
                        db.Entry(queryModule).State = EntityState.Modified;
                        db.SaveChanges();

                        attachment = queryModule.Attachment;
                    }
                    // Returns message that successfully uploaded  
                    return Json(new { attachment = attachment, success = true }, JsonRequestBehavior.AllowGet);
                }
                catch (Exception ex)
                {
                    return Json(new { message = "Error occurred. Error details: " + ex.Message, success = false }, JsonRequestBehavior.AllowGet);
                }
            }
            else
            {
                return Json(new { message = "No files selected.", success = false }, JsonRequestBehavior.AllowGet);
            }
        }

        [HttpGet]
        public JsonResult DeleteAttchment(string filename, int id)
        {
            string attachment = "";
            var queryModule = db.SZ_QueryModule.Where(x => x.Id == id).FirstOrDefault();
            if (queryModule != null)
            {
                queryModule.Attachment = queryModule.Attachment.Replace(filename, "");
                db.Entry(queryModule).State = EntityState.Modified;
                db.SaveChanges();

                attachment = queryModule.Attachment;
            }
            return Json(attachment, JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        public ActionResult clubquotepricescreen(List<QuotationListModel> modelusd, List<QuotationListModel> modelinr, int companyId)
        {
            var companyRecord = db.SZ_CompanyList.Where(x => x.Id == companyId).FirstOrDefault();
            int refNo = 1;
            string value = string.Empty;
            string matchingstring = "SZ-" + DateTime.Now.ToString("ddMMyy") + "-";
            var SZ_Quotationdata = (from i in db.SZ_Quotation
                                    where i.Ref.StartsWith(matchingstring)
                                    select i).ToList();
            if (SZ_Quotationdata.Count > 0)
            {
                refNo = SZ_Quotationdata.Select(x => ExtractQuoreRefNumber(x.Ref)).Max(w => w);
                int newbrokerrewf = Convert.ToInt32(refNo) + 1;

                value = "SZ-" + DateTime.Now.ToString("ddMMyy") + "-" + newbrokerrewf.ToString().PadLeft(2, '0');
            }
            else
            {
                value = "SZ-" + DateTime.Now.ToString("ddMMyy") + "-01";
            }
            int QuoteId = 0;
            SZ_Quotation objquote = new SZ_Quotation();
            objquote.Ref = value;
            objquote.CompanyId = companyRecord.Id;
            objquote.CompanyName = companyRecord.Name;
            objquote.EmailAddress = "";
            objquote.ClientRef = "";
            objquote.IsImageAttach = false;
            objquote.PONo = "";
            objquote.Remark = "";
            objquote.TermsId = null;
            objquote.CountryType = companyRecord.CountryType;
            objquote.UserDistType = companyRecord.UserDistType;
            objquote.IsToBe = false;
            objquote.IsQuoteApproved = false;
            objquote.IsCOA = true;
            objquote.Auction = false;
            //TODO: Stoped PO Update Date
            //objquote.PODate = DateTime.Now;
            objquote.SuggChemName = string.Empty;
            objquote.Attachment = string.Empty;
            objquote.CreatedDate = DateTime.Now;
            objquote.EmailCC = string.Empty;
            objquote.IsFollowupRequired = true;
            objquote.CreatedBy = SessionCookieManagement.UserName;
            objquote.LayoutType = "Standard";
            objquote.IsInstock = false;
            objquote.IsCustomSynthesis = false;
            if (objquote.CountryType == "Export")
            {
                objquote.IsAnalyticalData = true; objquote.CountryType = "Export";
                objquote.CountryTypeId = 2;
            }
            else
            {
                objquote.CountryType = "Domestic";
                objquote.CountryTypeId = 1;
            }
            db.SZ_Quotation.Add(objquote);
            db.SaveChanges();

            QuoteId = objquote.Id;

            if (companyRecord.CountryType == "Export")
            {
                //Export
                int displayOrder = 0;
                foreach (var i in modelusd)
                {
                    var product = db.Products.Where(x => x.Id == i.ProductId).FirstOrDefault();
                    if (product != null)
                    {
                        SZ_QuotationDetail objdetails = new SZ_QuotationDetail();
                        objdetails.IsUploadServer = true;
                        objdetails.CASNo = product.ManufacturerPartNumber;
                        objdetails.CATNo = product.Sku;
                        objdetails.CreatedDate = DateTime.Now;
                        objdetails.ImagePath = string.Empty;
                        objdetails.LeadTime = i.LeadTime;
                        objdetails.EstimateDispatchDate = null;
                        objdetails.Price = i.Price;
                        objdetails.FinalPrice = string.Empty;
                        objdetails.ProductId = i.ProductId;
                        objdetails.ProductName = product.Name;
                        objdetails.QuoteId = objquote.Id;
                        objdetails.DisplayOrder = displayOrder;
                        objdetails.ProductRemark = i.ProductRemark;
                        objdetails.ProcessState = (int)EnumList.ProcessState.InProgress;
                        objdetails.ProjectStatus = (int)EnumList.ProjectStatus.NoAction;
                        objdetails.IsSynthesisLog = false;
                        db.SZ_QuotationDetail.Add(objdetails);

                        displayOrder += 1;
                    }
                }

                db.SaveChanges();
            }
            else
            {
                //Domestic
                int displayOrder = 0;
                foreach (var i in modelinr)
                {
                    var product = db.Products.Where(x => x.Id == i.ProductId).FirstOrDefault();
                    if (product != null)
                    {
                        SZ_QuotationDetail objdetails = new SZ_QuotationDetail();
                        objdetails.IsUploadServer = true;
                        objdetails.CASNo = product.ManufacturerPartNumber;
                        objdetails.CATNo = product.Sku;
                        objdetails.CreatedDate = DateTime.Now;
                        objdetails.ImagePath = string.Empty;
                        objdetails.LeadTime = i.LeadTime;
                        objdetails.EstimateDispatchDate = null;
                        objdetails.Price = i.Price;
                        objdetails.FinalPrice = string.Empty;
                        objdetails.ProductId = i.ProductId;
                        objdetails.ProductName = product.Name;
                        objdetails.QuoteId = objquote.Id;
                        objdetails.DisplayOrder = displayOrder;
                        objdetails.ProductRemark = i.ProductRemark;
                        objdetails.ProcessState = (int)EnumList.ProcessState.InProgress;
                        objdetails.ProjectStatus = (int)EnumList.ProjectStatus.NoAction;
                        objdetails.IsSynthesisLog = false;
                        db.SZ_QuotationDetail.Add(objdetails);

                        displayOrder += 1;
                    }
                }

                db.SaveChanges();
            }
            return Json(QuoteId);
        }

        public ActionResult SaveQuoteLogInfoFromDispatch(List<DispatchQuoteLogModel> model)
        {

            model.ForEach(m =>
            {
                var data = _operationRepository.GetQuoteDetailByID(m.id);
                if (data != null)
                {
                    var oldModel = LogManagement.PrepareQuoteDetailEntity(data);
                    data.AdditionalBatchNo = m.additionalBatch;
                    if (m.coa.HasValue)
                    {
                        data.COAId = m.coa;
                        data.COARefNumber = db.SZ_ChildCOA.Where(x => x.Id == data.COAId).Select(x => x.RefNo).FirstOrDefault();
                    }
                    else
                    {
                        data.COAId = null;
                        data.COARefNumber = string.Empty;
                    }

                    data.ActivityStatus = m.activitystatus;
                    db.Entry(data).State = EntityState.Modified;
                    db.SaveChanges();

                    LogManagement.AddDispatchLog(data, oldModel);
                }
            });

            return Json("ok", JsonRequestBehavior.AllowGet);
        }
        //public ActionResult SaveQuoteLogInfoFromDispatch(int id, int? additionalBatch, int? coa, string activitystatus)
        //{
        //    var data = _operationRepository.GetQuoteDetailByID(id);
        //    if (data != null)
        //    {
        //        var oldModel = LogManagement.PrepareQuoteDetailEntity(data);
        //        data.AdditionalBatchNo = additionalBatch;
        //        if (coa.HasValue)
        //        {
        //            data.COAId = coa;
        //            data.COARefNumber = db.SZ_ChildCOA.Where(x => x.Id == data.COAId).Select(x => x.RefNo).FirstOrDefault();
        //        }
        //        else
        //        {
        //            data.COAId = null;
        //            data.COARefNumber = string.Empty;
        //        }

        //        data.ActivityStatus = activitystatus;
        //        db.Entry(data).State = EntityState.Modified;
        //        db.SaveChanges();

        //        LogManagement.AddDispatchLog(data, oldModel);
        //    }
        //    return Json("ok", JsonRequestBehavior.AllowGet);
        //}

        public ActionResult RemoveHoldManually(int id)
        {
            var data = _operationRepository.GetQuoteDetailByID(id);
            if (data != null)
            {
                data.IsHoldManually = false;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }
            return RedirectToAction("ScientistNewForm");
        }

        public ActionResult PaymentTerm()
        {
            if (!SessionCookieManagement.IsAdmin)
            {
                return RedirectToAction("Index", "Home");
            }
            var model = db.PaymentTerms.ToList();
            return View(model);
        }

        public ActionResult AddpaymentTerm(int id = 0)
        {
            var model = db.PaymentTerms.Where(x => x.Id == id).FirstOrDefault();
            if (model == null)
                model = new PaymentTerm();

            return View(model);
        }
        [HttpPost]
        public JsonResult AddpaymentTermData(string name, int? day, string note, int id)
        {
            try
            {
                if (note == "undefined")
                {
                    note = "";
                }
                if (id == 0)
                {
                    PaymentTerm objComp = new PaymentTerm();
                    objComp.Name = name;
                    objComp.Note = note;
                    objComp.Day = day;
                    objComp.CreatedDate = DateTime.Now;
                    objComp.UpdatedDate = DateTime.Now;
                    objComp.UpdatedBy = SessionCookieManagement.UserName;
                    db.PaymentTerms.Add(objComp);
                    db.SaveChanges();
                }
                else
                {
                    var comp = db.PaymentTerms.Where(x => x.Id == id).FirstOrDefault();
                    if (comp != null)
                    {
                        comp.Name = name;
                        comp.Note = note;
                        comp.Day = day;
                        comp.UpdatedDate = DateTime.Now;
                        comp.UpdatedBy = SessionCookieManagement.UserName;
                        db.Entry(comp).State = EntityState.Modified;
                        db.SaveChanges();
                    }
                }

                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = ""
                }, JsonRequestBehavior.AllowGet);
            }
        }

        public ActionResult QcModuleList()
        {
            if (!SessionCookieManagement.IsLogin)
            {
                return RedirectToAction("Index", "Home");
            }

            var str = "<select id='fltapprovestatus' class='form-control fltclsappropro'><option value=''>--Select--</option>";
            foreach (EnumList.ApprovedStatus r in Enum.GetValues(typeof(EnumList.ApprovedStatus)))
            {
                var item = Enum.GetName(typeof(EnumList.ApprovedStatus), r);
                var test = r.ToString();
                string text = SZ_Helper.GetEnumDescription((EnumList.ApprovedStatus)(int)r);
                int val = (int)r;
                string selected = "";
                str += "<option value='" + val + "' " + selected + ">" + text + "</option>";
            }
            str += "</select>";
            ViewBag.fltapprovestatus = str;
            return View();
        }

        public ActionResult NotificationQuote()
        {
            if (!SessionCookieManagement.IsQuote)
            {
                return RedirectToAction("Index", "Home");
            }

            return View();
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult UpdateQCFormRecord(QCInfoModel model)
        {
            var data = (from i in db.SZ_QuoteDetailForm
                        join t3 in db.SZ_QuoteDetails_Form on i.Id equals t3.FormId
                        join t2 in db.SZ_QuotationDetail on t3.QuoteDetailsId equals t2.Id
                        where i.Id == model.formId
                        select i).FirstOrDefault();
            if (data != null)
            {
                //if (model.TableId == "tblinventory")
                //{
                //    var quotedetailsrecord = data.SZ_QuotationDetail;
                //    quotedetailsrecord.AdditionalBatchNo = model.BatchId;
                //    db.Entry(quotedetailsrecord).State = EntityState.Modified;
                //}
                data.ApprovedAs = model.ApprovedAs;

                if (data.ApprovalStatus != Convert.ToString((int)EnumList.ApprovedStatus.QCApproved) && model.ApprovedStatus == Convert.ToString((int)EnumList.ApprovedStatus.QCApproved))
                {
                    //Approved Mail
                    data.QCApprovedDate = DateTime.Now;
                }
                data.ApprovalStatus = model.ApprovedStatus;
                data.RecommendedPeriod = model.RecommondationRetest;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();

                var quotedetailsdata = _operationRepository.GetQuoteDetailByID(data.QuotationDetailsId);
                if (quotedetailsdata != null)
                {
                    if (data.ApprovalStatus == Convert.ToString((int)EnumList.ApprovedStatus.QCApproval))
                    {
                        quotedetailsdata.ProStatus = Convert.ToString((int)EnumList.ProStatusDDL.QCApproval);
                        quotedetailsdata.OtherProStatus = Convert.ToString((int)EnumList.ProStatusDDL.QCApproval);
                        quotedetailsdata.DispatchStatus = Convert.ToString((int)EnumList.DispatchStatusDDl.QCApproval);
                        quotedetailsdata.ReviewSciStatus = Convert.ToString((int)EnumList.ScientistReviewStatusDDL.QCApproval);
                        quotedetailsdata.ExplainationSecond = "Batch data is under QC approval and we will submit the batch as per estimated completion date.";
                    }
                    if (data.ApprovalStatus == Convert.ToString((int)EnumList.ApprovedStatus.QCApproved))
                    {
                        quotedetailsdata.ProStatus = Convert.ToString((int)EnumList.ProStatusDDL.QCApproved);
                        quotedetailsdata.OtherProStatus = Convert.ToString((int)EnumList.ProStatusDDL.QCApproved);
                        quotedetailsdata.DispatchStatus = Convert.ToString((int)EnumList.ProStatusDDL.QCApproved);
                        quotedetailsdata.ReviewSciStatus = Convert.ToString((int)EnumList.ScientistReviewStatusDDL.QCApproved);
                        quotedetailsdata.ExplainationSecond = "Batch data has been approved by QC and we will submit the batch as per estimated completion date. ";
                    }
                    if (data.ApprovalStatus == Convert.ToString((int)EnumList.ApprovedStatus.QCCorrection))
                    {
                        quotedetailsdata.ProStatus = Convert.ToString((int)EnumList.ProStatusDDL.QCCorrection);
                        quotedetailsdata.OtherProStatus = Convert.ToString((int)EnumList.ProStatusDDL.QCCorrection);
                        quotedetailsdata.DispatchStatus = Convert.ToString((int)EnumList.ProStatusDDL.QCCorrection);
                        quotedetailsdata.ReviewSciStatus = Convert.ToString((int)EnumList.ScientistReviewStatusDDL.QCCorrection);
                        quotedetailsdata.ExplainationSecond = "QC has raised query in submitted batch and we will resolve and submit as per estimated completion date. ";
                    }

                    //if (data.ApprovalStatus == Convert.ToString((int)EnumList.ApprovedStatus.QCApproval))
                    //{
                    //    quotedetailsdata.ProStatus = Convert.ToString((int)EnumList.ProStatusDDL.QCApproval);
                    //    quotedetailsdata.OtherProStatus = Convert.ToString((int)EnumList.ProInstockexportStatusDDL.QCApproval);
                    //    quotedetailsdata.DispatchStatus = Convert.ToString((int)EnumList.DispatchStatusDDl.QCApproval);
                    //    quotedetailsdata.ReviewSciStatus = Convert.ToString((int)EnumList.ScientistReviewStatusDDL.QCApproval);

                    //}
                    //if (data.ApprovalStatus == Convert.ToString((int)EnumList.ApprovedStatus.QCApproved))
                    //{
                    //    quotedetailsdata.ProStatus = Convert.ToString((int)EnumList.ProStatusDDL.QCApproved);
                    //    quotedetailsdata.OtherProStatus = Convert.ToString("14");
                    //    quotedetailsdata.DispatchStatus = Convert.ToString("14");
                    //    quotedetailsdata.ReviewSciStatus = Convert.ToString((int)EnumList.ScientistReviewStatusDDL.QCApproved);
                    //}
                    //if (data.ApprovalStatus == Convert.ToString((int)EnumList.ApprovedStatus.QCCorrection))
                    //{
                    //    quotedetailsdata.ProStatus = Convert.ToString((int)EnumList.ProStatusDDL.QCCorrection);
                    //    quotedetailsdata.OtherProStatus = Convert.ToString("13");
                    //    quotedetailsdata.DispatchStatus = Convert.ToString("13");
                    //    quotedetailsdata.ReviewSciStatus = Convert.ToString((int)EnumList.ScientistReviewStatusDDL.QCCorrection);
                    //}

                    db.Entry(quotedetailsdata).State = EntityState.Modified;
                    db.SaveChanges();
                }
            }
            else
            {
                return Json("Form Data Not Found. Form Id : " + model.formId, JsonRequestBehavior.AllowGet);
            }
            return Json("", JsonRequestBehavior.AllowGet);
        }

        [HttpPost]
        [ValidateInput(false)]
        public ActionResult UpdateQCRecord(QCInfoModel model)
        {

            //var data = (from i in db.SZ_QuoteDetailForm
            //            join t2 in db.SZ_QuotationDetail on i.QuotationDetailsId equals t2.Id
            //            where i.Id == model.formId
            //            select t2).FirstOrDefault();
            var data = (from t2 in db.SZ_QuotationDetail
                        where t2.Id == model.QuotationDetailsId
                        select t2).FirstOrDefault();
            if (data != null)
            {
                if (model.TableId == "tblworkingstandard")
                {
                    data.PrimaryStdOrdered = model.PrimaryStdOrdered;
                    data.ColumnOrder = model.ColumnOrder;
                    data.SystemSuitability = model.SystemSuitability;
                    data.AdditionalBatchNo = model.BatchId;
                }
                if (model.TableId == "tblinventory" || model.TableId == "tbldispatch")
                {
                    data.AdditionalBatchNo = model.BatchId;
                }
                data.ApprovedAs = model.ApprovedAs;

                if (data.ApprovalStatus != Convert.ToString((int)EnumList.ApprovedStatus.QCApproved) && model.ApprovedStatus == Convert.ToString((int)EnumList.ApprovedStatus.QCApproved))
                {
                    data.QCApprovedDate = DateTime.Now;
                }
                data.ApprovedAs = model.ApprovedAs;
                data.ApprovalStatus = model.ApprovedStatus;
                if (data.ApprovalStatus == Convert.ToString((int)EnumList.ApprovedStatus.QCApproval))
                {
                    data.ProStatus = Convert.ToString((int)EnumList.ProStatusDDL.QCApproval);
                    data.OtherProStatus = Convert.ToString((int)EnumList.ProStatusDDL.QCApproval);
                    data.DispatchStatus = Convert.ToString((int)EnumList.DispatchStatusDDl.QCApproval);
                    data.ReviewSciStatus = Convert.ToString((int)EnumList.ScientistReviewStatusDDL.QCApproval);
                    data.ExplainationSecond = "Batch data is under QC approval and we will submit the batch as per estimated completion date.";
                }

                if (data.ApprovalStatus == Convert.ToString((int)EnumList.ApprovedStatus.QCApproved))
                {
                    data.ProStatus = Convert.ToString((int)EnumList.ProStatusDDL.QCApproved);
                    data.OtherProStatus = Convert.ToString((int)EnumList.ProStatusDDL.QCApproved);
                    data.DispatchStatus = Convert.ToString((int)EnumList.ProStatusDDL.QCApproved);
                    data.ReviewSciStatus = Convert.ToString((int)EnumList.ScientistReviewStatusDDL.QCApproved);
                    data.ExplainationSecond = "Batch data has been approved by QC and we will submit the batch as per estimated completion date. ";
                    if (model.TableId == "tbldispatch" || model.TableId == "tblallinstock")
                    {
                        data.ProStatus = Convert.ToString((int)EnumList.ProStatusDDL.ReadyforDispatch);
                        data.OtherProStatus = Convert.ToString((int)EnumList.ProStatusDDL.ReadyforDispatch);
                        data.DispatchStatus = Convert.ToString((int)EnumList.ProStatusDDL.ReadyforDispatch);
                        data.ReviewSciStatus = Convert.ToString((int)EnumList.ProStatusDDL.ReadyforDispatch);
                        data.ReviewSciStatus = Convert.ToString((int)EnumList.ProStatusDDL.ReadyforDispatch);
                        data.IsDispatchApprove = true;
                        data.ExplainationSecond = "Product is available now and processed for dispatch. ";
                    }
                }
                if (data.ApprovalStatus == Convert.ToString((int)EnumList.ApprovedStatus.QCCorrection))
                {
                    data.ProStatus = Convert.ToString((int)EnumList.ProStatusDDL.QCCorrection);
                    data.OtherProStatus = Convert.ToString((int)EnumList.ProStatusDDL.QCCorrection);
                    data.DispatchStatus = Convert.ToString((int)EnumList.ProStatusDDL.QCCorrection);
                    data.ReviewSciStatus = Convert.ToString((int)EnumList.ScientistReviewStatusDDL.QCCorrection);
                    data.ExplainationSecond = "QC has raised query in submitted batch and we will resolve and submit as per estimated completion date. ";
                }
                //if (data.ApprovalStatus == Convert.ToString((int)EnumList.ApprovedStatus.QCApproved))
                //{
                //    data.ProStatus = Convert.ToString((int)EnumList.ProStatusDDL.QCApproved);
                //    data.OtherProStatus = Convert.ToString("14");
                //    data.DispatchStatus = Convert.ToString("14");
                //    data.ReviewSciStatus = Convert.ToString((int)EnumList.ScientistReviewStatusDDL.QCApproved);

                //    if (model.TableId == "tbldispatch" || model.TableId == "tblallinstock")
                //    {
                //        data.ProStatus = Convert.ToString((int)EnumList.ProStatusDDL.ReadyforDispatch);
                //        data.OtherProStatus = Convert.ToString("15");
                //        data.DispatchStatus = Convert.ToString("15");
                //        data.ReviewSciStatus = Convert.ToString("15");
                //        data.ReviewSciStatus = Convert.ToString("15");
                //        data.IsDispatchApprove = true;
                //    }
                //}
                //if (data.ApprovalStatus == Convert.ToString((int)EnumList.ApprovedStatus.QCCorrection))
                //{
                //    data.ProStatus = Convert.ToString((int)EnumList.ProStatusDDL.QCCorrection);
                //    data.OtherProStatus = Convert.ToString("13");
                //    data.DispatchStatus = Convert.ToString("13");
                //    data.ReviewSciStatus = Convert.ToString((int)EnumList.ScientistReviewStatusDDL.QCCorrection);
                //}
                data.RecommendedPeriod = model.RecommondationRetest;
                db.Entry(data).State = EntityState.Modified;
                db.SaveChanges();
            }
            return Json("", JsonRequestBehavior.AllowGet);
        }

        public ActionResult ApprovedsubmittedFormInventoryData(int formid)
        {
            var formdata = db.SZ_QuoteDetailForm.Where(x => x.Id == formid).FirstOrDefault();
            if (formdata != null)
            {
                var quotedetails = _operationRepository.GetQuoteDetailByID(formdata.QuotationDetailsId);
                var productData = db.Products.Where(x => x.Sku.Trim().ToLower() == formdata.CATNo.Trim().ToLower().Replace("\t", "") && x.Deleted == false && x.Published == true).FirstOrDefault();
                SZ_Inventory objInv = db.SZ_Inventory.Where(x => x.BatchNo.Trim().ToLower() == formdata.BatchCode.Trim().ToLower()).FirstOrDefault();
                if (objInv != null)
                {
                    objInv.ProductId = productData.Id;
                    objInv.BatchNo = formdata.BatchCode;
                    if (!string.IsNullOrEmpty(formdata.Qty))
                    {
                        objInv.Qty = Convert.ToDecimal(formdata.Qty);
                    }
                    objInv.IsApproved = false;
                    objInv.CreatedDate = DateTime.Now;
                    objInv.Remarks = formdata.State;
                    db.Entry(objInv).State = EntityState.Modified;
                    db.SaveChanges();
                }
                else
                {
                    objInv = new SZ_Inventory();
                    objInv.ProductId = productData.Id;
                    objInv.BatchNo = formdata.BatchCode;
                    if (!string.IsNullOrEmpty(formdata.Qty))
                    {
                        objInv.Qty = Convert.ToDecimal(formdata.Qty);
                    }
                    objInv.IsApproved = false;
                    objInv.CreatedDate = DateTime.Now;
                    objInv.Remarks = formdata.State;
                    db.SZ_Inventory.Add(objInv);

                    if (quotedetails.ProjectType != Convert.ToString((int)EnumList.ProjectType.InHouse))
                    {
                        if (quotedetails.ProjectType != Convert.ToString((int)EnumList.ProjectType.InStock))
                        {
                            quotedetails.Instockdate = DateTime.Now;
                        }
                        quotedetails.ProjectStatus = (int)EnumList.ProjectStatus.MoveToInstock;
                        quotedetails.ProjectType = Convert.ToString((int)EnumList.ProjectType.InStock);
                    }
                    if (quotedetails.ProcessState <= (int)EnumList.ProcessState.MoveToInStock)
                    {
                        quotedetails.ProcessState = (int)EnumList.ProcessState.MoveToInStock;
                    }
                    db.Entry(quotedetails).State = EntityState.Modified;
                    db.SaveChanges();

                    MemoryCacheManager objCache = new MemoryCacheManager();
                    objCache.Remove("cache.inventoryData");
                }

                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { success = true, message = "Data added into inventory." }
                };
            }
            else
            {
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { success = false, message = "Sorry!!! System can not find any products from this sku. Please try again later." }
                };
            }
        }

        [HttpPost]
        public ActionResult SER(FormCollection fc, HttpPostedFileBase filess)
        {
            var file = Request.Files[0];
            var allowedExtensions = new[] { ".pdf" };
            var fileName = Path.GetFileName(file.FileName); //getting only file name(ex-ganesh.jpg)  
            var ext = Path.GetExtension(file.FileName); //getting the extension(ex-.jpg)  
            if (allowedExtensions.Contains(ext)) //check what type of extension  
            {
                string name = Path.GetFileNameWithoutExtension(fileName); //getting file name without extension  
                string myfile = name + "_" + DateTime.Now.ToString().Replace(" ", "_").Replace(":", "_").Replace("/", "_") + ext; //appending the name with id  
                                                                                                                                  // store the file inside ~/project folder(Img)  
                var path = Path.Combine(Server.MapPath("~/Content/SER/"), myfile);
                file.SaveAs(path);

                using (Stream inputPdfStream = new FileStream(path, FileMode.Open, FileAccess.Read, FileShare.Read))
                using (Stream inputImageStream = new FileStream(Server.MapPath("~/img/logo.png"), FileMode.Open, FileAccess.Read, FileShare.Read))
                using (Stream outputPdfStream = new FileStream(Server.MapPath("~/content/result.pdf"), FileMode.Create, FileAccess.Write, FileShare.None))
                {
                    var reader = new PdfReader(inputPdfStream);
                    var stamper = new PdfStamper(reader, outputPdfStream);
                    var pdfContentByte = stamper.GetOverContent(1);

                    iTextSharp.text.Image image = iTextSharp.text.Image.GetInstance(inputImageStream);
                    image.SetAbsolutePosition(10, pdfContentByte.PdfDocument.PageSize.Height - 100);
                    pdfContentByte.AddImage(image);

                    iTextSharp.text.Image signatureoneimage = iTextSharp.text.Image.GetInstance(Server.MapPath("~/images/ser01.png"));
                    signatureoneimage.SetAbsolutePosition(100, 40);
                    signatureoneimage.ScaleAbsolute(80f, 35f);
                    pdfContentByte.AddImage(signatureoneimage);

                    iTextSharp.text.Image signaturetwoimage = iTextSharp.text.Image.GetInstance(Server.MapPath("~/images/ser02.png"));
                    signaturetwoimage.SetAbsolutePosition(250, 40);
                    signaturetwoimage.ScaleAbsolute(80f, 35f);
                    pdfContentByte.AddImage(signaturetwoimage);

                    iTextSharp.text.Image signaturethreeimage = iTextSharp.text.Image.GetInstance(Server.MapPath("~/images/ser03.png"));
                    signaturethreeimage.SetAbsolutePosition(400, 40);
                    signaturethreeimage.ScaleAbsolute(80f, 35f);
                    pdfContentByte.AddImage(signaturethreeimage);

                    var numberofpages = reader.NumberOfPages;
                    for (int page = 1; page <= numberofpages; page++)
                    {
                        var pdfContentBytepage = stamper.GetOverContent(page);
                        iTextSharp.text.Image stampimage = iTextSharp.text.Image.GetInstance(Server.MapPath("~/images/stamp.png"));
                        stampimage.SetAbsolutePosition(pdfContentBytepage.PdfDocument.PageSize.Width - 110, 80);
                        stampimage.ScaleAbsolute(80f, 80f);
                        pdfContentBytepage.AddImage(stampimage);
                    }
                    stamper.Close();
                }
            }
            else
            {
                ViewBag.message = "Please choose only Image file";
            }
            return File(Server.MapPath("~/content/result.pdf"), "application/pdf", Server.UrlEncode("SER.pdf"));
        }

        public ActionResult SER()
        {
            return View();
        }

        public ActionResult PrepHPLC()
        {
            return View();
        }

        public ActionResult ParkAllQuoteFromConsoleApplication()
        {
            try
            {
                var date = DateTime.Now.AddMonths(-1);
                var data = (from i in db.SZ_Quotation
                            join t2 in db.SZ_QuotationDetail on i.Id equals t2.QuoteId
                            where i.IsToBe == true && (t2.IsSynthesisLog == false || t2.IsSynthesisLog == null)
                            && (i.IsQuoteApproved == false || i.IsQuoteApproved == null)
                            && (i.IsPark == false || i.IsPark == null)
                            && (i.UserDistType == "User" || i.UserDistType == "Distributor")
                            && i.CreatedDate <= date
                            && string.IsNullOrEmpty(i.PONo)
                            && (t2.MoveToProject == false || t2.MoveToProject == null)
                            select i).Distinct().ToList();

                if (data != null && data.Count > 0)
                {
                    data.ForEach(item =>
                    {
                        item.IsPark = true;
                        item.ParkReason = "SynthemSystem moved into park because of one month old quotation.";
                        item.IsInstock = false;
                        item.IsCustomSynthesis = false;
                        item.IsToBe = false;
                        //db.Entry(item).State = EntityState.Modified;
                    });
                    db.SaveChanges();
                }

                return Json("true", JsonRequestBehavior.AllowGet);
            }
            catch
            {
                return Json("false", JsonRequestBehavior.AllowGet);
            }
        }

        public ActionResult ClientApproved()
        {
            var listItems = new List<SelectListItem>();
            var subscilistItems = new List<SelectListItem>();
            var prostatusItem = new List<SelectListItem>();
            MemoryCacheManager objCache = new MemoryCacheManager();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });

            var scienList = objCache.Get("cache.GetScientistId", () =>
            {
                return db.GetScientistId().ToList();
            });
            listItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            subscilistItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            prostatusItem.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            scienList.ForEach(term =>
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == term).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                listItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.ToString()
                });
                subscilistItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.ToString()
                });
            });

            ViewBag.ScientistListItem = listItems;

            var subscienList = objCache.Get("cache.subscienList", () =>
            {
                return db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();
            });
            foreach (var term in subscienList)
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.EntityId == term.Id).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                subscilistItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.Id.ToString()
                });
            }
            ViewBag.SubScientistListItem = subscilistItems;

            foreach (EnumList.ProStatusDDL r in Enum.GetValues(typeof(EnumList.ProStatusDDL)))
            {
                var item = Enum.GetName(typeof(EnumList.ProStatusDDL), r);
                var test = r.ToString();
                string text = SZ_Helper.GetEnumDescription((EnumList.ProStatusDDL)(int)r);
                int val = (int)r;
                prostatusItem.Add(new SelectListItem
                {
                    Text = text,
                    Value = val.ToString()
                });
            }
            ViewBag.fltprostatusItem = prostatusItem;
            return View();
        }

        public ActionResult GetQuoteById(int id)
        {
            var quotedata = _operationRepository.GetQuoteByID(id);
            if (quotedata != null)
            {
                return Json(new { success = true, data = quotedata }, JsonRequestBehavior.AllowGet);
            }
            return Json(new { success = true, data = quotedata }, JsonRequestBehavior.AllowGet);
        }

        public ActionResult SettleUserDashboard()
        {
            var userIds = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("quote")).Select(x => x.Id).ToList();

            List<MonthWiseUserDashboardDto> mainmodel = new List<MonthWiseUserDashboardDto>();
            var startDate = DateTime.Now.AddMonths(-2);
            var endDate = DateTime.Now;
            MemoryCacheManager objCache = new MemoryCacheManager();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });
            while (startDate <= endDate)
            {
                var startMonthDate = new DateTime(startDate.Year, startDate.Month, 1);
                var endMonthDate = startDate.AddMonths(1).AddDays(-1);

                List<UserDashboardDto> model = new List<UserDashboardDto>();

                foreach (var uId in userIds)
                {
                    string customerName = string.Empty;
                    var genericAttr = genericData.Where(x => x.EntityId == uId).ToList();
                    if (genericAttr.Count > 0)
                    {
                        customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                    }
                    var szquotelist = db.SZ_Quotation.Where(x => x.CreatedBy == customerName
                    && x.CreatedDate >= startMonthDate && x.CreatedDate <= endMonthDate).ToList();

                    var quoteIds = szquotelist.Select(x => x.Id).ToList();
                    var szquotedetailslist = db.SZ_QuotationDetail.Where(x => quoteIds.Contains(x.QuoteId)).ToList();

                    var quotedetailsIds = szquotedetailslist.Select(x => x.Id).ToList();
                    var szQuotationDetailLog = db.SZ_QuotationDetailLog.Where(x => quotedetailsIds.Contains(x.QuoteDetailsId)).ToList();

                    UserDashboardDto objModel = new UserDashboardDto();
                    objModel.UserId = uId;
                    objModel.Month = startDate.Month;
                    objModel.Year = startDate.Year;
                    objModel.Username = customerName;
                    objModel.AllDetails = szquotelist.Select(x => x.SZ_QuotationDetail.Where(z => !string.IsNullOrEmpty(z.CATNo) && !string.IsNullOrEmpty(z.CASNo) && !string.IsNullOrEmpty(z.Price)).Count()).Sum(z => z);
                    objModel.WithoutCatNo = szquotelist.Select(x => x.SZ_QuotationDetail.Where(z => string.IsNullOrEmpty(z.CATNo)).Count()).Sum(z => z);
                    objModel.WithoutCasNo = szquotelist.Select(x => x.SZ_QuotationDetail.Where(z => string.IsNullOrEmpty(z.CASNo)).Count()).Sum(z => z);
                    objModel.WithoutPrice = szquotelist.Select(x => x.SZ_QuotationDetail.Where(z => string.IsNullOrEmpty(z.Price)).Count()).Sum(z => z);
                    objModel.TotalAdded = objModel.AllDetails + objModel.WithoutCatNo + objModel.WithoutCasNo;
                    objModel.RevisionCatNo = (from q in szquotelist
                                              join qd in szquotedetailslist on q.Id equals qd.QuoteId
                                              join l in szQuotationDetailLog on qd.Id equals l.QuoteDetailsId
                                              where l.PropertyName == "CATNo" && !string.IsNullOrEmpty(l.Before)
                                              && !string.IsNullOrEmpty(l.After)
                                              && l.UserId != uId
                                              select qd).Count();

                    objModel.RevisionCasNo = (from q in szquotelist
                                              join qd in szquotedetailslist on q.Id equals qd.QuoteId
                                              join l in szQuotationDetailLog on qd.Id equals l.QuoteDetailsId
                                              where l.PropertyName == "CAS No" && !string.IsNullOrEmpty(l.Before)
                                              && !string.IsNullOrEmpty(l.After)
                                              && l.UserId != uId
                                              select qd).Count();

                    objModel.RevisionPrice = (from q in szquotelist
                                              join qd in szquotedetailslist on q.Id equals qd.QuoteId
                                              join l in szQuotationDetailLog on qd.Id equals l.QuoteDetailsId
                                              where l.PropertyName == "Price" && !string.IsNullOrEmpty(l.Before)
                                              && !string.IsNullOrEmpty(l.After)
                                              && l.UserId != uId
                                              select qd).Count();

                    objModel.TotalRevisionProduct = objModel.TotalAdded - objModel.RevisionCatNo - objModel.RevisionCasNo - objModel.RevisionPrice;
                    model.Add(objModel);

                    SZ_UserDashboard objUserDashboard = db.SZ_UserDashboard.Where(x => x.UserId == uId
                    && x.Month == objModel.Month
                    && x.Year == objModel.Year).FirstOrDefault();
                    if (objUserDashboard != null)
                    {
                        //Update
                        objUserDashboard.UpdatedDate = DateTime.Now;
                        objUserDashboard.AllDetails = objModel.AllDetails;
                        objUserDashboard.WithoutCatNo = objModel.WithoutCatNo;
                        objUserDashboard.WithoutCasNo = objModel.WithoutCasNo;
                        objUserDashboard.WithoutPrice = objModel.WithoutPrice;
                        objUserDashboard.TotalAdded = objModel.TotalAdded;
                        objUserDashboard.CatNoRevision = objModel.RevisionCatNo;
                        objUserDashboard.CASNoRevision = objModel.RevisionCasNo;
                        objUserDashboard.PriceRevision = objModel.RevisionPrice;
                        objUserDashboard.TotalRevisionProduct = objModel.TotalRevisionProduct;
                        db.Entry(objUserDashboard).State = EntityState.Modified;
                    }
                    else
                    {
                        //Insert
                        objUserDashboard = new SZ_UserDashboard();
                        objUserDashboard.UserId = objModel.UserId;
                        objUserDashboard.UserName = objModel.Username;
                        objUserDashboard.Month = objModel.Month;
                        objUserDashboard.Year = objModel.Year;
                        objUserDashboard.UpdatedDate = DateTime.Now;
                        objUserDashboard.AllDetails = objModel.AllDetails;
                        objUserDashboard.WithoutCatNo = objModel.WithoutCatNo;
                        objUserDashboard.WithoutCasNo = objModel.WithoutCasNo;
                        objUserDashboard.WithoutPrice = objModel.WithoutPrice;
                        objUserDashboard.TotalAdded = objModel.TotalAdded;
                        objUserDashboard.CatNoRevision = objModel.RevisionCatNo;
                        objUserDashboard.CASNoRevision = objModel.RevisionCasNo;
                        objUserDashboard.PriceRevision = objModel.RevisionPrice;
                        objUserDashboard.TotalRevisionProduct = objModel.TotalRevisionProduct;
                        db.Entry(objUserDashboard).State = EntityState.Added;
                    }
                    db.SaveChanges();
                }
                startDate = startDate.AddMonths(1);
            }

            return Content("Success");
        }

        public ActionResult SettleSAPData()
        {
            string path = Server.MapPath("~/img/SAPdata.xlsx");

            var file = new FileInfo(path);
            var error = new List<string>();
            using (var package = new ExcelPackage(file))
            {
                var currentSheet = package.Workbook.Worksheets;
                var workSheet = currentSheet.First();
                var noOfCol = workSheet.Dimension.End.Column;
                var noOfRow = workSheet.Dimension.End.Row;
                for (int rowIterator = 2; rowIterator <= noOfRow; rowIterator++)
                {
                    string ponumber = workSheet.Cells[rowIterator, 1].Value.ToString();
                    try
                    {

                        string sapcustcode = workSheet.Cells[rowIterator, 2].Value != null ? workSheet.Cells[rowIterator, 2].Value.ToString() : string.Empty;
                        string status = workSheet.Cells[rowIterator, 3].Value != null ? workSheet.Cells[rowIterator, 3].Value.ToString() : string.Empty;
                        string sapcodeid = workSheet.Cells[rowIterator, 4].Value != null ? workSheet.Cells[rowIterator, 4].Value.ToString() : "";

                        var quotedetailsdata = db.SZ_QuotationDetail.AsNoTracking()
                                            .Where(x => x.MoveToProject == true
                                                            && x.SZ_Quotation.PONo == ponumber).ToList();

                        if (quotedetailsdata != null && quotedetailsdata.Count > 0)
                        {
                            quotedetailsdata.ForEach(item =>
                            {
                                item.IsSuccessSAP = true;
                                item.SAPSONo = sapcodeid;
                                db.Entry(item).State = EntityState.Modified;
                            });
                            db.SaveChanges();
                        }
                    }
                    catch (Exception)
                    {
                        error.Add(ponumber);
                    }
                }
            }
            return Content(string.Join(", ", error));
        }

        public ActionResult SettleSAPDataWithInformation()
        {
            string path = Server.MapPath("~/img/SAP_Data.xlsx");
            var quotedetailsList = db.SZ_QuotationDetail.ToList();

            var file = new FileInfo(path);
            var error = new List<string>();
            using (var package = new ExcelPackage(file))
            {
                var currentSheet = package.Workbook.Worksheets;
                var workSheet = currentSheet.First();
                var noOfCol = workSheet.Dimension.End.Column;
                var noOfRow = workSheet.Dimension.End.Row;
                for (int rowIterator = 2; rowIterator <= noOfRow; rowIterator++)
                {
                    string docinternalid = workSheet.Cells[rowIterator, 1].Value.ToString();
                    string ponumber = workSheet.Cells[rowIterator, 3].Value != null ? workSheet.Cells[rowIterator, 3].Value.ToString() : string.Empty;
                    string catno = workSheet.Cells[rowIterator, 7].Value != null ? workSheet.Cells[rowIterator, 7].Value.ToString() : "";

                    try
                    {
                        string sapdocnumber = workSheet.Cells[rowIterator, 2].Value != null ? workSheet.Cells[rowIterator, 2].Value.ToString() : string.Empty;
                        string saplineid = workSheet.Cells[rowIterator, 4].Value != null ? workSheet.Cells[rowIterator, 4].Value.ToString() : "";
                        string quoteid = workSheet.Cells[rowIterator, 5].Value != null ? workSheet.Cells[rowIterator, 5].Value.ToString() : "";
                        string quotedetailsid = workSheet.Cells[rowIterator, 6].Value != null ? workSheet.Cells[rowIterator, 6].Value.ToString() : "";
                        if (!string.IsNullOrEmpty(catno))
                        {
                            catno = catno.Trim().ToLower();
                        }
                        if (!string.IsNullOrEmpty(quotedetailsid))
                        {
                            int qid = Convert.ToInt32(quotedetailsid);
                            var quotedetailsdata = quotedetailsList
                                            .Where(x => x.Id == qid).FirstOrDefault();

                            if (quotedetailsdata != null)
                            {
                                quotedetailsdata.IsSuccessSAP = true;
                                quotedetailsdata.SAPSONo = saplineid;
                                quotedetailsdata.SAPSODocEntry = sapdocnumber;
                                quotedetailsdata.SAPSOLId = Convert.ToInt32(docinternalid);
                                //db.Entry(quotedetailsdata).State = EntityState.Modified;

                            }
                        }
                        if (string.IsNullOrEmpty(quotedetailsid) && !string.IsNullOrEmpty(quoteid))
                        {
                            int qid = Convert.ToInt32(quoteid);
                            var quotedetailsdata = quotedetailsList
                                                .Where(x => x.QuoteId == qid
                                                            && x.MoveToProject == true
                                                            && x.CATNo.ToLower() == catno).ToList();

                            if (quotedetailsdata != null && quotedetailsdata.Count > 0)
                            {
                                quotedetailsdata.ForEach(item =>
                                {
                                    item.IsSuccessSAP = true;
                                    item.SAPSONo = saplineid;
                                    item.SAPSODocEntry = sapdocnumber;
                                    item.SAPSOLId = Convert.ToInt32(docinternalid);
                                    //db.Entry(item).State = EntityState.Modified;
                                });

                            }
                        }
                        if (string.IsNullOrEmpty(quotedetailsid) && string.IsNullOrEmpty(quoteid))
                        {
                            var quotedetailsdata = quotedetailsList
                                                .Where(x => x.MoveToProject == true
                                                            && x.SZ_Quotation.PONo == ponumber
                                                            && x.CATNo.ToLower() == catno).ToList();

                            if (quotedetailsdata != null && quotedetailsdata.Count > 0)
                            {
                                quotedetailsdata.ForEach(item =>
                                {
                                    item.IsSuccessSAP = true;
                                    item.SAPSONo = saplineid;
                                    item.SAPSODocEntry = sapdocnumber;
                                    item.SAPSOLId = Convert.ToInt32(docinternalid);
                                    //db.Entry(item).State = EntityState.Modified;
                                });

                            }
                        }
                    }
                    catch (Exception ex)
                    {
                        error.Add(ponumber + " - " + catno);
                    }
                }

                db.SaveChanges();
            }

            return Content(string.Join(", ", error));
        }

        public ActionResult SettleProductImportant()
        {
            string path = Server.MapPath("~/img/ImportantProductData.xlsx");
            var productList = db.Products.ToList();

            var file = new FileInfo(path);
            var error = new List<string>();
            using (var package = new ExcelPackage(file))
            {
                var currentSheet = package.Workbook.Worksheets;
                var workSheet = currentSheet.First();
                var noOfCol = workSheet.Dimension.End.Column;
                var noOfRow = workSheet.Dimension.End.Row;
                for (int rowIterator = 2; rowIterator <= noOfRow; rowIterator++)
                {
                    string catno = workSheet.Cells[rowIterator, 1].Value.ToString();

                    try
                    {
                        if (!string.IsNullOrEmpty(catno))
                        {
                            catno = catno.Trim().ToLower();
                        }
                        var p = productList.Where(x => x.Sku.ToLower().Trim() == catno && x.Published == true && x.Deleted == false).FirstOrDefault();
                        if (p != null)
                        {
                            p.Important = 3;
                            db.Entry(p).State = EntityState.Modified;
                        }
                    }
                    catch (Exception ex)
                    {
                    }
                }

                db.SaveChanges();
            }

            return Content("success");
        }

        public ActionResult SettleDescription()
        {
            var processids = "";
            var category = db.Categories.Where(x => !string.IsNullOrEmpty(x.DataReference)).ToList();
            foreach (var item in category)
            {
                item.DataReference = System.Text.RegularExpressions.Regex.Replace(item.DataReference, @"\s+", " ");

                item.DataReference = item.DataReference.Replace("</p><p>", "<br />").Replace("</p> <p>", "<br />").Replace("</p>  <p>", "<br />").Replace("</p>   <p>", "<br />");
                db.Entry(item).State = EntityState.Modified;
                db.SaveChanges();
                processids += item.Name + "(" + item.Id + "), ";
            }
            return Content("Success : " + processids);
        }


        public ActionResult SettleFollowUpData()
        {
            DateTime startDate = DateTime.Now.AddMonths(-1);
            DateTime endDate = DateTime.Now;
            var quoteData = db.SZ_Quotation.Where(x => (!x.IsPark.HasValue || x.IsPark == false) && (!x.IsToBe.HasValue || x.IsToBe == false) && x.CreatedDate >= startDate && x.CreatedDate <= endDate && string.IsNullOrEmpty(x.PONo) && !x.CompanyName.Contains("synzeal")).ToList();
            if (quoteData != null && quoteData.Count > 0)
            {
                foreach (var quote in quoteData)
                {
                    var quotedetailsData = db.SZ_QuotationDetail.Where(x => x.QuoteId == quote.Id).ToList();
                    decimal total = 0;
                    int price1total = 0;
                    int price2total = 0;
                    int price3total = 0;
                    int price4total = 0;
                    var countryType = quote.CountryType;    //"Domestic" ? "INR" : "USD"
                    foreach (var details in quotedetailsData)
                    {
                        if (!string.IsNullOrEmpty(details.Price))
                        {
                            var allpricedata = details.Price.Split(',');
                            if (allpricedata.Count() == 1)
                            {
                                if (allpricedata[0].IndexOf("X") != -1)
                                {
                                    string packs = allpricedata[0].Split('X')[1];
                                    if (packs.Contains("="))
                                    {
                                        if (Convert.ToInt32(packs.Split('=')[0]) > 1)
                                        {
                                            if (!string.IsNullOrEmpty(packs.Split('=')[1].Trim().Split(' ')[0]))
                                            {
                                                total += Convert.ToDecimal(packs.Split('=')[1].Trim().Split(' ')[0]);
                                                price1total += Convert.ToInt32(packs.Split('=')[1].Trim().Split(' ')[0]);
                                            }

                                        }
                                    }
                                }
                                else
                                {
                                    try
                                    {
                                        if (!string.IsNullOrEmpty(allpricedata[0].Split(' ')[1].Split('@')[1]))
                                        {
                                            total += Convert.ToDecimal(allpricedata[0].Split(' ')[1].Split('@')[1]);
                                            price1total += Convert.ToInt32(allpricedata[0].Split(' ')[1].Split('@')[1]);
                                        }
                                    }
                                    catch
                                    {
                                        try
                                        {
                                            if (!string.IsNullOrEmpty(allpricedata[0].Split('@')[1].Trim().Split(' ')[0]))
                                            {
                                                total += Convert.ToDecimal(allpricedata[0].Split('@')[1].Trim().Split(' ')[0]);
                                                price1total += Convert.ToInt32(allpricedata[0].Split('@')[1].Trim().Split(' ')[0]);
                                            }
                                        }
                                        catch
                                        {

                                        }
                                    }
                                }
                            }
                            else
                            {
                                var cnt = new List<string>();
                                var loopcnt = 1;
                                foreach (var item in allpricedata)
                                {
                                    var qty = System.Text.RegularExpressions.Regex.Match(item.Split('@')[0], @"\d+").Value;
                                    var price = System.Text.RegularExpressions.Regex.Match(item.Split('@')[1], @"\d+").Value;
                                    if (item.Split('X').Count() > 1)
                                    {
                                        if (item.Split('X')[1].Contains("="))
                                        {
                                            if (!string.IsNullOrEmpty(item.Split('X')[1].Split('=')[1].Trim().Split(' ')[0]))
                                            {
                                                total += Convert.ToDecimal(item.Split('X')[1].Split('=')[1].Trim().Split(' ')[0]);
                                                if (loopcnt == 1)
                                                {
                                                    price1total += Convert.ToInt32(item.Split('X')[1].Split('=')[1].Trim().Split(' ')[0]);
                                                }
                                                if (loopcnt == 2)
                                                {
                                                    price2total += Convert.ToInt32(item.Split('X')[1].Split('=')[1].Trim().Split(' ')[0]);
                                                }
                                                if (loopcnt == 2)
                                                {
                                                    price3total += Convert.ToInt32(item.Split('X')[1].Split('=')[1].Trim().Split(' ')[0]);
                                                }
                                                if (loopcnt == 3)
                                                {
                                                    price4total += Convert.ToInt32(item.Split('X')[1].Split('=')[1].Trim().Split(' ')[0]);
                                                }
                                            }
                                        }
                                        else
                                        {
                                            if (!string.IsNullOrEmpty(item.Split('X')[1].Split('=')[1].Trim().Split(' ')[0]))
                                            {
                                                total += Convert.ToDecimal(item.Split('X')[1].Split('=')[1].Trim().Split(' ')[0]);
                                                if (loopcnt == 1)
                                                {
                                                    price1total += Convert.ToInt32(item.Split('X')[1].Split('=')[1].Trim().Split(' ')[0]);
                                                }
                                                if (loopcnt == 2)
                                                {
                                                    price2total += Convert.ToInt32(item.Split('X')[1].Split('=')[1].Trim().Split(' ')[0]);
                                                }
                                                if (loopcnt == 2)
                                                {
                                                    price3total += Convert.ToInt32(item.Split('X')[1].Split('=')[1].Trim().Split(' ')[0]);
                                                }
                                                if (loopcnt == 3)
                                                {
                                                    price4total += Convert.ToInt32(item.Split('X')[1].Split('=')[1].Trim().Split(' ')[0]);
                                                }
                                            }
                                        }
                                    }
                                    loopcnt += 1;
                                }
                                if (cnt.Count == 1)
                                {
                                    if (!string.IsNullOrEmpty(cnt[0].Split(' ')[1].Split('@')[1]))
                                    {
                                        total += Convert.ToDecimal(cnt[0].Split(' ')[1].Split('@')[1]);
                                    }
                                }
                            }
                        }
                    }

                    if (countryType == "Domestic")
                    {
                        if (price1total >= 360000 || price2total >= 360000 || price3total >= 360000 || price4total >= 360000)
                        {
                            quote.IsFollowupRequired = true;
                            quote.IsRemoveFollowup = false;
                        }
                    }
                    else
                    {
                        if (price1total >= 5000 || price2total >= 5000 || price3total >= 5000 || price4total >= 5000)
                        {
                            quote.IsFollowupRequired = true;
                            quote.IsRemoveFollowup = false;
                        }
                    }

                    db.Entry(quote).State = EntityState.Modified;
                    db.SaveChanges();
                }
            }

            return Content("true");
        }

        public ActionResult getProductDetailsByProductId(int id)
        {
            try
            {
                var model = (from x in db.Products
                             where x.Id == id && x.Deleted == false && x.Published == true
                             select x).FirstOrDefault();

                if (!string.IsNullOrEmpty(model.Sku))
                {
                    string uri = Domain + "/api/RestAPI/ProductDetailsBySku?sku=" + model.Sku;
                    using (HttpClient httpClient = new HttpClient())
                    {
                        Task<String> response = httpClient.GetStringAsync(uri);
                        string productModel = JsonConvert.DeserializeObject<string>(response.Result);
                        var ProductOutputModel = JsonConvert.DeserializeObject<ProductDetailsModel>(productModel);

                        var pricedata = db.SZ_PriceList.Where(x => x.ProductId == id).FirstOrDefault();
                        var pdata = new SZ_PriceList();
                        if (pricedata != null)
                        {
                            pdata.CategoryMasterUSdId = pricedata.CategoryMasterUSdId;
                            pdata.ProductId = pricedata.ProductId;
                            pdata.IsPriceApproved = pricedata.IsPriceApproved;
                            pdata.ProductRemark = pricedata.ProductRemark;
                            pdata.LeadTime = pricedata.LeadTime;
                            pdata.TenPrice = pricedata.TenPrice;
                            pdata.TwentyFivePrice = pricedata.TwentyFivePrice;
                            pdata.FiftyPrice = pricedata.FiftyPrice;
                            pdata.HundredPrice = pricedata.HundredPrice;
                            pdata.TenUSD = pricedata.TenUSD;
                            pdata.TwentyfiveUSD = pricedata.TwentyfiveUSD;
                            pdata.FiftyUSD = pricedata.FiftyUSD;
                            pdata.OnehundredUSD = pricedata.OnehundredUSD;
                        }
                        return new JsonResult()
                        {
                            JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                            Data = new { record = ProductOutputModel, pricedata = pdata, success = true }
                        };
                    }
                }
                else
                {
                    var ProductOutputModel = new ProductDetailsModel();
                    return new JsonResult()
                    {
                        JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                        Data = new { record = ProductOutputModel, success = true }
                    };
                }
            }
            catch (Exception ex)
            {
                return new JsonResult()
                {
                    JsonRequestBehavior = JsonRequestBehavior.AllowGet,
                    Data = new { record = ex.Message, success = false }
                };
            }
        }

        public ActionResult GetProductById(int id)
        {
            var product = db.Products.Where(x => x.Id == id).FirstOrDefault();
            var result = new Product()
            {
                Gtin = product.Gtin,
                Id = product.Id,
                MolecularWeight = product.MolecularWeight,
                Sku = product.Sku,
                ManufacturerPartNumber = product.ManufacturerPartNumber
            };

            return Json(result, JsonRequestBehavior.AllowGet);
        }

        public ActionResult GetInventoryDataByBatchNo(string batchno)
        {
            var inventorydata = db.SZ_Inventory.Where(x => x.BatchNo == batchno).FirstOrDefault();
            return Json(inventorydata, JsonRequestBehavior.AllowGet);
        }

        public ActionResult GetQuoteDetailsbyAdditionalBatchNoid(int batchid)
        {
            var data = db.SZ_QuotationDetail.Where(x => x.AdditionalBatchNo == batchid).OrderByDescending(x => x.Id).FirstOrDefault();
            if (data == null)
            {
                var productdata = db.SZ_Inventory.Where(x => x.Id == batchid).FirstOrDefault();
                if (productdata != null)
                {
                    var quotedetailsdata = db.SZ_QuotationDetail.Where(x => x.ProductId == productdata.ProductId).OrderByDescending(x => x.Id).FirstOrDefault();
                    if (quotedetailsdata != null)
                    {
                        var outputss = new SZ_QuotationDetailModel()
                        {
                            Id = quotedetailsdata.Id,
                            CATNo = quotedetailsdata.CATNo,
                            CASNo = quotedetailsdata.CASNo,
                            ProductName = quotedetailsdata.ProductName,
                            ProductId = quotedetailsdata.ProductId
                        };
                        return Json(outputss, JsonRequestBehavior.AllowGet);
                    }
                }

                return Json(data, JsonRequestBehavior.AllowGet);
            }

            var output = new SZ_QuotationDetailModel()
            {
                Id = data.Id,
                CATNo = data.CATNo,
                CASNo = data.CASNo,
                ProductName = data.ProductName,
                ProductId = data.ProductId
            };
            return Json(output, JsonRequestBehavior.AllowGet);

            // var list = JsonConvert.SerializeObject(new SZ_QuotationDetailModel() {
            //     Id = data.Id,
            //     CATNo = data.CATNo,
            //     CASNo = data.CASNo,
            //     ProductName = data.ProductName,
            //     ProductId = data.ProductId
            // },
            //             Formatting.None,
            //             new JsonSerializerSettings()
            //             {
            //                 ReferenceLoopHandling = Newtonsoft.Json.ReferenceLoopHandling.Ignore
            //             });

            // //return Json(list, JsonRequestBehavior.AllowGet);
            // var jsonResult = Json(list, JsonRequestBehavior.AllowGet);
            // jsonResult.MaxJsonLength = int.MaxValue;
            // return jsonResult;
        }

        public ActionResult GetQuoteDetailsFormByBatchCode(string BatchCode)
        {
            var data = db.SZ_QuoteDetailForm.Where(x => x.BatchCode == BatchCode).FirstOrDefault();
            if (data == null)
                return Json(null, JsonRequestBehavior.AllowGet);

            var model = new SZ_QuoteDetailForm()
            {
                Id = data.Id,
                QuotationDetailsId = data.QuotationDetailsId,
                SubmissionDate = data.SubmissionDate,
                CATNo = data.CATNo,
                ProjectName = data.ProjectName,
                CASNo = data.CASNo,
                ProductName = data.ProductName,
                ScientistName = data.ScientistName,
                BatchCode = data.BatchCode,
                JournalDate = data.JournalDate,
                MolWeight = data.MolWeight,
                MolFormula = data.MolFormula,
                NMRCode = data.NMRCode,
                HPCLCode = data.HPCLCode,
                MSCode = data.MSCode,
                OtherAnalysis = data.OtherAnalysis,
                TypeCompound = data.TypeCompound,
                StateCompound = data.StateCompound,
                SaltName = data.SaltName,
                StructurePath = data.StructurePath,
                Qty = data.Qty,
                Apearance = data.Apearance,
                Error = data.Error,
                CreatedDate = data.CreatedDate,
                UpdatedDate = data.UpdatedDate,
                RbSaltMentionName = data.RbSaltMentionName,
                SubmittedBy = data.SubmittedBy,
                TLName = data.TLName,
                HPLCDate = data.HPLCDate,
                HPLCPurity = data.HPLCPurity,
                ChkHygroscopic = data.ChkHygroscopic,
                RbAdditionalAnalysis = data.RbAdditionalAnalysis,
                MolecularFormula = data.MolecularFormula,
                SolutionForm = data.SolutionForm,
                SolidForm = data.SolidForm,
                State = data.State,
                NoOfFinalStep = data.NoOfFinalStep,
                EarlierSynthesized = data.EarlierSynthesized,
                PurificationBy = data.PurificationBy,
                SpectralDataAttachment = data.SpectralDataAttachment,
                Chemist = data.Chemist,
                TempSensitive = data.TempSensitive,
                Lacrymatory = data.Lacrymatory,
                StabilityRelatedComment = data.StabilityRelatedComment,
                Stability = data.Stability,
                IRAttachment = data.IRAttachment,
                MassAttachment = data.MassAttachment,
                PLCAttachment = data.PLCAttachment,
                NMRAttchment = data.NMRAttchment,
                QNMRAttchment = data.QNMRAttchment,
                TGAAttachment = data.TGAAttachment,
                CMRAttchment = data.CMRAttchment,
                DEPTAttachment = data.DEPTAttachment,
                HRMSAttachment = data.HRMSAttachment,
                ROIAttachment = data.ROIAttachment,
                ElementralAttachment = data.ElementralAttachment,
                SERAttachment = data.SERAttachment,
                GCAttachment = data.GCAttachment,
                ELSDAttachment = data.ELSDAttachment,
                ChiralAttachmenrt = data.ChiralAttachmenrt,
                IsDraftEntry = data.IsDraftEntry,
                chkNMRDone = data.chkNMRDone,
                chkCrystallizationDone = data.chkCrystallizationDone,
                APCIMassAttachment = data.APCIMassAttachment,
                ChemdrawFileAttachment = data.ChemdrawFileAttachment,
                WeightingSlipAttachment = data.WeightingSlipAttachment,
                NMRInterpretaionAttachment = data.NMRInterpretaionAttachment,
                IsDispatchedEntry = data.IsDispatchedEntry,
                LightSensitivity = data.LightSensitivity,
                ApprovalStatus = data.ApprovalStatus,
                ApprovedAs = data.ApprovedAs,
                ApprovalComment = data.ApprovalComment,
                RecommendedPeriod = data.RecommendedPeriod,
                QCApprovedDate = data.QCApprovedDate,
                Photostability = data.Photostability,
                UVSpectra = data.UVSpectra,
                OtherAnalysisAttachment = data.OtherAnalysisAttachment,
                N1NmrAttachment = data.N1NmrAttachment,
                ChiralHPLCAttachment = data.ChiralHPLCAttachment,
                IsotropicpurityAttachment = data.IsotropicpurityAttachment,
                TwoDNMRAttachment = data.TwoDNMRAttachment
            };
            return Json(model, JsonRequestBehavior.AllowGet);
        }

        public ActionResult NewQuotationForm(SZ_QuoteDetailForm model)
        {
            db.SZ_QuoteDetailForm.Add(model);
            db.SaveChanges();
            return Json(model, JsonRequestBehavior.AllowGet);
        }

        public ActionResult UpdateQuotationForm(SZ_QuoteDetailForm model)
        {
            db.Entry(model).State = EntityState.Modified;
            db.SaveChanges();
            return Json(model, JsonRequestBehavior.AllowGet);
        }

        public ActionResult NewQuotationFormMap(SZ_QuoteDetails_Form model)
        {
            db.SZ_QuoteDetails_Form.Add(model);
            db.SaveChanges();
            return Json(model, JsonRequestBehavior.AllowGet);
        }

        public ActionResult ChangeClientApproved(int id, bool status)
        {
            try
            {
                var model = _operationRepository.GetQuoteDetailByID(id);
                if (model != null)
                {
                    model.ApprovedForClient = status;
                    db.Entry(model).State = EntityState.Modified;
                    db.SaveChanges();
                }
                return Json(true, JsonRequestBehavior.AllowGet);
            }
            catch (Exception)
            {
                return Json(false, JsonRequestBehavior.AllowGet);
            }
        }
        public ActionResult GetQuoteDataForConversionReport(int companyId, string Startdate, string Enddate)
        {
            DateTime sd = DateTime.Now;
            DateTime ed = DateTime.Now;
            if (!string.IsNullOrEmpty(Startdate))
            {
                TimeSpan ts = new TimeSpan(00, 00, 00);
                sd = Convert.ToDateTime(Startdate);
                sd = sd.Add(ts);
                //modelAvailable = modelAvailable.Where(x => x.CreatedDate >= sd).ToList();
            }
            if (!string.IsNullOrEmpty(Enddate))
            {
                TimeSpan ts = new TimeSpan(23, 59, 59);
                ed = Convert.ToDateTime(Enddate);
                ed = ed.Add(ts);
                //modelAvailable = modelAvailable.Where(x => x.CreatedDate <= ed).ToList();
            }

            var data = (from pc in db.SZ_Quotation
                        join c in db.SZ_QuotationDetail on pc.Id equals c.QuoteId
                        where pc.CreatedDate >= sd && pc.CreatedDate <= ed
                        && pc.CompanyId == companyId
                        select new
                        {
                            quoteRef = pc.Ref,
                            PO = c.MoveToProject == true ? pc.PONo : "",
                            leadtime = c.LeadTime,
                            productname = c.ProductName,
                            casno = c.CASNo,
                            catno = c.CATNo,
                            price = c.Price
                        }).AsQueryable();

            return Json(data, JsonRequestBehavior.AllowGet);
        }


        public ActionResult SearchConversationReport(string Startdate, string Enddate, bool isallcompany = false)
        {
            DateTime sd = DateTime.Now;
            DateTime ed = DateTime.Now;
            if (!string.IsNullOrEmpty(Startdate))
            {
                TimeSpan ts = new TimeSpan(00, 00, 00);
                sd = Convert.ToDateTime(Startdate);
                sd = sd.Add(ts);
                //modelAvailable = modelAvailable.Where(x => x.CreatedDate >= sd).ToList();
            }
            if (!string.IsNullOrEmpty(Enddate))
            {
                TimeSpan ts = new TimeSpan(23, 59, 59);
                ed = Convert.ToDateTime(Enddate);
                ed = ed.Add(ts);
                //modelAvailable = modelAvailable.Where(x => x.CreatedDate <= ed).ToList();
            }
            var results = new List<ConversationReportModel>();
            var poresults = new List<ConversationReportModel>();
            var dbb = new SynzealLiveEntities();
            using (var connection = dbb.Database.Connection)
            {
                connection.Open();
                var command = connection.CreateCommand();
                command.CommandText = "EXEC [dbo].[ConversionReport] @StartDate, @EndDate, @AllCompany";
                SqlParameter sdparam = new SqlParameter("@StartDate", sd);
                SqlParameter edparam = new SqlParameter("@EndDate", ed);
                SqlParameter allcompparam = new SqlParameter("@AllCompany", isallcompany);

                command.Parameters.Add(sdparam);
                command.Parameters.Add(edparam);
                command.Parameters.Add(allcompparam);

                //command.Parameters.AddWithValue("@StartDate", sd);
                //command.Parameters.AddWithValue("@EndDate", ed);

                using (var reader = command.ExecuteReader())
                {
                    results = ((System.Data.Entity.Infrastructure.IObjectContextAdapter)dbb)
                            .ObjectContext
                            .Translate<ConversationReportModel>(reader)
                            .ToList();
                    reader.NextResult();

                    poresults = ((System.Data.Entity.Infrastructure.IObjectContextAdapter)dbb)
                            .ObjectContext
                            .Translate<ConversationReportModel>(reader)
                            .ToList();
                }
            }
            var companyList = new List<string>();
            companyList.AddRange((from p in results
                                  select p.companyname).Distinct().ToList());
            companyList.AddRange((from p in poresults
                                  select p.companyname).Distinct().ToList());

            companyList = companyList.Distinct().ToList();
            var compList = db.SZ_CompanyList.ToList();

            var model = new List<ConversionModel>();
            if (companyList != null)
            {
                companyList.ForEach(citem =>
                {
                    var objModel = new ConversionModel();
                    objModel.CompanyName = citem;
                    objModel.CompanyId = compList.Where(x => x.Name == citem).Select(x => x.Id).FirstOrDefault();
                    objModel.QuotedProduct = results.Where(x => x.companyname == citem).Select(x => x.CountData).FirstOrDefault();
                    objModel.POProduct = poresults.Where(x => x.companyname == citem).Select(x => x.CountData).FirstOrDefault();
                    if (objModel.QuotedProduct > 0)
                    {
                        objModel.Conversion = objModel.POProduct == 0 ? 0 : ((Convert.ToDecimal(objModel.POProduct) / Convert.ToDecimal(objModel.QuotedProduct)) * 100);
                    }
                    else
                    {
                        objModel.Conversion = 0;
                    }
                    model.Add(objModel);
                });
            }

            return Json(model.OrderByDescending(x => x.Conversion).ToList(), JsonRequestBehavior.AllowGet);
        }

        public ActionResult PrintCompanyPOReportExcel(string Startdate, string Enddate)
        {
            ExcelPackage ExcelPkg = new ExcelPackage();
            string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);

            var model = db.SZ_CompanyList.ToList();
            db.Database.ExecuteSqlCommand("SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED");
            DateTime sd = new DateTime();
            DateTime ed = new DateTime();
            if (!string.IsNullOrEmpty(Startdate))
            {
                TimeSpan ts = new TimeSpan(00, 00, 00);
                sd = Convert.ToDateTime(Startdate);
                sd = sd.Add(ts);
                //modelAvailable = modelAvailable.Where(x => x.CreatedDate >= sd).ToList();
            }
            if (!string.IsNullOrEmpty(Enddate))
            {
                TimeSpan ts = new TimeSpan(23, 59, 59);
                ed = Convert.ToDateTime(Enddate);
                ed = ed.Add(ts);
                //modelAvailable = modelAvailable.Where(x => x.CreatedDate <= ed).ToList();
            }

            var modelAvailable = (from i in db.SZ_Quotation
                                  join qd in db.SZ_QuotationDetail on i.Id equals qd.QuoteId
                                  where !string.IsNullOrEmpty(i.ApprovedBy) && i.PODate >= sd && i.PODate <= ed && qd.MoveToProject == true
                                  && !string.IsNullOrEmpty(i.PONo)
                                  select new
                                  {
                                      Quote = i,
                                      QuoteDetail = qd
                                  }).Distinct().ToList();

            var quotedata = (from i in db.SZ_Quotation
                             where !string.IsNullOrEmpty(i.ApprovedBy) && i.PODate >= sd && i.PODate <= ed && !string.IsNullOrEmpty(i.PONo)
                             select i).ToList();
            var quoteidlist = quotedata.Select(x => x.Id).ToList();
            var quotedetaildata = db.SZ_QuotationDetail.Where(x => quoteidlist.Contains(x.QuoteId) && x.MoveToProject == true).ToList();


            var actualquotedata = (from i in db.SZ_Quotation
                                   where !string.IsNullOrEmpty(i.ApprovedBy) && i.CreatedDate >= sd && i.CreatedDate <= ed
                                   select i).ToList();

            string madeby = string.Empty;
            ExcelWorksheet wsSheet1 = ExcelPkg.Workbook.Worksheets.Add("Company PO Report");
            wsSheet1.DefaultColWidth = 16;
            wsSheet1.Protection.IsProtected = false;
            wsSheet1.Protection.AllowSelectLockedCells = false;
            wsSheet1.Cells.AutoFitColumns(14, 40);
            wsSheet1.Column(3).Width = 40;
            wsSheet1.Column(3).Style.WrapText = true;

            using (ExcelRange Rng = wsSheet1.Cells[1, 1, 1, 12])
            {
                Rng.Style.Font.Bold = true;
                Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#7b7b7b");
                Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                Rng.Style.Font.Color.SetColor(Color.White);
                Rng.Style.WrapText = true;
                Rng.Value = "Company PO Report"; Rng.Merge = true;
            }


            int loopCount = 3;
            wsSheet1.Cells[loopCount, 1].Value = "Sr No";
            wsSheet1.Cells[loopCount, 2].Value = "Company Name";

            wsSheet1.Cells[loopCount, 3].Value = "All Quoted Product Value";
            wsSheet1.Cells[loopCount, 4].Value = "Total No of Quote Product";

            wsSheet1.Cells[loopCount, 5].Value = "Total No of PO";
            wsSheet1.Cells[loopCount, 6].Value = "Total Quote Amount (Available in Project)";
            wsSheet1.Cells[loopCount, 7].Value = "Total PO Amount";
            //wsSheet1.Cells[loopCount, 8].Value = "Active PO";
            wsSheet1.Cells[loopCount, 8].Value = "No of Products";
            wsSheet1.Cells[loopCount, 9].Value = "In-Stock Products";
            wsSheet1.Cells[loopCount, 10].Value = "Under-Synthesis Products";
            wsSheet1.Cells[loopCount, 11].Value = "Out Of Stock Products";
            wsSheet1.Cells[loopCount, 12].Value = "Country Type";
            int columnCount = 12;

            using (ExcelRange Rng = wsSheet1.Cells[loopCount, 1, loopCount, columnCount])
            {
                Rng.Style.Font.Bold = true;
                Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#7b7b7b");
                Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                Rng.Style.Font.Color.SetColor(Color.White);
                Rng.Style.WrapText = true;
            }

            loopCount = loopCount + 1;
            int srno = 1;

            var companyList = (from i in modelAvailable
                               select new
                               {
                                   CompanyId = i.Quote.CompanyId,
                                   CompanyName = i.Quote.CompanyName,
                                   CountryType = i.Quote.CountryType
                               }).Distinct().OrderBy(x => x.CompanyName).ToList();
            int totalPOValue = 0;
            if (companyList != null && companyList.Count > 0)
            {
                companyList.ForEach(compDetails =>
                {
                    var quoteFilterData = quotedata.Where(x => x.CompanyId == compDetails.CompanyId).ToList();

                    var actualquoteFilterData = actualquotedata.Where(x => x.CompanyId == compDetails.CompanyId).ToList();

                    int noofpoproduct = (from i in quoteFilterData
                                         join qd in quotedetaildata on i.Id equals qd.QuoteId
                                         where qd.MoveToProject == true
                                         select qd).Count();

                    int instockpoproducts = (from i in quoteFilterData
                                             join qd in quotedetaildata on i.Id equals qd.QuoteId
                                             where qd.MoveToProject == true
                                                   && (!string.IsNullOrEmpty(qd.LeadTime) && (qd.LeadTime.ToLower().Contains("in stock")
                                                       || qd.LeadTime.ToLower().Contains("in-stock") || qd.LeadTime.ToLower().Contains("instock")))
                                             select qd).Count();

                    int outofstock = (from i in quoteFilterData
                                      join qd in quotedetaildata on i.Id equals qd.QuoteId
                                      where qd.MoveToProject == true
                                            && (!string.IsNullOrEmpty(qd.LeadTime) && (qd.LeadTime.ToLower().Contains("out of stock")
                                                || qd.LeadTime.ToLower().Contains("out")))
                                      select qd).Count();

                    wsSheet1.Cells[loopCount, 1].Value = srno;
                    wsSheet1.Cells[loopCount, 2].Value = compDetails.CompanyName;
                    wsSheet1.Cells[loopCount, 3].Value = GetQuoteProductValue(actualquoteFilterData);
                    wsSheet1.Cells[loopCount, 4].Value = actualquoteFilterData.Sum(x => x.SZ_QuotationDetail.Count);
                    wsSheet1.Cells[loopCount, 5].Value = quoteFilterData.Where(x => !string.IsNullOrEmpty(x.PONo)).Select(x => x.PONo).Distinct().Count();
                    wsSheet1.Cells[loopCount, 6].Value = GetProductValue(quoteFilterData.Where(x => !string.IsNullOrEmpty(x.PONo)).ToList(), true);
                    wsSheet1.Cells[loopCount, 7].Value = GetPOProductValue(quoteFilterData.Where(x => !string.IsNullOrEmpty(x.PONo)).ToList());

                    //wsSheet1.Cells[loopCount, 8].Value = (from i in quoteFilterData
                    //                                      join qd in quotedetaildata on i.Id equals qd.QuoteId
                    //                                      where qd.MoveToProject == true && (qd.MoveToDispatch == null || qd.MoveToDispatch == false)
                    //                                      select i.PONo).Distinct().Count();

                    int synthesiscnt = noofpoproduct - outofstock - instockpoproducts;
                    wsSheet1.Cells[loopCount, 8].Value = noofpoproduct;
                    wsSheet1.Cells[loopCount, 9].Value = instockpoproducts;
                    wsSheet1.Cells[loopCount, 10].Value = synthesiscnt < 0 ? 0 : synthesiscnt;
                    wsSheet1.Cells[loopCount, 11].Value = outofstock;
                    wsSheet1.Cells[loopCount, 12].Value = compDetails.CountryType;
                    totalPOValue += Convert.ToInt32(wsSheet1.Cells[loopCount, 7].Value);
                    loopCount += 1;
                    srno += 1;
                });
            }
            wsSheet1.Cells[loopCount, 4].Value = totalPOValue;
            string filePath = HostingEnvironment.MapPath("~/Content/Quotation/") + "NewCompanyReport-" + DateTime.Now.ToShortDateString().Replace("/", "_") + "-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xlsx";
            ExcelPkg.SaveAs(new FileInfo(filePath));
            return File(filePath, "application/excel", Server.UrlEncode("CompanyPOReport_" + sd.ToShortDateString().Replace("#", "_") + "_TO_" + ed.ToShortDateString().Replace("#", "_") + ".xls"));
        }
        public ActionResult minAmountProductReport()
        {
            ExcelPackage ExcelPkg = new ExcelPackage();

            string madeby = string.Empty;
            ExcelWorksheet wsSheet1 = ExcelPkg.Workbook.Worksheets.Add("Product Record");
            wsSheet1.DefaultColWidth = 16;
            wsSheet1.Protection.IsProtected = false;
            wsSheet1.Protection.AllowSelectLockedCells = false;
            wsSheet1.Cells.AutoFitColumns(14, 40);
            wsSheet1.Column(3).Width = 40;
            wsSheet1.Column(3).Style.WrapText = true;

            int loopCount = 1;
            wsSheet1.Cells[loopCount, 1].Value = "Sr No";
            wsSheet1.Cells[loopCount, 2].Value = "CAT No";
            wsSheet1.Cells[loopCount, 3].Value = "CAS No";
            wsSheet1.Cells[loopCount, 4].Value = "Product Name";
            wsSheet1.Cells[loopCount, 5].Value = "25 (Domestic)";
            wsSheet1.Cells[loopCount, 6].Value = "50 (Domestic)";
            wsSheet1.Cells[loopCount, 7].Value = "100 (Domestic)";
            wsSheet1.Cells[loopCount, 8].Value = "25 (Export)";
            wsSheet1.Cells[loopCount, 9].Value = "50 (Export)";
            wsSheet1.Cells[loopCount, 10].Value = "100 (Export)";
            int columnCount = 10;

            using (ExcelRange Rng = wsSheet1.Cells[loopCount, 1, loopCount, columnCount])
            {
                Rng.Style.Font.Bold = true;
                Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#7b7b7b");
                Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                Rng.Style.Font.Color.SetColor(Color.White);
                Rng.Style.WrapText = true;
            }
            MemoryCacheManager objCache = new MemoryCacheManager();
            var newmodelAvailable = objCache.Get("cache.productsdata", () =>
            {
                return db.Products.Where(x => x.Published == true && x.Deleted == false).ToList();
            });
            var urlrecorddata = db.UrlRecords.ToList();
            var quotedetaildata = db.SZ_QuotationDetail.ToList();
            loopCount = loopCount + 1;
            int srno = 1;
            foreach (var data in newmodelAvailable)
            {
                var qdDomesticdata = quotedetaildata.Where(x => x.SZ_Quotation != null && x.SZ_Quotation.CountryType == "Domestic" && x.ProductId == data.Id).ToList();
                var qdExportdata = quotedetaildata.Where(x => x.SZ_Quotation != null && x.SZ_Quotation.CountryType == "Export" && x.ProductId == data.Id).ToList();

                wsSheet1.Cells[loopCount, 1].Value = srno;
                var urlrecord = urlrecorddata.Where(x => x.EntityName == "Product" && x.EntityId == data.Id && x.IsActive == true).OrderByDescending(x => x.Id).FirstOrDefault();
                if (urlrecord != null)
                {
                    ExcelRange Rngurl = wsSheet1.Cells[loopCount, 2];
                    Rngurl.Formula = "=HYPERLINK(\"" + urlrecord.Slug + "\", \"" + data.Sku + "\")";
                }
                else
                {
                    wsSheet1.Cells[loopCount, 2].Value = data.Sku;
                }

                wsSheet1.Cells[loopCount, 3].Value = data.ManufacturerPartNumber;
                wsSheet1.Cells[loopCount, 4].Value = data.Name;
                wsSheet1.Cells[loopCount, 5].Value = LowestPriceValue(25, qdDomesticdata);
                wsSheet1.Cells[loopCount, 6].Value = LowestPriceValue(50, qdDomesticdata);
                wsSheet1.Cells[loopCount, 7].Value = LowestPriceValue(100, qdDomesticdata);
                wsSheet1.Cells[loopCount, 8].Value = LowestPriceValue(25, qdExportdata);
                wsSheet1.Cells[loopCount, 9].Value = LowestPriceValue(50, qdExportdata);
                wsSheet1.Cells[loopCount, 10].Value = LowestPriceValue(100, qdExportdata);
                loopCount += 1;
                srno += 1;
            }

            string filePath = HostingEnvironment.MapPath("~/Content/Quotation/") + "ProductReport-" + DateTime.Now.ToShortDateString().Replace("/", "_") + "-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xlsx";
            ExcelPkg.SaveAs(new FileInfo(filePath));
            return File(filePath, "application/excel", Server.UrlEncode("ProductReport_" + DateTime.Now.ToShortDateString().Replace("#", "_") + ".xls"));
        }

        public ActionResult PrintNewCompanyReportExcel(string Startdate, string Enddate)
        {
            ExcelPackage ExcelPkg = new ExcelPackage();
            string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);

            var model = db.SZ_CompanyList.ToList();
            db.Database.ExecuteSqlCommand("SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED");
            DateTime sd = new DateTime();
            DateTime ed = new DateTime();
            if (!string.IsNullOrEmpty(Startdate))
            {
                TimeSpan ts = new TimeSpan(00, 00, 00);
                sd = Convert.ToDateTime(Startdate);
                sd = sd.Add(ts);
            }
            if (!string.IsNullOrEmpty(Enddate))
            {
                TimeSpan ts = new TimeSpan(23, 59, 59);
                ed = Convert.ToDateTime(Enddate);
                ed = ed.Add(ts);
            }

            var companyids = (from pc in db.SZ_Quotation
                              where !string.IsNullOrEmpty(pc.ApprovedBy) && pc.CreatedDate >= sd && pc.CreatedDate <= ed
                              select pc.CompanyId).Distinct().ToList();

            var availablecompanyid = (from pc in db.SZ_Quotation
                                      where pc.CreatedDate <= sd
                                      && companyids.Contains(pc.CompanyId)
                                      select pc.CompanyId).Distinct().ToList();

            var result = companyids.Where(p => availablecompanyid.All(p2 => p2 != p));

            var modelAvailable = (from pc in db.SZ_Quotation
                                  where result.Contains(pc.CompanyId)
                                  select new
                                  {
                                      CompanyName = pc.CompanyName,
                                      EmailAddress = pc.EmailAddress
                                  }).Distinct().ToList();

            string madeby = string.Empty;
            ExcelWorksheet wsSheet1 = ExcelPkg.Workbook.Worksheets.Add("Company Record");
            wsSheet1.DefaultColWidth = 16;
            wsSheet1.Protection.IsProtected = false;
            wsSheet1.Protection.AllowSelectLockedCells = false;
            wsSheet1.Cells.AutoFitColumns(14, 40);
            wsSheet1.Column(3).Width = 40;
            wsSheet1.Column(3).Style.WrapText = true;

            int loopCount = 1;
            wsSheet1.Cells[loopCount, 1].Value = "Sr No";
            wsSheet1.Cells[loopCount, 2].Value = "Company Name";
            wsSheet1.Cells[loopCount, 3].Value = "Email Address";

            int columnCount = 3;

            using (ExcelRange Rng = wsSheet1.Cells[loopCount, 1, loopCount, columnCount])
            {
                Rng.Style.Font.Bold = true;
                Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#7b7b7b");
                Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                Rng.Style.Font.Color.SetColor(Color.White);
                Rng.Style.WrapText = true;
            }

            var newmodelAvailable = (from i in modelAvailable
                                     select new
                                     {
                                         CompanyName = i.CompanyName,
                                         EmailAddress = i.EmailAddress
                                     }).Distinct().ToList();
            loopCount = loopCount + 1;
            int srno = 1;
            foreach (var data in newmodelAvailable)
            {
                wsSheet1.Cells[loopCount, 1].Value = srno;
                wsSheet1.Cells[loopCount, 2].Value = data.CompanyName;
                wsSheet1.Cells[loopCount, 3].Value = data.EmailAddress;

                loopCount += 1;
                srno += 1;
            }
            string filePath = HostingEnvironment.MapPath("~/Content/Quotation/") + "NewCompanyReport-" + DateTime.Now.ToShortDateString().Replace("/", "_") + "-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xlsx";
            ExcelPkg.SaveAs(new FileInfo(filePath));
            return File(filePath, "application/excel", Server.UrlEncode("NewCompanyReport_" + DateTime.Now.ToShortDateString().Replace("#", "_") + ".xls"));
        }


        public ActionResult PrintPOReportExcel(int? CreatedBy, string Startdate, string Enddate)
        {
            //var categoryData = db.Categories.ToList();
            //var productCategoryData = db.Product_Category_Mapping.ToList();
            MemoryCacheManager objCache = new MemoryCacheManager();

            var productsData = objCache.Get("cache.productsdata", () =>
            {
                return db.Products.Where(x => x.Published == true && x.Deleted == false).ToList();
            });
            ExcelPackage ExcelPkg = new ExcelPackage();
            List<string> typeList = new List<string>();
            typeList.Add("Project");
            typeList.Add("Invoice");
            string inhouseProjectType = Convert.ToString((int)EnumList.ProjectType.InHouse);

            foreach (var type in typeList)
            {
                var model = new List<SZ_QuotationDetail>();
                if (type == "Project")
                {
                    model = (from i in db.SZ_Quotation
                             join qd in db.SZ_QuotationDetail on i.Id equals qd.QuoteId
                             where qd.MoveToProject == true
                            && string.IsNullOrEmpty(qd.TrackingNo)
                            && (qd.IsOnHold == false || qd.IsOnHold == null)
                            && (qd.ProjectType != inhouseProjectType || qd.ProjectType == null)
                             && !string.IsNullOrEmpty(i.ApprovedBy)
                             orderby qd.MoveProjectDate descending
                             select qd).OrderByDescending(x => x.MoveProjectDate).ToList();
                }
                else
                {
                    model = (from i in db.SZ_Quotation
                             join qd in db.SZ_QuotationDetail on i.Id equals qd.QuoteId
                             where qd.MoveToInvoice == true && !string.IsNullOrEmpty(i.ApprovedBy)
                             select qd).OrderByDescending(x => x.MoveToInvoiceDate).ToList();
                }

                if (CreatedBy.HasValue)
                {
                    model = model.Where(x => x.SZ_Quotation.CompanyId == CreatedBy).ToList();
                }

                if (type == "Project")
                {
                    if (!string.IsNullOrEmpty(Startdate))
                    {
                        TimeSpan ts = new TimeSpan(00, 00, 00);
                        DateTime sd = Convert.ToDateTime(Startdate);
                        sd = sd.Add(ts);
                        model = model.Where(x => x.SZ_Quotation.PODate >= sd).ToList();
                    }
                    if (!string.IsNullOrEmpty(Enddate))
                    {
                        TimeSpan ts = new TimeSpan(23, 59, 59);
                        DateTime ed = Convert.ToDateTime(Enddate);
                        ed = ed.Add(ts);
                        model = model.Where(x => x.SZ_Quotation.PODate <= ed).ToList();
                    }
                }
                else
                {
                    if (!string.IsNullOrEmpty(Startdate))
                    {
                        TimeSpan ts = new TimeSpan(00, 00, 00);
                        DateTime sd = Convert.ToDateTime(Startdate);
                        sd = sd.Add(ts);
                        model = model.Where(x => x.MoveToInvoiceDate >= sd).ToList();
                    }
                    if (!string.IsNullOrEmpty(Enddate))
                    {
                        TimeSpan ts = new TimeSpan(23, 59, 59);
                        DateTime ed = Convert.ToDateTime(Enddate);
                        ed = ed.Add(ts);
                        model = model.Where(x => x.MoveToInvoiceDate <= ed).ToList();
                    }
                }

                string madeby = string.Empty;
                var result = (from i in model
                              select i).Distinct().ToList();

                ExcelWorksheet wsSheet1 = ExcelPkg.Workbook.Worksheets.Add(type);
                wsSheet1.DefaultColWidth = 16;
                wsSheet1.Protection.IsProtected = false;
                wsSheet1.Protection.AllowSelectLockedCells = false;
                wsSheet1.Cells.AutoFitColumns(14, 40);
                wsSheet1.Column(3).Width = 40;
                wsSheet1.Column(3).Style.WrapText = true;

                int loopCount = 1;
                wsSheet1.Cells[loopCount, 1].Value = "Sr No";
                wsSheet1.Cells[loopCount, 2].Value = "Product Name";
                wsSheet1.Cells[loopCount, 3].Value = "CAS No";
                wsSheet1.Cells[loopCount, 4].Value = "Cat No";
                wsSheet1.Cells[loopCount, 5].Value = "Client Name";
                wsSheet1.Cells[loopCount, 6].Value = "PO Dt";
                wsSheet1.Cells[loopCount, 7].Value = "PO No";
                wsSheet1.Cells[loopCount, 8].Value = "Lead Time";
                wsSheet1.Cells[loopCount, 9].Value = "Value";
                wsSheet1.Cells[loopCount, 10].Value = "Quantity";
                wsSheet1.Cells[loopCount, 11].Value = "Dispatch Date";
                wsSheet1.Cells[loopCount, 12].Value = "Domestic/Export";

                int columnCount = 12;
                if (SessionCookieManagement.UserEmail == "shailesh@synzeal.com" || SessionCookieManagement.UserEmail == "parthsuthar2010@gmail.com")
                {
                    wsSheet1.Cells[loopCount, 13].Value = "Batch No";
                    wsSheet1.Cells[loopCount, 14].Value = "COA No";
                    wsSheet1.Cells[loopCount, 15].Value = "Tracking No";
                    wsSheet1.Cells[loopCount, 16].Value = "API Name";
                    columnCount = 16;
                }

                using (ExcelRange Rng = wsSheet1.Cells[loopCount, 1, loopCount, columnCount])
                {
                    Rng.Style.Font.Bold = true;
                    Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                    Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#7b7b7b");
                    Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                    Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    Rng.Style.Font.Color.SetColor(Color.White);
                    Rng.Style.WrapText = true;
                }


                loopCount = loopCount + 1;
                int srno = 1;
                List<int> quoteids = result.Select(x => x.QuoteId).Distinct().ToList();
                foreach (var data in result)
                {
                    wsSheet1.Cells[loopCount, 1].Value = srno;
                    wsSheet1.Cells[loopCount, 2].Value = data.ProductName;
                    wsSheet1.Cells[loopCount, 3].Value = data.CASNo;
                    wsSheet1.Cells[loopCount, 4].Value = data.CATNo;
                    wsSheet1.Cells[loopCount, 5].Value = data.SZ_Quotation.CompanyName;
                    wsSheet1.Cells[loopCount, 6].Value = data.SZ_Quotation.PODate.HasValue ? data.SZ_Quotation.PODate.Value.ToShortDateString() : "";
                    wsSheet1.Cells[loopCount, 7].Value = data.SZ_Quotation.PONo;
                    wsSheet1.Cells[loopCount, 8].Value = data.LeadTime;

                    wsSheet1.Cells[loopCount, 9].Value = GetPOProductValue(data, true);
                    wsSheet1.Cells[loopCount, 10].Value = data.RequiredQty;

                    wsSheet1.Cells[loopCount, 11].Value = data.MoveDispatchDate.HasValue ? data.MoveDispatchDate.Value.ToShortDateString() : "";
                    wsSheet1.Cells[loopCount, 12].Value = data.SZ_Quotation.CountryType;
                    if (SessionCookieManagement.UserEmail == "shailesh@synzeal.com" || SessionCookieManagement.UserEmail == "parthsuthar2010@gmail.com")
                    {
                        wsSheet1.Cells[loopCount, 13].Value = db.SZ_Inventory.Where(x => x.Id == data.AdditionalBatchNo).Select(x => x.BatchNo).FirstOrDefault();
                        wsSheet1.Cells[loopCount, 14].Value = data.COARefNumber;
                        wsSheet1.Cells[loopCount, 15].Value = data.TrackingNo;
                        wsSheet1.Cells[loopCount, 16].Value = GetApiNameOfProduct(data.ProductId.Value, productsData);
                    }

                    loopCount += 1;
                    srno += 1;
                }
            }

            string filePath = HostingEnvironment.MapPath("~/Content/Quotation/") + "POReport-" + DateTime.Now.ToShortDateString().Replace("/", "_") + "-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xlsx";
            ExcelPkg.SaveAs(new FileInfo(filePath));
            return File(filePath, "application/excel", Server.UrlEncode("POReport_" + DateTime.Now.ToShortDateString().Replace("#", "_") + ".xls"));
        }

        public ActionResult GEO()
        {
            string path = Server.MapPath("~/img/GEO.xlsx");

            var file = new FileInfo(path);
            var geolocationList = db.SZ_Geographical.ToList();
            using (var package = new ExcelPackage(file))
            {
                var currentSheet = package.Workbook.Worksheets;
                var workSheet = currentSheet.First();
                var noOfCol = workSheet.Dimension.End.Column;
                var noOfRow = workSheet.Dimension.End.Row;
                for (int rowIterator = 2; rowIterator <= noOfRow; rowIterator++)
                {
                    string name = workSheet.Cells[rowIterator, 1].Value != null ? workSheet.Cells[rowIterator, 1].Value.ToString() : string.Empty;
                    string sapcode = workSheet.Cells[rowIterator, 2].Value != null ? workSheet.Cells[rowIterator, 2].Value.ToString() : string.Empty;
                    string geo = workSheet.Cells[rowIterator, 3].Value != null ? workSheet.Cells[rowIterator, 3].Value.ToString() : string.Empty;
                    if (!string.IsNullOrEmpty(sapcode))
                    {
                        sapcode = sapcode.Trim();
                    }
                    else
                    {
                        continue;
                    }
                    if (!string.IsNullOrEmpty(geo))
                    {
                        geo = geo.Trim().ToLower();
                    }
                    else
                    {
                        continue;
                    }
                    var compData = db.SZ_CompanyList.Where(x => x.SAPCode.ToLower().Contains(sapcode.ToLower())).FirstOrDefault();
                    if (compData != null)
                    {
                        compData.GeographicalLocation = geolocationList.Where(x => x.Name.Trim().ToLower() == geo).Select(x => x.Id).FirstOrDefault();
                        db.Entry(compData).State = EntityState.Modified;
                    }
                }
                db.SaveChanges();
            }

            return Content("Done");
        }

        public ActionResult SEO()
        {
            string path = Server.MapPath("~/img/seo.xlsx");

            var file = new FileInfo(path);

            using (var package = new ExcelPackage(file))
            {
                var currentSheet = package.Workbook.Worksheets;
                var workSheet = currentSheet.First();
                var noOfCol = workSheet.Dimension.End.Column;
                var noOfRow = workSheet.Dimension.End.Row;
                for (int rowIterator = 2; rowIterator <= noOfRow; rowIterator++)
                {
                    string CATNo = workSheet.Cells[rowIterator, 1].Value != null ? workSheet.Cells[rowIterator, 1].Value.ToString() : string.Empty;
                    string keyword = workSheet.Cells[rowIterator, 2].Value != null ? workSheet.Cells[rowIterator, 2].Value.ToString() : string.Empty;
                    string title = workSheet.Cells[rowIterator, 3].Value != null ? workSheet.Cells[rowIterator, 3].Value.ToString() : string.Empty;
                    string description = workSheet.Cells[rowIterator, 4].Value != null ? workSheet.Cells[rowIterator, 4].Value.ToString() : "";
                    if (!string.IsNullOrEmpty(CATNo))
                    {
                        CATNo = CATNo.Trim();
                    }
                    else
                    {
                        continue;
                    }

                    var productData = db.Products.Where(x => x.Deleted == false && x.Published == true && x.Sku.ToLower().Contains(CATNo.ToLower())).FirstOrDefault();
                    if (productData != null)
                    {
                        productData.MetaTitle = title;
                        productData.MetaDescription = description;
                        productData.MetaKeywords = keyword;
                        db.Entry(productData).State = EntityState.Modified;
                    }
                }
                db.SaveChanges();
            }

            return Content("Done");
        }
        public ActionResult ImportEstDate()
        {
            string path = Server.MapPath("~/img/estdate.xlsx");

            var file = new FileInfo(path);

            using (var package = new ExcelPackage(file))
            {
                var currentSheet = package.Workbook.Worksheets;
                var workSheet = currentSheet.First();
                var noOfCol = workSheet.Dimension.End.Column;
                var noOfRow = workSheet.Dimension.End.Row;
                for (int rowIterator = 2; rowIterator <= noOfRow; rowIterator++)
                {
                    string number = workSheet.Cells[rowIterator, 1].Value != null ? workSheet.Cells[rowIterator, 1].Value.ToString() : string.Empty;
                    string ponumber = workSheet.Cells[rowIterator, 2].Value != null ? workSheet.Cells[rowIterator, 2].Value.ToString() : string.Empty;
                    string CATNo = workSheet.Cells[rowIterator, 3].Value != null ? workSheet.Cells[rowIterator, 3].Value.ToString() : string.Empty;
                    string estdate = workSheet.Cells[rowIterator, 4].Value != null ? workSheet.Cells[rowIterator, 4].Value.ToString() : "";
                    if (!string.IsNullOrEmpty(CATNo))
                    {
                        CATNo = CATNo.Trim();
                    }
                    else
                    {
                        continue;
                    }

                    if (!string.IsNullOrEmpty(ponumber))
                    {
                        ponumber = ponumber.Trim();
                    }
                    if (string.IsNullOrEmpty(estdate))
                    {
                        continue;
                    }
                    var details = (from i in db.SZ_Quotation.AsNoTracking()
                                   join t2 in db.SZ_QuotationDetail.AsNoTracking() on i.Id equals t2.QuoteId
                                   where i.PONo == ponumber && t2.CATNo == CATNo
                                   orderby t2.MoveToScientistDate descending
                                   select t2).FirstOrDefault();

                    if (details != null)
                    {
                        SZ_QuotationDetailLog objhis = new SZ_QuotationDetailLog();
                        objhis.QuoteId = details.QuoteId;
                        objhis.QuoteDetailsId = details.Id;
                        objhis.QuoteRef = details.SZ_Quotation.Ref;
                        objhis.Username = "Parth Suthar : System Generated";
                        objhis.Datetime = Convert.ToDateTime("01/01/2018");
                        objhis.PropertyName = "EstimateDispatchDate";
                        objhis.FieldName = "EstimateDispatchDate"; // need to change
                        objhis.Before = Convert.ToString(estdate);
                        objhis.After = Convert.ToString("");
                        objhis.UserId = SessionCookieManagement.UserId;
                        db.SZ_QuotationDetailLog.Add(objhis);
                    }
                }
                db.SaveChanges();
            }

            return Content("Done");
        }

        public ActionResult GenerateAnualReport()
        {
            var listItems = new List<SelectListItem>();
            var scienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("quote")).ToList();
            foreach (var term in scienList)
            {
                string customerName = string.Empty;
                var genericAttr = db.GenericAttributes.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                listItems.Add(new SelectListItem
                {
                    Text = customerName.ToLower().Trim(),
                    Value = term.Id.ToString()
                });
            }
            var allQuoteData = (from i in db.SZ_Quotation
                                select i).Distinct().ToList();
            ExcelPackage ExcelPkg = new ExcelPackage();
            ExcelWorksheet wsSheet1 = ExcelPkg.Workbook.Worksheets.Add("Sheet");
            wsSheet1.DefaultColWidth = 16;
            wsSheet1.Protection.IsProtected = false;
            wsSheet1.Protection.AllowSelectLockedCells = false;
            wsSheet1.Cells.AutoFitColumns(14, 40);
            wsSheet1.Column(3).Width = 40;
            wsSheet1.Column(3).Style.WrapText = true;
            int loopCount = 1;
            foreach (var customer in listItems)
            {
                string madeby = string.Empty;
                var result = (from i in allQuoteData
                              where !string.IsNullOrEmpty(i.CreatedBy) && i.CreatedBy.ToLower().Trim() == customer.Text
                              select i).Distinct().ToList();


                wsSheet1.Cells[loopCount, 1].Value = "Employee Name";
                wsSheet1.Cells[loopCount, 2].Value = "";
                wsSheet1.Cells[loopCount, 3].Value = "Apr-20";
                wsSheet1.Cells[loopCount, 4].Value = "May-20";
                wsSheet1.Cells[loopCount, 5].Value = "Jun-20";
                wsSheet1.Cells[loopCount, 6].Value = "Jul-20";
                wsSheet1.Cells[loopCount, 7].Value = "Aug-20";
                wsSheet1.Cells[loopCount, 8].Value = "Sep-20";
                wsSheet1.Cells[loopCount, 9].Value = "Oct-20";
                wsSheet1.Cells[loopCount, 10].Value = "Nov-20";
                wsSheet1.Cells[loopCount, 11].Value = "Dec-20";
                wsSheet1.Cells[loopCount, 12].Value = "Jan-21";
                wsSheet1.Cells[loopCount, 13].Value = "Feb-21";
                wsSheet1.Cells[loopCount, 14].Value = "Mar-21";
                wsSheet1.Cells[loopCount, 15].Value = "Apr-21";
                wsSheet1.Cells[loopCount, 16].Value = "May-21";
                wsSheet1.Cells[loopCount, 17].Value = "Jun-21";
                wsSheet1.Cells[loopCount, 18].Value = "Jul-21";
                using (ExcelRange Rng = wsSheet1.Cells[loopCount, 1, loopCount, 18])
                {
                    Rng.Style.Font.Bold = true;
                    Rng.Style.Fill.PatternType = ExcelFillStyle.Solid;
                    Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#7b7b7b");
                    Rng.Style.Fill.BackgroundColor.SetColor(colFromHex);
                    Rng.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    Rng.Style.Font.Color.SetColor(Color.White);
                    Rng.Style.WrapText = true;
                }

                loopCount = loopCount + 1;
                int srno = 1;

                List<string> listoftypes = new List<string>();
                listoftypes.Add("Products Added");
                listoftypes.Add("Quotations Added");
                listoftypes.Add("Approved");
                listoftypes.Add("Masters Updated");
                foreach (var type in listoftypes)
                {
                    if (type == "Products Added")
                    {
                        wsSheet1.Cells[loopCount, 1].Value = customer.Text;
                        wsSheet1.Cells[loopCount, 2].Value = type;
                        wsSheet1.Cells[loopCount, 3].Value = GetProductCountOfQuote(new DateTime(2020, 4, 1), new DateTime(2020, 4, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 4].Value = GetProductCountOfQuote(new DateTime(2020, 5, 1), new DateTime(2020, 5, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 5].Value = GetProductCountOfQuote(new DateTime(2020, 6, 1), new DateTime(2020, 6, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 6].Value = GetProductCountOfQuote(new DateTime(2020, 7, 1), new DateTime(2020, 7, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 7].Value = GetProductCountOfQuote(new DateTime(2020, 8, 1), new DateTime(2020, 8, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 8].Value = GetProductCountOfQuote(new DateTime(2020, 9, 1), new DateTime(2020, 9, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 9].Value = GetProductCountOfQuote(new DateTime(2020, 10, 1), new DateTime(2020, 10, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 10].Value = GetProductCountOfQuote(new DateTime(2020, 11, 1), new DateTime(2020, 11, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 11].Value = GetProductCountOfQuote(new DateTime(2020, 12, 1), new DateTime(2020, 12, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 12].Value = GetProductCountOfQuote(new DateTime(2021, 1, 1), new DateTime(2021, 1, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 13].Value = GetProductCountOfQuote(new DateTime(2021, 2, 1), new DateTime(2021, 2, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 14].Value = GetProductCountOfQuote(new DateTime(2021, 3, 1), new DateTime(2021, 3, 1).AddMonths(1).AddDays(-1), result);

                        wsSheet1.Cells[loopCount, 15].Value = GetProductCountOfQuote(new DateTime(2021, 4, 1), new DateTime(2021, 4, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 16].Value = GetProductCountOfQuote(new DateTime(2021, 5, 1), new DateTime(2021, 5, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 17].Value = GetProductCountOfQuote(new DateTime(2021, 6, 1), new DateTime(2021, 6, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 18].Value = GetProductCountOfQuote(new DateTime(2021, 7, 1), new DateTime(2021, 7, 1).AddMonths(1).AddDays(-1), result);

                    }
                    else if (type == "Quotations Added")
                    {
                        wsSheet1.Cells[loopCount, 1].Value = "";
                        wsSheet1.Cells[loopCount, 2].Value = type;
                        wsSheet1.Cells[loopCount, 3].Value = GetQuoteCountOfQuote(new DateTime(2020, 4, 1), new DateTime(2020, 4, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 4].Value = GetQuoteCountOfQuote(new DateTime(2020, 5, 1), new DateTime(2020, 5, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 5].Value = GetQuoteCountOfQuote(new DateTime(2020, 6, 1), new DateTime(2020, 6, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 6].Value = GetQuoteCountOfQuote(new DateTime(2020, 7, 1), new DateTime(2020, 7, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 7].Value = GetQuoteCountOfQuote(new DateTime(2020, 8, 1), new DateTime(2020, 8, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 8].Value = GetQuoteCountOfQuote(new DateTime(2020, 9, 1), new DateTime(2020, 9, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 9].Value = GetQuoteCountOfQuote(new DateTime(2020, 10, 1), new DateTime(2020, 10, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 10].Value = GetQuoteCountOfQuote(new DateTime(2020, 11, 1), new DateTime(2020, 11, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 11].Value = GetQuoteCountOfQuote(new DateTime(2020, 12, 1), new DateTime(2020, 12, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 12].Value = GetQuoteCountOfQuote(new DateTime(2021, 1, 1), new DateTime(2021, 1, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 13].Value = GetQuoteCountOfQuote(new DateTime(2021, 2, 1), new DateTime(2021, 2, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 14].Value = GetQuoteCountOfQuote(new DateTime(2021, 3, 1), new DateTime(2021, 3, 1).AddMonths(1).AddDays(-1), result);

                        wsSheet1.Cells[loopCount, 15].Value = GetQuoteCountOfQuote(new DateTime(2021, 4, 1), new DateTime(2021, 4, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 16].Value = GetQuoteCountOfQuote(new DateTime(2021, 5, 1), new DateTime(2021, 5, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 17].Value = GetQuoteCountOfQuote(new DateTime(2021, 6, 1), new DateTime(2021, 6, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 18].Value = GetQuoteCountOfQuote(new DateTime(2021, 7, 1), new DateTime(2021, 7, 1).AddMonths(1).AddDays(-1), result);

                    }
                    else if (type == "Approved")
                    {
                        wsSheet1.Cells[loopCount, 1].Value = "";
                        wsSheet1.Cells[loopCount, 2].Value = type;
                        wsSheet1.Cells[loopCount, 3].Value = GetApprovedCountOfQuote(new DateTime(2020, 4, 1), new DateTime(2020, 4, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 4].Value = GetApprovedCountOfQuote(new DateTime(2020, 5, 1), new DateTime(2020, 5, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 5].Value = GetApprovedCountOfQuote(new DateTime(2020, 6, 1), new DateTime(2020, 6, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 6].Value = GetApprovedCountOfQuote(new DateTime(2020, 7, 1), new DateTime(2020, 7, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 7].Value = GetApprovedCountOfQuote(new DateTime(2020, 8, 1), new DateTime(2020, 8, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 8].Value = GetApprovedCountOfQuote(new DateTime(2020, 9, 1), new DateTime(2020, 9, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 9].Value = GetApprovedCountOfQuote(new DateTime(2020, 10, 1), new DateTime(2020, 10, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 10].Value = GetApprovedCountOfQuote(new DateTime(2020, 11, 1), new DateTime(2020, 11, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 11].Value = GetApprovedCountOfQuote(new DateTime(2020, 12, 1), new DateTime(2020, 12, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 12].Value = GetApprovedCountOfQuote(new DateTime(2021, 1, 1), new DateTime(2021, 1, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 13].Value = GetApprovedCountOfQuote(new DateTime(2021, 2, 1), new DateTime(2021, 2, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 14].Value = GetApprovedCountOfQuote(new DateTime(2021, 3, 1), new DateTime(2021, 3, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 15].Value = GetApprovedCountOfQuote(new DateTime(2021, 4, 1), new DateTime(2021, 4, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 16].Value = GetApprovedCountOfQuote(new DateTime(2021, 5, 1), new DateTime(2021, 5, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 17].Value = GetApprovedCountOfQuote(new DateTime(2021, 6, 1), new DateTime(2021, 6, 1).AddMonths(1).AddDays(-1), result);
                        wsSheet1.Cells[loopCount, 18].Value = GetApprovedCountOfQuote(new DateTime(2021, 7, 1), new DateTime(2021, 7, 1).AddMonths(1).AddDays(-1), result);

                    }
                    else if (type == "Masters Updated")
                    {
                        wsSheet1.Cells[loopCount, 1].Value = "";
                        wsSheet1.Cells[loopCount, 2].Value = "";
                        wsSheet1.Cells[loopCount, 3].Value = "";
                        wsSheet1.Cells[loopCount, 4].Value = "";
                        wsSheet1.Cells[loopCount, 5].Value = "";
                        wsSheet1.Cells[loopCount, 6].Value = "";
                        wsSheet1.Cells[loopCount, 7].Value = "";
                        wsSheet1.Cells[loopCount, 8].Value = "";
                        wsSheet1.Cells[loopCount, 9].Value = "";
                        wsSheet1.Cells[loopCount, 10].Value = "";
                        wsSheet1.Cells[loopCount, 11].Value = "";
                        wsSheet1.Cells[loopCount, 12].Value = "";
                        wsSheet1.Cells[loopCount, 13].Value = "";
                        wsSheet1.Cells[loopCount, 14].Value = "";
                        wsSheet1.Cells[loopCount, 15].Value = "";
                        wsSheet1.Cells[loopCount, 16].Value = "";
                        wsSheet1.Cells[loopCount, 17].Value = "";
                        wsSheet1.Cells[loopCount, 18].Value = "";
                    }

                    loopCount += 1;
                    srno += 1;
                }
            }

            string filePath = HostingEnvironment.MapPath("~/Content/Quotation/") + "AnualReport-" + DateTime.Now.ToShortDateString().Replace("/", "_") + "-" + DateTime.Now.ToShortTimeString().Replace("#", "_").Replace(":", "_") + ".xlsx";
            ExcelPkg.SaveAs(new FileInfo(filePath));
            return File(filePath, "application/excel", Server.UrlEncode("AnualReport_" + DateTime.Now.ToShortDateString().Replace("#", "_") + ".xls"));
        }


        public ActionResult GetProductByCATNo(string catno)
        {
            catno = catno.Trim().ToLower();
            var product = (from x in db.Products
                           where x.Sku.ToLower() == catno
                           && x.Published == true
                           && x.Deleted == false
                           select new
                           {
                               Id = x.Id,
                               Name = x.Name,
                               CATNo = x.Sku,
                               CASNo = x.ManufacturerPartNumber,
                               MolWeight = x.MolecularWeight,
                               MolFormula = x.Gtin,
                               APIName = x.MainCatName,
                               APIID = x.MainCatId
                           }).FirstOrDefault();

            return Json(product, JsonRequestBehavior.AllowGet);
        }

        public int GetProductCountOfQuote(DateTime startDate, DateTime endDate, List<SZ_Quotation> quotationData)
        {
            var productCount = (from q in quotationData
                                where q.CreatedDate >= startDate && q.CreatedDate <= endDate
                                select q.SZ_QuotationDetail.Count).Sum(x => x);
            return productCount;
        }
        public int GetQuoteCountOfQuote(DateTime startDate, DateTime endDate, List<SZ_Quotation> quotationData)
        {
            var productCount = (from q in quotationData
                                where q.CreatedDate >= startDate && q.CreatedDate <= endDate
                                select q).Count();
            return productCount;
        }

        public int GetApprovedCountOfQuote(DateTime startDate, DateTime endDate, List<SZ_Quotation> quotationData)
        {
            var productCount = (from q in quotationData
                                where q.CreatedDate >= startDate && q.CreatedDate <= endDate
                                && (q.IsQuoteApproved == false || q.IsQuoteApproved == null) && !string.IsNullOrEmpty(q.ApprovedBy)
                                select q).Count();
            return productCount;
        }

        public ActionResult Chat()
        {
            return View();
        }


        public ActionResult PopupList()
        {
            var model = db.SZ_Popup.AsEnumerable();
            return View(model);
        }
        public ActionResult GroupList()
        {
            var model = db.SZ_PopupGroup.AsEnumerable();
            return View(model);
        }

        public ActionResult GetSynzealUsers()
        {
            var users = (from i in db.Customers
                         where (i.Email.Contains("@synzeal.com") || i.Email.Contains("parthsuthar2010")) && i.Active == true && i.Deleted == false
                         select new
                         {
                             Id = i.Id,
                             Email = i.Email
                         }).ToList();
            return Json(users, JsonRequestBehavior.AllowGet);
        }
        public ActionResult AddPopup(int id = 0)
        {
            var model = db.SZ_Popup.Where(x => x.Id == id).FirstOrDefault();
            if (model == null)
            {
                model = new SZ_Popup();
            }

            var customerlist = db.Customers.Where(x => x.Deleted == false).OrderBy(x => x.Email).ToList();
            var userlistItems = new List<SelectListItem>();
            userlistItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            foreach (var term in customerlist)
            {
                if (string.IsNullOrEmpty(term.Email))
                {
                    continue;
                }
                userlistItems.Add(new SelectListItem
                {
                    Text = term.Email,
                    Value = term.Id.ToString()
                });
            }
            ViewBag.userList = userlistItems;

            var groupdatalist = db.SZ_PopupGroup.ToList();
            var grouplistItems = new List<SelectListItem>();
            grouplistItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            foreach (var term in groupdatalist)
            {
                grouplistItems.Add(new SelectListItem
                {
                    Text = term.GroupName,
                    Value = term.Id.ToString()
                });
            }
            ViewBag.groupList = grouplistItems;

            return View(model);
        }


        public ActionResult AddPopupGroup(int id = 0)
        {
            var model = db.SZ_PopupGroup.Where(x => x.Id == id).FirstOrDefault();
            if (model == null)
            {
                model = new SZ_PopupGroup();
            }

            var customerlist = db.Customers.Where(x => x.Deleted == false).OrderBy(x => x.Email).ToList();
            var userlistItems = new List<SelectListItem>();
            userlistItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });
            foreach (var term in customerlist)
            {
                if (string.IsNullOrEmpty(term.Email))
                {
                    continue;
                }
                userlistItems.Add(new SelectListItem
                {
                    Text = term.Email,
                    Value = term.Id.ToString()
                });
            }
            ViewBag.userList = userlistItems;
            if (model != null)
            {
                ViewBag.UserId = string.Join(",", model.SZ_PopupGroupEmailList.Select(x => x.CustomerId).ToList());
            }
            return View(model);
        }

        [HttpPost]
        public JsonResult AddPopupGroupData(PopupGroupModel model)
        {
            try
            {
                var data = db.SZ_PopupGroup.Where(x => x.Id == model.Id).FirstOrDefault();
                if (data != null)
                {
                    data.GroupName = model.GroupName;
                    db.Entry(data).State = EntityState.Modified;

                    List<int> uid = new List<int>();
                    var userids = model.UserId.Split(',');
                    if (userids != null && userids.Count() > 0)
                    {
                        foreach (var item in userids)
                        {
                            if (!string.IsNullOrEmpty(item))
                            {
                                uid.Add(Convert.ToInt32(item));
                            }
                        }
                    }

                    var mappedData = db.SZ_PopupGroupEmailList.Where(x => x.GroupId == model.Id).ToList();
                    if (mappedData != null && mappedData.Count > 0)
                    {
                        foreach (var item in mappedData)
                        {
                            db.Entry(item).State = EntityState.Modified;
                        }
                    }

                    var customerData = db.Customers.Where(x => uid.Contains(x.Id)).ToList();
                    foreach (var id in uid)
                    {
                        SZ_PopupGroupEmailList objPopupGroupEmailModel = new SZ_PopupGroupEmailList();
                        objPopupGroupEmailModel.GroupId = model.Id;
                        objPopupGroupEmailModel.CustomerId = id;
                        objPopupGroupEmailModel.EmailAddress = customerData.Where(x => x.Id == id).Select(x => x.Email).FirstOrDefault();
                        db.SZ_PopupGroupEmailList.Add(objPopupGroupEmailModel);
                    }
                    db.SaveChanges();
                }
                else
                {
                    SZ_PopupGroup objModel = new SZ_PopupGroup();
                    objModel.GroupName = model.GroupName;
                    objModel.CreatedBy = SessionCookieManagement.UserName;
                    objModel.CreatedDate = DateTime.Now;
                    db.SZ_PopupGroup.Add(objModel);
                    db.SaveChanges();

                    List<int> uid = new List<int>();
                    var userids = model.UserId.Split(',');
                    if (userids != null && userids.Count() > 0)
                    {
                        foreach (var item in userids)
                        {
                            if (!string.IsNullOrEmpty(item))
                            {
                                uid.Add(Convert.ToInt32(item));
                            }
                        }
                        var customerData = db.Customers.Where(x => uid.Contains(x.Id)).ToList();
                        foreach (var id in uid)
                        {
                            SZ_PopupGroupEmailList objPopupGroupEmailModel = new SZ_PopupGroupEmailList();
                            objPopupGroupEmailModel.GroupId = objModel.Id;
                            objPopupGroupEmailModel.CustomerId = id;
                            objPopupGroupEmailModel.EmailAddress = customerData.Where(x => x.Id == id).Select(x => x.Email).FirstOrDefault();
                            db.SZ_PopupGroupEmailList.Add(objPopupGroupEmailModel);
                        }
                        db.SaveChanges();
                    }
                }
                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = ""
                }, JsonRequestBehavior.AllowGet);
            }
        }


        [HttpPost]
        public JsonResult AddPopUpData(PopupModel model, FormCollection form)
        {
            try
            {
                string FileName = "";
                HttpFileCollectionBase files = Request.Files;
                for (int i = 0; i < files.Count; i++)
                {
                    HttpPostedFileBase file = files[i];
                    string fname;

                    // Checking for Internet Explorer    
                    if (Request.Browser.Browser.ToUpper() == "IE" || Request.Browser.Browser.ToUpper() == "INTERNETEXPLORER")
                    {
                        string[] testfiles = file.FileName.Split(new char[] { '\\' });
                        fname = testfiles[testfiles.Length - 1];
                    }
                    else
                    {
                        fname = file.FileName;
                        FileName = file.FileName;
                    }

                    // Get the complete folder path and store the file inside it.    
                    fname = Path.Combine(Server.MapPath("~/Content/NewProducts/"), fname);
                    file.SaveAs(fname);

                    FileName = "http://spms.synzeal.com/Content/NewProducts/" + fname;
                }

                if (model.Id == 0)
                {
                    //Insert Data
                    SZ_Popup objModel = new SZ_Popup();
                    objModel.Name = model.Name;
                    objModel.FilePath = FileName;
                    objModel.IsGeneral = model.IsGeneral;
                    objModel.IsEmailOrGroup = model.IsEmailOrGroup;
                    objModel.SZPopupGroupId = model.SZPopupGroupId;
                    objModel.IsActive = model.IsActive;
                    objModel.IsSystemPopup = false;
                    db.SZ_Popup.Add(objModel);
                    db.SaveChanges();

                    if (!model.IsGeneral)
                    {
                        if (model.IsEmailOrGroup)
                        {
                            SZ_PopupGroup objPopupGroup = new SZ_PopupGroup();
                            objPopupGroup.GroupName = "Test_" + model.Name;
                            objPopupGroup.CreatedBy = SessionCookieManagement.UserName;
                            objPopupGroup.CreatedDate = DateTime.Now;
                            db.SZ_PopupGroup.Add(objPopupGroup);

                            List<int> uid = new List<int>();
                            var userids = model.UserId.Split(',');
                            if (userids != null && userids.Count() > 0)
                            {
                                foreach (var item in userids)
                                {
                                    if (!string.IsNullOrEmpty(item))
                                    {
                                        uid.Add(Convert.ToInt32(item));
                                    }
                                }
                            }
                            var customerData = db.Customers.Where(x => uid.Contains(x.Id)).ToList();
                            foreach (var id in uid)
                            {
                                SZ_PopupGroupEmailList objPopupGroupEmailModel = new SZ_PopupGroupEmailList();
                                objPopupGroupEmailModel.GroupId = objPopupGroup.Id;
                                objPopupGroupEmailModel.CustomerId = id;
                                objPopupGroupEmailModel.EmailAddress = customerData.Where(x => x.Id == id).Select(x => x.Email).FirstOrDefault();
                                db.SZ_PopupGroupEmailList.Add(objPopupGroupEmailModel);
                            }

                        }
                    }
                }
                else
                {
                    //Update Data
                }

                return Json(new
                {
                    success = true
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = ""
                }, JsonRequestBehavior.AllowGet);
            }
        }

        public ActionResult PopupGroupList()
        {
            return View();
        }

        public ActionResult SciPRRequestList()
        {
            if (!SessionCookieManagement.IsLogin && !SessionCookieManagement.IsScientist)
            {
                return RedirectToAction("Index", "Home");
            }
            var model = db.SZ_PRRequest.Where(x => x.RaisedByUserId == SessionCookieManagement.UserId).ToList();
            return View(model);
        }
        public ActionResult PurPRRequestList()
        {
            if (!SessionCookieManagement.IsAdmin && !SessionCookieManagement.IsPurchase)
            {
                return RedirectToAction("Index", "Home");
            }
            var model = db.SZ_PRRequest.ToList();
            return View(model);
        }

        public ActionResult PRRequest(int id = 0)
        {
            if (!SessionCookieManagement.IsLogin && !SessionCookieManagement.IsScientist)
            {
                return RedirectToAction("Index", "Home");
            }
            var model = db.SZ_PRRequest.Where(x => x.Id == id).FirstOrDefault();
            if (model == null)
            {
                model = new SZ_PRRequest();
                model.RaisedBy = SessionCookieManagement.UserName;
                model.RaisedByUserId = SessionCookieManagement.UserId;
            }
            MemoryCacheManager objCache = new MemoryCacheManager();
            var genericData = objCache.Get("cache.genericData", () =>
            {
                return db.GenericAttributes.Where(x => x.KeyGroup == "Customer").ToList();
            });

            var listItems = new List<SelectListItem>();
            var scienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("scientist")).ToList();
            foreach (var term in scienList)
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }
                listItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.Id.ToString()
                });
            }
            var subscienList = db.Customers.Where(x => x.Deleted == false && x.Active == true && x.CustomerRoles.Select(z => z.SystemName.ToLower()).Contains("subscientist")).ToList();
            foreach (var term in subscienList)
            {
                string customerName = string.Empty;
                var genericAttr = genericData.Where(x => x.KeyGroup == "Customer" && x.EntityId == term.Id).ToList();
                if (genericAttr.Count > 0)
                {
                    customerName = genericAttr.Where(x => x.Key == "FirstName").Select(x => x.Value).FirstOrDefault() + " " + genericAttr.Where(x => x.Key == "LastName").Select(x => x.Value).FirstOrDefault();
                }

                listItems.Add(new SelectListItem
                {
                    Text = customerName,
                    Value = term.Id.ToString()
                });
            }
            ViewBag.scientistItems = listItems.OrderBy(x => x.Text);

            var lablistItems = new List<SelectListItem>();
            lablistItems.Add(new SelectListItem
            {
                Text = "--Select--",
                Value = ""
            });

            for (int i = 1; i <= 7; i++)
            {
                lablistItems.Add(new SelectListItem
                {
                    Text = "Lab " + i,
                    Value = i.ToString()
                });
            }
            ViewBag.lablistItems = lablistItems;

            var prstatuslist = new List<SelectListItem>();
            foreach (EnumList.PRRequestStatus r in Enum.GetValues(typeof(EnumList.PRRequestStatus)))
            {
                var item = Enum.GetName(typeof(EnumList.PRRequestStatus), r);
                var test = r.ToString();
                string text = SZ_Helper.GetEnumDescription((EnumList.PRRequestStatus)(int)r);
                int val = (int)r;
                listItems.Add(new SelectListItem
                {
                    Text = text,
                    Value = val.ToString()
                });
            }

            ViewBag.lablistItems = lablistItems;
            return View(model);
        }


        public ActionResult GetAddNewRawInQuote(int displayOrder, int quoteid)
        {
            ViewBag.QuoteId = quoteid;
            ViewBag.DisplayOrder = displayOrder;
            var htmlstring = PartialViewdata(this, "_PartialAddNewRawInQuote", null);
            return Json(htmlstring, JsonRequestBehavior.AllowGet);
        }

        public ActionResult GetRawMaterialDataByProject(int productid)
        {
            var product = db.Products.Where(x => x.Id == productid).FirstOrDefault();
            using (WebClient webClient = new WebClient())
            {
                webClient.BaseAddress = "http://103.54.21.42:333/api/";
                var json = Task.Run(() => webClient.DownloadString("SAPData/GetSAPPurchase/" + product.MainCatName));
                string productModel = JsonConvert.DeserializeObject<string>(json.Result);
                var list = JsonConvert.DeserializeObject<List<SAPRawMaterialModel>>(productModel);

                if (list != null && list.Count > 0)
                {
                    var htmlstring = PartialViewdata(this, "_PartialRawMaterialData", list);
                    return Json(htmlstring, JsonRequestBehavior.AllowGet);
                }
            }
            return Json("", JsonRequestBehavior.AllowGet);
        }

        public ActionResult GetRawMaterialDataByCASNo(int productid)
        {
            var product = db.Products.Where(x => x.Id == productid).FirstOrDefault();

            if (string.IsNullOrEmpty(product.ManufacturerPartNumber) || product.ManufacturerPartNumber == "NA" || product.ManufacturerPartNumber == "N/A")
            {
                return Json("", JsonRequestBehavior.AllowGet);
            }

            using (WebClient webClient = new WebClient())
            {
                webClient.BaseAddress = "http://103.54.21.42:333/api/";
                var json = Task.Run(() => webClient.DownloadString("SAPData/GetSAPPurchaseCASNo/" + product.ManufacturerPartNumber));
                string productModel = JsonConvert.DeserializeObject<string>(json.Result);
                var list = JsonConvert.DeserializeObject<List<SAPRawMaterialModel>>(productModel.ToString());

                if (list != null && list.Count > 0)
                {
                    var htmlstring = PartialViewdata(this, "_PartialRawMaterialData", list);
                    return Json(htmlstring, JsonRequestBehavior.AllowGet);
                }
            }
            return Json("", JsonRequestBehavior.AllowGet);
        }

        public string FetchCASNofromSAP()
        {
            try
            {
                using (WebClient webClient = new WebClient())
                {
                    webClient.BaseAddress = "http://103.54.21.42:333/api/";
                    var json = Task.Run(() => webClient.DownloadString("SAPData/GetSAPPurchaseCASNo"));
                    string productModel = JsonConvert.DeserializeObject<string>(json.Result);
                    var list = JsonConvert.DeserializeObject<List<SAPCASNOModel>>(productModel);

                    if (list != null && list.Count > 0)
                    {
                        var allpredata = db.SZ_SAPCASNo.ToList();
                        foreach (var item in allpredata)
                        {
                            db.Entry(item).State = EntityState.Deleted;
                        }
                        db.SaveChanges();
                        foreach (var item in list)
                        {
                            if (item != null)
                            {
                                // Insert Data
                                var matchdata = new SZ_SAPCASNo();
                                matchdata.CASNo = item.CASNo;
                                db.SZ_SAPCASNo.Add(matchdata);
                            }
                        }
                        db.SaveChanges();
                    }
                }
            }
            catch (WebException ex)
            {
                throw ex;
            }

            return "success";
        }

        public string FetchProjectNamefromSAP()
        {
            try
            {
                using (WebClient webClient = new WebClient())
                {
                    webClient.BaseAddress = "http://103.54.21.42:333/api/";
                    var json = Task.Run(() => webClient.DownloadString("SAPData/GetSAPPurchaseProject"));
                    string productModel = JsonConvert.DeserializeObject<string>(json.Result);
                    var list = JsonConvert.DeserializeObject<List<SAPProjectModel>>(productModel);

                    if (list != null && list.Count > 0)
                    {
                        var allpredata = db.SZ_SAPProjectNameData.ToList();

                        foreach (var item in allpredata)
                        {
                            db.Entry(item).State = EntityState.Deleted;
                        }
                        db.SaveChanges();

                        foreach (var item in list)
                        {
                            if (item != null)
                            {
                                //var matchdata = allpredata.Where(x => x.ProjectName == item.Project).FirstOrDefault();
                                //if (matchdata != null)
                                //{
                                //    // Update Data
                                //    matchdata.ProjectName = item.Project;
                                //    db.Entry(matchdata).State = EntityState.Modified;
                                //}
                                //else
                                //{
                                // Insert Data
                                var matchdata = new SZ_SAPProjectNameData();
                                matchdata.ProjectName = item.Project;
                                db.SZ_SAPProjectNameData.Add(matchdata);
                                //}
                            }
                        }
                        db.SaveChanges();
                    }
                }
            }
            catch (WebException ex)
            {
                throw ex;
            }

            return "success";
        }

        public string FetchCompanyMasterfromSAP()
        {
            //http://103.54.21.42:333/api/SAPData/GetSAPBusinessPartner
            //http://103.54.21.42:333/api/SAPData/GetSAPBPPaymentTerms

            using (WebClient webClient = new WebClient())
            {
                webClient.BaseAddress = "http://103.54.21.42:333/api/";
                var json = Task.Run(() => webClient.DownloadString("SAPData/GetSAPBusinessPartner"));
                string productModel = JsonConvert.DeserializeObject<string>(json.Result);
                var list = JsonConvert.DeserializeObject<List<MyArray>>(productModel);
                var allpredata = db.SZ_CompanyList.ToList();
                if (list != null && list.Count > 0)
                {
                    foreach (var item in list)
                    {
                        if (item != null)
                        {
                            var matchdata = allpredata.Where(x => x.SAPCode == item.BPCode).FirstOrDefault();
                            if (matchdata != null)
                            {
                                if (!string.IsNullOrEmpty(item.BPName))
                                {
                                    item.BPName = item.BPName.Trim();
                                }
                                // Update Data
                                matchdata.Name = item.BPName;
                                matchdata.Add1 = item.Bill2_Block + " " + item.Bill2_Building + " " + item.Bill2_Address;
                                matchdata.Add2 = item.Bill2_StreetNo;
                                matchdata.City = item.Bill2_City;
                                matchdata.State = item.Bill2_StateName;
                                matchdata.Country = item.Bill2_Country;
                                matchdata.PostCode = item.Bill2_ZipCode;

                                matchdata.ShipAdd1 = item.Ship2_Block + " " + item.Ship2_Building + " " + item.Ship2_Address;
                                matchdata.ShipAdd2 = item.Ship2_StreetNo;
                                matchdata.ShipCity = item.Ship2_City;
                                matchdata.ShipState = item.Ship2_StateName;
                                matchdata.ShipCountry = item.Ship2_Country;
                                matchdata.ShipPostCode = item.Ship2_ZipCode;
                                matchdata.UpdatedDate = DateTime.Now;

                                matchdata.PaymentTerms = item.PaymentTermsName;
                                matchdata.InccoTerm = item.IncoTerms;

                                db.Entry(matchdata).State = EntityState.Modified;

                                var szquotedata = db.SZ_Quotation.Where(x => x.CompanyId == matchdata.Id).ToList();
                                if (szquotedata != null && szquotedata.Count > 0)
                                {
                                    szquotedata.ForEach(x =>
                                    {
                                        x.CompanyName = matchdata.Name;
                                    });
                                }
                            }
                        }
                    }
                    db.SaveChanges();
                }
            }


            using (WebClient webClient = new WebClient())
            {
                webClient.BaseAddress = "http://103.54.21.42:333/api/";
                var json = Task.Run(() => webClient.DownloadString("SAPData/GetSAPBPPaymentTerms"));
                string productModel = JsonConvert.DeserializeObject<string>(json.Result);
                var list = JsonConvert.DeserializeObject<List<SAPPaymentTerm>>(productModel);
                var allpredata = db.PaymentTerms.ToList();
                if (list != null && list.Count > 0)
                {
                    foreach (var item in list)
                    {
                        if (item != null)
                        {
                            var matchdata = allpredata.Where(x => x.Name == item.PaymentTermsName).FirstOrDefault();
                            if (matchdata != null)
                            {
                                // Update Data
                                matchdata.Name = item.PaymentTermsName;
                                matchdata.SAPId = item.PaymentTermsCode;
                                db.Entry(matchdata).State = EntityState.Modified;
                            }
                            else
                            {
                                matchdata = new PaymentTerm();
                                matchdata.Name = item.PaymentTermsName;
                                matchdata.SAPId = item.PaymentTermsCode;
                                matchdata.CreatedDate = DateTime.Now;
                                matchdata.UpdatedDate = DateTime.Now;
                                db.Entry(matchdata).State = EntityState.Added;
                            }
                        }
                    }
                    db.SaveChanges();
                }
            }

            //GetSAPBPIncoTerms
            using (WebClient webClient = new WebClient())
            {
                webClient.BaseAddress = "http://103.54.21.42:333/api/";
                var json = Task.Run(() => webClient.DownloadString("SAPData/GetSAPBPIncoTerms"));
                string productModel = JsonConvert.DeserializeObject<string>(json.Result);
                var list = JsonConvert.DeserializeObject<List<SAPIncoTerm>>(productModel);
                var allpredata = db.InccoTerms.ToList();
                if (list != null && list.Count > 0)
                {
                    foreach (var item in list)
                    {
                        if (item != null)
                        {
                            var matchdata = allpredata.Where(x => x.Name == item.INCO_TERM).FirstOrDefault();
                            if (matchdata != null)
                            {
                                // Update Data
                                matchdata.Name = item.INCO_TERM;
                                db.Entry(matchdata).State = EntityState.Modified;
                            }
                            else
                            {
                                matchdata = new InccoTerm();
                                matchdata.Name = item.INCO_TERM;
                                matchdata.SAPId = 0;
                                matchdata.CreatedDate = DateTime.Now;
                                matchdata.UpdatedDate = DateTime.Now;
                                matchdata.CreatedBy = "API";
                                matchdata.UpdatedBy = "API";
                                db.Entry(matchdata).State = EntityState.Added;
                            }
                        }
                    }
                    db.SaveChanges();
                }
            }


            return "success";
        }

        public ActionResult settleQuoteDetailsPrice()
        {
            int loop = 1;
            db.Configuration.AutoDetectChangesEnabled = false;
            var model = new List<SZ_QuoteDetailPrice>();
            var szQuoteDetailsData = db.SZ_QuotationDetail.ToList();
            szQuoteDetailsData.ForEach(item =>
            {
                var price = item.Price;
                if (string.IsNullOrEmpty(price))
                {
                    goto _continue;
                }
                if (price.ToLower().Contains("structure"))
                {
                    goto _continue;
                }

                var spliprice = price.Split(',');
                if (spliprice != null && spliprice.Count() > 0)
                {
                    foreach (var pri in spliprice)
                    {
                        string currency = item.SZ_Quotation.Currency;
                        int qty = 0;
                        decimal pricequote = 0;
                        var pstr = pri.Split('@');
                        if (!string.IsNullOrEmpty(pstr[0].Trim().Replace("mg", "")))
                        {
                            try
                            {
                                qty = Convert.ToInt32(pstr[0].Trim().Replace("mg", ""));
                            }
                            catch (Exception ex)
                            {
                                qty = 0;
                            }
                        }
                        if (pstr.Count() > 1)
                        {
                            if (!string.IsNullOrEmpty(pstr[1].Trim()))
                            {
                                try
                                {
                                    pricequote = Convert.ToDecimal(pstr[1].Trim().Split(' ')[0]);
                                }
                                catch (Exception ex)
                                {
                                    pricequote = 0;
                                }
                            }
                        }
                        else
                        {
                            goto _continue;
                        }
                        var vialstr = "";
                        if (pri.Contains("X") == true)
                        {
                            var vial = pri.Split('X');
                            if (vial != null && vial.Count() > 0)
                            {
                                vialstr = vial[1].Split('=')[0].Trim();
                            }
                            if (string.IsNullOrEmpty(currency))
                            {
                                try
                                {
                                    currency = vial[1].Split('=')[1].Trim().Split(' ')[1];

                                    if (currency.Length > 3)
                                    {
                                        if (vial[1].Contains("INR"))
                                        {
                                            currency = "INR";
                                        }
                                        if (vial[1].Contains("USD"))
                                        {
                                            currency = "USD";
                                        }
                                    }
                                }
                                catch (Exception)
                                {
                                    if (vial[1].Contains("INR"))
                                    {
                                        currency = "INR";
                                    }
                                    if (vial[1].Contains("USD"))
                                    {
                                        currency = "USD";
                                    }
                                }
                            }
                        }
                        else
                        {
                            if (string.IsNullOrEmpty(currency))
                            {
                                var prisplitcount = pri.Trim().Split(' ').Count();
                                currency = pri.Trim().Split(' ')[prisplitcount - 1];
                                currency = currency.Replace("+", "").Trim();
                                if (currency.Length > 3)
                                {
                                    currency = currency.Substring(0, 3);
                                }
                                if (currency.Length < 3)
                                {
                                    if (pri.Contains("INR"))
                                    {
                                        currency = "INR";
                                    }
                                    if (pri.Contains("USD"))
                                    {
                                        currency = "USD";
                                    }
                                }
                            }
                        }

                        try
                        {
                            var objmodel = new SZ_QuoteDetailPrice()
                            {
                                QuoteDetailsId = item.Id,
                                Currency = !string.IsNullOrEmpty(currency) ? (currency.Contains("structure") ? "" : currency) : "",
                                MG = qty,
                                Price = pricequote,
                                Vial = !string.IsNullOrEmpty(vialstr) ? Convert.ToInt32(vialstr) : 0
                            };
                            model.Add(objmodel);
                        }
                        catch (Exception)
                        {
                            goto _continue;
                        }
                    }
                }


                if (loop == 10000)
                {
                    db.SZ_QuoteDetailPrice.AddRange(model);
                    db.SaveChanges();

                    model = new List<SZ_QuoteDetailPrice>();
                    loop = 0;
                }
                loop += 1;

                _continue:;

            });

            db.SZ_QuoteDetailPrice.AddRange(model);
            db.SaveChanges();
            db.Configuration.AutoDetectChangesEnabled = true;
            return Content("success");
        }

        public ActionResult GetSampleRequest(int day)
        {
            DateTime startdate = DateTime.Now.AddYears(-10);
            if (day != 0)
            {
                startdate = DateTime.Now.AddDays(-day);
            }

            var model = (from i in db.SZ_SampleRequest
                         join sr in db.SZ_SampleRequestDetail on i.Id equals sr.SampleRequestId
                         where i.CreatedDate >= startdate
                         select new
                         {
                             Id = i.Id,
                             RequestNo = !string.IsNullOrEmpty(i.RequestNo) ? i.RequestNo : "",
                             Name = !string.IsNullOrEmpty(i.Name) ? i.Name : "",
                             RequestDate = i.RequestDate,
                             Department = !string.IsNullOrEmpty(i.Department) ? i.Department : "",
                             IsConfirm = i.IsConfirm,
                             ProductName = !string.IsNullOrEmpty(sr.ProductName) ? sr.ProductName : "",
                             CASNo = !string.IsNullOrEmpty(sr.CASNo) ? sr.CASNo : "",
                             CATNo = !string.IsNullOrEmpty(sr.CATNo) ? sr.CATNo : "",
                             BatchCode = !string.IsNullOrEmpty(sr.BatchCode) ? sr.BatchCode : "",
                             Qty = sr.Qty,
                             Reason = !string.IsNullOrEmpty(sr.Reason) ? sr.Reason : "",
                             IsApproved = sr.IsApproved,
                             Handoverby = !string.IsNullOrEmpty(sr.Handoverby) ? sr.Handoverby : "",
                             RejectReason = !string.IsNullOrEmpty(sr.RejectReason) ? sr.RejectReason : "",
                         }).ToList();

            return Json(model, JsonRequestBehavior.AllowGet);
        }


        [HttpGet]
        public JsonResult TestAPICall()
        {
            try
            {
                string uri = "http://103.54.21.42:333/api/BATest/Get";
                var userName = "Spms";
                var userPassword = "Sz@123";
                var TARGETURL = uri;

                HttpClientHandler handler = new HttpClientHandler()
                {
                    Proxy = new WebProxy("http://103.54.21.42:333"),
                    UseProxy = true,
                };
                Console.WriteLine("GET: + " + TARGETURL);
                // ... Use HttpClient.            
                HttpClient client = new HttpClient(handler);

                var byteArray = Encoding.ASCII.GetBytes("Spms:Sz@123");
                client.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Basic", Convert.ToBase64String(byteArray));

                HttpResponseMessage response = client.GetAsync(TARGETURL).Result;
                HttpContent content = response.Content;

                string result = content.ReadAsStringAsync().Result;

                return Json(new
                {
                    success = true,
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false
                }, JsonRequestBehavior.AllowGet);
            }
        }


        public ActionResult UpdateQuoteAndPOValue()
        {
            DateTime threemonth = DateTime.Now.AddMonths(-1);
            var quoteData = db.SZ_Quotation.Where(x => x.CreatedDate >= threemonth).ToList();

            quoteData.ForEach(item =>
            {
                item.QuoteValue = GetQuoteProductValue(item);
                item.POValue = GetPOProductValue(item);
            });

            db.SaveChanges();

            return Content("success");
        }


        public ActionResult RemoveCaching()
        {
            return Content("success");
        }

    }


    public class ProductInfo
    {
        [AllowHtml]
        public string ProductName { get; set; }
        public string casno { get; set; }
        public string catNo { get; set; }
        [AllowHtml]
        public string price { get; set; }
        [AllowHtml]
        public string finalprice { get; set; }
        [AllowHtml]
        public string leadtime { get; set; }
        public int id { get; set; }
        public string ponumber { get; set; }
        public int displayOrder { get; set; }
        [AllowHtml]
        public string productremark { get; set; }
        [AllowHtml]
        public string followUpRemark { get; set; }
        [AllowHtml]
        public string followUpRemarkSecond { get; set; }
        public string estimateDispatchDate { get; set; }
        public string projectType { get; set; }
        public int? scientistCustomerid { get; set; }
        public bool? synthesislog { get; set; }
        public string actionname { get; set; }
        public string batchno { get; set; }

        [AllowHtml]
        public string contactdetail { get; set; }
        public bool IsClubQuotation { get; set; }
        public decimal? discount { get; set; }
        public string tracebilityCost { get; set; }
        public string coldShipCost { get; set; }
        public string addTestCost { get; set; }
        public string tracebilityCostRemark { get; set; }
        public string coldShipCostRemark { get; set; }
        public string addTestCostRemark { get; set; }
        public Nullable<int> coa { get; set; }
        public string ActivityStatus { get; set; }
        [AllowHtml]
        public string technicalEmail { get; set; }
        [AllowHtml]
        public string internalComment { get; set; }
        public bool? iscontrolledsubstancecharge { get; set; }
    }

    public class PerformaInvoiceDetails
    {
        public int id { get; set; }
        public string price { get; set; }
        public string trace { get; set; }
        public string addtest { get; set; }
        public string coldship { get; set; }
        public string HSNCode { get; set; }

    }

    public class ProductPriceModel
    {
        public string ChkRow { get; set; }
        public int Id { get; set; }
        public int SrNo { get; set; }
        public string ProductName { get; set; }
        public string casno { get; set; }
        public string catNo { get; set; }
        public string catNoLink { get; set; }
        public string TenPrice { get; set; }
        public string TwentyFivePrice { get; set; }
        public string FiftyPrice { get; set; }
        public string HundredPrice { get; set; }
        public string TwoHundredPrice { get; set; }
        public string FivehundredPrice { get; set; }
        public string OneThousandPrice { get; set; }
        public string DiscountINR { get; set; }
        public string DiscountUSD { get; set; }
        public string LeadTime { get; set; }
        public string RefStock { get; set; }
        public string LastRow { get; set; }
        public string ImagePath { get; set; }
        public bool IsBatchAvailable { get; set; }
        public string CategoryMasterUSDText { get; set; }
        public string CategoryMasterINRText { get; set; }
        public string AdditionalBatchNoText { get; set; }
        public int? CategoryMasterUSDId { get; set; }
        public int? CategoryMasterINRId { get; set; }
        public string TenUSD { get; set; }
        public string TwentyfiveUSD { get; set; }
        public string FiftyUSD { get; set; }
        public string OnehundredUSD { get; set; }
        public string TwohundredFiftyUSD { get; set; }
        public string FivehundredUSD { get; set; }
        public string OneThousandUSD { get; set; }
        public string CopyPaste { get; set; }
        public string ProductRemark { get; set; }
        public string ApprovedText { get; set; }
        public Nullable<bool> IsPriceApproved { get; set; }
    }

    public class ProductMasterModel
    {
        public string Quotationreceived { get; set; }
        public string PurchaseComment { get; set; }
        public string ProductRemark { get; set; }
        public string ChkRow { get; set; }
        public int Id { get; set; }
        public int SrNo { get; set; }
        public string ProductName { get; set; }
        public string casno { get; set; }
        public string MW { get; set; }

        public string MF { get; set; }

        public string catNo { get; set; }
        public string LeadTime { get; set; }
        public string Appearance { get; set; }
        public string DdlStatus { get; set; }
        public string ReTestRequired { get; set; }
        public string ShippingCondition { get; set; }
        public string EndUse { get; set; }
        public string SourceRequired { get; set; }
        public string Source { get; set; }
        public string ImagePath { get; set; }
        public string BatchNo { get; set; }
        public string Description { get; set; }
        public string CountryOrigin { get; set; }
        public string HSNCode { get; set; }
        public string DangGoodToShip { get; set; }
        public string SameAs { get; set; }
        public string ProductStatus { get; set; }
        public string ProductDdlStatus { get; set; }
        public string AdditionalBatchNoText { get; set; }
        public string BatchDataCheck { get; set; }

        public string HPLC { get; set; }
        public string RbAdditionalAnalysis { get; set; }
        public string IR { get; set; }
        public string Mass { get; set; }
        public string HPLCGCELSD { get; set; }
        public string NMR { get; set; }
        public string qNMR { get; set; }
        public string TGA { get; set; }
        public string CMR { get; set; }
        public string DEPT { get; set; }
        public string HRMS { get; set; }
        public string ROI { get; set; }
        public string Elemental { get; set; }
        public string SER { get; set; }
        public string GC { get; set; }
        public string ELSD { get; set; }
        public string Chairal { get; set; }
        public string APCIMass { get; set; }
        public string NMRInterpretaion { get; set; }
        public string StabilitySolution { get; set; }
        public string StabilityRT { get; set; }
        public string Photostability { get; set; }
        public string Hygroscopic { get; set; }
        public string TempSensitive { get; set; }
        public string Lacrymatory { get; set; }
        public bool IsBatchAvailable { get; set; }
        public string ControlledSubstance { get; set; }
        public string ManualControlledSubstance { get; set; }

        public string IsTracebility { get; set; }
        public string IsTechnicalReport { get; set; }

        public string TracebilityComment { get; set; }
        public string Important { get; set; }
    }
    public class SZ_QuotationDetailModel
    {
        public int Id { get; set; }
        public Nullable<int> ProductId { get; set; }
        public string ProductName { get; set; }
        public string CASNo { get; set; }
        public string CATNo { get; set; }
    }

    public class UserInfo
    {
        public string ConnectionId { get; set; }
        public string UserName { get; set; }
        public string UserGroup { get; set; }

        //if freeflag==0 ==> Busy
        //if freeflag==1 ==> Free
        public string freeflag { get; set; }

        //if tpflag==2 ==> User Admin
        //if tpflag==0 ==> User Member
        //if tpflag==1 ==> Admin

        public string tpflag { get; set; }

        public int UserID { get; set; }
        public int AdminID { get; set; }
    }

    public class MessageInfo
    {
        public string UserName { get; set; }

        public string Message { get; set; }

        public string UserGroup { get; set; }

        public string StartTime { get; set; }

        public string EndTime { get; set; }

        public string MsgDate { get; set; }
    }
}


