@{
    ViewBag.Title = "Project";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@model List<SZ_QuotationModel>
@using Synzeal_Inventory.Models
<style type="text/css">
    #example1 input {
        border: 0px;
    }
</style>
<section class="content-header">
    <h1>
        Project List <a href="javascript:void(0)" style="float:right" class="btn btn-primary" onclick="MoveToDispatchList()">Move to Dispatch</a>
    </h1>
</section>


<section class="content">
    <div class="row">
        <div class="col-xs-12">
            <div class="box box-primary">
                <ul class="nav nav-tabs">
                    <li class="active"><a data-toggle="tab" href="#home">ALL</a></li>
                    <li><a data-toggle="tab" href="#menu1">HOLD</a></li>
                </ul>

                <div class="tab-content">
                    <div id="home" class="tab-pane fade in active">
                        <!-- /.box-header -->
                        <div class="box-body" style="overflow:scroll;" id="divProj">
                            <table id="example1" class="table table-bordered table-striped">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th></th>
                                        <th>#</th>
                                        <th>Project Type</th>
                                        <th>Scientist</th>
                                        <th>Qty</th>
                                        <th>CAS No</th>
                                        <th>CAT No</th>
                                        <th>Additional Batch No</th>
                                        <th>Batch No</th>
                                        @*<th>Data Required</th>*@
                                        <th>Company Name</th>
                                        <th>PO No</th>
                                        <th>Product Name</th>
                                        <th>Estimate Comp. Date</th>
                                        <th>Scientist Status</th>
                                        <th>Project Status</th>
                                        <th>Data Remark</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (Model.Count > 0)
                                    {
                                        foreach (var i in Model)
                                        {
                                            foreach (var k in i.SZ_QuotationProductModel.Where(x => x.IsOnHold != true).ToList())
                                            {
                                                <tr id="tr_@k.QuoteDetailsId" class="clsRow" data-ScientistStatus="@k.ScientistStatus" data-ReadyToDeliverScientistStatusId="@k.ReadyToDeliverScientistStatusId" data-MovetoDispatch="@k.MoveToDispatch">
                                                    <td>
                                                        <span id="textscientistId_@k.QuoteDetailsId"></span>
                                                    </td>
                                                    <td width="1%">
                                                        @if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == k.ReadyToDeliverScientistStatusId && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                                                        {
                                                            <i class="fa fa-check-square" style="color:lightseagreen"></i>
                                                        }
                                                        else if (k.ScientistStatus.HasValue && k.ScientistStatus.Value == k.ReadyToDeliverScientistStatusId)
                                                        {
                                                            <input type="checkbox" value="@k.QuoteDetailsId" class="clsMoveDispatch" />
                                                        }
                                                        else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && k.MoveToDispatch == null)
                                                        {
                                                            <input type="checkbox" value="@k.QuoteDetailsId" class="clsMoveDispatch" />
                                                        }
                                                        else if (k.ProjectType == Convert.ToString((int)EnumList.ProjectType.InStock) && k.MoveToDispatch != null && k.MoveToDispatch.Value)
                                                        {
                                                            <i class="fa fa-check-square" style="color:lightseagreen"></i>
                                                        }
                                                    </td>
                                                    <td>
                                                        @k.SrPo

                                                    </td>
                                                    <td>
                                                        <select id="projecttype_@k.QuoteDetailsId" class="clsProjType" data-quoteDetailsId="@k.QuoteDetailsId">
                                                            <option value="">--Select--</option>
                                                            @foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
                                                            {
                                                                var item = Enum.GetName(typeof(EnumList.ProjectType), r);
                                                                var test = r.ToString();
                                                                string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
                                                                int val = (int)r;
                                                                string selected = "";
                                                                if (Convert.ToString(val) == k.ProjectType)
                                                                {
                                                                    selected = "selected ";
                                                                }
                                                                <option value="@val" @selected>@text</option>
                                                            }
                                                        </select>
                                                    </td>
                                                    <td>
                                                        @Html.DropDownList("ScientistId_" + k.QuoteDetailsId, (IEnumerable<SelectListItem>)ViewBag.ScientistList, "--Select--", new { @class = "scientist", @scientistId = k.ScientistCustomerId, @quotedetailsid = k.QuoteDetailsId })
                                                    </td>
                                                    <td><input id="qty_@k.QuoteDetailsId" type="text" value="@k.RequiredQty" style="width:50px" /></td>
                                                    <td><label>@k.CASNo</label> </td>
                                                    <td><label>@k.CATNo</label> </td>
                                                    <td>
                                                        @Html.DropDownList("additionalBatch_" + k.QuoteDetailsId, (List<SelectListItem>)k.ListBatchNo)
                                                    </td>
                                                    <td><input id="batchno_@k.QuoteDetailsId" type="text" value="@k.BatchNo" style="width:120px" /></td>
                                                    @*<td></td>*@
                                                    <td> @i.CompanyName</td>
                                                    <td><label>@i.PONumber</label> </td>
                                                    <td><label>@k.ProductName</label> </td>
                                                    <td>
                                                        @if (k.EstimateCompleteDate.HasValue)
                                                        {
                                                            @k.EstimateCompleteDate.Value.ToShortDateString()
                                                        }
                                                    </td>
                                                    <td>
                                                        <input id="scientistStatus_@k.QuoteDetailsId" type="text" value="@k.AdminScientistStatus" style="width:200px" />
                                                    </td>
                                                    <td>@k.ProjectStatustext </td>
                                                    <td><input id="remark_@k.QuoteDetailsId" type="text" value="@k.Remark" style="width:170px" /></td>
                                                    <td>
                                                        <a href="javascript:void(0)" id="save_@k.QuoteDetailsId" onclick="SaveProjectDetails('@k.QuoteDetailsId')"> Save</a>
                                                        <a href="javascript:void(0)" id="onhold_@k.QuoteDetailsId" onclick="SetOnHold('@k.QuoteDetailsId')"> Hold</a>
                                                        @*@if (scientistStatus == "Ready to Deliver")
                                                            {
                                                                <span id="spanmovedispatch_@k.QuoteDetailsId"> | <a href="javascript:void(0)" onclick="MovetoDispatch('@k.QuoteDetailsId')">Move To Dispatch</a></span>
                                                            }*@
                                                        @*| <a href="javascript:void(0)" onclick="Quote.deleteQuote('@i.QuoteId')"> Delete</a>*@
                                                    </td>
                                                </tr>
                                            }
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                        <!-- /.box-body -->
                    </div>
                    <div id="menu1" class="tab-pane fade">
                        <!-- /.box-header -->
                        <div class="box-body" style="overflow:scroll;" id="divProjss">
                            <table id="example2" class="table table-bordered table-striped">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Project Type</th>
                                        <th>Scientist</th>
                                        <th>Qty</th>
                                        <th>CAS No</th>
                                        <th>CAT No</th>
                                        <th>Additional Batch No</th>
                                        <th>Batch No</th>
                                        @*<th>Data Required</th>*@
                                        <th>Company Name</th>
                                        <th>PO No</th>
                                        <th>Product Name</th>
                                        <th>Estimate Comp. Date</th>
                                        <th>Scientist Status</th>
                                        <th>Project Status</th>
                                        <th>Data Remark</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (Model.Count > 0)
                                    {
                                        foreach (var i in Model)
                                        {
                                            foreach (var k in i.SZ_QuotationProductModel.Where(x => x.IsOnHold == true).ToList())
                                            {
                                                <tr id="tr_@k.QuoteDetailsId" class="clsRow" data-ScientistStatus="@k.ScientistStatus" data-ReadyToDeliverScientistStatusId="@k.ReadyToDeliverScientistStatusId" data-MovetoDispatch="@k.MoveToDispatch">
                                                    <td>
                                                        @k.SrPo
                                                    </td>
                                                    <td>
                                                        @{
                                                            string selectedTerxt = "";
                                                            foreach (EnumList.ProjectType r in Enum.GetValues(typeof(EnumList.ProjectType)))
                                                            {
                                                                var item = Enum.GetName(typeof(EnumList.ProjectType), r);
                                                                var test = r.ToString();
                                                                string text = SZ_Helper.GetEnumDescription((EnumList.ProjectType)(int)r);
                                                                int val = (int)r;

                                                                if (Convert.ToString(val) == k.ProjectType)
                                                                {
                                                                    selectedTerxt = Convert.ToString(text);
                                                                }
                                                            }
                                                        }
                                                        @selectedTerxt

                                                    </td>
                                                    <td>
                                                        @k.ScientistName
                                                    </td>
                                                    <td>@k.RequiredQty</td>
                                                    <td><label>@k.CASNo</label> </td>
                                                    <td><label>@k.CATNo</label> </td>
                                                    <td>
                                                        @k.AdditionalBatchNoText
                                                    </td>
                                                    <td>@k.BatchNo</td>
                                                    @*<td></td>*@
                                                    <td> @i.CompanyName</td>
                                                    <td><label>@i.PONumber</label> </td>
                                                    <td><label>@k.ProductName</label> </td>
                                                    <td>
                                                        @if (k.EstimateCompleteDate.HasValue)
                                                        {
                                                            @k.EstimateCompleteDate.Value.ToShortDateString()
                                                        }
                                                    </td>
                                                    <td>
                                                        @k.AdminScientistStatus
                                                    </td>
                                                    <td>@k.ProjectStatustext </td>
                                                    <td>@k.Remark</td>
                                                    <td>
                                                        <a href="javascript:void(0)" id="onhold_@k.QuoteDetailsId" onclick="SetOnresume('@k.QuoteDetailsId')"> Resume</a>
                                                        @*@if (scientistStatus == "Ready to Deliver")
                                                            {
                                                                <span id="spanmovedispatch_@k.QuoteDetailsId"> | <a href="javascript:void(0)" onclick="MovetoDispatch('@k.QuoteDetailsId')">Move To Dispatch</a></span>
                                                            }*@
                                                        @*| <a href="javascript:void(0)" onclick="Quote.deleteQuote('@i.QuoteId')"> Delete</a>*@
                                                    </td>
                                                </tr>
                                            }
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                        <!-- /.box-body -->
                    </div>
                </div>


            </div>
        </div>
    </div>
</section>
<script>

    $("#divProj").css('height',window.innerHeight - 200);
    $("#divProjss").css('height', window.innerHeight - 200);
	$(function () {
        var table = $('#example1').DataTable({
            "pageLength": 25,
            "ordering": false,
	        //"order": [[10, "desc"],[1, "asc"]],
            "columnDefs": [
                { "searchable": false, "targets": 4},
                { "visible": false, "targets": 0 }
            ]
        });
        $('#example2').DataTable({
            "pageLength": 25,
            "ordering": false,
            //"order": [[10, "desc"],[1, "asc"]],
            "columnDefs": [
                { "searchable": false, "targets": 4 }
            ]
        });
	});

    $(document).ready(function () {
        $(".scientist").each(function () {
            var value = $(this).attr("scientistId");
            var quotedetailsid= $(this).attr("quotedetailsid");
            if (value != "") {
                $(this).val(value);
                $("#textscientistId_"+quotedetailsid).text($("#ScientistId_"+quotedetailsid+" option:selected").text());

            }
        });

        $('.clsRow').each(function () {
            var sciStatus = $(this).attr('data-ScientistStatus');
            var moveDispatch = $(this).attr('data-MovetoDispatch');
    var readyDeliveredId = $(this).attr('data-ReadyToDeliverScientistStatusId');
            if(sciStatus === readyDeliveredId && moveDispatch === '')
            {
                $(this).css('background-color','lightgreen');
            }
            else {
                $(this).css('background-color', '');
            }

        });

        $(".clsProjType").change(function () {
            var id = $(this).attr("data-quoteDetailsId");
            var value = $(this).val();
            if (value === '3' || value === '4')
            {
                $("#ScientistId_" + id).val("");
                $("#ScientistId_" + id).prop("disabled",true);
            }
            else {
                $("#ScientistId_" + id).prop("disabled", false);
            }
        });
    })
    function SetOnHold(id) {
        $.ajax({
            url: '/Form/SetProjectOnHold?id=' + id ,
            data: {},
            type: 'POST',
            success: function (data) {
    toastr.success("You have set hold for this product");
                window.location.reload(true);
            }
        });
    }
    function SetOnresume(id) {
        $.ajax({
            url: '/Form/SetProjectOnResume?id=' + id,
            data: {},
            type: 'POST',
            success: function (data) {
                toastr.success("You have update for this product");
                window.location.reload(true);
            }
        });
    }
    function SaveProjectDetails(id) {
        $("#qty_" + id).css('border', '');
        var scId = $("#ScientistId_" + id).val();
        var scientistStatus = $("#scientistStatus_" + id).val();
        var projectType = $("#projecttype_" + id).val();
        var qty = $("#qty_" + id).val();
        var batchno = $("#batchno_" + id).val();
         var additionalBatch = $("#additionalBatch_" + id).val();
        var remark = $("#remark_" + id).val();
        if (qty === "" && qty !== "0") {
            $("#qty_" + id).css('border','1px solid red');
            return false;
        }
        $.ajax({
            url: '/Form/UpdateProjectInfo?scId=' + scId + '&projectType=' + projectType + '&qty=' + qty + '&id=' + id + '&batchno=' + batchno + '&remark=' + remark + '&additionalBatch=' + additionalBatch + '&scientistStatus=' + scientistStatus,
            data: {},
            type: 'POST',
            success: function (data) {
                toastr.success("You have updated product information.");
                window.location.reload(true);
            }
        });
    }

    function MoveToDispatchList() {
        var ids = [];
        $('.clsMoveDispatch').each(function () {
            if ($(this).is(':checked')) {
                ids.push($(this).val());
            }
        });

        if (ids.length === 0) {
            toastr.error("Please select atleast one Product");
            return false;
        }

        $.ajax({
            url: '/Form/MoveToDispatchList',
            data: { id: ids },
            type: 'POST',
            traditional: true, // add this
            dataType: 'json',
            success: function (data) {
                if (data.success) {
                    window.location.href = "/Form/Project";
                }
            }
        });
    }


    function MovetoDispatch(quoteDetailsId)
    {
        swal({
            title: "Are you sure?",
            text: "You want to move this file to dispatch team!",
            type: "warning",
            showCancelButton: true,
            confirmButtonClass: "btn-danger",
            confirmButtonText: "Yes, move it!",
            cancelButtonText: "No",
            closeOnConfirm: true,
            closeOnCancel: true
        },
         function (isConfirm) {
             if (isConfirm) {
                 $.ajax({
                     url: '/Form/MovetoDispatch?id=' + quoteDetailsId,
                     data: {},
                     type: 'POST',
                     success: function (data) {
                         if (data.success) {
                             toastr.success("Your product is moved to dispatch team.");
                             $("#spanmovedispatch_" + quoteDetailsId).hide();
                         }
                         else {
                             toastr.error(data.message);

                         }
                    }
                 });
             } else {
                 toastr.error("Your product is safe :)");
             }
         });
    }
</script>