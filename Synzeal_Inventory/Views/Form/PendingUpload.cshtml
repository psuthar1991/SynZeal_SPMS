@{
    ViewBag.Title = "PendingUpload";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@model List<SZ_QuotationModel>
@using Synzeal_Inventory.Models
<style type="text/css">
    #example1 input {
        border: 0px;
    }
</style>
<section class="content-header">
    <h1>
        Pending Upload List <a href="javascript:void(0)" style="float:right;margin-right:8px;" class="btn btn-primary" onclick="SaveAll()">Save All</a>
    </h1>
</section>


<section class="content">
    <div class="row">
        <div class="col-xs-12">
            <div class="box box-primary">
                <ul class="nav nav-tabs">
                    <li class="active"><a data-toggle="tab" href="#home" data-tabname="all">ALL</a></li>
                    <li><a data-toggle="tab" href="#tabpending" onclick="LoadPendingData()" data-tabname="pending">PENDING</a></li>
                    <li><a data-toggle="tab" href="#tabquoteupload" onclick="LoadQuoteUploadData()" data-tabname="quoteupload">QUOTE UPLOAD</a></li>

                    @*<li><a data-toggle="tab" href="#tabquotelog" onclick="LoadQuotelogData()" data-tabname="quotelog">QUOTE LOG</a></li>*@
                </ul>
                <div class="tab-content">
                    <div id="home" class="tab-pane fade in active">
                        <!-- /.box-header -->
                        <div class="box-body" style="overflow:scroll;" id="divProj">
                            <div>
                                <a href="javascript:void(0)" style="float:right;margin-right:8px;" class="btn btn-primary" onclick="exportforpendingupload()">Export</a>
                            </div><div class="clearfix"></div>
                            <br />
                            <table id="example1" class="table table-bordered table-striped" width="100%">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>PO No</th>
                                        <th>Product Name</th>
                                        <th>CAT No</th>
                                        <th>CAS No</th>
                                        <th>Batch No</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                        <!-- /.box-body -->
                    </div>

                    <div id="tabpending" class="tab-pane fade">
                        <!-- /.box-header -->
                        <div class="box-body" style="overflow:scroll;" id="divProj">
                            <table id="tblpending" class="table table-bordered table-striped" width="100%">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>PO No</th>
                                        <th>Product Name</th>
                                        <th>CAT No</th>
                                        <th>CAS No</th>
                                    </tr>
                                </thead>

                            </table>
                        </div>
                        <!-- /.box-body -->
                    </div>

                    <div id="tabquotelog" class="tab-pane fade">
                        <!-- /.box-header -->
                        <div class="box-body" style="overflow:scroll;" id="divProj">
                            <table id="tblquotelog" class="table table-bordered table-striped" width="100%">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>Quote No</th>
                                        <th>Product Name</th>
                                        <th>CAT No</th>
                                        <th>CAS No</th>
                                    </tr>
                                </thead>

                            </table>
                        </div>
                        <!-- /.box-body -->
                    </div>

                    <div id="tabquoteupload" class="tab-pane fade">
                        <!-- /.box-header -->
                        <div class="box-body" style="overflow:scroll;" id="divProj">
                            <a href="javascript:void(0)" style="float:right;margin-right:8px;" class="btn btn-primary" onclick="SubmituploadProduct()">Submitted Product</a>
                            
                            <a href="javascript:void(0)" style="float:right;margin-right:8px;" class="btn btn-primary" onclick="Printrecords()">Copy</a>
                            <div class="clearfix"></div>
                            <br />
                            <table id="tblquoteupload" class="table table-bordered table-striped" width="100%">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>Quote No</th>
                                        <th>Product Name</th>
                                        <th>CAT No</th>
                                        <th>CAS No</th>
                                        <th>Created By</th>
                                        <th>Attachment</th>
                                    </tr>
                                </thead>

                            </table>
                        </div>
                        <!-- /.box-body -->
                    </div>
                </div>
            </div>
            </div>
    </div>
</section>
<script type="text/javascript">
    function exportforpendingupload() {
        $.ajax({
            url: '/Form/PendingUploadExportPopup',
            data: {},
            type: 'GET',
            traditional: true, // add this
            dataType: 'json',
            success: function (data) {
                $('#myModal').find('.modal-body').html(data.html);
                $('#myModal').modal({ show: true });
                //$('#myModal').find(".modal-dialog").css("width", "1080px");
                //$('#myModal').find('.modal-body').find(".box-body").css('overflow', 'scroll').css('height', '400px');
            }
        });
    }



    var pendingloaded = false;
    function LoadPendingData() {
        if (pendingloaded === false) {
            var pendingtbl = $('#tblpending').DataTable({
                "ordering": false,
                "scrollX": true,
                "scrollY": "550px",
                //"autoWidth" : false,
                "processing": true, // for show progress bar
                "serverSide": true, // for process server side
                "filter": true, // this is for disable filter (search box)
                "pageLength": 25,
                "fnDrawCallback": function (oSettings) {
                    pendingtbl.columns.adjust();
                    pendingloaded = true;
                },
                "columnDefs":
                    [
                    ],
                "language": { processing: '<i class="fa fa-spinner fa-spin fa-3x fa-fw"></i><span class="sr-only">Loading...</span> ' },
                "initComplete": function (settings, json) {

                },
                "ajax": {
                    "url": "../Form/LoadPendingUplaodDatas",
                    "type": "POST",
                    "datatype": "json",
                    "data": function (d) {

                    }
                },
                "fnRowCallback": function (nRow, aData, iDisplayIndex, iDisplayIndexFull) {
                    //if (aData.SelectedProjectType === "In-Stock" && aData.MoveToDispatch != true) {
                    //    $('td', nRow).css('background-color', 'rgb(202, 251, 217)');
                    //}
                    //if (aData.ReadyToDeliverScientistStatusId === aData.ScientistStatus) {
                    //    $('td', nRow).css('background-color', 'rgb(202, 251, 217)');
                    //}
                    //if (aData.MoveToDispatch && (aData.DispatchedStatus == "0" || aData.DispatchedStatus == null)) {
                    //    $('td', nRow).css('background-color', '#ffe6b3');
                    //}
                    //if (aData.MoveToDispatch && aData.DispatchedStatus == "1") {
                    //    $('td', nRow).css('background-color', 'rgb(250, 209, 255)');
                    //}
                    //if (aData.MoveToInvoice) {
                    //    $('td', nRow).css('background-color', '#ff9999');
                    //}
                },
                "createdRow": function (row, data, dataIndex) {
                    // Set the data-status attribute, and add a class
                    $(row).attr('id', 'tr_' + data.QuoteDetailsId);
                },
                "columns": [
                    { "data": "FirstColumn" },
                    { "data": "PONumber" },
                    { "data": "ProductName" },
                    { "data": "CATNoText" },
                    { "data": "CASNoText" }
                ]
            });
        }
    }
    var quotelogloaded = false;
    function LoadQuotelogData() {
        if (quotelogloaded === false) {
            var quotelogtbl = $('#tblquotelog').DataTable({
                "ordering": false,
                "scrollX": true,
                "scrollY": "550px",
                //"autoWidth" : false,
                "processing": true, // for show progress bar
                "serverSide": true, // for process server side
                "filter": true, // this is for disable filter (search box)
                "pageLength": 25,
                "fnDrawCallback": function (oSettings) {
                    quotelogtbl.columns.adjust();
                    quotelogloaded = true;
                },
                "columnDefs":
                    [
                    ],
                "language": { processing: '<i class="fa fa-spinner fa-spin fa-3x fa-fw"></i><span class="sr-only">Loading...</span> ' },
                "initComplete": function (settings, json) {

                },
                "ajax": {
                    "url": "../Form/LoadQuoteLogUplaodData",
                    "type": "POST",
                    "datatype": "json",
                    "data": function (d) {

                    }
                },
                "fnRowCallback": function (nRow, aData, iDisplayIndex, iDisplayIndexFull) {
                    //if (aData.SelectedProjectType === "In-Stock" && aData.MoveToDispatch != true) {
                    //    $('td', nRow).css('background-color', 'rgb(202, 251, 217)');
                    //}
                    //if (aData.ReadyToDeliverScientistStatusId === aData.ScientistStatus) {
                    //    $('td', nRow).css('background-color', 'rgb(202, 251, 217)');
                    //}
                    //if (aData.MoveToDispatch && (aData.DispatchedStatus == "0" || aData.DispatchedStatus == null)) {
                    //    $('td', nRow).css('background-color', '#ffe6b3');
                    //}
                    //if (aData.MoveToDispatch && aData.DispatchedStatus == "1") {
                    //    $('td', nRow).css('background-color', 'rgb(250, 209, 255)');
                    //}
                    //if (aData.MoveToInvoice) {
                    //    $('td', nRow).css('background-color', '#ff9999');
                    //}
                },
                "createdRow": function (row, data, dataIndex) {
                    // Set the data-status attribute, and add a class
                    $(row).attr('id', 'tr_' + data.QuoteDetailsId);
                },
                "columns": [
                    { "data": "FirstColumn" },
                    { "data": "Ref" },
                    { "data": "ProductName" },
                    { "data": "CATNoText" },
                    { "data": "CASNoText" }
                ]
            });
        }
    }

    var quoteuploadloaded = false;
    function LoadQuoteUploadData() {
        if (quoteuploadloaded === false) {
            var quoteuploaddatatbl = $('#tblquoteupload').DataTable({
                "ordering": false,
                "scrollX": true,
                "scrollY": "550px",
                //"autoWidth" : false,
                "processing": true, // for show progress bar
                "serverSide": true, // for process server side
                "filter": true, // this is for disable filter (search box)
                "pageLength": 25,
                "fnDrawCallback": function (oSettings) {
                    quoteuploaddatatbl.columns.adjust();
                    quoteuploadloaded = true;
                },
                "columnDefs":
                    [
                    ],
                "language": { processing: '<i class="fa fa-spinner fa-spin fa-3x fa-fw"></i><span class="sr-only">Loading...</span> ' },
                "initComplete": function (settings, json) {

                },
                "ajax": {
                    "url": "../Form/LoadQuoteUploadData",
                    "type": "POST",
                    "datatype": "json",
                    "data": function (d) {

                    }
                },
                "fnRowCallback": function (nRow, aData, iDisplayIndex, iDisplayIndexFull) {
                    
                },
                "createdRow": function (row, data, dataIndex) {
                   $(row).attr('id', 'tr_' + data.QuoteDetailsId);
                },
                "columns": [
                    { "data": "FirstColumn" },
                    { "data": "Ref" },
                    { "data": "ProductName" },
                    { "data": "CATNoText" },
                    { "data": "CASNoText" },
                    { "data": "CreatedbyText" },
                    { "data": "AttachmentText" },
                ]
            });
        }
    }

     function SubmituploadProduct()
    {
         var ids = [];
         var errorcnt = 0;
         $('#tblquoteupload').find('.clspendingupload').each(function () {
             var val = $(this).val();
             if ($(this).is(':checked')) {
                 ids.push($(this).val());
                 if ($("#cat_" + val).val() === "") {
                     errorcnt += 1;
                 }
                 if ($("#cas_" + val).val() === "") {
                     errorcnt += 1;
                 }
             }
        });
        if (ids.length === 0) {
            toastr.error("Please select atleast one Product");
            return false;
        }
         if (errorcnt !== 0) {
             toastr.error("Please select that product which has CAS no and CAT no");
             return false;
         }
        $.ajax({
            url: '/Form/SubmittedUploadProduct',
            data: { id: ids },
            type: 'POST',
            traditional: true, // add this
            dataType: 'json',
            success: function (data) {
                if (data.success) {
                    toastr.success(data.message);
                    $('#tblquoteupload').DataTable().ajax.reload(null, false);
                }
                else {
                    toastr.error(data.message);
                    return false;
                }
            }
        });
    }

    function SaveAll()
    {   
        var ids = [];
        $('.clspendingupload').each(function () {
            var divid = $(this).val();
            $(this).css('border', '');
            if ($(this).is(':checked')) {
                var qty = $(this).val();
                if (qty === "" && qty !== "0") {
                    $("#cat_" + divid).css('border', '1px solid red');
                    qtyerror += 1;
                }
                ids.push($(this).val());
            }
        });
        if (ids.length === 0) {
            toastr.error("Please select atleast one Product.");
            return false;
        }


        $('.clspendingupload').each(function () {
            var id = $(this).val();
            if ($(this).is(':checked')) {
                var catno = $("#cat_" + id).val();
                if (catno.trim() === "") {
                    toastr.error("Please add catalog number.");
                    return false;
                }
                var casno = $("#cas_" + id).val();
                $.ajax({
                    url: '/Form/UploadedOnServer?id=' + id +'&catno='+ catno+'&casno='+ casno,
                    data: {},
                    type: 'POST',
                    success: function (data) {
                        if (data === "noproduct") {
                            toastr.error("No product available with this catalog no on website. Please upload product first on website..");
                            return false;
                        }
                         toastr.success( "You have updated product information.");
                        /*window.location.reload(true);*/
                    },
                    complete: function (data) {
                        successAlert(count, ids.length);
                        count += 1;
                    }
                });
            }
        });
    }

    function successAlert(count, forloopcount) {
        if (count === forloopcount) {
            if (data === "noproduct") {
                toastr.error("No product available with this catalog no on website. Please upload product first on website.");
                return false;
            }
            toastr.success("You have updated product information.");
        }
    }

    function UploadOnServer(id) {
        var catno = $("#cat_" + id).val();
        if (catno.trim() === "") {
    toastr.error("Please add catalog number.");
            return false;
        }
        $.ajax({
            url: '/Form/UploadedOnServer?id=' + id +'&catno='+ catno,
            data: {},
            type: 'POST',
            success: function (data) {
                if (data === "noproduct") {
                    toastr.error("No product available with this catalog no on website. Please upload product first on website.");
                    return false;
                }

                toastr.success("You have updated product information.");
                window.location.reload(true);
            }
        });
    }

    var alltbl = $('#example1').DataTable({
        "ordering": false,
        "scrollX": true,
        "scrollY": "550px",
        //"autoWidth" : false,
        "processing": true, // for show progress bar
        "serverSide": true, // for process server side
        "filter": true, // this is for disable filter (search box)
        "pageLength": 25,
        "fnDrawCallback": function (oSettings) {

            var api = this.api();
            var rows = api.rows({ page: 'current' }).nodes();
            var last = null;
            var groupingCounts = [];
            var counter = 1;
            api.column(1, { page: 'current' }).data().each(function (group, i) {

                if (last !== group) {
                    if (last !== undefined) {
                        groupingCounts[last] = counter;
                    }
                    $(rows).eq(i).before(
                        '<td class="group" colspan="24" style="BACKGROUND-COLOR:#3c8dbc;font-weight:700;color:#fff;padding:10px;">' + group  + ' </td>'
                    );

                    last = group;
                    counter = 1;
                } else {
                    counter++;
                }
            });
            alltbl.columns.adjust();
        },
        "columnDefs": [{ targets: 1, visible: false }],
        "language": { processing: '<i class="fa fa-spinner fa-spin fa-3x fa-fw"></i><span class="sr-only">Loading...</span> ' },
        "initComplete": function (settings, json) {

        },
        "ajax": {
            "url": "../Form/LoadAllPendingUplaodData",
            "type": "POST",
            "datatype": "json",
            "data": function (d) {
                
            }
        },
        "fnRowCallback": function (nRow, aData, iDisplayIndex, iDisplayIndexFull) {
        },
        "createdRow": function (row, data, dataIndex) {
            // Set the data-status attribute, and add a class
            $(row).attr('id', 'tr_' + data.QuoteDetailsId);
        },
        "columns": [
            { "data": "FirstColumn" },
            { "data": "PONumber" },
            { "data": "ProductName" },
            { "data": "CATNoText" },
            { "data": "CASNoText" },
            { "data": "AdditionalBatchNoText" }
        ]
    });

    function Printrecords() {
       
        var ids = [];
        $('#tblquoteupload').find('.clspendingupload').each(function () {
            if ($(this).is(':checked')) {
                ids.push($(this).val());
            }
        });

        if (ids.length === 0) {
            toastr.error("Please select atleast one Product");
            return false;
        }

        $.ajax({
            url: '/Form/PrintProjectRecord',
            data: { id: ids , pageName : 'pendingupload'},
            type: 'POST',
            traditional: true, // add this
            dataType: 'json',
            success: function (data) {
                $('.modal-body').html(data.html);
                $('#myModal').modal({ show: true });
                $(".modal-dialog").css("width", "1080px");
            }
        });
    }
</script>
<style>
    .bluetr {
        background: #c4e7f3 !important
    }
</style>